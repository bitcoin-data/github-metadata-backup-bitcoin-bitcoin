{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334",
    "id": 2806374008,
    "node_id": "PR_kwDOABII586nRd54",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/33334",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/33334.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/33334.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33334",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33334/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
    "number": 33334,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "node: optimize CBlockIndexWorkComparator",
    "user": {
      "login": "Raimo33",
      "id": 104778891,
      "node_id": "U_kgDOBj7Miw",
      "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Raimo33",
      "html_url": "https://github.com/Raimo33",
      "followers_url": "https://api.github.com/users/Raimo33/followers",
      "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
      "organizations_url": "https://api.github.com/users/Raimo33/orgs",
      "repos_url": "https://api.github.com/users/Raimo33/repos",
      "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Raimo33/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "## Summary\r\n\r\nThis PR optimizes `CBlockIndexWorkComparator::operator()` by removing 4 redundant branches.\r\n\r\nThe previous implementation used multiple separate comparisons with explicit branches for greater-than and less-than cases, resulting in unnecessary code paths.\r\n\r\nThe new implementation consolidates comparisons into single inequality checks and reduces complexity while preserving its original behavior. This change is particularly beneficial for loading blocks from files and reindexing.\r\n\r\n## Benchmarks\r\n\r\n```shell\r\ntaskset -c 1 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile)\" -output-csv=bench_old.csv --min-time=30000\r\n```\r\n\r\n> Before:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          129,988.82 |            7,692.97 |    0.0% |     33.02 | `CheckBlockIndex`\r\n|       21,661,396.96 |               46.17 |    0.5% |     32.37 | `LoadExternalBlockFile`\r\n\r\n> After:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          115,346.65 |            8,669.52 |    0.0% |     33.00 | `CheckBlockIndex`\r\n|       20,389,679.85 |               49.04 |    0.4% |     31.76 | `LoadExternalBlockFile`\r\n\r\nCompared to master:\r\n\r\n* `CheckBlockIndex` **+12.7%** faster\r\n* `LoadExternalBlockFile` **+6.2%** faster\r\n",
    "labels": [],
    "created_at": "2025-09-07T22:00:42Z",
    "updated_at": "2025-09-09T22:42:38Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "eece49556c3f7151617705e7b94bc165dd2f648c",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "Raimo33:index-work-comparator-branchless",
      "ref": "index-work-comparator-branchless",
      "sha": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "user": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1046546111,
        "node_id": "R_kgDOPmEGvw",
        "name": "bitcoinknots",
        "full_name": "Raimo33/bitcoinknots",
        "owner": {
          "login": "Raimo33",
          "id": 104778891,
          "node_id": "U_kgDOBj7Miw",
          "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/Raimo33",
          "html_url": "https://github.com/Raimo33",
          "followers_url": "https://api.github.com/users/Raimo33/followers",
          "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
          "organizations_url": "https://api.github.com/users/Raimo33/orgs",
          "repos_url": "https://api.github.com/users/Raimo33/repos",
          "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/Raimo33/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/Raimo33/bitcoinknots",
        "description": "Bitcoin Knots enhanced Bitcoin node/wallet software",
        "fork": true,
        "url": "https://api.github.com/repos/Raimo33/bitcoinknots",
        "archive_url": "https://api.github.com/repos/Raimo33/bitcoinknots/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/Raimo33/bitcoinknots/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/Raimo33/bitcoinknots/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/Raimo33/bitcoinknots/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/Raimo33/bitcoinknots/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/Raimo33/bitcoinknots/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/Raimo33/bitcoinknots/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/Raimo33/bitcoinknots/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/Raimo33/bitcoinknots/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/Raimo33/bitcoinknots/contributors",
        "deployments_url": "https://api.github.com/repos/Raimo33/bitcoinknots/deployments",
        "downloads_url": "https://api.github.com/repos/Raimo33/bitcoinknots/downloads",
        "events_url": "https://api.github.com/repos/Raimo33/bitcoinknots/events",
        "forks_url": "https://api.github.com/repos/Raimo33/bitcoinknots/forks",
        "git_commits_url": "https://api.github.com/repos/Raimo33/bitcoinknots/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/Raimo33/bitcoinknots/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/Raimo33/bitcoinknots/git/tags%7B/sha%7D",
        "git_url": "git://github.com/Raimo33/bitcoinknots.git",
        "issue_comment_url": "https://api.github.com/repos/Raimo33/bitcoinknots/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/Raimo33/bitcoinknots/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/Raimo33/bitcoinknots/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/Raimo33/bitcoinknots/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/Raimo33/bitcoinknots/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/Raimo33/bitcoinknots/languages",
        "merges_url": "https://api.github.com/repos/Raimo33/bitcoinknots/merges",
        "milestones_url": "https://api.github.com/repos/Raimo33/bitcoinknots/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/Raimo33/bitcoinknots/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/Raimo33/bitcoinknots/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/Raimo33/bitcoinknots/releases%7B/id%7D",
        "ssh_url": "git@github.com:Raimo33/bitcoinknots.git",
        "stargazers_url": "https://api.github.com/repos/Raimo33/bitcoinknots/stargazers",
        "statuses_url": "https://api.github.com/repos/Raimo33/bitcoinknots/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/Raimo33/bitcoinknots/subscribers",
        "subscription_url": "https://api.github.com/repos/Raimo33/bitcoinknots/subscription",
        "tags_url": "https://api.github.com/repos/Raimo33/bitcoinknots/tags",
        "teams_url": "https://api.github.com/repos/Raimo33/bitcoinknots/teams",
        "trees_url": "https://api.github.com/repos/Raimo33/bitcoinknots/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/Raimo33/bitcoinknots.git",
        "hooks_url": "https://api.github.com/repos/Raimo33/bitcoinknots/hooks",
        "svn_url": "https://github.com/Raimo33/bitcoinknots",
        "homepage": "",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 0,
        "watchers_count": 0,
        "size": 253714,
        "default_branch": "29.x-knots",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": true,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-09-09T16:33:02Z",
        "created_at": "2025-08-28T21:05:09Z",
        "updated_at": "2025-09-07T02:35:56Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "c0894a0a2be032cd9a5d5945643689230ab10255",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 37766,
        "stargazers_count": 85418,
        "watchers_count": 85418,
        "size": 293475,
        "default_branch": "master",
        "open_issues_count": 767,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-09-09T21:57:36Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-09-09T22:05:08Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334"
      }
    },
    "author_association": "NONE",
    "draft": false,
    "additions": 7,
    "deletions": 9,
    "changed_files": 1,
    "commits": 1,
    "review_comments": 2,
    "comments": 1
  },
  "events": [
    {
      "event": "commented",
      "id": 3264096071,
      "node_id": "IC_kwDOABII587CjidH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3264096071",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-07T22:00:47Z",
      "updated_at": "2025-09-09T21:28:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33334.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/33334#pullrequestreview-3202982209) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29640](https://github.com/bitcoin/bitcoin/pull/29640) (Fix tiebreak when loading blocks from disk (and add tests for comparing chain ties) by sr-gi)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33334#issuecomment-3264096071",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33334"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDgwYWMwNDY3ZWY0YzNmYjQ3ZjgwM2Q5NDhlOGRmMGE0YjA3ZTBlOWM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "tree": {
        "sha": "fe2eaeb9d06fea400883003759cc029724070ea0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fe2eaeb9d06fea400883003759cc029724070ea0"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree fe2eaeb9d06fea400883003759cc029724070ea0\nparent 36e40417de3fcaa776fb7bb8ebf3a23db4266572\nauthor Raimo33 <claudio.raimondi@protonmail.com> 1757203200 +0200\ncommitter Raimo33 <claudio.raimondi@protonmail.com> 1757435418 +0200\n\nnode: optimize CBlockIndexWorkComparator\n\nRefactor the comparator logic in CBlockIndexWorkComparator::operator() to reduce the amounts of branches and improve readability without changing semantics.\n\nThe previous implementation used multiple separate comparisons with explicit branches for greater-than and less-than cases, resulting in\nunnecessary code paths.\n\nThe new implementation consolidates comparisons into single inequality checks and reduces complexity while preserving its original behavior.\nThis change is particularly beneficial for loading blocks from files and reindexing.\n\ntaskset -c 1 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile|BlockToJsonVerboseWrite)\" -output-csv=bench_old.csv --min-time=30000\n\n|               ns/op |                op/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|       26,557,419.20 |               37.65 |    0.1% |     32.85 | `BlockToJsonVerboseWrite`\n|          129,988.82 |            7,692.97 |    0.0% |     33.02 | `CheckBlockIndex`\n|       21,661,396.96 |               46.17 |    0.5% |     32.37 | `LoadExternalBlockFile`\n\ntaskset -c 1 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile|BlockToJsonVerboseWrite|WalletIsMineDescriptors)\" -output-csv=bench_new.csv --min-time=30000\n\n|               ns/op |                op/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|       27,930,130.95 |               35.80 |    0.1% |     32.96 | `BlockToJsonVerboseWrite`\n|          115,346.65 |            8,669.52 |    0.0% |     33.00 | `CheckBlockIndex`\n|       20,389,679.85 |               49.04 |    0.4% |     31.76 | `LoadExternalBlockFile`\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYKAB0WIQT3Bgs/ry8S3d/jnkVrUBvycIswNgUCaMBWOwAKCRBrUBvycIsw\nNgiUAQCbA0MNxE0sFnTBo5yv+r/6j0/k/jHzSVMgELAF1FzErQD8CErB0tmbP8lY\nqOQa+AjbgoVjUTlnD9Hd/rHPv3ZZpww=\n=RtYu\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/36e40417de3fcaa776fb7bb8ebf3a23db4266572",
          "sha": "36e40417de3fcaa776fb7bb8ebf3a23db4266572",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/36e40417de3fcaa776fb7bb8ebf3a23db4266572"
        }
      ],
      "message": "node: optimize CBlockIndexWorkComparator\n\nRefactor the comparator logic in CBlockIndexWorkComparator::operator() to reduce the amounts of branches and improve readability without changing semantics.\n\nThe previous implementation used multiple separate comparisons with explicit branches for greater-than and less-than cases, resulting in\nunnecessary code paths.\n\nThe new implementation consolidates comparisons into single inequality checks and reduces complexity while preserving its original behavior.\nThis change is particularly beneficial for loading blocks from files and reindexing.\n\ntaskset -c 1 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile|BlockToJsonVerboseWrite)\" -output-csv=bench_old.csv --min-time=30000\n\n|               ns/op |                op/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|       26,557,419.20 |               37.65 |    0.1% |     32.85 | `BlockToJsonVerboseWrite`\n|          129,988.82 |            7,692.97 |    0.0% |     33.02 | `CheckBlockIndex`\n|       21,661,396.96 |               46.17 |    0.5% |     32.37 | `LoadExternalBlockFile`\n\ntaskset -c 1 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile|BlockToJsonVerboseWrite|WalletIsMineDescriptors)\" -output-csv=bench_new.csv --min-time=30000\n\n|               ns/op |                op/s |    err% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------:|:----------\n|       27,930,130.95 |               35.80 |    0.1% |     32.96 | `BlockToJsonVerboseWrite`\n|          115,346.65 |            8,669.52 |    0.0% |     33.00 | `CheckBlockIndex`\n|       20,389,679.85 |               49.04 |    0.4% |     31.76 | `LoadExternalBlockFile`",
      "committer": {
        "name": "Raimo33",
        "email": "claudio.raimondi@protonmail.com",
        "date": "2025-09-09T16:30:18Z"
      },
      "author": {
        "name": "Raimo33",
        "email": "claudio.raimondi@protonmail.com",
        "date": "2025-09-07T00:00:00Z"
      },
      "sha": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19594165683,
      "node_id": "HRFPE_lADOABII587KLqFzzwAAAASP5z2z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19594165683",
      "actor": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "commit_url": "https://api.github.com/repos/Raimo33/bitcoinknots/commits/80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "created_at": "2025-09-09T16:30:59Z"
    },
    {
      "event": "reviewed",
      "id": 3202982209,
      "node_id": "PRR_kwDOABII586-6aFB",
      "url": null,
      "actor": null,
      "commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-09T21:28:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK - please consider my suggestion",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33334#pullrequestreview-3202982209",
      "submitted_at": "2025-09-09T21:28:21Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2334808680",
      "pull_request_review_id": 3202982209,
      "id": 2334808680,
      "node_id": "PRRC_kwDOABII586LKlpo",
      "diff_hunk": "@@ -158,20 +158,18 @@ namespace node {\n bool CBlockIndexWorkComparator::operator()(const CBlockIndex* pa, const CBlockIndex* pb) const\n {\n     // First sort by most total work, ...\n-    if (pa->nChainWork > pb->nChainWork) return false;\n-    if (pa->nChainWork < pb->nChainWork) return true;\n+    if (pa->nChainWork != pb->nChainWork) {\n+        return pa->nChainWork < pb->nChainWork;\n+    }\n \n     // ... then by earliest time received, ...\n-    if (pa->nSequenceId < pb->nSequenceId) return false;\n-    if (pa->nSequenceId > pb->nSequenceId) return true;\n+    if (pa->nSequenceId != pb->nSequenceId) {\n+        return pa->nSequenceId > pb->nSequenceId;\n+    }\n \n     // Use pointer address as tie breaker (should only happen with blocks\n     // loaded from disk, as those all have id 0).\n-    if (pa < pb) return false;\n-    if (pa > pb) return true;\n-\n-    // Identical blocks.\n-    return false;\n+    return pa > pb;\n }",
      "path": "src/node/blockstorage.cpp",
      "position": 25,
      "original_position": 25,
      "commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "original_commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "All this does is compare by 3 parameters - wouldn't it be simpler to use [`std::tie`](https://en.cppreference.com/w/cpp/utility/tuple/tie) for lexicographical comparison instead?\r\n```suggestion\r\nbool CBlockIndexWorkComparator::operator()(const CBlockIndex* pa, const CBlockIndex* pb) const\r\n{\r\n    // First sort by most total work (descending), then by earliest activatable time (ascending), then by pointer value (ascending)\r\n    return std::tie(pa->nChainWork, pb->nSequenceId, pb) < std::tie(pb->nChainWork, pa->nSequenceId, pa);\r\n}\r\n```\r\n\r\n*Note that `pa` & `pb` usages are mixed to follow the original algorithm.*\r\n\r\nSince https://corecheck.dev/bitcoin/bitcoin/pulls/33334 hasn't finished yet, I ran the benchmarks on my Mac with `min-time` of 100 seconds for stability several times, and took the fastest of each execution (since noise can only slow down execution), which reveals that:\r\n* `BlockToJsonVerboseWrite` speed is completely unaffected in all cases;\r\n* `LoadExternalBlockFile` is the same in the current implementation but would be ~7% faster with the suggested solution;\r\n* `CheckBlockIndex` is indeed 17% faster for the current solution, but would be 24% faster with the proposed one - all while making the code a lot simpler;\r\n\r\n> Before:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       25,322,734.53 |               39.49 |    0.2% |    109.93 | `BlockToJsonVerboseWrite`\r\n|           39,049.20 |           25,608.72 |    0.2% |    110.15 | `CheckBlockIndex`\r\n|        5,955,124.54 |              167.92 |    0.1% |    110.26 | `LoadExternalBlockFile`\r\n\r\n> After:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       25,333,028.32 |               39.47 |    0.2% |    109.61 | `BlockToJsonVerboseWrite`\r\n|           33,173.57 |           30,144.48 |    0.3% |    109.82 | `CheckBlockIndex`\r\n|        6,169,392.66 |              162.09 |    0.4% |    110.79 | `LoadExternalBlockFile`\r\n\r\n\r\n> Suggested `std::tie`:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       25,360,146.33 |               39.43 |    0.3% |    109.90 | `BlockToJsonVerboseWrite`\r\n|           31,343.25 |           31,904.80 |    0.7% |    104.88 | `CheckBlockIndex`\r\n|        5,535,101.51 |              180.67 |    0.7% |    967.85 | `LoadExternalBlockFile`\r\n\r\n-----\r\n\r\nIf you decide to take the suggestion, please add me as a coauthor.",
      "created_at": "2025-09-09T21:07:37Z",
      "updated_at": "2025-09-09T21:33:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33334#discussion_r2334808680",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2334808680"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334"
        }
      },
      "start_line": 158,
      "original_start_line": 158,
      "start_side": "RIGHT",
      "line": 173,
      "original_line": 173,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2334980346",
      "pull_request_review_id": 3203586658,
      "id": 2334980346,
      "node_id": "PRRC_kwDOABII586LLPj6",
      "diff_hunk": "@@ -158,20 +158,18 @@ namespace node {\n bool CBlockIndexWorkComparator::operator()(const CBlockIndex* pa, const CBlockIndex* pb) const\n {\n     // First sort by most total work, ...\n-    if (pa->nChainWork > pb->nChainWork) return false;\n-    if (pa->nChainWork < pb->nChainWork) return true;\n+    if (pa->nChainWork != pb->nChainWork) {\n+        return pa->nChainWork < pb->nChainWork;\n+    }\n \n     // ... then by earliest time received, ...\n-    if (pa->nSequenceId < pb->nSequenceId) return false;\n-    if (pa->nSequenceId > pb->nSequenceId) return true;\n+    if (pa->nSequenceId != pb->nSequenceId) {\n+        return pa->nSequenceId > pb->nSequenceId;\n+    }\n \n     // Use pointer address as tie breaker (should only happen with blocks\n     // loaded from disk, as those all have id 0).\n-    if (pa < pb) return false;\n-    if (pa > pb) return true;\n-\n-    // Identical blocks.\n-    return false;\n+    return pa > pb;\n }",
      "path": "src/node/blockstorage.cpp",
      "position": 25,
      "original_position": 25,
      "commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "original_commit_id": "80ac0467ef4c3fb47f803d948e8df0a4b07e0e9c",
      "in_reply_to_id": 2334808680,
      "user": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I experimented with `std::tie` before. whether it is more readable is debatable. I'd say they're the same in terms of readability (one might not be familiar with std::tie). I ran the benchmarks on my x86 with gcc laptop (not the same machine as my original benchmarks) and got different results from yours.\r\n\r\n```shell\r\ntaskset -c 0 ./bin/bench_bitcoin --filter=\"(CheckBlockIndex|LoadExternalBlockFile)\" --min-time=10000\r\n```\r\n\r\n> Master:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          200,279.21 |            4,993.03 |    0.1% |     10.95 | `CheckBlockIndex`\r\n|       29,798,546.03 |               33.56 |    0.3% |     10.82 | `LoadExternalBlockFile`\r\n\r\n> This PR:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          166,134.37 |            6,019.22 |    0.1% |     10.91 | `CheckBlockIndex`\r\n|       29,547,138.28 |               33.84 |    0.1% |     10.59 | `LoadExternalBlockFile`\r\n\r\n`CheckBlockIndex`: **+17**% faster than master\r\n`LoadExternalBlockFile`: same as master\r\n\r\n> @l0rinc suggestion:\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          193,085.31 |            5,179.06 |    0.0% |     11.00 | `CheckBlockIndex`\r\n|       30,456,267.03 |               32.83 |    0.3% |     10.96 | `LoadExternalBlockFile`\r\n\r\n`CheckBlockIndex`: **+3.6**% faster than master\r\n`LoadExternalBlockFile`: **-2.2**% slower than master\r\n\r\nOverall very different results on different machines/compilers. probably std::tie would be the most standard implementation, giving room for smarter future compilers to optimize. but I genuinely don't know how this could be less than 2 branches.",
      "created_at": "2025-09-09T22:39:45Z",
      "updated_at": "2025-09-09T22:41:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33334#discussion_r2334980346",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2334980346"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33334"
        }
      },
      "start_line": 158,
      "original_start_line": 158,
      "start_side": "RIGHT",
      "line": 173,
      "original_line": 173,
      "side": "RIGHT"
    }
  ]
}