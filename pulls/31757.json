{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757",
    "id": 2305227291,
    "node_id": "PR_kwDOABII586JZvob",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31757",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31757.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31757.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/c80b105f77d8ee397c7dc07b013c37b7df63abd5",
    "number": 31757,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "wallet: fix crash on double block disconnection",
    "user": {
      "login": "furszy",
      "id": 5377650,
      "node_id": "MDQ6VXNlcjUzNzc2NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/furszy",
      "html_url": "https://github.com/furszy",
      "followers_url": "https://api.github.com/users/furszy/followers",
      "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
      "organizations_url": "https://api.github.com/users/furszy/orgs",
      "repos_url": "https://api.github.com/users/furszy/repos",
      "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/furszy/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "The wallet crashes if it processes the same block disconnection event twice in a row due\r\nto an incompatible coinbase transaction state.\r\nThis happens because `disconnectBlock` provides `TxStateInactive` without the \"abandoned\"\r\nflag for coinbase transactions to `SyncTransaction`, while `AddToWallet()` internally modifies\r\nit to retain the abandoned state.\r\n\r\nThe crash flow is as follows:\r\n1) On the first disconnection, the transaction state transitions from \"confirmed\" to\r\n\"inactive,\" bypassing the state equality check since the provided state differs. Then,\r\n`AddToWallet` internally updates the state to \"inactive + abandoned\"\r\n\r\n2) On the second disconnection, as we provide only the \"inactive\" state\r\nto `SyncTransaction()`, the state equality assertion fails and crashes the wallet.\r\n\r\nReviewers Note:\r\nThe crash can easily be replicated by cherry-picking the test commit in master.",
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "created_at": "2025-01-29T18:46:19Z",
    "updated_at": "2025-02-19T17:27:48Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "64dd395b59a60e0166d6ad8adcc6f69734166f58",
    "assignees": [],
    "requested_reviewers": [
      {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    ],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "furszy:2025_wallet_fix_disconnectBlock_state",
      "ref": "2025_wallet_fix_disconnectBlock_state",
      "sha": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 143624913,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDM2MjQ5MTM=",
        "name": "bitcoin-core",
        "full_name": "furszy/bitcoin-core",
        "owner": {
          "login": "furszy",
          "id": 5377650,
          "node_id": "MDQ6VXNlcjUzNzc2NTA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/furszy",
          "html_url": "https://github.com/furszy",
          "followers_url": "https://api.github.com/users/furszy/followers",
          "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
          "organizations_url": "https://api.github.com/users/furszy/orgs",
          "repos_url": "https://api.github.com/users/furszy/repos",
          "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/furszy/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/furszy/bitcoin-core",
        "description": "Bitcoin-Core",
        "fork": true,
        "url": "https://api.github.com/repos/furszy/bitcoin-core",
        "archive_url": "https://api.github.com/repos/furszy/bitcoin-core/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/furszy/bitcoin-core/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/furszy/bitcoin-core/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/furszy/bitcoin-core/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/furszy/bitcoin-core/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/furszy/bitcoin-core/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/furszy/bitcoin-core/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/furszy/bitcoin-core/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/furszy/bitcoin-core/contributors",
        "deployments_url": "https://api.github.com/repos/furszy/bitcoin-core/deployments",
        "downloads_url": "https://api.github.com/repos/furszy/bitcoin-core/downloads",
        "events_url": "https://api.github.com/repos/furszy/bitcoin-core/events",
        "forks_url": "https://api.github.com/repos/furszy/bitcoin-core/forks",
        "git_commits_url": "https://api.github.com/repos/furszy/bitcoin-core/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/furszy/bitcoin-core/git/tags%7B/sha%7D",
        "git_url": "git://github.com/furszy/bitcoin-core.git",
        "issue_comment_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/furszy/bitcoin-core/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/furszy/bitcoin-core/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/furszy/bitcoin-core/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/furszy/bitcoin-core/languages",
        "merges_url": "https://api.github.com/repos/furszy/bitcoin-core/merges",
        "milestones_url": "https://api.github.com/repos/furszy/bitcoin-core/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/furszy/bitcoin-core/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/furszy/bitcoin-core/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/furszy/bitcoin-core/releases%7B/id%7D",
        "ssh_url": "git@github.com:furszy/bitcoin-core.git",
        "stargazers_url": "https://api.github.com/repos/furszy/bitcoin-core/stargazers",
        "statuses_url": "https://api.github.com/repos/furszy/bitcoin-core/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/furszy/bitcoin-core/subscribers",
        "subscription_url": "https://api.github.com/repos/furszy/bitcoin-core/subscription",
        "tags_url": "https://api.github.com/repos/furszy/bitcoin-core/tags",
        "teams_url": "https://api.github.com/repos/furszy/bitcoin-core/teams",
        "trees_url": "https://api.github.com/repos/furszy/bitcoin-core/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/furszy/bitcoin-core.git",
        "hooks_url": "https://api.github.com/repos/furszy/bitcoin-core/hooks",
        "svn_url": "https://github.com/furszy/bitcoin-core",
        "homepage": "",
        "language": "C++",
        "forks_count": 4,
        "stargazers_count": 6,
        "watchers_count": 6,
        "size": 420323,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-02-19T17:24:24Z",
        "created_at": "2018-08-05T15:28:43Z",
        "updated_at": "2025-02-19T14:05:48Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "785649f3977517a4ba45c5d2fedfbda778fb52cb",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36751,
        "stargazers_count": 82081,
        "watchers_count": 82081,
        "size": 275668,
        "default_branch": "master",
        "open_issues_count": 685,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-02-19T05:12:56Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-02-19T17:31:35Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 51,
    "deletions": 2,
    "changed_files": 2,
    "commits": 2,
    "review_comments": 23,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 2622553572,
      "node_id": "IC_kwDOABII586cUP3k",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2622553572",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-29T18:46:23Z",
      "updated_at": "2025-02-18T22:09:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31757.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2602622517), [achow101](https://github.com/bitcoin/bitcoin/pull/31757#issuecomment-2660425278) |\n| Stale ACK | [rkrux](https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2622808152) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27865](https://github.com/bitcoin/bitcoin/pull/27865) (wallet: Track no-longer-spendable TXOs separately by achow101)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#issuecomment-2622553572",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757"
    },
    {
      "event": "labeled",
      "id": 16112565807,
      "node_id": "LE_lADOABII586oBhzszwAAAAPAYj4v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16112565807",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-29T18:46:25Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16112745478,
      "node_id": "HRFPE_lADOABII586oBhzszwAAAAPAZPwG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16112745478",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "commit_url": "https://api.github.com/repos/furszy/bitcoin-core/commits/4229839b454befea2e18764eee20186b6c18f1c5",
      "created_at": "2025-01-29T19:01:04Z"
    },
    {
      "event": "labeled",
      "id": 16112746586,
      "node_id": "LE_lADOABII586oBhzszwAAAAPAZQBa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16112746586",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-29T19:01:10Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2622586137,
      "node_id": "IC_kwDOABII586cUX0Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2622586137",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-29T19:01:12Z",
      "updated_at": "2025-01-29T19:01:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/36373842434</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#issuecomment-2622586137",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757"
    },
    {
      "event": "unlabeled",
      "id": 16113929417,
      "node_id": "UNLE_lADOABII586oBhzszwAAAAPAdwzJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16113929417",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-01-29T20:32:01Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "subscribed",
      "id": 16149043027,
      "node_id": "SE_lADOABII586oBhzszwAAAAPCjtdT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16149043027",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-01T05:59:19Z"
    },
    {
      "event": "reviewed",
      "id": 2602622517,
      "node_id": "PRR_kwDOABII586bIN41",
      "url": null,
      "actor": null,
      "commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK - I opened #31824, which shows that this can actually happen in production.\r\n\r\nThe suggested fix seems good from a defensive programming point of view, although it doesn't address the root problem why double disconnections can happen.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2602622517",
      "submitted_at": "2025-02-07T19:17:45Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
    },
    {
      "event": "reviewed",
      "id": 2617954596,
      "node_id": "PRR_kwDOABII586cCtEk",
      "url": null,
      "actor": null,
      "commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "Concept ACK\r\n\r\nInitial pass, will review in detail soon.",
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2617954596",
      "submitted_at": "2025-02-14T14:28:38Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
    },
    {
      "event": "commented",
      "id": 2660425278,
      "node_id": "IC_kwDOABII586ekt4-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2660425278",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-14T22:52:23Z",
      "updated_at": "2025-02-14T22:52:23Z",
      "author_association": "MEMBER",
      "body": "Concept ACK",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#issuecomment-2660425278",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757"
    },
    {
      "event": "reviewed",
      "id": 2622808152,
      "node_id": "PRR_kwDOABII586cVOBY",
      "url": null,
      "actor": null,
      "commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "I have checked that a coinbase transaction is set to \"inactive + abandoned\" here on first block disconnect inside the `AddToWallet` function: https://github.com/bitcoin/bitcoin/blob/master/src/wallet/wallet.cpp#L1132\r\n\r\nAnd on an unwanted second block disconnection, the same state needs to be passed so that the assertion on line 1114 is satisfied if it's not a new transaction and with the same state variant: https://github.com/bitcoin/bitcoin/blob/master/src/wallet/wallet.cpp#L1114\r\n\r\nI cherry-picked the unit test on master and as expected it failed with the below error due to wallet crash:\r\n```\r\nwallet/test/wallet_tests.cpp:1027: Entering test case \"wallet_crash_during_disconnectBlock\"\r\nwallet/test/wallet_tests.cpp:1037: info: check GetBalance(*wallet, 0, false).m_mine_immature == 50 * COIN has passed\r\nAssertion failed: (TxStateSerializedIndex(wtx.m_state) == TxStateSerializedIndex(state)), function AddToWallet, file wallet.cpp, line 1114.\r\nunknown location:0: fatal error: in \"wallet_tests/wallet_crash_during_disconnectBlock\": signal: SIGABRT (application abort requested)\r\nwallet/test/wallet_tests.cpp:1037: last checkpoint\r\nwallet/test/wallet_tests.cpp:1027: Leaving test case \"wallet_crash_during_disconnectBlock\"; testing time: 576342us\r\n```\r\n\r\nACK 4229839b454befea2e18764eee20186b6c18f1c5",
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2622808152",
      "submitted_at": "2025-02-18T08:40:50Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
    },
    {
      "event": "review_requested",
      "id": 16344149174,
      "node_id": "RRE_lADOABII586oBhzszwAAAAPOL-y2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16344149174",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T08:40:54Z",
      "requested_reviewer": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "review_requested",
      "id": 16344149342,
      "node_id": "RRE_lADOABII586oBhzszwAAAAPOL-1e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16344149342",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T08:40:55Z",
      "requested_reviewer": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      }
    },
    {
      "event": "reviewed",
      "id": 2622887690,
      "node_id": "PRR_kwDOABII586cVhcK",
      "url": null,
      "actor": null,
      "commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2622887690",
      "submitted_at": "2025-02-18T09:20:02Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16356188915,
      "node_id": "HRFPE_lADOABII586oBhzszwAAAAPO56Lz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16356188915",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "commit_url": "https://api.github.com/repos/furszy/bitcoin-core/commits/df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "created_at": "2025-02-18T22:08:58Z"
    },
    {
      "event": "commented",
      "id": 2667045493,
      "node_id": "IC_kwDOABII586e9-J1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2667045493",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-18T22:16:34Z",
      "updated_at": "2025-02-18T22:16:34Z",
      "author_association": "MEMBER",
      "body": "Ended up changing the testing approach, opting for a functional test over a unit test due to its reduced maintenance costs across code refactorings. Made a few modifications to mzumzande's #31824 functional tests.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#issuecomment-2667045493",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31757"
    },
    {
      "event": "labeled",
      "id": 16358943093,
      "node_id": "LE_lADOABII586oBhzszwAAAAPPEal1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16358943093",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-19T04:38:56Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2626627692,
      "node_id": "PRR_kwDOABII586cjyhs",
      "url": null,
      "actor": null,
      "commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "I reviewed till df87cf2\r\n\r\nI had thought about adding the functional test earlier but had ruled it out because I thought technically it's a bug fix and not a functionality per se.\r\nBut after reading this test, I'm in favour of this test, makes me think from the POV of what's happening to the node overall. ",
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#pullrequestreview-2626627692",
      "submitted_at": "2025-02-19T13:36:20Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDllZjQyOWI2YWU2NWY2YWQzZTlhYzExYzJkOWMwYTZjNTJiZWI4NjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865",
      "tree": {
        "sha": "326e1b2163e8051c8fdaf3138d2a924951ef5109",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/326e1b2163e8051c8fdaf3138d2a924951ef5109"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 326e1b2163e8051c8fdaf3138d2a924951ef5109\nparent 785649f3977517a4ba45c5d2fedfbda778fb52cb\nauthor furszy <matiasfurszyfer@protonmail.com> 1738175602 -0500\ncommitter furszy <matiasfurszyfer@protonmail.com> 1739974028 -0300\n\nwallet: fix crash on double block disconnection\n\nThe wallet crashes if it processes the same block disconnection event twice in a row due\nto an incompatible coinbase transaction state.\nThis happens because 'disconnectBlock' provides 'TxStateInactive' without the \"abandoned\"\nflag for coinbase transactions to 'SyncTransaction', while 'AddToWallet()' internally\nmodifies it to retain the abandoned state.\n\nThe flow is as follows:\n1) On the first disconnection, the transaction state transitions from \"confirmed\" to\n\"inactive,\" bypassing the state equality check since the provided state differs. Then,\n'AddToWallet' internally updates the state to \"inactive + abandoned\"\n\n2) On the second disconnection, as we provide only the \"inactive\" state\nto 'SyncTransaction()', the state equality assertion fails and crashes the wallet.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAme15YwACgkQXdI8zGhq\npiMEog//cvxWawu73Y2aTnAn7ht32dI0bejdL+HO0FMlPqAHfWbwfT2iacno0NVV\n/KlYRrIx3jvE+08qLL0Fq4eSePaHk5AzcNbR21Yj1rX5S0C3o9U7cE5e+W53bfAV\nEoEdW2Q481eW6xTBGE1ZCjuombmGMDyhslALqNCreZwYGzOMP+LcupkgdxarbhtW\naPHrfB2yDdHXoKmsY27VyzJhzqmpnY6JbviZ7gVQHJZrbTX0LWmY2eImg7hDO7SM\nd8/amOzjirSlcSTPasKHFWrc/8KJKUO0VXGcIixPkMuJ0C1fotHTbr9jiPVNul8c\ncAePorEUlP6O45eRGKdWiTUP7PD3N5B6c15LCRmi6o8kSO+9zDAmks4EGe8fudxS\nbrBKcYgMicQSE5ccHAfNFsKFBJG2r7OAj6rEz1wvz6idSecVb0IDU08H5Zehogsb\nCmUtiBKchtiEunZfxHTs3EOPYP/KwJH9KVVyIu0sdxtCvl8IERBuJlfm0e6smjHh\nh9LbwSehpeukNwa0CdAU9RLXFoNs6twhGGqDVPHXo1+oXVhuc5vdb8cufPe7R05D\nLNooMR6HhTtZQr0sNez23KQk1ZYWqiuASIZVQAqnxpyJ/uJf2PNEUAAn2TayIPve\nwaLRzMHqoO4/WD84+xG6acXPQ6v7ZOJVQ+wwe73ZblHY7gL4j38=\n=s8Lc\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/785649f3977517a4ba45c5d2fedfbda778fb52cb",
          "sha": "785649f3977517a4ba45c5d2fedfbda778fb52cb",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/785649f3977517a4ba45c5d2fedfbda778fb52cb"
        }
      ],
      "message": "wallet: fix crash on double block disconnection\n\nThe wallet crashes if it processes the same block disconnection event twice in a row due\nto an incompatible coinbase transaction state.\nThis happens because 'disconnectBlock' provides 'TxStateInactive' without the \"abandoned\"\nflag for coinbase transactions to 'SyncTransaction', while 'AddToWallet()' internally\nmodifies it to retain the abandoned state.\n\nThe flow is as follows:\n1) On the first disconnection, the transaction state transitions from \"confirmed\" to\n\"inactive,\" bypassing the state equality check since the provided state differs. Then,\n'AddToWallet' internally updates the state to \"inactive + abandoned\"\n\n2) On the second disconnection, as we provide only the \"inactive\" state\nto 'SyncTransaction()', the state equality assertion fails and crashes the wallet.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2025-02-19T14:07:08Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2025-01-29T18:33:22Z"
      },
      "sha": "9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM4MGIxMDVmNzdkOGVlMzk3YzdkYzA3YjAxM2MzN2I3ZGY2M2FiZDU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "tree": {
        "sha": "c8ae7c99ee98bc01938550ab395d8e4d42bcd82b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c8ae7c99ee98bc01938550ab395d8e4d42bcd82b"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree c8ae7c99ee98bc01938550ab395d8e4d42bcd82b\nparent 9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865\nauthor Martin Zumsande <mzumsande@gmail.com> 1739916424 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1739985802 -0300\n\ntest: wallet, coverage for crash on dup block disconnection during unclean shutdown\n\nCo-authored-by: furszy <matiasfurszyfer@protonmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAme2E4oACgkQXdI8zGhq\npiMsxw/8Cigtatq1BX4HJqXXWiFGZ47B7zZucAu+fYGeOpQ+Cx4umAEEV7boLDJv\nLA9NVoLOcykC/Gy0AIBRBKvOI/ZS9Gj0yivPUn/t6GGtVAt9a0f/n6r7wuimXKK5\npiWM5bKfMCX2VeTu2XhYZnXwlcpSUvWSohdHd8o2tf5ALY0qS7uPBerkAal/o1/h\nMnkeMuTjNiSKVnQ1fL3dyYzwGQA3Sfk3irSA5vsGlUtLyVB3hl6t7az1MU0PqUyE\neBQBHL9ZECFBhTFzVmT7nslIjOBkWzyguNUU0JLAIDiQsO6E4t3s0kewl0Zx1RYh\nXyn74eDkHkGxBYg/UdeJeNHPZbYcgY9Z8Yr824XSHVU6h1LAmAYcQ6bKF6VsSB7n\nSyOqd7HJCJzz8tT9jcRjC4XcMx9q4zQufNUyJWhRFCJmwxrtAg3DebbQrYMrVye1\nFUE0//uu9cWlMv5hYgmKhdyGpNIQtG1E5tbRKtViCzGbVdTjLZaMeMDCZXW+S9HZ\n2nRVs+5jA5KlBXXeOrukKAmtEKejRGP8zKQAyWZ4ZGTznzB7VxcBB3B+3RFccgDU\nza+ISS1f6gWQ3NcSB4iu4NIA/HpaGX4a4IGHa6fUXwEFzk+S5klALaHK/B4F14/S\nCvEI3CQpEcBD52U89n8uv6PBV3uI9JzeU3VaK0pqw1DvrTn+zkk=\n=BmLw\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865",
          "sha": "9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9ef429b6ae65f6ad3e9ac11c2d9c0a6c52beb865"
        }
      ],
      "message": "test: wallet, coverage for crash on dup block disconnection during unclean shutdown\n\nCo-authored-by: furszy <matiasfurszyfer@protonmail.com>",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2025-02-19T17:23:22Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2025-02-18T22:07:04Z"
      },
      "sha": "c80b105f77d8ee397c7dc07b013c37b7df63abd5"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16369312125,
      "node_id": "HRFPE_lADOABII586oBhzszwAAAAPPr-F9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16369312125",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "commit_url": "https://api.github.com/repos/furszy/bitcoin-core/commits/c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "created_at": "2025-02-19T17:24:30Z"
    },
    {
      "event": "unlabeled",
      "id": 16369355017,
      "node_id": "UNLE_lADOABII586oBhzszwAAAAPPsIkJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16369355017",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-02-19T17:27:47Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1956236842",
      "pull_request_review_id": 2617954596,
      "id": 1956236842,
      "node_id": "PRRC_kwDOABII5850mc4q",
      "diff_hunk": "@@ -1545,8 +1545,11 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n \n     int disconnect_height = block.height;\n \n-    for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n-        SyncTransaction(ptx, TxStateInactive{});\n+    for (size_t index = 0; index < block.data->vtx.size(); index++) {\n+        const CTransactionRef& ptx = Assert(block.data)->vtx[index];\n+        // Coinbase transactions are not only inactive but also abandoned,\n+        // meaning they should never be relayed standalone via the p2p protocol.\n+        SyncTransaction(ptx, TxStateInactive{ /*abandoned=*/index == 0});",
      "path": "src/wallet/wallet.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```diff\r\n- for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\r\n-        SyncTransaction(ptx, TxStateInactive{});\r\n+ for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\r\n+        // Coinbase transactions are not only inactive but also abandoned,\r\n+        // meaning they should never be relayed standalone via the p2p protocol.\r\n+        SyncTransaction(ptx, TxStateInactive{ /*abandoned=*/ ptx->IsCoinBase()});\r\n```\r\n\r\nBuild and tests all good with this.\r\n\r\nI considered this with readability in mind, upon checking the `IsCoinBase()` implementation I noticed a basic sanity `if` condition on the input, which would be helpful for robustness.",
      "created_at": "2025-02-14T14:28:13Z",
      "updated_at": "2025-02-14T14:44:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1956236842",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1956236842"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 1548,
      "start_side": "LEFT",
      "line": null,
      "original_line": 1552,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959294653",
      "pull_request_review_id": 2622808152,
      "id": 1959294653,
      "node_id": "PRRC_kwDOABII5850yHa9",
      "diff_hunk": "@@ -1545,8 +1545,11 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n \n     int disconnect_height = block.height;\n \n-    for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n-        SyncTransaction(ptx, TxStateInactive{});\n+    for (size_t index = 0; index < block.data->vtx.size(); index++) {\n+        const CTransactionRef& ptx = Assert(block.data)->vtx[index];\n+        // Coinbase transactions are not only inactive but also abandoned,\n+        // meaning they should never be relayed standalone via the p2p protocol.\n+        SyncTransaction(ptx, TxStateInactive{ /*abandoned=*/index == 0});",
      "path": "src/wallet/wallet.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": 1956236842,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The same function seems to be used in the first block disconnection as well:\r\nhttps://github.com/bitcoin/bitcoin/blob/master/src/wallet/wallet.cpp#L1129",
      "created_at": "2025-02-18T08:40:18Z",
      "updated_at": "2025-02-18T08:40:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1959294653",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959294653"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 1548,
      "start_side": "LEFT",
      "line": null,
      "original_line": 1552,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959342651",
      "pull_request_review_id": 2622887690,
      "id": 1959342651,
      "node_id": "PRRC_kwDOABII5850yTI7",
      "diff_hunk": "@@ -1021,5 +1021,41 @@ BOOST_FIXTURE_TEST_CASE(wallet_sync_tx_invalid_state_test, TestingSetup)\n                           HasReason(\"DB error adding transaction to wallet, write failed\"));\n }\n \n+/**\n+ * Verify the wallet does not crash when the same block is disconnected twice due to an incompatible coinbase transaction state.\n+ */\n+BOOST_FIXTURE_TEST_CASE(wallet_crash_during_disconnectBlock, TestChain100Setup)\n+{\n+    const auto& chainman = Assert(m_node.chainman);\n+    const int64_t BLOCK_TIME = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip()->GetBlockTimeMax() + 5);\n+    SetMockTime(BLOCK_TIME);  // to by-pass the wallet birth time.\n+\n+    CKey key;\n+    key.MakeNewKey(true);\n+    CreateAndProcessBlock({}, GetScriptForRawPubKey(key.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain()), key);\n+    BOOST_CHECK(GetBalance(*wallet, /*min_depth=*/0, false).m_mine_immature == 50 * COIN);\n+\n+    // Fetch the latest block data.\n+    CBlockIndex* tip = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip());\n+    CBlock block_data;\n+    m_node.chain->findBlock(tip->GetBlockHash(), interfaces::FoundBlock().data(block_data));\n+\n+    // Construct block info for disconnection\n+    interfaces::BlockInfo info(*tip->phashBlock);\n+    info.data = &block_data;\n+    info.prev_hash = tip->phashBlock;",
      "path": "src/wallet/test/wallet_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```diff\r\n- info.prev_hash = tip->phashBlock;\r\n+ info.prev_hash = tip->pprev->phashBlock;\r\n```\r\n\r\nThe hash of the previous block needs to be added here instead of the hash of the same block. I ran the test with this and it works.\r\n\r\nReference: `MakeBlockInfo()` here https://github.com/bitcoin/bitcoin/blob/9da0820ec55e136d5213bf5bb90c36499debc034/src/kernel/chain.cpp#L18\r\n\r\nThe `pprev` presence check can be avoided because the test is using `TestChain100Setup` that has 100 blocks mined already leading to `pprev` being present after `CreateAndProcessBlock()` is called on line 1035.",
      "created_at": "2025-02-18T09:11:33Z",
      "updated_at": "2025-02-18T09:20:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1959342651",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959342651"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1047,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959355949",
      "pull_request_review_id": 2622887690,
      "id": 1959355949,
      "node_id": "PRRC_kwDOABII5850yWYt",
      "diff_hunk": "@@ -1021,5 +1021,41 @@ BOOST_FIXTURE_TEST_CASE(wallet_sync_tx_invalid_state_test, TestingSetup)\n                           HasReason(\"DB error adding transaction to wallet, write failed\"));\n }\n \n+/**\n+ * Verify the wallet does not crash when the same block is disconnected twice due to an incompatible coinbase transaction state.\n+ */\n+BOOST_FIXTURE_TEST_CASE(wallet_crash_during_disconnectBlock, TestChain100Setup)\n+{\n+    const auto& chainman = Assert(m_node.chainman);\n+    const int64_t BLOCK_TIME = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip()->GetBlockTimeMax() + 5);\n+    SetMockTime(BLOCK_TIME);  // to by-pass the wallet birth time.",
      "path": "src/wallet/test/wallet_tests.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> // to by-pass the wallet birth time.\r\n\r\nCan you explain this a bit more? I ran the test w/o it and it works.",
      "created_at": "2025-02-18T09:19:57Z",
      "updated_at": "2025-02-18T09:20:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1959355949",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1959355949"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 1030,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1031,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1960663432",
      "pull_request_review_id": 2625159984,
      "id": 1960663432,
      "node_id": "PRRC_kwDOABII58503VmI",
      "diff_hunk": "@@ -1021,5 +1021,41 @@ BOOST_FIXTURE_TEST_CASE(wallet_sync_tx_invalid_state_test, TestingSetup)\n                           HasReason(\"DB error adding transaction to wallet, write failed\"));\n }\n \n+/**\n+ * Verify the wallet does not crash when the same block is disconnected twice due to an incompatible coinbase transaction state.\n+ */\n+BOOST_FIXTURE_TEST_CASE(wallet_crash_during_disconnectBlock, TestChain100Setup)\n+{\n+    const auto& chainman = Assert(m_node.chainman);\n+    const int64_t BLOCK_TIME = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip()->GetBlockTimeMax() + 5);\n+    SetMockTime(BLOCK_TIME);  // to by-pass the wallet birth time.",
      "path": "src/wallet/test/wallet_tests.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": 1959355949,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It was a leftover from a previous implementation. But see https://github.com/bitcoin/bitcoin/pull/27469.",
      "created_at": "2025-02-18T22:10:55Z",
      "updated_at": "2025-02-18T22:10:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1960663432",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1960663432"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 1030,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1031,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1960664340",
      "pull_request_review_id": 2625161384,
      "id": 1960664340,
      "node_id": "PRRC_kwDOABII58503V0U",
      "diff_hunk": "@@ -1021,5 +1021,41 @@ BOOST_FIXTURE_TEST_CASE(wallet_sync_tx_invalid_state_test, TestingSetup)\n                           HasReason(\"DB error adding transaction to wallet, write failed\"));\n }\n \n+/**\n+ * Verify the wallet does not crash when the same block is disconnected twice due to an incompatible coinbase transaction state.\n+ */\n+BOOST_FIXTURE_TEST_CASE(wallet_crash_during_disconnectBlock, TestChain100Setup)\n+{\n+    const auto& chainman = Assert(m_node.chainman);\n+    const int64_t BLOCK_TIME = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip()->GetBlockTimeMax() + 5);\n+    SetMockTime(BLOCK_TIME);  // to by-pass the wallet birth time.\n+\n+    CKey key;\n+    key.MakeNewKey(true);\n+    CreateAndProcessBlock({}, GetScriptForRawPubKey(key.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain()), key);\n+    BOOST_CHECK(GetBalance(*wallet, /*min_depth=*/0, false).m_mine_immature == 50 * COIN);\n+\n+    // Fetch the latest block data.\n+    CBlockIndex* tip = WITH_LOCK(chainman->GetMutex(), return chainman->ActiveChain().Tip());\n+    CBlock block_data;\n+    m_node.chain->findBlock(tip->GetBlockHash(), interfaces::FoundBlock().data(block_data));\n+\n+    // Construct block info for disconnection\n+    interfaces::BlockInfo info(*tip->phashBlock);\n+    info.data = &block_data;\n+    info.prev_hash = tip->phashBlock;",
      "path": "src/wallet/test/wallet_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "4229839b454befea2e18764eee20186b6c18f1c5",
      "in_reply_to_id": 1959342651,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ended up changing the testing approach, preferring functional over unit tests. But thanks.",
      "created_at": "2025-02-18T22:11:44Z",
      "updated_at": "2025-02-18T22:11:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1960664340",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1960664340"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1047,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961582654",
      "pull_request_review_id": 2626627692,
      "id": 1961582654,
      "node_id": "PRRC_kwDOABII585062A-",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 28,
      "original_position": 20,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can add a comment here highlighting that this RPC call is added to ensure the block disconnected notification is handled by the wallet.",
      "created_at": "2025-02-19T12:22:18Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961582654",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961582654"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 110,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961623606",
      "pull_request_review_id": 2626627692,
      "id": 1961623606,
      "node_id": "PRRC_kwDOABII58507AA2",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 15,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Might be in the nit-land but I find reading `25` here distracting. I had to figure out why it's 25 that is because in regtest the subsidy halving interval is 150 and initially a 199 blocks long chain is created in the regtest. The block count at this stage is 215 which is because few blocks were created in the preceding test in this file, thereby making this test dependent on the changes of that test as well.\r\nIMO, a simple balance greater than 0 check is sufficient.\r\n\r\nAlso generally, I am inclined to creating and using a constant, for such usages of 25, called `INITIAL_ACTIVE_BLOCK_REWARD` in the test framework.",
      "created_at": "2025-02-19T12:49:45Z",
      "updated_at": "2025-02-19T16:52:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961623606",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961623606"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 45,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961637704",
      "pull_request_review_id": 2626627692,
      "id": 1961637704,
      "node_id": "PRRC_kwDOABII58507DdI",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 28,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This test passes in my system but one thing that's on my mind is that can this test ever become flaky? Can there be a scenario that the best block locator changes are written to the disk before the node is killed here? Do you think a time delay should be added before killing the node here? ",
      "created_at": "2025-02-19T12:59:18Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961637704",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961637704"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 57,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961641424",
      "pull_request_review_id": 2626627692,
      "id": 1961641424,
      "node_id": "PRRC_kwDOABII58507EXQ",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 27,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```diff\r\n+  # Abort process abruptly to force an unclean shutdown (no flush) so that the best block locator changes are not persisted\r\n```",
      "created_at": "2025-02-19T13:01:48Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961641424",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961641424"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 57,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961643854",
      "pull_request_review_id": 2626627692,
      "id": 1961643854,
      "node_id": "PRRC_kwDOABII58507E9O",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()\n+\n+        # Start wallet again. Ensure the tx is still abandoned and the wallet has no balance.\n+        self.start_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getbestblockhash(), tip)\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        wallet.invalidateblock(tip)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 47,
      "original_position": 35,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can add a comment here: `Disconnect tip again`",
      "created_at": "2025-02-19T13:03:26Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961643854",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961643854"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 129,
      "original_line": 129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961647929",
      "pull_request_review_id": 2626627692,
      "id": 1961647929,
      "node_id": "PRRC_kwDOABII58507F85",
      "diff_hunk": "@@ -1545,8 +1545,11 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n \n     int disconnect_height = block.height;\n \n-    for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n-        SyncTransaction(ptx, TxStateInactive{});\n+    for (size_t index = 0; index < block.data->vtx.size(); index++) {\n+        const CTransactionRef& ptx = Assert(block.data)->vtx[index];\n+        // Coinbase transactions are not only inactive but also abandoned,\n+        // meaning they should never be relayed standalone via the p2p protocol.\n+        SyncTransaction(ptx, TxStateInactive{/*abandoned=*/index == 0});",
      "path": "src/wallet/wallet.cpp",
      "position": 10,
      "original_position": 10,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "f99b2f136c229b8199ce14b96a9472f37ba0e043",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Re: https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1956236842\r\n\r\nBringing it back again because I feel besides the robustness `IsCoinBase()` brings in here, we can also get rid of introducing `index` that is not used elsewhere in the function.\r\n\r\nLMK your thoughts.",
      "created_at": "2025-02-19T13:06:22Z",
      "updated_at": "2025-02-19T13:37:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961647929",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961647929"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": 1551,
      "original_start_line": 1548,
      "start_side": "RIGHT",
      "line": 1555,
      "original_line": 1555,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961669843",
      "pull_request_review_id": 2626627692,
      "id": 1961669843,
      "node_id": "PRRC_kwDOABII58507LTT",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()\n+\n+        # Start wallet again. Ensure the tx is still abandoned and the wallet has no balance.\n+        self.start_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getbestblockhash(), tip)\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        wallet.invalidateblock(tip)\n+        # Ensure abandoned state persists after restart\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 52,
      "original_position": 37,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Might not hurt to check for wallet balance again. But more importantly it would be nice to check that the best block hash is not `tip` now like below. Should we stop the node again (cleanly this time) and check this on start? \r\n\r\n```diff\r\n+ assert_equal(node.getbestblockhash() == tip, False)\r\n```",
      "created_at": "2025-02-19T13:20:27Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961669843",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961669843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 134,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961680280",
      "pull_request_review_id": 2626627692,
      "id": 1961680280,
      "node_id": "PRRC_kwDOABII58507N2Y",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 34,
      "original_position": 26,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Interesting that the best block hash at the stage is not the `tip` because of invalidation but not so after unclean-stop-start.\r\n\r\n```\r\nassert_equal(node.getbestblockhash() == tip, False)\r\n```",
      "created_at": "2025-02-19T13:27:01Z",
      "updated_at": "2025-02-19T16:50:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961680280",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961680280"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 116,
      "original_line": 116,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961687763",
      "pull_request_review_id": 2626627692,
      "id": 1961687763,
      "node_id": "PRRC_kwDOABII58507PrT",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 5,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`Test that wallet doesn't crash due to a duplicate block disconnection event after an unclean shutdown`",
      "created_at": "2025-02-19T13:31:39Z",
      "updated_at": "2025-02-19T13:36:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961687763",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961687763"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961986354",
      "pull_request_review_id": 2627332404,
      "id": 1961986354,
      "node_id": "PRRC_kwDOABII58508Yky",
      "diff_hunk": "@@ -1545,8 +1545,11 @@ void CWallet::blockDisconnected(const interfaces::BlockInfo& block)\n \n     int disconnect_height = block.height;\n \n-    for (const CTransactionRef& ptx : Assert(block.data)->vtx) {\n-        SyncTransaction(ptx, TxStateInactive{});\n+    for (size_t index = 0; index < block.data->vtx.size(); index++) {\n+        const CTransactionRef& ptx = Assert(block.data)->vtx[index];\n+        // Coinbase transactions are not only inactive but also abandoned,\n+        // meaning they should never be relayed standalone via the p2p protocol.\n+        SyncTransaction(ptx, TxStateInactive{/*abandoned=*/index == 0});",
      "path": "src/wallet/wallet.cpp",
      "position": 10,
      "original_position": 10,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "f99b2f136c229b8199ce14b96a9472f37ba0e043",
      "in_reply_to_id": 1961647929,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Bringing it back again because I feel besides the robustness IsCoinBase() brings in here\r\n\r\nBy consensus, coinbase transactions must be the first in a block. Using `IsCoinBase()` is slightly more readable but not more robust. It is also a slower check, as it verifies that all bytes in the input hash are zero for every tx in the block. I'm a ~0 here.",
      "created_at": "2025-02-19T16:17:35Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961986354",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961986354"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": 1551,
      "original_start_line": 1548,
      "start_side": "RIGHT",
      "line": 1555,
      "original_line": 1555,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961997545",
      "pull_request_review_id": 2627332404,
      "id": 1961997545,
      "node_id": "PRRC_kwDOABII58508bTp",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 28,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961637704,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> This test passes in my system but one thing that's on my mind is that can this test ever become flaky? Can there be a scenario that the best block locator changes are written to the disk before the node is killed here?\r\n\r\nThat wouldnâ€™t be a problem, it would be a fix. See #30221 and the last paragraph of #31824â€™s issue description.\r\n\r\n> Do you think a time delay should be added before killing the node here?\r\n\r\nThe test will still pass if the best locator is flushed to disk before the abrupt shutdown. And thatâ€™s fine, thatâ€™s the expected behavior.",
      "created_at": "2025-02-19T16:24:35Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1961997545",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1961997545"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": 57,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962084604",
      "pull_request_review_id": 2627332404,
      "id": 1962084604,
      "node_id": "PRRC_kwDOABII58508wj8",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()\n+\n+        # Start wallet again. Ensure the tx is still abandoned and the wallet has no balance.\n+        self.start_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getbestblockhash(), tip)\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        wallet.invalidateblock(tip)\n+        # Ensure abandoned state persists after restart\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 52,
      "original_position": 37,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961669843,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Should we stop the node again (cleanly this time) and check this on start?\r\n\r\nThere should be another test case already ensuring locator persistence during a clean shutdown.",
      "created_at": "2025-02-19T17:20:19Z",
      "updated_at": "2025-02-19T17:27:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962084604",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962084604"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 134,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962091902",
      "pull_request_review_id": 2627332404,
      "id": 1962091902,
      "node_id": "PRRC_kwDOABII58508yV-",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)\n+        node.process.kill()\n+\n+        # Start wallet again. Ensure the tx is still abandoned and the wallet has no balance.\n+        self.start_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getbestblockhash(), tip)\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        wallet.invalidateblock(tip)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 47,
      "original_position": 35,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961643854,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done as suggested",
      "created_at": "2025-02-19T17:25:09Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962091902",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962091902"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 129,
      "original_line": 129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092019",
      "pull_request_review_id": 2627332404,
      "id": 1962092019,
      "node_id": "PRRC_kwDOABII58508yXz",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()\n+\n+        # Tip was disconnected, ensure coinbase has been abandoned\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 0)\n+        coinbase_tx_id = wallet.getblock(tip, verbose=1)[\"tx\"][0]\n+        assert_equal(wallet.gettransaction(coinbase_tx_id)['details'][0]['abandoned'], True)\n+\n+        # Abort process abruptly to force an unclean shutdown (no flush)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 27,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961641424,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done as suggested",
      "created_at": "2025-02-19T17:25:13Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962092019",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092019"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 57,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092246",
      "pull_request_review_id": 2627332404,
      "id": 1962092246,
      "node_id": "PRRC_kwDOABII58508ybW",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 15,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961623606,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done as suggested",
      "created_at": "2025-02-19T17:25:22Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962092246",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092246"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 45,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092420",
      "pull_request_review_id": 2627332404,
      "id": 1962092420,
      "node_id": "PRRC_kwDOABII58508yeE",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")\n+        node = self.nodes[0]\n+        # Receive coinbase reward on a new wallet\n+        node.createwallet(wallet_name=\"reorg_crash\", load_on_startup=True)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        self.generatetoaddress(node, 1, wallet.getnewaddress(), sync_fun=self.no_op)\n+\n+        # Restart to ensure node and wallet are flushed\n+        self.restart_node(0)\n+        wallet = node.get_wallet_rpc(\"reorg_crash\")\n+        assert_equal(wallet.getwalletinfo()['immature_balance'], 25)\n+\n+        # Disconnect tip\n+        tip = wallet.getbestblockhash()\n+        wallet.invalidateblock(tip)\n+        wallet.syncwithvalidationinterfacequeue()",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": 28,
      "original_position": 20,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961582654,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done as suggested",
      "created_at": "2025-02-19T17:25:28Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962092420",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092420"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 110,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092648",
      "pull_request_review_id": 2627332404,
      "id": 1962092648,
      "node_id": "PRRC_kwDOABII58508yho",
      "diff_hunk": "@@ -31,6 +31,41 @@ def set_test_params(self):\n     def skip_test_if_missing_module(self):\n         self.skip_if_no_wallet()\n \n+    def test_reorg_handling_during_unclean_shutdown(self):\n+        self.log.info(\"Test crash due to a duplicate block disconnection event during an unclean shutdown\")",
      "path": "test/functional/wallet_reorgsrestore.py",
      "position": null,
      "original_position": 5,
      "commit_id": "c80b105f77d8ee397c7dc07b013c37b7df63abd5",
      "original_commit_id": "df87cf2a52b6a7f106fa144c5254d3e73ae89c63",
      "in_reply_to_id": 1961687763,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done as suggested",
      "created_at": "2025-02-19T17:25:39Z",
      "updated_at": "2025-02-19T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31757#discussion_r1962092648",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1962092648"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31757"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    }
  ]
}