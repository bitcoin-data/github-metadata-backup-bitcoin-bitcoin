{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996",
    "id": 1845963395,
    "node_id": "PR_kwDOABII585uByqD",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/29996",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/29996.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/29996.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/5478d9c4fde00556b18f25a530e2f468fd1b402e",
    "number": 29996,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "test: Assumeutxo: import snapshot in a node with a divergent chain",
    "user": {
      "login": "alfonsoromanz",
      "id": 19962151,
      "node_id": "MDQ6VXNlcjE5OTYyMTUx",
      "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alfonsoromanz",
      "html_url": "https://github.com/alfonsoromanz",
      "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
      "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
      "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
      "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
      "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This PR adds tests to cover two scenarios of loading a snapshot when the current chain tip is:\r\n\r\n- Not an ancestor of the snapshot block but has less work\r\n- Not an ancestor or a descendant of the snapshot block and has more work\r\n\r\nDuring the review process, a bug was found where if the background tip is not an ancestor of the snapshot, blocks in between that ancestor up to the height of the background tip are never requested. @mzumsande provided a fix to start downloading historical blocks from the last common ancestor to avoid this issue. I have incorporated this fix into the PR as well.\r\n\r\nIn the second scenario: \"Not an ancestor or a descendant of the snapshot block and has more work\" the snapshot block does not belong to the most-work chain anymore so I believe it covers this scenario too: `TODO: Valid snapshot file and snapshot block, but the block is not on the\r\n      most-work chain`. Therefore I deleted that TODO as well.",
    "labels": [
      {
        "id": 62963516,
        "node_id": "MDU6TGFiZWw2Mjk2MzUxNg==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests",
        "name": "Tests",
        "color": "d4c5f9",
        "default": false
      }
    ],
    "created_at": "2024-04-29T15:13:24Z",
    "updated_at": "2024-06-22T04:53:02Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "67f14131e81884a754a12c24976948a350ce3410",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "alfonsoromanz:assumeutxo_tests",
      "ref": "assumeutxo_tests",
      "sha": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 742079678,
        "node_id": "R_kgDOLDs8vg",
        "name": "bitcoin",
        "full_name": "alfonsoromanz/bitcoin",
        "owner": {
          "login": "alfonsoromanz",
          "id": 19962151,
          "node_id": "MDQ6VXNlcjE5OTYyMTUx",
          "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/alfonsoromanz",
          "html_url": "https://github.com/alfonsoromanz",
          "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
          "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
          "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
          "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
          "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/alfonsoromanz/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/alfonsoromanz/bitcoin",
        "archive_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/events",
        "forks_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/alfonsoromanz/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:alfonsoromanz/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/alfonsoromanz/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/alfonsoromanz/bitcoin/hooks",
        "svn_url": "https://github.com/alfonsoromanz/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 0,
        "watchers_count": 0,
        "size": 219609,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": true,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-06-19T13:12:05Z",
        "created_at": "2024-01-11T18:09:37Z",
        "updated_at": "2024-06-06T09:50:10Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "2d21060af831fa8f8f1791b4464961d5f28a88cb",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35551,
        "stargazers_count": 76979,
        "watchers_count": 76979,
        "size": 261806,
        "default_branch": "master",
        "open_issues_count": 684,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-06-22T02:17:06Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-06-22T03:01:28Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 49,
    "deletions": 8,
    "changed_files": 2,
    "commits": 3,
    "review_comments": 47,
    "comments": 9
  },
  "events": [
    {
      "event": "commented",
      "id": 2083008209,
      "node_id": "IC_kwDOABII5858KC7R",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083008209",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T15:13:27Z",
      "updated_at": "2024-06-22T04:53:02Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29996).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [naiyoma](https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282) |\n| Stale ACK | [rkrux](https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2045600755) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30320](https://github.com/bitcoin/bitcoin/pull/30320) (assumeutxo: Don't load a snapshot if it's not in the best header chain by mzumsande)\n* [#29681](https://github.com/bitcoin/bitcoin/pull/29681) (test: loading assumeutxo snapshot start states by BrandonOdiwuor)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2083008209",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "labeled",
      "id": 12644821120,
      "node_id": "LE_lADOABII586HQtfUzwAAAALxsKiA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12644821120",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T15:13:30Z",
      "label": {
        "name": "Tests",
        "color": "d4c5f9"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12662791451,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAALywt0b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12662791451",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-30T19:15:13Z"
    },
    {
      "event": "commented",
      "id": 2086782948,
      "node_id": "IC_kwDOABII5858Ycfk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2086782948",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-30T19:25:18Z",
      "updated_at": "2024-04-30T19:25:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "I splitted the original commit into two commits (one for each test). The second test (https://github.com/bitcoin/bitcoin/pull/29996/commits/af0f401258e0c189799a36f4487eaa751d779e7b) may be redundant with this one: https://github.com/bitcoin/bitcoin/pull/29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n\r\n `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n \r\n If it's redundant I can delete the second commit. Thoughts?",
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2086782948",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "commented",
      "id": 2087518282,
      "node_id": "IC_kwDOABII5858bQBK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2087518282",
      "actor": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-30T22:05:06Z",
      "updated_at": "2024-04-30T22:05:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK, covers more tests scenarios for AssumeUTXO\r\n",
      "user": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2087518282",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "reviewed",
      "id": 2034676796,
      "node_id": "PRR_kwDOABII5855RrQ8",
      "url": null,
      "actor": null,
      "commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "",
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2034676796",
      "submitted_at": "2024-05-02T01:42:13Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12681863066,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAALz5d-a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12681863066",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-02T11:34:11Z"
    },
    {
      "event": "reviewed",
      "id": 2045600755,
      "node_id": "PRR_kwDOABII58557WPz",
      "url": null,
      "actor": null,
      "commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "tACK [ce80f7e](https://github.com/bitcoin/bitcoin/pull/29996/commits/ce80f7ec9a66d594c3a6a6e249f911e9e543a623)\r\n\r\nMake and tests successful, thanks for adding this test - it's easy to follow through.",
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2045600755",
      "submitted_at": "2024-05-08T13:16:53Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "labeled",
      "id": 12784107994,
      "node_id": "LE_lADOABII586HQtfUzwAAAAL5_gHa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12784107994",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-13T09:21:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12789048126,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAAL6SWM-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12789048126",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-13T15:09:12Z"
    },
    {
      "event": "commented",
      "id": 2107965861,
      "node_id": "IC_kwDOABII5859pQGl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2107965861",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-13T15:18:56Z",
      "updated_at": "2024-05-13T15:18:56Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased. I also addressed some feedback from rkrux's comments: changed hardcoded value of `nblocks` from 99 to a dynamic value, i.e `SNAPSHOT_BASE_HEIGHT-START_HEIGHT-1`",
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2107965861",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "unlabeled",
      "id": 12789412620,
      "node_id": "UNLE_lADOABII586HQtfUzwAAAAL6TvMM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12789412620",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-13T15:35:39Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2116143536,
      "node_id": "IC_kwDOABII585-Icmw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116143536",
      "actor": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T20:43:23Z",
      "updated_at": "2024-05-16T20:43:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "\r\nTest  passes for  all three scenarios: \r\n- [x] https://github.com/bitcoin/bitcoin/pull/29996/commits/a7501f779eb84effd5579070b8b1c1a3020273d6 loading a snapshot when chain tip isn't ancestor but has less work\r\n- [x] https://github.com/bitcoin/bitcoin/pull/29996/commits/3f033542b869dfbe037cda705c3b8f7faa32da5d loading a snapshot when chain tip isn't ancestor/descendant, has more work  and A valid snapshot file & snapshot block, but the block is not on the most-work chain",
      "user": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2116143536",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "commented",
      "id": 2116200874,
      "node_id": "IC_kwDOABII585-Iqmq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2116200874",
      "actor": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T21:17:14Z",
      "updated_at": "2024-05-16T21:17:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "\r\n\r\n\r\n> I splitted the original commit into two commits (one for each test). The second test ([af0f401](https://github.com/bitcoin/bitcoin/commit/af0f401258e0c189799a36f4487eaa751d779e7b)) may be redundant with this one: #29428. The only difference is that my test is executed on a node that has a divergent chain after block 199. I did that to cover this scenario described in the comments\r\n> \r\n> `[...] Loading a snapshot when the current chain tip is: [...] Not an ancestor or a descendant of the snapshot block and has more work`\r\n> \r\n> If it's redundant I can delete the second commit. Thoughts?\r\n\r\nIMO you should not delete the second commit,  both tests verify that the snapshot load fails but under different scenarios",
      "user": {
        "login": "naiyoma",
        "id": 40592031,
        "node_id": "MDQ6VXNlcjQwNTkyMDMx",
        "avatar_url": "https://avatars.githubusercontent.com/u/40592031?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naiyoma",
        "html_url": "https://github.com/naiyoma",
        "followers_url": "https://api.github.com/users/naiyoma/followers",
        "following_url": "https://api.github.com/users/naiyoma/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naiyoma/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naiyoma/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naiyoma/subscriptions",
        "organizations_url": "https://api.github.com/users/naiyoma/orgs",
        "repos_url": "https://api.github.com/users/naiyoma/repos",
        "events_url": "https://api.github.com/users/naiyoma/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naiyoma/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2116200874",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "labeled",
      "id": 13043169102,
      "node_id": "LE_lADOABII586HQtfUzwAAAAMJbvdO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13043169102",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-05T00:09:59Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13064131706,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAAMKrtR6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13064131706",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-06T09:57:31Z"
    },
    {
      "event": "reviewed",
      "id": 2101629969,
      "node_id": "PRR_kwDOABII5859RFQR",
      "url": null,
      "actor": null,
      "commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2101629969",
      "submitted_at": "2024-06-06T11:01:07Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "unlabeled",
      "id": 13065358194,
      "node_id": "UNLE_lADOABII586HQtfUzwAAAAMKwYty",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13065358194",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-06T11:39:58Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2109771701,
      "node_id": "PRR_kwDOABII5859wI-1",
      "url": null,
      "actor": null,
      "commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2109771701",
      "submitted_at": "2024-06-11T08:52:17Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "reviewed",
      "id": 2109806294,
      "node_id": "PRR_kwDOABII5859wRbW",
      "url": null,
      "actor": null,
      "commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2109806294",
      "submitted_at": "2024-06-11T09:02:42Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "reviewed",
      "id": 2109882346,
      "node_id": "PRR_kwDOABII5859wj_q",
      "url": null,
      "actor": null,
      "commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2109882346",
      "submitted_at": "2024-06-11T09:26:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "commented",
      "id": 2160819048,
      "node_id": "IC_kwDOABII586Ay3to",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2160819048",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-11T13:49:51Z",
      "updated_at": "2024-06-11T14:59:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "> This PR adds tests to cover two scenarios of loading a snapshot when the current chain tip is:\r\n> \r\n>* Not an ancestor of the snapshot block but has less work\r\n> \r\n>* Not an ancestor or a descendant of the snapshot block and has more work\r\n> \r\n> In the second scenario, the snapshot block does not belong to the most-work chain anymore so I believe it covers this scenario too: `TODO: Valid snapshot file and snapshot block, but the block is not on the most-work chain`. Therefore I deleted that TODO as well.\r\n\r\nI'm not sure about this last part. It should be possible for the current chain tip to have more work than the snapshot block, which is on a different chain, and for the chain the snapshot block is on to ultimately be the most-work chain. Maybe this is not an interesting scenario to test though, since it involves a later-reorg. I'm not sure.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2160819048",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDhiNmExOGE3ZDViZGM2YjJiYjA1NzYxM2U2NjE4MTY5MTczMTQwODQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8b6a18a7d5bdc6b2bb057613e661816917314084",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8b6a18a7d5bdc6b2bb057613e661816917314084",
      "tree": {
        "sha": "ce39dcda074cd56855534335cb69e979de7a188d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ce39dcda074cd56855534335cb69e979de7a188d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f47cd649e970b37fcd1fc31bbadaebf49566ee73",
          "sha": "f47cd649e970b37fcd1fc31bbadaebf49566ee73",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f47cd649e970b37fcd1fc31bbadaebf49566ee73"
        }
      ],
      "message": "p2p: Start downloading historical blocks from common ancestor\n\nOtherwise, if the background tip is not an ancestor of the snapshot, blocks in between that ancestor up to the height of the background tip will never be requested.",
      "committer": {
        "name": "Alfonso Roman Zubeldia",
        "email": "19962151+alfonsoromanz@users.noreply.github.com",
        "date": "2024-06-12T05:54:46Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2024-06-10T22:20:15Z"
      },
      "sha": "8b6a18a7d5bdc6b2bb057613e661816917314084"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13126599097,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAAMOaAG5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13126599097",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-12T06:35:10Z"
    },
    {
      "event": "mentioned",
      "id": 13126665910,
      "node_id": "MEE_lADOABII586HQtfUzwAAAAMOaQa2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13126665910",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-12T06:41:36Z"
    },
    {
      "event": "subscribed",
      "id": 13126665919,
      "node_id": "SE_lADOABII586HQtfUzwAAAAMOaQa_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13126665919",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-12T06:41:36Z"
    },
    {
      "event": "commented",
      "id": 2162284182,
      "node_id": "IC_kwDOABII586A4daW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2162284182",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-12T07:16:54Z",
      "updated_at": "2024-06-12T07:16:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "> > This PR adds tests to cover two scenarios of loading a snapshot when the current chain tip is:\r\n> > \r\n> > * Not an ancestor of the snapshot block but has less work\r\n> > * Not an ancestor or a descendant of the snapshot block and has more work\r\n> > \r\n> > In the second scenario, the snapshot block does not belong to the most-work chain anymore so I believe it covers this scenario too: `TODO: Valid snapshot file and snapshot block, but the block is not on the most-work chain`. Therefore I deleted that TODO as well.\r\n> \r\n> I'm not sure about this last part. It should be possible for the current chain tip to have more work than the snapshot block, which is on a different chain, and for the chain the snapshot block is on to ultimately be the most-work chain. Maybe this is not an interesting scenario to test though, since it involves a later-reorg. I'm not sure.\r\n\r\nYes, that makes sense. I am not sure what exact scenario the comment refers to. If my statement is not correct, I can undo the comment deletion.",
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2162284182",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "reviewed",
      "id": 2125850159,
      "node_id": "PRR_kwDOABII585-teYv",
      "url": null,
      "actor": null,
      "commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#pullrequestreview-2125850159",
      "submitted_at": "2024-06-18T16:27:12Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13215099977,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAAMTrmxJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13215099977",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-19T11:43:15Z"
    },
    {
      "event": "commented",
      "id": 2178578099,
      "node_id": "IC_kwDOABII586B2naz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2178578099",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-19T12:26:32Z",
      "updated_at": "2024-06-19T12:26:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Pushed changes to address the latest feedback from fjahr",
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#issuecomment-2178578099",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29996"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDM1YWMyMDIyZGI5ZjU4MGE3NmZjMmViMGJjMDkyYzA4YWNlOTNiNWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/35ac2022db9f580a76fc2eb0bc092c08ace93b5b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/35ac2022db9f580a76fc2eb0bc092c08ace93b5b",
      "tree": {
        "sha": "df04ab1bfb7f9ca80857c3ec59e4d4bf6dd3c395",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/df04ab1bfb7f9ca80857c3ec59e4d4bf6dd3c395"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8b6a18a7d5bdc6b2bb057613e661816917314084",
          "sha": "8b6a18a7d5bdc6b2bb057613e661816917314084",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8b6a18a7d5bdc6b2bb057613e661816917314084"
        }
      ],
      "message": "test: loadtxoutset in divergent chain with less work",
      "committer": {
        "name": "Alfonso Roman Zubeldia",
        "email": "19962151+alfonsoromanz@users.noreply.github.com",
        "date": "2024-06-19T13:07:55Z"
      },
      "author": {
        "name": "Alfonso Roman Zubeldia",
        "email": "19962151+alfonsoromanz@users.noreply.github.com",
        "date": "2024-06-19T13:07:55Z"
      },
      "sha": "35ac2022db9f580a76fc2eb0bc092c08ace93b5b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU0NzhkOWM0ZmRlMDA1NTZiMThmMjVhNTMwZTJmNDY4ZmQxYjQwMmU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "tree": {
        "sha": "c4d732c5f53d2d4368695aee5584845b2c9c7076",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c4d732c5f53d2d4368695aee5584845b2c9c7076"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/35ac2022db9f580a76fc2eb0bc092c08ace93b5b",
          "sha": "35ac2022db9f580a76fc2eb0bc092c08ace93b5b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/35ac2022db9f580a76fc2eb0bc092c08ace93b5b"
        }
      ],
      "message": "test: loadtxoutset in divergent chain with more work",
      "committer": {
        "name": "Alfonso Roman Zubeldia",
        "email": "19962151+alfonsoromanz@users.noreply.github.com",
        "date": "2024-06-19T13:11:44Z"
      },
      "author": {
        "name": "Alfonso Roman Zubeldia",
        "email": "19962151+alfonsoromanz@users.noreply.github.com",
        "date": "2024-06-19T13:11:44Z"
      },
      "sha": "5478d9c4fde00556b18f25a530e2f468fd1b402e"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13216335961,
      "node_id": "HRFPE_lADOABII586HQtfUzwAAAAMTwUhZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13216335961",
      "actor": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-19T13:12:06Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904",
      "pull_request_review_id": 2034676796,
      "id": 1586967904,
      "node_id": "PRRC_kwDOABII585elzVg",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 42,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "instead of number `298` would it make more sense to use `SNAPSHOT_BASE_HEIGHT`?",
      "created_at": "2024-05-02T01:23:21Z",
      "updated_at": "2024-05-02T01:42:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586967904",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586967904"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840",
      "pull_request_review_id": 2034676796,
      "id": 1586968840,
      "node_id": "PRRC_kwDOABII585elzkI",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 25,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "is this not the same as `START_HEIGHT`?",
      "created_at": "2024-05-02T01:25:20Z",
      "updated_at": "2024-05-02T01:42:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586968840",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586968840"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804",
      "pull_request_review_id": 2034676796,
      "id": 1586972804,
      "node_id": "PRRC_kwDOABII585el0iE",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 29,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n        block_hash = node.getblockhash(START_HEIGHT + 1)\r\n        node.invalidateblock(block_hash)\r\n        assert_equal(node.getblockcount(), START_HEIGHT)\r\n```",
      "created_at": "2024-05-02T01:34:42Z",
      "updated_at": "2024-05-02T01:42:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1586972804",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1586972804"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": 156,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035",
      "pull_request_review_id": 2035514730,
      "id": 1587494035,
      "node_id": "PRRC_kwDOABII585enzyT",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert_equal(node.getblockcount(), 298)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 42,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": 1586967904,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Actually `SNAPSHOT_BASE_HEIGHT` is 299, and here I am trying to make sure that the snapshot was deleted and therefore the node is now using it's previous chain which has less work. I changed it to `assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT`  for more clarity",
      "created_at": "2024-05-02T11:38:57Z",
      "updated_at": "2024-05-02T11:38:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587494035",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587494035"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652",
      "pull_request_review_id": 2035516343,
      "id": 1587496652,
      "node_id": "PRRC_kwDOABII585en0bM",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 25,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": 1586968840,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes, good catch. This line was removed since the iteration is no longer needed based on your other comment below.",
      "created_at": "2024-05-02T11:39:39Z",
      "updated_at": "2024-05-02T11:39:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587496652",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587496652"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230",
      "pull_request_review_id": 2035516963,
      "id": 1587497230,
      "node_id": "PRRC_kwDOABII585en0kO",
      "diff_hunk": "@@ -152,6 +148,38 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        current_height = node.getblockcount()\n+        base_height = 199\n+        for block_height in range(current_height, base_height, -1):\n+            block_hash = node.getblockhash(block_height)\n+            node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 29,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "af0f401258e0c189799a36f4487eaa751d779e7b",
      "in_reply_to_id": 1586972804,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "That's a good one. Thanks. I Fixed it.",
      "created_at": "2024-05-02T11:39:59Z",
      "updated_at": "2024-05-02T11:39:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1587497230",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1587497230"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": 156,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574",
      "pull_request_review_id": 2045600755,
      "id": 1593998574,
      "node_id": "PRRC_kwDOABII585fAnzu",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 23,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Nit: Because this test involves dealing with multiple nodes, for verbosity and clarity we can call this variable as `second_node`.",
      "created_at": "2024-05-08T13:05:05Z",
      "updated_at": "2024-05-08T13:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1593998574",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1593998574"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 205,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248",
      "pull_request_review_id": 2045600755,
      "id": 1594000248,
      "node_id": "PRRC_kwDOABII585fAoN4",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 30,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`nblocks=99`\r\nWe can make this value dependent on SNAPSHOT_BASE_HEIGHT such as (SNAPSHOT_BASE_HEIGHT - 200) or (SNAPSHOT_BASE_HEIGHT / 2) so that it's tied to SNAPSHOT_BASE_HEIGHT, and any future changes will automatically account for this variable as well.",
      "created_at": "2024-05-08T13:06:22Z",
      "updated_at": "2024-05-08T13:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594000248",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594000248"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 212,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624",
      "pull_request_review_id": 2045600755,
      "id": 1594008624,
      "node_id": "PRRC_kwDOABII585fAqQw",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 38,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Got to know from the CPP code that `-reindex-chainstate` will load up from the blk.dat files. That's why I understand only 2 more blocks are needed to exceed the work of the snapshot chain.",
      "created_at": "2024-05-08T13:11:00Z",
      "updated_at": "2024-05-08T13:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594008624",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594008624"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 220,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627",
      "pull_request_review_id": 2045600755,
      "id": 1594014627,
      "node_id": "PRRC_kwDOABII585fAruj",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT\n+        # Import the snapshot and assert its failure\n+        with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n+            assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 48,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": null,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`-32603`\r\n\r\nAlthough not necessary for this PR, I am wondering how big of a lift would it be to tie these errors to the ones defined here: https://github.com/bitcoin/bitcoin/blob/master/src/rpc/protocol.h",
      "created_at": "2024-05-08T13:14:42Z",
      "updated_at": "2024-05-08T13:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1594014627",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1594014627"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994",
      "pull_request_review_id": 2050118488,
      "id": 1596777994,
      "node_id": "PRRC_kwDOABII585fLOYK",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 23,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": 1593998574,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks for your review. Actually this test uses only one node and I used the same notation used in other tests, but I am willing to change it if others agree.",
      "created_at": "2024-05-10T13:48:30Z",
      "updated_at": "2024-05-10T13:48:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596777994",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596777994"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 205,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313",
      "pull_request_review_id": 2050118997,
      "id": 1596778313,
      "node_id": "PRRC_kwDOABII585fLOdJ",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 30,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": 1594000248,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good point. The goal of this test is to generate a divergent chain starting from `START_HEIGHT` but having less work than the snapshot, which height equals `SNAPSHOT_BASE_HEIGHT`. Maybe I can set `nBlocks=SNAPSHOT_BASE_HEIGHT-START_HEIGHT-1`. This will result in `99` and it will adapt to any future changes to either `START_HEIGHT` or `SNAPSHOT_BASE_HEIGHT`",
      "created_at": "2024-05-10T13:48:47Z",
      "updated_at": "2024-05-10T13:48:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1596778313",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1596778313"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 212,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656",
      "pull_request_review_id": 2051304962,
      "id": 1597568656,
      "node_id": "PRRC_kwDOABII585fOPaQ",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 30,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": 1594000248,
      "user": {
        "login": "rkrux",
        "id": 5960750,
        "node_id": "MDQ6VXNlcjU5NjA3NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5960750?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/rkrux",
        "html_url": "https://github.com/rkrux",
        "followers_url": "https://api.github.com/users/rkrux/followers",
        "following_url": "https://api.github.com/users/rkrux/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/rkrux/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/rkrux/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/rkrux/subscriptions",
        "organizations_url": "https://api.github.com/users/rkrux/orgs",
        "repos_url": "https://api.github.com/users/rkrux/repos",
        "events_url": "https://api.github.com/users/rkrux/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/rkrux/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes, that would be good.",
      "created_at": "2024-05-12T07:13:56Z",
      "updated_at": "2024-05-12T07:13:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1597568656",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1597568656"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 212,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598649148",
      "pull_request_review_id": 2053004297,
      "id": 1598649148,
      "node_id": "PRRC_kwDOABII585fSXM8",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 30,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": 1594000248,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done. Thanks",
      "created_at": "2024-05-13T15:14:29Z",
      "updated_at": "2024-05-13T15:14:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598649148",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598649148"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 212,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598651033",
      "pull_request_review_id": 2053007625,
      "id": 1598651033,
      "node_id": "PRRC_kwDOABII585fSXqZ",
      "diff_hunk": "@@ -152,6 +148,35 @@ def test_invalid_mempool_state(self, dump_output_path):\n \n         self.restart_node(2, extra_args=self.extra_args[2])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT\n+        # Import the snapshot and assert its failure\n+        with node.assert_debug_log(expected_msgs=[\"[snapshot] activation failed - work does not exceed active chainstate\"]):\n+            assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 48,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "ce80f7ec9a66d594c3a6a6e249f911e9e543a623",
      "in_reply_to_id": 1594014627,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not sure. Maybe you can try opening an issue to discuss it ",
      "created_at": "2024-05-13T15:15:56Z",
      "updated_at": "2024-05-13T15:15:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1598651033",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1598651033"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629294986",
      "pull_request_review_id": 2101629969,
      "id": 1629294986,
      "node_id": "PRRC_kwDOABII585hHRGK",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": null,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This should also check that the background validation succeeds. Otherwise there could be a bug where the diverging chain is not rewound?",
      "created_at": "2024-06-06T11:01:07Z",
      "updated_at": "2024-06-06T11:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1629294986",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1629294986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1631431050",
      "pull_request_review_id": 2104939743,
      "id": 1631431050,
      "node_id": "PRRC_kwDOABII585hPamK",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks for pointing this out. The background validation does not seem to finish in this case.\r\n\r\nI am now testing with a new node `n3` (in my local copy) to avoid the manual rollback to `START_HEIGHT` ([L207](https://github.com/bitcoin/bitcoin/pull/29996/files#diff-8eaa6b77b4e4f242deb67950425cb6b6b7de5370c56a1e8fa7e3a12e95df0a9dR207)). Additionally, `sync_blocks()` was throwing a timeout when reusing n2 for this test (not sure why). \r\n\r\nHere's the new approach I'm trying:\r\n\r\n- The new node starts at `START_HEIGHT` (199).\r\n- I generate a divergent chain from `START_HEIGHT` up to height 298 (< `SNAPSHOT_BASE_HEIGHT`).\r\n- I load the snapshot (height=299).\r\n\r\nAfter loading the snapshot, I can see these two chain states:â€¨\r\n\r\n```\r\n[{'blocks': 298, 'bestblockhash': '171f1d8af9371c9d54a3731f8befdfa6dd2fe553831970ddffdaeb0b93aa54d3', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 7969177, 'coins_tip_cache_bytes': 438304768, 'validated': True}, {'blocks': 299, 'bestblockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 419430, 'coins_tip_cache_bytes': 23068672, 'snapshot_blockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'validated': False}]\r\n```\r\n\r\nNext, I connect the nodes and ensure they all see the same tip:â€¨        \r\n```\r\nself.connect_nodes(0, 3)\r\nself.wait_until(lambda: n3.getchainstates()['chainstates'][-1]['blocks'] == FINAL_HEIGHT)\r\nself.sync_blocks(nodes=(self.nodes[0], n3))\r\n```\r\nâ€¨After syncing, these are the chain states:\r\n\r\n```\r\n[{'blocks': 298, 'bestblockhash': '171f1d8af9371c9d54a3731f8befdfa6dd2fe553831970ddffdaeb0b93aa54d3', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 7969177, 'coins_tip_cache_bytes': 438304768, 'validated': True}, {'blocks': 399, 'bestblockhash': '193ad9344966a54125f4b8d3596572c356ca3dcc216b25b91cb0022fbf61c7e1', 'difficulty': Decimal('4.656542373906925E-10'), 'verificationprogress': 1, 'coins_db_cache_bytes': 419430, 'coins_tip_cache_bytes': 23068672, 'snapshot_blockhash': '3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0', 'validated': False}]\r\n```\r\n\r\nIt seems that the snapshot chain has now synced to the tip (height 399). However, this line times out after syncing the blocks:\r\n\r\n`self.wait_until(lambda: len(n3.getchainstates()['chainstates']) == 1)`\r\n\r\nI'm not sure if I'm doing something wrong or if there is indeed a bug where the divergent chain is not rewound. I will continue investigating. \r\n\r\n**Something to note here:** if I follow the same process but I don't generate any divergent chain, then the validation completes successfully.\r\n\r\nAny directions on how to proceed with this would be appreciated.",
      "created_at": "2024-06-07T16:12:06Z",
      "updated_at": "2024-06-07T16:12:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1631431050",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1631431050"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1632216319",
      "pull_request_review_id": 2106121371,
      "id": 1632216319,
      "node_id": "PRRC_kwDOABII585hSaT_",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I'm not sure if I'm doing something wrong or if there is indeed a bug where the divergent chain is not rewound. I will continue investigating.\r\n\r\nThis sounds like a bug. Just to clarify, the active chain is stuck at height `298` and the background chain continues to sync past `399`?",
      "created_at": "2024-06-09T09:12:08Z",
      "updated_at": "2024-06-09T09:12:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1632216319",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1632216319"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633146879",
      "pull_request_review_id": 2107619315,
      "id": 1633146879,
      "node_id": "PRRC_kwDOABII585hV9f_",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I guess I am confused with the terms \"active\" and \"background\" chain. I assume the active chain is the snapshot chain which starts at height `299`, and the divergent chain is the one stuck at `298`. I base this on the fact that when I run `getbestblockhash` after `loadtxoutset`, I get the hash of the snapshot tip. However, I might be mistaken. Shouldn't the divergent chain be rewound to `START_HEIGHT` and become the background validation chain?\r\n\r\nTo address your questions:\r\n\r\n1. The divergent chain is indeed stuck at height `298`.\r\n2. The snapshot chain continues to sync past height `399`. Although `399` is the `FINAL_HEIGHT` for this test, I was able to mine an additional 100 blocks on top of `node0`, resulting in both `node0` and `node3` syncing again, and the snapshot chain syncing up to height `499`.\r\n\r\nHowever, even after syncing past 399, the background validation does not seem to finish. I always get a timeout when running this line after syncing the nodes:\r\n```\r\nself.wait_until(lambda: len(node.getchainstates()['chainstates']) == 1)\r\n```\r\n\r\nAdditionally, I am experiencing an intermittent issue where the sync does not always finish, and I have not been able to determine the cause yet. This issue happens only after mining past 399.",
      "created_at": "2024-06-10T12:13:13Z",
      "updated_at": "2024-06-10T12:13:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633146879",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633146879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633915935",
      "pull_request_review_id": 2108877582,
      "id": 1633915935,
      "node_id": "PRRC_kwDOABII585hY5Qf",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I can confirm this behavior and also think that this has uncovered a bug in `net_processing`.\r\n\r\nI think that the root cause is in [TryDownloadingHistoricalBlocks](https://github.com/bitcoin/bitcoin/blob/b1ba1b178f501daa1afdd91f9efec34e5ec1e294/src/net_processing.cpp#L1511-L1538) (which is responsible for downloading the background chain):\r\nThis function calls `FindNextBlocks()` with  `pindexWalk` set to the current tip of the background chainstate (`from_tip`), and `target_block` set to the snapshot block.\r\n`FindNextBlocks` then walks from the snapshot block backwards to the the **height** of `from_tip`, save these blocks in `vToFetch` and then begins to download these blocks in forward order.\r\nThis is incorrect, because the blocks in starting at the last common ancestor of `from_tip` and the snapshot block, up to the height of `from_tip` are never requested that way (their height is smaller than the height of `from_tip`).\r\nSo, my proposed fix would be something like https://github.com/mzumsande/bitcoin/commit/edb2b69a16889552ddd40b71a491e7722d9b4e12 (feel free to cherry-pick/ adjust as you like).\r\n\r\n@alfonsoromanz: Could you check if that fix would solve the issue for you?\r\n@ryanofsky Could you take a look - would you agree with that explanation and the proposed fix?\r\n ",
      "created_at": "2024-06-10T22:35:56Z",
      "updated_at": "2024-06-10T22:35:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633915935",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633915935"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633934145",
      "pull_request_review_id": 2108903806,
      "id": 1633934145,
      "node_id": "PRRC_kwDOABII585hY9tB",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Although I'm not sure if this is an actual problem in practice, because with our DoS protections for low-work blocks and headers we shouldn't really get into this situation with a divergent chain in the first place.",
      "created_at": "2024-06-10T23:05:12Z",
      "updated_at": "2024-06-10T23:05:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1633934145",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1633934145"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634458835",
      "pull_request_review_id": 2109766439,
      "id": 1634458835,
      "node_id": "PRRC_kwDOABII585ha9zT",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Hi, I am a bit confused as well but I think I have an idea :) I think the approach chosen in this test doesn't work for what it's actually trying to do. Block 299 is marked invalid in the node under test so it's not surprising that the node is stuck on 298. I don't understand how the \"divergent\" chain could get \"rewound\" when the alternative \"real\" chain is still marked invalid. I don't think the dump should mark and invalid block valid but that is what it would need to do in order to sync the chain containing the snapshot and connect both chainstates. What is indeed surprising here is that the dump does load even though the base block is invalid. I have suggested a fix here: #30267 although this scenario seems highly unlikely in practice. I am using a simplified version of your test here and made you co-author there @alfonsoromanz .\r\n\r\nSo I think the approach here would need to be altered so that the right chain is not marked invalid. I think that is fairly hard to do in regtest. It seems we would need a (premined) heavy chain to simulate this scenario. I think the scenario that James had in mind is also a lot less likely to occur since we pre-sync headers (see #25717). I didn't check but I guess this test file predates that PR and a test would have been more practical when the attack scenario described there would have been exploited.\r\n\r\nI don't have another idea how to test this in a simpler way but such a heavy work regtest chain could be useful for a number of scenario, don't you think @maflcko ?\r\n\r\nEDIT: Also note that the todo in the comment explicitly states \"Valid snapshot file and snapshot block\" but this is not the case here. The snapshot block is invalid.",
      "created_at": "2024-06-11T08:50:04Z",
      "updated_at": "2024-06-11T09:01:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634458835",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634458835"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634462141",
      "pull_request_review_id": 2109771701,
      "id": 1634462141,
      "node_id": "PRRC_kwDOABII585ha-m9",
      "diff_hunk": "@@ -419,10 +444,10 @@ def check_tx_counts(final: bool) -> None:\n                 self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n \n \n-        # Node 2: all indexes + reindex\n-        # -----------------------------\n+        # Node 2: all indexes + reindex + divergent chain",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 59,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think this edit here (and in the log below) isn't needed. \"all indexes + reindex\" is describing the configuration of the node. Divergent chain is just one of the test cases that this node runs through. I think just having the logs in the test you already have is enough.",
      "created_at": "2024-06-11T08:52:17Z",
      "updated_at": "2024-06-11T08:52:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634462141",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634462141"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 447,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634478108",
      "pull_request_review_id": 2109806294,
      "id": 1634478108,
      "node_id": "PRRC_kwDOABII585hbCgc",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 45,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I would prefer usage of `assert_equal` with the precise height you expect here.",
      "created_at": "2024-06-11T09:02:41Z",
      "updated_at": "2024-06-11T09:02:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634478108",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634478108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 227,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634517149",
      "pull_request_review_id": 2109882346,
      "id": 1634517149,
      "node_id": "PRRC_kwDOABII585hbMCd",
      "diff_hunk": "@@ -219,6 +216,19 @@ def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n         assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n         assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n \n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 24,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This may be resolved through addressing the comments on the previous test case anyway but for this one also, both chains should be valid.",
      "created_at": "2024-06-11T09:26:41Z",
      "updated_at": "2024-06-11T09:26:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634517149",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634517149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634545007",
      "pull_request_review_id": 2109919756,
      "id": 1634545007,
      "node_id": "PRRC_kwDOABII585hbS1v",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks @fjahr and @mzumsande, for your help.\r\n\r\n> Block 299 is marked invalid in the node under test so it's not surprising that the node is stuck on 298 \r\n> [...] So I think the approach here would need to be altered so that the right chain is not marked invalid\r\n\r\nYes, that makes sense. Initially, I didn't want to create a new node for this test and instead wanted to reuse the existing `node2`. To achieve this, I needed to rollback the chain to create a divergent chain from `START_HEIGHT` up to height 298. I used `invalidateblock` for that purpose, but I didn't consider the side effects.\r\n\r\nAfter trying to ensure the background validation finishes, I encountered an issue where I was unable to sync `node0` and `node2`. This led me to adopt a new approach that doesn't require invalidation by creating a new node starting at `START_HEIGHT` and creating a divergent chain from there. However, I did not push that code yet because the validation was not working either until @mzumsande provided the fix.\r\n\r\n> So, my proposed fix would be something like https://github.com/mzumsande/bitcoin/commit/edb2b69a16889552ddd40b71a491e7722d9b4e12 (feel free to cherry-pick/ adjust as you like).\r\n> \r\n> @alfonsoromanz: Could you check if that fix would solve the issue for you?\r\n> \r\n\r\nYes, this issue is fixed with your proposed change and my new approach with a new `node3`. Here is the updated approach:\r\n\r\n1. The new node starts at `START_HEIGHT` (199).\r\n2. I generate a divergent chain from `START_HEIGHT` up to height 298 (< `SNAPSHOT_BASE_HEIGHT`).\r\n3. I load the snapshot (height=299).\r\n4. I ensure the background validation finishes.\r\n\r\nI can continue working on this new approach and also on adapting the second part of this test, which involves a divergent chain with more work than the snapshot. However this new approach will require merging @mzumsande proposed fix to work.\r\n\r\n\r\nThanks again, everyone!\r\n",
      "created_at": "2024-06-11T09:42:14Z",
      "updated_at": "2024-06-11T09:47:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634545007",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634545007"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634549960",
      "pull_request_review_id": 2109928147,
      "id": 1634549960,
      "node_id": "PRRC_kwDOABII585hbUDI",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Huh, I didn't see @mzumsande 's post when I wrote mine... Will look into this approach as well.",
      "created_at": "2024-06-11T09:45:55Z",
      "updated_at": "2024-06-11T09:45:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634549960",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634549960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634588775",
      "pull_request_review_id": 2109992133,
      "id": 1634588775,
      "node_id": "PRRC_kwDOABII585hbdhn",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Yes, this issue is fixed with your proposed change and my new approach with a new node3. Here is the updated approach:\r\n\r\nSounds good to me in principle but before doing 3 ensure that the node's tip is actually the tip of the divergent chain. This may happen through the node not knowing the real chain, i.e. not being in sync, but I don't think this is what we are actually trying to test here.\r\n\r\nMaybe I am blind or interpret the original Todo differently than the rest of you but I don't see a simpler approach than the following to actually have a scenario that simulates what might happen on mainnet:\r\n\r\n- Start with a new node under test that is not connected to the nodes that have the real chain\r\n- Mine a divergent chain of the same height as the real chain\r\n- Compare total work of the real chain with the divergent chain and grind the last block(s) of the divergent chain until you see that its tip has less total work than that of the real chain, if this is not the case right away.\r\n- Then connect the node under test to a node with the real chain\r\n- The node under test should have knowledge of the real chain with more work but it should still have the divergent chain as its tip because it has seen that block first\r\n- Now load the snapshot into node under test",
      "created_at": "2024-06-11T10:14:23Z",
      "updated_at": "2024-06-11T10:19:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634588775",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634588775"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634607244",
      "pull_request_review_id": 2110021958,
      "id": 1634607244,
      "node_id": "PRRC_kwDOABII585hbiCM",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "To clarify the meaning of the Todo:\r\n\r\n> Interesting starting states could be loading a snapshot when the current chain tip is:\r\n> - TODO: Not an ancestor of the snapshot block but has less work\r\n\r\nParticularly \"but has less work\" could mean A) less work than the tip of the chain that includes the snapshot or B) less work than the snapshot block itself. I believe A is the more interesting and intended scenario because B only seems to be a state a node can be in if the snapshot block is invalid or its ancestors are unknown which should lead to a much earlier error.",
      "created_at": "2024-06-11T10:28:49Z",
      "updated_at": "2024-06-11T10:28:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634607244",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634607244"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635022608",
      "pull_request_review_id": 2110691404,
      "id": 1635022608,
      "node_id": "PRRC_kwDOABII585hdHcQ",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29996/files#r1633915935\r\n\r\n> my proposed fix would be something like [mzumsande@edb2b69](https://github.com/mzumsande/bitcoin/commit/edb2b69a16889552ddd40b71a491e7722d9b4e12) (feel free to cherry-pick/ adjust as you like).\r\n\r\nNice find! Would suggest opening a separate PR so it is easier to understand the problem and fix. And maybe it is possible to come up with a simpler test for this problem specifically, like by adding an assert in FindNextBlocks() that pindexWalk is an ancestor of `state->pindexBestKnownBlock` and then adding a test that triggers the assert.\r\n\r\nWould also consider tweaking the fix to call LastCommonAncestor() before calling TryDownloadingHistoricalBlocks(), so it is easier to understand `from_tip` variable being the immediate predecessor of blocks to download next instead of having a more complicated meaning.",
      "created_at": "2024-06-11T14:46:09Z",
      "updated_at": "2024-06-11T15:06:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635022608",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635022608"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635083945",
      "pull_request_review_id": 2110793584,
      "id": 1635083945,
      "node_id": "PRRC_kwDOABII585hdWap",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1634607244\r\n\r\n> To clarify the meaning of the Todo:\r\n> \r\n> > Interesting starting states could be loading a snapshot when the current chain tip is:\r\n> > \r\n> > * TODO: Not an ancestor of the snapshot block but has less work\r\n> \r\n> Particularly \"but has less work\" could mean A) less work than the tip of the chain that includes the snapshot or B) less work than the snapshot block itself. I believe A is the more interesting and intended scenario because B only seems to be a state a node can be in if the snapshot block is invalid or its ancestors are unknown which should lead to a much earlier error.\r\n\r\nI think the todo list came from my comment https://github.com/bitcoin/bitcoin/pull/27596#discussion_r1331521797, and I probably was thinking of interpretation (B) not (A), but maybe (B) is not a very interesting scenario.\r\n\r\nI'm not sure why it needs to \"lead to a much earlier error,\" though, or lead to any error. If the node is syncing to some chain that seems to have the most work, but then headers for a second chain are announced that has more work, the chainstate tip is not going to switch to the second chain, even though it has more work, until enough blocks from it are downloaded and validated, and a block from the second chain is reached that is that is valid and has more work than the chainstate tip. Before that happens, a snapshot from the second chain could be loaded such that the current chain tip has less work than the snapshot block and is not an ancestor of the snapshot block, but the snapshot block is valid and its ancestors can be downloaded.\r\n\r\nOr maybe that is wrong, but at least it's my understanding.",
      "created_at": "2024-06-11T15:22:58Z",
      "updated_at": "2024-06-11T15:22:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635083945",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635083945"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635106225",
      "pull_request_review_id": 2110830005,
      "id": 1635106225,
      "node_id": "PRRC_kwDOABII585hdb2x",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Sounds good to me in principle but before doing 3 ensure that the node's tip is actually the tip of the divergent chain (...)\r\n\r\nMaybe I misunderstand, but that seems overly complicated. I assume we're talking about the scenario \"Not an ancestor of the snapshot block but has less work\":\r\nIn my local test, I just gave the node the headers of the snapshot chain, and then used `-generate` to mine a divergent chain from the old tip. Number of blocks doesn't really matter. The other chain (with the snapshot in it) will have more work, but it is headers-only, so the tip will be on the divergent chain no matter how much work it has. Then, after the snapshot is loaded and we connected to a peer that has all the blocks, the node will successfully download the snapshot chain, but currently the background sync won't complete unless you apply my fix above. I assume that @alfonsoromanz's test (not pushed yet) works in a similar way.\r\n\r\n> have suggested a fix here: https://github.com/bitcoin/bitcoin/pull/30267\r\n\r\n> Huh, I didn't see @mzumsande 's post when I wrote mine... Will look into this approach as well.\r\n\r\nJust to avoid any confusion: There are two independent issues. My issue pops up if you don't use invalidateblock anymore, as the current version of the PR still does.\r\n\r\n> However this new approach will require merging @mzumsande proposed fix to work.\r\n\r\nI neither want to hijack this PR nor open a PR with just the fix without a test, so my suggestion would be that you could incorporate the one-line fix into this PR (meaning that this PR wouldn't be test-only anymore) - if you're interested and have the time, that is.\r\n\r\n",
      "created_at": "2024-06-11T15:37:48Z",
      "updated_at": "2024-06-11T15:38:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635106225",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635106225"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635147026",
      "pull_request_review_id": 2110897821,
      "id": 1635147026,
      "node_id": "PRRC_kwDOABII585hdl0S",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> Particularly \"but has less work\" could mean A) less work than the tip of the chain that includes the snapshot or B) less work than the snapshot block itself. I believe A is the more interesting and intended scenario because B only seems to be a state a node can be in if the snapshot block is invalid or its ancestors are unknown which should lead to a much earlier error.\r\n\r\nI interpreted it as B) less work than the snapshot block itself.\r\n\r\nRegarding A): If the new node (divergent chain) has less work than the chain tip (`399`) but more than the snapshot (`299`), the expected behavior would be to get the error: `\"Unable to Load UTXO Snapshot - [snapshot] activation failed - work does not exceed active chainstate.\"` This same behavior is expected for the other scenario of a node with a divergent chain but with more work, i.e \"TODO: Not an ancestor or a descendant of the snapshot block and has more work\"\r\n\r\nSo both scenarios look very similar to me. That's why I was leaning towards option B. However, I am not an expert on real scenarios in mainnet and I may be missing something.\r\n\r\nAlso, I started working on your approach and completed this part:\r\n\r\n> - Start with a new node under test that is not connected to the nodes that have the real chain.\r\n> - Mine a divergent chain of the same height as the real chain.\r\n> - Compare the total work of the real chain with the divergent chain and grind the last block(s) of the divergent chain until its tip has less total work than that of the real chain, if this is not the case right away.\r\n> - Then connect the node under test to a node with the real chain.\r\n\r\nBut this is where I get confused:\r\n\r\n> - The node under test should have knowledge of the real chain with more work but it should still have the divergent chain as its tip because it has seen that block first.\r\n\r\nAfter following you steps and connecting and syncing the nodes, the divergent chain is replaced with the original chain because has more work. If I don't run sync, it's not replaced, but I guess it's just a matter of time? or maybe I don't understand how connect and sync works.\r\n\r\nGiven that the snapshot will not be loaded because it doesn't exceed the active chainstate, I don't see much difference in making the divergent chain have less or more work than the original chain. What am I missing?\r\n\r\nEither way, I am happy to add tests for both A) and B) scenarios.\r\n\r\n> In my local test, I just gave the node the headers of the snapshot chain, and then used -generate to mine a divergent chain from the old tip. Number of blocks doesn't really matter. The other chain (with the snapshot in it) will have more work, but it is headers-only, so the tip will be on the divergent chain no matter how much work it has. Then, after the snapshot is loaded and we connected to a peer that has all the blocks, the node will successfully download the snapshot chain, but currently the background sync won't complete unless you apply my fix above. I assume that @alfonsoromanz's test (not pushed yet) works in a similar way.\r\n\r\nYes that's what I'm doing in my local code (not pushed). I'm submitting the headers to `n3` just like the original code is doing to `n1` and `n2`. After that, I call this test function `test_snapshot_in_a_divergent_chain` where I generate the divergent chain and load the snapshot. The background validation only finishes if I apply your fix.\r\n\r\n> I neither want to hijack this PR nor open a PR with just the fix without a test, so my suggestion would be that you could incorporate the one-line fix into this PR (meaning that this PR wouldn't be test-only anymore) - if you're interested and have the time, that is.\r\n\r\nYes, I can incorporate it and add you as a co-author. Thanks",
      "created_at": "2024-06-11T16:07:14Z",
      "updated_at": "2024-06-11T16:48:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635147026",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635147026"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635899433",
      "pull_request_review_id": 2112085537,
      "id": 1635899433,
      "node_id": "PRRC_kwDOABII585hgdgp",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I just pushed my recent changes for this PR. This is the approach I decided to move forward with:\r\n\r\n1. **Scenario Choice**: Between these two scenarios mentioned by @fjahr: \"Particularly 'but has less work' could mean A) less work than the tip of the chain that includes the snapshot or B) less work than the snapshot block itself,\" I chose B) for this PR: less work than the snapshot block itself. I am happy to add tests for the other scenario in a separate PR.\r\n2. **Added Fix**: I incorporated the fix from @mzumsande to start downloading historical blocks from the last common ancestor. This avoids the scenario where blocks in between are not requested, which causes the background validation to never finish. https://github.com/bitcoin/bitcoin/pull/29996/commits/8b6a18a7d5bdc6b2bb057613e661816917314084\r\n3. **New Node for \"Divergent Chain with Less Work\"**: I added a new node (`n3`) for the scenario where we load the snapshot in a node with a divergent chain but less work. I am not reusing previous nodes because I don't know a way to do a clean rollback without invalidating blocks. As mentioned by @fjahr, we shouldn't expect to load a snapshot in a scenario where part of the snapshot was invalidated. There is actually a new PR to prevent this from happening: https://github.com/bitcoin/bitcoin/pull/30267.\r\n4. **New Node for \"Divergent Chain with More Work\"**: I also added a new node (`n4`) for the scenario where we load the snapshot in a node with a divergent chain and more work. I was not able to reuse `n3` for the same reason described previously: `n3` has already synced to the tip, and I don't know any other way to rollback the chain other than invalidating blocks.\r\n\r\nAny feedback is appreciated.\r\n\r\nThanks!",
      "created_at": "2024-06-12T06:44:49Z",
      "updated_at": "2024-06-12T06:49:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635899433",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635899433"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635899839",
      "pull_request_review_id": 2112086248,
      "id": 1635899839,
      "node_id": "PRRC_kwDOABII585hgdm_",
      "diff_hunk": "@@ -419,10 +444,10 @@ def check_tx_counts(final: bool) -> None:\n                 self.wait_until(lambda: n.getindexinfo() == completed_idx_state)\n \n \n-        # Node 2: all indexes + reindex\n-        # -----------------------------\n+        # Node 2: all indexes + reindex + divergent chain",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 59,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1634462141,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed",
      "created_at": "2024-06-12T06:45:16Z",
      "updated_at": "2024-06-12T06:45:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635899839",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635899839"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 447,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635900277",
      "pull_request_review_id": 2112086941,
      "id": 1635900277,
      "node_id": "PRRC_kwDOABII585hgdt1",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success\n+        loaded = node.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Restart the node and delete the snapshot chainstate from previous test.\n+        self.restart_node(2, extra_args=['-reindex-chainstate=1', *self.extra_args[2]])\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")\n+        # Generate two extra blocks and make sure node2's chain has more work than the snapshot's chain\n+        # This covers the scenario where the snapshot block is not on the most-work chain\n+        self.generate(node, nblocks=2, sync_fun=self.no_op)\n+        assert node.getblockcount() > SNAPSHOT_BASE_HEIGHT",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 45,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1634478108,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed",
      "created_at": "2024-06-12T06:45:40Z",
      "updated_at": "2024-06-12T06:45:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1635900277",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635900277"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 227,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644663646",
      "pull_request_review_id": 2125850159,
      "id": 1644663646,
      "node_id": "PRRC_kwDOABII585iB5Ne",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Now lets sync the nodes and wait for the background validation to finish\n+        self.connect_nodes(0, 3)\n+        self.sync_blocks(nodes=(n0, n3))\n+        print('Ensuring background validation finishes')",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 66,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n        self.log.info('Ensuring background validation finishes')\r\n```",
      "created_at": "2024-06-18T15:30:13Z",
      "updated_at": "2024-06-18T16:27:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1644663646",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644663646"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 227,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644672188",
      "pull_request_review_id": 2125850159,
      "id": 1644672188,
      "node_id": "PRRC_kwDOABII585iB7S8",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Now lets sync the nodes and wait for the background validation to finish\n+        self.connect_nodes(0, 3)\n+        self.sync_blocks(nodes=(n0, n3))\n+        print('Ensuring background validation finishes')\n+        self.wait_until(lambda: len(n3.getchainstates()['chainstates']) == 1)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 69,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This is a f-string now but its actually not needed here.",
      "created_at": "2024-06-18T15:36:06Z",
      "updated_at": "2024-06-18T16:27:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1644672188",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644672188"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644745285",
      "pull_request_review_id": 2125850159,
      "id": 1644745285,
      "node_id": "PRRC_kwDOABII585iCNJF",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> After following you steps and connecting and syncing the nodes, the divergent chain is replaced with the original chain because has more work. If I don't run sync, it's not replaced, but I guess it's just a matter of time? or maybe I don't understand how connect and sync works.\r\n\r\nWhen we see two blocks on the same height, we take the one that is seen first as the tip, not the one that has more work. We do this to ensure a miner who found a very low hash doesn't withhold it. What I described builds on this behavior but maybe there are other things at play that I am missing. Might be that this doesn't work with longer forks.\r\n\r\n> In my local test, I just gave the node the headers of the snapshot chain, and then used -generate to mine a divergent chain from the old tip. Number of blocks doesn't really matter. The other chain (with the snapshot in it) will have more work, but it is headers-only, so the tip will be on the divergent chain no matter how much work it has.\r\n\r\nOk, I think it was never mentioned before that one of the chains is a headers-only chain. When not specified otherwise I assume knowing a \"chain\" means having the blocks as well. I guess I am interpreting the TODOs differently here than everyone else.",
      "created_at": "2024-06-18T16:19:50Z",
      "updated_at": "2024-06-18T16:27:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1644745285",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644745285"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644747936",
      "pull_request_review_id": 2125850159,
      "id": 1644747936,
      "node_id": "PRRC_kwDOABII585iCNyg",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 60,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I would remove this line because it doesn't really add anything that the line below doesn't test.",
      "created_at": "2024-06-18T16:22:08Z",
      "updated_at": "2024-06-18T16:27:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1644747936",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644747936"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 221,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644749546",
      "pull_request_review_id": 2125850159,
      "id": 1644749546,
      "node_id": "PRRC_kwDOABII585iCOLq",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 60,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644747936,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Maybe rather check the chainstates instead if you want to add something more but I think it's not absolutely necessary.",
      "created_at": "2024-06-18T16:23:32Z",
      "updated_at": "2024-06-18T16:27:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1644749546",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644749546"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 221,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646020872",
      "pull_request_review_id": 2128011038,
      "id": 1646020872,
      "node_id": "PRRC_kwDOABII585iHEkI",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Now lets sync the nodes and wait for the background validation to finish\n+        self.connect_nodes(0, 3)\n+        self.sync_blocks(nodes=(n0, n3))\n+        print('Ensuring background validation finishes')",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 66,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644663646,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed",
      "created_at": "2024-06-19T11:48:22Z",
      "updated_at": "2024-06-19T11:48:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646020872",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646020872"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 227,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646021806",
      "pull_request_review_id": 2128012472,
      "id": 1646021806,
      "node_id": "PRRC_kwDOABII585iHEyu",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)\n+        assert_equal(loaded['base_height'], SNAPSHOT_BASE_HEIGHT)\n+\n+        # Now lets sync the nodes and wait for the background validation to finish\n+        self.connect_nodes(0, 3)\n+        self.sync_blocks(nodes=(n0, n3))\n+        print('Ensuring background validation finishes')\n+        self.wait_until(lambda: len(n3.getchainstates()['chainstates']) == 1)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor or a descendant of the snapshot block and has more work\")",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 69,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644672188,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed",
      "created_at": "2024-06-19T11:49:08Z",
      "updated_at": "2024-06-19T11:49:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646021806",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646021806"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646036157",
      "pull_request_review_id": 2128036756,
      "id": 1646036157,
      "node_id": "PRRC_kwDOABII585iHIS9",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 60,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644747936,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks. I removed the line as suggested. I wasn't sure which chainstates check might be useful to add. Something like [this](https://github.com/bitcoin/bitcoin/blob/master/test/functional/feature_assumeutxo.py#L322C7-L328C51), maybe? ",
      "created_at": "2024-06-19T12:01:16Z",
      "updated_at": "2024-06-19T12:01:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646036157",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646036157"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 221,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646149435",
      "pull_request_review_id": 2128196930,
      "id": 1646149435,
      "node_id": "PRRC_kwDOABII585iHj87",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 60,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644747936,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah, just that each of them is at the height you expect. ",
      "created_at": "2024-06-19T12:49:55Z",
      "updated_at": "2024-06-19T12:49:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646149435",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646149435"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 221,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646164004",
      "pull_request_review_id": 2128217740,
      "id": 1646164004,
      "node_id": "PRRC_kwDOABII585iHngk",
      "diff_hunk": "@@ -204,6 +200,35 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        # First rollback node2's chain to the pregenerated one, up to height 199\n+        node = self.nodes[2]\n+        block_hash = node.getblockhash(START_HEIGHT + 1)\n+        node.invalidateblock(block_hash)\n+        assert_equal(node.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in node2 but with less work compared to the snapshot\n+        self.generate(node, nblocks=99, sync_fun=self.no_op)\n+        assert node.getblockcount() < SNAPSHOT_BASE_HEIGHT\n+        # Try importing the snapshot and assert its success",
      "path": "test/functional/feature_assumeutxo.py",
      "position": 57,
      "original_position": 32,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "50cdb2450f4a35c0f6c9278c184e507ece6ea43d",
      "in_reply_to_id": 1629294986,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I'm not sure why it needs to \"lead to a much earlier error,\" though, or lead to any error. If the node is syncing to some chain that seems to have the most work, but then headers for a second chain are announced that has more work, the chainstate tip is not going to switch to the second chain, even though it has more work, until enough blocks from it are downloaded and validated, and a block from the second chain is reached that is that is valid and has more work than the chainstate tip. Before that happens, a snapshot from the second chain could be loaded such that the current chain tip has less work than the snapshot block and is not an ancestor of the snapshot block, but the snapshot block is valid and its ancestors can be downloaded.\r\n\r\nThat's not how the tests currently work if I am not mistaken. The nodes currently get the headers of the \"second chain\" first and then they mine their own chain that is the referred to as the \"divergent chain\" in the tests. But you are correct, we are not failing as early as I thought. I think we should though. We are currently failing only pretty late when calling `CBlockIndexWorkComparator()` (see also the error message in the last test added here in the PR) and I find that a weird point to fail at if the base block is not in the best (header) chain. I think we should actually already fail when looking for the snapshot start block the first time.\r\n\r\nSo I think something like this might be interesting to discuss later as an optimization: https://github.com/fjahr/bitcoin/commit/3ef2eea6e750e811198019173a39f2ad0a4da415 It's untested because it makes some unrelated tests fail that are run before the headers are synced. So it's not critical at all. But this is actually how I thought things worked when I wrote the that we would fail earlier.",
      "created_at": "2024-06-19T12:59:21Z",
      "updated_at": "2024-06-19T12:59:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646164004",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646164004"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 218,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646189792",
      "pull_request_review_id": 2128263226,
      "id": 1646189792,
      "node_id": "PRRC_kwDOABII585iHtzg",
      "diff_hunk": "@@ -204,6 +202,40 @@ def test_snapshot_with_less_work(self, dump_output_path):\n             assert_raises_rpc_error(-32603, \"Unable to load UTXO snapshot\", node.loadtxoutset, dump_output_path)\n         self.restart_node(0, extra_args=self.extra_args[0])\n \n+    def test_snapshot_in_a_divergent_chain(self, dump_output_path):\n+        n0 = self.nodes[0]\n+        n3 = self.nodes[3]\n+        n4 = self.nodes[4]\n+        assert_equal(n0.getblockcount(), FINAL_HEIGHT)\n+        assert_equal(n3.getblockcount(), START_HEIGHT)\n+        assert_equal(n4.getblockcount(), START_HEIGHT)\n+\n+        self.log.info(f\"Check importing a snapshot where current chain-tip is not an ancestor of the snapshot block but has less work\")\n+        # Generate a divergent chain in n3 up to 298\n+        self.generate(n3, nblocks=99, sync_fun=self.no_op)\n+        assert_equal(n3.getblockcount(), SNAPSHOT_BASE_HEIGHT - 1)\n+\n+        # Try importing the snapshot and assert its success\n+        self.log.info('Importing the snapshot into n3')\n+        loaded = n3.loadtxoutset(dump_output_path)\n+        assert_equal(loaded['coins_loaded'], SNAPSHOT_BASE_HEIGHT)",
      "path": "test/functional/feature_assumeutxo.py",
      "position": null,
      "original_position": 60,
      "commit_id": "5478d9c4fde00556b18f25a530e2f468fd1b402e",
      "original_commit_id": "4b34a0cfb6dec2fc1b369b805869a713d02e0459",
      "in_reply_to_id": 1644747936,
      "user": {
        "login": "alfonsoromanz",
        "id": 19962151,
        "node_id": "MDQ6VXNlcjE5OTYyMTUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/19962151?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/alfonsoromanz",
        "html_url": "https://github.com/alfonsoromanz",
        "followers_url": "https://api.github.com/users/alfonsoromanz/followers",
        "following_url": "https://api.github.com/users/alfonsoromanz/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/alfonsoromanz/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/alfonsoromanz/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/alfonsoromanz/subscriptions",
        "organizations_url": "https://api.github.com/users/alfonsoromanz/orgs",
        "repos_url": "https://api.github.com/users/alfonsoromanz/repos",
        "events_url": "https://api.github.com/users/alfonsoromanz/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/alfonsoromanz/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks. Updated",
      "created_at": "2024-06-19T13:17:55Z",
      "updated_at": "2024-06-19T13:17:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29996#discussion_r1646189792",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646189792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29996"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 221,
      "side": "RIGHT"
    }
  ]
}