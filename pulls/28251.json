{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251",
    "id": 1470315013,
    "node_id": "PR_kwDOABII585XozoF",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/28251",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/28251.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/28251.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/22fe13e3526b582170c05f823395dba0a3c9c99a",
    "number": 28251,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "validation: fix coins disappearing mid-package evaluation",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "While we are evaluating a package, we split it into \"subpackages\" for evaluation (currently subpackages all have size 1 except the last one). If a subpackage has size 1, we may add a tx to mempool and call `LimitMempoolSize()`, which evicts transactions if the mempool gets full. We handle the case where the just-submitted transaction is evicted immediately, but we don't handle the case in which a transaction from a previous subpackage (either just submitted or already in mempool) is evicted. Mainly, since the coins created by the evicted transaction are cached in `m_view`, we don't realize the UTXO has disappeared until `CheckInputsFromMempoolAndCache` asserts that they exist. Also, the returned `PackageMempoolAcceptResult` reports that the transaction is in mempool even though it isn't anymore.\r\n\r\nFix this by not calling `LimitMempoolSize()` until the very end, and editing the results map with \"mempool full\" if things fall out.\r\n\r\nPointed out by instagibbs in https://github.com/bitcoin/bitcoin/commit/faeed687e5cde5e32750d93818dd1d4add837f24 on top of the v3 PR.",
    "labels": [
      {
        "id": 64585,
        "node_id": "MDU6TGFiZWw2NDU4NQ==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug",
        "name": "Bug",
        "color": "FBBAAB",
        "default": false
      },
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2023-08-10T13:04:18Z",
    "updated_at": "2023-08-30T03:23:23Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "abd0b70dc0059c2f35a3bb8078dcbff5b2736eb0",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "glozow:2023-08-mid-package-trim",
      "ref": "2023-08-mid-package-trim",
      "sha": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 244262754,
        "node_id": "MDEwOlJlcG9zaXRvcnkyNDQyNjI3NTQ=",
        "name": "bitcoin",
        "full_name": "glozow/bitcoin",
        "owner": {
          "login": "glozow",
          "id": 25183001,
          "node_id": "MDQ6VXNlcjI1MTgzMDAx",
          "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/glozow",
          "html_url": "https://github.com/glozow",
          "followers_url": "https://api.github.com/users/glozow/followers",
          "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
          "organizations_url": "https://api.github.com/users/glozow/orgs",
          "repos_url": "https://api.github.com/users/glozow/repos",
          "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/glozow/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/glozow/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/glozow/bitcoin",
        "archive_url": "https://api.github.com/repos/glozow/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/glozow/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/glozow/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/glozow/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/glozow/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/glozow/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/glozow/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/glozow/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/glozow/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/glozow/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/glozow/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/glozow/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/glozow/bitcoin/events",
        "forks_url": "https://api.github.com/repos/glozow/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/glozow/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/glozow/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/glozow/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/glozow/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/glozow/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/glozow/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/glozow/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/glozow/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/glozow/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/glozow/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/glozow/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/glozow/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/glozow/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/glozow/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/glozow/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:glozow/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/glozow/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/glozow/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/glozow/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/glozow/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/glozow/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/glozow/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/glozow/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/glozow/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/glozow/bitcoin/hooks",
        "svn_url": "https://github.com/glozow/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 9,
        "watchers_count": 9,
        "size": 229852,
        "default_branch": "master",
        "open_issues_count": 1,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-29T16:26:36Z",
        "created_at": "2020-03-02T02:31:56Z",
        "updated_at": "2023-07-18T03:26:20Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "c9273f68f6a17b669890b0b2d38dbcc8b3c39d7b",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35591,
        "stargazers_count": 71156,
        "watchers_count": 71156,
        "size": 238082,
        "default_branch": "master",
        "open_issues_count": 674,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-30T02:48:43Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-08-30T03:37:48Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 367,
    "deletions": 90,
    "changed_files": 7,
    "commits": 9,
    "review_comments": 41,
    "comments": 6
  },
  "events": [
    {
      "event": "labeled",
      "id": 10059222426,
      "node_id": "LE_lADOABII585t-sSfzwAAAAJXk42a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059222426",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:19Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 10059222442,
      "node_id": "LE_lADOABII585t-sSfzwAAAAJXk42q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059222442",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:19Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "commented",
      "id": 1673181532,
      "node_id": "IC_kwDOABII585jurlc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673181532",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:21Z",
      "updated_at": "2023-08-25T16:04:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [instagibbs](https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1596008248) |\n| Concept ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1584983469) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28311](https://github.com/bitcoin/bitcoin/pull/28311) ([WIP] BIP300 (Drivechains) consensus-level logic by luke-jr)\n* [#26711](https://github.com/bitcoin/bitcoin/pull/26711) (validate package transactions with their in-package ancestor sets by glozow)\n* [#25038](https://github.com/bitcoin/bitcoin/pull/25038) (policy: nVersion=3 and Package RBF by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1673181532",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "commented",
      "id": 1673181801,
      "node_id": "IC_kwDOABII585jurpp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673181801",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:32Z",
      "updated_at": "2023-08-10T13:04:32Z",
      "author_association": "MEMBER",
      "body": "cc @instagibbs ",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1673181801",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "mentioned",
      "id": 10059224991,
      "node_id": "MEE_lADOABII585t-sSfzwAAAAJXk5ef",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059224991",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:32Z"
    },
    {
      "event": "subscribed",
      "id": 10059225007,
      "node_id": "SE_lADOABII585t-sSfzwAAAAJXk5ev",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059225007",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:04:33Z"
    },
    {
      "event": "commented",
      "id": 1673202074,
      "node_id": "IC_kwDOABII585juwma",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1673202074",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:17:00Z",
      "updated_at": "2023-08-10T13:17:00Z",
      "author_association": "MEMBER",
      "body": "@sipa you might want to weigh in as well",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1673202074",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "mentioned",
      "id": 10059365473,
      "node_id": "MEE_lADOABII585t-sSfzwAAAAJXlbxh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059365473",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:17:00Z"
    },
    {
      "event": "subscribed",
      "id": 10059365492,
      "node_id": "SE_lADOABII585t-sSfzwAAAAJXlbx0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10059365492",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T13:17:01Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T14:06:42Z",
      "updated_at": "2023-08-10T14:06:42Z",
      "source": {
        "issue": {
          "id": 1668056618,
          "node_id": "I_kwDOABII585jbIYq",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27463",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27463/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27463/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27463/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/27463",
          "number": 27463,
          "state": "open",
          "state_reason": null,
          "title": "Package Relay Project Tracking",
          "body": "This issue will be edited frequently to reflect the current status of the project.\r\n\r\n**What should I review now?**\r\n:point_down: :point_down: :point_down: :point_down: :point_down: :point_down: :point_down:\r\n#28364 and #28251\r\n:point_up: :point_up: :point_up: :point_up: :point_up: :point_up: :point_up:\r\n\r\n**Mempool, Policy, Validation**\r\n- [x] Enable validation of multiple transactions in ATMP\r\n  - [x] Refactoring #21062, #22675, #23381\r\n  - [x] #20833\r\n  - [x] #21800\r\n  - [x] #22674\r\n- [x] #24152\r\n- [x] #24836 \r\n- [x] Avoid the risk of below-minrelaytxfee transactions hanging around forever in the mempool (currently only possible through reorgs and replacements after package CPFP). There are multiple options:\r\n   - Don't ever allow v1 and v2 txs below minrelaytxfee (#26933)\r\n   - Mine everything that makes it into in the mempool (default blockmintxfee to 0). Trim descendant packages <=0 fees, even when the mempool is not full (#27018)\r\n   - Other long-term improvements that address this problem, e.g. #27677.\r\n- [ ] #26711\r\n  - [ ] #28251\r\n- (Some existing DoS and incentive compatibility issues are addressed. It is safe to expose this interface on P2P)\r\n\r\n**Additional Policy**\r\n- [ ] Add v3 rules that make transactions/packages easier to work with (#25038)\r\n- [ ] Introduce a Miner Incentive Compatibility Score rule to RBF\r\n  - This is done for v3 transactions in #25038.\r\n  - Cluster-based mempool would allow this for all transactions: #27677.\r\n- [ ] Enable Package RBF for v3 transactions (#25038)\r\n- (Things like LN can sign things 0-fee, add fees at broadcast, and avoid pinning attacks. Assuming package relay is available.)\r\n- [ ] Add Ephemeral Anchors rules for v3 transactions (#26403)\r\n- (LN symmetry and other things can have 0-value anchors.)\r\n\r\n**P2P, Net Processing**\r\nFull implementation: #27742\r\n- [ ] BIP 331 (bitcoin/bips/pull/1382)\r\n- [ ] #28031\r\n  - [x] #28199\r\n  - [ ] #28364\r\n- (Orphan-handling is more robust)\r\n- [ ] (Milestone 2/3) Negotiate package relay support with peers, gated by config flag (`sendpackages`). Request ancestor package information for orphans (`MSG_ANCPKGINFO`, `ancpkginfo`).\r\n- (Assuming adoption, in most cases, package relay nodes never need to use txid-based relay)\r\n- [ ] (Milestone 3/3) Using package info, request (`getpkgtxns`), download (`pkgtxns`), and submit packages together.\r\n  - [ ] Introduce a mechanism for protecting orphan transactions from eviction.\r\n  - [ ] Avoid telling legacy peers about transactions that depend on below-fee-filter parents.\r\n- [ ] Default `-packagerelay` config flag to true.\r\n- (Assuming adoption, below-mempool min feerate CPFP'd transactions propagate.)",
          "user": {
            "login": "glozow",
            "id": 25183001,
            "node_id": "MDQ6VXNlcjI1MTgzMDAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/glozow",
            "html_url": "https://github.com/glozow",
            "followers_url": "https://api.github.com/users/glozow/followers",
            "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
            "organizations_url": "https://api.github.com/users/glozow/orgs",
            "repos_url": "https://api.github.com/users/glozow/repos",
            "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/glozow/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 64583,
              "node_id": "MDU6TGFiZWw2NDU4Mw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Feature",
              "name": "Feature",
              "color": "7cf575",
              "default": false
            },
            {
              "id": 64584,
              "node_id": "MDU6TGFiZWw2NDU4NA==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming",
              "name": "Brainstorming",
              "color": "ebd775",
              "default": false
            },
            {
              "id": 82428251,
              "node_id": "MDU6TGFiZWw4MjQyODI1MQ==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/TX%20fees%20and%20policy",
              "name": "TX fees and policy",
              "color": "5319e7",
              "default": false
            },
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 10,
          "created_at": "2023-04-14T11:14:50Z",
          "updated_at": "2023-08-29T14:02:07Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-10T14:07:51Z",
      "updated_at": "2023-08-10T14:07:51Z",
      "source": {
        "issue": {
          "id": 1221671479,
          "node_id": "PR_kwDOABII5843Gzwx",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25038",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25038/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25038/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/25038/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/25038",
          "number": 25038,
          "state": "open",
          "state_reason": null,
          "title": "policy: nVersion=3 and Package RBF",
          "body": "See #27463 for overall package relay tracking. This PR is in draft while ancestor package validation is being figured out.\r\n\r\nThis PR contains 2 projects: v3 policy and package RBF. Mailing list posts: [package RBF 1](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2021-September/019464.html) and [V3 + package RBF 2](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2022-September/020937.html). It stems from a long discussion about RBF pinning, across a [mailing list thread](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2022-January/019817.html) and [gist](https://gist.github.com/glozow/25d9662c52453bd08b4b4b1d3783b9ff).\r\n\r\nV3 Policy: A set of policy rules applied to transactions with their `nVersion` field set to 3. Namely, it allows users to opt in to more restrictive descendant limits for shared transactions. If adopted by many nodes in the network, V3 mitigates various RBF pinning attacks. See doc/policy/version3_transactions.md for the exact rules and rationale, and [these review club notes](bitcoincore.reviews/25038) for more background and discussion.\r\n\r\nPackage RBF: In addition to allowing a child to pay for its parents within the package, also allow the child to pay for replacing the parent's conflicts. For example, this allows LN users to replace commitment transactions existing in the mempool, simply by broadcasting their respective commitment transactions with a high-fee child. The commitment transactions can be signed with 0 fees, which means no overpaying.\r\n\r\nFAQ: is v3 still helpful even with cluster mempool (#27677) ?\r\n\r\n- Rule 3 pinning: This is addressed with v3 but not really with cluster mempool (descendant allowance is still too permissive).\r\n- Package RBF and ACP pinning: This PR allows for package RBF with v3 packages. V3 has an effective \"cluster limit\" of 2 which makes it very cheap to calculate the mining score of a v3 transaction. With cluster mempool, which also makes it easier to calculate mining score, we could have package RBF for non-v3 transactions.\r\n- Allowing 0fee transactions: This PR allows v3 transactions to be below minimum relay feerate, provided they are CPFP'd. This is because the simplified topology allows us to avoid situations like the ones described in #26933. With cluster mempool, we can allow this for non-v3 transactions.",
          "user": {
            "login": "glozow",
            "id": 25183001,
            "node_id": "MDQ6VXNlcjI1MTgzMDAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/glozow",
            "html_url": "https://github.com/glozow",
            "followers_url": "https://api.github.com/users/glozow/followers",
            "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
            "organizations_url": "https://api.github.com/users/glozow/orgs",
            "repos_url": "https://api.github.com/users/glozow/repos",
            "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/glozow/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 82428251,
              "node_id": "MDU6TGFiZWw4MjQyODI1MQ==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/TX%20fees%20and%20policy",
              "name": "TX fees and policy",
              "color": "5319e7",
              "default": false
            },
            {
              "id": 1392286103,
              "node_id": "MDU6TGFiZWwxMzkyMjg2MTAz",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20Conceptual%20Review",
              "name": "Needs Conceptual Review",
              "description": "",
              "color": "fef2c0",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 27,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/25038",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/25038",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/25038.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/25038.patch"
          },
          "created_at": "2022-04-30T00:24:31Z",
          "updated_at": "2023-08-29T20:25:55Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 1572237699,
      "node_id": "PRR_kwDOABII585dtnGD",
      "url": null,
      "actor": null,
      "commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "conditional ACK https://github.com/bitcoin/bitcoin/pull/28251/commits/c2c9dfe95b3c5b8332521d9a691725ee55ec3450\r\n\r\non having a test case catching the crash included. Tested with my own test case in https://github.com/bitcoin/bitcoin/pull/26403/commits/e3622f7ec944ec0e4c48ec3f29835d9f90d9d55c",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1572237699",
      "submitted_at": "2023-08-10T15:59:59Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "reviewed",
      "id": 1572955374,
      "node_id": "PRR_kwDOABII585dwWTu",
      "url": null,
      "actor": null,
      "commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Note the code path affected by the bug is under the `submitpackage` RPC, which is clearly indicated as an experimental RPC with an unstable interface.\r\n\r\nMore test coverage sounds good.",
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1572955374",
      "submitted_at": "2023-08-11T03:53:22Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-11T08:43:46Z",
      "updated_at": "2023-08-11T08:43:46Z",
      "source": {
        "issue": {
          "id": 1500046485,
          "node_id": "PR_kwDOABII585FocrT",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26711",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26711/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26711/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/26711/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/26711",
          "number": 26711,
          "state": "open",
          "state_reason": null,
          "title": "validate package transactions with their in-package ancestor sets",
          "body": "Builds on #28251, please review that first.\r\n\r\nThis contains everything to make mempool/validation logic ready for package relay (see #27463).\r\n\r\nThe hope here is to end up with the incentive-compatible transactions in our mempool. Prior to this commit, if parents within the package relied on each other, we could end up (1) accepting a low-feerate child or (2) rejecting high-feerate parents. See the \"interdependent parents\" test case for a specific example.\r\n\r\nA description of the package validation logic: https://github.com/bitcoin/bitcoin/pull/26711#issuecomment-1647523520",
          "user": {
            "login": "glozow",
            "id": 25183001,
            "node_id": "MDQ6VXNlcjI1MTgzMDAx",
            "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/glozow",
            "html_url": "https://github.com/glozow",
            "followers_url": "https://api.github.com/users/glozow/followers",
            "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
            "organizations_url": "https://api.github.com/users/glozow/orgs",
            "repos_url": "https://api.github.com/users/glozow/repos",
            "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/glozow/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 118379652,
              "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
              "name": "Validation",
              "color": "6060aa",
              "default": false
            },
            {
              "id": 164208572,
              "node_id": "MDU6TGFiZWwxNjQyMDg1NzI=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool",
              "name": "Mempool",
              "color": "fef2c0",
              "default": false
            },
            {
              "id": 5334691551,
              "node_id": "LA_kwDOABII588AAAABPfju3w",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
              "name": "CI failed",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 17,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/26711",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/26711",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/26711.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/26711.patch"
          },
          "created_at": "2022-12-16T11:27:00Z",
          "updated_at": "2023-08-29T23:20:05Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 1584983469,
      "node_id": "PRR_kwDOABII585eeO2t",
      "url": null,
      "actor": null,
      "commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK, will do a full review once the test has been added.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1584983469",
      "submitted_at": "2023-08-18T18:10:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "commented",
      "id": 1688170869,
      "node_id": "IC_kwDOABII585kn3F1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1688170869",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-22T13:16:45Z",
      "updated_at": "2023-08-22T13:19:32Z",
      "author_association": "MEMBER",
      "body": "Pushed a test - it should fail on master with the assertion.\r\n\r\nGenerally, the conditions to hit the case are:\r\n- An almost-full mempool.\r\n- `mempool_evicted_tx` (`parent`) A to-be-evicted tx that is submitted ahead of time. Has a very low feerate and is evicted immediately when mempool overflows. It has an output `coin_to_disappear`\r\n- A package consisting of:\r\n\t- `cpfp_parent` (`child_a`) parent that spends `coin_to_disappear` and fails a check that requires its input to be loaded and makes it eligible for reconsideration (e.g. below mempool minimum feerate).\r\n\t- high-feerate parent (`child_b`), high feerate so that they are submitted individually and trigger eviction.\r\n\t\t- I've used 6 high-feerate parents in this test to make it easy to trigger overflow.\r\n\t\t- In the EA test, `child_b` triggers eviction due to proactive trimming of the sponsorless `parent` instead of mempool overflow.\r\n\t- `package_child` (`child_c`) spending the above parents.\r\n\t\t- The child must pay a fee high enough to CPFP the low-feerate parent. \r\n\t- Additional requirements:\r\n\t\t- The low-feerate parent needs to be checked before the higher-feerate parents so that its inputs are loaded before the eviction happens. Otherwise it will just hit missing-inputs. This also means that as a side effect of the fee-based linearization in #26711 (which would put the low-feerate parent at the end), this test won't trigger. But I don't think the linearization is an adequate solution to this problem.\r\n\t\t- To make the test interesting, it should be low enough that the to-be-evicted tx is evicted regardless of when the eviction happens.\r\n\r\nTimeline of what happens:\r\n1. mempool is almost full\r\n2. `mempool_evicted_tx` is submitted to mempool\r\n3. `AcceptPackage(package)`:\r\n\t1. `AcceptSingleTransaction(cpfp_parent)`. This loads `coin_to_disappear` into `m_view` . After the fee is checked, the tx fails and we continue onto the next transactions.\r\n\t2. for each of the n high-feerate parents, `AcceptSingleTransaction(tx)`. These succeed and, in `Finalize()`, the transactions are submitted.\r\n\t\t1. (Without PR's changes) this also calls `LimitMempool()` which evicts by descendant score until the mempool is within size limits again.\r\n\t\t2. This kicks out `mempool_evicted_tx`, which means the `m_viewmempool` will no longer have a coin for `coin_to_disappear`. However, the coin has already been cached in `m_view` and it doesn't know this.\r\n\t3. `AcceptSingleTransaction(package_child)` fails due to missing inputs.\r\n\t4. `AcceptMultipleTransactions([cpfp_parent, package_child])` \r\n\t\t1. `PreChecks` looks for the inputs of each transaction, including the now-nonexistent `coin_to_disappear`. This succeeds because `m_view` has a coin for it.\r\n\t\t2. The CPFP works, so both transactions are submitted in `SubmitPackage()` , which calls `ConsensusScriptChecks()` which calls `CheckInputsFromMempoolAndCache()` which asserts that the coins all exist.\r\n\t\t\t1. We can't find the coin in the mempool (which is where it used to be).\r\n\t\t\t2. So we assume we will find it in the UTXO set. We call `AccessCoin()`  and assert `!coinFromUTXOSet.IsSpent()`. This fails because the coin does not exist (which is the same as isspent).",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1688170869",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "labeled",
      "id": 10159021372,
      "node_id": "LE_lADOABII585t-sSfzwAAAAJdhl08",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10159021372",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-22T13:59:56Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 10159043217,
      "node_id": "HRFPE_lADOABII585t-sSfzwAAAAJdhrKR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10159043217",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-22T14:01:41Z"
    },
    {
      "event": "commented",
      "id": 1688316931,
      "node_id": "IC_kwDOABII585koawD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1688316931",
      "actor": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-22T14:38:04Z",
      "updated_at": "2023-08-22T14:38:04Z",
      "author_association": "MEMBER",
      "body": "the above test description sounds right. The eldest ancestor gets trimmed due to size limitations, then things go wonky without this change",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1688316931",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "unlabeled",
      "id": 10160043044,
      "node_id": "UNLE_lADOABII585t-sSfzwAAAAJdlfQk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10160043044",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-22T15:22:05Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1589916383,
      "node_id": "PRR_kwDOABII585exDLf",
      "url": null,
      "actor": null,
      "commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK https://github.com/bitcoin/bitcoin/pull/28251/commits/3729ee483688da8427c9228de01407777d4e4691\r\n\r\nThe newly added test, while slightly obscure to trigger it, makes sense and triggers the crash bug when the fix is not applied.\r\n\r\n![image](https://github.com/bitcoin/bitcoin/assets/5767891/cf6e6bb5-3b77-447e-8f16-6f21d93f95af)\r\n",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1589916383",
      "submitted_at": "2023-08-22T17:37:35Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 10171551475,
      "node_id": "HRFPE_lADOABII585t-sSfzwAAAAJeRY7z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10171551475",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-23T15:19:17Z"
    },
    {
      "event": "commented",
      "id": 1690174835,
      "node_id": "IC_kwDOABII585kvgVz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1690174835",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-23T15:29:48Z",
      "updated_at": "2023-08-23T15:29:48Z",
      "author_association": "MEMBER",
      "body": "Updated the approach + added a test for replacement case.\r\n\r\nThere are now 2 fixes:\r\n(1) Clear any non-chainstate coins at the end of `AcceptSubPackage` so they can't be used in a different `AcceptSubPackage`.\r\n(2) Don't trim in the middle of package evaluation.\r\n\r\nTechnically (1) is sufficient, but I think (2) is also beneficial as it avoids changing the mempool minimum feerate (which affects how we group transactions) mid-package evaluation. It would be sad if a CPFP package contains a parent that's just barely above mempool minimum feerate, so we submit it, then evict it (due to later parent), then can't submit the child... when we could have just submitted all of them and evicted something else.",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#issuecomment-1690174835",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28251"
    },
    {
      "event": "renamed",
      "id": 10171890738,
      "node_id": "RTE_lADOABII585t-sSfzwAAAAJeSrwy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10171890738",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-23T15:51:05Z",
      "rename": {
        "from": "validation: avoid mempool eviction mid-package evaluation",
        "to": "validation: fix coins disappearing mid-package evaluation"
      }
    },
    {
      "event": "reviewed",
      "id": 1591955738,
      "node_id": "PRR_kwDOABII585e41Ea",
      "url": null,
      "actor": null,
      "commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Ifirst pass on most recent fix to https://github.com/bitcoin/bitcoin/pull/28251/commits/a5a029c7799cb1f972e3fddc896bf009068cd8db\r\n\r\napproach ack on fixes, would be flakey to trim things within packages prematurely. ",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1591955738",
      "submitted_at": "2023-08-23T16:51:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "labeled",
      "id": 10175712036,
      "node_id": "LE_lADOABII585t-sSfzwAAAAJehQsk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10175712036",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-24T01:04:00Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1592973079,
      "node_id": "PRR_kwDOABII585e8tcX",
      "url": null,
      "actor": null,
      "commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1592973079",
      "submitted_at": "2023-08-24T07:40:30Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "reviewed",
      "id": 1593858718,
      "node_id": "PRR_kwDOABII585fAFqe",
      "url": null,
      "actor": null,
      "commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1593858718",
      "submitted_at": "2023-08-24T19:20:29Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGMzYjU1MjkyNWQyZTViMTVlYTAyZTUwNzlkM2I4MmRiMDNkMDA3Yzk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c3b552925d2e5b15ea02e5079d3b82db03d007c9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c3b552925d2e5b15ea02e5079d3b82db03d007c9",
      "tree": {
        "sha": "7ca49775a2155dc554dbd0ede0a72a9636dc7e08",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7ca49775a2155dc554dbd0ede0a72a9636dc7e08"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b2ec0326fd76e64a6d0d7e4745506b29f60d0be5",
          "sha": "b2ec0326fd76e64a6d0d7e4745506b29f60d0be5",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b2ec0326fd76e64a6d0d7e4745506b29f60d0be5"
        }
      ],
      "message": "[CCoinsViewMemPool] track non-base coins and allow Reset\n\nTemporary coins should not be available in separate subpackage submissions.\nAny mempool coins that are cached in m_view should be removed whenever\nmempool contents change, as they may be spent or no longer exist.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T09:47:40Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-23T14:35:26Z"
      },
      "sha": "c3b552925d2e5b15ea02e5079d3b82db03d007c9"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 10192001096,
      "node_id": "HRFPE_lADOABII585t-sSfzwAAAAJffZhI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10192001096",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-25T11:24:53Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-25T12:43:21Z",
      "updated_at": "2023-08-25T12:43:21Z",
      "source": {
        "issue": {
          "id": 1860387785,
          "node_id": "PR_kwDOABII585YcPUw",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28311",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28311/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28311/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28311/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/28311",
          "number": 28311,
          "state": "open",
          "state_reason": null,
          "title": "[WIP] BIP300 (Drivechains) consensus-level logic",
          "body": "This is a (rough draft) clean rewrite of BIP300 (Drivechain) consensus-level code.\r\n\r\nInstead of a separate sidechain database (which may be prone to hard-to-review/test consistency issues), instead the unusable 8 MSB of the UTXO index are reserved for non-UTXO database entries, and the existing UTXO db and caching layer is shared. This can be refactored in the future, but I think it is the cleanest and most reviewable approach initially - open to other ideas, though. There's also some ugliness in the undo data to handle restoring the new data, but it's abstracted and shouldn't be too hard to reason about.\r\n\r\nUsing these new primitives, Drivechains can be reimplemented with a UTXO-like model. Note that there is zero activation logic in the current PR: the protocol changes are *always* active. Therefore, this will *not* work (at least not safely) on Bitcoin today, and cannot be deployed without significant additional changes to handle an activation.\r\n\r\nA new `SERIALIZE_TRANSACTION_FOR_WEIGHT` serialization flag is also added, that is meant only for weight counting. This allows for adjusting weight (upward) to fit additional resource requirements by new functionality. In this case, several Drivechain \"messages\" are expected to have a larger burden than their `OP_RETURN` encoding would otherwise weigh. However, the specific adjustments are not implemented in this draft.\r\n\r\nAs a consensus change, this can only be implemented with community support. Many people seem to have opinions, but please keep them to other forums. Despite providing and continuing this implementation, I myself do not thereby endorse or otherwise comment on the proposal itself.\r\n\r\nTherefore, not looking for concept ACKs/NACKs (ie, about Drivechains), just *Approach* ACKs / constructive criticism (ie, about *how* I'm implementing it).",
          "user": {
            "login": "luke-jr",
            "id": 1095675,
            "node_id": "MDQ6VXNlcjEwOTU2NzU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/luke-jr",
            "html_url": "https://github.com/luke-jr",
            "followers_url": "https://api.github.com/users/luke-jr/followers",
            "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
            "organizations_url": "https://api.github.com/users/luke-jr/orgs",
            "repos_url": "https://api.github.com/users/luke-jr/repos",
            "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/luke-jr/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 5334691551,
              "node_id": "LA_kwDOABII588AAAABPfju3w",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
              "name": "CI failed",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 17,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28311",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/28311",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/28311.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/28311.patch"
          },
          "created_at": "2023-08-22T01:17:13Z",
          "updated_at": "2023-08-29T21:25:44Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU3ZGU4YTgzYWFmNjkxNWI0ZjNiNzE5ZmM3MmIxMGQ3NWMwOGYzZWM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57de8a83aaf6915b4f3b719fc72b10d75c08f3ec",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/57de8a83aaf6915b4f3b719fc72b10d75c08f3ec",
      "tree": {
        "sha": "4ceea666cf4c47a556a96d5368d8a7ed8c2d7023",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4ceea666cf4c47a556a96d5368d8a7ed8c2d7023"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c3b552925d2e5b15ea02e5079d3b82db03d007c9",
          "sha": "c3b552925d2e5b15ea02e5079d3b82db03d007c9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c3b552925d2e5b15ea02e5079d3b82db03d007c9"
        }
      ],
      "message": "[validation] add AcceptSubPackage to delegate Accept* calls and clean up m_view\n\n(1) Call AcceptSingleTransaction when there is only 1 transaction in the\n  subpackage. This avoids calling PackageMempoolChecks() which enforces\nrules that don't need to be applied for a single transaction, i.e.\ndisabling CPFP carve out.\nThere is a slight change in the error type returned, as shown in the\ntxpackage_tests change.  When a transaction is the last one left in the\npackage and its fee is too low, this returns a PCKG_TX instead of\nPCKG_POLICY. This interface is clearer; \"package-fee-too-low\" for 1\ntransaction would be a bit misleading.\n\n(2) Clean up m_view and m_viewmempool so that coins created in this\nsub-package evaluation are not available for other sub-package\nevaluations. The contents of the mempool may change, so coins that are\navailable now might not be later.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2022-12-15T18:00:04Z"
      },
      "sha": "57de8a83aaf6915b4f3b719fc72b10d75c08f3ec"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU3NDY0YmVmYTZmMTUxYzRlZWQwZmMxZDhkYTJkNzRlM2ZlNmQxNzQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57464befa6f151c4eed0fc1d8da2d74e3fe6d174",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/57464befa6f151c4eed0fc1d8da2d74e3fe6d174",
      "tree": {
        "sha": "757f0505651d84fc2edc2e9e25eb79ec1e9d2880",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/757f0505651d84fc2edc2e9e25eb79ec1e9d2880"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57de8a83aaf6915b4f3b719fc72b10d75c08f3ec",
          "sha": "57de8a83aaf6915b4f3b719fc72b10d75c08f3ec",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/57de8a83aaf6915b4f3b719fc72b10d75c08f3ec"
        }
      ],
      "message": "[validation] make PackageMempoolAcceptResult members mutable\n\nAfter the PackageMempoolAcceptResult is returned from\nAcceptMultipleTransactions, leave room for results to change due to\nLimitMempool() eviction.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-10T10:47:56Z"
      },
      "sha": "57464befa6f151c4eed0fc1d8da2d74e3fe6d174"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDljODE2ZDYyMDcwZmYyODhmM2IxMWJkNDg0OWZiMmM0YjQ5NGEwMzA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9c816d62070ff288f3b11bd4849fb2c4b494a030",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9c816d62070ff288f3b11bd4849fb2c4b494a030",
      "tree": {
        "sha": "989221242f853bbd27cd497ba5e3055f1757a72b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/989221242f853bbd27cd497ba5e3055f1757a72b"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57464befa6f151c4eed0fc1d8da2d74e3fe6d174",
          "sha": "57464befa6f151c4eed0fc1d8da2d74e3fe6d174",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/57464befa6f151c4eed0fc1d8da2d74e3fe6d174"
        }
      ],
      "message": "[refactor] back-fill results in AcceptPackage\n\nInstead of populating the last PackageMempoolAcceptResult with stuff\nfrom results_final and individual_results_nonfinal, fill results_final\nand create a PackageMempoolAcceptResult using that one.\n\nA future commit will add LimitMempoolSize() which may change the status\nof each of these transactions from \"already in mempool\" or \"submitted to\nmempool\" to \"no longer in mempool\". We will change those transactions'\nresults here.\n\nA future commit also gets rid of the last AcceptSubPackage outside of\nthe loop. It makes more sense to use results_final as the place where\nall results end up.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-10T10:54:02Z"
      },
      "sha": "9c816d62070ff288f3b11bd4849fb2c4b494a030"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZhYjAwYTY0NzQyNWRjYjhlYTc4M2U2OGQ1NmJmY2FmMTRkYzhkOTE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fab00a647425dcb8ea783e68d56bfcaf14dc8d91",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fab00a647425dcb8ea783e68d56bfcaf14dc8d91",
      "tree": {
        "sha": "e00689b2f0f617f86d962cec00326029dac27c43",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e00689b2f0f617f86d962cec00326029dac27c43"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9c816d62070ff288f3b11bd4849fb2c4b494a030",
          "sha": "9c816d62070ff288f3b11bd4849fb2c4b494a030",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9c816d62070ff288f3b11bd4849fb2c4b494a030"
        }
      ],
      "message": "[validation] return correct result when already-in-mempool tx gets evicted\n\nBug fix: a transaction may be in the mempool when package evaluation\nbegins (so it is added to results_final with MEMPOOL_ENTRY or\nDIFFERENT_WITNESS), but get evicted due to another transaction\nsubmission.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T10:11:36Z"
      },
      "sha": "fab00a647425dcb8ea783e68d56bfcaf14dc8d91"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI1Mjg5MTEyZmFlY2VmMzZkY2FkYzcwMDA2MGViNDIyNmJiNzRmNzc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/25289112faecef36dcadc700060eb4226bb74f77",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/25289112faecef36dcadc700060eb4226bb74f77",
      "tree": {
        "sha": "26f028876c6d50022cf9ebae1cad9a0599f4ba55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/26f028876c6d50022cf9ebae1cad9a0599f4ba55"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fab00a647425dcb8ea783e68d56bfcaf14dc8d91",
          "sha": "fab00a647425dcb8ea783e68d56bfcaf14dc8d91",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fab00a647425dcb8ea783e68d56bfcaf14dc8d91"
        }
      ],
      "message": "[validation] don't LimitMempoolSize in any subpackage submissions\n\nDon't do any mempool evictions until package validation is done,\npreventing the mempool minimum feerate from changing. Whether we submit\ntransactions separately or as a package depends on whether they meet the\nmempool minimum feerate threshold, so it's best that the value not\nchange while we are evaluating a package.\nThis avoids a situation where we have a CPFP package in which\nthe parents meet the mempool minimum feerate and are submitted by\nthemselves, but they are evicted before we have submitted the child.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-10T11:11:21Z"
      },
      "sha": "25289112faecef36dcadc700060eb4226bb74f77"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQxNWYzOTgyMDc2MjcyZGQ4M2Y3ZTg0OGNmOWNjOGM0ZmE1YjFkYjk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d15f3982076272dd83f7e848cf9cc8c4fa5b1db9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d15f3982076272dd83f7e848cf9cc8c4fa5b1db9",
      "tree": {
        "sha": "99c9e170583f1d4b06f0d3f0d7f9fdcad86759c0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/99c9e170583f1d4b06f0d3f0d7f9fdcad86759c0"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/25289112faecef36dcadc700060eb4226bb74f77",
          "sha": "25289112faecef36dcadc700060eb4226bb74f77",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/25289112faecef36dcadc700060eb4226bb74f77"
        }
      ],
      "message": "[test framework] add ability to spend only confirmed utxos\n\nUseful to ensure that the topologies of packages/transactions are as\nexpected, preventing bugs caused by having unexpected mempool ancestors.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-14T09:10:06Z"
      },
      "sha": "d15f3982076272dd83f7e848cf9cc8c4fa5b1db9"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDIzNDQwNzM0NGFkYTJjODBjNjNmOGFkMWRhZWJlMTBjNjc2MDRmMDY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/234407344ada2c80c63f8ad1daebe10c67604f06",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/234407344ada2c80c63f8ad1daebe10c67604f06",
      "tree": {
        "sha": "06cd690ac93ac053726aed169efd44d64b8ea9ba",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/06cd690ac93ac053726aed169efd44d64b8ea9ba"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d15f3982076272dd83f7e848cf9cc8c4fa5b1db9",
          "sha": "d15f3982076272dd83f7e848cf9cc8c4fa5b1db9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d15f3982076272dd83f7e848cf9cc8c4fa5b1db9"
        }
      ],
      "message": "[refactor] split setup in mempool_limit test\n\nWe want to be able to re-use fill_mempool so that none of the tests\naffect each other.\n\nChange the logs from info to debug because they are otherwise repeated\nmany times in the test output.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-14T09:30:57Z"
      },
      "sha": "234407344ada2c80c63f8ad1daebe10c67604f06"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDIyZmUxM2UzNTI2YjU4MjE3MGMwNWY4MjMzOTVkYmEwYTNjOWM5OWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/22fe13e3526b582170c05f823395dba0a3c9c99a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/22fe13e3526b582170c05f823395dba0a3c9c99a",
      "tree": {
        "sha": "05e6ad50216c43acae367924d5bd1f59f0b06d66",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/05e6ad50216c43acae367924d5bd1f59f0b06d66"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/234407344ada2c80c63f8ad1daebe10c67604f06",
          "sha": "234407344ada2c80c63f8ad1daebe10c67604f06",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/234407344ada2c80c63f8ad1daebe10c67604f06"
        }
      ],
      "message": "[test] mempool coins disappearing mid-package evaluation\n\nTest for scenario(s) outlined in PR 28251.\nTest what happens when a package transaction spends a mempool coin which\nis fetched and then disappears mid-package evaluation due to eviction or\nreplacement.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-25T13:00:27Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-08-14T09:53:39Z"
      },
      "sha": "22fe13e3526b582170c05f823395dba0a3c9c99a"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 10192812509,
      "node_id": "HRFPE_lADOABII585t-sSfzwAAAAJfifnd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10192812509",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-25T13:00:41Z"
    },
    {
      "event": "unlabeled",
      "id": 10193979889,
      "node_id": "UNLE_lADOABII585t-sSfzwAAAAJfm8nx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10193979889",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-25T14:54:28Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1596008248,
      "node_id": "PRR_kwDOABII585fISc4",
      "url": null,
      "actor": null,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK https://github.com/bitcoin/bitcoin/pull/28251/commits/22fe13e3526b582170c05f823395dba0a3c9c99a\r\n\r\n",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1596008248",
      "submitted_at": "2023-08-25T16:04:43Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    },
    {
      "event": "reviewed",
      "id": 1601796934,
      "node_id": "PRR_kwDOABII585feXtG",
      "url": null,
      "actor": null,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Thanks for the in-depth explanation of the conditions to hit the case. Will review more the code and test coverage as high-prio.",
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#pullrequestreview-1601796934",
      "submitted_at": "2023-08-30T03:23:23Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290350524",
      "pull_request_review_id": 1572237699,
      "id": 1290350524,
      "node_id": "PRRC_kwDOABII585M6S-8",
      "diff_hunk": "@@ -1184,32 +1184,21 @@ bool MemPoolAccept::SubmitPackage(const ATMPArgs& args, std::vector<Workspace>&\n         }\n     }\n \n-    // It may or may not be the case that all the transactions made it into the mempool. Regardless,\n-    // make sure we haven't exceeded max mempool size.\n-    LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());",
      "path": "src/validation.cpp",
      "position": 55,
      "original_position": 15,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Declaration comments for `SubmitPackage` should reflect that it doesn't limit anymore, or just not mention limiting.",
      "created_at": "2023-08-10T15:54:30Z",
      "updated_at": "2023-08-10T15:59:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1290350524",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290350524"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1179,
      "original_line": 1179,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290355065",
      "pull_request_review_id": 1572237699,
      "id": 1290355065,
      "node_id": "PRRC_kwDOABII585M6UF5",
      "diff_hunk": "@@ -516,7 +516,7 @@ class MemPoolAccept\n                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,\n                             /* m_test_accept */ package_args.m_test_accept,\n                             /* m_allow_replacement */ true,\n-                            /* m_package_submission */ false,\n+                            /* m_package_submission */ true, // do not LimitMempool",
      "path": "src/validation.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "was this always supposed to be true?",
      "created_at": "2023-08-10T15:58:04Z",
      "updated_at": "2023-08-10T15:59:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1290355065",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290355065"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 519,
      "original_line": 519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290857304",
      "pull_request_review_id": 1572955374,
      "id": 1290857304,
      "node_id": "PRRC_kwDOABII585M8OtY",
      "diff_hunk": "@@ -554,6 +554,16 @@ class MemPoolAccept\n     */\n     PackageMempoolAcceptResult AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Submission of a subpackage.  If only 1 transaction exists in subpackage, calls\n+     * AcceptSingleTransaction() with adjusted ATMPArgs to avoid additional package policy\n+     * restrictions like PackageMempoolChecks() and disabled RBF, and creates a",
      "path": "src/validation.cpp",
      "position": 16,
      "original_position": 16,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": null,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The â€œdisabled RBFâ€ can sound as confusing. There is no nsequence opted-out of the transaction candidate targeted by a replacement, it sounds rather to mean the `m_allow_replacement` of `ATMPArgs` which is true for `SingleInPackageAccept` and false for `PackageChildWithParents`.",
      "created_at": "2023-08-11T03:21:30Z",
      "updated_at": "2023-08-11T03:53:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1290857304",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290857304"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 560,
      "original_line": 560,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290865427",
      "pull_request_review_id": 1572955374,
      "id": 1290865427,
      "node_id": "PRRC_kwDOABII585M8QsT",
      "diff_hunk": "@@ -516,7 +516,7 @@ class MemPoolAccept\n                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,\n                             /* m_test_accept */ package_args.m_test_accept,\n                             /* m_allow_replacement */ true,\n-                            /* m_package_submission */ false,\n+                            /* m_package_submission */ true, // do not LimitMempool",
      "path": "src/validation.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": null,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think this could document more where the â€œdo not LimitMempoolâ€ is applied, i.e in `Finalize()` L1123 which is itself called by `AcceptSingleTransaction` and the source of the bug. `LimitMempoolSize()` is called few times in validation.",
      "created_at": "2023-08-11T03:44:13Z",
      "updated_at": "2023-08-11T03:53:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1290865427",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290865427"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 519,
      "original_line": 519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290866687",
      "pull_request_review_id": 1572955374,
      "id": 1290866687,
      "node_id": "PRRC_kwDOABII585M8Q__",
      "diff_hunk": "@@ -1326,6 +1325,23 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    if (subpackage.size() > 1) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 101,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": null,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think this check doesnâ€™t have test coverage as tx are individually validated in `AcceptPackage`.",
      "created_at": "2023-08-11T03:47:42Z",
      "updated_at": "2023-08-11T03:53:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1290866687",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1290866687"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1333,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291488191",
      "pull_request_review_id": 1573909211,
      "id": 1291488191,
      "node_id": "PRRC_kwDOABII585M-ou_",
      "diff_hunk": "@@ -516,7 +516,7 @@ class MemPoolAccept\n                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,\n                             /* m_test_accept */ package_args.m_test_accept,\n                             /* m_allow_replacement */ true,\n-                            /* m_package_submission */ false,\n+                            /* m_package_submission */ true, // do not LimitMempool",
      "path": "src/validation.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": 1290355065,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No, as it means skipping `LimitMempoolSize` within `Finalize` and we're not always guaranteed to call `SubmitPackage` afterwards (e.g. if we quit early). It's safe to make it `true` now because we always do a `LimitMempoolSize` within `AcceptPackage`",
      "created_at": "2023-08-11T15:18:54Z",
      "updated_at": "2023-08-11T15:19:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1291488191",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1291488191"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 519,
      "original_line": 519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298712742",
      "pull_request_review_id": 1584983469,
      "id": 1298712742,
      "node_id": "PRRC_kwDOABII585NaMim",
      "diff_hunk": "@@ -1326,6 +1336,23 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "0678df31d50d36f92e39a7c709b0e1975695e2e8",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In the `AcceptMultipleTransactions` this is unused, to maybe move it down?",
      "created_at": "2023-08-18T17:53:41Z",
      "updated_at": "2023-08-18T18:10:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1298712742",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1298712742"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1341,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301942552",
      "pull_request_review_id": 1589916383,
      "id": 1301942552,
      "node_id": "PRRC_kwDOABII585NmhEY",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        parent_utxos = []\n+        package_txids = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=mempool_evicted_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+        package_hex.append(cpfp_parent[\"hex\"])\n+        parent_utxos.append(cpfp_parent[\"new_utxo\"])\n+        package_txids.append(cpfp_parent[\"txid\"])\n+        assert_equal(node.testmempoolaccept([cpfp_parent[\"hex\"]])[0][\"reject-reason\"], \"mempool min fee not met\")\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Series of parents that don't need CPFP and are submitted individually. Each one is large and\n+        # high feerate, which means they should trigger eviction but not be evicted.\n+        parent_weight = 100000\n+        num_big_parents = 3\n+        assert_greater_than(parent_weight * num_big_parents, current_info[\"maxmempool\"] - current_info[\"bytes\"])\n+        parent_fee = (100 * mempoolmin_feerate / 1000) * (parent_weight // 4)\n+\n+        for i in range(num_big_parents):\n+            parent = self.wallet.create_self_transfer(fee=parent_fee, target_weight=parent_weight, confirmed_only=True)\n+            parent_utxos.append(parent[\"new_utxo\"])\n+            package_hex.append(parent[\"hex\"])\n+            package_txids.append(parent[\"txid\"])\n+            # There is room for each of these transactions independently\n+            assert node.testmempoolaccept([parent[\"hex\"]])[0][\"allowed\"]\n+\n+        # Create a child spending everything, CPFPing the low-feerate parent just above mempool\n+        # minimum feerate. It's important not to bump too much as otherwise mempool_evicted_tx would\n+        # not be evicted, making this test much less meaningful. Approximate size of cpfp_parent +\n+        # child is.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        # Specific number of satoshis to fit within a small window. The parent_cpfp + child package needs to be\n+        # - When there is mid-package eviction, high enough feerate to meet the new mempoolminfee\n+        # - When there is no mid-package eviction, low enough feerate to be evicted immediately after submission.\n+        magic_satoshis = 1200\n+        cpfp_satoshis = int(cpfp_fee * COIN) + magic_satoshis\n+\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=cpfp_satoshis)\n+        package_hex.append(child[\"hex\"])\n+        package_txids.append(child[\"txid\"])\n+\n+        # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n+        with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n+            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+\n+        # Maximum size must never be exceeded.\n+        assert_greater_than(node.getmempoolinfo()[\"maxmempool\"], node.getmempoolinfo()[\"bytes\"])\n+\n+        # Evicted transaction and its descendants must not be in mempool.\n+        resulting_mempool_txids = node.getrawmempool()\n+        assert mempool_evicted_tx[\"txid\"] not in resulting_mempool_txids\n+        assert cpfp_parent[\"txid\"] not in resulting_mempool_txids\n+        assert child[\"txid\"] not in resulting_mempool_txids",
      "path": "test/functional/mempool_limit.py",
      "position": 149,
      "original_position": 107,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "should assert all 3 parents are in the mempool",
      "created_at": "2023-08-22T16:58:30Z",
      "updated_at": "2023-08-22T17:37:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1301942552",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301942552"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 167,
      "original_line": 167,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301971311",
      "pull_request_review_id": 1589916383,
      "id": 1301971311,
      "node_id": "PRRC_kwDOABII585NmoFv",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        parent_utxos = []\n+        package_txids = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.",
      "path": "test/functional/mempool_limit.py",
      "position": 97,
      "original_position": 53,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n        # coin is no longer available, but the cache could still contain the tx.\r\n```",
      "created_at": "2023-08-22T17:26:48Z",
      "updated_at": "2023-08-22T17:37:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1301971311",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301971311"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 115,
      "original_line": 115,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301972717",
      "pull_request_review_id": 1589916383,
      "id": 1301972717,
      "node_id": "PRRC_kwDOABII585Nmobt",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        parent_utxos = []",
      "path": "test/functional/mempool_limit.py",
      "position": 79,
      "original_position": 34,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n        parent_utxos = [] # utxos to be spent by the ultimate child transaction\r\n```",
      "created_at": "2023-08-22T17:28:11Z",
      "updated_at": "2023-08-22T17:37:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1301972717",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301972717"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 97,
      "original_line": 97,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301977111",
      "pull_request_review_id": 1589916383,
      "id": 1301977111,
      "node_id": "PRRC_kwDOABII585NmpgX",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        parent_utxos = []\n+        package_txids = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=mempool_evicted_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+        package_hex.append(cpfp_parent[\"hex\"])\n+        parent_utxos.append(cpfp_parent[\"new_utxo\"])\n+        package_txids.append(cpfp_parent[\"txid\"])\n+        assert_equal(node.testmempoolaccept([cpfp_parent[\"hex\"]])[0][\"reject-reason\"], \"mempool min fee not met\")\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Series of parents that don't need CPFP and are submitted individually. Each one is large and\n+        # high feerate, which means they should trigger eviction but not be evicted.\n+        parent_weight = 100000\n+        num_big_parents = 3\n+        assert_greater_than(parent_weight * num_big_parents, current_info[\"maxmempool\"] - current_info[\"bytes\"])\n+        parent_fee = (100 * mempoolmin_feerate / 1000) * (parent_weight // 4)\n+\n+        for i in range(num_big_parents):\n+            parent = self.wallet.create_self_transfer(fee=parent_fee, target_weight=parent_weight, confirmed_only=True)\n+            parent_utxos.append(parent[\"new_utxo\"])\n+            package_hex.append(parent[\"hex\"])\n+            package_txids.append(parent[\"txid\"])\n+            # There is room for each of these transactions independently\n+            assert node.testmempoolaccept([parent[\"hex\"]])[0][\"allowed\"]\n+\n+        # Create a child spending everything, CPFPing the low-feerate parent just above mempool",
      "path": "test/functional/mempool_limit.py",
      "position": null,
      "original_position": 80,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n        # Create a child spending everything, CPFPing the low-feerate cpfp_parent just above mempool\r\n```",
      "created_at": "2023-08-22T17:32:27Z",
      "updated_at": "2023-08-22T17:37:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1301977111",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301977111"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 150,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301978861",
      "pull_request_review_id": 1589916383,
      "id": 1301978861,
      "node_id": "PRRC_kwDOABII585Nmp7t",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")",
      "path": "test/functional/mempool_limit.py",
      "position": null,
      "original_position": 20,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction before package submission terminates\")\r\n```",
      "created_at": "2023-08-22T17:34:09Z",
      "updated_at": "2023-08-22T17:37:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1301978861",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1301978861"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 91,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303183629",
      "pull_request_review_id": 1591859179,
      "id": 1303183629,
      "node_id": "PRRC_kwDOABII585NrQEN",
      "diff_hunk": "@@ -1326,6 +1325,23 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    if (subpackage.size() > 1) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 101,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": 1290866687,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No, `AcceptPackage` also calls this for `txns_package_eval` which can have multiple transactions.",
      "created_at": "2023-08-23T15:21:00Z",
      "updated_at": "2023-08-23T15:21:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303183629",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303183629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1333,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303184115",
      "pull_request_review_id": 1591859933,
      "id": 1303184115,
      "node_id": "PRRC_kwDOABII585NrQLz",
      "diff_hunk": "@@ -1184,32 +1184,21 @@ bool MemPoolAccept::SubmitPackage(const ATMPArgs& args, std::vector<Workspace>&\n         }\n     }\n \n-    // It may or may not be the case that all the transactions made it into the mempool. Regardless,\n-    // make sure we haven't exceeded max mempool size.\n-    LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());",
      "path": "src/validation.cpp",
      "position": 55,
      "original_position": 15,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": 1290350524,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed, thanks",
      "created_at": "2023-08-23T15:21:20Z",
      "updated_at": "2023-08-23T15:21:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303184115",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303184115"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1179,
      "original_line": 1179,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303184486",
      "pull_request_review_id": 1591860461,
      "id": 1303184486,
      "node_id": "PRRC_kwDOABII585NrQRm",
      "diff_hunk": "@@ -1326,6 +1336,23 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "0678df31d50d36f92e39a7c709b0e1975695e2e8",
      "in_reply_to_id": 1298712742,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Moved",
      "created_at": "2023-08-23T15:21:32Z",
      "updated_at": "2023-08-23T15:21:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303184486",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303184486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1341,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303185024",
      "pull_request_review_id": 1591861267,
      "id": 1303185024,
      "node_id": "PRRC_kwDOABII585NrQaA",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        parent_utxos = []\n+        package_txids = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=mempool_evicted_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+        package_hex.append(cpfp_parent[\"hex\"])\n+        parent_utxos.append(cpfp_parent[\"new_utxo\"])\n+        package_txids.append(cpfp_parent[\"txid\"])\n+        assert_equal(node.testmempoolaccept([cpfp_parent[\"hex\"]])[0][\"reject-reason\"], \"mempool min fee not met\")\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Series of parents that don't need CPFP and are submitted individually. Each one is large and\n+        # high feerate, which means they should trigger eviction but not be evicted.\n+        parent_weight = 100000\n+        num_big_parents = 3\n+        assert_greater_than(parent_weight * num_big_parents, current_info[\"maxmempool\"] - current_info[\"bytes\"])\n+        parent_fee = (100 * mempoolmin_feerate / 1000) * (parent_weight // 4)\n+\n+        for i in range(num_big_parents):\n+            parent = self.wallet.create_self_transfer(fee=parent_fee, target_weight=parent_weight, confirmed_only=True)\n+            parent_utxos.append(parent[\"new_utxo\"])\n+            package_hex.append(parent[\"hex\"])\n+            package_txids.append(parent[\"txid\"])\n+            # There is room for each of these transactions independently\n+            assert node.testmempoolaccept([parent[\"hex\"]])[0][\"allowed\"]\n+\n+        # Create a child spending everything, CPFPing the low-feerate parent just above mempool\n+        # minimum feerate. It's important not to bump too much as otherwise mempool_evicted_tx would\n+        # not be evicted, making this test much less meaningful. Approximate size of cpfp_parent +\n+        # child is.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        # Specific number of satoshis to fit within a small window. The parent_cpfp + child package needs to be\n+        # - When there is mid-package eviction, high enough feerate to meet the new mempoolminfee\n+        # - When there is no mid-package eviction, low enough feerate to be evicted immediately after submission.\n+        magic_satoshis = 1200\n+        cpfp_satoshis = int(cpfp_fee * COIN) + magic_satoshis\n+\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=cpfp_satoshis)\n+        package_hex.append(child[\"hex\"])\n+        package_txids.append(child[\"txid\"])\n+\n+        # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n+        with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n+            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+\n+        # Maximum size must never be exceeded.\n+        assert_greater_than(node.getmempoolinfo()[\"maxmempool\"], node.getmempoolinfo()[\"bytes\"])\n+\n+        # Evicted transaction and its descendants must not be in mempool.\n+        resulting_mempool_txids = node.getrawmempool()\n+        assert mempool_evicted_tx[\"txid\"] not in resulting_mempool_txids\n+        assert cpfp_parent[\"txid\"] not in resulting_mempool_txids\n+        assert child[\"txid\"] not in resulting_mempool_txids",
      "path": "test/functional/mempool_limit.py",
      "position": 149,
      "original_position": 107,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": 1301942552,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Added this and the comment fixups",
      "created_at": "2023-08-23T15:21:52Z",
      "updated_at": "2023-08-23T15:21:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303185024",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303185024"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 167,
      "original_line": 167,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303250157",
      "pull_request_review_id": 1591955738,
      "id": 1303250157,
      "node_id": "PRRC_kwDOABII585NrgTt",
      "diff_hunk": "@@ -982,6 +982,7 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n     if (ptx) {\n         if (outpoint.n < ptx->vout.size()) {\n             coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+            m_non_base_coins.emplace(outpoint);",
      "path": "src/txmempool.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "this side-effect should be noted in the declaration comments",
      "created_at": "2023-08-23T16:11:37Z",
      "updated_at": "2023-08-23T16:51:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303250157",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303250157"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 985,
      "original_line": 985,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303253413",
      "pull_request_review_id": 1591955738,
      "id": 1303253413,
      "node_id": "PRRC_kwDOABII585NrhGl",
      "diff_hunk": "@@ -839,6 +839,12 @@ class CCoinsViewMemPool : public CCoinsViewBacked\n     * validation, since we can access transaction outputs without submitting them to mempool.\n     */\n     std::unordered_map<COutPoint, Coin, SaltedOutpointHasher> m_temp_added;\n+\n+    /**\n+     * Set of all coins that have been fetched from mempool (not base). Used to internally track",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 6,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n     * Set of all coins that have been fetched from mempool or package (not base). Used to internally track\r\n```",
      "created_at": "2023-08-23T16:13:20Z",
      "updated_at": "2023-08-23T16:51:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303253413",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303253413"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 844,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303262613",
      "pull_request_review_id": 1591955738,
      "id": 1303262613,
      "node_id": "PRRC_kwDOABII585NrjWV",
      "diff_hunk": "@@ -994,8 +995,22 @@ void CCoinsViewMemPool::PackageAddTransaction(const CTransactionRef& tx)\n {\n     for (unsigned int n = 0; n < tx->vout.size(); ++n) {\n         m_temp_added.emplace(COutPoint(tx->GetHash(), n), Coin(tx->vout[n], MEMPOOL_HEIGHT, false));\n+        m_non_base_coins.emplace(COutPoint(tx->GetHash(), n));\n     }\n }\n+std::unordered_set<COutPoint, SaltedOutpointHasher> CCoinsViewMemPool::GetNonBaseCoins() const\n+{\n+    std::unordered_set<COutPoint, SaltedOutpointHasher> non_base_coins(m_non_base_coins.cbegin(), m_non_base_coins.cend());\n+    for (const auto& [coin, _] : m_temp_added) {",
      "path": "src/txmempool.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "why is this necessary after `PackageAddTransaction` changes https://github.com/bitcoin/bitcoin/pull/28251/files#diff-c065d4cd2398ad0dbcef393c5dfc53f465bf44723348892395fffd2fb3bac522R998 ; shouldn't `non_base_coins` be a superset of `m_temp_added`?",
      "created_at": "2023-08-23T16:20:51Z",
      "updated_at": "2023-08-23T16:51:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303262613",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303262613"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1004,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303286812",
      "pull_request_review_id": 1591955738,
      "id": 1303286812,
      "node_id": "PRRC_kwDOABII585NrpQc",
      "diff_hunk": "@@ -86,13 +86,172 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        # UTXOs to be spent by the ultimate child transaction\n+        parent_utxos = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=mempool_evicted_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+        package_hex.append(cpfp_parent[\"hex\"])\n+        parent_utxos.append(cpfp_parent[\"new_utxo\"])\n+        assert_equal(node.testmempoolaccept([cpfp_parent[\"hex\"]])[0][\"reject-reason\"], \"mempool min fee not met\")\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Series of parents that don't need CPFP and are submitted individually. Each one is large and\n+        # high feerate, which means they should trigger eviction but not be evicted.\n+        parent_weight = 100000\n+        num_big_parents = 3\n+        assert_greater_than(parent_weight * num_big_parents, current_info[\"maxmempool\"] - current_info[\"bytes\"])\n+        parent_fee = (100 * mempoolmin_feerate / 1000) * (parent_weight // 4)\n+\n+        big_parent_txids = []\n+        for i in range(num_big_parents):\n+            parent = self.wallet.create_self_transfer(fee=parent_fee, target_weight=parent_weight, confirmed_only=True)\n+            parent_utxos.append(parent[\"new_utxo\"])\n+            package_hex.append(parent[\"hex\"])\n+            big_parent_txids.append(parent[\"txid\"])\n+            # There is room for each of these transactions independently\n+            assert node.testmempoolaccept([parent[\"hex\"]])[0][\"allowed\"]\n+\n+        # Create a child spending everything, bumping cpfp_parent just above mempool minimum\n+        # feerate. It's important not to bump too much as otherwise mempool_evicted_tx would not be\n+        # evicted, making this test much less meaningful.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        # Specific number of satoshis to fit within a small window. The parent_cpfp + child package needs to be\n+        # - When there is mid-package eviction, high enough feerate to meet the new mempoolminfee\n+        # - When there is no mid-package eviction, low enough feerate to be evicted immediately after submission.\n+        magic_satoshis = 1200\n+        cpfp_satoshis = int(cpfp_fee * COIN) + magic_satoshis\n+\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=cpfp_satoshis)\n+        package_hex.append(child[\"hex\"])\n+\n+        # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n+        with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n+            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+\n+        # Maximum size must never be exceeded.\n+        assert_greater_than(node.getmempoolinfo()[\"maxmempool\"], node.getmempoolinfo()[\"bytes\"])\n+\n+        # Evicted transaction and its descendants must not be in mempool.\n+        resulting_mempool_txids = node.getrawmempool()\n+        assert mempool_evicted_tx[\"txid\"] not in resulting_mempool_txids\n+        assert cpfp_parent[\"txid\"] not in resulting_mempool_txids\n+        assert child[\"txid\"] not in resulting_mempool_txids\n+        for txid in big_parent_txids:\n+            assert txid in resulting_mempool_txids\n+\n+    def test_mid_package_replacement(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where an early tx depends on a later-replaced mempool tx\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        double_spent_utxo = self.wallet.get_utxo(confirmed_only=True)\n+        replaced_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            utxo_to_spend=double_spent_utxo,\n+            fee_rate=mempoolmin_feerate,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert replaced_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contain the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=replaced_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Parent that replaces the parent of cpfp_parent.\n+        replacement_tx = self.wallet.create_self_transfer(\n+            utxo_to_spend=double_spent_utxo,\n+            fee_rate=10*mempoolmin_feerate,\n+            confirmed_only=True\n+        )\n+        parent_utxos = [cpfp_parent[\"new_utxo\"], replacement_tx[\"new_utxo\"]]\n+\n+        # Create a child spending everything, CPFPing the low-feerate parent.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (2 * mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=int(cpfp_fee * COIN))\n+        package_hex = [cpfp_parent[\"hex\"], replacement_tx[\"hex\"], child[\"hex\"]]",
      "path": "test/functional/mempool_limit.py",
      "position": 205,
      "original_position": 146,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Should have a note that the importance of the submission order is paramount to the test catching the issue. \r\n\r\ni.e. something like this passes without the fix:\r\n```\r\npackage_hex = [replacement_tx[\"hex\"], cpfp_parent[\"hex\"], child[\"hex\"]]\r\n```",
      "created_at": "2023-08-23T16:42:22Z",
      "updated_at": "2023-08-23T16:51:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303286812",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303286812"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 223,
      "original_line": 223,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303930607",
      "pull_request_review_id": 1592973079,
      "id": 1303930607,
      "node_id": "PRRC_kwDOABII585NuGbv",
      "diff_hunk": "@@ -1326,6 +1325,47 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    const auto result = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs) {\n+        if (subpackage.size() > 1) {\n+            return AcceptMultipleTransactions(subpackage, args);\n+        }\n+        const auto& tx = subpackage.front();\n+        ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+        const auto single_res = AcceptSingleTransaction(tx, single_args);\n+        PackageValidationState package_state_wrapped;\n+        if (single_res.m_result_type != MempoolAcceptResult::ResultType::VALID) {\n+            package_state_wrapped.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+        }\n+        return PackageMempoolAcceptResult(package_state_wrapped, {{tx->GetWitnessHash(), single_res}});\n+    }();\n+    // There are 3 kinds of coins in m_view:\n+    // (1) Temporary coins from the transactions in subpackage, constructed by m_viewmempool.\n+    // (2) Mempool coins from transactions in the mempool, constructed by m_viewmempool.\n+    // (3) Chainstate coins fetched from our current UTXO set.\n+    //\n+    // (1) Temporary coins need to be removed. If transactions were submitted to the mempool,\n+    // m_viewmempool will be able to fetch them from there. If they weren't submitted to\n+    // mempool, it is incorrect to keep them - future calls may try to spend those coins that\n+    // don't actually exist.\n+    // (2) Mempool coins also need to be removed. If the mempool contents have changed, coins\n+    // previously fetched from mempool may now be spent or nonexistent. Those coins need to be\n+    // deleted from m_view.\n+    // (3) Chainstate coins don't need to be removed, as the chainstate has not changed (we are\n+    // holding cs_main and no blocks have been processed). They *should not* be removed, as we\n+    // wouldn't want to fetch them again.\n+    for (const auto& outpoint : m_viewmempool.GetNonBaseCoins()) {\n+        // We also need to manually delete these coins from m_view because it has cached copies\n+        // of the coins it fetched from m_viewmempool when they were connected.\n+        m_view.Uncache(outpoint);\n+    }\n+    m_viewmempool.Reset();\n+    return result;",
      "path": "src/validation.cpp",
      "position": 146,
      "original_position": 139,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "MarcoFalke",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/MarcoFalke",
        "html_url": "https://github.com/MarcoFalke",
        "followers_url": "https://api.github.com/users/MarcoFalke/followers",
        "following_url": "https://api.github.com/users/MarcoFalke/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/MarcoFalke/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/MarcoFalke/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
        "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
        "repos_url": "https://api.github.com/users/MarcoFalke/repos",
        "events_url": "https://api.github.com/users/MarcoFalke/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```\r\nvalidation.cpp:1369:12: error: constness of 'result' prevents automatic move [performance-no-automatic-move,-warnings-as-errors]\r\n    return result;",
      "created_at": "2023-08-24T07:40:30Z",
      "updated_at": "2023-08-24T07:40:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1303930607",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1303930607"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1373,
      "original_line": 1373,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304490960",
      "pull_request_review_id": 1593858718,
      "id": 1304490960,
      "node_id": "PRRC_kwDOABII585NwPPQ",
      "diff_hunk": "@@ -1326,6 +1325,47 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    const auto result = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs) {\n+        if (subpackage.size() > 1) {\n+            return AcceptMultipleTransactions(subpackage, args);\n+        }\n+        const auto& tx = subpackage.front();\n+        ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+        const auto single_res = AcceptSingleTransaction(tx, single_args);\n+        PackageValidationState package_state_wrapped;\n+        if (single_res.m_result_type != MempoolAcceptResult::ResultType::VALID) {\n+            package_state_wrapped.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+        }\n+        return PackageMempoolAcceptResult(package_state_wrapped, {{tx->GetWitnessHash(), single_res}});\n+    }();\n+    // There are 3 kinds of coins in m_view:",
      "path": "src/validation.cpp",
      "position": 121,
      "original_position": 118,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n    // This is an optimization to not re-fetch chainstate coins into the cache. There are 3 kinds of coins in m_view:\r\n```",
      "created_at": "2023-08-24T15:15:14Z",
      "updated_at": "2023-08-24T19:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1304490960",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304490960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1348,
      "original_line": 1348,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304701809",
      "pull_request_review_id": 1593858718,
      "id": 1304701809,
      "node_id": "PRRC_kwDOABII585NxCtx",
      "diff_hunk": "@@ -1505,32 +1505,28 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         }\n     }\n \n-    // Quit early because package validation won't change the result or the entire package has\n-    // already been submitted.\n-    if (quit_early || txns_package_eval.empty()) {\n-        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n-            Assume(results_final.emplace(wtxid, mempoolaccept_res).second);\n-            Assume(mempoolaccept_res.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n-        }\n-        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results_final));\n-    }\n-    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n-    // own PackageValidationState; package_state_quit_early is unused past this point.\n-    auto submission_result = AcceptSubPackage(txns_package_eval, args);\n-    // Include already-in-mempool transaction results in the final result.\n-    for (const auto& [wtxid, mempoolaccept_res] : results_final) {\n-        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);\n-        Assume(mempoolaccept_res.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n-    }\n-    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n-        // Package validation failed because one or more transactions failed. Provide a result for\n-        // each transaction; if a transaction doesn't have an entry in submission_result,\n-        // include the previous individual failure reason.\n-        submission_result.m_tx_results.insert(individual_results_nonfinal.cbegin(),\n-                                              individual_results_nonfinal.cend());\n-        Assume(submission_result.m_tx_results.size() == package.size());\n-    }\n-    return submission_result;\n+    auto final_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a98da1a9844cdbc1cdeeeed9d4d9b80ea0cb7ee6",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "commit message \"[refactor] back-fill m_tx_results in AcceptPackage\" is old; should be `results_final`?",
      "created_at": "2023-08-24T18:16:02Z",
      "updated_at": "2023-08-24T19:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1304701809",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304701809"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1508,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304712148",
      "pull_request_review_id": 1593858718,
      "id": 1304712148,
      "node_id": "PRRC_kwDOABII585NxFPU",
      "diff_hunk": "@@ -1505,32 +1505,28 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         }\n     }\n \n-    // Quit early because package validation won't change the result or the entire package has\n-    // already been submitted.\n-    if (quit_early || txns_package_eval.empty()) {\n-        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n-            Assume(results_final.emplace(wtxid, mempoolaccept_res).second);\n-            Assume(mempoolaccept_res.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n-        }\n-        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results_final));\n-    }\n-    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n-    // own PackageValidationState; package_state_quit_early is unused past this point.\n-    auto submission_result = AcceptSubPackage(txns_package_eval, args);\n-    // Include already-in-mempool transaction results in the final result.\n-    for (const auto& [wtxid, mempoolaccept_res] : results_final) {\n-        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);\n-        Assume(mempoolaccept_res.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n-    }\n-    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n-        // Package validation failed because one or more transactions failed. Provide a result for\n-        // each transaction; if a transaction doesn't have an entry in submission_result,\n-        // include the previous individual failure reason.\n-        submission_result.m_tx_results.insert(individual_results_nonfinal.cbegin(),\n-                                              individual_results_nonfinal.cend());\n-        Assume(submission_result.m_tx_results.size() == package.size());\n-    }\n-    return submission_result;\n+    auto final_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :\n+        AcceptSubPackage(txns_package_eval, args);\n+    PackageValidationState& package_state_final = final_submission_result.m_state;\n+\n+    for (const auto& tx : package) {\n+        const auto& wtxid = tx->GetWitnessHash();\n+        if (final_submission_result.m_tx_results.count(wtxid) > 0) {\n+            // We shouldn't have re-submitted if the tx result was already in results_final.\n+            Assume(results_final.count(wtxid) == 0);\n+            results_final.emplace(wtxid, final_submission_result.m_tx_results.at(wtxid));\n+        } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {\n+            // Already-in-mempool transaction.\n+            Assume(it->second.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n+            Assume(individual_results_nonfinal.count(wtxid) == 0);\n+        } else if (const auto it{individual_results_nonfinal.find(wtxid)}; it != individual_results_nonfinal.end()) {",
      "path": "src/validation.cpp",
      "position": 253,
      "original_position": 44,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a98da1a9844cdbc1cdeeeed9d4d9b80ea0cb7ee6",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Looks like we're considering `individual_results_nonfinal` after the subpackage one, contrary to the description of `individual_results_nonfinal` which says that in the event of multiple failures, the individual result is reported. Looks like there's no test coverage of this case; how important is it?",
      "created_at": "2023-08-24T18:27:23Z",
      "updated_at": "2023-08-24T19:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1304712148",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304712148"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1541,
      "original_line": 1541,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304736690",
      "pull_request_review_id": 1593858718,
      "id": 1304736690,
      "node_id": "PRRC_kwDOABII585NxLOy",
      "diff_hunk": "@@ -516,7 +516,7 @@ class MemPoolAccept\n                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 1,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "4cd3b8f2edb3176fef4dbc6109188d62e7dd2ba6",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "from commit message in 4cd3b8f2edb3176fef4dbc6109188d62e7dd2ba6\r\n\r\n\"- We cache a coin from a mempool transaction in m_view, but the coin\r\n      disappears due to eviction.\"\r\n\r\nNo longer true with the `AcceptSubPackage` changes in place",
      "created_at": "2023-08-24T18:52:41Z",
      "updated_at": "2023-08-24T19:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1304736690",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304736690"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 516,
      "original_line": 516,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304756440",
      "pull_request_review_id": 1593858718,
      "id": 1304756440,
      "node_id": "PRRC_kwDOABII585NxQDY",
      "diff_hunk": "@@ -1509,16 +1497,36 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         AcceptSubPackage(txns_package_eval, args);\n     PackageValidationState& package_state_final = final_submission_result.m_state;\n \n+    // Make sure we haven't exceeded max mempool size.\n+    // Package transactions that were submitted to mempool or already in mempool may be evicted.\n+    LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());\n+\n     for (const auto& tx : package) {\n+        // In case a transaction was in mempool but was evicted in the call to LimitMempoolSize().\n+        TxValidationState mempool_full_state;\n+        mempool_full_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"mempool full\");\n         const auto& wtxid = tx->GetWitnessHash();\n         if (final_submission_result.m_tx_results.count(wtxid) > 0) {\n             // We shouldn't have re-submitted if the tx result was already in results_final.\n             Assume(results_final.count(wtxid) == 0);\n-            results_final.emplace(wtxid, final_submission_result.m_tx_results.at(wtxid));\n+            // If it was submitted, check to see if the tx is still in the mempool. It could have\n+            // been evicted due to LimitMempoolSize() above.\n+            const auto& txresult = final_submission_result.m_tx_results.at(wtxid);\n+            if (txresult.m_result_type == MempoolAcceptResult::ResultType::VALID && !m_pool.exists(GenTxid::Wtxid(wtxid))) {\n+                package_state_final.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                results_final.emplace(wtxid, MempoolAcceptResult::Failure(mempool_full_state));\n+            } else {\n+                results_final.emplace(wtxid, txresult);\n+            }\n         } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {\n-            // Already-in-mempool transaction.\n+            // Already-in-mempool transaction. Check to see if it's still in the mempool. It could\n+            // have been evicted due to LimitMempoolSize() above. Check by txid to include the\n+            // same-txid-different-witness case.\n             Assume(it->second.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n             Assume(individual_results_nonfinal.count(wtxid) == 0);\n+            if (!m_pool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                package_state_final.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");",
      "path": "src/validation.cpp",
      "position": 246,
      "original_position": 92,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "4cd3b8f2edb3176fef4dbc6109188d62e7dd2ba6",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n                package_state_final.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\r\n                results_final.emplace(wtxid, MempoolAcceptResult::Failure(mempool_full_state));\r\n```\r\n?",
      "created_at": "2023-08-24T19:12:43Z",
      "updated_at": "2023-08-24T19:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1304756440",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1304756440"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1534,
      "original_line": 1534,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305441088",
      "pull_request_review_id": 1595348940,
      "id": 1305441088,
      "node_id": "PRRC_kwDOABII585Nz3NA",
      "diff_hunk": "@@ -982,6 +982,7 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n     if (ptx) {\n         if (outpoint.n < ptx->vout.size()) {\n             coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+            m_non_base_coins.emplace(outpoint);",
      "path": "src/txmempool.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1303250157,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Added",
      "created_at": "2023-08-25T09:44:04Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305441088",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305441088"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 985,
      "original_line": 985,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305444269",
      "pull_request_review_id": 1595348940,
      "id": 1305444269,
      "node_id": "PRRC_kwDOABII585Nz3-t",
      "diff_hunk": "@@ -994,8 +995,22 @@ void CCoinsViewMemPool::PackageAddTransaction(const CTransactionRef& tx)\n {\n     for (unsigned int n = 0; n < tx->vout.size(); ++n) {\n         m_temp_added.emplace(COutPoint(tx->GetHash(), n), Coin(tx->vout[n], MEMPOOL_HEIGHT, false));\n+        m_non_base_coins.emplace(COutPoint(tx->GetHash(), n));\n     }\n }\n+std::unordered_set<COutPoint, SaltedOutpointHasher> CCoinsViewMemPool::GetNonBaseCoins() const\n+{\n+    std::unordered_set<COutPoint, SaltedOutpointHasher> non_base_coins(m_non_base_coins.cbegin(), m_non_base_coins.cend());\n+    for (const auto& [coin, _] : m_temp_added) {",
      "path": "src/txmempool.cpp",
      "position": null,
      "original_position": 18,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1303262613,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes. I've changed this to just return `m_non_base_coins`.",
      "created_at": "2023-08-25T09:46:35Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305444269",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305444269"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1004,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305445765",
      "pull_request_review_id": 1595348940,
      "id": 1305445765,
      "node_id": "PRRC_kwDOABII585Nz4WF",
      "diff_hunk": "@@ -839,6 +839,12 @@ class CCoinsViewMemPool : public CCoinsViewBacked\n     * validation, since we can access transaction outputs without submitting them to mempool.\n     */\n     std::unordered_map<COutPoint, Coin, SaltedOutpointHasher> m_temp_added;\n+\n+    /**\n+     * Set of all coins that have been fetched from mempool (not base). Used to internally track",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 6,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1303253413,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "added",
      "created_at": "2023-08-25T09:47:49Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305445765",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305445765"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 844,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305500514",
      "pull_request_review_id": 1595348940,
      "id": 1305500514,
      "node_id": "PRRC_kwDOABII585N0Fti",
      "diff_hunk": "@@ -1326,6 +1325,47 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    const auto result = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs) {\n+        if (subpackage.size() > 1) {\n+            return AcceptMultipleTransactions(subpackage, args);\n+        }\n+        const auto& tx = subpackage.front();\n+        ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+        const auto single_res = AcceptSingleTransaction(tx, single_args);\n+        PackageValidationState package_state_wrapped;\n+        if (single_res.m_result_type != MempoolAcceptResult::ResultType::VALID) {\n+            package_state_wrapped.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+        }\n+        return PackageMempoolAcceptResult(package_state_wrapped, {{tx->GetWitnessHash(), single_res}});\n+    }();\n+    // There are 3 kinds of coins in m_view:",
      "path": "src/validation.cpp",
      "position": 121,
      "original_position": 118,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1304490960,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "added more detail to this comment block",
      "created_at": "2023-08-25T10:41:31Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305500514",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305500514"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1348,
      "original_line": 1348,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305500619",
      "pull_request_review_id": 1595348940,
      "id": 1305500619,
      "node_id": "PRRC_kwDOABII585N0FvL",
      "diff_hunk": "@@ -1326,6 +1325,47 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    const auto result = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_pool.cs) {\n+        if (subpackage.size() > 1) {\n+            return AcceptMultipleTransactions(subpackage, args);\n+        }\n+        const auto& tx = subpackage.front();\n+        ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+        const auto single_res = AcceptSingleTransaction(tx, single_args);\n+        PackageValidationState package_state_wrapped;\n+        if (single_res.m_result_type != MempoolAcceptResult::ResultType::VALID) {\n+            package_state_wrapped.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+        }\n+        return PackageMempoolAcceptResult(package_state_wrapped, {{tx->GetWitnessHash(), single_res}});\n+    }();\n+    // There are 3 kinds of coins in m_view:\n+    // (1) Temporary coins from the transactions in subpackage, constructed by m_viewmempool.\n+    // (2) Mempool coins from transactions in the mempool, constructed by m_viewmempool.\n+    // (3) Chainstate coins fetched from our current UTXO set.\n+    //\n+    // (1) Temporary coins need to be removed. If transactions were submitted to the mempool,\n+    // m_viewmempool will be able to fetch them from there. If they weren't submitted to\n+    // mempool, it is incorrect to keep them - future calls may try to spend those coins that\n+    // don't actually exist.\n+    // (2) Mempool coins also need to be removed. If the mempool contents have changed, coins\n+    // previously fetched from mempool may now be spent or nonexistent. Those coins need to be\n+    // deleted from m_view.\n+    // (3) Chainstate coins don't need to be removed, as the chainstate has not changed (we are\n+    // holding cs_main and no blocks have been processed). They *should not* be removed, as we\n+    // wouldn't want to fetch them again.\n+    for (const auto& outpoint : m_viewmempool.GetNonBaseCoins()) {\n+        // We also need to manually delete these coins from m_view because it has cached copies\n+        // of the coins it fetched from m_viewmempool when they were connected.\n+        m_view.Uncache(outpoint);\n+    }\n+    m_viewmempool.Reset();\n+    return result;",
      "path": "src/validation.cpp",
      "position": 146,
      "original_position": 139,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1303930607,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "thanks, fixed",
      "created_at": "2023-08-25T10:41:38Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305500619",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305500619"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1373,
      "original_line": 1373,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305501594",
      "pull_request_review_id": 1595348940,
      "id": 1305501594,
      "node_id": "PRRC_kwDOABII585N0F-a",
      "diff_hunk": "@@ -1505,32 +1505,28 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         }\n     }\n \n-    // Quit early because package validation won't change the result or the entire package has\n-    // already been submitted.\n-    if (quit_early || txns_package_eval.empty()) {\n-        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n-            Assume(results_final.emplace(wtxid, mempoolaccept_res).second);\n-            Assume(mempoolaccept_res.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n-        }\n-        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results_final));\n-    }\n-    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n-    // own PackageValidationState; package_state_quit_early is unused past this point.\n-    auto submission_result = AcceptSubPackage(txns_package_eval, args);\n-    // Include already-in-mempool transaction results in the final result.\n-    for (const auto& [wtxid, mempoolaccept_res] : results_final) {\n-        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);\n-        Assume(mempoolaccept_res.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n-    }\n-    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n-        // Package validation failed because one or more transactions failed. Provide a result for\n-        // each transaction; if a transaction doesn't have an entry in submission_result,\n-        // include the previous individual failure reason.\n-        submission_result.m_tx_results.insert(individual_results_nonfinal.cbegin(),\n-                                              individual_results_nonfinal.cend());\n-        Assume(submission_result.m_tx_results.size() == package.size());\n-    }\n-    return submission_result;\n+    auto final_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a98da1a9844cdbc1cdeeeed9d4d9b80ea0cb7ee6",
      "in_reply_to_id": 1304701809,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "changed",
      "created_at": "2023-08-25T10:42:56Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305501594",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305501594"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1508,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305501801",
      "pull_request_review_id": 1595348940,
      "id": 1305501801,
      "node_id": "PRRC_kwDOABII585N0GBp",
      "diff_hunk": "@@ -1509,16 +1497,36 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         AcceptSubPackage(txns_package_eval, args);\n     PackageValidationState& package_state_final = final_submission_result.m_state;\n \n+    // Make sure we haven't exceeded max mempool size.\n+    // Package transactions that were submitted to mempool or already in mempool may be evicted.\n+    LimitMempoolSize(m_pool, m_active_chainstate.CoinsTip());\n+\n     for (const auto& tx : package) {\n+        // In case a transaction was in mempool but was evicted in the call to LimitMempoolSize().\n+        TxValidationState mempool_full_state;\n+        mempool_full_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"mempool full\");\n         const auto& wtxid = tx->GetWitnessHash();\n         if (final_submission_result.m_tx_results.count(wtxid) > 0) {\n             // We shouldn't have re-submitted if the tx result was already in results_final.\n             Assume(results_final.count(wtxid) == 0);\n-            results_final.emplace(wtxid, final_submission_result.m_tx_results.at(wtxid));\n+            // If it was submitted, check to see if the tx is still in the mempool. It could have\n+            // been evicted due to LimitMempoolSize() above.\n+            const auto& txresult = final_submission_result.m_tx_results.at(wtxid);\n+            if (txresult.m_result_type == MempoolAcceptResult::ResultType::VALID && !m_pool.exists(GenTxid::Wtxid(wtxid))) {\n+                package_state_final.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                results_final.emplace(wtxid, MempoolAcceptResult::Failure(mempool_full_state));\n+            } else {\n+                results_final.emplace(wtxid, txresult);\n+            }\n         } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {\n-            // Already-in-mempool transaction.\n+            // Already-in-mempool transaction. Check to see if it's still in the mempool. It could\n+            // have been evicted due to LimitMempoolSize() above. Check by txid to include the\n+            // same-txid-different-witness case.\n             Assume(it->second.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n             Assume(individual_results_nonfinal.count(wtxid) == 0);\n+            if (!m_pool.exists(GenTxid::Txid(tx->GetHash()))) {\n+                package_state_final.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");",
      "path": "src/validation.cpp",
      "position": 246,
      "original_position": 92,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "4cd3b8f2edb3176fef4dbc6109188d62e7dd2ba6",
      "in_reply_to_id": 1304756440,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Bad rebase. Fixed",
      "created_at": "2023-08-25T10:43:12Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305501801",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305501801"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1534,
      "original_line": 1534,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305529484",
      "pull_request_review_id": 1595348940,
      "id": 1305529484,
      "node_id": "PRRC_kwDOABII585N0MyM",
      "diff_hunk": "@@ -1505,32 +1505,28 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         }\n     }\n \n-    // Quit early because package validation won't change the result or the entire package has\n-    // already been submitted.\n-    if (quit_early || txns_package_eval.empty()) {\n-        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n-            Assume(results_final.emplace(wtxid, mempoolaccept_res).second);\n-            Assume(mempoolaccept_res.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n-        }\n-        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results_final));\n-    }\n-    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n-    // own PackageValidationState; package_state_quit_early is unused past this point.\n-    auto submission_result = AcceptSubPackage(txns_package_eval, args);\n-    // Include already-in-mempool transaction results in the final result.\n-    for (const auto& [wtxid, mempoolaccept_res] : results_final) {\n-        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);\n-        Assume(mempoolaccept_res.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n-    }\n-    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n-        // Package validation failed because one or more transactions failed. Provide a result for\n-        // each transaction; if a transaction doesn't have an entry in submission_result,\n-        // include the previous individual failure reason.\n-        submission_result.m_tx_results.insert(individual_results_nonfinal.cbegin(),\n-                                              individual_results_nonfinal.cend());\n-        Assume(submission_result.m_tx_results.size() == package.size());\n-    }\n-    return submission_result;\n+    auto final_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :\n+        AcceptSubPackage(txns_package_eval, args);\n+    PackageValidationState& package_state_final = final_submission_result.m_state;\n+\n+    for (const auto& tx : package) {\n+        const auto& wtxid = tx->GetWitnessHash();\n+        if (final_submission_result.m_tx_results.count(wtxid) > 0) {\n+            // We shouldn't have re-submitted if the tx result was already in results_final.\n+            Assume(results_final.count(wtxid) == 0);\n+            results_final.emplace(wtxid, final_submission_result.m_tx_results.at(wtxid));\n+        } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {\n+            // Already-in-mempool transaction.\n+            Assume(it->second.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n+            Assume(individual_results_nonfinal.count(wtxid) == 0);\n+        } else if (const auto it{individual_results_nonfinal.find(wtxid)}; it != individual_results_nonfinal.end()) {",
      "path": "src/validation.cpp",
      "position": 253,
      "original_position": 44,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a98da1a9844cdbc1cdeeeed9d4d9b80ea0cb7ee6",
      "in_reply_to_id": 1304712148,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I've changed the comment above `results_final` and `individual_results_nonfinal` to be accurate to this PR and to #26711.\r\n\r\nThis is most relevant when we otherwise don't have a result for this tx. From P2P it will be helpful for rejection caching and `MaybePunish` to know whenever there was a problem with any transaction.\r\nIn this case where we override the result with \"mempool full\", it's the same result anyway (`TX_MEMPOOL_POLICY`).",
      "created_at": "2023-08-25T11:16:52Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305529484",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305529484"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1541,
      "original_line": 1541,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305531847",
      "pull_request_review_id": 1595348940,
      "id": 1305531847,
      "node_id": "PRRC_kwDOABII585N0NXH",
      "diff_hunk": "@@ -86,13 +86,172 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        package_hex = []\n+        # UTXOs to be spent by the ultimate child transaction\n+        parent_utxos = []\n+\n+        evicted_weight = 8000\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        mempool_evicted_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            fee=(mempoolmin_feerate / 1000) * (evicted_weight // 4) + Decimal('0.000001'),\n+            target_weight=evicted_weight,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert mempool_evicted_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contains the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=mempool_evicted_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+        package_hex.append(cpfp_parent[\"hex\"])\n+        parent_utxos.append(cpfp_parent[\"new_utxo\"])\n+        assert_equal(node.testmempoolaccept([cpfp_parent[\"hex\"]])[0][\"reject-reason\"], \"mempool min fee not met\")\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Series of parents that don't need CPFP and are submitted individually. Each one is large and\n+        # high feerate, which means they should trigger eviction but not be evicted.\n+        parent_weight = 100000\n+        num_big_parents = 3\n+        assert_greater_than(parent_weight * num_big_parents, current_info[\"maxmempool\"] - current_info[\"bytes\"])\n+        parent_fee = (100 * mempoolmin_feerate / 1000) * (parent_weight // 4)\n+\n+        big_parent_txids = []\n+        for i in range(num_big_parents):\n+            parent = self.wallet.create_self_transfer(fee=parent_fee, target_weight=parent_weight, confirmed_only=True)\n+            parent_utxos.append(parent[\"new_utxo\"])\n+            package_hex.append(parent[\"hex\"])\n+            big_parent_txids.append(parent[\"txid\"])\n+            # There is room for each of these transactions independently\n+            assert node.testmempoolaccept([parent[\"hex\"]])[0][\"allowed\"]\n+\n+        # Create a child spending everything, bumping cpfp_parent just above mempool minimum\n+        # feerate. It's important not to bump too much as otherwise mempool_evicted_tx would not be\n+        # evicted, making this test much less meaningful.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        # Specific number of satoshis to fit within a small window. The parent_cpfp + child package needs to be\n+        # - When there is mid-package eviction, high enough feerate to meet the new mempoolminfee\n+        # - When there is no mid-package eviction, low enough feerate to be evicted immediately after submission.\n+        magic_satoshis = 1200\n+        cpfp_satoshis = int(cpfp_fee * COIN) + magic_satoshis\n+\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=cpfp_satoshis)\n+        package_hex.append(child[\"hex\"])\n+\n+        # Package should be submitted, temporarily exceeding maxmempool, and then evicted.\n+        with node.assert_debug_log(expected_msgs=[\"rolling minimum fee bumped\"]):\n+            assert_raises_rpc_error(-26, \"mempool full\", node.submitpackage, package_hex)\n+\n+        # Maximum size must never be exceeded.\n+        assert_greater_than(node.getmempoolinfo()[\"maxmempool\"], node.getmempoolinfo()[\"bytes\"])\n+\n+        # Evicted transaction and its descendants must not be in mempool.\n+        resulting_mempool_txids = node.getrawmempool()\n+        assert mempool_evicted_tx[\"txid\"] not in resulting_mempool_txids\n+        assert cpfp_parent[\"txid\"] not in resulting_mempool_txids\n+        assert child[\"txid\"] not in resulting_mempool_txids\n+        for txid in big_parent_txids:\n+            assert txid in resulting_mempool_txids\n+\n+    def test_mid_package_replacement(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where an early tx depends on a later-replaced mempool tx\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()\n+        current_info = node.getmempoolinfo()\n+        mempoolmin_feerate = current_info[\"mempoolminfee\"]\n+        assert_greater_than(mempoolmin_feerate, get_first_eviction_score(node))\n+\n+        # Mempool transaction which is evicted due to being at the \"bottom\" of the mempool when the\n+        # mempool overflows and evicts by descendant score. It's important that the eviction doesn't\n+        # happen in the middle of package evaluation, as it can invalidate the coins cache.\n+        double_spent_utxo = self.wallet.get_utxo(confirmed_only=True)\n+        replaced_tx = self.wallet.send_self_transfer(\n+            from_node=node,\n+            utxo_to_spend=double_spent_utxo,\n+            fee_rate=mempoolmin_feerate,\n+            confirmed_only=True\n+        )\n+        # Already in mempool when package is submitted.\n+        assert replaced_tx[\"txid\"] in node.getrawmempool()\n+\n+        # This parent spends the above mempool transaction that exists when its inputs are first\n+        # looked up, but disappears later. It is rejected for being too low fee (but eligible for\n+        # reconsideration), and its inputs are cached. When the mempool transaction is evicted, its\n+        # coin is no longer available, but the cache could still contain the tx.\n+        cpfp_parent = self.wallet.create_self_transfer(\n+            utxo_to_spend=replaced_tx[\"new_utxo\"],\n+            fee_rate=mempoolmin_feerate - Decimal('0.00001'),\n+            confirmed_only=True)\n+\n+        self.wallet.rescan_utxos()\n+\n+        # Parent that replaces the parent of cpfp_parent.\n+        replacement_tx = self.wallet.create_self_transfer(\n+            utxo_to_spend=double_spent_utxo,\n+            fee_rate=10*mempoolmin_feerate,\n+            confirmed_only=True\n+        )\n+        parent_utxos = [cpfp_parent[\"new_utxo\"], replacement_tx[\"new_utxo\"]]\n+\n+        # Create a child spending everything, CPFPing the low-feerate parent.\n+        approx_child_vsize = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos)[\"tx\"].get_vsize()\n+        cpfp_fee = (2 * mempoolmin_feerate / 1000) * (cpfp_parent[\"tx\"].get_vsize() + approx_child_vsize) - cpfp_parent[\"fee\"]\n+        child = self.wallet.create_self_transfer_multi(utxos_to_spend=parent_utxos, fee_per_output=int(cpfp_fee * COIN))\n+        package_hex = [cpfp_parent[\"hex\"], replacement_tx[\"hex\"], child[\"hex\"]]",
      "path": "test/functional/mempool_limit.py",
      "position": 205,
      "original_position": 146,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a5a029c7799cb1f972e3fddc896bf009068cd8db",
      "in_reply_to_id": 1303286812,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Added a note",
      "created_at": "2023-08-25T11:19:36Z",
      "updated_at": "2023-08-25T12:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305531847",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305531847"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 223,
      "original_line": 223,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305631043",
      "pull_request_review_id": 1595687741,
      "id": 1305631043,
      "node_id": "PRRC_kwDOABII585N0llD",
      "diff_hunk": "@@ -516,7 +516,7 @@ class MemPoolAccept\n                             /* m_coins_to_uncache */ package_args.m_coins_to_uncache,",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 1,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "4cd3b8f2edb3176fef4dbc6109188d62e7dd2ba6",
      "in_reply_to_id": 1304736690,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "removed",
      "created_at": "2023-08-25T13:01:14Z",
      "updated_at": "2023-08-25T13:01:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305631043",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305631043"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 516,
      "original_line": 516,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305631297",
      "pull_request_review_id": 1595688112,
      "id": 1305631297,
      "node_id": "PRRC_kwDOABII585N0lpB",
      "diff_hunk": "@@ -84,13 +85,105 @@ def fill_mempool(self):\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction\")",
      "path": "test/functional/mempool_limit.py",
      "position": null,
      "original_position": 20,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "3729ee483688da8427c9228de01407777d4e4691",
      "in_reply_to_id": 1301978861,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "added",
      "created_at": "2023-08-25T13:01:28Z",
      "updated_at": "2023-08-25T13:01:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305631297",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305631297"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 91,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305838343",
      "pull_request_review_id": 1596008248,
      "id": 1305838343,
      "node_id": "PRRC_kwDOABII585N1YMH",
      "diff_hunk": "@@ -839,15 +839,27 @@ class CCoinsViewMemPool : public CCoinsViewBacked\n     * validation, since we can access transaction outputs without submitting them to mempool.\n     */\n     std::unordered_map<COutPoint, Coin, SaltedOutpointHasher> m_temp_added;\n+\n+    /**\n+     * Set of all coins that have been fetched from mempool or created using PackageAddTransaction\n+     * (not base). Used to internally track the origin of a coin.\n+     */\n+    mutable std::unordered_set<COutPoint, SaltedOutpointHasher> m_non_base_coins;\n protected:\n     const CTxMemPool& mempool;\n \n public:\n     CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn);\n+    /** GetCoin, returning whether it exists and is not spent. Also updates m_non_base_coins if the\n+     * coin is not fetched from base. */\n     bool GetCoin(const COutPoint &outpoint, Coin &coin) const override;\n     /** Add the coins created by this transaction. These coins are only temporarily stored in\n      * m_temp_added and cannot be flushed to the back end. Only used for package validation. */\n     void PackageAddTransaction(const CTransactionRef& tx);\n+    /** Get all coins in m_non_base_coins and m_temp_added. */",
      "path": "src/txmempool.h",
      "position": 21,
      "original_position": 21,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c3b552925d2e5b15ea02e5079d3b82db03d007c9",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `m_temp_added` isn't involved",
      "created_at": "2023-08-25T15:55:30Z",
      "updated_at": "2023-08-25T16:04:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305838343",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305838343"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 859,
      "original_line": 859,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305844817",
      "pull_request_review_id": 1596008248,
      "id": 1305844817,
      "node_id": "PRRC_kwDOABII585N1ZxR",
      "diff_hunk": "@@ -1505,32 +1505,28 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         }\n     }\n \n-    // Quit early because package validation won't change the result or the entire package has\n-    // already been submitted.\n-    if (quit_early || txns_package_eval.empty()) {\n-        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n-            Assume(results_final.emplace(wtxid, mempoolaccept_res).second);\n-            Assume(mempoolaccept_res.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n-        }\n-        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results_final));\n-    }\n-    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n-    // own PackageValidationState; package_state_quit_early is unused past this point.\n-    auto submission_result = AcceptSubPackage(txns_package_eval, args);\n-    // Include already-in-mempool transaction results in the final result.\n-    for (const auto& [wtxid, mempoolaccept_res] : results_final) {\n-        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);\n-        Assume(mempoolaccept_res.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n-    }\n-    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n-        // Package validation failed because one or more transactions failed. Provide a result for\n-        // each transaction; if a transaction doesn't have an entry in submission_result,\n-        // include the previous individual failure reason.\n-        submission_result.m_tx_results.insert(individual_results_nonfinal.cbegin(),\n-                                              individual_results_nonfinal.cend());\n-        Assume(submission_result.m_tx_results.size() == package.size());\n-    }\n-    return submission_result;\n+    auto final_submission_result = quit_early || txns_package_eval.empty() ? PackageMempoolAcceptResult(package_state_quit_early, {}) :\n+        AcceptSubPackage(txns_package_eval, args);\n+    PackageValidationState& package_state_final = final_submission_result.m_state;\n+\n+    for (const auto& tx : package) {\n+        const auto& wtxid = tx->GetWitnessHash();\n+        if (final_submission_result.m_tx_results.count(wtxid) > 0) {\n+            // We shouldn't have re-submitted if the tx result was already in results_final.\n+            Assume(results_final.count(wtxid) == 0);\n+            results_final.emplace(wtxid, final_submission_result.m_tx_results.at(wtxid));\n+        } else if (const auto it{results_final.find(wtxid)}; it != results_final.end()) {\n+            // Already-in-mempool transaction.\n+            Assume(it->second.m_result_type != MempoolAcceptResult::ResultType::INVALID);\n+            Assume(individual_results_nonfinal.count(wtxid) == 0);\n+        } else if (const auto it{individual_results_nonfinal.find(wtxid)}; it != individual_results_nonfinal.end()) {",
      "path": "src/validation.cpp",
      "position": 253,
      "original_position": 44,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "a98da1a9844cdbc1cdeeeed9d4d9b80ea0cb7ee6",
      "in_reply_to_id": 1304712148,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "clearer the way it is now, thanks!",
      "created_at": "2023-08-25T16:00:43Z",
      "updated_at": "2023-08-25T16:04:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1305844817",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1305844817"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1541,
      "original_line": 1541,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309559476",
      "pull_request_review_id": 1601777001,
      "id": 1309559476,
      "node_id": "PRRC_kwDOABII585ODkq0",
      "diff_hunk": "@@ -1326,6 +1325,23 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n     return PackageMempoolAcceptResult(package_state, std::move(results));\n }\n \n+PackageMempoolAcceptResult MemPoolAccept::AcceptSubPackage(const std::vector<CTransactionRef>& subpackage, ATMPArgs& args)\n+{\n+    ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    AssertLockHeld(::cs_main);\n+    AssertLockHeld(m_pool.cs);\n+    if (subpackage.size() > 1) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 101,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "c2c9dfe95b3c5b8332521d9a691725ee55ec3450",
      "in_reply_to_id": 1290866687,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think there is confusion, my comment is about the test coverage of the exact code path in the first half of `AcceptSubPackage` not of the second usage of `AccetSubPackage()`.\r\n\r\nFrom a quick look on the tests at c2c9dfe9, it was uncertain.",
      "created_at": "2023-08-30T02:44:53Z",
      "updated_at": "2023-08-30T02:44:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1309559476",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309559476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1333,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309581518",
      "pull_request_review_id": 1601796934,
      "id": 1309581518,
      "node_id": "PRRC_kwDOABII585ODqDO",
      "diff_hunk": "@@ -34,51 +34,224 @@ def set_test_params(self):\n         ]]\n         self.supports_cli = False\n \n-    def run_test(self):\n+    def fill_mempool(self):\n+        \"\"\"Fill mempool until eviction.\"\"\"\n+        self.log.info(\"Fill the mempool until eviction is triggered and the mempoolminfee rises\")\n         txouts = gen_return_txouts()\n         node = self.nodes[0]\n-        miniwallet = MiniWallet(node)\n+        miniwallet = self.wallet\n         relayfee = node.getnetworkinfo()['relayfee']\n \n-        self.log.info('Check that mempoolminfee is minrelaytxfee')\n-        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n-        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n-\n         tx_batch_size = 1\n         num_of_batches = 75\n         # Generate UTXOs to flood the mempool\n         # 1 to create a tx initially that will be evicted from the mempool later\n-        # 3 batches of multiple transactions with a fee rate much higher than the previous UTXO\n+        # 75 transactions each with a fee rate higher than the previous one\n         # And 1 more to verify that this tx does not get added to the mempool with a fee rate less than the mempoolminfee\n         # And 2 more for the package cpfp test\n-        self.generate(miniwallet, 1 + (num_of_batches * tx_batch_size) + 1 + 2)\n+        self.generate(miniwallet, 1 + (num_of_batches * tx_batch_size))\n \n         # Mine 99 blocks so that the UTXOs are allowed to be spent\n         self.generate(node, COINBASE_MATURITY - 1)\n \n-        self.log.info('Create a mempool tx that will be evicted')\n+        self.log.debug(\"Create a mempool tx that will be evicted\")\n         tx_to_be_evicted_id = miniwallet.send_self_transfer(from_node=node, fee_rate=relayfee)[\"txid\"]\n \n         # Increase the tx fee rate to give the subsequent transactions a higher priority in the mempool\n         # The tx has an approx. vsize of 65k, i.e. multiplying the previous fee rate (in sats/kvB)\n         # by 130 should result in a fee that corresponds to 2x of that fee rate\n         base_fee = relayfee * 130\n \n-        self.log.info(\"Fill up the mempool with txs with higher fee rate\")\n-        for batch_of_txid in range(num_of_batches):\n-            fee = (batch_of_txid + 1) * base_fee\n-            create_lots_of_big_transactions(miniwallet, node, fee, tx_batch_size, txouts)\n+        self.log.debug(\"Fill up the mempool with txs with higher fee rate\")\n+        with node.assert_debug_log([\"rolling minimum fee bumped\"]):\n+            for batch_of_txid in range(num_of_batches):\n+                fee = (batch_of_txid + 1) * base_fee\n+                create_lots_of_big_transactions(miniwallet, node, fee, tx_batch_size, txouts)\n \n-        self.log.info('The tx should be evicted by now')\n+        self.log.debug(\"The tx should be evicted by now\")\n         # The number of transactions created should be greater than the ones present in the mempool\n         assert_greater_than(tx_batch_size * num_of_batches, len(node.getrawmempool()))\n         # Initial tx created should not be present in the mempool anymore as it had a lower fee rate\n         assert tx_to_be_evicted_id not in node.getrawmempool()\n \n-        self.log.info('Check that mempoolminfee is larger than minrelaytxfee')\n+        self.log.debug(\"Check that mempoolminfee is larger than minrelaytxfee\")\n         assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n         assert_greater_than(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n \n+    def test_mid_package_eviction(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Check a package where each parent passes the current mempoolminfee but would cause eviction before package submission terminates\")\n+\n+        self.restart_node(0, extra_args=self.extra_args[0])\n+\n+        # Restarting the node resets mempool minimum feerate\n+        assert_equal(node.getmempoolinfo()['minrelaytxfee'], Decimal('0.00001000'))\n+        assert_equal(node.getmempoolinfo()['mempoolminfee'], Decimal('0.00001000'))\n+\n+        self.fill_mempool()",
      "path": "test/functional/mempool_limit.py",
      "position": 73,
      "original_position": 73,
      "commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "original_commit_id": "22fe13e3526b582170c05f823395dba0a3c9c99a",
      "in_reply_to_id": null,
      "user": {
        "login": "ariard",
        "id": 23310655,
        "node_id": "MDQ6VXNlcjIzMzEwNjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ariard",
        "html_url": "https://github.com/ariard",
        "followers_url": "https://api.github.com/users/ariard/followers",
        "following_url": "https://api.github.com/users/ariard/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ariard/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ariard/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
        "organizations_url": "https://api.github.com/users/ariard/orgs",
        "repos_url": "https://api.github.com/users/ariard/repos",
        "events_url": "https://api.github.com/users/ariard/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ariard/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "As I understand one of the condition to hit the case is a full mempool and when we call `LimitMempool()`, one interesting variation of the test case could be to limit the mempool size to the _subpackage_ only. It might be a tricky one, though boundary conditions are always nice to exercise.",
      "created_at": "2023-08-30T03:19:45Z",
      "updated_at": "2023-08-30T03:23:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28251#discussion_r1309581518",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1309581518"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28251"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 91,
      "original_line": 91,
      "side": "RIGHT"
    }
  ]
}