{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668",
    "id": 1776120732,
    "node_id": "PR_kwDOABII585p3XOc",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/29668",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/29668.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/29668.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/8789dc8f315a9d9ad7142d831bc9412f780248e7",
    "number": 29668,
    "state": "closed",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "prune, rpc: Check undo data when finding pruneheight",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The function `GetFirstStoredBlock()` helps us find the first block for which we have data. So far this function only looked for a block with `BLOCK_HAVE_DATA`. However, this doesn't mean that we also have the undo data of that block, and undo data might be required for what a user would like to do with those blocks. One example of how this might happen is if some blocks were fetched using the `getblockfrompeer` RPC. Blocks fetched from a peer will have data but no undo data.\r\n\r\nThe first commit here allows `GetFirstStoredBlock()` to check for undo data as well by passing a parameter. This alone is useful for #29553 and I would use it there.\r\n\r\nIn the second commit I am applying the undo check to the RPCs that report `pruneheight` to the user. I find this much more intuitive because I think the user expects to be able to do all operations on blocks up until the `pruneheight` but that is not the case if undo data is missing. I personally ran into this once before and now again when testing for assumeutxo when I had used `getblockfrompeer`. The following commit adds test coverage for this change of behavior.\r\n\r\nThe last commit adds a note in the docs of `getblockfrompeer` that undo data will not be available.\r\n",
    "labels": [],
    "created_at": "2024-03-17T16:42:40Z",
    "updated_at": "2024-07-12T16:02:34Z",
    "closed_at": "2024-07-10T19:27:21Z",
    "mergeable_state": "unknown",
    "merged_at": "2024-07-10T19:27:20Z",
    "merge_commit_sha": "f4849f692270f341f353806c44f2c1849879a6bf",
    "assignees": [],
    "requested_reviewers": [
      {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false
      }
    ],
    "requested_teams": [],
    "head": {
      "label": "fjahr:2024-03-first-stored-undo",
      "ref": "2024-03-first-stored-undo",
      "sha": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 196253948,
        "node_id": "MDEwOlJlcG9zaXRvcnkxOTYyNTM5NDg=",
        "name": "bitcoin",
        "full_name": "fjahr/bitcoin",
        "owner": {
          "login": "fjahr",
          "id": 1322187,
          "node_id": "MDQ6VXNlcjEzMjIxODc=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/fjahr",
          "html_url": "https://github.com/fjahr",
          "followers_url": "https://api.github.com/users/fjahr/followers",
          "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
          "organizations_url": "https://api.github.com/users/fjahr/orgs",
          "repos_url": "https://api.github.com/users/fjahr/repos",
          "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/fjahr/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/fjahr/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/fjahr/bitcoin",
        "archive_url": "https://api.github.com/repos/fjahr/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/fjahr/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/fjahr/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/fjahr/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/fjahr/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/fjahr/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/fjahr/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/fjahr/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/fjahr/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/fjahr/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/fjahr/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/fjahr/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/fjahr/bitcoin/events",
        "forks_url": "https://api.github.com/repos/fjahr/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/fjahr/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/fjahr/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/fjahr/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/fjahr/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/fjahr/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/fjahr/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/fjahr/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/fjahr/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/fjahr/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/fjahr/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/fjahr/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/fjahr/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/fjahr/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/fjahr/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/fjahr/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:fjahr/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/fjahr/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/fjahr/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/fjahr/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/fjahr/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/fjahr/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/fjahr/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/fjahr/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/fjahr/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/fjahr/bitcoin/hooks",
        "svn_url": "https://github.com/fjahr/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 249437,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-07-12T16:01:33Z",
        "created_at": "2019-07-10T18:11:06Z",
        "updated_at": "2024-04-27T19:57:43Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "538363738e9e30813cf3e76ca4f71c1aaff349e7",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35632,
        "stargazers_count": 77172,
        "watchers_count": 77172,
        "size": 263003,
        "default_branch": "master",
        "open_issues_count": 684,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-07-12T16:41:08Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-07-12T16:59:25Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 120,
    "deletions": 14,
    "changed_files": 7,
    "commits": 3,
    "review_comments": 63,
    "comments": 11
  },
  "events": [
    {
      "event": "commented",
      "id": 2002534384,
      "node_id": "IC_kwDOABII5853XD_w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2002534384",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-17T16:42:43Z",
      "updated_at": "2024-07-10T19:18:07Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29668).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2135821455), [stickies-v](https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2135982014), [achow101](https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2221253695) |\n| Stale ACK | [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1949117498) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29770](https://github.com/bitcoin/bitcoin/pull/29770) (index: Check all necessary block data is available before starting to sync by fjahr)\n* [#29656](https://github.com/bitcoin/bitcoin/pull/29656) (chainparams: Change nChainTx type to uint64_t by fjahr)\n* [#19463](https://github.com/bitcoin/bitcoin/pull/19463) (Prune locks by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2002534384",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "renamed",
      "id": 12143426386,
      "node_id": "RTE_lADOABII586ClE1ezwAAAALTzftS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12143426386",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-17T16:43:04Z",
      "rename": {
        "from": "prune, rpc: Check undo data when finding for pruneheight",
        "to": "prune, rpc: Check undo data when finding pruneheight"
      }
    },
    {
      "event": "labeled",
      "id": 12143569624,
      "node_id": "LE_lADOABII586ClE1ezwAAAALT0CrY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12143569624",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-17T17:52:58Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12143935060,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALT1b5U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12143935060",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-17T20:13:55Z"
    },
    {
      "event": "unlabeled",
      "id": 12144099099,
      "node_id": "UNLE_lADOABII586ClE1ezwAAAALT2D8b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12144099099",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-17T21:36:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1949117498,
      "node_id": "PRR_kwDOABII5850LSw6",
      "url": null,
      "actor": null,
      "commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "ACK 296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1949117498",
      "submitted_at": "2024-03-20T14:47:27Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "reviewed",
      "id": 1958325955,
      "node_id": "PRR_kwDOABII5850ua7D",
      "url": null,
      "actor": null,
      "commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nI think this approach works well, but I think I'd prefer passing a mask instead of a bool, which prevents combinatorial explosion of params if we want to add more filtering options in the future. I personally find that a bit easier to quickly understand too. What do you think about something like this (didn't add static asserts and doc updates etc yet):\r\n\r\n<details>\r\n<summary>git diff on 296243c315</summary>\r\n\r\n```diff\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex 74a233f43b..eaefa602d3 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -595,16 +595,12 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\r\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\r\n }\r\n \r\n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\r\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, uint32_t status_mask)\r\n {\r\n     AssertLockHeld(::cs_main);\r\n-    uint32_t check_status{BLOCK_HAVE_DATA};\r\n-    if (check_undo) {\r\n-        check_status |= BLOCK_HAVE_UNDO;\r\n-    }\r\n     const CBlockIndex* last_block = &upper_block;\r\n-    assert((last_block->nStatus & check_status) == check_status); // 'upper_block' must have data\r\n-    while (last_block->pprev && ((last_block->pprev->nStatus & check_status) == check_status)) {\r\n+    assert((last_block->nStatus & status_mask) == status_mask); // 'upper_block' must have data\r\n+    while (last_block->pprev && ((last_block->pprev->nStatus & status_mask) == status_mask)) {\r\n         if (lower_block) {\r\n             // Return if we reached the lower_block\r\n             if (last_block == lower_block) return lower_block;\r\n@@ -617,7 +613,7 @@ const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_bl\r\n     assert(last_block != nullptr);\r\n     // In the special case that all blocks up to the Genesis block are not\r\n     // pruned, we return the Genesis block instead of block 1, even though\r\n-    // it can not have any undo data, since it is properly handled as an\r\n+    // it may be missing (e.g. undo) data, since it is properly handled as an\r\n     // exception everywhere.\r\n     if (last_block->nHeight == 1) {\r\n         return last_block->pprev;\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 33d78259e6..766a170946 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -338,7 +338,7 @@ public:\r\n     //! Find the first stored ancestor of start_block immediately after the last\r\n     //! pruned ancestor. Return value will never be null. Caller is responsible\r\n     //! for ensuring that start_block has data.\r\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     /** True if any block files have ever been pruned. */\r\n     bool m_have_pruned = false;\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 3cd9421343..88ed7ed964 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -836,7 +836,8 @@ static RPCHelpMan pruneblockchain()\r\n \r\n     PruneBlockFilesManual(active_chainstate, height);\r\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\r\n-    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, true)->nHeight - 1 : block.nHeight;\r\n+    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\r\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, has_undo)->nHeight - 1 : block.nHeight;\r\n },\r\n     };\r\n }\r\n@@ -1290,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\r\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\r\n     if (chainman.m_blockman.IsPruneMode()) {\r\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_MASK;\r\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip, nullptr, true)->nHeight : tip.nHeight + 1);\r\n+        const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\r\n+        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip, nullptr, has_undo)->nHeight : tip.nHeight + 1);\r\n \r\n         const bool automatic_pruning{chainman.m_blockman.GetPruneTarget() != BlockManager::PRUNE_TARGET_MANUAL};\r\n         obj.pushKV(\"automatic_pruning\",  automatic_pruning);\r\n\r\n```\r\n</details>\r\n\r\n\r\nCode LGTM 296243c3153e996d1626b8eabc8f8bce845ce3ad, and I verified that the (updated) `feature_pruning.py` test fails on master as expected. I'm happy to proceed with your approach too if you don't like mine.",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1958325955",
      "submitted_at": "2024-03-25T20:12:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12269015551,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALbSlH_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12269015551",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-27T17:01:55Z"
    },
    {
      "event": "commented",
      "id": 2023324076,
      "node_id": "IC_kwDOABII5854mXms",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2023324076",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-27T17:03:26Z",
      "updated_at": "2024-03-27T17:03:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "@stickies-v thanks for the feedback! I don't have strong feelings between the approaches but I agree yours is more flexible and maybe a bit more expressive, so I applied that. I also addressed the rest of the feedback and added some more detail to the docs.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2023324076",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 12269036208,
      "node_id": "MEE_lADOABII586ClE1ezwAAAALbSqKw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12269036208",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-27T17:03:28Z"
    },
    {
      "event": "subscribed",
      "id": 12269036221,
      "node_id": "SE_lADOABII586ClE1ezwAAAALbSqK9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12269036221",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-27T17:03:28Z"
    },
    {
      "event": "labeled",
      "id": 12274966434,
      "node_id": "LE_lADOABII586ClE1ezwAAAALbpR-i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12274966434",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-28T01:49:58Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2024255644,
      "node_id": "IC_kwDOABII5854p7Cc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2024255644",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-28T01:49:59Z",
      "updated_at": "2024-03-28T01:49:59Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\nðŸš§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/23163769501</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2024255644",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12281954148,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALcD79k",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12281954148",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-28T13:50:59Z"
    },
    {
      "event": "reviewed",
      "id": 1966493859,
      "node_id": "PRR_kwDOABII5851NlCj",
      "url": null,
      "actor": null,
      "commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "q: doesn't this mean that if we generate a chain, prune half of it, then fetch the pruned blocks through `getblockfrompeer`, any fresh indexes sync will throw a different init error after this changes? (`StartIndexBackgroundSync()` should fail at `CheckBlockDataAvailability()` now).\r\n\r\nIf this is correct, it would be nice to introduce a test presenting the behavior change.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1966493859",
      "submitted_at": "2024-03-28T15:08:45Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "unlabeled",
      "id": 12283777777,
      "node_id": "UNLE_lADOABII586ClE1ezwAAAALcK5Lx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12283777777",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-28T15:49:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2028489071,
      "node_id": "IC_kwDOABII58546Elv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2028489071",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-03-30T22:57:10Z",
      "updated_at": "2024-03-30T22:57:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "> q: doesn't this mean that if we generate a chain, prune half of it, then fetch the pruned blocks through `getblockfrompeer`, any fresh indexes sync will throw a different init error after this changes? (`StartIndexBackgroundSync()` should fail at `CheckBlockDataAvailability()` now).\r\n> \r\n> If this is correct, it would be nice to introduce a test presenting the behavior change.\r\n\r\nGood question but no, `CheckBlockDataAvailability()` does not change the default mask (`HAVE_DATA`), so it shouldn't change behavior there for now. But your question made me realize that we should check for undo data for some indices because they need it. I have implemented that in a follow-up here: #29770 and I also implemented the test there that shows the behavior change you had in mind I think.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2028489071",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "reviewed",
      "id": 1970253804,
      "node_id": "PRR_kwDOABII5851b6_s",
      "url": null,
      "actor": null,
      "commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for incorporating the mask suggestion. Had a deeper look at the code, I think this logic maybe warrants a bit more cleaning up, because with the status_mask, using `GetFirstStoredBlock` is not very intuitive anymore and potentially a bit footgunny.\r\n- `GetFirstStoredBlock`: rename to `GetFirstBlock` since the `Stored` bit depends on the `status_mask` now. Consequently, make `status_mask` required to avoid footguns.\r\n- let callsites handle genesis block exceptions, because it depends on the status_mask. As a bonus, everything is a bit more explicit?\r\n- some other tidying up, e.g. make parameter naming consistent between header and implementation, improve documentation\r\n\r\nWdyt about this further iteration? I understand it's quite a bit of overhaul compared to your first proposal for what should be a relatively simple change. I'm just hesitant about introducing new boolean parameters when we can avoid it, and I think it's worth improving overall code robustness?\r\n\r\n<details>\r\n<summary>git diff on 23ac56177d</summary>\r\n\r\n```diff\r\ndiff --git a/src/init.cpp b/src/init.cpp\r\nindex 1a4fce4678..a8a5ff0dfd 100644\r\n--- a/src/init.cpp\r\n+++ b/src/init.cpp\r\n@@ -2032,7 +2032,7 @@ bool StartIndexBackgroundSync(NodeContext& node)\r\n     if (indexes_start_block) {\r\n         LOCK(::cs_main);\r\n         const CBlockIndex* start_block = *indexes_start_block;\r\n-        if (!start_block) start_block = chainman.ActiveChain().Genesis();\r\n+        if (!start_block) start_block = chainman.ActiveChain()[1];\r\n         if (!chainman.m_blockman.CheckBlockDataAvailability(*index_chain.Tip(), *Assert(start_block))) {\r\n             return InitError(strprintf(Untranslated(\"%s best block of the index goes beyond pruned data. Please disable the index or reindex (which will download the whole blockchain again)\"), older_index_name));\r\n         }\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex eaefa602d3..8556504453 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -595,11 +595,12 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\r\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\r\n }\r\n \r\n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, uint32_t status_mask)\r\n+const CBlockIndex* BlockManager::GetFirstBlock(const CBlockIndex& upper_block, uint32_t status_mask,\r\n+                                               const CBlockIndex* lower_block)\r\n {\r\n     AssertLockHeld(::cs_main);\r\n     const CBlockIndex* last_block = &upper_block;\r\n-    assert((last_block->nStatus & status_mask) == status_mask); // 'upper_block' must have data\r\n+    assert((last_block->nStatus & status_mask) == status_mask); // 'upper_block' must satisfy the status mask\r\n     while (last_block->pprev && ((last_block->pprev->nStatus & status_mask) == status_mask)) {\r\n         if (lower_block) {\r\n             // Return if we reached the lower_block\r\n@@ -610,21 +611,13 @@ const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_bl\r\n         }\r\n         last_block = last_block->pprev;\r\n     }\r\n-    assert(last_block != nullptr);\r\n-    // In the special case that all blocks up to the Genesis block are not\r\n-    // pruned, we return the Genesis block instead of block 1, even though\r\n-    // it may be missing (e.g. undo) data, since it is properly handled as an\r\n-    // exception everywhere.\r\n-    if (last_block->nHeight == 1) {\r\n-        return last_block->pprev;\r\n-    }\r\n-    return last_block;\r\n+    return Assert(last_block);\r\n }\r\n \r\n bool BlockManager::CheckBlockDataAvailability(const CBlockIndex& upper_block, const CBlockIndex& lower_block)\r\n {\r\n     if (!(upper_block.nStatus & BLOCK_HAVE_DATA)) return false;\r\n-    return GetFirstStoredBlock(upper_block, &lower_block) == &lower_block;\r\n+    return GetFirstBlock(upper_block, BLOCK_HAVE_DATA, &lower_block) == &lower_block;\r\n }\r\n \r\n // If we're using -prune with -reindex, then delete block files that will be ignored by the\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 8f83b68558..8f309c31b6 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -335,13 +335,29 @@ public:\r\n     //! (part of the same chain).\r\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n-    //! Find the first stored ancestor of start_block immediately after the last\r\n-    //! ancestor that does not match the status mask. Return value will never be\r\n-    //! null. Caller is responsible for ensuring that start_block has the status\r\n-    //! mask data. If the whole chain matched the status mask the genesis block\r\n-    //! will be returned regardless of it's status match because, for example,\r\n-    //! it can not have undo data by nature.\r\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    /**\r\n+     * @brief Finds the furthest away ancestor of `upper_block` of which the nStatus matches the `status_mask`\r\n+     * \r\n+     * Starts from `upper_block` and iterates backwards through its ancestors for as long as the block's\r\n+     * nStatus keeps matching the `status_mask` mask, or until it encounters `lower_block`.\r\n+     *\r\n+     * @pre `upper_block` must match the `status_mask`.\r\n+     * \r\n+     * @param upper_block The block from which to start the search, must meet the `status_mask` criteria.\r\n+     * @param status_mask A bitmask representing the conditions to check against each block's nStatus.\r\n+     * @param lower_block An optional pointer to the `CBlockIndex` that serves as the lower boundary of\r\n+     *                    the search (inclusive). If `nullptr`, the search includes up to the genesis\r\n+     *                    block.\r\n+     * @return A (non-null) pointer to the `CBlockIndex` of the furthest away ancestor (including\r\n+     *         `upper_block` itself) that matches the `status_mask`, up to and including\r\n+     *         `lower_block` if it is part of the ancestry.\r\n+     */\r\n+    const CBlockIndex* GetFirstBlock(\r\n+        const CBlockIndex& upper_block LIFETIMEBOUND, \r\n+        uint32_t status_mask,\r\n+        const CBlockIndex* lower_block = nullptr\r\n+    ) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+\r\n \r\n     /** True if any block files have ever been pruned. */\r\n     bool m_have_pruned = false;\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex fa83d2e397..15d6f9e9b9 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -94,6 +94,18 @@ double GetDifficulty(const CBlockIndex& blockindex)\r\n     return dDiff;\r\n }\r\n \r\n+//! Return height of highest block that has been pruned, or -1 if no blocks have been pruned\r\n+static int GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(!cs_main) {\r\n+    AssertLockHeld(cs_main);\r\n+\r\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\r\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\r\n+    const auto first_pruned{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_MASK)->nHeight - 1};\r\n+\r\n+    // special case: genesis block is never pruned\r\n+    return first_pruned == 0 ? -1 : first_pruned;\r\n+}\r\n+\r\n static int ComputeNextBlockAndDepth(const CBlockIndex& tip, const CBlockIndex& blockindex, const CBlockIndex*& next)\r\n {\r\n     next = tip.GetAncestor(blockindex.nHeight + 1);\r\n@@ -835,9 +847,7 @@ static RPCHelpMan pruneblockchain()\r\n     }\r\n \r\n     PruneBlockFilesManual(active_chainstate, height);\r\n-    const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\r\n-    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\r\n-    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;\r\n+    return GetPruneHeight(active_chainstate);\r\n },\r\n     };\r\n }\r\n@@ -1290,10 +1300,7 @@ RPCHelpMan getblockchaininfo()\r\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\r\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\r\n     if (chainman.m_blockman.IsPruneMode()) {\r\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\r\n-        const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\r\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight : tip.nHeight + 1);\r\n-\r\n+        obj.pushKV(\"pruneheight\", GetPruneHeight(active_chainstate) + 1);\r\n         const bool automatic_pruning{chainman.m_blockman.GetPruneTarget() != BlockManager::PRUNE_TARGET_MANUAL};\r\n         obj.pushKV(\"automatic_pruning\",  automatic_pruning);\r\n         if (automatic_pruning) {\r\ndiff --git a/src/test/blockmanager_tests.cpp b/src/test/blockmanager_tests.cpp\r\nindex d7ac0bf823..12f3257700 100644\r\n--- a/src/test/blockmanager_tests.cpp\r\n+++ b/src/test/blockmanager_tests.cpp\r\n@@ -2,6 +2,7 @@\r\n // Distributed under the MIT software license, see the accompanying\r\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n \r\n+#include <chain.h>\r\n #include <chainparams.h>\r\n #include <clientversion.h>\r\n #include <node/blockstorage.h>\r\n@@ -113,7 +114,7 @@ BOOST_FIXTURE_TEST_CASE(blockmanager_block_data_availability, TestChain100Setup)\r\n     };\r\n \r\n     // 1) Return genesis block when all blocks are available\r\n-    BOOST_CHECK_EQUAL(blockman.GetFirstStoredBlock(tip), chainman->ActiveChain()[0]);\r\n+    BOOST_CHECK_EQUAL(blockman.GetFirstBlock(tip, BLOCK_HAVE_DATA), chainman->ActiveChain()[0]);\r\n     BOOST_CHECK(blockman.CheckBlockDataAvailability(tip, *chainman->ActiveChain()[0]));\r\n \r\n     // 2) Check lower_block when all blocks are available\r\n@@ -127,7 +128,7 @@ BOOST_FIXTURE_TEST_CASE(blockmanager_block_data_availability, TestChain100Setup)\r\n     func_prune_blocks(last_pruned_block);\r\n \r\n     // 3) The last block not pruned is in-between upper-block and the genesis block\r\n-    BOOST_CHECK_EQUAL(blockman.GetFirstStoredBlock(tip), first_available_block);\r\n+    BOOST_CHECK_EQUAL(blockman.GetFirstBlock(tip, BLOCK_HAVE_DATA), first_available_block);\r\n     BOOST_CHECK(blockman.CheckBlockDataAvailability(tip, *first_available_block));\r\n     BOOST_CHECK(!blockman.CheckBlockDataAvailability(tip, *last_pruned_block));\r\n }\r\n\r\n```\r\n</details>\r\n",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-1970253804",
      "submitted_at": "2024-03-31T22:14:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12635651379,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALxJL0z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12635651379",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T19:28:27Z"
    },
    {
      "event": "commented",
      "id": 2081618206,
      "node_id": "IC_kwDOABII5858Evke",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2081618206",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T19:34:03Z",
      "updated_at": "2024-04-28T23:13:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "@stickies-v Thank you, I mostly took your suggestions with some minor tweaks and made you co-author of the refactoring commit. I was a bit torn about letting the caller handle the Genesis block issue but since this was actually the previous behavior I guess it's better to not change it if you like it the way it is. I have adapted `GetPruneHeight` to return `std::optional` which I found a good fit and avoids the `-1` return value. And I think the change in `init.cpp` isn't needed here (yet). But I think we will need it in #29770 later.\r\n\r\nEDIT: I had forgotten that `pruneblockchain` returns `-1` when nothing is pruned, but I still think handling it internally with `std::optional` is nicer.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2081618206",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 12635668446,
      "node_id": "MEE_lADOABII586ClE1ezwAAAALxJP_e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12635668446",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T19:34:04Z"
    },
    {
      "event": "subscribed",
      "id": 12635668450,
      "node_id": "SE_lADOABII586ClE1ezwAAAALxJP_i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12635668450",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T19:34:04Z"
    },
    {
      "event": "labeled",
      "id": 12635821265,
      "node_id": "LE_lADOABII586ClE1ezwAAAALxJ1TR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12635821265",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T20:39:35Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12635948991,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALxKUe_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12635948991",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T21:30:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12636063152,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALxKwWw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12636063152",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T22:06:01Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12636147486,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALxLE8e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12636147486",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T22:44:19Z"
    },
    {
      "event": "unlabeled",
      "id": 12636285940,
      "node_id": "UNLE_lADOABII586ClE1ezwAAAALxLmv0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12636285940",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-28T23:51:35Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2028288474,
      "node_id": "PRR_kwDOABII58545Tna",
      "url": null,
      "actor": null,
      "commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "nit: I think the last 3 commits should be squashed",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2028288474",
      "submitted_at": "2024-04-29T12:18:52Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12645879816,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAALxwNAI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12645879816",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T16:25:31Z"
    },
    {
      "event": "commented",
      "id": 2083168939,
      "node_id": "IC_kwDOABII5858KqKr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2083168939",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T16:27:19Z",
      "updated_at": "2024-04-29T16:27:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "Adressed feedback from @stickies-v , thanks again!\r\n\r\n> nit: I think the last 3 commits should be squashed\r\n\r\nThe doc change is only tangentially related so I will keep it separate. But I squashed the 2nd and 3rd.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2083168939",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 12645901178,
      "node_id": "MEE_lADOABII586ClE1ezwAAAALxwSN6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12645901178",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T16:27:20Z"
    },
    {
      "event": "subscribed",
      "id": 12645901191,
      "node_id": "SE_lADOABII586ClE1ezwAAAALxwSOH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12645901191",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-04-29T16:27:20Z"
    },
    {
      "event": "reviewed",
      "id": 2028926937,
      "node_id": "PRR_kwDOABII58547vfZ",
      "url": null,
      "actor": null,
      "commit_id": "697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review 697d0a23f5d0a75829ffe1ac874eaf15fff3bfbe. Approach seems good and first commit seems ok in its current form but I think version of GetPruneHeight in the second commit is not handling the genesis block correctly.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2028926937",
      "submitted_at": "2024-04-29T18:21:03Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "subscribed",
      "id": 12961427688,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMEj7Do",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12961427688",
      "actor": {
        "login": "Blackmoses32",
        "id": 76093520,
        "node_id": "MDQ6VXNlcjc2MDkzNTIw",
        "avatar_url": "https://avatars.githubusercontent.com/u/76093520?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Blackmoses32",
        "html_url": "https://github.com/Blackmoses32",
        "followers_url": "https://api.github.com/users/Blackmoses32/followers",
        "following_url": "https://api.github.com/users/Blackmoses32/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Blackmoses32/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Blackmoses32/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Blackmoses32/subscriptions",
        "organizations_url": "https://api.github.com/users/Blackmoses32/orgs",
        "repos_url": "https://api.github.com/users/Blackmoses32/repos",
        "events_url": "https://api.github.com/users/Blackmoses32/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Blackmoses32/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-28T18:00:57Z"
    },
    {
      "event": "unsubscribed",
      "id": 12961427783,
      "node_id": "UE_lADOABII586ClE1ezwAAAAMEj7FH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12961427783",
      "actor": {
        "login": "Blackmoses32",
        "id": 76093520,
        "node_id": "MDQ6VXNlcjc2MDkzNTIw",
        "avatar_url": "https://avatars.githubusercontent.com/u/76093520?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Blackmoses32",
        "html_url": "https://github.com/Blackmoses32",
        "followers_url": "https://api.github.com/users/Blackmoses32/followers",
        "following_url": "https://api.github.com/users/Blackmoses32/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Blackmoses32/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Blackmoses32/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Blackmoses32/subscriptions",
        "organizations_url": "https://api.github.com/users/Blackmoses32/orgs",
        "repos_url": "https://api.github.com/users/Blackmoses32/repos",
        "events_url": "https://api.github.com/users/Blackmoses32/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Blackmoses32/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-28T18:00:57Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12990514940,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAAMGS4b8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12990514940",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-30T18:57:03Z"
    },
    {
      "event": "commented",
      "id": 2140704680,
      "node_id": "IC_kwDOABII585_mI-o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2140704680",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-30T19:07:15Z",
      "updated_at": "2024-05-30T19:07:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "Addressed comments from @ryanofsky , thank you for the thoughtful review!",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2140704680",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 12990621365,
      "node_id": "MEE_lADOABII586ClE1ezwAAAAMGTSa1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12990621365",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-30T19:07:16Z"
    },
    {
      "event": "subscribed",
      "id": 12990621379,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMGTSbD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12990621379",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-30T19:07:16Z"
    },
    {
      "event": "reviewed",
      "id": 2093944753,
      "node_id": "PRR_kwDOABII5858zw-x",
      "url": null,
      "actor": null,
      "commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2093944753",
      "submitted_at": "2024-06-03T16:24:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "reviewed",
      "id": 2094387578,
      "node_id": "PRR_kwDOABII58581dF6",
      "url": null,
      "actor": null,
      "commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review 0501ec102f3740049bd2e891cd83527c31b29222. Code looks very good, but the `nStatus & BLOCK_HAVE_MASK` bug found by stickies-v https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314 needs to be fixed, and the other suggested changes could be considered too\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2094387578",
      "submitted_at": "2024-06-03T16:54:53Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk2YjRmYWNjOTEyOTI3MzA1YjA2YTIzM2NiOGIzNmU3ZTU5NjRjMDg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/96b4facc912927305b06a233cb8b36e7e5964c08",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/96b4facc912927305b06a233cb8b36e7e5964c08",
      "tree": {
        "sha": "c771001c6fafacc62975afd06482f4ebe105b0b7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c771001c6fafacc62975afd06482f4ebe105b0b7"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree c771001c6fafacc62975afd06482f4ebe105b0b7\nparent 3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab\nauthor Fabian Jahr <fjahr@protonmail.com> 1710686284 +0100\ncommitter Fabian Jahr <fjahr@protonmail.com> 1718974816 +0200\n\nrefactor, blockstorage: Generalize GetFirstStoredBlock\n\nGetFirstStoredBlock is generalized to check for any data status with a\nstatus mask that needs to be passed as a parameter. To reflect this the\nfunction is also renamed to GetFirstBlock.\n\nCo-authored-by: stickies-v <stickies-v@protonmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJIBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmZ1eWEVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNwFwP93rmtdRQeAPXr0JPgG0AnDmyiGBD\n0/w0sZGBqNRYNH2CnIMBUcJGqASmcmhztTKpCzMpw2JdLu6jN5Ek1GvN2seq7m5V\nItcGplvmUJFpHLgjZTHGwtLFCsvOwG8pbaJ6dFwA02rvzrlXFUnh3oZn6eJoApbL\nt0s09buv2pteDE8Gv66ooW5SP9Q1wd3feUIChPMUmN2lZTnYuvFgGtrULlJkbnyy\nqqmMam5SjxIsHGLcxPbaVEuBAPLqNuNoD/egt1fLLeg7533LG+eraKnGNOYLX42v\nQX6VeZWlkCZXLBQNXm8Jkj3gqhcoK/RLbY1RIUCx6p4MhyhMA19LuVZca85kGQDF\nCkBRBnYL+b2TW3REYlalo6BAZuxUKPlDSRTYDwHPfHb4TaX2BqRLnU0/rGyWfNeW\niMk/cGYlPitIp3Dz6vyAnv6hUh14FHO2V6CdJhFwtLPqtIvYMFokrzVRBdx10hZy\nX556xFE8CocU2vdFqH4oImjWzbsh4rjd+0MOscG4zGqDcumWOpfCZzD2QBFJSAzV\nqS70+W+TDhfQztmo8SKPhOxgoZuN0tVtSVXioS8RlqC7v0WxXm9NV3T/ZQGAoRtV\n3JJwTXtSxjxxZPgUbgg/eBvtgX1S6S9lRBO71U0ONZaCE1HQih8t8bi5UPvoslYR\nsU0MuomAX+t6WzI=\n=CSTL\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab",
          "sha": "3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/3aaf7328eb656b642e5f0f74f3e4d51645a1d0ab"
        }
      ],
      "message": "refactor, blockstorage: Generalize GetFirstStoredBlock\n\nGetFirstStoredBlock is generalized to check for any data status with a\nstatus mask that needs to be passed as a parameter. To reflect this the\nfunction is also renamed to GetFirstBlock.\n\nCo-authored-by: stickies-v <stickies-v@protonmail.com>",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-06-21T13:00:16Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-03-17T14:38:04Z"
      },
      "sha": "96b4facc912927305b06a233cb8b36e7e5964c08"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13251041432,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAAMV0tiY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251041432",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:19:47Z"
    },
    {
      "event": "commented",
      "id": 2184088934,
      "node_id": "IC_kwDOABII586CLo1m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184088934",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:23:42Z",
      "updated_at": "2024-06-22T16:23:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "Addressed feedback from @stickies-v and @ryanofsky, thank you!",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2184088934",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 13251048973,
      "node_id": "MEE_lADOABII586ClE1ezwAAAAMV0vYN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251048973",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:23:44Z"
    },
    {
      "event": "subscribed",
      "id": 13251048976,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMV0vYQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251048976",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:23:44Z"
    },
    {
      "event": "mentioned",
      "id": 13251048986,
      "node_id": "MEE_lADOABII586ClE1ezwAAAAMV0vYa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251048986",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:23:44Z"
    },
    {
      "event": "subscribed",
      "id": 13251048989,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMV0vYd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251048989",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T16:23:44Z"
    },
    {
      "event": "commented",
      "id": 2184124132,
      "node_id": "IC_kwDOABII586CLxbk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2184124132",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T17:37:33Z",
      "updated_at": "2024-06-22T17:37:33Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\nðŸš§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/26553131801</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2184124132",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "labeled",
      "id": 13251244643,
      "node_id": "LE_lADOABII586ClE1ezwAAAAMV1fJj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251244643",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T17:37:33Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRhMTk3NTAwOGI2MDJhZWFjZGFkOWE3NGQxODM3YTc0NTUxNDgwNzQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4a1975008b602aeacdad9a74d1837a7455148074",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4a1975008b602aeacdad9a74d1837a7455148074",
      "tree": {
        "sha": "79cb0d007707a8d95a7853f24254d4e9b8336d4b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/79cb0d007707a8d95a7853f24254d4e9b8336d4b"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 79cb0d007707a8d95a7853f24254d4e9b8336d4b\nparent 96b4facc912927305b06a233cb8b36e7e5964c08\nauthor Fabian Jahr <fjahr@protonmail.com> 1710687458 +0100\ncommitter Fabian Jahr <fjahr@protonmail.com> 1719094524 +0200\n\nrpc: Make pruneheight also reflect undo data presence\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmZ3TP4VHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jN3z4P/isMH0r5jw0xiKi59ZDkMMO/W8VT\n426iLWwdmZPbLHSdMkFZ0v1909q/gMtull9Z+7C5xNd3UsnXny746Ke4bBnVd/TU\nnCRnsHyuEIj2VVIcbUlbBkrKVN0VUDcQFDLucVPI6vOM1OsIpfbvyG6qpLR5+H82\nOxLLpOUWEbs1mXTzat6o9WZRaPDYZA6z1DZBOOWpezOksTXvcExJ+xexJ6RjtTFm\nBZyAqSwqsJ4GxqiQFI67hN2Hum7gmKD5xwP5IHSMCf8tJ2h3rlaTHjEldQwEC+lO\n5gs7rTWJK00IZwJwAzRUA5eqAeV/grPP0sWs6bA/LnMIZUhIudYOjxXFHWc7ZQGe\ncDxQ/9SZ6FGImR4+ppYPZ7eTHEm/pFsnmfg1Mha9aI/0WuQOjYmzD+2fs5/ZolmP\nE9nNeZqwAzEFe92a/DvTsMJpOnL9wCGbzHX9+LrkFjq3v+p/lKkhbtZhXuXMduLs\nSS3/MGusiYZB8nqVsCqwDHL7pVeve2AzDLnz8o8fvFcdwZAsSeX53r4QmVQA1geV\niEhQklDSrpnv5NPAnQ9VOryLc26bNPyURANW/MUycWV82ZMRM4JGvfH8jVfSX4OB\nlY5h3pHtYS81zexe8TxLzkfbsy2ayjzGzJ5yfa0KUg/WNDIy/Hnn+Q/Q3mnaIvMe\nKVUIm6j3I9Uh1Jf1\n=1hNS\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/96b4facc912927305b06a233cb8b36e7e5964c08",
          "sha": "96b4facc912927305b06a233cb8b36e7e5964c08",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/96b4facc912927305b06a233cb8b36e7e5964c08"
        }
      ],
      "message": "rpc: Make pruneheight also reflect undo data presence",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-06-22T22:15:24Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-03-17T14:57:38Z"
      },
      "sha": "4a1975008b602aeacdad9a74d1837a7455148074"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg3ODlkYzhmMzE1YTlkOWFkNzE0MmQ4MzFiYzk0MTJmNzgwMjQ4ZTc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "tree": {
        "sha": "584c84082dbcbae166947a0d9b528e6106535003",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/584c84082dbcbae166947a0d9b528e6106535003"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 584c84082dbcbae166947a0d9b528e6106535003\nparent 4a1975008b602aeacdad9a74d1837a7455148074\nauthor Fabian Jahr <fjahr@protonmail.com> 1710693677 +0100\ncommitter Fabian Jahr <fjahr@protonmail.com> 1719094528 +0200\n\ndoc: Add note to getblockfrompeer on missing undo data\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmZ3TQAVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNY5QQAJvbFCyuNiySpIbRjs2ittfEmXcH\nhtqDKyl4BntyzIOz8m5MQg9Ut0B+j7iyW0G2cYob2wwyClwcR7YhWSHus9F+FcyJ\nMxmakbNrdXBSf4eBbd2rQciyQvbiAoijuYCbgW4MRGkhbJBkiCSQyEpEkwaTm6+7\n2pSNqxDIa2W2WebXIYng0jdDdoJc7Q5otbVuI0Qe+LO3muTitdlmjtLJ4z+/p8N9\nPA3qZdiJaEOFd2QsQIINg2sj61VydvBCi6drFQdfq9HIEvJnemHVeCHzcRxINRYv\nyDHTpQ2iXjhj05ZFZStGnehhvnVpLsqO3gQPcvhJtzg72HgcjmkcBouWQa4ygjS0\n6G50YE3iwSPadQzYIFF0b9eA8FPtwa7E5OgWJTZbUTj2HElzl5aS+gNfYtIRm/Re\ngJgrqDdSbUQAOOMb8VWJs5mAh0fWeMMqUxpgq28QqZclm3NhXn1EsR0LfiynUC7B\nLInAWL4TSYofee1+U17NAv5dXVXo+CM3luXLYCKz5Fse46D3Cc2CrHfMx6z9SfXd\nXGCmBI+WIDERvJF7mF9eUY9PrueJyFM4lh4aAbu4BL20D/XKjzsng1NU3OeKzP7p\nbSeXNvs7oiI9oM9YrbyiMGyj1wYrgHZW3aMj1IwzoS0xVu3N8ByVEDrZd+k5vc1d\nyZ7yQH/iIq3/JQDC\n=2JJB\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4a1975008b602aeacdad9a74d1837a7455148074",
          "sha": "4a1975008b602aeacdad9a74d1837a7455148074",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4a1975008b602aeacdad9a74d1837a7455148074"
        }
      ],
      "message": "doc: Add note to getblockfrompeer on missing undo data",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-06-22T22:15:28Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2024-03-17T16:41:17Z"
      },
      "sha": "8789dc8f315a9d9ad7142d831bc9412f780248e7"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13251871005,
      "node_id": "HRFPE_lADOABII586ClE1ezwAAAAMV34Ed",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13251871005",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T22:18:47Z"
    },
    {
      "event": "unlabeled",
      "id": 13252050289,
      "node_id": "UNLE_lADOABII586ClE1ezwAAAAMV4j1x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13252050289",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-22T23:36:05Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2134340911,
      "node_id": "PRR_kwDOABII585_N3Uv",
      "url": null,
      "actor": null,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2134340911",
      "submitted_at": "2024-06-23T16:48:55Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "reviewed",
      "id": 2135821455,
      "node_id": "PRR_kwDOABII585_TgyP",
      "url": null,
      "actor": null,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Code review ACK 8789dc8f315a9d9ad7142d831bc9412f780248e7.\r\nLeft few nits.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2135821455",
      "submitted_at": "2024-06-24T14:43:25Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "review_requested",
      "id": 13267609056,
      "node_id": "RRE_lADOABII586ClE1ezwAAAAMWz6Xg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13267609056",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-24T14:43:29Z",
      "requested_reviewer": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_requested",
      "id": 13267609248,
      "node_id": "RRE_lADOABII586ClE1ezwAAAAMWz6ag",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13267609248",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-24T14:43:30Z",
      "requested_reviewer": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "reviewed",
      "id": 2135982014,
      "node_id": "PRR_kwDOABII585_UH--",
      "url": null,
      "actor": null,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "ACK 8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#pullrequestreview-2135982014",
      "submitted_at": "2024-06-24T14:45:47Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
    },
    {
      "event": "commented",
      "id": 2221253695,
      "node_id": "IC_kwDOABII586EZaQ_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2221253695",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T19:18:03Z",
      "updated_at": "2024-07-10T19:18:03Z",
      "author_association": "MEMBER",
      "body": "ACK 8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2221253695",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "merged",
      "id": 13461007187,
      "node_id": "ME_lADOABII586ClE1ezwAAAAMiVqtT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13461007187",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f4849f692270f341f353806c44f2c1849879a6bf",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f4849f692270f341f353806c44f2c1849879a6bf",
      "created_at": "2024-07-10T19:27:21Z"
    },
    {
      "event": "closed",
      "id": 13461007222,
      "node_id": "CE_lADOABII586ClE1ezwAAAAMiVqt2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13461007222",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T19:27:21Z"
    },
    {
      "event": "commented",
      "id": 2221722356,
      "node_id": "IC_kwDOABII586EbMr0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2221722356",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T23:49:38Z",
      "updated_at": "2024-07-10T23:49:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "With this merged, I will take #29770 out of draft mode shortly and also address the left-over comments here. Thanks @stickies-v and @furszy !",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#issuecomment-2221722356",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29668"
    },
    {
      "event": "mentioned",
      "id": 13463962450,
      "node_id": "MEE_lADOABII586ClE1ezwAAAAMig8NS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13463962450",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T23:49:40Z"
    },
    {
      "event": "subscribed",
      "id": 13463962468,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMig8Nk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13463962468",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T23:49:40Z"
    },
    {
      "event": "mentioned",
      "id": 13463962477,
      "node_id": "MEE_lADOABII586ClE1ezwAAAAMig8Nt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13463962477",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T23:49:40Z"
    },
    {
      "event": "subscribed",
      "id": 13463962481,
      "node_id": "SE_lADOABII586ClE1ezwAAAAMig8Nx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13463962481",
      "actor": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-10T23:49:40Z"
    },
    {
      "event": "referenced",
      "id": 13489352518,
      "node_id": "REFE_lADOABII586ClE1ezwAAAAMkBy9G",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13489352518",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "34fdeface441dde673abdfc16fef9b384dc65930",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/34fdeface441dde673abdfc16fef9b384dc65930",
      "created_at": "2024-07-12T16:01:34Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537942918",
      "pull_request_review_id": 1958325955,
      "id": 1537942918,
      "node_id": "PRRC_kwDOABII585bqyWG",
      "diff_hunk": "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)",
      "path": "src/node/blockstorage.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: I find `has_undo` more to the point\r\n```suggestion\r\nconst CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool has_undo)\r\n```",
      "created_at": "2024-03-25T17:14:30Z",
      "updated_at": "2024-03-25T20:12:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537942918",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537942918"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 598,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537955721",
      "pull_request_review_id": 1958325955,
      "id": 1537955721,
      "node_id": "PRRC_kwDOABII585bq1eJ",
      "diff_hunk": "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "path": "src/node/blockstorage.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: I think highlighting that this is a mask improves readability\r\n```suggestion\r\n    uint32_t status_mask{BLOCK_HAVE_DATA};\r\n```",
      "created_at": "2024-03-25T17:24:51Z",
      "updated_at": "2024-03-26T10:39:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537955721",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537955721"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 601,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537962499",
      "pull_request_review_id": 1958325955,
      "id": 1537962499,
      "node_id": "PRRC_kwDOABII585bq3ID",
      "diff_hunk": "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "path": "src/node/blockstorage.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537955721,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: also, perhaps good to add a type `static_assert` here to ensure this doesn't silently introduce bugs when `nStatus` changes type?\r\n\r\n```\r\nstatic_assert(std::is_same<decltype(check_status), decltype(last_block->nStatus)>::value);\r\n\r\n```",
      "created_at": "2024-03-25T17:29:45Z",
      "updated_at": "2024-03-25T20:12:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537962499",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537962499"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 601,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537973016",
      "pull_request_review_id": 1958325955,
      "id": 1537973016,
      "node_id": "PRRC_kwDOABII585bq5sY",
      "diff_hunk": "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 7,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: unnecessary `const`\r\n```suggestion\r\n    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n```",
      "created_at": "2024-03-25T17:35:03Z",
      "updated_at": "2024-03-25T20:12:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537973016",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537973016"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 341,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537985109",
      "pull_request_review_id": 1958325955,
      "id": 1537985109,
      "node_id": "PRRC_kwDOABII585bq8pV",
      "diff_hunk": "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 7,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537973016,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: also, would be nice to update the docs for the `check_undo` param, and include the exception made for genesis block so new callers are made aware to look out for that?",
      "created_at": "2024-03-25T17:42:49Z",
      "updated_at": "2024-03-25T20:12:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537985109",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537985109"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 341,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537989270",
      "pull_request_review_id": 1958325955,
      "id": 1537989270,
      "node_id": "PRRC_kwDOABII585bq9qW",
      "diff_hunk": "@@ -835,7 +836,7 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, true)->nHeight - 1 : block.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit (+ a few lines down)\r\n```suggestion\r\n    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*last_block=*/nullptr, /*check_undo=*/true)->nHeight - 1 : block.nHeight;\r\n```",
      "created_at": "2024-03-25T17:45:26Z",
      "updated_at": "2024-03-25T20:12:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1537989270",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1537989270"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 839,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505540",
      "pull_request_review_id": 1963955472,
      "id": 1541505540,
      "node_id": "PRRC_kwDOABII585b4YIE",
      "diff_hunk": "@@ -835,7 +836,7 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, nullptr, true)->nHeight - 1 : block.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537989270,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-03-27T17:03:31Z",
      "updated_at": "2024-03-27T17:03:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505540",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505540"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 839,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505629",
      "pull_request_review_id": 1963955617,
      "id": 1541505629,
      "node_id": "PRRC_kwDOABII585b4YJd",
      "diff_hunk": "@@ -337,8 +337,8 @@ class BlockManager\n \n     //! Find the first stored ancestor of start_block immediately after the last\n     //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! for ensuring that start_block has data.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, const bool check_undo=false) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 7,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537973016,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-03-27T17:03:34Z",
      "updated_at": "2024-03-27T17:03:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505629",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 341,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505765",
      "pull_request_review_id": 1963955807,
      "id": 1541505765,
      "node_id": "PRRC_kwDOABII585b4YLl",
      "diff_hunk": "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)\n {\n     AssertLockHeld(::cs_main);\n+    uint32_t check_status{BLOCK_HAVE_DATA};",
      "path": "src/node/blockstorage.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537955721,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not needed due to approach change",
      "created_at": "2024-03-27T17:03:40Z",
      "updated_at": "2024-03-27T17:03:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505765",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505765"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 601,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505876",
      "pull_request_review_id": 1963955981,
      "id": 1541505876,
      "node_id": "PRRC_kwDOABII585b4YNU",
      "diff_hunk": "@@ -595,12 +595,16 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\n }\n \n-const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block)\n+const CBlockIndex* BlockManager::GetFirstStoredBlock(const CBlockIndex& upper_block, const CBlockIndex* lower_block, const bool check_undo)",
      "path": "src/node/blockstorage.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "296243c3153e996d1626b8eabc8f8bce845ce3ad",
      "in_reply_to_id": 1537942918,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not needed due to approach change",
      "created_at": "2024-03-27T17:03:44Z",
      "updated_at": "2024-03-27T17:03:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1541505876",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1541505876"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 598,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545671827",
      "pull_request_review_id": 1970253804,
      "id": 1545671827,
      "node_id": "PRRC_kwDOABII585cIRST",
      "diff_hunk": "@@ -835,7 +836,8 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n    return block.nStatus & has_undo ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;\r\n```",
      "created_at": "2024-03-31T13:35:54Z",
      "updated_at": "2024-03-31T22:14:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545671827",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545671827"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 840,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545672055",
      "pull_request_review_id": 1970253804,
      "id": 1545672055,
      "node_id": "PRRC_kwDOABII585cIRV3",
      "diff_hunk": "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This should check for `has_undo` too",
      "created_at": "2024-03-31T13:36:34Z",
      "updated_at": "2024-03-31T22:14:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545672055",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545672055"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1293,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545690307",
      "pull_request_review_id": 1970253804,
      "id": 1545690307,
      "node_id": "PRRC_kwDOABII585cIVzD",
      "diff_hunk": "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": 1545672055,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Also, it seems like we can just use `BLOCK_HAVE_MASK          =   BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO,`",
      "created_at": "2024-03-31T14:13:13Z",
      "updated_at": "2024-03-31T22:14:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545690307",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545690307"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1293,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545720878",
      "pull_request_review_id": 1970253804,
      "id": 1545720878,
      "node_id": "PRRC_kwDOABII585cIdQu",
      "diff_hunk": "@@ -336,9 +336,12 @@ class BlockManager\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! ancestor that does not match the status mask. Return value will never be\n+    //! null. Caller is responsible for ensuring that start_block has the status\n+    //! mask data. If the whole chain matched the status mask the genesis block\n+    //! will be returned regardless of it's status match because, for example,\n+    //! it can not have undo data by nature.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: it's called `upper_block` in the implementation, which I think is a better name too (cfr `lower_block`)\r\n```suggestion\r\n    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n```",
      "created_at": "2024-03-31T15:35:19Z",
      "updated_at": "2024-03-31T22:14:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1545720878",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1545720878"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 344,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311337",
      "pull_request_review_id": 2027256874,
      "id": 1582311337,
      "node_id": "PRRC_kwDOABII585eUCep",
      "diff_hunk": "@@ -336,9 +336,12 @@ class BlockManager\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    //! ancestor that does not match the status mask. Return value will never be\n+    //! null. Caller is responsible for ensuring that start_block has the status\n+    //! mask data. If the whole chain matched the status mask the genesis block\n+    //! will be returned regardless of it's status match because, for example,\n+    //! it can not have undo data by nature.\n+    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr, uint32_t status_mask=BLOCK_HAVE_DATA) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": 1545720878,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-04-28T19:28:29Z",
      "updated_at": "2024-04-28T19:28:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311337",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311337"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 344,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311605",
      "pull_request_review_id": 2027257309,
      "id": 1582311605,
      "node_id": "PRRC_kwDOABII585eUCi1",
      "diff_hunk": "@@ -1289,7 +1291,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n         bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": 1545672055,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done, I liked that `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` is more expressive because we don't use `BLOCK_HAVE_MASK` much I feel like people would need to look it up more, but I have just added a comment instead now.",
      "created_at": "2024-04-28T19:28:35Z",
      "updated_at": "2024-04-28T19:28:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311605",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311605"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1293,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311745",
      "pull_request_review_id": 2027257574,
      "id": 1582311745,
      "node_id": "PRRC_kwDOABII585eUClB",
      "diff_hunk": "@@ -835,7 +836,8 @@ static RPCHelpMan pruneblockchain()\n \n     PruneBlockFilesManual(active_chainstate, height);\n     const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const uint32_t has_undo{BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO};\n+    return block.nStatus & BLOCK_HAVE_MASK ? active_chainstate.m_blockman.GetFirstStoredBlock(block, /*lower_block=*/nullptr, /*status_mask=*/has_undo)->nHeight - 1 : block.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "23ac56177df6888f9ede370092f26b1cf6bebf26",
      "in_reply_to_id": 1545671827,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-04-28T19:28:40Z",
      "updated_at": "2024-04-28T19:28:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582311745",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582311745"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 840,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582961257",
      "pull_request_review_id": 2028288474,
      "id": 1582961257,
      "node_id": "PRRC_kwDOABII585eWhJp",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Could add a `CHECK_NONFATAL(first_block->nHeight > 0);` here to put that assumption in code, that would've helped with the segfault in current HEAD",
      "created_at": "2024-04-29T11:51:40Z",
      "updated_at": "2024-04-29T12:19:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582961257",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582961257"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 798,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582963779",
      "pull_request_review_id": 2028288474,
      "id": 1582963779,
      "node_id": "PRRC_kwDOABII585eWhxD",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This block needs to be in the next commit - we're not passing `BLOCK_HAVE_MASK` yet in dd7696b97f20d756df1afa523a8f9e7bf3924c7d. This should fix the [failing CI](https://github.com/bitcoin/bitcoin/actions/runs/8870919761/job/24353246496?pr=29668)",
      "created_at": "2024-04-29T11:52:18Z",
      "updated_at": "2024-04-29T12:18:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582963779",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582963779"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 795,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582976807",
      "pull_request_review_id": 2028288474,
      "id": 1582976807,
      "node_id": "PRRC_kwDOABII585eWk8n",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`GetFirstBlock()` does not provide any guarantees that `pprev` is not `nullptr` (nor should it), so I think we need to assert that here",
      "created_at": "2024-04-29T11:59:58Z",
      "updated_at": "2024-04-29T12:18:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582976807",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582976807"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 801,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582979911",
      "pull_request_review_id": 2028288474,
      "id": 1582979911,
      "node_id": "PRRC_kwDOABII585eWltH",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```suggestion\r\n//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n```",
      "created_at": "2024-04-29T12:02:52Z",
      "updated_at": "2024-04-29T12:18:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582979911",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582979911"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582984829",
      "pull_request_review_id": 2028288474,
      "id": 1582984829,
      "node_id": "PRRC_kwDOABII585eWm59",
      "diff_hunk": "@@ -834,8 +853,8 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const auto prune_height{GetPruneHeight(active_chainstate)};\n+    return prune_height ? prune_height.value() : -1;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit\r\n```suggestion\r\n    return GetPruneHeight(active_chainstate).value_or(-1);\r\n```",
      "created_at": "2024-04-29T12:07:22Z",
      "updated_at": "2024-04-29T12:18:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582984829",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582984829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 856,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 857,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582992037",
      "pull_request_review_id": 2028288474,
      "id": 1582992037,
      "node_id": "PRRC_kwDOABII585eWoql",
      "diff_hunk": "@@ -1288,8 +1307,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(active_chainstate)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 51,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: more consistent with the (suggested) approach in `pruneblockchain`, but then \"plus one (only present if pruning is enabled)\" as per the docs in this RPC\r\n\r\n```suggestion\r\n        const auto prune_height{GetPruneHeight(active_chainstate).value_or(-1)};\r\n        obj.pushKV(\"pruneheight\", prune_height + 1);\r\n```",
      "created_at": "2024-04-29T12:14:03Z",
      "updated_at": "2024-04-29T12:18:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1582992037",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1582992037"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 1310,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1318,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583335298",
      "pull_request_review_id": 2028926937,
      "id": 1583335298,
      "node_id": "PRRC_kwDOABII585eX8eC",
      "diff_hunk": "@@ -335,10 +335,28 @@ class BlockManager\n     //! (part of the same chain).\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n-    //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    /**\n+     * @brief Finds the furthest away ancestor of `upper_block` of which the nStatus matches the `status_mask`\n+     *\n+     * Starts from `upper_block` and iterates backwards through its ancestors for as long as the block's\n+     * nStatus keeps matching the `status_mask` mask, or until it encounters `lower_block`.\n+     *\n+     * @pre `upper_block` must match the `status_mask`.\n+     *\n+     * @param upper_block The block from which to start the search, must meet the `status_mask` criteria.\n+     * @param status_mask A bitmask representing the conditions to check against each block's nStatus.\n+     * @param lower_block An optional pointer to the `CBlockIndex` that serves as the lower boundary of\n+     *                    the search (inclusive). If `nullptr`, the search includes up to the genesis\n+     *                    block.\n+     * @return A (non-null) pointer to the `CBlockIndex` of the furthest away ancestor (including\n+     *         `upper_block` itself) that matches the `status_mask`, up to and including\n+     *         `lower_block` if it is part of the ancestry.\n+     */",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 24,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dd7696b97f20d756df1afa523a8f9e7bf3924c7d",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (dd7696b97f20d756df1afa523a8f9e7bf3924c7d)\r\n\r\nI think there are a few issues with this comment:\r\n\r\n- The @<!-- -->brief and @<!-- -->return sections make it sound like it is returning the earliest block matching the flags, when actually it is returning the earliest block matching the flags after the latest block _not_ matching them. This is different because it means not only does the returned block have the flags, but all blocks between the returned block and upper block have them.\r\n- One precondition is specified but one is missing (this also asserts false if the lower block is not an ancestor of the upper block).\r\n- I don't like how some pretty important details are written in parentheses. Better to use parentheses for more optional explanatory information.\r\n\r\nSuggestion to fix these things:\r\n\r\n```c++\r\n    /**\r\n     * @brief Returns the earliest block with specified `status_mask` flags set after\r\n     * the latest block _not_ having those flags.\r\n     *\r\n     * This function starts from `upper_block`, which must have all\r\n     * `status_mask` flags set, and iterates backwards through its ancestors. It\r\n     * continues as long as each block has all `status_mask` flags set, until\r\n     * reaching the oldest ancestor or `lower_block`.\r\n     * \r\n     * @pre `upper_block` must have all `status_mask` flags set.\r\n     * @pre `lower_block` must be null or an ancestor of `upper_block`\r\n     *\r\n     * @param upper_block The starting block for the search, which must have all\r\n     *                    `status_mask` flags set.\r\n     * @param status_mask Bitmask specifying required status flags.\r\n     * @param lower_block The earliest possible block to return. If null, the\r\n     *                    search can extend to the genesis block.\r\n     *\r\n     * @return A non-null pointer to the earliest block between `upper_block`\r\n     *         and `lower_block`, inclusive, such that every block between the\r\n     *         returned block and `upper_block` has `status_mask` flags set.\r\n     */\r\n```",
      "created_at": "2024-04-29T16:00:09Z",
      "updated_at": "2024-04-29T18:21:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583335298",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583335298"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 338,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 359,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375437",
      "pull_request_review_id": 2028993343,
      "id": 1583375437,
      "node_id": "PRRC_kwDOABII585eYGRN",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582961257,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-04-29T16:25:38Z",
      "updated_at": "2024-04-29T16:25:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375437",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375437"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 798,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375522",
      "pull_request_review_id": 2028993500,
      "id": 1583375522,
      "node_id": "PRRC_kwDOABII585eYGSi",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582963779,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-04-29T16:25:42Z",
      "updated_at": "2024-04-29T16:25:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375522",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375522"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 795,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375709",
      "pull_request_review_id": 2028993751,
      "id": 1583375709,
      "node_id": "PRRC_kwDOABII585eYGVd",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582976807,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-04-29T16:25:49Z",
      "updated_at": "2024-04-29T16:25:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375709",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375709"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 801,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375852",
      "pull_request_review_id": 2028993958,
      "id": 1583375852,
      "node_id": "PRRC_kwDOABII585eYGXs",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582979911,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "added",
      "created_at": "2024-04-29T16:25:55Z",
      "updated_at": "2024-04-29T16:25:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583375852",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583375852"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376000",
      "pull_request_review_id": 2028994150,
      "id": 1583376000,
      "node_id": "PRRC_kwDOABII585eYGaA",
      "diff_hunk": "@@ -834,8 +853,8 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex& block{*CHECK_NONFATAL(active_chain.Tip())};\n-    return block.nStatus & BLOCK_HAVE_DATA ? active_chainstate.m_blockman.GetFirstStoredBlock(block)->nHeight - 1 : block.nHeight;\n+    const auto prune_height{GetPruneHeight(active_chainstate)};\n+    return prune_height ? prune_height.value() : -1;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582984829,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "taken",
      "created_at": "2024-04-29T16:26:00Z",
      "updated_at": "2024-04-29T16:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376000",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376000"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 856,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 857,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376085",
      "pull_request_review_id": 2028994276,
      "id": 1583376085,
      "node_id": "PRRC_kwDOABII585eYGbV",
      "diff_hunk": "@@ -1288,8 +1307,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(active_chainstate)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 51,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582992037,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I prefer to keep this one as is because I find it more intuitive.",
      "created_at": "2024-04-29T16:26:04Z",
      "updated_at": "2024-04-29T16:26:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583376085",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583376085"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 1310,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1318,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583398465",
      "pull_request_review_id": 2028926937,
      "id": 1583398465,
      "node_id": "PRRC_kwDOABII585eYL5B",
      "diff_hunk": "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n+\n+    if (first_block->nHeight == 0) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return Assert(first_block->pprev)->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (4e62129d8aed839c83fa4a595aab06ed5ca7eeb6)\r\n\r\nIMO, this logic is a little confusing because it using both `nHeight` and `pprev` instead of just using `pprev` consistently. Also I think the cases here could have more explanation.\r\n\r\n```c++\r\n// Get first block with data, after the last block without data.\r\n// This is the start of the unpruned range of blocks.\r\nconst auto first_unpruned{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\r\nif (!first_unpruned->prev) {\r\n   // No block before the first unpruned block means nothing is pruned.\r\n   return nullopt;\r\n}\r\n// Block before the first unpruned block is the last pruned block.\r\nreturn first_unpruned->prev->nHeight;\r\n```",
      "created_at": "2024-04-29T16:44:22Z",
      "updated_at": "2024-04-29T18:21:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583398465",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583398465"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 793,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 797,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583454227",
      "pull_request_review_id": 2028926937,
      "id": 1583454227,
      "node_id": "PRRC_kwDOABII585eYZgT",
      "diff_hunk": "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"rpc: Make pruneheight also reflect undo data presence\" (61f352d6bcf485862815fdd68064cc07ea8ab6ce)\r\n\r\nThis doesn't seem right. If chain consists of just genesis block, and genesis block doesn't have undo data this will return height 0 as if genesis block were pruned.",
      "created_at": "2024-04-29T17:30:47Z",
      "updated_at": "2024-04-29T18:21:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583454227",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583454227"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 791,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583472496",
      "pull_request_review_id": 2028926937,
      "id": 1583472496,
      "node_id": "PRRC_kwDOABII585eYd9w",
      "diff_hunk": "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (4e62129d8aed839c83fa4a595aab06ed5ca7eeb6)\r\n\r\nI don't think it makes sense to call this parameter `active_chainstate`. It is true the active chainstate is always passed, but this function should care whether the chainstate is active or not. Probably also it would be better for this function not to access the Chainstate class at all and instead be passed separate BlockMan and CChain parameters.",
      "created_at": "2024-04-29T17:41:09Z",
      "updated_at": "2024-04-29T18:21:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583472496",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583472496"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583515582",
      "pull_request_review_id": 2028926937,
      "id": 1583515582,
      "node_id": "PRRC_kwDOABII585eYoe-",
      "diff_hunk": "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"rpc: Make pruneheight also reflect undo data presence\" (61f352d6bcf485862815fdd68064cc07ea8ab6ce)\r\n\r\nThis comment \"Result can never be 0 because genesis block is never pruned\" is misleading and basically describes the opposite of what is happening. If the genesis block was not pruned you would expect GetFirstBlock to return the genesis block, because it has data, and for the result to still be 0 here like it was in the previous commit. The reason `GetFirstBlock` is no longer returning the genesis block is because the genesis block does not have undo data, so it is now being considered pruned.\r\n\r\nSo code works for a different reason than is being described. I think it would probably clearer to ignore genesis block flags rather than making this code depend on that that genesis undo flag won't be set.\r\n\r\nWould suggest something more like the following (untested):\r\n\r\n```c++\r\n//! Return height of highest block on the chain that has been pruned, or std::nullopt if no blocks have been pruned\r\nstatic std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n    AssertLockHeld(::cs_main);\r\n\r\n    // Search for the last block missing block data or undo data. Don't let the\r\n    // search consider the genesis block, because the genesis block does not\r\n    // have undo data, but should not be considered pruned.\r\n    const CBlockIndex* first_block{chain[1]};\r\n    const CBlockIndex* chain_tip{chain.Tip()};\r\n\r\n    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\r\n    if (!first_block || !chain_tip) return std::nullopt;\r\n\r\n    // If the chain tip is pruned, everything is pruned.\r\n    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;\r\n\r\n    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\r\n    if (&first_unpruned == first_block) {\r\n        // All blocks between first_block and chain_tip have data, so nothing is pruned.\r\n        return std::nullopt;\r\n    }\r\n\r\n    // Block before the first unpruned block is the last pruned block.\r\n    return Assert(first_unpruned.pprev)->nHeight;\r\n}\r\n```\r\n\r\n",
      "created_at": "2024-04-29T18:15:18Z",
      "updated_at": "2024-04-29T18:21:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1583515582",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1583515582"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 794,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295595",
      "pull_request_review_id": 2089159494,
      "id": 1621295595,
      "node_id": "PRRC_kwDOABII585gowHr",
      "diff_hunk": "@@ -335,10 +335,28 @@ class BlockManager\n     //! (part of the same chain).\n     bool CheckBlockDataAvailability(const CBlockIndex& upper_block LIFETIMEBOUND, const CBlockIndex& lower_block LIFETIMEBOUND) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n-    //! Find the first stored ancestor of start_block immediately after the last\n-    //! pruned ancestor. Return value will never be null. Caller is responsible\n-    //! for ensuring that start_block has data is not pruned.\n-    const CBlockIndex* GetFirstStoredBlock(const CBlockIndex& start_block LIFETIMEBOUND, const CBlockIndex* lower_block=nullptr) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    /**\n+     * @brief Finds the furthest away ancestor of `upper_block` of which the nStatus matches the `status_mask`\n+     *\n+     * Starts from `upper_block` and iterates backwards through its ancestors for as long as the block's\n+     * nStatus keeps matching the `status_mask` mask, or until it encounters `lower_block`.\n+     *\n+     * @pre `upper_block` must match the `status_mask`.\n+     *\n+     * @param upper_block The block from which to start the search, must meet the `status_mask` criteria.\n+     * @param status_mask A bitmask representing the conditions to check against each block's nStatus.\n+     * @param lower_block An optional pointer to the `CBlockIndex` that serves as the lower boundary of\n+     *                    the search (inclusive). If `nullptr`, the search includes up to the genesis\n+     *                    block.\n+     * @return A (non-null) pointer to the `CBlockIndex` of the furthest away ancestor (including\n+     *         `upper_block` itself) that matches the `status_mask`, up to and including\n+     *         `lower_block` if it is part of the ancestry.\n+     */",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 24,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dd7696b97f20d756df1afa523a8f9e7bf3924c7d",
      "in_reply_to_id": 1583335298,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Taken, thanks!",
      "created_at": "2024-05-30T18:57:17Z",
      "updated_at": "2024-05-30T18:57:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295595",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295595"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 338,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 359,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295778",
      "pull_request_review_id": 2089159738,
      "id": 1621295778,
      "node_id": "PRRC_kwDOABII585gowKi",
      "diff_hunk": "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "in_reply_to_id": 1583472496,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ok, passing CChain and BlockMan as parameters now.",
      "created_at": "2024-05-30T18:57:23Z",
      "updated_at": "2024-05-30T18:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295778",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295778"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295907",
      "pull_request_review_id": 2089159896,
      "id": 1621295907,
      "node_id": "PRRC_kwDOABII585gowMj",
      "diff_hunk": "@@ -782,6 +782,21 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n+\n+    if (first_block->nHeight == 0) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return Assert(first_block->pprev)->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4e62129d8aed839c83fa4a595aab06ed5ca7eeb6",
      "in_reply_to_id": 1583398465,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Taken, thanks!",
      "created_at": "2024-05-30T18:57:28Z",
      "updated_at": "2024-05-30T18:57:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621295907",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621295907"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 793,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 797,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621298451",
      "pull_request_review_id": 2089163324,
      "id": 1621298451,
      "node_id": "PRRC_kwDOABII585gow0T",
      "diff_hunk": "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "in_reply_to_id": 1583515582,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I have adopted these changes with minor edits and that addresses your previous comment about the genesis behavior as well.",
      "created_at": "2024-05-30T18:59:07Z",
      "updated_at": "2024-05-30T18:59:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621298451",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621298451"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 794,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621299243",
      "pull_request_review_id": 2089164503,
      "id": 1621299243,
      "node_id": "PRRC_kwDOABII585goxAr",
      "diff_hunk": "@@ -787,10 +787,14 @@ static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EX\n     AssertLockHeld(::cs_main);\n \n     const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n-    if (!(chain_tip.nStatus & BLOCK_HAVE_DATA)) return chain_tip.nHeight;\n-    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, BLOCK_HAVE_DATA)};\n-\n-    if (first_block->nHeight == 0) {\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "61f352d6bcf485862815fdd68064cc07ea8ab6ce",
      "in_reply_to_id": 1583454227,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Addressed in the other comment on this commit",
      "created_at": "2024-05-30T18:59:46Z",
      "updated_at": "2024-05-30T18:59:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1621299243",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1621299243"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 791,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624501620",
      "pull_request_review_id": 2093944753,
      "id": 1624501620,
      "node_id": "PRRC_kwDOABII585g0-10",
      "diff_hunk": "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In dca1ca1f56d8e63929eb7aea64f8fb3e01752357: I think `BlockManager::GetFirstBlock()` can be made `const`, which allows us to pass a `const BlockManager& blockman` here:\r\n\r\n<details>\r\n<summary>git diff on dca1ca1f56</summary>\r\n\r\n```diff\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex 18eb2dc1aa..6dbc111eb6 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -595,7 +595,7 @@ bool BlockManager::IsBlockPruned(const CBlockIndex& block)\r\n     return m_have_pruned && !(block.nStatus & BLOCK_HAVE_DATA) && (block.nTx > 0);\r\n }\r\n \r\n-const CBlockIndex* BlockManager::GetFirstBlock(const CBlockIndex& upper_block, uint32_t status_mask, const CBlockIndex* lower_block)\r\n+const CBlockIndex* BlockManager::GetFirstBlock(const CBlockIndex& upper_block, uint32_t status_mask, const CBlockIndex* lower_block) const\r\n {\r\n     AssertLockHeld(::cs_main);\r\n     const CBlockIndex* last_block = &upper_block;\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 917d75232d..d1e46fde2b 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -361,7 +361,7 @@ public:\r\n         const CBlockIndex& upper_block LIFETIMEBOUND,\r\n         uint32_t status_mask,\r\n         const CBlockIndex* lower_block = nullptr\r\n-    ) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    ) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     /** True if any block files have ever been pruned. */\r\n     bool m_have_pruned = false;\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 90cee9901d..b99abe545d 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -783,7 +783,7 @@ static RPCHelpMan getblock()\r\n }\r\n \r\n //! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+static std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\n\r\n```\r\n</details>\r\n",
      "created_at": "2024-06-03T13:52:31Z",
      "updated_at": "2024-06-03T16:24:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624501620",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624501620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624683314",
      "pull_request_review_id": 2093944753,
      "id": 1624683314,
      "node_id": "PRRC_kwDOABII585g1rMy",
      "diff_hunk": "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think this is buggy, chain tip should be considered pruned if any of the `BLOCK_HAVE_MASK` flags are missing:\r\n\r\n```suggestion\r\n    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;\r\n```\r\n\r\nCan be verified by adding unit test to the first commit, which passes on dca1ca1f56 and fails on current HEAD for `CheckGetPruneHeight(blockman, chain, 100)`:\r\n\r\n```\r\n$ ./src/test/test_bitcoin --run_test=blockchain_tests/get_prune_height\r\n...\r\nRunning 1 test case...\r\nAssertion failed: ((last_block->nStatus & status_mask) == status_mask), function GetFirstBlock, file blockstorage.cpp, line 602.\r\nunknown location:0: fatal error: in \"blockchain_tests/get_prune_height\": signal: SIGABRT (application abort requested)\r\ntest/blockchain_tests.cpp:93: last checkpoint\r\n```\r\n\r\n<details>\r\n<summary>git diff on dca1ca1f56</summary>\r\n\r\n```diff\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex 90cee9901d..b7c1bc9673 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -783,7 +783,7 @@ static RPCHelpMan getblock()\r\n }\r\n \r\n //! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\ndiff --git a/src/rpc/blockchain.h b/src/rpc/blockchain.h\r\nindex c2021c3608..d9bf627df5 100644\r\n--- a/src/rpc/blockchain.h\r\n+++ b/src/rpc/blockchain.h\r\n@@ -21,6 +21,7 @@ class CBlockIndex;\r\n class Chainstate;\r\n class UniValue;\r\n namespace node {\r\n+class BlockManager;\r\n struct NodeContext;\r\n } // namespace node\r\n \r\n@@ -57,4 +58,7 @@ UniValue CreateUTXOSnapshot(\r\n     const fs::path& path,\r\n     const fs::path& tmppath);\r\n \r\n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n+std::optional<int> GetPruneHeight(node::BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+\r\n #endif // BITCOIN_RPC_BLOCKCHAIN_H\r\ndiff --git a/src/test/blockchain_tests.cpp b/src/test/blockchain_tests.cpp\r\nindex be515a9eac..2a63d09795 100644\r\n--- a/src/test/blockchain_tests.cpp\r\n+++ b/src/test/blockchain_tests.cpp\r\n@@ -5,7 +5,9 @@\r\n #include <boost/test/unit_test.hpp>\r\n \r\n #include <chain.h>\r\n+#include <node/blockstorage.h>\r\n #include <rpc/blockchain.h>\r\n+#include <sync.h>\r\n #include <test/util/setup_common.h>\r\n #include <util/string.h>\r\n \r\n@@ -74,4 +76,36 @@ BOOST_AUTO_TEST_CASE(get_difficulty_for_very_high_target)\r\n     TestDifficulty(0x12345678, 5913134931067755359633408.0);\r\n }\r\n \r\n+//! Prune chain from height down to genesis block and check that\r\n+//! GetPruneHeight returns the correct value\r\n+static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+{\r\n+    AssertLockHeld(::cs_main);\r\n+\r\n+    // Emulate pruning all blocks from `height` down to the genesis block\r\n+    // by unsetting the `BLOCK_HAVE_DATA` flag from `nStatus`\r\n+    for (CBlockIndex* it{chain[height]}; it != nullptr && it->nHeight > 0; it = it->pprev) {\r\n+        it->nStatus &= ~BLOCK_HAVE_DATA;\r\n+    }\r\n+\r\n+    const auto prune_height{GetPruneHeight(blockman, chain)};\r\n+    BOOST_REQUIRE(prune_height.has_value());\r\n+    BOOST_CHECK_EQUAL(*prune_height, height);\r\n+}\r\n+\r\n+BOOST_FIXTURE_TEST_CASE(get_prune_height, TestChain100Setup)\r\n+{\r\n+    LOCK(::cs_main);\r\n+    auto& chain = m_node.chainman->ActiveChain();\r\n+    auto& blockman = m_node.chainman->m_blockman;\r\n+\r\n+    // Fresh chain of 100 blocks without any pruned blocks, so std::nullopt should be returned\r\n+    BOOST_CHECK(!GetPruneHeight(blockman, chain).has_value());\r\n+\r\n+    // Start pruning\r\n+    CheckGetPruneHeight(blockman, chain, 1);\r\n+    CheckGetPruneHeight(blockman, chain, 99);\r\n+    CheckGetPruneHeight(blockman, chain, 100);\r\n+}\r\n+\r\n BOOST_AUTO_TEST_SUITE_END()\r\n\r\n```\r\n</details>\r\n",
      "created_at": "2024-06-03T15:42:53Z",
      "updated_at": "2024-06-03T16:24:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624683314"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 800,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624721555",
      "pull_request_review_id": 2093944753,
      "id": 1624721555,
      "node_id": "PRRC_kwDOABII585g10iT",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582976807,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I don't think this is fully addressed in 0501ec102f3740049bd2e891cd83527c31b29222 - would update to `return Assert(first_unpruned.pprev)->nHeight;`?",
      "created_at": "2024-06-03T16:10:29Z",
      "updated_at": "2024-06-03T16:24:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624721555",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624721555"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 801,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624736686",
      "pull_request_review_id": 2093944753,
      "id": 1624736686,
      "node_id": "PRRC_kwDOABII585g14Ou",
      "diff_hunk": "@@ -494,5 +499,19 @@ def test_scanblocks_pruned(self):\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n             \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n \n+    def test_pruneheight_undo_presence(self):\n+        node = self.nodes[2]\n+        pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n+        fetch_block = node.getblockhash(pruneheight - 1)\n+\n+        self.connect_nodes(1, 2)\n+        peers = node.getpeerinfo()\n+        peer_id = peers[0][\"id\"]\n+        node.getblockfrompeer(fetch_block, peer_id)",
      "path": "test/functional/feature_pruning.py",
      "position": null,
      "original_position": 33,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `peer_id` makes things less readable imo\r\n```suggestion\r\n        node.getblockfrompeer(fetch_block, peers[0][\"id\"])\r\n```",
      "created_at": "2024-06-03T16:20:55Z",
      "updated_at": "2024-06-03T16:24:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624736686",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624736686"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 509,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624762665",
      "pull_request_review_id": 2094387578,
      "id": 1624762665,
      "node_id": "PRRC_kwDOABII585g1-kp",
      "diff_hunk": "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned",
      "path": "src/rpc/blockchain.cpp",
      "position": 12,
      "original_position": 4,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"refactor, blockstorage: Generalize GetFirstStoredBlock\" (dca1ca1f56d8e63929eb7aea64f8fb3e01752357)\r\n\r\nI think the code would be simpler (and have fewer cases to think about) if this function just returned -1 when no blocks were pruned, instead of nullopt:\r\n\r\n```diff\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -782,8 +782,8 @@ static RPCHelpMan getblock()\r\n     };\r\n }\r\n \r\n-//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\r\n-static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+//! Return height of highest block that has been pruned, or -1 if no blocks have been pruned\r\n+int GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n     AssertLockHeld(::cs_main);\r\n \r\n     const CBlockIndex* chain_tip{chain.Tip()};\r\n@@ -794,7 +794,7 @@ static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& c\r\n     const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\r\n     if (!first_unpruned.pprev) {\r\n        // No block before the first unpruned block means nothing is pruned.\r\n-       return std::nullopt;\r\n+       return -1;\r\n     }\r\n     // Block before the first unpruned block is the last pruned block.\r\n     return first_unpruned.pprev->nHeight;\r\n@@ -852,7 +852,7 @@ static RPCHelpMan pruneblockchain()\r\n     }\r\n \r\n     PruneBlockFilesManual(active_chainstate, height);\r\n-    return GetPruneHeight(chainman.m_blockman, active_chain).value_or(-1);\r\n+    return GetPruneHeight(chainman.m_blockman, active_chain);\r\n },\r\n     };\r\n }\r\n@@ -1305,8 +1305,7 @@ RPCHelpMan getblockchaininfo()\r\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\r\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\r\n     if (chainman.m_blockman.IsPruneMode()) {\r\n-        const auto prune_height{GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain)};\r\n-        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);\r\n+        obj.pushKV(\"pruneheight\", GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain) + 1);\r\n \r\n         const bool automatic_pruning{chainman.m_blockman.GetPruneTarget() != BlockManager::PRUNE_TARGET_MANUAL};\r\n         obj.pushKV(\"automatic_pruning\",  automatic_pruning);\r\n```\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2024-06-03T16:42:19Z",
      "updated_at": "2024-06-03T16:55:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624762665",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624762665"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 786,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624770978",
      "pull_request_review_id": 2094387578,
      "id": 1624770978,
      "node_id": "PRRC_kwDOABII585g2Ami",
      "diff_hunk": "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "in_reply_to_id": 1624683314,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624683314\r\n\r\n> I think this is buggy, chain tip should be considered pruned if any of the `BLOCK_HAVE_MASK` flags are missing:\r\n\r\nNice catch! Would be great to add the test to the first commit.",
      "created_at": "2024-06-03T16:48:58Z",
      "updated_at": "2024-06-03T16:54:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1624770978",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1624770978"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 800,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739144",
      "pull_request_review_id": 2133850334,
      "id": 1649739144,
      "node_id": "PRRC_kwDOABII585iVQWI",
      "diff_hunk": "@@ -494,5 +499,19 @@ def test_scanblocks_pruned(self):\n         assert_raises_rpc_error(-1, \"Block not available (pruned data)\", node.scanblocks,\n             \"start\", [{\"desc\": f\"raw({false_positive_spk.hex()})\"}], 0, 0, \"basic\", {\"filter_false_positives\": True})\n \n+    def test_pruneheight_undo_presence(self):\n+        node = self.nodes[2]\n+        pruneheight = node.getblockchaininfo()[\"pruneheight\"]\n+        fetch_block = node.getblockhash(pruneheight - 1)\n+\n+        self.connect_nodes(1, 2)\n+        peers = node.getpeerinfo()\n+        peer_id = peers[0][\"id\"]\n+        node.getblockfrompeer(fetch_block, peer_id)",
      "path": "test/functional/feature_pruning.py",
      "position": null,
      "original_position": 33,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "in_reply_to_id": 1624736686,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-06-22T16:19:50Z",
      "updated_at": "2024-06-22T16:19:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739144",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739144"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": 509,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739149",
      "pull_request_review_id": 2133850341,
      "id": 1649739149,
      "node_id": "PRRC_kwDOABII585iVQWN",
      "diff_hunk": "@@ -782,6 +783,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned\n+static std::optional<int> GetPruneHeight(const Chainstate& active_chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    const CBlockIndex& chain_tip{*CHECK_NONFATAL(active_chainstate.m_chain.Tip())};\n+    // Check for both data and undo data\n+    if (!(chain_tip.nStatus & BLOCK_HAVE_MASK)) return chain_tip.nHeight;\n+    const auto first_block{active_chainstate.m_blockman.GetFirstBlock(chain_tip, /*status_mask=*/BLOCK_HAVE_MASK)};\n+\n+    // Result can never be 0 because genesis block is never pruned, so the\n+    // result 1 means that no block has been pruned.\n+    if (first_block->nHeight == 1) {\n+        return std::nullopt;\n+    }\n+    // The block before the block with all data is the last that was pruned\n+    return first_block->pprev->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "edbb6a3eb18c43ff20574a534143c40e0a84befe",
      "in_reply_to_id": 1582976807,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not sure why this is still needed when we return above if `!first_unpruned.pprev` but I've added it since it won't hurt.",
      "created_at": "2024-06-22T16:19:53Z",
      "updated_at": "2024-06-22T16:19:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739149",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 801,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739156",
      "pull_request_review_id": 2133850352,
      "id": 1649739156,
      "node_id": "PRRC_kwDOABII585iVQWU",
      "diff_hunk": "@@ -782,6 +783,32 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    AssertLockHeld(::cs_main);\n+\n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n+    const CBlockIndex* chain_tip{chain.Tip()};\n+\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!(chain_tip->nStatus & BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "0501ec102f3740049bd2e891cd83527c31b29222",
      "in_reply_to_id": 1624683314,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Cool, thanks! Added the fix and the test.",
      "created_at": "2024-06-22T16:20:00Z",
      "updated_at": "2024-06-22T16:20:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739156",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739156"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 800,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739250",
      "pull_request_review_id": 2133850453,
      "id": 1649739250,
      "node_id": "PRRC_kwDOABII585iVQXy",
      "diff_hunk": "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned",
      "path": "src/rpc/blockchain.cpp",
      "position": 12,
      "original_position": 4,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "in_reply_to_id": 1624762665,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I disagree here. I think this is the correct use of an optional when we may or may not have a value to return. And I think it's easier to understand because the code is more expressive. Handing a magical `-1` around is just not intuitive IMO.",
      "created_at": "2024-06-22T16:20:56Z",
      "updated_at": "2024-06-22T16:20:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739250",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739250"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 786,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739281",
      "pull_request_review_id": 2133850475,
      "id": 1649739281,
      "node_id": "PRRC_kwDOABII585iVQYR",
      "diff_hunk": "@@ -782,6 +782,24 @@ static RPCHelpMan getblock()\n     };\n }\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+static std::optional<int> GetPruneHeight(BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {",
      "path": "src/rpc/blockchain.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "dca1ca1f56d8e63929eb7aea64f8fb3e01752357",
      "in_reply_to_id": 1624501620,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-06-22T16:21:11Z",
      "updated_at": "2024-06-22T16:21:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1649739281",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1649739281"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650127334",
      "pull_request_review_id": 2134340911,
      "id": 1650127334,
      "node_id": "PRRC_kwDOABII585iWvHm",
      "diff_hunk": "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "path": "src/rpc/blockchain.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": null,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "q: is the \"undo data\" term well known outside of core? It seems to be an implementation detail to me. Maybe, could write this differently: \"The block data will be stored alone; there will be no available information associated with the outputs this block spent. This limits the usage.. etc\".",
      "created_at": "2024-06-23T16:48:29Z",
      "updated_at": "2024-06-23T16:48:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650127334",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650127334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 432,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650196258",
      "pull_request_review_id": 2134420970,
      "id": 1650196258,
      "node_id": "PRRC_kwDOABII585iW_8i",
      "diff_hunk": "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "path": "src/rpc/blockchain.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": 1650127334,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Hm, not sure how much it is known but it is referenced in other places already, like the `getblock` RPC help. And I'm not sure if a more generic text helps more people because it's a quite technical reason and I don't know how to explain it in a way that works for everyone and is still concise. With the term undo data people at least have something they can search on Bitcoin SE etc.",
      "created_at": "2024-06-23T22:19:31Z",
      "updated_at": "2024-06-23T22:19:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1650196258",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1650196258"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 432,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651043128",
      "pull_request_review_id": 2135821455,
      "id": 1651043128,
      "node_id": "PRRC_kwDOABII585iaOs4",
      "diff_hunk": "@@ -429,6 +429,7 @@ static RPCHelpMan getblockfrompeer()\n         \"getblockfrompeer\",\n         \"Attempt to fetch block from a given peer.\\n\\n\"\n         \"We must have the header for this block, e.g. using submitheader.\\n\"\n+        \"The block will not have any undo data which can limit the usage of the block data in a context where the undo data is needed.\\n\"",
      "path": "src/rpc/blockchain.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": 1650127334,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I don't know how to explain it in a way that works for everyone and is still concise\r\n\r\nNo problem on leaving it as is if there is other RPC command using this term.\r\nWhat I wrote seems generally useful to me; it means that the node might not be able to access the spent outputs script and value. Maybe adding few scenarios where the undo data is needed could clarify it usage.",
      "created_at": "2024-06-24T13:31:18Z",
      "updated_at": "2024-06-24T14:43:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651043128",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651043128"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 432,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651079954",
      "pull_request_review_id": 2135821455,
      "id": 1651079954,
      "node_id": "PRRC_kwDOABII585iaXsS",
      "diff_hunk": "@@ -1288,8 +1314,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "path": "src/rpc/blockchain.cpp",
      "position": 58,
      "original_position": 58,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": null,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "little topic: \r\nmaybe changing the RPC docs to say that \"pruneheight\" returns \"the first block unpruned, all previous blocks were pruned\" is more useful than saying \"height of the last block pruned, plus one\" as is now.",
      "created_at": "2024-06-24T13:55:03Z",
      "updated_at": "2024-06-24T14:43:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651079954",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651079954"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": 1317,
      "original_start_line": 1317,
      "start_side": "RIGHT",
      "line": 1318,
      "original_line": 1318,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651138486",
      "pull_request_review_id": 2135982014,
      "id": 1651138486,
      "node_id": "PRRC_kwDOABII585ial-2",
      "diff_hunk": "@@ -57,4 +58,7 @@ UniValue CreateUTXOSnapshot(\n     const fs::path& path,\n     const fs::path& tmppath);\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+std::optional<int> GetPruneHeight(const node::BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/rpc/blockchain.h",
      "position": 13,
      "original_position": 13,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: missing some includes / fwd decls for the newly added line:\r\n\r\n<details>\r\n<summary>git diff on 8789dc8f31</summary>\r\n\r\n```diff\r\ndiff --git a/src/rpc/blockchain.h b/src/rpc/blockchain.h\r\nindex f6a7fe236c..23909c334e 100644\r\n--- a/src/rpc/blockchain.h\r\n+++ b/src/rpc/blockchain.h\r\n@@ -9,15 +9,18 @@\r\n #include <core_io.h>\r\n #include <streams.h>\r\n #include <sync.h>\r\n+#include <threadsafety.h>\r\n #include <util/fs.h>\r\n #include <validation.h>\r\n \r\n #include <any>\r\n+#include <optional>\r\n #include <stdint.h>\r\n #include <vector>\r\n \r\n class CBlock;\r\n class CBlockIndex;\r\n+class CChain;\r\n class Chainstate;\r\n class UniValue;\r\n namespace node {\r\n\r\n```\r\n</details>\r\n",
      "created_at": "2024-06-24T14:27:59Z",
      "updated_at": "2024-06-24T14:45:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651138486",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651138486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 62,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651153859",
      "pull_request_review_id": 2135982014,
      "id": 1651153859,
      "node_id": "PRRC_kwDOABII585iapvD",
      "diff_hunk": "@@ -74,4 +76,36 @@ BOOST_AUTO_TEST_CASE(get_difficulty_for_very_high_target)\n     TestDifficulty(0x12345678, 5913134931067755359633408.0);\n }\n \n+//! Prune chain from height down to genesis block and check that\n+//! GetPruneHeight returns the correct value\n+static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/test/blockchain_tests.cpp",
      "position": 16,
      "original_position": 16,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": null,
      "user": {
        "login": "stickies-v",
        "id": 69010457,
        "node_id": "MDQ6VXNlcjY5MDEwNDU3",
        "avatar_url": "https://avatars.githubusercontent.com/u/69010457?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/stickies-v",
        "html_url": "https://github.com/stickies-v",
        "followers_url": "https://api.github.com/users/stickies-v/followers",
        "following_url": "https://api.github.com/users/stickies-v/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/stickies-v/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/stickies-v/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/stickies-v/subscriptions",
        "organizations_url": "https://api.github.com/users/stickies-v/orgs",
        "repos_url": "https://api.github.com/users/stickies-v/repos",
        "events_url": "https://api.github.com/users/stickies-v/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/stickies-v/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit\r\n```suggestion\r\nstatic void CheckGetPruneHeight(const node::BlockManager& blockman, const CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n```\r\n\r\nand related:\r\n\r\n<details>\r\n<summary>git diff on 8789dc8f31</summary>\r\n\r\n```diff\r\ndiff --git a/src/test/blockchain_tests.cpp b/src/test/blockchain_tests.cpp\r\nindex 2a63d09795..7a5d175c8c 100644\r\n--- a/src/test/blockchain_tests.cpp\r\n+++ b/src/test/blockchain_tests.cpp\r\n@@ -96,8 +96,8 @@ static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int\r\n BOOST_FIXTURE_TEST_CASE(get_prune_height, TestChain100Setup)\r\n {\r\n     LOCK(::cs_main);\r\n-    auto& chain = m_node.chainman->ActiveChain();\r\n-    auto& blockman = m_node.chainman->m_blockman;\r\n+    const auto& chain = m_node.chainman->ActiveChain();\r\n+    const auto& blockman = m_node.chainman->m_blockman;\r\n \r\n     // Fresh chain of 100 blocks without any pruned blocks, so std::nullopt should be returned\r\n     BOOST_CHECK(!GetPruneHeight(blockman, chain).has_value());\r\n\r\n```\r\n</details>\r\n",
      "created_at": "2024-06-24T14:37:17Z",
      "updated_at": "2024-06-24T14:45:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651153859",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651153859"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 81,
      "original_line": 81,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651156361",
      "pull_request_review_id": 2135821455,
      "id": 1651156361,
      "node_id": "PRRC_kwDOABII585iaqWJ",
      "diff_hunk": "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;\n+\n+    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\n+    if (&first_unpruned == first_block) {",
      "path": "src/rpc/blockchain.cpp",
      "position": 29,
      "original_position": 24,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4a1975008b602aeacdad9a74d1837a7455148074",
      "in_reply_to_id": null,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Can remove the back and forth.\r\n```suggestion\r\n    const CBlockIndex* first_unpruned{Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\r\n    if (first_unpruned == first_block) {\r\n```",
      "created_at": "2024-06-24T14:38:50Z",
      "updated_at": "2024-06-24T14:44:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651156361",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651156361"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": 802,
      "original_start_line": 801,
      "start_side": "RIGHT",
      "line": 803,
      "original_line": 802,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651160369",
      "pull_request_review_id": 2135821455,
      "id": 1651160369,
      "node_id": "PRRC_kwDOABII585iarUx",
      "diff_hunk": "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": 26,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4a1975008b602aeacdad9a74d1837a7455148074",
      "in_reply_to_id": null,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "could be simpler:\r\n```suggestion\r\n    if ((chain_tip->nStatus & BLOCK_HAVE_MASK) != BLOCK_HAVE_MASK) return chain_tip->nHeight;\r\n```",
      "created_at": "2024-06-24T14:41:29Z",
      "updated_at": "2024-06-24T14:43:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1651160369",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1651160369"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 800,
      "original_line": 799,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146166",
      "pull_request_review_id": 2175253435,
      "id": 1676146166,
      "node_id": "PRRC_kwDOABII585j5_X2",
      "diff_hunk": "@@ -74,4 +76,36 @@ BOOST_AUTO_TEST_CASE(get_difficulty_for_very_high_target)\n     TestDifficulty(0x12345678, 5913134931067755359633408.0);\n }\n \n+//! Prune chain from height down to genesis block and check that\n+//! GetPruneHeight returns the correct value\n+static void CheckGetPruneHeight(node::BlockManager& blockman, CChain& chain, int height) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/test/blockchain_tests.cpp",
      "position": 16,
      "original_position": 16,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": 1651153859,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done in #29770",
      "created_at": "2024-07-12T16:02:18Z",
      "updated_at": "2024-07-12T16:02:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1676146166",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146166"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 81,
      "original_line": 81,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146312",
      "pull_request_review_id": 2175253649,
      "id": 1676146312,
      "node_id": "PRRC_kwDOABII585j5_aI",
      "diff_hunk": "@@ -57,4 +58,7 @@ UniValue CreateUTXOSnapshot(\n     const fs::path& path,\n     const fs::path& tmppath);\n \n+//! Return height of highest block that has been pruned, or std::nullopt if no blocks have been pruned\n+std::optional<int> GetPruneHeight(const node::BlockManager& blockman, const CChain& chain) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "path": "src/rpc/blockchain.h",
      "position": 13,
      "original_position": 13,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": 1651138486,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done in #29770",
      "created_at": "2024-07-12T16:02:25Z",
      "updated_at": "2024-07-12T16:02:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1676146312",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146312"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 62,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146409",
      "pull_request_review_id": 2175253740,
      "id": 1676146409,
      "node_id": "PRRC_kwDOABII585j5_bp",
      "diff_hunk": "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;",
      "path": "src/rpc/blockchain.cpp",
      "position": 26,
      "original_position": 21,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4a1975008b602aeacdad9a74d1837a7455148074",
      "in_reply_to_id": 1651160369,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done in #29770",
      "created_at": "2024-07-12T16:02:29Z",
      "updated_at": "2024-07-12T16:02:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1676146409",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146409"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 800,
      "original_line": 799,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146466",
      "pull_request_review_id": 2175253804,
      "id": 1676146466,
      "node_id": "PRRC_kwDOABII585j5_ci",
      "diff_hunk": "@@ -786,16 +786,24 @@ static RPCHelpMan getblock()\n std::optional<int> GetPruneHeight(const BlockManager& blockman, const CChain& chain) {\n     AssertLockHeld(::cs_main);\n \n+    // Search for the last block missing block data or undo data. Don't let the\n+    // search consider the genesis block, because the genesis block does not\n+    // have undo data, but should not be considered pruned.\n+    const CBlockIndex* first_block{chain[1]};\n     const CBlockIndex* chain_tip{chain.Tip()};\n-    if (!(chain_tip->nStatus & BLOCK_HAVE_DATA)) return chain_tip->nHeight;\n \n-    // Get first block with data, after the last block without data.\n-    // This is the start of the unpruned range of blocks.\n-    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_DATA))};\n-    if (!first_unpruned.pprev) {\n-       // No block before the first unpruned block means nothing is pruned.\n-       return std::nullopt;\n+    // If there are no blocks after the genesis block, or no blocks at all, nothing is pruned.\n+    if (!first_block || !chain_tip) return std::nullopt;\n+\n+    // If the chain tip is pruned, everything is pruned.\n+    if (!((chain_tip->nStatus & BLOCK_HAVE_MASK) == BLOCK_HAVE_MASK)) return chain_tip->nHeight;\n+\n+    const auto& first_unpruned{*Assert(blockman.GetFirstBlock(*chain_tip, /*status_mask=*/BLOCK_HAVE_MASK, first_block))};\n+    if (&first_unpruned == first_block) {",
      "path": "src/rpc/blockchain.cpp",
      "position": 29,
      "original_position": 24,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "4a1975008b602aeacdad9a74d1837a7455148074",
      "in_reply_to_id": 1651156361,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done in #29770",
      "created_at": "2024-07-12T16:02:31Z",
      "updated_at": "2024-07-12T16:02:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1676146466",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146466"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": 802,
      "original_start_line": 801,
      "start_side": "RIGHT",
      "line": 803,
      "original_line": 802,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146524",
      "pull_request_review_id": 2175253886,
      "id": 1676146524,
      "node_id": "PRRC_kwDOABII585j5_dc",
      "diff_hunk": "@@ -1288,8 +1314,8 @@ RPCHelpMan getblockchaininfo()\n     obj.pushKV(\"size_on_disk\", chainman.m_blockman.CalculateCurrentUsage());\n     obj.pushKV(\"pruned\", chainman.m_blockman.IsPruneMode());\n     if (chainman.m_blockman.IsPruneMode()) {\n-        bool has_tip_data = tip.nStatus & BLOCK_HAVE_DATA;\n-        obj.pushKV(\"pruneheight\", has_tip_data ? chainman.m_blockman.GetFirstStoredBlock(tip)->nHeight : tip.nHeight + 1);\n+        const auto prune_height{GetPruneHeight(chainman.m_blockman, active_chainstate.m_chain)};\n+        obj.pushKV(\"pruneheight\", prune_height ? prune_height.value() + 1 : 0);",
      "path": "src/rpc/blockchain.cpp",
      "position": 58,
      "original_position": 58,
      "commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "original_commit_id": "8789dc8f315a9d9ad7142d831bc9412f780248e7",
      "in_reply_to_id": 1651079954,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "sounds good, taken as you suggested in #29770",
      "created_at": "2024-07-12T16:02:34Z",
      "updated_at": "2024-07-12T16:02:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29668#discussion_r1676146524",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1676146524"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29668"
        }
      },
      "start_line": 1317,
      "original_start_line": 1317,
      "start_side": "RIGHT",
      "line": 1318,
      "original_line": 1318,
      "side": "RIGHT"
    }
  ]
}