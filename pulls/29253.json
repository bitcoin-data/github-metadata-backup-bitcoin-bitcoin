{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
    "id": 1679974105,
    "node_id": "PR_kwDOABII585kIl7Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/29253",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/29253.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/29253.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/b298242c8d495c36072415e1b95eaa7bf485a38a",
    "number": 29253,
    "state": "closed",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "wallet: guard against dangling to-be-reverted db transactions",
    "user": {
      "login": "furszy",
      "id": 5377650,
      "node_id": "MDQ6VXNlcjUzNzc2NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/furszy",
      "html_url": "https://github.com/furszy",
      "followers_url": "https://api.github.com/users/furszy/followers",
      "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
      "organizations_url": "https://api.github.com/users/furszy/orgs",
      "repos_url": "https://api.github.com/users/furszy/repos",
      "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/furszy/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Discovered while was reviewing #29112, specifically https://github.com/bitcoin/bitcoin/pull/29112#pullrequestreview-1821862931.\r\n\r\nIf the db handler that initiated the database transaction is destroyed,\r\nthe ongoing transaction cannot be left dangling when the db txn fails\r\nto abort. It must be forcefully reverted; otherwise, any subsequent\r\ndb handler executing a write operation will dump the dangling,\r\nto-be-reverted transaction data to disk.\r\n\r\nThis not only breaks the isolation property but also results in the\r\nimproper storage of incomplete information on disk, impacting\r\nthe wallet consistency.\r\n\r\nThis PR fixes the issue by resetting the db connection, automatically\r\nrolling back the transaction (per https://www.sqlite.org/c3ref/close.html)\r\nwhen the handler object is being destroyed and the txn abortion failed.\r\n\r\nTesting Notes\r\nCan verify the failure by reverting the fix e5217fea and running the test.\r\nIt will fail without e5217fea and pass with it.",
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      },
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/61",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61/labels",
      "id": 9334188,
      "node_id": "MI_kwDOABII584Ajm2s",
      "number": 61,
      "state": "open",
      "title": "27.0",
      "description": "",
      "creator": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 6,
      "closed_issues": 37,
      "created_at": "2023-04-27T08:01:57Z",
      "updated_at": "2024-01-31T21:36:39Z"
    },
    "created_at": "2024-01-16T00:41:40Z",
    "updated_at": "2024-02-01T12:48:39Z",
    "closed_at": "2024-01-31T20:22:57Z",
    "mergeable_state": "unknown",
    "merged_at": "2024-01-31T20:22:57Z",
    "merge_commit_sha": "a01da41112387fd50553e8a5f203589f04f6e942",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "furszy:2024_wallet_db_dangling_txn",
      "ref": "2024_wallet_db_dangling_txn",
      "sha": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 143624913,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDM2MjQ5MTM=",
        "name": "bitcoin-core",
        "full_name": "furszy/bitcoin-core",
        "owner": {
          "login": "furszy",
          "id": 5377650,
          "node_id": "MDQ6VXNlcjUzNzc2NTA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/furszy",
          "html_url": "https://github.com/furszy",
          "followers_url": "https://api.github.com/users/furszy/followers",
          "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
          "organizations_url": "https://api.github.com/users/furszy/orgs",
          "repos_url": "https://api.github.com/users/furszy/repos",
          "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/furszy/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/furszy/bitcoin-core",
        "description": "Bitcoin-Core",
        "fork": true,
        "url": "https://api.github.com/repos/furszy/bitcoin-core",
        "archive_url": "https://api.github.com/repos/furszy/bitcoin-core/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/furszy/bitcoin-core/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/furszy/bitcoin-core/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/furszy/bitcoin-core/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/furszy/bitcoin-core/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/furszy/bitcoin-core/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/furszy/bitcoin-core/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/furszy/bitcoin-core/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/furszy/bitcoin-core/contributors",
        "deployments_url": "https://api.github.com/repos/furszy/bitcoin-core/deployments",
        "downloads_url": "https://api.github.com/repos/furszy/bitcoin-core/downloads",
        "events_url": "https://api.github.com/repos/furszy/bitcoin-core/events",
        "forks_url": "https://api.github.com/repos/furszy/bitcoin-core/forks",
        "git_commits_url": "https://api.github.com/repos/furszy/bitcoin-core/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/furszy/bitcoin-core/git/tags%7B/sha%7D",
        "git_url": "git://github.com/furszy/bitcoin-core.git",
        "issue_comment_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/furszy/bitcoin-core/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/furszy/bitcoin-core/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/furszy/bitcoin-core/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/furszy/bitcoin-core/languages",
        "merges_url": "https://api.github.com/repos/furszy/bitcoin-core/merges",
        "milestones_url": "https://api.github.com/repos/furszy/bitcoin-core/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/furszy/bitcoin-core/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/furszy/bitcoin-core/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/furszy/bitcoin-core/releases%7B/id%7D",
        "ssh_url": "git@github.com:furszy/bitcoin-core.git",
        "stargazers_url": "https://api.github.com/repos/furszy/bitcoin-core/stargazers",
        "statuses_url": "https://api.github.com/repos/furszy/bitcoin-core/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/furszy/bitcoin-core/subscribers",
        "subscription_url": "https://api.github.com/repos/furszy/bitcoin-core/subscription",
        "tags_url": "https://api.github.com/repos/furszy/bitcoin-core/tags",
        "teams_url": "https://api.github.com/repos/furszy/bitcoin-core/teams",
        "trees_url": "https://api.github.com/repos/furszy/bitcoin-core/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/furszy/bitcoin-core.git",
        "hooks_url": "https://api.github.com/repos/furszy/bitcoin-core/hooks",
        "svn_url": "https://github.com/furszy/bitcoin-core",
        "homepage": "",
        "language": "C++",
        "forks_count": 4,
        "stargazers_count": 2,
        "watchers_count": 2,
        "size": 391670,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-02-01T12:48:39Z",
        "created_at": "2018-08-05T15:28:43Z",
        "updated_at": "2023-08-30T13:12:58Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "cad2df24b396be403f13f372ec48ea14a90d7f06",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36655,
        "stargazers_count": 73649,
        "watchers_count": 73649,
        "size": 248166,
        "default_branch": "master",
        "open_issues_count": 688,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-02-01T12:52:19Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-02-01T11:35:20Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 129,
    "deletions": 9,
    "changed_files": 3,
    "commits": 5,
    "review_comments": 30,
    "comments": 8
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZkZjlmNjY5MDlhMzU0YTk1ZjRiN2M1ZjA5MmYwZTlmYmUxYmFhN2M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
      "tree": {
        "sha": "8e93b59d21a004b2f7806464800cdf1014afc88c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8e93b59d21a004b2f7806464800cdf1014afc88c"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 8e93b59d21a004b2f7806464800cdf1014afc88c\nparent 05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89\nauthor furszy <matiasfurszyfer@protonmail.com> 1703084833 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1705360162 -0300\n\ntest: wallet db, exercise deadlock after write failure\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWluyIACgkQXdI8zGhq\npiOfzw/6Az5/FcwvnrW5Zb9QTGZubQkEGERTDcqv4ZxykUUL76lKJ2FiV4waUKWP\nTQXFbzfZvwA8sVsg1sf7ve4rHr0YP1Kp92lUBMwjBQ9ikfeZQOt+91jSVQFW8TXr\nMnzV/maS/oimI/rPm0JUoOejBmvxYGN5ehRyrlJJY0iYsS+GUF9X7rgZy0Po7H8E\nQ6aaefWX3C2lTviIFylslUU1+x4pZA/a3sxm/y6LrrM/abBNL3gm1octxKAt28Xf\n61mAs8GWxhLY9qibk8/4hb1RtE7i5StFecaXxpgXN/ZzVUL4CQxSWwns2dcGwqpU\n3qyHq0M4aDtTqMYY3URfEm1K17Pq2rHBuPpy9Aa5MkS1cuVsKGdJnfyh5+xBK8hX\nWSaTRGUGrysQt7cKMbFeXRryF5AwwnuPihtARLahFoNcGpcSLLgR70Y3L/tt8SvQ\n/6anIpfYHFmloDgGeZtJbpodnHU5RuZmhltIa2IOordj2rKSni2p9hNBi2zC9N8H\nkVmiTdY7XUczIgsVL1WZ+Pj3nuMG1C1EDgdLJidD4ivlsFs5G4ByROjqwhfMCklS\nr+KBlvHr+IyAFIbCkmcLDVUItXsClKyL0u+681Pf5WkWo6lM6oKLhwi11GKEUvEH\nE+OVZvj5svE5InTBPpUalU5z4l3vFtslx42mF9vS/7dCjEZCLFs=\n=Xq7S\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89",
          "sha": "05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89"
        }
      ],
      "message": "test: wallet db, exercise deadlock after write failure",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:09:22Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-12-20T15:07:13Z"
      },
      "sha": "fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c"
    },
    {
      "event": "commented",
      "id": 1892913940,
      "node_id": "IC_kwDOABII585w05MU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:41:43Z",
      "updated_at": "2024-01-31T20:02:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29253).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1854204356), [achow101](https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919841411) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29112](https://github.com/bitcoin/bitcoin/pull/29112) (sqlite: Disallow writing from multiple `SQLiteBatch`s by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1892913940",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "labeled",
      "id": 11493057640,
      "node_id": "LE_lADOABII5858JbUhzwAAAAKtCiRo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11493057640",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:41:45Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:55:53Z",
      "updated_at": "2024-01-16T00:55:53Z",
      "source": {
        "issue": {
          "id": 2047565192,
          "node_id": "PR_kwDOABII585iT-Q8",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/29112",
          "number": 29112,
          "state": "open",
          "state_reason": null,
          "title": "sqlite: Disallow writing from multiple `SQLiteBatch`s",
          "body": "The way that we have configured SQLite to run means that only one database transaction can be open at a time. Typically, each individual read and write operation will be its own transaction that is opened and committed automatically by SQLite. However, sometimes we want these operations to be batched into a multi-statement transaction, so `SQLiteBatch::TxnBegin`, `SQLiteBatch::TxnCommit`, and `SQLiteBatch::TxnAbort` are used to manage the transaction of the database.\r\n\r\nHowever, once a db transaction is begun with one `SQLiteBatch`, any operations performed by another `SQLiteBatch` will also occur within the same transaction. Furthermore, those other `SQLiteBatch`s will not be expecting a transaction to be active, and will abort it once the `SQLiteBatch` is destructed. This is problematic as it will prevent some data from being written, and also cause the `SQLiteBatch` that opened the transaction in the first place to be in an unexpected state and throw an error.\r\n\r\nTo avoid this situation, we need to prevent the multiple batches from writing at the same time. Although SQLite does have facilities for doing that, they require the Write Ahead Log (WAL) mode, which is a feature that we explicitly chose to disable since it spread wallet data to multiple files. As such, we need to be handling the concurrency ourselves. To do so, I've implemented added a `CSemaphore` within `SQLiteDatabase` which will be used by any `SQLiteBatch` trying to do a write operation. `wait()` is called by `TxnBegin`, and at the beginning of `WriteKey`, `EraseKey`, and `ErasePrefix`. `post()` is called in `TxnCommit`, `TxnAbort` and at the end of `WriteKey`, `EraseKey`, and `ErasePrefix`. To avoid deadlocking on ` TxnBegin()` followed by a `WriteKey()`, `SQLiteBatch will now also track whether a transaction is in progress so that it knows whether to use the semaphore.\r\n\r\nThis issue is not a problem for BDB wallets since BDB uses WAL and provides transaction objects that must be used if an operation is to occur within a transaction. Specifically, we either pass a transaction pointer, or a nullptr, to all BDB operations, and this allows for concurrent transactions so it doesn't have this problem.\r\n\r\nFixes #29110",
          "user": {
            "login": "achow101",
            "id": 3782274,
            "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/achow101",
            "html_url": "https://github.com/achow101",
            "followers_url": "https://api.github.com/users/achow101/followers",
            "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
            "organizations_url": "https://api.github.com/users/achow101/orgs",
            "repos_url": "https://api.github.com/users/achow101/repos",
            "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/achow101/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "milestone": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61",
            "html_url": "https://github.com/bitcoin/bitcoin/milestone/61",
            "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61/labels",
            "id": 9334188,
            "node_id": "MI_kwDOABII584Ajm2s",
            "number": 61,
            "state": "open",
            "title": "27.0",
            "description": "",
            "creator": {
              "login": "sipa",
              "id": 548488,
              "node_id": "MDQ6VXNlcjU0ODQ4OA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/sipa",
              "html_url": "https://github.com/sipa",
              "followers_url": "https://api.github.com/users/sipa/followers",
              "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
              "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
              "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
              "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
              "organizations_url": "https://api.github.com/users/sipa/orgs",
              "repos_url": "https://api.github.com/users/sipa/repos",
              "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
              "received_events_url": "https://api.github.com/users/sipa/received_events",
              "type": "User",
              "site_admin": false
            },
            "open_issues": 6,
            "closed_issues": 37,
            "created_at": "2023-04-27T08:01:57Z",
            "updated_at": "2024-01-31T21:36:39Z"
          },
          "locked": false,
          "comments": 7,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29112",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/29112",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/29112.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/29112.patch"
          },
          "created_at": "2023-12-18T22:27:10Z",
          "updated_at": "2024-02-01T07:53:40Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T06:37:20Z",
      "updated_at": "2024-01-16T06:37:20Z",
      "source": {
        "issue": {
          "id": 1958204865,
          "node_id": "PR_kwDOABII585dlfBo",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/28710",
          "number": 28710,
          "state": "open",
          "state_reason": null,
          "title": "Remove the legacy wallet and BDB dependency",
          "body": "The final step of #20160.\r\n\r\nA bare minimum of legacy wallet code is kept in order to perform wallet migration. Migration of legacy wallets uses the independent BDB parser and a minimal `LegacyDataSPKM` that allows the legacy data to be loaded so that the migration can be completed.\r\n\r\nAll tests which tested legacy wallet behavior have been removed. The `--descriptors` and `--legacy-wallet` options are removed from the functional tests.\r\n\r\nBDB has been removed as a dependency and documentation have been updated to reflect that.\r\n\r\nDepends on #26596",
          "user": {
            "login": "achow101",
            "id": 3782274,
            "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/achow101",
            "html_url": "https://github.com/achow101",
            "followers_url": "https://api.github.com/users/achow101/followers",
            "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
            "organizations_url": "https://api.github.com/users/achow101/orgs",
            "repos_url": "https://api.github.com/users/achow101/repos",
            "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/achow101/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 955867938,
              "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
              "name": "Needs rebase",
              "description": "",
              "color": "cccccc",
              "default": false
            },
            {
              "id": 5334691551,
              "node_id": "LA_kwDOABII588AAAABPfju3w",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
              "name": "CI failed",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 2,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28710",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/28710",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/28710.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/28710.patch"
          },
          "created_at": "2023-10-23T23:36:07Z",
          "updated_at": "2024-01-25T21:20:32Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 1824875743,
      "node_id": "PRR_kwDOABII585sxWTf",
      "url": null,
      "actor": null,
      "commit_id": "fb9e1b3074ff5911b11fcfe918a59a843a2dbd64",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1824875743",
      "submitted_at": "2024-01-16T20:11:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11503442522,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAKtqJpa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11503442522",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T20:19:20Z"
    },
    {
      "event": "milestoned",
      "id": 11504178197,
      "node_id": "MIE_lADOABII5858JbUhzwAAAAKts9QV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11504178197",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T21:50:58Z",
      "milestone": {
        "title": "27.0"
      }
    },
    {
      "event": "comment_deleted",
      "id": 11559368171,
      "node_id": "CDE_lADOABII5858JbUhzwAAAAKw_fXr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11559368171",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-22T16:47:06Z"
    },
    {
      "event": "commented",
      "id": 1906252904,
      "node_id": "IC_kwDOABII585xnxxo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-23T15:09:48Z",
      "updated_at": "2024-01-23T15:09:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in e5217fea1516120643f4a7a55a474648e21e2269 is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1906252904",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "reviewed",
      "id": 1843953699,
      "node_id": "PRR_kwDOABII585t6IAj",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "> I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in [e5217fe](https://github.com/bitcoin/bitcoin/commit/e5217fea1516120643f4a7a55a474648e21e2269) is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n\r\nThe current sqlite configuration doesn't allow concurrent database transactions (see #29112). This means that if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection), the created transaction will remain active indefinitely, contrary to what all workflows expect. This situation provoques that any subsequent write operation on a new database handler (WalletBatch; it doesn't necessarily need to begin a new transaction, could also be a direct write) will dump information that was intended to be rolled back to disk. \r\n\r\nCheck https://github.com/bitcoin/bitcoin/pull/29112#pullrequestreview-1821862931 to see the test that originated this work.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1843953699",
      "submitted_at": "2024-01-25T15:02:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "commented",
      "id": 1910522489,
      "node_id": "IC_kwDOABII585x4EJ5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T16:09:58Z",
      "updated_at": "2024-01-25T16:09:58Z",
      "author_association": "CONTRIBUTOR",
      "body": ">  if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection)\r\n\r\nYes I've started reviewing both PR's and the code changes seem reasonable, I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910522489",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "commented",
      "id": 1910567093,
      "node_id": "IC_kwDOABII585x4PC1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T16:33:31Z",
      "updated_at": "2024-01-25T16:33:31Z",
      "author_association": "MEMBER",
      "body": "> seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs?\r\n\r\nIt shouldn't ever happen.\r\n\r\nIn general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "reviewed",
      "id": 1838949232,
      "node_id": "PRR_kwDOABII585tnCNw",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review d4ebac8381801d024b69d5f1f5a13246c61edbe4. This seems like a nice change that could make the wallet more reliable, and adds good cleanup and test coverage.\r\n\r\nDid not ack just because I noticed a bug in SQLiteBatch::TxnBegin if `m_db` is null, but none of my other comments are too important, so feel free to ignore them.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093\r\n\r\n> In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n\r\nYeah that sounds pretty close to ideal. Maybe not an urgent problem to solve, but could be nice.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1838949232",
      "submitted_at": "2024-01-25T21:30:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "commented",
      "id": 1911119751,
      "node_id": "IC_kwDOABII585x6V-H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911119751",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T22:47:39Z",
      "updated_at": "2024-01-26T14:03:39Z",
      "author_association": "MEMBER",
      "body": "> I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?\r\n\r\nYeah, I just noted that the error handling in the destructor isn't optimal. That if this ever occurs in #29112, the introduced database mutex would lock indefinitely.\r\nThen, I considered the same event in current master: which could lead to the writing of a dangling transaction to disk, which would corrupt the wallet and leave it at a non-recoverable point. Which is quite bad. And that motivated me to split the PR and force the txn rollback within the WalletBatch context as a last resource safety measure.\r\n\r\n> In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n\r\nIt wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\nAt least in this scenario, where we are destroying the object that created the transaction, I believe triggering the database connection reset is acceptable as a first measure. If it fails, then yeah, I agree that unloading the wallet instead of exiting the node would be desirable.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1911119751",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11608736531,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAKz70MT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11608736531",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-26T13:07:11Z"
    },
    {
      "event": "reviewed",
      "id": 1845717595,
      "node_id": "PRR_kwDOABII585uA2pb",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Updated per feedback, thanks @ryanofsky!\r\n\r\nThe main modification resides in the `ExecHandler` class, which is now designed to encapsulate all sqlite functions. This enables us to trigger different errors across the database sources; letting us improve the error-handling code and expand its test coverage. Furthermore, future encapsulation of sqlite functions within this class will contribute to minimizing the impact of any future API changes.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1845717595",
      "submitted_at": "2024-01-26T13:32:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "reviewed",
      "id": 1849338675,
      "node_id": "PRR_kwDOABII585uOqsz",
      "url": null,
      "actor": null,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 493cfc728aa7835527b1eab179b8cb36edd60946. I left more more comments about comments (feel free to ignore), but otherwise this looks good.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1911119751\r\n\r\n> > In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n> \r\n> It wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\n\r\nIn this case do we ever think we should see SQLITE_BUSY while trying to abandon a transaction? But yes in general we should treat expected errors and unexpected errors differently, and not handle expected errors by unloading the wallet.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1849338675",
      "submitted_at": "2024-01-29T19:32:24Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11641753906,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAK15xEy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11641753906",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-30T13:26:57Z"
    },
    {
      "event": "reviewed",
      "id": 1852174380,
      "node_id": "PRR_kwDOABII585uZfAs",
      "url": null,
      "actor": null,
      "commit_id": "756bed0529b46944162c02c783ecc804f802b637",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 756bed0529b46944162c02c783ecc804f802b637. New update consolidating the exec classes looks good.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1852174380",
      "submitted_at": "2024-01-30T19:47:33Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGRjYTg3NGU4MzhjMjU5OWJkMjQ0MzM2NzViMjkxMTY4ZjhlN2IwNTU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dca874e838c2599bd24433675b291168f8e7b055",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/dca874e838c2599bd24433675b291168f8e7b055",
      "tree": {
        "sha": "b70355dfe5ba99c5cbd6cd5870831e41433e5f91",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b70355dfe5ba99c5cbd6cd5870831e41433e5f91"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree b70355dfe5ba99c5cbd6cd5870831e41433e5f91\nparent fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c\nauthor furszy <matiasfurszyfer@protonmail.com> 1704723505 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706646405 -0300\n\nsqlite: add ability to interrupt statements\n\nBy encapsulating sqlite3_exec into its own standalone method\nand introducing the 'SQliteExecHandler' class, we enable the\nability to test db statements execution failures within the\nunit test framework.\n\nThis is used in the following-up commit to exercise a deadlock\nand improve our wallet db error handling code.\n\nMoreover, the future encapsulation of other sqlite functions\nwithin this class will contribute to minimize the impact of\nany future API changes.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmW5W4cACgkQXdI8zGhq\npiNi1BAApIa4xI5hfkEcgIhzYmU6UrC+QQIRsMCNI1bb9rYt9ShpawcanV73XHzw\nLCvGnNYtWRZIsjpZJ9sE8d6RnB8p6CmjDq0c/US6zbQxtXrlUXQsxNH0PEKGkJBc\nRjecVQa82k+3G9S0FSaRBt4Q9LQzjk3GffRwmPOilex/xUyi1jEZ678uZ3lnp8R/\nNFpzFnG3Cje0RTeKLCT9h3SsK2qKRepsV6PmV0baGuXsI0dMU5lvMdHNXxmzhbbL\n2NsbDrxHWEh6IXH2ZCF6Z5Yq38TmeDxE39rNNrdQmsaFzW+KHsqGh2DdWQM2RfaC\n9m32fw4uEQLByaRQxR1EPDPSSSW0jXYiVRRwKKfl1nBUUJfRadeS8wi7l18iYdQK\nx3PU/a6P590NQ8IOFJgqHMlKulPZ+0XH27oyjZrrn8Zxc6irhHGnsEFkDPxf88aL\nd9Y78xlZ0bcB98sMHZ9q/FsDRKXom8Qe2uQiMEtr6EL+2rgkWZIbGmKEVeJdN5d1\nGx2Ybev0rLvYWgR+TmQIhiM7bf486Nl7b0rXc3rtSIGgfxd4q1tcb83U0kz14vbq\njDANp3RR/Cb/1Zsrs/ahyaXk1CRLQlCahKtzJYU7TS/N5iTNK4n98gERLRu9uboA\nBmiLQqmMpR8me92x6PYMpqE76dA2+MZaUExpHwr0nhnZ661v7c4=\n=kECy\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
          "sha": "fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c"
        }
      ],
      "message": "sqlite: add ability to interrupt statements\n\nBy encapsulating sqlite3_exec into its own standalone method\nand introducing the 'SQliteExecHandler' class, we enable the\nability to test db statements execution failures within the\nunit test framework.\n\nThis is used in the following-up commit to exercise a deadlock\nand improve our wallet db error handling code.\n\nMoreover, the future encapsulation of other sqlite functions\nwithin this class will contribute to minimize the impact of\nany future API changes.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-30T20:26:45Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-08T14:18:25Z"
      },
      "sha": "dca874e838c2599bd24433675b291168f8e7b055"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ3MmQyY2E5ODE3MDA0OWUwZWRlYzgzMGUyZDExYzVlZjIzNzQwYTQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/472d2ca98170049e0edec830e2d11c5ef23740a4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/472d2ca98170049e0edec830e2d11c5ef23740a4",
      "tree": {
        "sha": "486a9314ebc07c92d7184556b349242ea83d1ca8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/486a9314ebc07c92d7184556b349242ea83d1ca8"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 486a9314ebc07c92d7184556b349242ea83d1ca8\nparent dca874e838c2599bd24433675b291168f8e7b055\nauthor furszy <matiasfurszyfer@protonmail.com> 1705360714 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706646440 -0300\n\nsqlite: introduce HasActiveTxn method\n\nUtil function to clean up code and let us\nverify, in the following-up commit, that dangling,\nto-be-reverted db transactions cannot occur anymore.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmW5W6oACgkQXdI8zGhq\npiMcQRAAm4iwzthmc+BVunmjsu0ikvCDqV8WrpFJ227jq7C0Tv7yiu5G39YXFCO6\nz97rIgKp0hnnr5zeSPumk7os7E3Fv4wQ0N26nRvqCHYKqzc8EHQGn1ubZIeMtumr\nn3ANtmhtFsZ1Y03ZtK3fX2p7MfTGXbkPkU09pUSXXM9C1/yz7MGitej8t1it2qGY\nhyjjrP5oqHeZ4tF4cXIYfm5GFcODPIoZqB3YzcCxP8veiQPHQ4bo3ceTyG4lS/Zr\nBJpKuYEmLdx9qAmQ6rU1rR5rvFE9Ch8vc4pNHonj1/Y1n3yy6wQeojBvG7so7+wX\naS/Y1HcTviIInel4SOyYOER3TJuWAOMtIDBc9I1kM5cAUWbR9eGXdT1DSAPm3ZDc\nzNQUblsQgPsCeExMcXoxrk0yrnoZpNwHpbu7V/bce0tdECI0H1l6w0+mwyUsYycl\n0wjTFtIbPJewdmK/h8qcbluXH7onf7jWzMZKPF9Q8pWMfbTb8xyUshvi6FxLKhlJ\nGwP7RQocNPFMpPPbmwX9EICFeAF9iFPi3IBpR6GtMg/Ngb8PX0LYF8o/RC9Y6hFe\nwRL/U4FSL5Rtqm5VUXk1c5LYTwOBX2ROjyAUlxW1z/9kajQA68PwlybwyVMPhtSB\nM5QQWmq0W2sp43prXZeZTV6dDq5TPivi0bAECFnD8tivwH3CAXQ=\n=1yQZ\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dca874e838c2599bd24433675b291168f8e7b055",
          "sha": "dca874e838c2599bd24433675b291168f8e7b055",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/dca874e838c2599bd24433675b291168f8e7b055"
        }
      ],
      "message": "sqlite: introduce HasActiveTxn method\n\nUtil function to clean up code and let us\nverify, in the following-up commit, that dangling,\nto-be-reverted db transactions cannot occur anymore.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-30T20:27:20Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:18:34Z"
      },
      "sha": "472d2ca98170049e0edec830e2d11c5ef23740a4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZjMGU3NDcxOTJlOThlNzc5YzVmMzFmMmRmODA4ZjYyYjNmZGQwNzE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fc0e747192e98e779c5f31f2df808f62b3fdd071",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fc0e747192e98e779c5f31f2df808f62b3fdd071",
      "tree": {
        "sha": "37abb01c2bfa913fd2bb0ecf636a232721bb1b18",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/37abb01c2bfa913fd2bb0ecf636a232721bb1b18"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 37abb01c2bfa913fd2bb0ecf636a232721bb1b18\nparent 472d2ca98170049e0edec830e2d11c5ef23740a4\nauthor furszy <matiasfurszyfer@protonmail.com> 1705362189 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706646456 -0300\n\nsqlite: guard against dangling to-be-reverted db transactions\n\nIf the handler that initiated the database transaction is destroyed,\nthe ongoing transaction cannot be left dangling when the db txn fails\nto abort. It must be forcefully reversed; otherwise, any subsequent\ndb handler executing a write operation will dump the dangling,\nto-be-reverted transaction data to disk.\n\nThis not only breaks the database isolation property but also results\nin the improper storage of incomplete information on disk, impacting\nthe wallet consistency.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmW5W7gACgkQXdI8zGhq\npiNvXA//Z0Y5gckD/rDVy5oJqzjpT5sR3I5YsrqRkKjDjR+2ou9IUAdp0qv7VbB8\nn+BmlkTfk3R07B5cAownq+0er/PRx1Z7Ncimu6lkH+v/cDwaL7G2c9Y2iUR46YSQ\nxye1lN74VNBXq4Rq0jjdNEtrZh9+ZiIoh4x1RH+d1xx+v8iDt41jjLOJgkKB8dTt\nnOCQw40Iah+xoADwpG503je9G2ZpGNdKvjVyglTjClU0BYNhbV5o8reF6v7sMph5\n5vTd//rOMo7zlAAOcA4F0qMOkNE7S5/M0D36oawuSgM4Nzsom07Zpp1MRxNBipug\nyaWxaS+QAwN+plyibbfbJZ0aOHlGP0NA8uzTLyFCTUdLcwf9FX4UgW2fPWK9P3iw\n061wPo6Anezx4GhuVREgJWnwk5gXTZ5ammkiBWCPWEXhTFiSjN9ziYQhRpLbEbVf\nMBCJRh7JJoelOHG8sgxEuA6zAv0GKbNKrbdum1uM7R33wo41mC+JHnQwZZ2quob4\nXsFoJiyFs267lXHIYQhKbvpxIQD6zsGLfVFKgw9WYwNrZv/RPedmkQ0WpRGUARud\nomhx7EC/BYswxPUMyBuEGwNcAttNwlLtdfVhVbfE43n0SyKOSu0mTkjrx4YsGSfq\nkLL9Ai4nnOoCJ+9z7jExgh4E1nCyy0WyQZSr8ZITGFN2Pa/q8hs=\n=Pblr\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/472d2ca98170049e0edec830e2d11c5ef23740a4",
          "sha": "472d2ca98170049e0edec830e2d11c5ef23740a4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/472d2ca98170049e0edec830e2d11c5ef23740a4"
        }
      ],
      "message": "sqlite: guard against dangling to-be-reverted db transactions\n\nIf the handler that initiated the database transaction is destroyed,\nthe ongoing transaction cannot be left dangling when the db txn fails\nto abort. It must be forcefully reversed; otherwise, any subsequent\ndb handler executing a write operation will dump the dangling,\nto-be-reverted transaction data to disk.\n\nThis not only breaks the database isolation property but also results\nin the improper storage of incomplete information on disk, impacting\nthe wallet consistency.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-30T20:27:36Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:43:09Z"
      },
      "sha": "fc0e747192e98e779c5f31f2df808f62b3fdd071"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGIyOTgyNDJjOGQ0OTVjMzYwNzI0MTVlMWI5NWVhYTdiZjQ4NWEzOGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b298242c8d495c36072415e1b95eaa7bf485a38a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b298242c8d495c36072415e1b95eaa7bf485a38a",
      "tree": {
        "sha": "97e2c2104962da68074620af87c7fb24792e9dc3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/97e2c2104962da68074620af87c7fb24792e9dc3"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 97e2c2104962da68074620af87c7fb24792e9dc3\nparent fc0e747192e98e779c5f31f2df808f62b3fdd071\nauthor furszy <matiasfurszyfer@protonmail.com> 1704723565 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706646456 -0300\n\ntest: sqlite, add coverage for dangling to-be-reverted db txns\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmW5W7gACgkQXdI8zGhq\npiM3sQ//WJDSCMP4toJKt9+sXUpi8cLkSw5liSi1AYPziTxipMs8tp5Pa2D0CsNd\n5wUQaFT1Hf+9zr0VTuhaNJgnpCuajURtGLfi/Lxt7CQ20Y01v6+t14UfFAsE0WpI\nXbWUvOivCC/M8x6YzkXp9Ct5IwILweQRDT2QUhMhzxAJa3MXT6wgr2TKAGw94k9z\nR8fikrTTlwf/KfLKeDtE067QClyMtZ03KnBGe0Bo4Wla4XEGYYdkBTy3mPeS6jYY\n8iwo27V055hxq2/VDqVoYYMRXpIAP7l9EmdlZPOmqvwR9nkKW+mEcGqF3l1y7MvY\nj462t2q/hjBhH10jTmNzfOwZk5M/Mw3ogUZtQALtbnRMEIP5ukqBh5YgugnarYzf\nfmcGyWl0/1QEORqUmSu2hXAEXAjdQPF2znM+0fbzOuLWwuWhiDcCTvbmg8Y5UT8/\nqhBCI3jwXc4zHY0buK3x2WmNN9mgVjcQVYaHaFmneyvMfeuXNWoiq/hvUwG4Kmuc\nmWrLkPa2xZLsNTIU2XKm4LaOpHmYMiIx2qdvp8WKgos4dgN3wujZZ1Fx3f6a98mz\nDKumWcKqSoelzONeQgdqSEmWDIQCyCe11Bx0wVsQVu2IvuuRvUTiCYaMdoEpDxGC\nrZ9nIaAVE/7Q7gZhoF/FG5WX3qLorbG1wlTNoPl1WpNIPuHEkKs=\n=+gqO\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fc0e747192e98e779c5f31f2df808f62b3fdd071",
          "sha": "fc0e747192e98e779c5f31f2df808f62b3fdd071",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fc0e747192e98e779c5f31f2df808f62b3fdd071"
        }
      ],
      "message": "test: sqlite, add coverage for dangling to-be-reverted db txns",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-30T20:27:36Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-08T14:19:25Z"
      },
      "sha": "b298242c8d495c36072415e1b95eaa7bf485a38a"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11647146899,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAK2OVuT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11647146899",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-30T20:31:59Z"
    },
    {
      "event": "reviewed",
      "id": 1852350177,
      "node_id": "PRR_kwDOABII585uaJ7h",
      "url": null,
      "actor": null,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Updated per feedback, thanks ryanofsky!\r\nDocstrings were improved, and a bug related to a null `SQLiteExecHandler` has been fixed.\r\n[Small diff](https://github.com/bitcoin/bitcoin/compare/756bed0529b46944162c02c783ecc804f802b637..b298242c8d495c36072415e1b95eaa7bf485a38a).",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1852350177",
      "submitted_at": "2024-01-30T20:58:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "labeled",
      "id": 11649043690,
      "node_id": "LE_lADOABII5858JbUhzwAAAAK2Vkzq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11649043690",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-30T23:55:23Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1854204356,
      "node_id": "PRR_kwDOABII585uhOnE",
      "url": null,
      "actor": null,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK b298242c8d495c36072415e1b95eaa7bf485a38a. Just fix for exec result codes and comment update since last review.\r\n\r\nOverall this change should help wallet recover and not cause more problems if a rollback fails, and it adds some nice test coverage.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1854204356",
      "submitted_at": "2024-01-31T17:02:14Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "commented",
      "id": 1919735812,
      "node_id": "IC_kwDOABII585ybNgE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919735812",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-31T18:55:24Z",
      "updated_at": "2024-01-31T19:01:32Z",
      "author_association": "MEMBER",
      "body": "> It wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\n> At least in this scenario, where we are destroying the object that created the transaction, I believe triggering the database connection reset is acceptable as a first measure.\r\n\r\nIf we do have recoverable errors, then we should be handling them, not hitting them with the hammer of closing and reopening the database.\r\n\r\n***\r\n\r\nThis PR feels like it's the wrong approach to dealing with this particular database failure. It shouldn't be possible for a transaction commit or abort to currently fail in way that isn't catastrophic. In that case, we should be shutting the wallet rather than reopening the database connection and pretending that nothing happened. This could potentially lead to a state where the wallet's in-memory state does not match the database, which is really bad and could lead to loss of funds.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919735812",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "commented",
      "id": 1919780817,
      "node_id": "IC_kwDOABII585ybYfR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919780817",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-31T19:24:34Z",
      "updated_at": "2024-01-31T19:24:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "> This PR feels like it's the wrong approach to dealing with this particular database failure. It shouldn't be possible for a transaction commit or abort to currently fail in way that isn't catastrophic. In that case, we should be shutting the wallet rather than reopening the database connection and pretending that nothing happened. This could potentially lead to a state where the wallet's in-memory state does not match the database, which is really bad and could lead to loss of funds.\r\n\r\nIt seems like if there is failure to rollback a transaction one way, with a rollback statement, this PR is just retrying again a different way, by closing and reopening the database. In theory the code could always roll back transactions by closing and reopening the database, so the new behavior in this PR doesn't seem worse than current behavior.\r\n\r\nOne way the PR seems better than the current code is that the current code just logs \"SQLiteBatch: Batch closed and failed to abort transaction\" if the rollback fails, which is not even an obvious error message, and it continues like nothing happened. The new code at least raises an exception if the rollback fails.\r\n\r\nAll of this seems very theoretical to me since I have no idea why a rollback statement would ever fail. But I think this PR seems reasonable, adds some test coverage, and probably is a small improvement even if better approaches are also possible.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919780817",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "commented",
      "id": 1919841411,
      "node_id": "IC_kwDOABII585ybnSD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1919841411",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-31T20:02:16Z",
      "updated_at": "2024-01-31T20:02:16Z",
      "author_association": "MEMBER",
      "body": "ACK b298242c8d495c36072415e1b95eaa7bf485a38a",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1919841411",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "merged",
      "id": 11660925309,
      "node_id": "ME_lADOABII5858JbUhzwAAAAK3C5l9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11660925309",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "a01da41112387fd50553e8a5f203589f04f6e942",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a01da41112387fd50553e8a5f203589f04f6e942",
      "created_at": "2024-01-31T20:22:57Z"
    },
    {
      "event": "closed",
      "id": 11660925336,
      "node_id": "CE_lADOABII5858JbUhzwAAAAK3C5mY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11660925336",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-31T20:22:57Z"
    },
    {
      "event": "head_ref_deleted",
      "id": 11669661645,
      "node_id": "HRDE_lADOABII5858JbUhzwAAAAK3kOfN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11669661645",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-02-01T12:48:39Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110",
      "pull_request_review_id": 1824875743,
      "id": 1453968110,
      "node_id": "PRRC_kwDOABII585Wqcru",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": 64,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "83c807a380b41787214806c6440236ea1a9dabd7",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 83c807a380b41787214806c6440236ea1a9dabd7 \"sqlite: introduce HasActiveTxn method\"\r\n\r\n`HasActiveTxn()` checks for `m_db` already, so no need to do check that here too.\r\n\r\nSame for `TxnCommit()` and `TxnAbort()`.",
      "created_at": "2024-01-16T20:10:05Z",
      "updated_at": "2024-01-16T20:11:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 637,
      "original_line": 637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729",
      "pull_request_review_id": 1824891279,
      "id": 1453982729,
      "node_id": "PRRC_kwDOABII585WqgQJ",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": 64,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "83c807a380b41787214806c6440236ea1a9dabd7",
      "in_reply_to_id": 1453968110,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "upps done",
      "created_at": "2024-01-16T20:22:19Z",
      "updated_at": "2024-01-16T20:22:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 637,
      "original_line": 637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113",
      "pull_request_review_id": 1838949232,
      "id": 1463377113,
      "node_id": "PRRC_kwDOABII585XOVzZ",
      "diff_hunk": "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nIt would be good to define -999 as a constant so callers could check for this error. Or if there probably won't be a need for callers to do that, it would be clearer to return SQLITE_ERROR.",
      "created_at": "2024-01-23T14:36:43Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1463377113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 498,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843",
      "pull_request_review_id": 1838949232,
      "id": 1466931843,
      "node_id": "PRRC_kwDOABII585Xb5qD",
      "diff_hunk": "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": 6,
      "original_position": 4,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nWould suggest calling this `SQliteExecBlocker`, or maybe `SQliteExecHook` or `SQliteTestHook` if you anticipate it being used more broadly for other things in the future. \"ExecHandler\" seems like the wrong name because the class itself isn't executing anything and doesn't call sqlite3_exec.\r\n\r\nWould also suggest adding a comment saying this is used for testing, because otherwise it's not clear why `CanExecute` would ever return false.\r\n\r\nAlso, in case you _don't_ anticipate the class being extended used for other things in the future, you could replace it with a std::function, since it does only have one virtual method.",
      "created_at": "2024-01-25T20:34:21Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466931843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 41,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379",
      "pull_request_review_id": 1838949232,
      "id": 1466947379,
      "node_id": "PRRC_kwDOABII585Xb9cz",
      "diff_hunk": "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "path": "src/wallet/sqlite.cpp",
      "position": 7,
      "original_position": 6,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nIt would be nice to have a comment explaining the use of sqlite3_get_autocommit, since the name doesn't really explain what it is doing. Maybe \"// sqlite3_get_autocommit returns true by default, and false if a transaction has begun and not been committed or rolled back.\"\r\n\r\nAlso, I noticed https://www.sqlite.org/c3ref/get_autocommit.html says \"If another thread changes the autocommit status of the database connection while this routine is running, then the return value is undefined\" so it seems like we probably need to be using a mutex for this. (That would be a pre-existing issue not related to this PR.)",
      "created_at": "2024-01-25T20:50:38Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466947379",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 383,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925",
      "pull_request_review_id": 1838949232,
      "id": 1466953925,
      "node_id": "PRRC_kwDOABII585Xb_DF",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nThere appears to be a bug here. Previously it would return false if `m_db` is null. Now it will try to execute begin transaction. I think you need to keep the `!m_database.m_db` condition",
      "created_at": "2024-01-25T20:58:31Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466953925",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 620,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009",
      "pull_request_review_id": 1838949232,
      "id": 1466956009,
      "node_id": "PRRC_kwDOABII585Xb_jp",
      "diff_hunk": "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nWould be good to drop the parenthetical about autocommit mode here, since that's now an implementation detail of HasActiveTxn()",
      "created_at": "2024-01-25T21:00:59Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466956009",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 402,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956",
      "pull_request_review_id": 1838949232,
      "id": 1466966956,
      "node_id": "PRRC_kwDOABII585XcCOs",
      "diff_hunk": "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (508fda2fddfef0cefedde9777c914aec72adf7fb)\r\n\r\nI found this comment confusing because I couldn't figure out when failing to abort a transaction would ever be expected to happen, and what the error handling strategy was supposed to be when it did happen. Would maybe suggest: \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\n\r\n\r\n",
      "created_at": "2024-01-25T21:14:14Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 408,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974",
      "pull_request_review_id": 1838949232,
      "id": 1466968974,
      "node_id": "PRRC_kwDOABII585XcCuO",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"test: sqlite, add coverage for dangling to-be-reverted db txns\" (d4ebac8381801d024b69d5f1f5a13246c61edbe4)\r\n\r\nI think it would be a little more consistent with other code to call this variable \"batch\" instead of \"handler.\" Also calling it handler gets a little confusing when code below sets a handler on the handler.",
      "created_at": "2024-01-25T21:16:43Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193",
      "pull_request_review_id": 1845717595,
      "id": 1467629193,
      "node_id": "PRRC_kwDOABII585Xej6J",
      "diff_hunk": "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "path": "src/wallet/sqlite.cpp",
      "position": 7,
      "original_position": 6,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466947379,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure, done. Comment added.",
      "created_at": "2024-01-26T13:05:00Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629193",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 383,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362",
      "pull_request_review_id": 1845717595,
      "id": 1467629362,
      "node_id": "PRRC_kwDOABII585Xej8y",
      "diff_hunk": "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466956009,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-01-26T13:05:10Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629362",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 402,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981",
      "pull_request_review_id": 1845717595,
      "id": 1467631981,
      "node_id": "PRRC_kwDOABII585Xeklt",
      "diff_hunk": "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "in_reply_to_id": 1466966956,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure, done. Have slightly rephrased the suggestion. Thanks",
      "created_at": "2024-01-26T13:08:19Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467631981",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 408,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309",
      "pull_request_review_id": 1845717595,
      "id": 1467634309,
      "node_id": "PRRC_kwDOABII585XelKF",
      "diff_hunk": "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": 1463377113,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure. Created a constant for the -999 error in the new approach.",
      "created_at": "2024-01-26T13:10:36Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634309",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 498,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537",
      "pull_request_review_id": 1845717595,
      "id": 1467634537,
      "node_id": "PRRC_kwDOABII585XelNp",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466953925,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "upps thanks. Fixed.",
      "created_at": "2024-01-26T13:10:51Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634537",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 620,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407",
      "pull_request_review_id": 1845717595,
      "id": 1467640407,
      "node_id": "PRRC_kwDOABII585XempX",
      "diff_hunk": "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": 6,
      "original_position": 4,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": 1466931843,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah, this was meant to be a class encapsulating all sqlite functions so that we can trigger different errors and improve and test our error-handling code. I'm not sure why I implemented `CanExecute` instead of decoupling the `Exec()`, but well.. I just changed the implementation to follow the initial idea. Thanks for pointing this out.",
      "created_at": "2024-01-26T13:17:28Z",
      "updated_at": "2024-01-26T13:33:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467640407",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 41,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011",
      "pull_request_review_id": 1845717595,
      "id": 1467644011,
      "node_id": "PRRC_kwDOABII585Xenhr",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": 1466968974,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "So true that it hurts.\r\nI tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process. This is something that the `WalletBatch` class doesn't do unless we explicitly begin and finish the transaction.",
      "created_at": "2024-01-26T13:21:14Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467644011",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356",
      "pull_request_review_id": 1849338675,
      "id": 1469966356,
      "node_id": "PRRC_kwDOABII585XnegU",
      "diff_hunk": "@@ -36,11 +36,26 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class ExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 4,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "53c4f1334ee300e2228974b4abca51c38087c51c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (53c4f1334ee300e2228974b4abca51c38087c51c)\r\n\r\nWould suggest a rename and comment.\r\n\r\nThis class is SQLite specific, but unlike other other classes in this file it does not have SQLite in the name. Would suggest calling it `SQliteExecInterface` since it is an abstract class with all virtual methods.\r\n\r\nAlso, it's not initially clear why this class and the class below exist. Would suggest adding a doxygen comment like //* Abstract class responsible for executing SQL statements in SQLite databases. It is abstract so it can be overridden by unit tests testing unusual database conditions. */\r\n\r\n---\r\n\r\nEDIT: Alternately you could combine ExecHandler and SQliteExecHandler into a single class. This would also simplify the unit test because it could just inherit from SQliteExecHandler instead of inheriting from ExecHandler and containing SQliteExecHandler.",
      "created_at": "2024-01-29T17:36:23Z",
      "updated_at": "2024-01-29T19:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1469966356",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684",
      "pull_request_review_id": 1849338675,
      "id": 1470026684,
      "node_id": "PRRC_kwDOABII585XntO8",
      "diff_hunk": "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "0bf3a7356db224d28a86194b004ca30549197f27",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (0bf3a7356db224d28a86194b004ca30549197f27)\r\n\r\nI think this comment might be more harmful than helpful in its current form, because it isn't communicating the most important thing, which is that this code path is never expected to be hit under normal conditions, and if it is hit, it means something is seriously wrong and there has probably been data loss, if not data corruption. By saying this failure can happen when the connection is \"busy\", it makes it sound like database could just be waiting for a lock. But locking alone could never trigger this, so suggesting that it could raises doubts about the rest of the code, and makes the handling here seem to be unnecessary.\r\n\r\nAlso saying \"this action will automatically rollback the transaction ensuring...\" seems like an overstatement. Even if it's probably true, we are in the middle of recovering from some other significant bug or I/O error, so this comment seems to be going out on a limb to make a guarantee that isn't clearly significant. It is also unclear to me what \"transaction data outside the context of the 'SQLiteBatch'\" would refer to if SQLiteBatch is the class responsible for creating transactions.\r\n\r\nConsidering all this, I'd probably suggest still going with my original comment from https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956 which was \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\nBut maybe this comment is missing some other information that you wanted to get across?",
      "created_at": "2024-01-29T18:28:52Z",
      "updated_at": "2024-01-29T19:33:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470026684",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 415,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 418,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536",
      "pull_request_review_id": 1849338675,
      "id": 1470035536,
      "node_id": "PRRC_kwDOABII585XnvZQ",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": 1466968974,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974\r\n\r\n> I tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process.\r\n\r\n:grinning: yeah very used to seeing bland names that don't mean anything because someone rejected an an actually descriptive name for a pedantic reason. In this case, I think a batch is just a collection of actions done together. Metaphors are ok once in a while.",
      "created_at": "2024-01-29T18:36:30Z",
      "updated_at": "2024-01-29T19:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470035536",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471199191",
      "pull_request_review_id": 1851256310,
      "id": 1471199191,
      "node_id": "PRRC_kwDOABII585XsLfX",
      "diff_hunk": "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "0bf3a7356db224d28a86194b004ca30549197f27",
      "in_reply_to_id": 1470026684,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> It is also unclear to me what \"transaction data outside the context of the 'SQLiteBatch'\" would refer to if SQLiteBatch is the class responsible for creating transactions.\r\n\r\nThe purpose of this sentence was to describe what could happen if we don't rollback the transaction and explain why we rollback the transaction inside the `SQLiteBatch` destructor.\r\n\r\nThe complete sentence, \"This prevents dangling transaction data outside the context of the 'SQLiteBatch' that initiated such a transaction,\" refers to the `SQLiteBatch` instance, not the class. Each `SQLiteBatch` can create a single transaction at a time; no concurrent `SQLiteBatch` instances are allowed (#29112). Thus, the code rolls back the db txn within the `SQLiteBatch` object destructor. This links the db txn to the `SQLiteBatch` instance lifecycle, isolating data changes and preventing other `SQLiteBatch` instances from dumping data that does not correspond to them.\r\n\r\n> But maybe this comment is missing some other information that you wanted to get across?\r\n\r\nI wanted to emphasize the importance of rolling back the transaction by explaining the consequences of leaving the transaction dangling. Also, wanted to mention that the error could be transient (so we don't forget about this possibility) and describe why we want to keep the transaction data changes isolated within the `SQLiteBatch` instance that initiated the transaction.\r\n\r\n---------------------\r\n\r\nIf, after reading this response, you still have doubts and find the comment confusing, I can replace it with your comment. No problem; the idea was to provide a clearer description of the situation.",
      "created_at": "2024-01-30T13:21:47Z",
      "updated_at": "2024-01-30T13:25:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471199191",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471199191"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 415,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 418,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471205237",
      "pull_request_review_id": 1851256310,
      "id": 1471205237,
      "node_id": "PRRC_kwDOABII585XsM91",
      "diff_hunk": "@@ -36,11 +36,26 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class ExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 4,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "53c4f1334ee300e2228974b4abca51c38087c51c",
      "in_reply_to_id": 1469966356,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Great, thanks ðŸ‘ŒðŸ¼. Unified `ExecHandler` and `SQliteExecHandler` and added your doxygen comment.",
      "created_at": "2024-01-30T13:25:51Z",
      "updated_at": "2024-01-30T13:25:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471205237",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471205237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471209737",
      "pull_request_review_id": 1851270902,
      "id": 1471209737,
      "node_id": "PRRC_kwDOABII585XsOEJ",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": 1466968974,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done as suggested.",
      "created_at": "2024-01-30T13:28:50Z",
      "updated_at": "2024-01-30T13:28:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471209737",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471209737"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471833134",
      "pull_request_review_id": 1852174380,
      "id": 1471833134,
      "node_id": "PRRC_kwDOABII585XumQu",
      "diff_hunk": "@@ -36,11 +36,21 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+/** Abstract class responsible for executing SQL statements in SQLite databases.\n+ *  It is abstract so it can be overridden by unit tests testing unusual database conditions. */",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 5,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (177ff954c1221a00d4bf5ea63e6bfc415ba706c8)\r\n\r\nIt's technically not an abstract class anymore since it doesn't contain any `= 0` pure virtual methods. Would maybe suggest \"Class responsible for executing SQL statements in SQLite databases. Methods are virtual so they can be overridden by unit tests testing unusual database conditions.\"\r\n",
      "created_at": "2024-01-30T19:29:09Z",
      "updated_at": "2024-01-30T19:47:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471833134",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471833134"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 39,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471840452",
      "pull_request_review_id": 1852174380,
      "id": 1471840452,
      "node_id": "PRRC_kwDOABII585XuoDE",
      "diff_hunk": "@@ -607,7 +612,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n bool SQLiteBatch::TxnBegin()\n {\n     if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n-    int res = sqlite3_exec(m_database.m_db, \"BEGIN TRANSACTION\", nullptr, nullptr, nullptr);\n+    int res = m_exec_handler && m_exec_handler->Exec(m_database, \"BEGIN TRANSACTION\");",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 17,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (177ff954c1221a00d4bf5ea63e6bfc415ba706c8)\r\n\r\nThis doesn't seem right because the `&&` operator will convert the integer return value into a bool. Also if m_exec_handler is null the `res` value will be 0 which is SQLITE_OK so the call will appear to succed.\r\n\r\nIt probably would make more sense to do `int res = Assert(m_exec_handler)->Exec(...)`",
      "created_at": "2024-01-30T19:34:39Z",
      "updated_at": "2024-01-30T19:48:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471840452",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471840452"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 615,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471853965",
      "pull_request_review_id": 1852174380,
      "id": 1471853965,
      "node_id": "PRRC_kwDOABII585XurWN",
      "diff_hunk": "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "0bf3a7356db224d28a86194b004ca30549197f27",
      "in_reply_to_id": 1470026684,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471199191\r\n\r\nThanks for clarifying.\r\n\r\n> I wanted to emphasize the importance of rolling back the transaction by explaining the consequences of leaving the transaction dangling.\r\n\r\nThat seems ok. Would maybe suggest adding to the previously suggested comment:\r\n\r\n* // If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back **and future transactions can succeed without committing old data**.\r\n\r\n> Also, wanted to mention that the error could be transient (so we don't forget about this possibility)\r\n\r\nThis is exactly what I think the comment should not be saying because the error cannot be transient. And it's confusing to suggest that it could be transient, because it either makes the rest of the code seem broken, or it makes this code seem unnecessary.\r\n\r\nIf you want talk about a theoretical future state, in some future version of sqlite or future version of the wallet codebase where a rollback statement could return SQLITE_BUSY, I guess you could do that but it seems speculative and confusing if you don't distinguish that scenario with what is actually happening in the current code.\r\n\r\n> and describe why we want to keep the transaction data changes isolated within the `SQLiteBatch` instance that initiated the transaction.\r\n\r\nI think that's mostly clear from the context but if you want to say more about it, the best place to put it would be on line 410 before the TxnAbort() call is made, to explain why the TxnAbort() call is being made and why it's important. Trying to get into why the rollback is important after the rolllback fails seems like going down a tangent and not putting information where it is most helpful.",
      "created_at": "2024-01-30T19:44:52Z",
      "updated_at": "2024-01-30T19:47:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471853965",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471853965"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 415,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 418,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915202",
      "pull_request_review_id": 1852300328,
      "id": 1471915202,
      "node_id": "PRRC_kwDOABII585Xu6TC",
      "diff_hunk": "@@ -607,7 +612,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n bool SQLiteBatch::TxnBegin()\n {\n     if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n-    int res = sqlite3_exec(m_database.m_db, \"BEGIN TRANSACTION\", nullptr, nullptr, nullptr);\n+    int res = m_exec_handler && m_exec_handler->Exec(m_database, \"BEGIN TRANSACTION\");",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 17,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "in_reply_to_id": 1471840452,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "yes, fixed. Thanks. God knows why I did that.. it seems that I wasn't focused.",
      "created_at": "2024-01-30T20:32:37Z",
      "updated_at": "2024-01-30T20:32:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915202",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915202"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 615,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915666",
      "pull_request_review_id": 1852300936,
      "id": 1471915666,
      "node_id": "PRRC_kwDOABII585Xu6aS",
      "diff_hunk": "@@ -36,11 +36,21 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+/** Abstract class responsible for executing SQL statements in SQLite databases.\n+ *  It is abstract so it can be overridden by unit tests testing unusual database conditions. */",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 5,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "177ff954c1221a00d4bf5ea63e6bfc415ba706c8",
      "in_reply_to_id": 1471833134,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "yeah, fixed. I pasted your doc suggestion first, then made the classes consolidation..",
      "created_at": "2024-01-30T20:33:05Z",
      "updated_at": "2024-01-30T20:33:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471915666",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471915666"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 39,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 40,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471941289",
      "pull_request_review_id": 1852338645,
      "id": 1471941289,
      "node_id": "PRRC_kwDOABII585XvAqp",
      "diff_hunk": "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "0bf3a7356db224d28a86194b004ca30549197f27",
      "in_reply_to_id": 1470026684,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "All good, applied your suggestion. Thanks!\r\n\r\n> This is exactly what I think the comment should not be saying because the error cannot be transient. And it's confusing to suggest that it could be transient, because it either makes the rest of the code seem broken, or it makes this code seem unnecessary.\r\n\r\nI was also thinking about an I/O hardware malfunctioning error, which \"could\" be transient; sqlite has return codes for it. But it's probably better to abort the program if something like this ever happens.",
      "created_at": "2024-01-30T20:52:56Z",
      "updated_at": "2024-01-30T20:59:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1471941289",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1471941289"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": 415,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 418,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473087294",
      "pull_request_review_id": 1854204356,
      "id": 1473087294,
      "node_id": "PRRC_kwDOABII585XzYc-",
      "diff_hunk": "@@ -61,6 +71,8 @@ class SQLiteBatch : public DatabaseBatch\n     explicit SQLiteBatch(SQLiteDatabase& database);\n     ~SQLiteBatch() override { Close(); }\n \n+    void SetExecHandler(std::unique_ptr<SQliteExecHandler>&& handler) { m_exec_handler = std::move(handler); }",
      "path": "src/wallet/sqlite.h",
      "position": 26,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "dca874e838c2599bd24433675b291168f8e7b055",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (dca874e838c2599bd24433675b291168f8e7b055)\r\n\r\nIt's a little better to pass plain `unique_ptr` instead of `unique_ptr&&`, because former guarantees unique_ptr argument will be moved-from and null afterward, while latter means the move may or may not happen depending on internals of the function. In general you want explicit && references for template programming and perfect forwarding, but should use values and & references otherwise.. Can see https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-conventional for guidelines.\r\n",
      "created_at": "2024-01-31T16:11:15Z",
      "updated_at": "2024-01-31T17:02:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473087294",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473087294"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 74,
      "original_line": 74,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473503275",
      "pull_request_review_id": 1854901398,
      "id": 1473503275,
      "node_id": "PRRC_kwDOABII585X0-Ar",
      "diff_hunk": "@@ -61,6 +71,8 @@ class SQLiteBatch : public DatabaseBatch\n     explicit SQLiteBatch(SQLiteDatabase& database);\n     ~SQLiteBatch() override { Close(); }\n \n+    void SetExecHandler(std::unique_ptr<SQliteExecHandler>&& handler) { m_exec_handler = std::move(handler); }",
      "path": "src/wallet/sqlite.h",
      "position": 26,
      "original_position": 26,
      "commit_id": "b298242c8d495c36072415e1b95eaa7bf485a38a",
      "original_commit_id": "dca874e838c2599bd24433675b291168f8e7b055",
      "in_reply_to_id": 1473087294,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "ok noted, thanks!",
      "created_at": "2024-01-31T21:44:47Z",
      "updated_at": "2024-01-31T21:44:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1473503275",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1473503275"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 74,
      "original_line": 74,
      "side": "RIGHT"
    }
  ]
}