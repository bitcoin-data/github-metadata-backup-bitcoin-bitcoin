{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253",
    "id": 1679974105,
    "node_id": "PR_kwDOABII585kIl7Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/29253",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/29253.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/29253.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/493cfc728aa7835527b1eab179b8cb36edd60946",
    "number": 29253,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "wallet: guard against dangling to-be-reverted db transactions",
    "user": {
      "login": "furszy",
      "id": 5377650,
      "node_id": "MDQ6VXNlcjUzNzc2NTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/furszy",
      "html_url": "https://github.com/furszy",
      "followers_url": "https://api.github.com/users/furszy/followers",
      "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
      "organizations_url": "https://api.github.com/users/furszy/orgs",
      "repos_url": "https://api.github.com/users/furszy/repos",
      "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/furszy/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Discovered while was reviewing #29112, specifically https://github.com/bitcoin/bitcoin/pull/29112#pullrequestreview-1821862931.\r\n\r\nIf the db handler that initiated the database transaction is destroyed,\r\nthe ongoing transaction cannot be left dangling when the db txn fails\r\nto abort. It must be forcefully reverted; otherwise, any subsequent\r\ndb handler executing a write operation will dump the dangling,\r\nto-be-reverted transaction data to disk.\r\n\r\nThis not only breaks the isolation property but also results in the\r\nimproper storage of incomplete information on disk, impacting\r\nthe wallet consistency.\r\n\r\nThis PR fixes the issue by resetting the db connection, automatically\r\nrolling back the transaction (per https://www.sqlite.org/c3ref/close.html)\r\nwhen the handler object is being destroyed and the txn abortion failed.\r\n\r\nTesting Notes\r\nCan verify the failure by reverting the fix e5217fea and running the test.\r\nIt will fail without e5217fea and pass with it.",
    "labels": [
      {
        "id": 149424,
        "node_id": "MDU6TGFiZWwxNDk0MjQ=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
        "name": "Wallet",
        "color": "08a781",
        "default": false
      }
    ],
    "milestone": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61",
      "html_url": "https://github.com/bitcoin/bitcoin/milestone/61",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61/labels",
      "id": 9334188,
      "node_id": "MI_kwDOABII584Ajm2s",
      "number": 61,
      "state": "open",
      "title": "27.0",
      "description": "",
      "creator": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "open_issues": 7,
      "closed_issues": 33,
      "created_at": "2023-04-27T08:01:57Z",
      "updated_at": "2024-01-29T17:31:51Z"
    },
    "created_at": "2024-01-16T00:41:40Z",
    "updated_at": "2024-01-29T19:32:26Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "84c53c1e8811a8b7fc54f12cb9d3494c3fe0378e",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "furszy:2024_wallet_db_dangling_txn",
      "ref": "2024_wallet_db_dangling_txn",
      "sha": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 143624913,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDM2MjQ5MTM=",
        "name": "bitcoin-core",
        "full_name": "furszy/bitcoin-core",
        "owner": {
          "login": "furszy",
          "id": 5377650,
          "node_id": "MDQ6VXNlcjUzNzc2NTA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/furszy",
          "html_url": "https://github.com/furszy",
          "followers_url": "https://api.github.com/users/furszy/followers",
          "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
          "organizations_url": "https://api.github.com/users/furszy/orgs",
          "repos_url": "https://api.github.com/users/furszy/repos",
          "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/furszy/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/furszy/bitcoin-core",
        "description": "Bitcoin-Core",
        "fork": true,
        "url": "https://api.github.com/repos/furszy/bitcoin-core",
        "archive_url": "https://api.github.com/repos/furszy/bitcoin-core/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/furszy/bitcoin-core/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/furszy/bitcoin-core/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/furszy/bitcoin-core/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/furszy/bitcoin-core/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/furszy/bitcoin-core/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/furszy/bitcoin-core/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/furszy/bitcoin-core/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/furszy/bitcoin-core/contributors",
        "deployments_url": "https://api.github.com/repos/furszy/bitcoin-core/deployments",
        "downloads_url": "https://api.github.com/repos/furszy/bitcoin-core/downloads",
        "events_url": "https://api.github.com/repos/furszy/bitcoin-core/events",
        "forks_url": "https://api.github.com/repos/furszy/bitcoin-core/forks",
        "git_commits_url": "https://api.github.com/repos/furszy/bitcoin-core/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/furszy/bitcoin-core/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/furszy/bitcoin-core/git/tags%7B/sha%7D",
        "git_url": "git://github.com/furszy/bitcoin-core.git",
        "issue_comment_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/furszy/bitcoin-core/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/furszy/bitcoin-core/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/furszy/bitcoin-core/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/furszy/bitcoin-core/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/furszy/bitcoin-core/languages",
        "merges_url": "https://api.github.com/repos/furszy/bitcoin-core/merges",
        "milestones_url": "https://api.github.com/repos/furszy/bitcoin-core/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/furszy/bitcoin-core/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/furszy/bitcoin-core/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/furszy/bitcoin-core/releases%7B/id%7D",
        "ssh_url": "git@github.com:furszy/bitcoin-core.git",
        "stargazers_url": "https://api.github.com/repos/furszy/bitcoin-core/stargazers",
        "statuses_url": "https://api.github.com/repos/furszy/bitcoin-core/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/furszy/bitcoin-core/subscribers",
        "subscription_url": "https://api.github.com/repos/furszy/bitcoin-core/subscription",
        "tags_url": "https://api.github.com/repos/furszy/bitcoin-core/tags",
        "teams_url": "https://api.github.com/repos/furszy/bitcoin-core/teams",
        "trees_url": "https://api.github.com/repos/furszy/bitcoin-core/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/furszy/bitcoin-core.git",
        "hooks_url": "https://api.github.com/repos/furszy/bitcoin-core/hooks",
        "svn_url": "https://github.com/furszy/bitcoin-core",
        "homepage": "",
        "language": "C++",
        "forks_count": 4,
        "stargazers_count": 2,
        "watchers_count": 2,
        "size": 391469,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-01-26T13:56:23Z",
        "created_at": "2018-08-05T15:28:43Z",
        "updated_at": "2023-08-30T13:12:58Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "e3b68b3b833984973401ceff43930f7c56a83f29",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36629,
        "stargazers_count": 73608,
        "watchers_count": 73608,
        "size": 247952,
        "default_branch": "master",
        "open_issues_count": 687,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-01-29T19:50:25Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-01-29T18:34:16Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 135,
    "deletions": 9,
    "changed_files": 3,
    "commits": 5,
    "review_comments": 19,
    "comments": 5
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZkZjlmNjY5MDlhMzU0YTk1ZjRiN2M1ZjA5MmYwZTlmYmUxYmFhN2M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
      "tree": {
        "sha": "8e93b59d21a004b2f7806464800cdf1014afc88c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8e93b59d21a004b2f7806464800cdf1014afc88c"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 8e93b59d21a004b2f7806464800cdf1014afc88c\nparent 05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89\nauthor furszy <matiasfurszyfer@protonmail.com> 1703084833 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1705360162 -0300\n\ntest: wallet db, exercise deadlock after write failure\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWluyIACgkQXdI8zGhq\npiOfzw/6Az5/FcwvnrW5Zb9QTGZubQkEGERTDcqv4ZxykUUL76lKJ2FiV4waUKWP\nTQXFbzfZvwA8sVsg1sf7ve4rHr0YP1Kp92lUBMwjBQ9ikfeZQOt+91jSVQFW8TXr\nMnzV/maS/oimI/rPm0JUoOejBmvxYGN5ehRyrlJJY0iYsS+GUF9X7rgZy0Po7H8E\nQ6aaefWX3C2lTviIFylslUU1+x4pZA/a3sxm/y6LrrM/abBNL3gm1octxKAt28Xf\n61mAs8GWxhLY9qibk8/4hb1RtE7i5StFecaXxpgXN/ZzVUL4CQxSWwns2dcGwqpU\n3qyHq0M4aDtTqMYY3URfEm1K17Pq2rHBuPpy9Aa5MkS1cuVsKGdJnfyh5+xBK8hX\nWSaTRGUGrysQt7cKMbFeXRryF5AwwnuPihtARLahFoNcGpcSLLgR70Y3L/tt8SvQ\n/6anIpfYHFmloDgGeZtJbpodnHU5RuZmhltIa2IOordj2rKSni2p9hNBi2zC9N8H\nkVmiTdY7XUczIgsVL1WZ+Pj3nuMG1C1EDgdLJidD4ivlsFs5G4ByROjqwhfMCklS\nr+KBlvHr+IyAFIbCkmcLDVUItXsClKyL0u+681Pf5WkWo6lM6oKLhwi11GKEUvEH\nE+OVZvj5svE5InTBPpUalU5z4l3vFtslx42mF9vS/7dCjEZCLFs=\n=Xq7S\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89",
          "sha": "05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/05c4c5a4347018d6d0e81b8f12cf5bdcaa8b4a89"
        }
      ],
      "message": "test: wallet db, exercise deadlock after write failure",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:09:22Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2023-12-20T15:07:13Z"
      },
      "sha": "fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c"
    },
    {
      "event": "commented",
      "id": 1892913940,
      "node_id": "IC_kwDOABII585w05MU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1892913940",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:41:43Z",
      "updated_at": "2024-01-29T19:32:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/29253).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1849338675) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#29112](https://github.com/bitcoin/bitcoin/pull/29112) (sqlite: Disallow writing from multiple `SQLiteBatch`s by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1892913940",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "labeled",
      "id": 11493057640,
      "node_id": "LE_lADOABII5858JbUhzwAAAAKtCiRo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11493057640",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:41:45Z",
      "label": {
        "name": "Wallet",
        "color": "08a781"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T00:55:53Z",
      "updated_at": "2024-01-16T00:55:53Z",
      "source": {
        "issue": {
          "id": 2047565192,
          "node_id": "PR_kwDOABII585iT-Q8",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29112/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/29112",
          "number": 29112,
          "state": "open",
          "state_reason": null,
          "title": "sqlite: Disallow writing from multiple `SQLiteBatch`s",
          "body": "The way that we have configured SQLite to run means that only one database transaction can be open at a time. Typically, each individual read and write operation will be its own transaction that is opened and committed automatically by SQLite. However, sometimes we want these operations to be batched into a multi-statement transaction, so `SQLiteBatch::TxnBegin`, `SQLiteBatch::TxnCommit`, and `SQLiteBatch::TxnAbort` are used to manage the transaction of the database.\r\n\r\nHowever, once a db transaction is begun with one `SQLiteBatch`, any operations performed by another `SQLiteBatch` will also occur within the same transaction. Furthermore, those other `SQLiteBatch`s will not be expecting a transaction to be active, and will abort it once the `SQLiteBatch` is destructed. This is problematic as it will prevent some data from being written, and also cause the `SQLiteBatch` that opened the transaction in the first place to be in an unexpected state and throw an error.\r\n\r\nTo avoid this situation, we need to prevent the multiple batches from writing at the same time. Although SQLite does have facilities for doing that, they require the Write Ahead Log (WAL) mode, which is a feature that we explicitly chose to disable since it spread wallet data to multiple files. As such, we need to be handling the concurrency ourselves. To do so, I've implemented added a `CSemaphore` within `SQLiteDatabase` which will be used by any `SQLiteBatch` trying to do a write operation. `wait()` is called by `TxnBegin`, and at the beginning of `WriteKey`, `EraseKey`, and `ErasePrefix`. `post()` is called in `TxnCommit`, `TxnAbort` and at the end of `WriteKey`, `EraseKey`, and `ErasePrefix`. To avoid deadlocking on ` TxnBegin()` followed by a `WriteKey()`, `SQLiteBatch will now also track whether a transaction is in progress so that it knows whether to use the semaphore.\r\n\r\nThis issue is not a problem for BDB wallets since BDB uses WAL and provides transaction objects that must be used if an operation is to occur within a transaction. Specifically, we either pass a transaction pointer, or a nullptr, to all BDB operations, and this allows for concurrent transactions so it doesn't have this problem.\r\n\r\nFixes #29110",
          "user": {
            "login": "achow101",
            "id": 3782274,
            "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/achow101",
            "html_url": "https://github.com/achow101",
            "followers_url": "https://api.github.com/users/achow101/followers",
            "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
            "organizations_url": "https://api.github.com/users/achow101/orgs",
            "repos_url": "https://api.github.com/users/achow101/repos",
            "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/achow101/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 149424,
              "node_id": "MDU6TGFiZWwxNDk0MjQ=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet",
              "name": "Wallet",
              "color": "08a781",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "milestone": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61",
            "html_url": "https://github.com/bitcoin/bitcoin/milestone/61",
            "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones/61/labels",
            "id": 9334188,
            "node_id": "MI_kwDOABII584Ajm2s",
            "number": 61,
            "state": "open",
            "title": "27.0",
            "description": "",
            "creator": {
              "login": "sipa",
              "id": 548488,
              "node_id": "MDQ6VXNlcjU0ODQ4OA==",
              "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
              "gravatar_id": "",
              "url": "https://api.github.com/users/sipa",
              "html_url": "https://github.com/sipa",
              "followers_url": "https://api.github.com/users/sipa/followers",
              "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
              "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
              "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
              "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
              "organizations_url": "https://api.github.com/users/sipa/orgs",
              "repos_url": "https://api.github.com/users/sipa/repos",
              "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
              "received_events_url": "https://api.github.com/users/sipa/received_events",
              "type": "User",
              "site_admin": false
            },
            "open_issues": 7,
            "closed_issues": 33,
            "created_at": "2023-04-27T08:01:57Z",
            "updated_at": "2024-01-29T17:31:51Z"
          },
          "locked": false,
          "comments": 7,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29112",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/29112",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/29112.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/29112.patch"
          },
          "created_at": "2023-12-18T22:27:10Z",
          "updated_at": "2024-01-17T23:42:04Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T06:37:20Z",
      "updated_at": "2024-01-16T06:37:20Z",
      "source": {
        "issue": {
          "id": 1958204865,
          "node_id": "PR_kwDOABII585dlfBo",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28710/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/28710",
          "number": 28710,
          "state": "open",
          "state_reason": null,
          "title": "Remove the legacy wallet and BDB dependency",
          "body": "The final step of #20160.\r\n\r\nA bare minimum of legacy wallet code is kept in order to perform wallet migration. Migration of legacy wallets uses the independent BDB parser and a minimal `LegacyDataSPKM` that allows the legacy data to be loaded so that the migration can be completed.\r\n\r\nAll tests which tested legacy wallet behavior have been removed. The `--descriptors` and `--legacy-wallet` options are removed from the functional tests.\r\n\r\nBDB has been removed as a dependency and documentation have been updated to reflect that.\r\n\r\nDepends on #26596",
          "user": {
            "login": "achow101",
            "id": 3782274,
            "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
            "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/achow101",
            "html_url": "https://github.com/achow101",
            "followers_url": "https://api.github.com/users/achow101/followers",
            "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
            "organizations_url": "https://api.github.com/users/achow101/orgs",
            "repos_url": "https://api.github.com/users/achow101/repos",
            "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/achow101/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 955867938,
              "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
              "name": "Needs rebase",
              "description": "",
              "color": "cccccc",
              "default": false
            },
            {
              "id": 5334691551,
              "node_id": "LA_kwDOABII588AAAABPfju3w",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
              "name": "CI failed",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 2,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28710",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/28710",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/28710.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/28710.patch"
          },
          "created_at": "2023-10-23T23:36:07Z",
          "updated_at": "2024-01-25T21:20:32Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 1824875743,
      "node_id": "PRR_kwDOABII585sxWTf",
      "url": null,
      "actor": null,
      "commit_id": "fb9e1b3074ff5911b11fcfe918a59a843a2dbd64",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1824875743",
      "submitted_at": "2024-01-16T20:11:53Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11503442522,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAKtqJpa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11503442522",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T20:19:20Z"
    },
    {
      "event": "milestoned",
      "id": 11504178197,
      "node_id": "MIE_lADOABII5858JbUhzwAAAAKts9QV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11504178197",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-16T21:50:58Z",
      "milestone": {
        "title": "27.0"
      }
    },
    {
      "event": "comment_deleted",
      "id": 11559368171,
      "node_id": "CDE_lADOABII5858JbUhzwAAAAKw_fXr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11559368171",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-22T16:47:06Z"
    },
    {
      "event": "commented",
      "id": 1906252904,
      "node_id": "IC_kwDOABII585xnxxo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1906252904",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-23T15:09:48Z",
      "updated_at": "2024-01-23T15:09:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in e5217fea1516120643f4a7a55a474648e21e2269 is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1906252904",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "reviewed",
      "id": 1843953699,
      "node_id": "PRR_kwDOABII585t6IAj",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "> I'm trying to understand this, but confused about why executing \"ROLLBACK TRANSACTION\" would be expected to fail in sqlite. It seems like the fix in [e5217fe](https://github.com/bitcoin/bitcoin/commit/e5217fea1516120643f4a7a55a474648e21e2269) is handling failure to roll back by trying to close and reopen the database. But I don't understand why rolling back a transaction would fail to begin with, unless there was some serious error like disk corruption. Probably to make the this fix clearer and safer it would be good to check the specific error code from the failed rollback instead of just checking res == SQLITE_OK. But I'm generally just confused.\r\n\r\nThe current sqlite configuration doesn't allow concurrent database transactions (see #29112). This means that if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection), the created transaction will remain active indefinitely, contrary to what all workflows expect. This situation provoques that any subsequent write operation on a new database handler (WalletBatch; it doesn't necessarily need to begin a new transaction, could also be a direct write) will dump information that was intended to be rolled back to disk. \r\n\r\nCheck https://github.com/bitcoin/bitcoin/pull/29112#pullrequestreview-1821862931 to see the test that originated this work.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1843953699",
      "submitted_at": "2024-01-25T15:02:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "commented",
      "id": 1910522489,
      "node_id": "IC_kwDOABII585x4EJ5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910522489",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T16:09:58Z",
      "updated_at": "2024-01-25T16:09:58Z",
      "author_association": "CONTRIBUTOR",
      "body": ">  if there is a failure during the WalletBatch destruction (independently on if it is due to a fatal or transient and recoverable error, like a busy db or a loss of the db connection)\r\n\r\nYes I've started reviewing both PR's and the code changes seem reasonable, I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910522489",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "commented",
      "id": 1910567093,
      "node_id": "IC_kwDOABII585x4PC1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1910567093",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T16:33:31Z",
      "updated_at": "2024-01-25T16:33:31Z",
      "author_association": "MEMBER",
      "body": "> seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs?\r\n\r\nIt shouldn't ever happen.\r\n\r\nIn general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "reviewed",
      "id": 1838949232,
      "node_id": "PRR_kwDOABII585tnCNw",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review d4ebac8381801d024b69d5f1f5a13246c61edbe4. This seems like a nice change that could make the wallet more reliable, and adds good cleanup and test coverage.\r\n\r\nDid not ack just because I noticed a bug in SQLiteBatch::TxnBegin if `m_db` is null, but none of my other comments are too important, so feel free to ignore them.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1910567093\r\n\r\n> In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n\r\nYeah that sounds pretty close to ideal. Maybe not an urgent problem to solve, but could be nice.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1838949232",
      "submitted_at": "2024-01-25T21:30:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "commented",
      "id": 1911119751,
      "node_id": "IC_kwDOABII585x6V-H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1911119751",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-25T22:47:39Z",
      "updated_at": "2024-01-26T14:03:39Z",
      "author_association": "MEMBER",
      "body": "> I just don't understand what motivated this PR, because \"failure during the WalletBatch destruction\" seems like something I would never expect to happen unless someone modified the code or manually corrupted the data on disk. So I'm wondering did we accidentally cause a breakage like that during development of these PRs? Or did you just notice that the error handling in the destructor wasn't very good, and decide to fix it? Or can failures to roll back actually happen in more cases than it seems, and this is a bug that could happen during normal operation without data corruption?\r\n\r\nYeah, I just noted that the error handling in the destructor isn't optimal. That if this ever occurs in #29112, the introduced database mutex would lock indefinitely.\r\nThen, I considered the same event in current master: which could lead to the writing of a dangling transaction to disk, which would corrupt the wallet and leave it at a non-recoverable point. Which is quite bad. And that motivated me to split the PR and force the txn rollback within the WalletBatch context as a last resource safety measure.\r\n\r\n> In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n\r\nIt wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\nAt least in this scenario, where we are destroying the object that created the transaction, I believe triggering the database connection reset is acceptable as a first measure. If it fails, then yeah, I agree that unloading the wallet instead of exiting the node would be desirable.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1911119751",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/29253"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUzYzRmMTMzNGVlMzAwZTIyMjg5NzRiNGFiY2E1MWMzODA4N2M1MWM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/53c4f1334ee300e2228974b4abca51c38087c51c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/53c4f1334ee300e2228974b4abca51c38087c51c",
      "tree": {
        "sha": "7a2b69923ae2da5d2f3d7a4057877bf6eb067217",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7a2b69923ae2da5d2f3d7a4057877bf6eb067217"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 7a2b69923ae2da5d2f3d7a4057877bf6eb067217\nparent fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c\nauthor furszy <matiasfurszyfer@protonmail.com> 1704723505 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706273273 -0300\n\nsqlite: add ability to interrupt statements\n\nBy encapsulating sqlite3_exec into its own standalone method\nand introducing the 'SQliteExecHandler' class, we enable the\nability to test db statements execution failures within the\nunit test framework.\n\nThis is used in the following-up commit to exercise a deadlock\nand improve our wallet db error handling code.\n\nMoreover, the future encapsulation of more sqlite functions\nwithin this class will contribute to minimize the impact of\nany future API changes.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWzqfkACgkQXdI8zGhq\npiOFYRAAgLbvJxy6AFz5U/xDJMO2ADnLIjmkmp5UtRejiZ0wELgrAtXQTXCOZ55k\ni16pj3lYY0AyomqOrNu/K2XCdnUj6pgR7aJi9l7nPXS1RKpZOx+B15LwZuP77fEM\ngqirj5zgGJA4TS/KZ6zDOvYbUtIVoMwvlU3o7Q+AY/TLbP/c1dptBGH8CdrU8XP/\nk7jMaxMPixrJlWfiKyYxhXMT4vbSz8np8VSsBJ8ijH4Zs4FrJLG2+OkIho0geF3l\n8if7Bnswxse7qjdjpLzfQeun1Z4U5xjsvcxzILvb5X9ibHgY6dZJiVe5q16g6FGg\nTXboafpSpwxEmYeqShMRKww6Q/s5ahXF9EJOaBQqkKpFlOZ6d0k35NhLGlAIC95N\npi465L3bLSsb/R+zt0x+73Xxjjf9S89on42VZPvdjUlFGVevZfZyZ3YCFcRnhoYA\nIAkdOmY5vUO0ObCI8tZ7sIk6rau+xLSWPDl8IiVL+Gty+jMk8ZT3k+6YZfJ0I6PU\nECb+qtb3LdCcsnJTNxPF8InbjufuhvuUtDeWJGFroij6DOAsA/hwAUDv25ll0RKV\nO0TivdLtF0ORkvn48mvwjhcuYZbgkJvwwa3g7+ShOpJcfZtqD9wj5k5TSg5Iu4Qt\nJaKC/HEljO4oNPTZN1KKK67Q3Win5/a72sjmqr87csatvI32nLA=\n=m7jC\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
          "sha": "fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fdf9f66909a354a95f4b7c5f092f0e9fbe1baa7c"
        }
      ],
      "message": "sqlite: add ability to interrupt statements\n\nBy encapsulating sqlite3_exec into its own standalone method\nand introducing the 'SQliteExecHandler' class, we enable the\nability to test db statements execution failures within the\nunit test framework.\n\nThis is used in the following-up commit to exercise a deadlock\nand improve our wallet db error handling code.\n\nMoreover, the future encapsulation of more sqlite functions\nwithin this class will contribute to minimize the impact of\nany future API changes.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-26T12:47:53Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-08T14:18:25Z"
      },
      "sha": "53c4f1334ee300e2228974b4abca51c38087c51c"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGU2YzM4M2M0MWM2YTQ3ZGUxNzhjZGExYjBhZTczMjA0NTM0NWE1NWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e6c383c41c6a47de178cda1b0ae732045345a55e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e6c383c41c6a47de178cda1b0ae732045345a55e",
      "tree": {
        "sha": "19a342a6d97608aabe9125ed1846697ba08b4cb2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/19a342a6d97608aabe9125ed1846697ba08b4cb2"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 19a342a6d97608aabe9125ed1846697ba08b4cb2\nparent 53c4f1334ee300e2228974b4abca51c38087c51c\nauthor furszy <matiasfurszyfer@protonmail.com> 1705360714 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706273623 -0300\n\nsqlite: introduce HasActiveTxn method\n\nUtil function to clean up code and let us\nverify, in the following-up commit, that dangling,\nto-be-reverted db transactions cannot occur anymore.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWzq1kACgkQXdI8zGhq\npiNuHQ//U1YEayYgbg7fzp6rR7itXQKcYaJzo7sx8Y7XX3FuDUiv8L2GZqchHLcu\nUKxIvVh93NdcOv9GbKvOcrK/750B0gdwQGMrqmbw3kZqZONtR/IcPmzUSpd9vQud\nb3owIRh1WYRW8sFGH/zihSN7VJhzV+Xqfl9HbVH0UlHz7dSSLvm/W/A9KnMx9l/B\nbKwugps8F+MIPVddfxf8ilfbVxQYCumLL7ptoFFAphyGi44FpG1XslIq6VkzFh8+\n1RkNSXqh0UXdQjTifyBxWviOJbYViIXktu1w1pMC0OrOTNlZrfwOd5gXfBvi5B8F\nY6P8XtCqfkM3YPy/t2W1m7GNp3CpWP6d97CW7qc7iXSx8YhbqzG4VnL0SatpSLsp\nl8w0IUfLS0GtIuaktHOFKk5OqhHdSMav/MQ+rGOQWeOnewh/c0eR6eySKJutj348\ngNmg1u7b91CB+BZQEHa0838Uay0IFf+emr6aN6fg2EP32BdQtSUbAmv9E9bK3/AC\nhF0wN1OaKcAgJpRNTP6/qS/pF8Gft95wn0jUXxXMAhedorv+HAJFnsBz+O81UNPh\naS8xBik9f2ZIVz8TSQ5vkEqdppV3v3OfiStzvO5wY+FrT3eqp6JawZzkAKZZjsxn\nUCPy4KJT3GW7Cafp8graiW/BSq8vbLo/q9B8AvV4RdEs3RvljzE=\n=XjHg\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/53c4f1334ee300e2228974b4abca51c38087c51c",
          "sha": "53c4f1334ee300e2228974b4abca51c38087c51c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/53c4f1334ee300e2228974b4abca51c38087c51c"
        }
      ],
      "message": "sqlite: introduce HasActiveTxn method\n\nUtil function to clean up code and let us\nverify, in the following-up commit, that dangling,\nto-be-reverted db transactions cannot occur anymore.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-26T12:53:43Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:18:34Z"
      },
      "sha": "e6c383c41c6a47de178cda1b0ae732045345a55e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBiZjNhNzM1NmRiMjI0ZDI4YTg2MTk0YjAwNGNhMzA1NDkxOTdmMjc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0bf3a7356db224d28a86194b004ca30549197f27",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0bf3a7356db224d28a86194b004ca30549197f27",
      "tree": {
        "sha": "d54180ed8f8c5db8ea6396cac87b66b37f760bbf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d54180ed8f8c5db8ea6396cac87b66b37f760bbf"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree d54180ed8f8c5db8ea6396cac87b66b37f760bbf\nparent e6c383c41c6a47de178cda1b0ae732045345a55e\nauthor furszy <matiasfurszyfer@protonmail.com> 1705362189 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706274268 -0300\n\nsqlite: guard against dangling to-be-reverted db transactions\n\nIf the handler that initiated the database transaction is destroyed,\nthe ongoing transaction cannot be left dangling when the db txn fails\nto abort. It must be forcefully reversed; otherwise, any subsequent\ndb handler executing a write operation will dump the dangling,\nto-be-reverted transaction data to disk.\n\nThis not only breaks the database isolation property but also results\nin the improper storage of incomplete information on disk, impacting\nthe wallet consistency.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWzrdwACgkQXdI8zGhq\npiMRVg/+N1lkd9MAqoZusFtaFb88+76QNz7C3DbWjYsQCwbHgoRaWKxZER595Qlr\n4Y6LVHuUt1dIz80WEhdXeE41qNxBzbFZ6zoRt2INgiu+q6pb3HAN4sbaMVYGfrje\nPTWJLWqQ1ct0xSNLHFWBF+nSJNP44FIinTQc4B33Yx6wmabrzzjfcqIIjqfSHhi8\n1Hp241WLs1d09P1W8QCuTdgaWmrs3/AK3Fj5yn/hca6Vu4aCv3jSGcHhysTDuPO5\nx4DOYdoaz5t+3WcM8EQKT7WtY9loyf8QBs08Qbw/y/O4kABr0sZIYPWoVRdxKkoi\n2tB/dkMTbrJQRkxy71eZlkjYwrQTaWHDTv4vbnvE3vqDJNCU8ng/h4cdVh7+FnRv\nLD8bxCNoK60a2rbpHIGy82+G8T20dcACEJzvOr9ZBCn0WY4PuhSGUrmx9x2d58KT\nY6T7Cy7BCyySSq23rWow4CMMN7HAXU159UObT2Sjml822hyrZzyXgptiwrTVBNYo\nDc8v5PRvZ6y+PdSc58D0vjXE6pUPbIbgG1bJD4H1B+5xhLDQ+4BcOMd9DxcQTlf5\nHkHNaiEFSZLgtfh7bf+nOJjP2p4FdL76aUCzfZ0BUWimtOykao1xEuDd1gg6shle\n0SYJOn9qIjpyGfC2YDs0BHNnFRNqYytY4D2a/mKG6qIk3PEA5H8=\n=zRn3\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e6c383c41c6a47de178cda1b0ae732045345a55e",
          "sha": "e6c383c41c6a47de178cda1b0ae732045345a55e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e6c383c41c6a47de178cda1b0ae732045345a55e"
        }
      ],
      "message": "sqlite: guard against dangling to-be-reverted db transactions\n\nIf the handler that initiated the database transaction is destroyed,\nthe ongoing transaction cannot be left dangling when the db txn fails\nto abort. It must be forcefully reversed; otherwise, any subsequent\ndb handler executing a write operation will dump the dangling,\nto-be-reverted transaction data to disk.\n\nThis not only breaks the database isolation property but also results\nin the improper storage of incomplete information on disk, impacting\nthe wallet consistency.",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-26T13:04:28Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-15T23:43:09Z"
      },
      "sha": "0bf3a7356db224d28a86194b004ca30549197f27"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ5M2NmYzcyOGFhNzgzNTUyN2IxZWFiMTc5YjhjYjM2ZWRkNjA5NDY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/493cfc728aa7835527b1eab179b8cb36edd60946",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/493cfc728aa7835527b1eab179b8cb36edd60946",
      "tree": {
        "sha": "db81606db6ce91e4077771fcbece49e90d94f575",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/db81606db6ce91e4077771fcbece49e90d94f575"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree db81606db6ce91e4077771fcbece49e90d94f575\nparent 0bf3a7356db224d28a86194b004ca30549197f27\nauthor furszy <matiasfurszyfer@protonmail.com> 1704723565 -0300\ncommitter furszy <matiasfurszyfer@protonmail.com> 1706274268 -0300\n\ntest: sqlite, add coverage for dangling to-be-reverted db txns\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEA++0fqwRHQpmlZfQXdI8zGhqpiMFAmWzrdwACgkQXdI8zGhq\npiOAFQ//b8BGqCJ5Kr95FpouBv/HdoqbT1zFxM3/KIeuyXEQSavlZc7GdaJP/7Cf\naktxDC9hHhcjPqglsMVu52VhUtHE6Kc5OdCoswQin17wA7cZwnd8GCP9Sm0rQuqP\njEsMBrdFhweQcoL8tQkXKAfjBDSgMFNejJ9w9u88IdybhN/VVqa2/OFsYxmivJM9\nfeYStP66thSsnp46nIo7cMSIQ48/aJtJlE42cQxxFSAiWRhU/l8AJ0O0Jg61mbKT\nduzvizDg1ucuigTJ/oMrjq942mdwh7MYfah8CCVLRw1jFTeNyzT3dDCtaqtZZYHH\nI/tJbcaCWSJk4a+XnES6O+ZYPB+4sz8AgM9Gz2EgSiYKMdPFpptF+5/9yt5GiWAB\nYsPNhUhwgWbsmak7ja1sqPUeNPkSu+lTzVEJ+H0QemiAEwZsKTqCRtVYXCchEGVT\npUYXcEQmlZVWs20XKSoofyv480MwS1HLlabnjT3usRjb4avxVq85KixiL/TBwqMR\nuFMH3OPBb0q0HgXJh+VvlPGQ92jzQxlfOaelFYRqA1m1f38FWuKx96AeJibNfdcJ\nFOYigJn1p0Qo/bLG38xBBpGkaWVsmxNy6NpU8n3Y2gzNRHMH0W5If3b50Ogngkvi\n9uhbt46SHoojh+/yB9FLaKLbLmXaA6ll/kibnKabyhGnpzk9Z7E=\n=hqfh\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0bf3a7356db224d28a86194b004ca30549197f27",
          "sha": "0bf3a7356db224d28a86194b004ca30549197f27",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0bf3a7356db224d28a86194b004ca30549197f27"
        }
      ],
      "message": "test: sqlite, add coverage for dangling to-be-reverted db txns",
      "committer": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-26T13:04:28Z"
      },
      "author": {
        "name": "furszy",
        "email": "matiasfurszyfer@protonmail.com",
        "date": "2024-01-08T14:19:25Z"
      },
      "sha": "493cfc728aa7835527b1eab179b8cb36edd60946"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 11608736531,
      "node_id": "HRFPE_lADOABII5858JbUhzwAAAAKz70MT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11608736531",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-01-26T13:07:11Z"
    },
    {
      "event": "reviewed",
      "id": 1845717595,
      "node_id": "PRR_kwDOABII585uA2pb",
      "url": null,
      "actor": null,
      "commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Updated per feedback, thanks @ryanofsky!\r\n\r\nThe main modification resides in the `ExecHandler` class, which is now designed to encapsulate all sqlite functions. This enables us to trigger different errors across the database sources; letting us improve the error-handling code and expand its test coverage. Furthermore, future encapsulation of sqlite functions within this class will contribute to minimizing the impact of any future API changes.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1845717595",
      "submitted_at": "2024-01-26T13:32:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    },
    {
      "event": "reviewed",
      "id": 1849338675,
      "node_id": "PRR_kwDOABII585uOqsz",
      "url": null,
      "actor": null,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 493cfc728aa7835527b1eab179b8cb36edd60946. I left more more comments about comments (feel free to ignore), but otherwise this looks good.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/29253#issuecomment-1911119751\r\n\r\n> > In general, we don't have very robust error handling for when the database fails to read or write something. I think this should actually be more like an assert, but one that doesn't kill the whole software, maybe just unloads the wallet?\r\n> \r\n> It wouldn't be ideal if the error is still recoverable (e.g. [SQLITE_BUSY](https://sqlite.org/rescode.html#busy) if we ever introduce concurrent txns).\r\n\r\nIn this case do we ever think we should see SQLITE_BUSY while trying to abandon a transaction? But yes in general we should treat expected errors and unexpected errors differently, and not handle expected errors by unloading the wallet.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#pullrequestreview-1849338675",
      "submitted_at": "2024-01-29T19:32:24Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110",
      "pull_request_review_id": 1824875743,
      "id": 1453968110,
      "node_id": "PRRC_kwDOABII585Wqcru",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": 65,
      "original_position": 26,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "83c807a380b41787214806c6440236ea1a9dabd7",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 83c807a380b41787214806c6440236ea1a9dabd7 \"sqlite: introduce HasActiveTxn method\"\r\n\r\n`HasActiveTxn()` checks for `m_db` already, so no need to do check that here too.\r\n\r\nSame for `TxnCommit()` and `TxnAbort()`.",
      "created_at": "2024-01-16T20:10:05Z",
      "updated_at": "2024-01-16T20:11:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453968110",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453968110"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 638,
      "original_line": 638,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729",
      "pull_request_review_id": 1824891279,
      "id": 1453982729,
      "node_id": "PRRC_kwDOABII585WqgQJ",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (!m_database.m_db || m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": 65,
      "original_position": 26,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "83c807a380b41787214806c6440236ea1a9dabd7",
      "in_reply_to_id": 1453968110,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "upps done",
      "created_at": "2024-01-16T20:22:19Z",
      "updated_at": "2024-01-16T20:22:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1453982729",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1453982729"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 638,
      "original_line": 638,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113",
      "pull_request_review_id": 1838949232,
      "id": 1463377113,
      "node_id": "PRRC_kwDOABII585XOVzZ",
      "diff_hunk": "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nIt would be good to define -999 as a constant so callers could check for this error. Or if there probably won't be a need for callers to do that, it would be clearer to return SQLITE_ERROR.",
      "created_at": "2024-01-23T14:36:43Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1463377113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1463377113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 498,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843",
      "pull_request_review_id": 1838949232,
      "id": 1466931843,
      "node_id": "PRRC_kwDOABII585Xb5qD",
      "diff_hunk": "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 4,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (ca39d812e4766575e25721296fa2d43dfe7eba7e)\r\n\r\nWould suggest calling this `SQliteExecBlocker`, or maybe `SQliteExecHook` or `SQliteTestHook` if you anticipate it being used more broadly for other things in the future. \"ExecHandler\" seems like the wrong name because the class itself isn't executing anything and doesn't call sqlite3_exec.\r\n\r\nWould also suggest adding a comment saying this is used for testing, because otherwise it's not clear why `CanExecute` would ever return false.\r\n\r\nAlso, in case you _don't_ anticipate the class being extended used for other things in the future, you could replace it with a std::function, since it does only have one virtual method.",
      "created_at": "2024-01-25T20:34:21Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466931843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466931843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379",
      "pull_request_review_id": 1838949232,
      "id": 1466947379,
      "node_id": "PRRC_kwDOABII585Xb9cz",
      "diff_hunk": "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "path": "src/wallet/sqlite.cpp",
      "position": 7,
      "original_position": 6,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nIt would be nice to have a comment explaining the use of sqlite3_get_autocommit, since the name doesn't really explain what it is doing. Maybe \"// sqlite3_get_autocommit returns true by default, and false if a transaction has begun and not been committed or rolled back.\"\r\n\r\nAlso, I noticed https://www.sqlite.org/c3ref/get_autocommit.html says \"If another thread changes the autocommit status of the database connection while this routine is running, then the return value is undefined\" so it seems like we probably need to be using a mutex for this. (That would be a pre-existing issue not related to this PR.)",
      "created_at": "2024-01-25T20:50:38Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466947379",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466947379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 383,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925",
      "pull_request_review_id": 1838949232,
      "id": 1466953925,
      "node_id": "PRRC_kwDOABII585Xb_DF",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nThere appears to be a bug here. Previously it would return false if `m_db` is null. Now it will try to execute begin transaction. I think you need to keep the `!m_database.m_db` condition",
      "created_at": "2024-01-25T20:58:31Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466953925",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466953925"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 620,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009",
      "pull_request_review_id": 1838949232,
      "id": 1466956009,
      "node_id": "PRRC_kwDOABII585Xb_jp",
      "diff_hunk": "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: introduce HasActiveTxn method\" (5670a21f5ef28748b6b7242c03b82f39dcbc983f)\r\n\r\nWould be good to drop the parenthetical about autocommit mode here, since that's now an implementation detail of HasActiveTxn()",
      "created_at": "2024-01-25T21:00:59Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466956009",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466956009"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 402,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956",
      "pull_request_review_id": 1838949232,
      "id": 1466966956,
      "node_id": "PRRC_kwDOABII585XcCOs",
      "diff_hunk": "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (508fda2fddfef0cefedde9777c914aec72adf7fb)\r\n\r\nI found this comment confusing because I couldn't figure out when failing to abort a transaction would ever be expected to happen, and what the error handling strategy was supposed to be when it did happen. Would maybe suggest: \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\n\r\n\r\n",
      "created_at": "2024-01-25T21:14:14Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466966956"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 408,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974",
      "pull_request_review_id": 1838949232,
      "id": 1466968974,
      "node_id": "PRRC_kwDOABII585XcCuO",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"test: sqlite, add coverage for dangling to-be-reverted db txns\" (d4ebac8381801d024b69d5f1f5a13246c61edbe4)\r\n\r\nI think it would be a little more consistent with other code to call this variable \"batch\" instead of \"handler.\" Also calling it handler gets a little confusing when code below sets a handler on the handler.",
      "created_at": "2024-01-25T21:16:43Z",
      "updated_at": "2024-01-25T21:30:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1466968974"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193",
      "pull_request_review_id": 1845717595,
      "id": 1467629193,
      "node_id": "PRRC_kwDOABII585Xej6J",
      "diff_hunk": "@@ -377,6 +377,11 @@ void SQLiteDatabase::Close()\n     m_db = nullptr;\n }\n \n+bool SQLiteDatabase::HasActiveTxn()\n+{\n+    return m_db && sqlite3_get_autocommit(m_db) == 0;",
      "path": "src/wallet/sqlite.cpp",
      "position": 7,
      "original_position": 6,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466947379,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure, done. Comment added.",
      "created_at": "2024-01-26T13:05:00Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629193",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629193"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 383,
      "original_line": 383,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362",
      "pull_request_review_id": 1845717595,
      "id": 1467629362,
      "node_id": "PRRC_kwDOABII585Xej8y",
      "diff_hunk": "@@ -395,7 +400,7 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466956009,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "done",
      "created_at": "2024-01-26T13:05:10Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467629362",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467629362"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 402,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981",
      "pull_request_review_id": 1845717595,
      "id": 1467631981,
      "node_id": "PRRC_kwDOABII585Xeklt",
      "diff_hunk": "@@ -400,11 +400,16 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n void SQLiteBatch::Close()\n {\n     // If m_db is in a transaction (i.e. not in autocommit mode), then abort the transaction in progress\n+    bool force_conn_refresh = false;\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // In case we cannot abort the transaction, prevent other handler/s from dumping the ongoing",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 10,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "508fda2fddfef0cefedde9777c914aec72adf7fb",
      "in_reply_to_id": 1466966956,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure, done. Have slightly rephrased the suggestion. Thanks",
      "created_at": "2024-01-26T13:08:19Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467631981",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467631981"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 408,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309",
      "pull_request_review_id": 1845717595,
      "id": 1467634309,
      "node_id": "PRRC_kwDOABII585XelKF",
      "diff_hunk": "@@ -493,6 +493,12 @@ bool SQLiteBatch::ExecStatement(sqlite3_stmt* stmt, Span<const std::byte> blob)\n     return res == SQLITE_DONE;\n }\n \n+int SQLiteBatch::Exec(const std::string& statement)\n+{\n+    if (m_exec_handler && !m_exec_handler->CanExecute(statement)) return -999;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 6,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": 1463377113,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sure. Created a constant for the -999 error in the new approach.",
      "created_at": "2024-01-26T13:10:36Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634309",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634309"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 498,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537",
      "pull_request_review_id": 1845717595,
      "id": 1467634537,
      "node_id": "PRRC_kwDOABII585XelNp",
      "diff_hunk": "@@ -612,7 +617,7 @@ std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewPrefixCursor(Span<const std::\n \n bool SQLiteBatch::TxnBegin()\n {\n-    if (!m_database.m_db || sqlite3_get_autocommit(m_database.m_db) == 0) return false;\n+    if (m_database.HasActiveTxn()) return false;",
      "path": "src/wallet/sqlite.cpp",
      "position": null,
      "original_position": 26,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "5670a21f5ef28748b6b7242c03b82f39dcbc983f",
      "in_reply_to_id": 1466953925,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "upps thanks. Fixed.",
      "created_at": "2024-01-26T13:10:51Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467634537",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467634537"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 620,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407",
      "pull_request_review_id": 1845717595,
      "id": 1467640407,
      "node_id": "PRRC_kwDOABII585XempX",
      "diff_hunk": "@@ -36,11 +36,20 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class SQliteExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": null,
      "original_position": 4,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "ca39d812e4766575e25721296fa2d43dfe7eba7e",
      "in_reply_to_id": 1466931843,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah, this was meant to be a class encapsulating all sqlite functions so that we can trigger different errors and improve and test our error-handling code. I'm not sure why I implemented `CanExecute` instead of decoupling the `Exec()`, but well.. I just changed the implementation to follow the initial idea. Thanks for pointing this out.",
      "created_at": "2024-01-26T13:17:28Z",
      "updated_at": "2024-01-26T13:33:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467640407",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467640407"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011",
      "pull_request_review_id": 1845717595,
      "id": 1467644011,
      "node_id": "PRRC_kwDOABII585Xenhr",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": 1466968974,
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "So true that it hurts.\r\nI tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process. This is something that the `WalletBatch` class doesn't do unless we explicitly begin and finish the transaction.",
      "created_at": "2024-01-26T13:21:14Z",
      "updated_at": "2024-01-26T13:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1467644011",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1467644011"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356",
      "pull_request_review_id": 1849338675,
      "id": 1469966356,
      "node_id": "PRRC_kwDOABII585XnegU",
      "diff_hunk": "@@ -36,11 +36,26 @@ class SQLiteCursor : public DatabaseCursor\n     Status Next(DataStream& key, DataStream& value) override;\n };\n \n+class ExecHandler",
      "path": "src/wallet/sqlite.h",
      "position": 4,
      "original_position": 4,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "53c4f1334ee300e2228974b4abca51c38087c51c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: add ability to interrupt statements\" (53c4f1334ee300e2228974b4abca51c38087c51c)\r\n\r\nWould suggest a rename and comment.\r\n\r\nThis class is SQLite specific, but unlike other other classes in this file it does not have SQLite in the name. Would suggest calling it `SQliteExecInterface` since it is an abstract class with all virtual methods.\r\n\r\nAlso, it's not initially clear why this class and the class below exist. Would suggest adding a doxygen comment like //* Abstract class responsible for executing SQL statements in SQLite databases. It is abstract so it can be overridden by unit tests testing unusual database conditions. */\r\n\r\n---\r\n\r\nEDIT: Alternately you could combine ExecHandler and SQliteExecHandler into a single class. This would also simplify the unit test because it could just inherit from SQliteExecHandler instead of inheriting from ExecHandler and containing SQliteExecHandler.",
      "created_at": "2024-01-29T17:36:23Z",
      "updated_at": "2024-01-29T19:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1469966356",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1469966356"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 39,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684",
      "pull_request_review_id": 1849338675,
      "id": 1470026684,
      "node_id": "PRRC_kwDOABII585XntO8",
      "diff_hunk": "@@ -405,12 +405,19 @@ SQLiteBatch::SQLiteBatch(SQLiteDatabase& database)\n \n void SQLiteBatch::Close()\n {\n+    bool force_conn_refresh = false;\n+\n     // If we began a transaction, and it wasn't committed, abort the transaction in progress\n     if (m_database.HasActiveTxn()) {\n         if (TxnAbort()) {\n             LogPrintf(\"SQLiteBatch: Batch closed unexpectedly without the transaction being explicitly committed or aborted\\n\");\n         } else {\n-            LogPrintf(\"SQLiteBatch: Batch closed and failed to abort transaction\\n\");\n+            // If the transaction cannot be aborted, it may be due to the database connection being \"busy\", indicating a potential bug or data corruption.\n+            // In such cases, attempt recovery by closing and reopening the database. This action will automatically roll back the transaction,\n+            // ensuring that any changes made since the transaction was opened will be reverted. This prevents dangling transaction data\n+            // outside the context of the 'SQLiteBatch' that initiated such a transaction.",
      "path": "src/wallet/sqlite.cpp",
      "position": 35,
      "original_position": 15,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "0bf3a7356db224d28a86194b004ca30549197f27",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"sqlite: guard against dangling to-be-reverted db transactions\" (0bf3a7356db224d28a86194b004ca30549197f27)\r\n\r\nI think this comment might be more harmful than helpful in its current form, because it isn't communicating the most important thing, which is that this code path is never expected to be hit under normal conditions, and if it is hit, it means something is seriously wrong and there has probably been data loss, if not data corruption. By saying this failure can happen when the connection is \"busy\", it makes it sound like database could just be waiting for a lock. But locking alone could never trigger this, so suggesting that it could raises doubts about the rest of the code, and makes the handling here seem to be unnecessary.\r\n\r\nAlso saying \"this action will automatically rollback the transaction ensuring...\" seems like an overstatement. Even if it's probably true, we are in the middle of recovering from some other significant bug or I/O error, so this comment seems to be going out on a limb to make a guarantee that isn't clearly significant. It is also unclear to me what \"transaction data outside the context of the 'SQLiteBatch'\" would refer to if SQLiteBatch is the class responsible for creating transactions.\r\n\r\nConsidering all this, I'd probably suggest still going with my original comment from https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466966956 which was \"// If transaction cannot be aborted, it means there is a bug or there has been data corruption. Try to recover in this case by closing and reopening the database. Closing the database should also ensure that any changes made since the transaction was opened will be rolled back.\"\r\n\r\nBut maybe this comment is missing some other information that you wanted to get across?",
      "created_at": "2024-01-29T18:28:52Z",
      "updated_at": "2024-01-29T19:33:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470026684",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470026684"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": 415,
      "original_start_line": 415,
      "start_side": "RIGHT",
      "line": 418,
      "original_line": 418,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536",
      "pull_request_review_id": 1849338675,
      "id": 1470035536,
      "node_id": "PRRC_kwDOABII585XnvZQ",
      "diff_hunk": "@@ -228,6 +228,52 @@ BOOST_AUTO_TEST_CASE(db_availability_after_write_error)\n     }\n }\n \n+#ifdef USE_SQLITE\n+\n+class DbExecBlocker : public SQliteExecHandler\n+{\n+public:\n+    bool CanExecute(const std::string& statement) override {\n+        if (statement == \"ROLLBACK TRANSACTION\") return false;\n+        return true;\n+    }\n+};\n+\n+BOOST_AUTO_TEST_CASE(txn_close_failure_dangling_txn)\n+{\n+    // Verifies that there is no active dangling, to-be-reversed db txn\n+    // after the batch object that initiated it is destroyed.\n+    DatabaseOptions options;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::unique_ptr<SQLiteDatabase> database = MakeSQLiteDatabase(m_path_root / \"sqlite\", options, status, error);\n+\n+    std::string key = \"key\";\n+    std::string value = \"value\";\n+\n+    std::unique_ptr<SQLiteBatch> handler = std::make_unique<SQLiteBatch>(*database);",
      "path": "src/wallet/test/db_tests.cpp",
      "position": null,
      "original_position": 27,
      "commit_id": "493cfc728aa7835527b1eab179b8cb36edd60946",
      "original_commit_id": "d4ebac8381801d024b69d5f1f5a13246c61edbe4",
      "in_reply_to_id": 1466968974,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1466968974\r\n\r\n> I tend to call the `WalletBatch` handler because 'batch' refers to a class that groups operations and dumps the result all at once atomically at the end of the process.\r\n\r\n:grinning: yeah very used to seeing bland names that don't mean anything because someone rejected an an actually descriptive name for a pedantic reason. In this case, I think a batch is just a collection of actions done together. Metaphors are ok once in a while.",
      "created_at": "2024-01-29T18:36:30Z",
      "updated_at": "2024-01-29T19:32:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/29253#discussion_r1470035536",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1470035536"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/29253"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 254,
      "side": "RIGHT"
    }
  ]
}