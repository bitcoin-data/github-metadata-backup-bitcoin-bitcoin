{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083",
    "id": 3107664562,
    "node_id": "PR_kwDOABII5865OzKy",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/34083",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/34083.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/34083.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/cdfca84e235ead4306aadbf27df561964bcd6c2e",
    "number": 34083,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "Add initial vectorized chacha20 implementation for 2-3x speedup",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "body": "Exploit modern simd to calculate 2/4/6/8/16 states at a time depending on the size of the input.\r\n\r\nThis demonstrates a 2x speedup on x86-64 and 3x for arm+neon. Platforms which require runtime detection (avx2/avx512) improve performance even further, and will come as a follow-up.\r\n\r\nRather than hand-writing assembly or using arch-specific intrinsics, this is written using compiler built-ins understood by gcc and clang.\r\n\r\nIn practice (at least on x86_64 and armv8), the compilers are able to produce assembly that's not much worse than hand-written.\r\n\r\nThis means that every architecture can benefit from its own vectorized instructions without having to write/maintain an implementation for each one. But because each will vary in ability to exploit the parallelism, we allow (via ifdefs) each architecture to opt-out of some or all multi-state calculation at compile-time..\r\n\r\nHere, as a starting point, x86-64 and arm+neon have been defined based on local benchmarks.\r\n\r\nLocal profiling revealed that chacha20 accounts for a substantial amount of the network thread's time. It's not clear to me if speeding up chacha20 will improve network performance/latency, but it will definitely make it more efficient.\r\n\r\nThis is part 1 of a series of PR's for chacha20. I think it makes sense to take a look at the generic implementation and tune the architecture-specific defines for parallel blocks before adding the runtime-dependent platforms.\r\n\r\nMy WIP branch which includes avx2/avx512 can be seen here: https://github.com/theuni/bitcoin/commits/chacha20-vectorized/\r\n\r\nI've been hacking on this for quite a while, trying every imaginable tweak and comparing lots of resulting asm/ir. I'm happy to answer any questions about any choices made which aren't immediately obvious.\r\n\r\nEdit: some more impl details:\r\n\r\nI wrestled with gcc/clang a good bit, tweaking something and comparing the generated code output. A few things I found, which may explain some of the decisions I made:\r\n\r\n- gcc really wanted to inline some of the helpers, which comes at a very substantial performance cost due to register clobbering (and with avx2, `vzeroupper`). Hence, all helpers are decorated with `ALWAYS_INLINE`.\r\n- gcc/clang do well with the vec256 loads/stores with minimal fussing. Though loading each element with `[]` is clumsy and verbose, it avoids compiler-specific layout assumptions. Other things I tried (which produced the same asm):\r\n  - casting directly to `using unaligned_vec256 __attribute__((aligned (1))) = vec256`\r\n  - memcpy into ^^\r\n  - clang's `__builtin_masked_load`\r\n- Loop unrolling was hit-or-miss without `#pragma GCC unroll n`, and I tried to avoid macros for loops, hence the awkward recursive inline template loops. But in practice, I see those unrolled 100% of the time.\r\n- I used `std::get` in the helpers for some extra compile-time safety (this actually pointed out some off-by-one's that would've been annoying to track down)\r\n- I avoided using any lambdas or classes for fear of compilers missing obvious optimizations\r\n- All `vec256` are passed by reference to avoid an annoying clang warning about returning a vector changing the abi (this is specific to x86 when not compiling with `-avx`). Even though our functions are all inlined, I didn't see any harm in making that adjustment.",
    "labels": [],
    "created_at": "2025-12-16T20:42:37Z",
    "updated_at": "2026-01-13T19:34:47Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "77dab6aaa833c9f279e84ca1d304ba4ec31c3416",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "theuni:chacha20-vectorized-initial",
      "ref": "chacha20-vectorized-initial",
      "sha": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 10302141,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMDMwMjE0MQ==",
        "name": "bitcoin",
        "full_name": "theuni/bitcoin",
        "owner": {
          "login": "theuni",
          "id": 417043,
          "node_id": "MDQ6VXNlcjQxNzA0Mw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/theuni",
          "html_url": "https://github.com/theuni",
          "followers_url": "https://api.github.com/users/theuni/followers",
          "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
          "organizations_url": "https://api.github.com/users/theuni/orgs",
          "repos_url": "https://api.github.com/users/theuni/repos",
          "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/theuni/received_events",
          "type": "User",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/theuni/bitcoin",
        "description": "Bitcoin integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/theuni/bitcoin",
        "archive_url": "https://api.github.com/repos/theuni/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/theuni/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/theuni/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/theuni/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/theuni/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/theuni/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/theuni/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/theuni/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/theuni/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/theuni/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/theuni/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/theuni/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/theuni/bitcoin/events",
        "forks_url": "https://api.github.com/repos/theuni/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/theuni/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/theuni/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/theuni/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/theuni/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/theuni/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/theuni/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/theuni/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/theuni/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/theuni/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/theuni/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/theuni/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/theuni/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/theuni/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/theuni/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/theuni/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:theuni/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/theuni/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/theuni/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/theuni/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/theuni/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/theuni/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/theuni/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/theuni/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/theuni/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/theuni/bitcoin/hooks",
        "svn_url": "https://github.com/theuni/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 6,
        "watchers_count": 6,
        "size": 285294,
        "default_branch": "trivial-next",
        "open_issues_count": 2,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2026-01-13T19:22:06Z",
        "created_at": "2013-05-26T18:55:06Z",
        "updated_at": "2025-11-07T20:56:54Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "13891a8a685d255cb13dd5018e3d5ccc18b07c34",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38598,
        "stargazers_count": 87641,
        "watchers_count": 87641,
        "size": 301650,
        "default_branch": "master",
        "open_issues_count": 759,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2026-01-13T13:02:02Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2026-01-13T15:39:27Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 434,
    "deletions": 5,
    "changed_files": 5,
    "commits": 4,
    "review_comments": 41,
    "comments": 12
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFjYmJkMTRlNmRlOWYzZDAxM2MzNzk2YmNjNjFmYzE5OWRjOGYwYWQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad",
      "tree": {
        "sha": "e000b9c1ae107d7814a3bb31f3726f5902a7dee4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e000b9c1ae107d7814a3bb31f3726f5902a7dee4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/938d7aacabd0bb3784bb3e529b1ed06bb2891864",
          "sha": "938d7aacabd0bb3784bb3e529b1ed06bb2891864",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/938d7aacabd0bb3784bb3e529b1ed06bb2891864"
        }
      ],
      "message": "chacha20: move single-block crypt to inline helper function",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2025-12-12T22:14:22Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2025-12-12T21:12:40Z"
      },
      "sha": "1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDNiZGRmNTljZDNmMjAxZWNmOGQ2NWJiMWY2YzBjZGU1YzM5NTk1ZTk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "tree": {
        "sha": "d0c0acbc78076ef0f9c8e030500f82171ed7ba43",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d0c0acbc78076ef0f9c8e030500f82171ed7ba43"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad",
          "sha": "1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1cbbd14e6de9f3d013c3796bcc61fc199dc8f0ad"
        }
      ],
      "message": "chacha20: Add generic vectorized chacha20 implementation\n\nExploit modern simd to calculate 2/4/6/8/16 states at a time depending on the\nsize of the input.\n\nDemonstrates a 2x speedup on x86-64 and 3x for arm+neon. Platforms which\nrequire runtime detection (avx2/avx512) improve performance even further, and\nwill come as a follow-up.\n\nRather than hand-writing assembly or using arch-specific intrinsics, this is\nwritten using compiler built-ins understood by gcc and clang.\n\nIn practice (at least on x86_64 and armv8), the compilers are able to produce\nassembly that's not much worse than hand-written.\n\nThis means that every architecture can benefit from its own vectorized\ninstructions without having to write/maintain an implementation for each one.\nBut because each will vary in ability to exploit the parallelism, we allow\n(via ifdefs) each architecture to opt-out of some or all multi-state\ncalculation at compile-time..\n\nHere, as a starting point, x86-64 and arm+neon have been defined based on local\nbenchmarks.",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2025-12-16T20:25:52Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2025-12-12T21:37:52Z"
      },
      "sha": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9"
    },
    {
      "event": "commented",
      "id": 3662305410,
      "node_id": "IC_kwDOABII587aSliC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3662305410",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:42:44Z",
      "updated_at": "2026-01-13T19:22:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/34083.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (✨ experimental)\n\n\n\nPossible typos and grammar issues:\n\n- \"32bytes\" -> \"32 bytes\" [missing space between number and unit]\n- \"which used to increment the states\" -> \"which are used to increment the states\" [missing auxiliary verb \"are\"]\n- \"256bit registers\" -> \"256‑bit registers\" [missing hyphen for the compound adjective; can be written as \"256-bit\" or \"256 bit\" for clarity]\n\n\n\n<sup>2026-01-13</sup>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3662305410",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "commented",
      "id": 3662325588,
      "node_id": "IC_kwDOABII587aSqdU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3662325588",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:14Z",
      "updated_at": "2025-12-16T20:49:14Z",
      "author_association": "MEMBER",
      "body": "Adding pings for a few people I've discussed this with: @sipa @ajtowns @l0rinc ",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3662325588",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "mentioned",
      "id": 21601999154,
      "node_id": "MEE_lADOABII587essUFzwAAAAUHlFky",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999154",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:15Z"
    },
    {
      "event": "subscribed",
      "id": 21601999192,
      "node_id": "SE_lADOABII587essUFzwAAAAUHlFlY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999192",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:15Z"
    },
    {
      "event": "mentioned",
      "id": 21601999215,
      "node_id": "MEE_lADOABII587essUFzwAAAAUHlFlv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999215",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:16Z"
    },
    {
      "event": "subscribed",
      "id": 21601999259,
      "node_id": "SE_lADOABII587essUFzwAAAAUHlFmb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999259",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:16Z"
    },
    {
      "event": "mentioned",
      "id": 21601999326,
      "node_id": "MEE_lADOABII587essUFzwAAAAUHlFne",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999326",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:16Z"
    },
    {
      "event": "subscribed",
      "id": 21601999383,
      "node_id": "SE_lADOABII587essUFzwAAAAUHlFoX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21601999383",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-16T20:49:16Z"
    },
    {
      "event": "reviewed",
      "id": 3585574031,
      "node_id": "PRR_kwDOABII587Vt4SP",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-17T02:07:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "Some nits. Approach looks very nice, and at least going by the bench results, gives a good improvement.",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3585574031",
      "submitted_at": "2025-12-17T02:07:55Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "commented",
      "id": 3664158140,
      "node_id": "IC_kwDOABII587aZp28",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3664158140",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-17T08:11:01Z",
      "updated_at": "2025-12-17T09:47:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "Looking forward to reviewing it - quick question before I do: was it tested on any big-endian systems which don't revert to non-vectorized run?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3664158140",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "reviewed",
      "id": 3586630513,
      "node_id": "PRR_kwDOABII587Vx6Nx",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-17T08:48:01Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3586630513",
      "submitted_at": "2025-12-17T08:48:01Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "reviewed",
      "id": 3586669603,
      "node_id": "PRR_kwDOABII587VyDwj",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-17T08:58:20Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3586669603",
      "submitted_at": "2025-12-17T08:58:20Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "reviewed",
      "id": 3586783659,
      "node_id": "PRR_kwDOABII587Vyfmr",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-17T15:46:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "I went through the code roughly, I like that we're focusing on this and looking forward to specializing other parts of the code that are this critical (looking at you, SipHash!).\r\n\r\nMy biggest objection currently is that it's broken on big-endian systems - left a suggestion how to reproduce and fix it. This also reveals the lack of testing - we have to find a way to selectively enable and disable these optimizations to make sure we have tests that compare their outputs.\r\nI agree with AJ that we could modernize this a bit with `constexpr` and less general recursive template magic since C++20 allows us to use simple loops and `constexpr` conditions and lambdas - it could reduce a lot of duplication while maintaining performance.\r\nThere's also some repetition (e.g. `ALWAYS_INLINE` and `internal_bswap_32`), already defined elsewhere which I think we could use instead.\r\nWhich leads me to think we should extract the new primitives used here (`__builtin_shufflevector`, `vec_rotl`, `vec_byteswap`, `vec256`) to a reusable header - tested and benchmarked separately from the chacha work.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3586783659",
      "submitted_at": "2025-12-17T15:46:36Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "reviewed",
      "id": 3588436636,
      "node_id": "PRR_kwDOABII587V4zKc",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-17T15:59:54Z",
      "author_association": "MEMBER",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3588436636",
      "submitted_at": "2025-12-17T15:59:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "commented",
      "id": 3666489045,
      "node_id": "IC_kwDOABII587aii7V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3666489045",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-17T17:48:28Z",
      "updated_at": "2025-12-17T18:54:56Z",
      "author_association": "MEMBER",
      "body": "An additional note about the actual vectorizing algorithm itself...\r\n\r\nThere's a different (and arguably more obvious) algorithm that's possible when calculating exactly 8 states. Rather than loading each `vec256` with partial info from 2 states, it's possible to use 16 `vec256` where each vector contains 1 element for each of the 8 states. It looks like:\r\n\r\n```c++\r\nvec256 x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15;\r\n\r\nbroadcast(x0, 0x61707865);\r\nbroadcast(x1, 0x3320646e);\r\nbroadcast(x2, 0x79622d32);\r\nbroadcast(x3, 0x6b206574);\r\nbroadcast(x4, input[0]);\r\n...\r\nbroadcast(x15, input[11]);\r\n\r\nQUARTERROUND( x0, x4, x8,x12);\r\nQUARTERROUND( x1, x5, x9,x13);\r\n...\r\n\r\nvec256 j0, j1, j2, j3, ... j31;\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 0, j0, j1);\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 1, j2, j3);\r\n...\r\nextract_column(x0, x1, x2, x3, x4, x5, x6, x7, x8, x9, x10, x11, x12, x13, x14, x15, 15, j30, j31);\r\n\r\nvec_read_xor_write(in_bytes, out_bytes, j0);\r\nvec_read_xor_write(in_bytes, out_bytes, j1);\r\n...\r\n\r\n```\r\n\r\nThe problem with this is the overhead of the transpose at the end. My experiments showed (on x86_64+avx2, at least) that this was actually slower than what's currently implemented. It's possible that this approach is better for other architectures, but I left it out of this PR to reduce the initial complexity.\r\n\r\nEdit: This is what the linux kernel does for x86_64+avx2. I grabbed their .S and hacked it into Core to benchmark, only to find that the impl here actually outperformed their hand-written asm. That was neat :)",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3666489045",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "commented",
      "id": 3667333373,
      "node_id": "IC_kwDOABII587alxD9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3667333373",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-17T21:46:10Z",
      "updated_at": "2025-12-17T21:46:10Z",
      "author_association": "MEMBER",
      "body": "Ok, after some experimenting, I am very hesitant to add the helpers as suggested above. For example, consider @ajtowns's seemingly innocuous Repeat function:\r\n```c++\r\ntemplate <size_t REPS, typename Fn>\r\nALWAYS_INLINE void Repeat(Fn&& fn)\r\n{\r\n    if constexpr (REPS > 0) {\r\n        fn();\r\n        Repeat<REPS-1>(std::forward<Fn>(fn));\r\n    }\r\n}\r\n```\r\n\r\nThis causes a 10% slowdown on this branch, but with avx2 the performance is abysmal:\r\n\r\nBaseline(master):\r\n```\r\n|                1.38 |      723,275,584.44 | `CHACHA20_1MB`\r\n```\r\nThis PR:\r\n```\r\n|                0.71 |    1,408,751,284.34 | `CHACHA20_1MB`\r\n```\r\n[202512-pr34083-templates](https://github.com/ajtowns/bitcoin/commits/202512-pr34083-templates/)\r\n```\r\n|                0.79 |    1,258,748,451.87 | `CHACHA20_1MB`\r\n```\r\n\r\nThis PR + [avx2 commits](https://github.com/theuni/bitcoin/commits/chacha20-vectorized/):\r\n```\r\n|                0.50 |    1,988,653,922.83 |  `CHACHA20_1MB`\r\n```\r\n\r\n[202512-pr34083-templates](https://github.com/ajtowns/bitcoin/commits/202512-pr34083-templates/) + [avx2 commits](https://github.com/theuni/bitcoin/commits/chacha20-vectorized/):\r\n```\r\n|                1.34 |      748,148,324.75 | `CHACHA20_1MB`\r\n```\r\n\r\nThe problem in AJ's branch that some functions end up un-inlined. For clang, it's `doubleround`. For gcc it's `arr_read_xor_write` and `doubleround`.\r\n\r\nBoth are fixed with:\r\n```diff\r\ndiff --git a/src/crypto/chacha20_vec.ipp b/src/crypto/chacha20_vec.ipp\r\nindex 344c68259a5..16d7da45633 100644\r\n--- a/src/crypto/chacha20_vec.ipp\r\n+++ b/src/crypto/chacha20_vec.ipp\r\n@@ -164 +164 @@ public:\r\n-        Repeat<10>([&]() {\r\n+        Repeat<10>([&]() __attribute__ ((always_inline)) {\r\n```\r\n\r\nThat means, to be safe, every lambda would need that attribute, which is pretty ugly and easy to forget. So I think my aversion to lambdas in this code was somewhat justified.\r\n\r\nFurther, clang's [inlining docs](https://clang.llvm.org/docs/analyzer/developer-docs/IPA.html) state that variadic functions aren't inlined. Experimenting now, that's obviously not true as of v21-git. But clearly it was in the recent past.\r\n\r\nSo.. I'd _really_ prefer to keep things as simple here as possible. I know the recursive template functions aren't exactly pretty, but I don't think they're _THAT_ bad? Plus, with c++26, it all goes away in favor of `template for` :)",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3667333373",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "mentioned",
      "id": 21628291035,
      "node_id": "MEE_lADOABII587essUFzwAAAAUJJYfb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21628291035",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-17T21:46:11Z"
    },
    {
      "event": "subscribed",
      "id": 21628291065,
      "node_id": "SE_lADOABII587essUFzwAAAAUJJYf5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21628291065",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-17T21:46:11Z"
    },
    {
      "event": "commented",
      "id": 3667913915,
      "node_id": "IC_kwDOABII587an-y7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3667913915",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-18T01:38:13Z",
      "updated_at": "2025-12-18T01:38:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "> So.. I'd _really_ prefer to keep things as simple here as possible. I know the recursive template functions aren't exactly pretty, but I don't think they're _THAT_ bad? Plus, with c++26, it all goes away in favor of `template for` :)\r\n\r\nCould we get some comments in the code as to compiler versions (and architecture) that failed to be efficient enough with lambdas, to hopefully avoid future people modernizing the code without checking that these problems have gone away? Presumably will be a long time before we can modernize to `template for` (which doesn't even seem to be on [cppref's compiler support page](https://en.cppreference.com/w/cpp/compiler_support.html) yet?)...\r\n\r\n(Only thing that I do think is \"that bad\" about the recursive templates is using `ITER` and `I` -- `i` should be the loop variable, not the size!)",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3667913915",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "commented",
      "id": 3670950989,
      "node_id": "IC_kwDOABII587azkRN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3670950989",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-18T15:52:48Z",
      "updated_at": "2025-12-18T15:52:48Z",
      "author_association": "MEMBER",
      "body": "> Could we get some comments in the code as to compiler versions (and architecture) that failed to be efficient enough with lambdas, to hopefully avoid future people modernizing the code without checking that these problems have gone away? Presumably will be a long time before we can modernize to `template for` (which doesn't even seem to be on [cppref's compiler support page](https://en.cppreference.com/w/cpp/compiler_support.html) yet?)...\r\n> \r\n> (Only thing that I do think is \"that bad\" about the recursive templates is using `ITER` and `I` -- `i` should be the loop variable, not the size!)\r\n\r\nSure, I can definitely add some more context and clean up the wonky variable names.\r\n\r\nAnother brain dump after thinking about all this some more last night:\r\n\r\n1. I don't think lambdas specifically are the problem, more specifically, the issue is: can the compiler infer enough about the \"callback\" function to inline it?\r\n\r\nThere are a few considerations there. @sipa's `make_index_sequence` suggestion is executed immediately, so I imagine that's more likely to be inlined than AJ's `Repeat`. But still, from a compiler's POV, if it's evaluating: \"here's a function call without `ALWAYS_INLINE` and my function is already huge, should I exclude it from inlining?\", imo it'd be reasonable for it to conclude \"yes\".\r\n\r\nSo to be safe, whatever we do, I think we should strive to annotate all functions. And imo, annotating a bunch of lambdas with an inline attribute feels weird.\r\n\r\n(as an aside: There's also the `flatten` attribute, which could be added to `multi_block_crypt` as a belt-and-suspenders)\r\n\r\nThe `index_sequence` trick is neat. If that ends up looking cleaner/more obvious than the recursive iteration, that works for me. I'll play around with it.\r\n\r\n2. Not all loops have to be unrolled.\r\n\r\nIn my testing, loop unrolling always showed slightly better performance (presumably because calculating multiple blocks is otherwise branch-free), but it's not nearly as performance-critical as the inlining. For example, skipping unrolling of `doubleround` leads to _much_ smaller code, which I imagine could end up being faster on some architectures.\r\n\r\n> Is there any way we could help that would make you reconsider? I don't mind running the benchmarks on a few platforms, as long as we can have simpler code. The current template magic is not something I would like to see more of - modern C++20 should be able to handle the situations we have here.\r\n\r\nMy primary goal with this code (and hopefully setting a precedent for other multi-arch simd code... poly1305 is next ;) is to be as explicit to the compiler about what we want as possible. Ideally as portably as possible. So if we want our functions inlined or loops unrolled, we should attempt to communicate those things opposed to leaving them implicit. Unfortunately, modern c++ doesn't have ways to express either of those yet, but we can make our intentions clear enough.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3670950989",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "mentioned",
      "id": 21647236582,
      "node_id": "MEE_lADOABII587essUFzwAAAAUKRp3m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21647236582",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-18T15:52:50Z"
    },
    {
      "event": "subscribed",
      "id": 21647236679,
      "node_id": "SE_lADOABII587essUFzwAAAAUKRp5H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21647236679",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-18T15:52:50Z"
    },
    {
      "event": "commented",
      "id": 3674308009,
      "node_id": "IC_kwDOABII587bAX2p",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3674308009",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-19T09:38:43Z",
      "updated_at": "2025-12-19T09:38:43Z",
      "author_association": "CONTRIBUTOR",
      "body": "> And imo, annotating a bunch of lambdas with an inline attribute feels weird.\r\n\r\nYou could `#define AI __attribute__((always_inline))`, then you'd just be adding `AI` to all the lambdas, which, if nothing else, would be very modern?\r\n\r\n> My primary goal with this code (and hopefully setting a precedent for other multi-arch simd code... poly1305 is next ;) is to be as explicit to the compiler about what we want as possible. Ideally as portably as possible. \r\n\r\nThe above was kind-of a joke, but, perhaps you could combine it with a clang-tidy plugin that lets CI check that all lambdas in a particular namespace are annotated in that way? That might be both clear to compilers and reasonably friendly to human authors/reviewers?\r\n\r\n(Explicit recursive templates and prohibiting lambdas are fine by me though; that's still a big step up from inline asm)",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3674308009",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "commented",
      "id": 3680977671,
      "node_id": "IC_kwDOABII587bZ0MH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3680977671",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-22T08:18:17Z",
      "updated_at": "2025-12-22T08:18:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have measured its effect on IBD and happy to say it produces a measurable speedup.\r\n\r\n<img width=\"1474\" height=\"846\" alt=\"image\" src=\"https://github.com/user-attachments/assets/a660986e-c752-4670-8dcf-595f6742520d\" />\r\n\r\n<details>\r\n<summary>IBD | 926619 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"938d7aacabd0bb3784bb3e529b1ed06bb2891864 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9\"; \\\r\nSTOP=926619; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n```\r\n\r\n> 938d7aacab Merge bitcoin/bitcoin#33657: rest: allow reading partial block data from storage\r\n> 3bddf59cd3 chacha20: Add generic vectorized chacha20 implementation\r\n\r\n```\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 938d7aacabd0bb3784bb3e529b1ed06bb2891864)\r\n  Time (mean ± σ):     45198.232 s ± 539.231 s    [User: 57185.689 s, System: 4367.881 s]\r\n  Range (min … max):   44816.939 s … 45579.526 s    2 runs\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9)\r\n  Time (mean ± σ):     43699.641 s ± 25.532 s    [User: 57610.736 s, System: 4058.824 s]\r\n  Range (min … max):   43681.587 s … 43717.695 s    2 runs\r\n \r\nRelative speed comparison\r\n        1.03 ±  0.01  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 938d7aacabd0bb3784bb3e529b1ed06bb2891864)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=926619 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9)\r\n```\r\n\r\n</details>\r\n\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3680977671",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "commented",
      "id": 3688981402,
      "node_id": "IC_kwDOABII587b4WOa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3688981402",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-24T07:50:01Z",
      "updated_at": "2025-12-24T07:50:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I have measured its effect on IBD and happy to say it produces a measurable speedup.\r\n\r\nPresumably that indicates this IBD run is compute bound (vs disk or network), and that ChaCha20 is using up maybe 7% of CPU time (or 7% of a core when we're bottlenecked on something single-threaded) prior to this PR. That seems like a lot? Is this due to FastRandomContext, or something else? Or is it just that obfuscating all the block data is a large component of IBD CPU currently? This seems a bit surprising to me.",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3688981402",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "reviewed",
      "id": 3611660652,
      "node_id": "PRR_kwDOABII587XRZFs",
      "url": null,
      "actor": null,
      "commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-28T13:52:00Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#pullrequestreview-3611660652",
      "submitted_at": "2025-12-28T13:52:00Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
    },
    {
      "event": "commented",
      "id": 3716395582,
      "node_id": "IC_kwDOABII587dg7I-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3716395582",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-06T21:18:08Z",
      "updated_at": "2026-01-06T21:18:08Z",
      "author_association": "MEMBER",
      "body": "> Presumably that indicates this IBD run is compute bound (vs disk or network), and that ChaCha20 is using up maybe 7% of CPU time (or 7% of a core when we're bottlenecked on something single-threaded) prior to this PR. That seems like a lot? Is this due to FastRandomContext, or something else? Or is it just that obfuscating all the block data is a large component of IBD CPU currently? This seems a bit surprising to me.\r\n\r\nNot sure if you missed this in the description, but that's exactly what this is trying to improve:\r\n> Local profiling revealed that chacha20 accounts for a substantial amount of the network thread's time. It's not clear to me if speeding up chacha20 will improve network performance/latency, but it will definitely make it more efficient.\r\n\r\nIBD would indeed be slowed by Chacha20 via single-threaded bip324 handling on the network thread. [While profiling my POC multi-process net binary](https://github.com/bitcoin-core/libmultiprocess/issues/215) I observed `ChaCha20Aligned::Crypt()` accounting for 30% of the net thread's cpu time.\r\n\r\nSo it's not surprising to me at all that 3x'ing that function (it's only 2x here, avx2/avx512 improve performance even more) speeds up IBD.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3716395582",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDMzYjQ4YTI5MjdkNmI2YTEwZDY1YmRkM2MyZjU5YmI5YjRlMTQyMjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225",
      "tree": {
        "sha": "d5a303603f47fa4740875e8eda1d03444570b75f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d5a303603f47fa4740875e8eda1d03444570b75f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
          "sha": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9"
        }
      ],
      "message": "squashme: fix vectorized chacha20 on big endian\n\nCo-authored-by: Lőrinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2026-01-13T19:05:08Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2026-01-13T19:04:05Z"
      },
      "sha": "33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGNkZmNhODRlMjM1ZWFkNDMwNmFhZGJmMjdkZjU2MTk2NGJjZDZjMmU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "tree": {
        "sha": "979a5b489f5eda2b690695973481930e91a705d3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/979a5b489f5eda2b690695973481930e91a705d3"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225",
          "sha": "33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/33b48a2927d6b6a10d65bdd3c2f59bb9b4e14225"
        }
      ],
      "message": "squashme: fix main performance discrepancy between clang and gcc\n\n__builtin_shufflevector emits non-optimal code for this case, so avoid using it\nhere. See: https://gcc.gnu.org/bugzilla/show_bug.cgi?id=107563#c14",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2026-01-13T19:20:08Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2026-01-13T16:23:41Z"
      },
      "sha": "cdfca84e235ead4306aadbf27df561964bcd6c2e"
    },
    {
      "event": "commented",
      "id": 3746127336,
      "node_id": "IC_kwDOABII587fSV3o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3746127336",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-13T19:34:47Z",
      "updated_at": "2026-01-13T19:34:47Z",
      "author_association": "MEMBER",
      "body": "I finally managed to track down the gcc slowdown that @l0rinc mentioned during last week's IRC meeting. The culprit was [this gcc bug](https://gcc.gnu.org/bugzilla/show_bug.cgi?id=107563#c14). Thankfully, it's easily worked around by simply not calling the guilty builtin.\r\n\r\nAlso pushed @l0rinc's fix for big-endian.\r\n\r\nNow that gcc/clang are more on par and the impl seems feasible again, I'll address the other feedback.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#issuecomment-3746127336",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/34083"
    },
    {
      "event": "mentioned",
      "id": 22025767616,
      "node_id": "MEE_lADOABII587essUFzwAAAAUg1orA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22025767616",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-13T19:34:48Z"
    },
    {
      "event": "subscribed",
      "id": 22025767641,
      "node_id": "SE_lADOABII587essUFzwAAAAUg1orZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22025767641",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-13T19:34:48Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625248846",
      "pull_request_review_id": 3585574031,
      "id": 2625248846,
      "node_id": "PRRC_kwDOABII586ceh5O",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#endif\n+\n+#include <crypto/chacha20_vec.ipp>",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 26,
      "original_position": 26,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why separate this into an .ipp file if it's only included in a single .cpp file?",
      "created_at": "2025-12-17T01:11:28Z",
      "updated_at": "2025-12-17T02:07:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2625248846",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625248846"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 26,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625293528",
      "pull_request_review_id": 3585574031,
      "id": 2625293528,
      "node_id": "PRRC_kwDOABII586ceszY",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 12,
      "original_position": 12,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Using `#if !defined` for these seems old school. Why not static constexpr bools, and `if constexpr (..)`?\r\n\r\nWriting:\r\n\r\n```c++\r\n#if defined(__x86_64__) || defined(__amd64__)\r\n#  define CHACHA20_VEC_DISABLE_STATES_16 true\r\n#  define CHACHA20_VEC_DISABLE_STATES_8  true\r\n#  define CHACHA20_VEC_DISABLE_STATES_6  true\r\n#  define CHACHA20_VEC_DISABLE_STATES_4  false\r\n#  define CHACHA20_VEC_DISABLE_STATES_2  false\r\n#elif defined(__ARM_NEON)\r\n...\r\n\r\nstatic constexpr bool CHACHA20_VEC_ALL_MULTI_STATES_DISABLED =\r\n    CHACHA20_VEC_DISABLE_STATES_16 &&\r\n    CHACHA20_VEC_DISABLE_STATES_8 &&\r\n    CHACHA20_VEC_DISABLE_STATES_6 &&\r\n    CHACHA20_VEC_DISABLE_STATES_4 &&\r\n    CHACHA20_VEC_DISABLE_STATES_2;\r\n\r\n void chacha20_crypt_vectorized(std::span<const std::byte>& in_bytes, std::span<std::byte>& out_bytes, const std::array<uint32_t, 12>& input) noexcept\r\n {\r\n    if constexpr (CHACHA20_VEC_ALL_MULTI_STATES_DISABLED) return;\r\n...\r\n    if constexpr (!CHACHA20_VEC_DISABLE_STATES_16) {\r\n         while(in_bytes.size() >= CHACHA20_VEC_BLOCKLEN * 16) {\r\n...\r\n```\r\n\r\nseems to work right, and also seems like it avoids needing to put all the potentially unused code in a #if block.",
      "created_at": "2025-12-17T01:39:15Z",
      "updated_at": "2025-12-17T02:07:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2625293528",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625293528"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 12,
      "original_line": 12,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625334750",
      "pull_request_review_id": 3585574031,
      "id": 2625334750,
      "node_id": "PRRC_kwDOABII586ce23e",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 38,
      "original_position": 38,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`static_assert(sizeof(vec256) == 32)` ? (Or `sizeof(vec256) == 32 || ALL_MULTI_STATES_DISABLED`)",
      "created_at": "2025-12-17T02:03:33Z",
      "updated_at": "2025-12-17T02:08:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2625334750",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625334750"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 38,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625335880",
      "pull_request_review_id": 3585574031,
      "id": 2625335880,
      "node_id": "PRRC_kwDOABII586ce3JI",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 101,
      "original_position": 101,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`if constexpr (ITER + 1 < I)`   (we have a space after `if constexpr` elsewhere)",
      "created_at": "2025-12-17T02:04:20Z",
      "updated_at": "2025-12-17T02:07:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2625335880",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625335880"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 101,
      "original_line": 101,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625986598",
      "pull_request_review_id": 3586460575,
      "id": 2625986598,
      "node_id": "PRRC_kwDOABII586chWAm",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 12,
      "original_position": 12,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625293528,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Here's a branch that replaces the #defines and abstracts the recursive template stuff a bit more for your perusal https://github.com/ajtowns/bitcoin/commits/202512-pr34083-templates/ ",
      "created_at": "2025-12-17T07:58:39Z",
      "updated_at": "2025-12-17T07:58:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2625986598",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2625986598"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 12,
      "original_line": 12,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626127018",
      "pull_request_review_id": 3586630513,
      "id": 2626127018,
      "node_id": "PRRC_kwDOABII586ch4Sq",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}\n+\n+/*\n+The first round:\n+            QUARTERROUND( x0, x4, x8,x12);\n+            QUARTERROUND( x1, x5, x9,x13);\n+            QUARTERROUND( x2, x6,x10,x14);\n+            QUARTERROUND( x3, x7,x11,x15);\n+\n+The second round:\n+            QUARTERROUND( x0, x5,x10,x15);\n+            QUARTERROUND( x1, x6,x11,x12);\n+            QUARTERROUND( x2, x7, x8,x13);\n+            QUARTERROUND( x3, x4, x9,x14);\n+\n+After the first round, arr_shuf0, arr_shuf1, and arr_shuf2 are used to shuffle\n+the layout to prepare for the second round.\n+\n+After the second round, they are used (in reverse) to restore the original\n+layout.",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 121,
      "original_position": 121,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "My understanding is that you're inverting the logic here: instead of\r\n\r\n```c++\r\n#define QUARTERROUND(a,b,c,d) \\\r\n    X(a,b,d,16) X(c,d,b,12) X(a,d,b,8) X(c,d,b,7)\r\n```\r\n\r\nThis does the `X(a,b,d,16)` all four times via simd, then `X(c,d,b,12)` all four times, etc. And the simd part relies on the data for those four steps being exactly +4 units apart, which is why the shuffling and unshuffling is necessary for the second round. (Okay, not four times but eight times because each vec256 is two blocks)\r\n\r\nCould use a little more explanation in the comment I think? But makes sense to me.",
      "created_at": "2025-12-17T08:48:01Z",
      "updated_at": "2025-12-17T08:48:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2626127018",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626127018"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 121,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626160716",
      "pull_request_review_id": 3586669603,
      "id": 2626160716,
      "node_id": "PRRC_kwDOABII586ciAhM",
      "diff_hunk": "@@ -273,8 +278,29 @@ inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::spa\n             return;\n         }\n         blocks -= 1;\n-        c += BLOCKLEN;\n-        m += BLOCKLEN;\n+        c += ChaCha20Aligned::BLOCKLEN;\n+        m += ChaCha20Aligned::BLOCKLEN;\n+    }\n+}\n+\n+\n+inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes) noexcept\n+{\n+    assert(in_bytes.size() == out_bytes.size());\n+    size_t blocks = out_bytes.size() / ChaCha20Aligned::BLOCKLEN;\n+    assert(blocks * ChaCha20Aligned::BLOCKLEN == out_bytes.size());\n+#ifdef ENABLE_CHACHA20_VEC\n+    // Only use the vectorized implementations if the counter will not overflow.\n+    const bool overflow = static_cast<uint64_t>(input[8]) + blocks > std::numeric_limits<uint32_t>::max();",
      "path": "src/crypto/chacha20.cpp",
      "position": 53,
      "original_position": 53,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Overflow happens every 274GB I guess, which presumably isn't worth putting much effort in to optimising around.\r\n\r\n        ",
      "created_at": "2025-12-17T08:58:20Z",
      "updated_at": "2025-12-17T08:58:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2626160716",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626160716"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 294,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626253726",
      "pull_request_review_id": 3586783659,
      "id": 2626253726,
      "node_id": "PRRC_kwDOABII586ciXOe",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 46,
      "original_position": 46,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we assume that all big endian systems have `__builtin_bswap32` available?\r\nhttps://github.com/bitcoin/bitcoin/blob/432b18ca8d0654318a8d882b28b20af2cb2d2e5d/src/compat/byteswap.h#L14-L16 indicates we could use our existing helpers here instead:\r\n```C++\r\nALWAYS_INLINE void vec_byteswap(vec256& vec)\r\n{\r\n    if constexpr (std::endian::native == std::endian::big) {\r\n        for (size_t i = 0; i < 8; ++i) {\r\n            vec[i] = internal_bswap_32(vec[i]);\r\n        }\r\n    }\r\n}\r\n```\r\nA small, fixed-size loop like this should be unrolled by every compiler, it's what we did in https://github.com/bitcoin/bitcoin/pull/31144/files#diff-f26d4597a7f5a5d4aa30053032d49427b402ef4fd7a1b3194cb75b2551d58ca4R48 as well.\r\n\r\n(nit: could you please reformat the patch, it differs slightly from how clang-format is set for new code)",
      "created_at": "2025-12-17T09:24:53Z",
      "updated_at": "2025-12-17T16:17:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2626253726",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626253726"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 46,
      "original_line": 46,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626256140",
      "pull_request_review_id": 3586783659,
      "id": 2626256140,
      "node_id": "PRRC_kwDOABII586ciX0M",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 67,
      "original_position": 67,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It seems to me the existing standard test vectors are too short (mostly < 128 bytes) to trigger the vectorized optimization - can we extend the tests to runa and compare the new specializations (could show as `skipped` when the given architecture isn't available locally)?\r\n",
      "created_at": "2025-12-17T09:25:36Z",
      "updated_at": "2025-12-17T15:46:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2626256140",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2626256140"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 67,
      "original_line": 67,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627310095",
      "pull_request_review_id": 3586783659,
      "id": 2627310095,
      "node_id": "PRRC_kwDOABII586cmZIP",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Forcing vectorized operations on an emulated big-endian system (otherwise it falls back to the scalar implementation due to the safety checks):\r\n\r\n```patch\r\ndiff --git a/src/crypto/chacha20_vec_base.cpp b/src/crypto/chacha20_vec_base.cpp\r\nindex 9fda9452a1..a2aa1e5552 100644\r\n--- a/src/crypto/chacha20_vec_base.cpp\r\n+++ b/src/crypto/chacha20_vec_base.cpp\r\n@@ -20,7 +20,7 @@\r\n #  define CHACHA20_VEC_DISABLE_STATES_8\r\n #  define CHACHA20_VEC_DISABLE_STATES_6\r\n #  define CHACHA20_VEC_DISABLE_STATES_4\r\n-#  define CHACHA20_VEC_DISABLE_STATES_2\r\n+//#  define CHACHA20_VEC_DISABLE_STATES_2\r\n #endif\r\n\r\n #include <crypto/chacha20_vec.ipp>\r\n```\r\n\r\nand running the `crypto_tests`:\r\n\r\n```bash\r\nbrew install podman pigz qemu\r\npodman machine init\r\npodman machine start\r\n\r\npodman run --platform linux/s390x -it --rm ubuntu:latest /bin/bash -c \\\r\n  'apt-get update && \\\r\n   DEBIAN_FRONTEND=noninteractive apt-get install -y \\\r\n   git build-essential cmake ccache pkg-config \\\r\n   libevent-dev libboost-dev libssl-dev libsqlite3-dev python3 && \\\r\n   git clone https://github.com/bitcoin/bitcoin.git && cd bitcoin && \\\r\n   git fetch origin pull/34083/head:chacha20-vec && git checkout chacha20-vec && \\\r\n   sed -i \"s/#  define CHACHA20_VEC_DISABLE_STATES_2/\\/\\/#  define CHACHA20_VEC_DISABLE_STATES_2/\" src/crypto/chacha20_vec_base.cpp && \\\r\n   cmake -B build -DBUILD_BENCH=OFF -DBUILD_GUI=OFF -DBUILD_DAEMON=OFF -DBUILD_TX=OFF -DENABLE_IPC=OFF -DENABLE_WALLET=OFF -DENABLE_ZMQ=OFF -DENABLE_UPNP=OFF -DENABLE_NATPMP=OFF && \\\r\n   cmake --build build --target test_bitcoin -j1 && \\ ./build/bin/test_bitcoin --run_test=crypto_tests'\r\n```\r\n\r\nWe're getting a lot of failures:\r\n```bash\r\nRunning 17 test cases...\r\n./test/crypto_tests.cpp(155): error: in \"crypto_tests/chacha20_testvector\": check hexout == HexStr(outres) has failed [a3fbf07df3fa2fde4f376ca23e82737041605d9f4f4f57bd8cff2c1d4b7955ec2a97948bd3722915c8f3d337f7d370050e9e96d647b7c39f56e031ca5eb6250d4042e02785ececfa4b4bb5e8ead0440e20b6e8db09d881a7c6132f420e52795042bdfa7773d8a9051447b3291ce1411c680465552aa6c405b7764d5e87bea85ad00f8449ed8f72d0d662ab052691ca66424bc86d2df80ea41f43abf937d3259dc4b2d0dfb48a6c9139ddd7f76966e928e635553ba76c5c879d7b35d49eb2e62b0871cdac638939e25e8a1e0ef9d5280fa8ca328b351c3c765989cbcf3daa8b6ccc3aaf9f3979c92b3720fc88dc95ed84a1be059c6499b9fda236e7e818b04b0bc39c1e876b193bfe5569753f88128cc08aaa9b63d1a16f80ef2554d7189c411f5869ca52c5b83fa36ff216b9c1d30062bebcfd2dc5bce0911934fda79a86f6e698ced759c3ff9b6477338f3da4f9cd8514ea9982ccafb341b2384dd902f3d1ab7ac61dd29c6f21ba5b862f3730e37cfdc4fd806c22f221 != c2ece71ceded38c04f376ca225cc3d6b463409986f263e9db1994a204b6844ec6e9695cfc52b7003e3b6961ceac96a18138981cb4ee5919649b263d542b82b114a57f52d8ba2a2f4540af4f7f49f0b1072a7f9891b97ceb5c61c20420143685f169add2373c4b505122eda2f5df3535d555637680dc5a722b83209519ae7f147c11a9158f48479c9926ea7412ac69d6a584ac97768e412e1514fa7b737ce389dc4bbd9df9cc422b95ccfc5926171fe20e9284834a77646878d7a34c485b3e7300c3589a8448b3bc53b980c6bced42938afc1398c2f1a3a6c2887c5be68a18039cb2fba983271c1202a73af95c79ae29faafb40973694b4afa523f2ef13b84300c39c1e876b193bfe5569753f88128cc08aaa9b63d1a16f80ef2554d7189c411f5869ca52c5b83fa36ff216b9c1d30062bebcfd2dc5bce0911934fda79a86f6e698ced759c3ff9b6477338f3da4f9cd8514ea9982ccafb341b2384dd902f3d1ab7ac61dd29c6f21ba5b862f3730e37cfdc4fd806c22f221]\r\n...\r\n./test/crypto_tests.cpp(185): error: in \"crypto_tests/chacha20_testvector\": check hexout == HexStr(outres) has failed [a3fbf07df3fa2fde4f376ca23e82737041605d9f4f4f57bd8cff2c1d4b7955ec2a97948bd3722915c8f3d337f7d370050e9e96d647b7c39f56e031ca5eb6250d4042e02785ececfa4b4bb5e8ead0440e20b6e8db09d881a7c6132f420e52795042bdfa7773d8a9051447b3291ce1411c680465552aa6c405b7764d5e87bea85ad00f8449ed8f72d0d662ab052691ca66424bc86d2df80ea41f43abf937d3259dc4b2d0dfb48a6c9139ddd7f76966e928e635553ba76c5c879d7b35d49eb2e62b0871cdac638939e25e8a1e0ef9d5280fa8ca328b351c3c765989cbcf3daa8b6ccc3aaf9f3979c92b3720fc88dc95ed84a1be059c6499b9fda236e7e818b04b0bc39c1e876b193bfe5569753f88128cc08aaa9b63d1a16f80ef2554d7189c411f5869ca52c5b83fa36ff216b9c1d30062bebcfd2dc5bce0911934fda79a86f6e698ced759c3ff9b6477338f3da4f9cd8514ea9982ccafb341b2384dd902f3d1ab7ac61dd29c6f21ba5b862f3730e37cfdc4fd806c22f221 != a3fbf07df3fa2fde4f376ca23e82737041605d9f4f4f57bd8cff2c1d4b7955ec2a97948bd3722915c8f3d337f7d370050e9e96d647b7c39f56e031ca5eb6250d4a57f52d8ba2a2f4540af4f7f49f0b1072a7f9891b97ceb5c61c20420143685f169add2373c4b505122eda2f5df3535d555637680dc5a722b83209519ae7f147c11a9158f48479c9926ea7412ac69d6a584ac97768e412e1514fa7b737ce389dc4bbd9df9cc422b95ccfc5926171fe20e9284834a77646878d7a34c485b3e7300871cdac638939e25e8a1e0ef9d5280fa8ca328b351c3c765989cbcf3daa8b6ccc3aaf9f3979c92b3720fc88dc95ed84a1be059c6499b9fda236e7e818b04b0bc39c1e876b193bfe5569753f88128cc08aaa9b63d1a16f80ef2554d7189c411f5869ca52c5b83fa36ff216b9c1d30062bebcfd2dc5bce0911934fda79a86f6e698ced759c3ff9b6477338f3da4f9cd8514ea9982ccafb341b2384dd902f3d1ab7ac61dd29c6f21ba5b862f3730e37cfdc4fd806c22f221]\r\n./test/crypto_tests.cpp(272): error: in \"crypto_tests/chacha20poly1305_testvectors\": check cipher == expected_cipher has failed\r\n...\r\n./test/crypto_tests.cpp(337): error: in \"crypto_tests/chacha20poly1305_testvectors\": check decipher == plain has failed\r\n\r\n*** 37 failures are detected in the test module \"Bitcoin Core Test Suite\"\r\n```\r\n\r\nThis appears to be an endianness issue in `vec_read_xor_write`: the current implementation swaps the result of the XOR, but on Big Endian systems we must swap the state `vec` *before* the XOR.\r\n\r\nChanging it to:\r\n\r\n```patch\r\ndiff --git a/src/crypto/chacha20_vec.ipp b/src/crypto/chacha20_vec.ipp\r\nindex 46a159ce01..cfc0535a92 100644\r\n--- a/src/crypto/chacha20_vec.ipp\r\n+++ b/src/crypto/chacha20_vec.ipp\r\n@@ -174,8 +174,9 @@ ALWAYS_INLINE void vec_read_xor_write(std::span<const std::byte, 32> in_bytes, s\r\n {\r\n     std::array<uint32_t, 8> temparr;\r\n     memcpy(temparr.data(), in_bytes.data(), in_bytes.size());\r\n-    vec256 tempvec = vec ^ (vec256){temparr[0], temparr[1], temparr[2], temparr[3], temparr[4], temparr[5], temparr[6], temparr[7]};\r\n+    vec256 tempvec = vec;\r\n     vec_byteswap(tempvec);\r\n+    tempvec ^= (vec256){temparr[0], temparr[1], temparr[2], temparr[3], temparr[4], temparr[5], temparr[6], temparr[7]};\r\n     temparr = {tempvec[0], tempvec[1], tempvec[2], tempvec[3], tempvec[4], tempvec[5], tempvec[6], tempvec[7]};\r\n     memcpy(out_bytes.data(), temparr.data(), out_bytes.size());\r\n }\r\n ```\r\n\r\nMakes it pass for me.\r\n\r\nWe should find a way to exercise this via CI and benchmarks, maybe similarly to `SHA256AutoDetect` in https://github.com/bitcoin/bitcoin/blob/bdb8eadcdc193f398ebad83911d3297b5257e721/src/crypto/sha256.cpp#L585-L690 which would enable us running benchmarks and tests selectively.",
      "created_at": "2025-12-17T14:33:11Z",
      "updated_at": "2025-12-17T17:14:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627310095",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627310095"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627477691",
      "pull_request_review_id": 3586783659,
      "id": 2627477691,
      "node_id": "PRRC_kwDOABII586cnCC7",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmmm, it seems to me we're doing heavy recursive templates here to unroll loops.\r\nMy understanding (and experience with the mentioned Obfuscation PR) is that modern compilers are good at unrolling fixed-bound loops.\r\nCan you please try if this also works and results in the same speedup?\r\n\r\n```suggestion\r\ntemplate <size_t BITS, size_t I>\r\nALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\r\n{\r\n    for (size_t i{0}; i < I; ++i) {\r\n        arr0[i] += arr1[i];\r\n        arr2[i] ^= arr0[i];\r\n        vec_rotl<BITS>(arr2[i]);\r\n    }\r\n}\r\n```\r\n(nit: the size is often `N` instead of `I`)",
      "created_at": "2025-12-17T15:17:29Z",
      "updated_at": "2025-12-17T16:09:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627477691",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627477691"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627488702",
      "pull_request_review_id": 3586783659,
      "id": 2627488702,
      "node_id": "PRRC_kwDOABII586cnEu-",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 33,
      "original_position": 33,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Could we use https://github.com/bitcoin/bitcoin/blob/e16c22fe025f82166c7f3f15a37c96bf4a06e4cf/src/attributes.h#L19-L25 instead?",
      "created_at": "2025-12-17T15:20:22Z",
      "updated_at": "2025-12-17T15:46:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627488702",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627488702"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 25,
      "original_start_line": 25,
      "start_side": "RIGHT",
      "line": 33,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627508017",
      "pull_request_review_id": 3586783659,
      "id": 2627508017,
      "node_id": "PRRC_kwDOABII586cnJcx",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}\n+\n+/*\n+The first round:\n+            QUARTERROUND( x0, x4, x8,x12);\n+            QUARTERROUND( x1, x5, x9,x13);\n+            QUARTERROUND( x2, x6,x10,x14);\n+            QUARTERROUND( x3, x7,x11,x15);\n+\n+The second round:\n+            QUARTERROUND( x0, x5,x10,x15);\n+            QUARTERROUND( x1, x6,x11,x12);\n+            QUARTERROUND( x2, x7, x8,x13);\n+            QUARTERROUND( x3, x4, x9,x14);\n+\n+After the first round, arr_shuf0, arr_shuf1, and arr_shuf2 are used to shuffle\n+the layout to prepare for the second round.\n+\n+After the second round, they are used (in reverse) to restore the original\n+layout.\n+\n+*/\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf0(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 1, 2, 3, 0, 5, 6, 7, 4);\n+    if constexpr(ITER + 1 < I ) arr_shuf0<I, ITER + 1>(arr);\n+}\n+\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf1(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 2, 3, 0, 1, 6, 7, 4, 5);\n+    if constexpr(ITER + 1 < I ) arr_shuf1<I, ITER + 1>(arr);\n+}\n+\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf2(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 3, 0, 1, 2, 7, 4, 5, 6);\n+    if constexpr(ITER + 1 < I ) arr_shuf2<I, ITER + 1>(arr);\n+}\n+\n+/* Main round function. */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void doubleround(std::array<vec256, I>& arr0, std::array<vec256, I>& arr1, std::array<vec256, I>&arr2, std::array<vec256, I>&arr3)\n+{\n+    arr_add_xor_rot<16>(arr0, arr1, arr3);\n+    arr_add_xor_rot<12>(arr2, arr3, arr1);\n+    arr_add_xor_rot<8>(arr0, arr1, arr3);\n+    arr_add_xor_rot<7>(arr2, arr3, arr1);\n+    arr_shuf0(arr1);\n+    arr_shuf1(arr2);\n+    arr_shuf2(arr3);\n+    arr_add_xor_rot<16>(arr0, arr1, arr3);\n+    arr_add_xor_rot<12>(arr2, arr3, arr1);\n+    arr_add_xor_rot<8>(arr0, arr1, arr3);\n+    arr_add_xor_rot<7>(arr2, arr3, arr1);\n+    arr_shuf2(arr1);\n+    arr_shuf1(arr2);\n+    arr_shuf0(arr3);\n+    if constexpr (ITER + 1 < 10) doubleround<I, ITER + 1>(arr0, arr1, arr2, arr3);\n+}\n+\n+/* Read 32bytes of input, xor with calculated state, write to output. Assumes\n+   that input and output are unaligned, and makes no assumptions about the\n+   internal layout of vec256;\n+*/\n+ALWAYS_INLINE void vec_read_xor_write(std::span<const std::byte, 32> in_bytes, std::span<std::byte, 32> out_bytes, const vec256& vec)\n+{\n+    std::array<uint32_t, 8> temparr;\n+    memcpy(temparr.data(), in_bytes.data(), in_bytes.size());\n+    vec256 tempvec = vec ^ (vec256){temparr[0], temparr[1], temparr[2], temparr[3], temparr[4], temparr[5], temparr[6], temparr[7]};\n+    vec_byteswap(tempvec);\n+    temparr = {tempvec[0], tempvec[1], tempvec[2], tempvec[3], tempvec[4], tempvec[5], tempvec[6], tempvec[7]};\n+    memcpy(out_bytes.data(), temparr.data(), out_bytes.size());\n+}\n+\n+/* Merge the 128 bit lanes from 2 states to the proper order, then pass each vec_read_xor_write */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_read_xor_write(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes, const std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, const std::array<vec256, I>& arr2, const std::array<vec256, I>& arr3)\n+{\n+    const vec256& w = std::get<ITER>(arr0);\n+    const vec256& x = std::get<ITER>(arr1);\n+    const vec256& y = std::get<ITER>(arr2);\n+    const vec256& z = std::get<ITER>(arr3);\n+\n+    vec_read_xor_write(in_bytes.first<32>(), out_bytes.first<32>(), __builtin_shufflevector(w, x, 4, 5, 6, 7, 12, 13, 14, 15));\n+    vec_read_xor_write(in_bytes.subspan<32, 32>(), out_bytes.subspan<32, 32>(), __builtin_shufflevector(y, z, 4, 5, 6, 7, 12, 13, 14, 15));\n+    vec_read_xor_write(in_bytes.subspan<64, 32>(), out_bytes.subspan<64, 32>(), __builtin_shufflevector(w, x, 0, 1, 2, 3, 8, 9, 10, 11));\n+    vec_read_xor_write(in_bytes.subspan<96, 32>(), out_bytes.subspan<96, 32>(), __builtin_shufflevector(y, z, 0, 1, 2, 3, 8, 9, 10, 11));\n+\n+    if constexpr(ITER + 1 < I ) arr_read_xor_write<I, ITER + 1>(in_bytes.subspan<128>(), out_bytes.subspan<128>(), arr0, arr1, arr2, arr3);\n+}\n+\n+/* Compile-time helper to create addend vectors which used to increment the states\n+\n+    Generates vectors of the pattern:\n+    1 0 0 0 0 0 0 0\n+    3 0 0 0 2 0 0 0\n+    5 0 0 0 4 0 0 0\n+    ...\n+*/\n+template <size_t SIZE>\n+consteval std::array<vec256, SIZE> generate_increments()\n+{\n+    std::array<vec256, SIZE> rows;\n+    for (uint32_t i = 0; i < SIZE; i ++)\n+    {\n+        rows[i] = (i * (vec256){2, 0, 0, 0, 2, 0, 0, 0}) + (vec256){1, 0, 0, 0, 0, 0, 0, 0};\n+    }\n+    return rows;\n+}\n+\n+/* Main crypt function. Calculates up to 16 states.\n+\n+    Each array contains one or more vectors, with each array representing a\n+    quarter of a state. Initially, the high and low parts of each vector are\n+    duplicated. They each contain a portion of the current and next state.\n+\n+    arr0[0]    arr1[0]    arr2[0]    arr3[0]   increment\n+    ----------|---------|----------|----------|---------\n+    0x61707865 input[0]   input[4]   input[8]   [1]\n+    0x3320646e input[1]   input[5]   input[9]   [0]\n+    0x79622d32 input[2]   input[6]   input[10]  [0]\n+    0x6b206574 input[3]   input[7]   input[11]  [0]\n+\n+    0x61707865 input[0]   input[4]   input[8]   [0]\n+    0x3320646e input[1]   input[5]   input[9]   [0]\n+    0x79622d32 input[2]   input[6]   input[10]  [0]\n+    0x6b206574 input[3]   input[7]   input[11]  [0]\n+\n+    After loading the states, arr3's vectors are incremented as-necessary to\n+    contain the correct counter values.\n+\n+    This way, operations like \"arr0[0] += arr1[0]\" can perform all 8 operations\n+    in parallel, taking advantage of 256bit registers where available.\n+\n+    arrX[0] represents states 0 and 1.\n+    arrX[1] represents states 2 and 3 (if present)\n+    etc.\n+\n+    After the doublerounds have been run and the initial state has been mixed\n+    back in, the high and low portions of the vectors in each array are\n+    shuffled in order to prepare them for mixing with the input bytes. Finally,\n+    each state is xor'd with its corresponding input, byteswapped if necessary,\n+    and written to its output.\n+*/\n+template <size_t STATES>\n+ALWAYS_INLINE void multi_block_crypt(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes, const vec256& state0, const vec256& state1, const vec256& state2)\n+{\n+    static constexpr size_t HALF_STATES = STATES / 2;\n+    static constexpr vec256 nums256 = (vec256){0x61707865, 0x3320646e, 0x79622d32, 0x6b206574, 0x61707865, 0x3320646e, 0x79622d32, 0x6b206574};\n+    static constinit std::array<vec256, HALF_STATES> increments = generate_increments<HALF_STATES>();\n+\n+    std::array<vec256, HALF_STATES> arr0, arr1, arr2, arr3;\n+\n+    arr_set_vec256(arr0, nums256);\n+    arr_set_vec256(arr1, state0);\n+    arr_set_vec256(arr2, state1);\n+    arr_set_vec256(arr3, state2);\n+\n+    arr_add_arr(arr3, increments);\n+\n+    doubleround(arr0, arr1, arr2, arr3);\n+\n+    arr_add_vec256(arr0, nums256);\n+    arr_add_vec256(arr1, state0);\n+    arr_add_vec256(arr2, state1);\n+    arr_add_vec256(arr3, state2);\n+\n+    arr_add_arr(arr3, increments);\n+\n+    arr_read_xor_write(in_bytes, out_bytes, arr0, arr1, arr2, arr3);\n+}\n+\n+} // anonymous namespace\n+#endif // CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+\n+#if defined(CHACHA20_NAMESPACE)\n+namespace CHACHA20_NAMESPACE {\n+#endif\n+\n+void chacha20_crypt_vectorized(std::span<const std::byte>& in_bytes, std::span<std::byte>& out_bytes, const std::array<uint32_t, 12>& input) noexcept\n+{\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+    assert(in_bytes.size() == out_bytes.size());\n+    const vec256 state0 =  (vec256){input[0], input[1], input[2], input[3], input[0], input[1], input[2], input[3]};\n+    const vec256 state1 =  (vec256){input[4], input[5], input[6], input[7], input[4], input[5], input[6], input[7]};\n+    vec256 state2 =  (vec256){input[8], input[9], input[10], input[11], input[8], input[9], input[10], input[11]};\n+#if !defined(CHACHA20_VEC_DISABLE_STATES_16)\n+    while(in_bytes.size() >= CHACHA20_VEC_BLOCKLEN * 16) {\n+        multi_block_crypt<16>(in_bytes, out_bytes, state0, state1, state2);\n+        state2 += (vec256){16, 0, 0, 0, 16, 0, 0, 0};\n+        in_bytes = in_bytes.subspan(CHACHA20_VEC_BLOCKLEN * 16);\n+        out_bytes = out_bytes.subspan(CHACHA20_VEC_BLOCKLEN * 16);\n+    }\n+#endif\n+#if !defined(CHACHA20_VEC_DISABLE_STATES_8)\n+    while(in_bytes.size() >= CHACHA20_VEC_BLOCKLEN * 8) {\n+        multi_block_crypt<8>(in_bytes, out_bytes, state0, state1, state2);\n+        state2 += (vec256){8, 0, 0, 0, 8, 0, 0, 0};\n+        in_bytes = in_bytes.subspan(CHACHA20_VEC_BLOCKLEN * 8);\n+        out_bytes = out_bytes.subspan(CHACHA20_VEC_BLOCKLEN * 8);\n+    }",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 313,
      "original_position": 309,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There's a lot of repetition here - could we extract that to an `ALWAYS_INLINE` lambda and have something like:\r\n```C++\r\n    if constexpr (ENABLE_16) process_blocks(16);\r\n    else if constexpr (ENABLE_8)  process_blocks(8);\r\n...\r\n```\r\n\r\nI haven't implemented it locally, maybe it's naive, let me know what you think.",
      "created_at": "2025-12-17T15:25:27Z",
      "updated_at": "2025-12-17T15:46:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627508017",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627508017"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 299,
      "original_start_line": 295,
      "start_side": "RIGHT",
      "line": 313,
      "original_line": 309,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627510708",
      "pull_request_review_id": 3586783659,
      "id": 2627510708,
      "node_id": "PRRC_kwDOABII586cnKG0",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 12,
      "original_position": 12,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625293528,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "+1 for `if constexpr`, should simplify the code a lot (especially if we migrate from recursive templates as well)",
      "created_at": "2025-12-17T15:26:05Z",
      "updated_at": "2025-12-17T15:46:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627510708",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627510708"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 12,
      "original_line": 12,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627561084",
      "pull_request_review_id": 3586783659,
      "id": 2627561084,
      "node_id": "PRRC_kwDOABII586cnWZ8",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 38,
      "original_position": 38,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625334750,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I haven't used this before but the internets tells me we could use the attribute syntax here, something like:\r\n```suggestion\r\ntemplate <typename T, size_t N>\r\nusing VectorType [[gnu::vector_size(sizeof(T) * N)]] = T;\r\n\r\nusing vec256 = VectorType<uint32_t, 8>;\r\n```",
      "created_at": "2025-12-17T15:39:10Z",
      "updated_at": "2025-12-17T15:48:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627561084",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627561084"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 38,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627635541",
      "pull_request_review_id": 3588436636,
      "id": 2627635541,
      "node_id": "PRRC_kwDOABII586cnolV",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 70,
      "original_position": 70,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I believe it's possible to use compile-time loops here instead of recursive templates (if runtime loops don't get optimized sufficiently):\n\n```c++\n/** Store a vector in all array elements */\ntemplate <size_t I>\nALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n{\n    [&]<size_t... ITER>(std::index_sequence<ITER...>) {\n        ((std::get<ITER>(arr) = vec),...);\n    }(std::make_index_sequence<I>());\n}\n```\n",
      "created_at": "2025-12-17T15:59:54Z",
      "updated_at": "2025-12-17T15:59:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627635541",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627635541"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627673584",
      "pull_request_review_id": 3588480408,
      "id": 2627673584,
      "node_id": "PRRC_kwDOABII586cnx3w",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627477691,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Alternatively, with a compile-time loop:\n\n```c++\n/** Perform add/xor/rotate for the round function */\ntemplate <size_t BITS, size_t I>\nALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n{\n    [&]<size_t... ITER>(std::index_sequence<ITER...>) {\n        ((\n            arr0[ITER] += arr1[ITER],\n            arr2[ITER] ^= arr0[ITER],\n            vec_rotl<BITS>(arr2[ITER])\n        ), ...);\n    }(std::make_index_sequence<I>());\n}\n```",
      "created_at": "2025-12-17T16:10:37Z",
      "updated_at": "2025-12-17T16:10:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627673584",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627673584"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627688908",
      "pull_request_review_id": 3588498680,
      "id": 2627688908,
      "node_id": "PRRC_kwDOABII586cn1nM",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#endif\n+\n+#include <crypto/chacha20_vec.ipp>",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 26,
      "original_position": 26,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625248846,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "See branch here: https://github.com/theuni/bitcoin/commits/chacha20-vectorized/\r\n\r\nI decided to exclude the impls which require runtime detection from this PR, as I think how that should be done is a separate conversation.\r\n\r\nTo answer your question more specifically: some impls may require different compilation flags (`-mavx2`/`-mavx512vl`), which have to be in their own compilation units.",
      "created_at": "2025-12-17T16:14:47Z",
      "updated_at": "2025-12-17T16:14:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627688908",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627688908"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 26,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627732760",
      "pull_request_review_id": 3588552550,
      "id": 2627732760,
      "node_id": "PRRC_kwDOABII586coAUY",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 12,
      "original_position": 12,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625293528,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "` if constexpr` certainly makes more sense where possible. I'll have a look, thanks!",
      "created_at": "2025-12-17T16:25:11Z",
      "updated_at": "2025-12-17T16:25:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627732760",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627732760"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 12,
      "original_line": 12,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627863562",
      "pull_request_review_id": 3588710126,
      "id": 2627863562,
      "node_id": "PRRC_kwDOABII586cogQK",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 38,
      "original_position": 38,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625334750,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Because they're compiler-specific, the code makes no assumptions about the size/structure/alignment of vec256. The only accesses are via `operator[]`. So afaik, there's no need to check for this.",
      "created_at": "2025-12-17T17:03:37Z",
      "updated_at": "2025-12-17T17:03:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627863562",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627863562"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 38,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627886053",
      "pull_request_review_id": 3588736049,
      "id": 2627886053,
      "node_id": "PRRC_kwDOABII586colvl",
      "diff_hunk": "@@ -273,8 +278,29 @@ inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::spa\n             return;\n         }\n         blocks -= 1;\n-        c += BLOCKLEN;\n-        m += BLOCKLEN;\n+        c += ChaCha20Aligned::BLOCKLEN;\n+        m += ChaCha20Aligned::BLOCKLEN;\n+    }\n+}\n+\n+\n+inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes) noexcept\n+{\n+    assert(in_bytes.size() == out_bytes.size());\n+    size_t blocks = out_bytes.size() / ChaCha20Aligned::BLOCKLEN;\n+    assert(blocks * ChaCha20Aligned::BLOCKLEN == out_bytes.size());\n+#ifdef ENABLE_CHACHA20_VEC\n+    // Only use the vectorized implementations if the counter will not overflow.\n+    const bool overflow = static_cast<uint64_t>(input[8]) + blocks > std::numeric_limits<uint32_t>::max();",
      "path": "src/crypto/chacha20.cpp",
      "position": 53,
      "original_position": 53,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2626160716,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is actually doing the opposite.. it's keeping the vectorized impl from having to worry about this case. In the current code, we have:\r\n```c++\r\n++j12;\r\nif (!j12) ++j13;\r\n...\r\ninput[8] = j12;\r\ninput[9] = j13;\r\n```\r\n\r\nSo effectively `input[8]` and `input[9]` are treated as a single `uint64_t`. It's not possible to express \"cast to `uint64_t` elements and increment\" or \"increment and overflow over there\" with the vector extensions, so it turned out to be easier to just forbid the overflow cases from being vectorized at all.",
      "created_at": "2025-12-17T17:10:48Z",
      "updated_at": "2025-12-17T17:10:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627886053",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627886053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 294,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627890205",
      "pull_request_review_id": 3588743006,
      "id": 2627890205,
      "node_id": "PRRC_kwDOABII586comwd",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 46,
      "original_position": 46,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2626253726,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks, yes, I meant to change that to `internal_bswap_32` before pushing. Will do.",
      "created_at": "2025-12-17T17:12:11Z",
      "updated_at": "2025-12-17T17:12:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627890205",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627890205"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 46,
      "original_line": 46,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627891854",
      "pull_request_review_id": 3588745377,
      "id": 2627891854,
      "node_id": "PRRC_kwDOABII586conKO",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 67,
      "original_position": 67,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2626256140,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yep, will do.",
      "created_at": "2025-12-17T17:12:41Z",
      "updated_at": "2025-12-17T17:12:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627891854",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627891854"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 67,
      "original_line": 67,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627906491",
      "pull_request_review_id": 3588768183,
      "id": 2627906491,
      "node_id": "PRRC_kwDOABII586coqu7",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks for catching this! I forgot to mention in the PR description that big-endian was best-effort and untested. I figured our c-i would catch any obvious bugs. Agree it's not great that it didn't :(\r\n\r\nThanks for the quick fix too :)",
      "created_at": "2025-12-17T17:17:27Z",
      "updated_at": "2025-12-17T17:17:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627906491",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627906491"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627921902",
      "pull_request_review_id": 3588789302,
      "id": 2627921902,
      "node_id": "PRRC_kwDOABII586coufu",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I had the same disappointment when implementing the obfuscation optimization. :)\r\n\r\n@maflcko do we have a big-endian nightly that supports vectorized operations? Would it have caught this?",
      "created_at": "2025-12-17T17:22:33Z",
      "updated_at": "2025-12-17T17:22:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627921902",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627921902"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627930434",
      "pull_request_review_id": 3588799918,
      "id": 2627930434,
      "node_id": "PRRC_kwDOABII586cowlC",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627477691,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "See updated title description where I touched on this.\r\n\r\nI found (with lots of experimentation here) that different compilers use complicated and unpredictable heuristics to decide whether or not to unroll loops. Even if an unroll-able loop is detected, unrolling may be skipped because of the function size (as is the case here because it's huge).\r\n\r\nSo, I'd like to not take chances on unrolling. That means one of:\r\n- Manual unrolling\r\n- Macro-based (as-in `REPEAT10()`)\r\n- A pragma\r\n- Recursive template based\r\n\r\n[c++26 introduces `template for`](https://www.open-std.org/jtc1/sc22/wg21/docs/papers/2025/p1306r5.html), which is what we really want.\r\n\r\nI'm up for whichever of those is generally preferred, as long as it's explicit rather than implicit.",
      "created_at": "2025-12-17T17:25:36Z",
      "updated_at": "2025-12-17T17:25:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627930434",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627930434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627942778",
      "pull_request_review_id": 3588814284,
      "id": 2627942778,
      "node_id": "PRRC_kwDOABII586cozl6",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627477691,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Is there any way we could help that would make you reconsider? I don't mind running the benchmarks on a few platforms, as long as we can have simpler code. The current template magic is not something I would like to see more of - modern C++20 should be able to handle the situations we have here. I don't mind experimenting with this if you don't want to.",
      "created_at": "2025-12-17T17:30:03Z",
      "updated_at": "2025-12-17T17:30:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627942778",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627942778"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627980132",
      "pull_request_review_id": 3588859110,
      "id": 2627980132,
      "node_id": "PRRC_kwDOABII586co8tk",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 70,
      "original_position": 70,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627635541,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I avoided lambdas as I've historically observed lots of optims being skipped (with clang, at least) when using them. But since you/@ajtowns/@l0rinc have all made the same comment, I'll play around and see if these indeed compile down to nothing as one would hope.",
      "created_at": "2025-12-17T17:41:07Z",
      "updated_at": "2025-12-17T17:41:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627980132",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627980132"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627980586",
      "pull_request_review_id": 3588859560,
      "id": 2627980586,
      "node_id": "PRRC_kwDOABII586co80q",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627477691,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "@theuni See my `std::make_index_sequence` based I demonstrated above. It's template based, but doesn't need recursion, and doesn't rely on compiler unrolling. It simply expands to an expression `(a[0] = v, a[1] = v, a[2] = v, ...)` e.g.",
      "created_at": "2025-12-17T17:41:14Z",
      "updated_at": "2025-12-17T17:41:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627980586",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627980586"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627999059",
      "pull_request_review_id": 3588884458,
      "id": 2627999059,
      "node_id": "PRRC_kwDOABII586cpBVT",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 102,
      "original_position": 102,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627477691,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "https://www.agner.org/optimize/optimizing_cpp.pdf contains a few useful examples:\r\n> The automatic vectorization works best if the following conditions are satisfied:\r\n> 1. Use a compiler with good support for automatic vectorization, such as Gnu, Clang,\r\n> or Intel.\r\n> 2. Use the latest version of the compiler. The compilers are becoming better and better\r\n> at vectorization.\r\n> \r\n> 3. If the arrays or structures are accessed through pointers or references then tell the\r\n> compiler explicitly that pointers do not alias, if appropriate, using the __restrict or\r\n> __restrict__ keyword.\r\n> \r\n> 4. Use appropriate compiler options to enable the desired instruction set\r\n> (/arch:SSE2, /arch:AVX etc. for Windows, -msse2, -mavx512f, etc. for Linux)\r\n> \r\n> 5. Use the less restrictive floating point options. For Gnu and Clang compilers, use the\r\n> options -O2 -fno-trapping-math -fno-math-errno -fno-signed-zeros\r\n> (-ffast-math works as well, but functions like isnan(x) do not work under\r\n> -ffast-math).\r\n> 6. Align arrays and big structures by 16 for SSE2, preferably 32 for AVX and preferably\r\n> 64 for AVX512.\r\n> \r\n> 7. The loop count should preferably be a constant that is divisible by the number of\r\n> elements in a vector.\r\n> \r\n> 8. If arrays are accessed through pointers so that the alignment is not visible in the\r\n> scope of the function where you want vectorization then follow the advice given\r\n> above.\r\n> 9. Minimize the use of branches at the vector element level.\r\n> \r\n> 10. Avoid table lookup at the vector element level.\r\n\r\nSimilarly in https://en.algorithmica.org/hpc/simd/auto-vectorization useful hints:\r\n> The other way, specific to SIMD, is the “ignore vector dependencies” pragma. It is a general way to inform the compiler that there are no dependencies between the loop iterations:\r\n> \r\n> #pragma GCC ivdep\r\n> for (int i = 0; i < n; i++)",
      "created_at": "2025-12-17T17:45:59Z",
      "updated_at": "2025-12-17T17:46:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2627999059",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2627999059"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": 90,
      "original_start_line": 90,
      "start_side": "RIGHT",
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2628013042",
      "pull_request_review_id": 3588903647,
      "id": 2628013042,
      "node_id": "PRRC_kwDOABII586cpEvy",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "See https://github.com/bitcoin/bitcoin/pull/33436, but it was slow despite having the gui and the fuzz tests disabled. I am running it as part of nightly, so any issues will be caught before a release, but I am not sure if catching everything in pull requests is possible.\r\n\r\nMaybe it is possible to split the task into two: One for a cross-compile, which should be faster than a \"native\" compile via qemu. And another to run the tests, similar to the windows-cross tests.",
      "created_at": "2025-12-17T17:50:01Z",
      "updated_at": "2025-12-17T17:50:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2628013042",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2628013042"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2628034222",
      "pull_request_review_id": 3588928022,
      "id": 2628034222,
      "node_id": "PRRC_kwDOABII586cpJ6u",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 70,
      "original_position": 70,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627635541,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It can be done with a helper function too, but that's not as concise:\r\n\r\n```c++\r\ntemplate <size_t I, size_t... ITER>\r\nALWAYS_INLINE void arr_set_vec256_inner(std::array<vec256, I>& arr, const vec256& vec, std::index_sequence<ITER...>)\r\n{\r\n    ((std::get<ITER>(arr) = vec),...);\r\n}\r\n\r\n/** Store a vector in all array elements */\r\ntemplate <size_t I>\r\nALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\r\n{\r\n    arr_set_vec256_inner(arr, vec, std::make_index_sequence<I>());\r\n}\r\n```\r\n",
      "created_at": "2025-12-17T17:55:37Z",
      "updated_at": "2025-12-17T17:55:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2628034222",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2628034222"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629157441",
      "pull_request_review_id": 3590291479,
      "id": 2629157441,
      "node_id": "PRRC_kwDOABII586ctcJB",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 38,
      "original_position": 38,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2625334750,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Sorry, I meant just so you get an error if you're using a compiler ignores the `__attribute__` entirely but still passes the `#if` in _base.cpp.",
      "created_at": "2025-12-18T01:22:05Z",
      "updated_at": "2025-12-18T01:22:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2629157441",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629157441"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 38,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629159079",
      "pull_request_review_id": 3590293189,
      "id": 2629159079,
      "node_id": "PRRC_kwDOABII586ctcin",
      "diff_hunk": "@@ -273,8 +278,29 @@ inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::spa\n             return;\n         }\n         blocks -= 1;\n-        c += BLOCKLEN;\n-        m += BLOCKLEN;\n+        c += ChaCha20Aligned::BLOCKLEN;\n+        m += ChaCha20Aligned::BLOCKLEN;\n+    }\n+}\n+\n+\n+inline void ChaCha20Aligned::Crypt(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes) noexcept\n+{\n+    assert(in_bytes.size() == out_bytes.size());\n+    size_t blocks = out_bytes.size() / ChaCha20Aligned::BLOCKLEN;\n+    assert(blocks * ChaCha20Aligned::BLOCKLEN == out_bytes.size());\n+#ifdef ENABLE_CHACHA20_VEC\n+    // Only use the vectorized implementations if the counter will not overflow.\n+    const bool overflow = static_cast<uint64_t>(input[8]) + blocks > std::numeric_limits<uint32_t>::max();",
      "path": "src/crypto/chacha20.cpp",
      "position": 53,
      "original_position": 53,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2626160716,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yeah, I was thinking about whether the code should just do the non-vectorized stuff to get past the overflow then immediately go back to vectorizing, rather than waiting for the next call. I think what you've got makes sense.",
      "created_at": "2025-12-18T01:23:16Z",
      "updated_at": "2025-12-18T01:23:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2629159079",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629159079"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 294,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629220635",
      "pull_request_review_id": 3590372415,
      "id": 2629220635,
      "node_id": "PRRC_kwDOABII586ctrkb",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 70,
      "original_position": 70,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627635541,
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Writing this as:\r\n\r\n```c++\r\n    template<size_t... ITER> using iseq = std::index_sequence<ITER>;\r\n    static constexpr ISEQ = std::make_index_sequence<I>();\r\n    \r\n    template<size_t... ITER>\r\n    ALWAYS_INLINE void arr_set_vec256(iseq<ITER>, std::array<vec256, I>& arr, const vec256& vec)\r\n    {\r\n        ((std::get<ITER>(arr) = vec), ...);\r\n    }\r\n\r\n   ...\r\n        arr_set_vec256(ISEQ, arr0, num256);\r\n```\r\n\r\ndoesn't seem too bad, and avoids lambdas? Possibly still a bit clumsy if you can't capture `I` by putting everything in a class? Might still be a bit clumsy for add_xor_rot.",
      "created_at": "2025-12-18T01:58:30Z",
      "updated_at": "2025-12-18T01:58:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2629220635",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629220635"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629716761",
      "pull_request_review_id": 3590957725,
      "id": 2629716761,
      "node_id": "PRRC_kwDOABII586cvksZ",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Actually, I ran the CI config locally, but it didn't catch this, as the platform opts out. The CI doesn't run the `   sed -i \"s/#  define CHACHA20_VEC_DISABLE_STATES_2/\\/\\/#  define CHACHA20_VEC_DISABLE_STATES_2/\" src/crypto/chacha20_vec_base.cpp && \\` portion, so it would not have caught this, even if the task was run.",
      "created_at": "2025-12-18T06:13:49Z",
      "updated_at": "2025-12-18T06:13:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2629716761",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2629716761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2630727791",
      "pull_request_review_id": 3592461217,
      "id": 2630727791,
      "node_id": "PRRC_kwDOABII586czbhv",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks for checking @maflcko, that's why I asked.\r\nThe vectorized operations are obviously supported, but for some reason were not triggered for me either.\r\n@theuni, is this just an emulation anomaly or we were just too cautious?\r\nI understdood that @achow101 has access to real big-endian power9 machine that we might be able to test this on when it's ready.",
      "created_at": "2025-12-18T11:47:22Z",
      "updated_at": "2025-12-18T11:47:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2630727791",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2630727791"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2631524729",
      "pull_request_review_id": 3593561008,
      "id": 2631524729,
      "node_id": "PRRC_kwDOABII586c2eF5",
      "diff_hunk": "@@ -0,0 +1,26 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#define CHACHA20_NAMESPACE chacha20_vec_base\n+\n+// This file should define which states should be en/disabled for all\n+// supported architectures. For some, like x86-64 and armv8, simd features\n+// (sse2 and neon respectively) are safe to use without runtime detection.\n+\n+#if defined(__x86_64__) || defined(__amd64__)\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#elif defined(__ARM_NEON)\n+#  define CHACHA20_VEC_DISABLE_STATES_2\n+#else\n+// Be conservative and require platforms to opt-in\n+#  define CHACHA20_VEC_DISABLE_STATES_16\n+#  define CHACHA20_VEC_DISABLE_STATES_8\n+#  define CHACHA20_VEC_DISABLE_STATES_6\n+#  define CHACHA20_VEC_DISABLE_STATES_4\n+#  define CHACHA20_VEC_DISABLE_STATES_2",
      "path": "src/crypto/chacha20_vec_base.cpp",
      "position": 23,
      "original_position": 23,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627310095,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "@l0rinc As the code is written at the moment, all platforms must opt-in to vectorization as opposed to opting out. I'm not sure that's the best approach, but I figured that was a reasonable starting point.\r\n\r\nMy reasoning for that was: consider non-x86, non-arm+neon platforms. For the most part, I'm assuming they're under-powered. Enabling (for example) 4x blocks/sec for mipsel would probably cause a drastic slowdown. Obviously there are lots of other powerful platforms, but I figured those would be added over time.\r\n\r\nSo if there's a big-endian architecture (or more ideally, a specific instruction set ala `__ARM_NEON`) that demonstrates a performance gain from calculating multiple states at once, it should be added here.\r\n\r\nOf course, we could go the opposite direction and opt all platforms IN to all states, and instead opt-out the slow ones.\r\n\r\ntl;dr: If we want a big-endian platform to be supported, we need to opt one in or provide an override.",
      "created_at": "2025-12-18T15:22:20Z",
      "updated_at": "2025-12-18T15:22:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2631524729",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2631524729"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 23,
      "original_line": 23,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646339883",
      "pull_request_review_id": 3611660652,
      "id": 2646339883,
      "node_id": "PRRC_kwDOABII586du_Er",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}\n+\n+/*\n+The first round:\n+            QUARTERROUND( x0, x4, x8,x12);\n+            QUARTERROUND( x1, x5, x9,x13);\n+            QUARTERROUND( x2, x6,x10,x14);\n+            QUARTERROUND( x3, x7,x11,x15);\n+\n+The second round:\n+            QUARTERROUND( x0, x5,x10,x15);\n+            QUARTERROUND( x1, x6,x11,x12);\n+            QUARTERROUND( x2, x7, x8,x13);\n+            QUARTERROUND( x3, x4, x9,x14);\n+\n+After the first round, arr_shuf0, arr_shuf1, and arr_shuf2 are used to shuffle\n+the layout to prepare for the second round.\n+\n+After the second round, they are used (in reverse) to restore the original\n+layout.\n+\n+*/\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf0(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 1, 2, 3, 0, 5, 6, 7, 4);\n+    if constexpr(ITER + 1 < I ) arr_shuf0<I, ITER + 1>(arr);\n+}\n+\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf1(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 2, 3, 0, 1, 6, 7, 4, 5);\n+    if constexpr(ITER + 1 < I ) arr_shuf1<I, ITER + 1>(arr);\n+}\n+\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_shuf2(std::array<vec256, I>& arr)\n+{\n+    vec256& x = std::get<ITER>(arr);\n+    x = __builtin_shufflevector(x, x, 3, 0, 1, 2, 7, 4, 5, 6);\n+    if constexpr(ITER + 1 < I ) arr_shuf2<I, ITER + 1>(arr);\n+}\n+\n+/* Main round function. */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void doubleround(std::array<vec256, I>& arr0, std::array<vec256, I>& arr1, std::array<vec256, I>&arr2, std::array<vec256, I>&arr3)\n+{\n+    arr_add_xor_rot<16>(arr0, arr1, arr3);\n+    arr_add_xor_rot<12>(arr2, arr3, arr1);\n+    arr_add_xor_rot<8>(arr0, arr1, arr3);\n+    arr_add_xor_rot<7>(arr2, arr3, arr1);\n+    arr_shuf0(arr1);\n+    arr_shuf1(arr2);\n+    arr_shuf2(arr3);\n+    arr_add_xor_rot<16>(arr0, arr1, arr3);\n+    arr_add_xor_rot<12>(arr2, arr3, arr1);\n+    arr_add_xor_rot<8>(arr0, arr1, arr3);\n+    arr_add_xor_rot<7>(arr2, arr3, arr1);\n+    arr_shuf2(arr1);\n+    arr_shuf1(arr2);\n+    arr_shuf0(arr3);\n+    if constexpr (ITER + 1 < 10) doubleround<I, ITER + 1>(arr0, arr1, arr2, arr3);\n+}\n+\n+/* Read 32bytes of input, xor with calculated state, write to output. Assumes\n+   that input and output are unaligned, and makes no assumptions about the\n+   internal layout of vec256;\n+*/\n+ALWAYS_INLINE void vec_read_xor_write(std::span<const std::byte, 32> in_bytes, std::span<std::byte, 32> out_bytes, const vec256& vec)\n+{\n+    std::array<uint32_t, 8> temparr;\n+    memcpy(temparr.data(), in_bytes.data(), in_bytes.size());\n+    vec256 tempvec = vec ^ (vec256){temparr[0], temparr[1], temparr[2], temparr[3], temparr[4], temparr[5], temparr[6], temparr[7]};\n+    vec_byteswap(tempvec);\n+    temparr = {tempvec[0], tempvec[1], tempvec[2], tempvec[3], tempvec[4], tempvec[5], tempvec[6], tempvec[7]};\n+    memcpy(out_bytes.data(), temparr.data(), out_bytes.size());\n+}\n+\n+/* Merge the 128 bit lanes from 2 states to the proper order, then pass each vec_read_xor_write */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_read_xor_write(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes, const std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, const std::array<vec256, I>& arr2, const std::array<vec256, I>& arr3)\n+{\n+    const vec256& w = std::get<ITER>(arr0);\n+    const vec256& x = std::get<ITER>(arr1);\n+    const vec256& y = std::get<ITER>(arr2);\n+    const vec256& z = std::get<ITER>(arr3);\n+\n+    vec_read_xor_write(in_bytes.first<32>(), out_bytes.first<32>(), __builtin_shufflevector(w, x, 4, 5, 6, 7, 12, 13, 14, 15));\n+    vec_read_xor_write(in_bytes.subspan<32, 32>(), out_bytes.subspan<32, 32>(), __builtin_shufflevector(y, z, 4, 5, 6, 7, 12, 13, 14, 15));\n+    vec_read_xor_write(in_bytes.subspan<64, 32>(), out_bytes.subspan<64, 32>(), __builtin_shufflevector(w, x, 0, 1, 2, 3, 8, 9, 10, 11));\n+    vec_read_xor_write(in_bytes.subspan<96, 32>(), out_bytes.subspan<96, 32>(), __builtin_shufflevector(y, z, 0, 1, 2, 3, 8, 9, 10, 11));\n+\n+    if constexpr(ITER + 1 < I ) arr_read_xor_write<I, ITER + 1>(in_bytes.subspan<128>(), out_bytes.subspan<128>(), arr0, arr1, arr2, arr3);\n+}\n+\n+/* Compile-time helper to create addend vectors which used to increment the states\n+\n+    Generates vectors of the pattern:\n+    1 0 0 0 0 0 0 0\n+    3 0 0 0 2 0 0 0\n+    5 0 0 0 4 0 0 0\n+    ...\n+*/\n+template <size_t SIZE>\n+consteval std::array<vec256, SIZE> generate_increments()\n+{\n+    std::array<vec256, SIZE> rows;\n+    for (uint32_t i = 0; i < SIZE; i ++)\n+    {\n+        rows[i] = (i * (vec256){2, 0, 0, 0, 2, 0, 0, 0}) + (vec256){1, 0, 0, 0, 0, 0, 0, 0};\n+    }\n+    return rows;\n+}\n+\n+/* Main crypt function. Calculates up to 16 states.\n+\n+    Each array contains one or more vectors, with each array representing a\n+    quarter of a state. Initially, the high and low parts of each vector are\n+    duplicated. They each contain a portion of the current and next state.\n+\n+    arr0[0]    arr1[0]    arr2[0]    arr3[0]   increment\n+    ----------|---------|----------|----------|---------\n+    0x61707865 input[0]   input[4]   input[8]   [1]\n+    0x3320646e input[1]   input[5]   input[9]   [0]\n+    0x79622d32 input[2]   input[6]   input[10]  [0]\n+    0x6b206574 input[3]   input[7]   input[11]  [0]\n+\n+    0x61707865 input[0]   input[4]   input[8]   [0]\n+    0x3320646e input[1]   input[5]   input[9]   [0]\n+    0x79622d32 input[2]   input[6]   input[10]  [0]\n+    0x6b206574 input[3]   input[7]   input[11]  [0]\n+\n+    After loading the states, arr3's vectors are incremented as-necessary to\n+    contain the correct counter values.\n+\n+    This way, operations like \"arr0[0] += arr1[0]\" can perform all 8 operations\n+    in parallel, taking advantage of 256bit registers where available.\n+\n+    arrX[0] represents states 0 and 1.\n+    arrX[1] represents states 2 and 3 (if present)\n+    etc.\n+\n+    After the doublerounds have been run and the initial state has been mixed\n+    back in, the high and low portions of the vectors in each array are\n+    shuffled in order to prepare them for mixing with the input bytes. Finally,\n+    each state is xor'd with its corresponding input, byteswapped if necessary,\n+    and written to its output.\n+*/\n+template <size_t STATES>\n+ALWAYS_INLINE void multi_block_crypt(std::span<const std::byte> in_bytes, std::span<std::byte> out_bytes, const vec256& state0, const vec256& state1, const vec256& state2)\n+{\n+    static constexpr size_t HALF_STATES = STATES / 2;\n+    static constexpr vec256 nums256 = (vec256){0x61707865, 0x3320646e, 0x79622d32, 0x6b206574, 0x61707865, 0x3320646e, 0x79622d32, 0x6b206574};\n+    static constinit std::array<vec256, HALF_STATES> increments = generate_increments<HALF_STATES>();\n+\n+    std::array<vec256, HALF_STATES> arr0, arr1, arr2, arr3;\n+\n+    arr_set_vec256(arr0, nums256);\n+    arr_set_vec256(arr1, state0);\n+    arr_set_vec256(arr2, state1);\n+    arr_set_vec256(arr3, state2);\n+\n+    arr_add_arr(arr3, increments);\n+\n+    doubleround(arr0, arr1, arr2, arr3);\n+\n+    arr_add_vec256(arr0, nums256);\n+    arr_add_vec256(arr1, state0);\n+    arr_add_vec256(arr2, state1);\n+    arr_add_vec256(arr3, state2);\n+\n+    arr_add_arr(arr3, increments);\n+\n+    arr_read_xor_write(in_bytes, out_bytes, arr0, arr1, arr2, arr3);\n+}\n+\n+} // anonymous namespace\n+#endif // CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+\n+#if defined(CHACHA20_NAMESPACE)\n+namespace CHACHA20_NAMESPACE {\n+#endif\n+\n+void chacha20_crypt_vectorized(std::span<const std::byte>& in_bytes, std::span<std::byte>& out_bytes, const std::array<uint32_t, 12>& input) noexcept",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 292,
      "original_position": 288,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": null,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think this function should get a short description too. Wasn't immediately clear to me that it attempts to peel off larger blocks first before potentially finishing with a few smaller blocks. ",
      "created_at": "2025-12-24T23:02:17Z",
      "updated_at": "2025-12-28T13:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2646339883",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646339883"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 292,
      "original_line": 288,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646341499",
      "pull_request_review_id": 3611660652,
      "id": 2646341499,
      "node_id": "PRRC_kwDOABII586du_d7",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 70,
      "original_position": 70,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2627635541,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Is there a particular reason for the aversion to the current approach? It seems easier to read and probably also to debug to me.",
      "created_at": "2025-12-24T23:04:50Z",
      "updated_at": "2025-12-28T13:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2646341499",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646341499"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 70,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649714174",
      "pull_request_review_id": 3611660652,
      "id": 2649714174,
      "node_id": "PRRC_kwDOABII586d723-",
      "diff_hunk": "@@ -0,0 +1,342 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <crypto/chacha20_vec.h>\n+\n+#include <bit>\n+#include <cassert>\n+#include <cstring>\n+#include <limits>\n+\n+#if defined(ENABLE_CHACHA20_VEC)\n+\n+#if defined(CHACHA20_VEC_DISABLE_STATES_16) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_8) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_6) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_4) && \\\n+    defined(CHACHA20_VEC_DISABLE_STATES_2)\n+#define CHACHA20_VEC_ALL_MULTI_STATES_DISABLED\n+#endif\n+\n+\n+#if !defined(CHACHA20_VEC_ALL_MULTI_STATES_DISABLED)\n+\n+#if defined(__has_attribute)\n+#  if __has_attribute(always_inline)\n+#    define ALWAYS_INLINE __attribute__ ((always_inline)) inline\n+#  endif\n+#endif\n+\n+#if !defined(ALWAYS_INLINE)\n+#  define ALWAYS_INLINE inline\n+#endif\n+\n+\n+namespace {\n+\n+using vec256 = uint32_t __attribute__((__vector_size__(32)));\n+\n+/** Endian-conversion for big-endian */\n+ALWAYS_INLINE void vec_byteswap(vec256& vec)\n+{\n+    if constexpr (std::endian::native == std::endian::big)\n+    {\n+        vec256 ret;\n+        ret[0] = __builtin_bswap32(vec[0]);\n+        ret[1] = __builtin_bswap32(vec[1]);\n+        ret[2] = __builtin_bswap32(vec[2]);\n+        ret[3] = __builtin_bswap32(vec[3]);\n+        ret[4] = __builtin_bswap32(vec[4]);\n+        ret[5] = __builtin_bswap32(vec[5]);\n+        ret[6] = __builtin_bswap32(vec[6]);\n+        ret[7] = __builtin_bswap32(vec[7]);\n+        vec = ret;\n+    }\n+}\n+\n+/** Left-rotate vector */\n+template <size_t BITS>\n+ALWAYS_INLINE void vec_rotl(vec256& vec)\n+{\n+    vec = (vec << BITS) | (vec >> (32 - BITS));\n+}\n+\n+/** Store a vector in all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_set_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) = vec;\n+    if constexpr(ITER + 1 < I ) arr_set_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add a vector to all array elements */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_vec256(std::array<vec256, I>& arr, const vec256& vec)\n+{\n+    std::get<ITER>(arr) += vec;\n+    if constexpr(ITER + 1 < I ) arr_add_vec256<I, ITER + 1>(arr, vec);\n+}\n+\n+/** Add corresponding vectors in arr1 to arr0 */\n+template <size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_arr(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1)\n+{\n+    std::get<ITER>(arr0) += std::get<ITER>(arr1);\n+    if constexpr(ITER + 1 < I ) arr_add_arr<I, ITER + 1>(arr0, arr1);\n+}\n+\n+/** Perform add/xor/rotate for the round function */\n+template <size_t BITS, size_t I, size_t ITER = 0>\n+ALWAYS_INLINE void arr_add_xor_rot(std::array<vec256, I>& arr0, const std::array<vec256, I>& arr1, std::array<vec256, I>& arr2)\n+{\n+    vec256& x = std::get<ITER>(arr0);\n+    const vec256& y = std::get<ITER>(arr1);\n+    vec256& z = std::get<ITER>(arr2);\n+\n+    x += y;\n+    z ^= x;\n+    vec_rotl<BITS>(z);\n+\n+    if constexpr(ITER + 1 < I ) arr_add_xor_rot<BITS, I, ITER + 1>(arr0, arr1, arr2);\n+}\n+\n+/*\n+The first round:\n+            QUARTERROUND( x0, x4, x8,x12);\n+            QUARTERROUND( x1, x5, x9,x13);\n+            QUARTERROUND( x2, x6,x10,x14);\n+            QUARTERROUND( x3, x7,x11,x15);\n+\n+The second round:\n+            QUARTERROUND( x0, x5,x10,x15);\n+            QUARTERROUND( x1, x6,x11,x12);\n+            QUARTERROUND( x2, x7, x8,x13);\n+            QUARTERROUND( x3, x4, x9,x14);\n+\n+After the first round, arr_shuf0, arr_shuf1, and arr_shuf2 are used to shuffle\n+the layout to prepare for the second round.\n+\n+After the second round, they are used (in reverse) to restore the original\n+layout.",
      "path": "src/crypto/chacha20_vec.ipp",
      "position": 121,
      "original_position": 121,
      "commit_id": "cdfca84e235ead4306aadbf27df561964bcd6c2e",
      "original_commit_id": "3bddf59cd3f201ecf8d65bb1f6c0cde5c39595e9",
      "in_reply_to_id": 2626127018,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Makes sense to me too, but I'm not sure why doing it this way is preferable. Intuitively I would have expected that the vectors hold the same word spread over multiple blocks. But if I understand your approach here, we have multiple words over two blocks. Is it just easier to express the quarter rounds in this way?",
      "created_at": "2025-12-28T13:49:29Z",
      "updated_at": "2025-12-28T13:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/34083#discussion_r2649714174",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649714174"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/34083"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 121,
      "original_line": 121,
      "side": "RIGHT"
    }
  ]
}