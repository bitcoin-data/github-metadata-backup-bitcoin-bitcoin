{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397",
    "id": 2208562627,
    "node_id": "PR_kwDOABII586Do_3D",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31397",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31397.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31397.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31397",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31397/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/f96df3d60a943b87eecd3a6915fcace0eee2838f",
    "number": 31397,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "p2p: track and use all potential peers for orphan resolution",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "Part of #27463.\r\n\r\n(Transaction) **orphan resolution** is a process that kicks off when we are missing UTXOs to validate an unconfirmed transaction. We currently request missing parents by txid; BIP 331 also defines a way to [explicitly request ancestors](https://github.com/bitcoin/bips/blob/master/bip-0331.mediawiki#handle-orphans-better).\r\n\r\nCurrently, when we find that a transaction is an orphan, we only try to resolve it with the peer who provided the `tx`. If this doesn't work out (e.g. they send a `notfound` or don't respond), we do not try again. We actually can't, because we've already forgotten who else could resolve this orphan (i.e. all the other peers who announced the transaction).\r\n\r\nWhat is wrong with this? It makes transaction download less reliable, particularly for 1p1c packages which must go through orphan resolution in order to be downloaded.\r\n\r\nCan we fix this with BIP 331 / is this \"duct tape\" before the real solution?\r\nBIP 331 (receiver-initiated ancestor package relay) is also based on the idea that there is an orphan that needs resolution, but it's just a new way of communicating information. It's not inherently more honest; you can request ancestor package information and get a `notfound`. So ancestor package relay still requires some kind of procedure for retrying when an orphan resolution attempt fails. See the #27742 implementation which builds on this orphan resolution tracker to keep track of what packages to download (it just isn't rebased on this exact branch). The difference when using BIP 331 is that we request `ancpkginfo` and then `pkgtxns` instead of the parent txids.\r\n\r\nApproach\r\nThis PR introduces `m_orphan_resolution_tracker` which is responsible for remembering which peers are candidates for orphan resolution and scheduling when to make orphan resolution requests (i.e. getdata for txid of missing parent(s)). The scheduling process should be:\r\n- Bandwidth-efficient: don't have too many requests out at once. As already implemented today, transaction requests for orphan parents and regular download both go through the `TxRequestTracker` so that we don't have duplicate requests out.\r\n- Not vulnerable to censorship: don't give up too easily, use all candidate peers. See e.g. https://bitcoincore.org/en/2024/07/03/disclose_already_asked_for/\r\n- Load-balance between peers: don't overload peers; use all peers available. This is also useful for when we introduce per-peer orphan protection, since each peer will have limited slots.\r\n\r\nNotice that the functionality and requirements are extremely similar to that of transaction download. Naturally, `TxRequestTracker` is the data structure used for `m_orphan_resolution_tracker`. Instead of tracking hashes of transactions we need to download, it tracks hashes of orphans we need to resolve. ",
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "created_at": "2024-11-30T21:06:45Z",
    "updated_at": "2024-12-06T14:42:06Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "6b30d67128b19bb7ddcf8b88756e2999cafb8baf",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "glozow:2024-11-multi-orphan",
      "ref": "2024-11-multi-orphan",
      "sha": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 244262754,
        "node_id": "MDEwOlJlcG9zaXRvcnkyNDQyNjI3NTQ=",
        "name": "bitcoin",
        "full_name": "glozow/bitcoin",
        "owner": {
          "login": "glozow",
          "id": 25183001,
          "node_id": "MDQ6VXNlcjI1MTgzMDAx",
          "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/glozow",
          "html_url": "https://github.com/glozow",
          "followers_url": "https://api.github.com/users/glozow/followers",
          "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
          "organizations_url": "https://api.github.com/users/glozow/orgs",
          "repos_url": "https://api.github.com/users/glozow/repos",
          "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/glozow/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/glozow/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/glozow/bitcoin",
        "archive_url": "https://api.github.com/repos/glozow/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/glozow/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/glozow/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/glozow/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/glozow/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/glozow/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/glozow/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/glozow/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/glozow/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/glozow/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/glozow/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/glozow/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/glozow/bitcoin/events",
        "forks_url": "https://api.github.com/repos/glozow/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/glozow/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/glozow/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/glozow/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/glozow/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/glozow/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/glozow/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/glozow/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/glozow/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/glozow/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/glozow/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/glozow/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/glozow/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/glozow/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/glozow/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/glozow/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:glozow/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/glozow/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/glozow/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/glozow/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/glozow/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/glozow/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/glozow/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/glozow/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/glozow/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/glozow/bitcoin/hooks",
        "svn_url": "https://github.com/glozow/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 4,
        "stargazers_count": 12,
        "watchers_count": 12,
        "size": 264372,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-06T12:27:24Z",
        "created_at": "2020-03-02T02:31:56Z",
        "updated_at": "2024-12-05T19:20:35Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "22723c809a8abce415195693546e2a7c03e516c4",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36490,
        "stargazers_count": 80099,
        "watchers_count": 80099,
        "size": 273394,
        "default_branch": "master",
        "open_issues_count": 654,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-06T11:38:53Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-12-06T14:56:12Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 510,
    "deletions": 182,
    "changed_files": 18,
    "commits": 11,
    "review_comments": 35,
    "comments": 3
  },
  "events": [
    {
      "event": "labeled",
      "id": 15482319323,
      "node_id": "LE_lADOABII586haVlzzwAAAAOa0XHb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15482319323",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-30T21:06:45Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "commented",
      "id": 2509386087,
      "node_id": "IC_kwDOABII586VkjFn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2509386087",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-30T21:06:50Z",
      "updated_at": "2024-12-05T11:25:23Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31397.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/31397#pullrequestreview-2472515530) |\n\nIf your review is incorrectly listed, please react with üëé to this comment and the bot will ignore it on the next update.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#issuecomment-2509386087",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31397"
    },
    {
      "event": "reviewed",
      "id": 2478886117,
      "node_id": "PRR_kwDOABII586TwMzl",
      "url": null,
      "actor": null,
      "commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#pullrequestreview-2478886117",
      "submitted_at": "2024-12-04T14:34:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
    },
    {
      "event": "reviewed",
      "id": 2472515530,
      "node_id": "PRR_kwDOABII586TX5fK",
      "url": null,
      "actor": null,
      "commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\nI implemented what I was talking about in the [review club yesterday](https://bitcoincore.reviews/31397) here: https://github.com/dergoegge/bitcoin/commits/2024-12-rslv-orphns/ (the only difference is the main commit 3928b400d805f75e0ba5b9947d5d441a828aa5be) and it looks like it passes your functional test additions! So perhaps it's worth exploring if we actually need another tracker...\r\n\r\n\r\n<details>\r\n\r\n<summary>IRC logs</summary>\r\n\r\n```\r\n17:34 \t<dergoegge> I was wondering why we need another txrequest tracker instance for this? couldn‚Äôt we just keep track of announcers in the orphanage (same as in the PR) and then add requests for the parents to the existing tracker on future announcements?\r\n17:35 \t<glozow> dergoegge: that's an idea. How would you schedule the requests?\r\n17:35 \t<dergoegge> ideally at the same time\r\n17:35 \t<glozow> Is there a cost to having another txrequest tracker? It's not that different from adding another std::map\r\n17:35 \t<glozow> No, I mean, how would you load-balance between peers, bake in preferences, etc.\r\n17:36 \t<dergoegge> isn't that what the existing tracker does?\r\n17:36 \t<glozow> Oh, you mean adding a new type to the tracker? So we'd have txid type, wtxid type, and orphan?\r\n17:37 \t<glozow> also note that the parent requests are added to the txrequest tracker\r\n17:39 \t<dergoegge> I guess I'm wondering why we need the concept of tracking the resolution by orphan id, as opposed to just putting the requests for the parents in the existing tracker\r\n17:39 \t<glozow> we do put the requests for the parents in the existing tracker\r\n17:39 \t<glozow> Maybe we are crossing wires?\r\n17:39 \t<instagibbs> mmmm he's asking why the add to new tracker, then \"immediately\" add to old one, vs just add to old one, I think\r\n17:40 \t<dergoegge> yea\r\n17:40 \t<instagibbs> add to old one with \"proper delays\"\r\n17:40 \t<instagibbs> I didn't get far enough in my review to figure this out either üòÖ\r\n17:40 \t<glozow> We might have multiple candidates for orphan resolution\r\n17:41 \t<glozow> Oh I see what you're saying\r\n17:42 \t<dergoegge> \"multiple candidates\" as in same parents different orphan?\r\n17:42 \t<glozow> Perhaps that could work, where you're treating it as if all of them just announced the missing parents? I don't know how you'd add `ancpkginfo` orphan resolution easily this way though.\r\n17:43 \t<glozow> different peers same orphan\r\n17:43 \t<instagibbs> You'd also have to somehow track that you're no longer asking for any parents of an orphan in order to EraseOrphanOfPeer?\r\n17:43 \t<marcofleon> yeah i was thinking it made sense with GetCandidatePeers. Having another tracker to separate out the orphan reso process\r\n17:46 \t<glozow> will think about this idea some more\r\n17:47 \t<dergoegge> me too üëç\r\n17:47 \t<glozow> I think it's possible it works? My main questions would be (1) what is the cost of having a second tracker? Because it's the perfect data structure for this. (2) how do we make it extensible to package relay still.\r\n17:48 \t<instagibbs> imo the cost is mostly an additional structure lying around that needs to stay in sync with other things\r\n17:48 \t<dergoegge> 1) if we don't need it then it's just extra complexity 2) fair!\r\n17:48 \t<marcofleon> The fact that there are candidates that be added or not added to that new tracker is why it made sense to me in the first place I guess is what i was saying\r\n17:48 \t<marcofleon> can be*\r\n17:49 \t<glozow> (1) shoving it into the existing tracker but needing to have extra logic could also be complexity!\r\n17:49 \t<dergoegge> well in my mind it wouldn't need extra logic but I might be wrong, need to think more\r\n17:49 \t<instagibbs> proof of code for this I think..\r\n17:49 \t<glozow> but yeah, I don't like that we need to ensure m_orphanage and m_orphan_resolution_tracker are in sync. that's super fair\r\n17:49 \t<dergoegge> frfr\r\n17:50 \t<glozow> yeah let's see what the code would look like\r\n17:50 \t<marcofleon> fr\r\n17:50 \t<glozow> fr r r\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#pullrequestreview-2472515530",
      "submitted_at": "2024-12-05T11:25:20Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
    },
    {
      "event": "commented",
      "id": 2520264267,
      "node_id": "IC_kwDOABII586WOC5L",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2520264267",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T13:00:57Z",
      "updated_at": "2024-12-05T13:00:57Z",
      "author_association": "MEMBER",
      "body": "Thanks @dergoegge, will spend some time thinking about whether there are any problems with it. Perhaps we can do this easier version now and cross the orphan reso tracker bridge when we need to build the 2-step orphan resolution protocol (info and then transactions).",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#issuecomment-2520264267",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31397"
    },
    {
      "event": "mentioned",
      "id": 15543806472,
      "node_id": "MEE_lADOABII586haVlzzwAAAAOee6oI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15543806472",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T13:01:00Z"
    },
    {
      "event": "subscribed",
      "id": 15543806492,
      "node_id": "SE_lADOABII586haVlzzwAAAAOee6oc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15543806492",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T13:01:00Z"
    },
    {
      "event": "reviewed",
      "id": 2473080499,
      "node_id": "PRR_kwDOABII586TaDaz",
      "url": null,
      "actor": null,
      "commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#pullrequestreview-2473080499",
      "submitted_at": "2024-12-05T13:34:25Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDUwM2U1MmE3ZmU0YjMwYTQ0NjQwOGQzNmQzMDlhZjU0YThmNTY1NzI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/503e52a7fe4b30a446408d36d309af54a8f56572",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/503e52a7fe4b30a446408d36d309af54a8f56572",
      "tree": {
        "sha": "7728e78dee3f79d0fd977e0cde424cd46716a013",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7728e78dee3f79d0fd977e0cde424cd46716a013"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b1f0f3c288af3464209a48a608d3d7122c06c21f",
          "sha": "b1f0f3c288af3464209a48a608d3d7122c06c21f",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b1f0f3c288af3464209a48a608d3d7122c06c21f"
        }
      ],
      "message": "[txrequest] GetCandidatePeers\n\nNeeded for a later commit adding logic to ask the TxRequestTracker for a\nlist of announcers.  These announcers should know the parents of the\ntransaction they announced.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:24:17Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-03-20T10:37:23Z"
      },
      "sha": "503e52a7fe4b30a446408d36d309af54a8f56572"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRiOTMyODE5ODA1NTQ2YmUxNDkxZjY5YjdmNmEyZmIzZDYwNjc4YTA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4b932819805546be1491f69b7f6a2fb3d60678a0",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4b932819805546be1491f69b7f6a2fb3d60678a0",
      "tree": {
        "sha": "35054afc685b11ef0634ff149802728765f41e97",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/35054afc685b11ef0634ff149802728765f41e97"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/503e52a7fe4b30a446408d36d309af54a8f56572",
          "sha": "503e52a7fe4b30a446408d36d309af54a8f56572",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/503e52a7fe4b30a446408d36d309af54a8f56572"
        }
      ],
      "message": "[refactor] change type of unique_parents to Txid",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-07-26T13:10:21Z"
      },
      "sha": "4b932819805546be1491f69b7f6a2fb3d60678a0"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDgwYTBmZDAxMTkwMmRlMGI0ZDA1YTJiOThlZTBlZTRkMjhhZGNmZDA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0",
      "tree": {
        "sha": "c3761a91d6c02fdbaa3a6dbd69c784c214329b07",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c3761a91d6c02fdbaa3a6dbd69c784c214329b07"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4b932819805546be1491f69b7f6a2fb3d60678a0",
          "sha": "4b932819805546be1491f69b7f6a2fb3d60678a0",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4b932819805546be1491f69b7f6a2fb3d60678a0"
        }
      ],
      "message": "[txorphanage] store parent txids in OrphanTx\n\nUnused for now",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-07-27T10:27:16Z"
      },
      "sha": "80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI5NTY1ZGQ5ZWQyOWFjMDNhMjVlZmEyMDZhZjY1MzFiNzllYzM2ZTQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b9565dd9ed29ac03a25efa206af6531b79ec36e4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b9565dd9ed29ac03a25efa206af6531b79ec36e4",
      "tree": {
        "sha": "e1be255664d8fbe14e1cdd506b69fb9ba8c294ff",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e1be255664d8fbe14e1cdd506b69fb9ba8c294ff"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0",
          "sha": "80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/80a0fd011902de0b4d05a2b98ee0ee4d28adcfd0"
        }
      ],
      "message": "[txorphanage] support multiple announcers\n\nAdd ability to add and track multiple announcers per orphan transaction,\nerasing announcers but not the entire orphan.\n\nThe tx creation code in orphanage_tests needs to be updated so that each\ntx is unique, because the CountOrphans() check assumes that calling\nEraseForPeer necessarily means its orphans are deleted.\n\nUnused for now.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2023-04-18T15:02:58Z"
      },
      "sha": "b9565dd9ed29ac03a25efa206af6531b79ec36e4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGEwZTQyN2I0NmUxOGJjNDZkYTBkZDdlOTZkNWVhY2MzZDM3YTZmOTM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93",
      "tree": {
        "sha": "317615c67ad7336635e07d6589b9dd8884b70664",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/317615c67ad7336635e07d6589b9dd8884b70664"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b9565dd9ed29ac03a25efa206af6531b79ec36e4",
          "sha": "b9565dd9ed29ac03a25efa206af6531b79ec36e4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b9565dd9ed29ac03a25efa206af6531b79ec36e4"
        }
      ],
      "message": "[unit test] multiple announcers",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-07-31T09:24:39Z"
      },
      "sha": "a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGVkMDExMmQzMDlmNzY1MGExMDVjOWJmMDI3NDk1ZTVhYzc3ZjRkYWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ed0112d309f7650a105c9bf027495e5ac77f4daf",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ed0112d309f7650a105c9bf027495e5ac77f4daf",
      "tree": {
        "sha": "79018e49bc538abbf7db987f1d4700d957c13b99",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/79018e49bc538abbf7db987f1d4700d957c13b99"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93",
          "sha": "a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a0e427b46e18bc46da0dd7e96d5eacc3d37a6f93"
        }
      ],
      "message": "[fuzz] orphanage multiple announcer functions",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-07-31T09:52:01Z"
      },
      "sha": "ed0112d309f7650a105c9bf027495e5ac77f4daf"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI3ODJmOGIxNTdmYzBjMWZlNGM1YWJhZDU3MjE4NjE2N2JjOTFjYWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2782f8b157fc0c1fe4c5abad572186167bc91caa",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/2782f8b157fc0c1fe4c5abad572186167bc91caa",
      "tree": {
        "sha": "095339d0470c6cebd89700267e739c278b891eb4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/095339d0470c6cebd89700267e739c278b891eb4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ed0112d309f7650a105c9bf027495e5ac77f4daf",
          "sha": "ed0112d309f7650a105c9bf027495e5ac77f4daf",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ed0112d309f7650a105c9bf027495e5ac77f4daf"
        }
      ],
      "message": "[txdownload] remove unique_parents that we already have\n\nThis means we no longer return parents we already have in the\nm_unique_parents result from MempoolRejectedTx.\n\nWe need to separate the loop that checks AlreadyHave parents from the\nloop that adds parents as announcements, because we may do the latter\nloop multiple times for different peers.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-11-28T11:43:08Z"
      },
      "sha": "2782f8b157fc0c1fe4c5abad572186167bc91caa"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFjYzllMGZkYTlkODEzNmJjMzZhMjQ3MDA5Njc2ZjA3ZDVkODRmYjY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cc9e0fda9d8136bc36a247009676f07d5d84fb6",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1cc9e0fda9d8136bc36a247009676f07d5d84fb6",
      "tree": {
        "sha": "995a97aa0915e4430c09d71859b2d37539749ffd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/995a97aa0915e4430c09d71859b2d37539749ffd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2782f8b157fc0c1fe4c5abad572186167bc91caa",
          "sha": "2782f8b157fc0c1fe4c5abad572186167bc91caa",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2782f8b157fc0c1fe4c5abad572186167bc91caa"
        }
      ],
      "message": "[p2p] try multiple peers for orphan resolution\n\nCo-authored-by: dergoegge <n.goeggi@gmail.com>",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-07-26T14:02:02Z"
      },
      "sha": "1cc9e0fda9d8136bc36a247009676f07d5d84fb6"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI4NmRjYjAxY2Y0MmMxNDE0MzU5ZjRhMGZlZThiOTdkYjhlYzdiY2Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd",
      "tree": {
        "sha": "5779c554f330e27f6b5e615362418544289829c4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5779c554f330e27f6b5e615362418544289829c4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cc9e0fda9d8136bc36a247009676f07d5d84fb6",
          "sha": "1cc9e0fda9d8136bc36a247009676f07d5d84fb6",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1cc9e0fda9d8136bc36a247009676f07d5d84fb6"
        }
      ],
      "message": "[functional test] orphan handling with multiple announcers",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-07-26T15:34:55Z"
      },
      "sha": "b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc0MTI0MDIwZmU5NmUxODQ3MjU3MzVhODJjMWJmMzY4YTAwYTBkMjY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/74124020fe96e184725735a82c1bf368a00a0d26",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/74124020fe96e184725735a82c1bf368a00a0d26",
      "tree": {
        "sha": "65ab164c034dddd360d6c59f916c1aafa51cd3e4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/65ab164c034dddd360d6c59f916c1aafa51cd3e4"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd",
          "sha": "b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b86dcb01cf42c1414359f4a0fee8b97db8ec7bcd"
        }
      ],
      "message": "[cleanup] remove p2p_inv from AddTxAnnouncement\n\nThis param is no longer needed since orphan parent requests are added to\nthe TxRequestTracker directly.",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:02:14Z"
      },
      "sha": "74124020fe96e184725735a82c1bf368a00a0d26"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGY5NmRmM2Q2MGE5NDNiODdlZWNkM2E2OTE1ZmNhY2UwZWVlMjgzOGY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "tree": {
        "sha": "d9d76e116da19ab8cb19a0f837b820d9e6645a7b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d9d76e116da19ab8cb19a0f837b820d9e6645a7b"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/74124020fe96e184725735a82c1bf368a00a0d26",
          "sha": "74124020fe96e184725735a82c1bf368a00a0d26",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/74124020fe96e184725735a82c1bf368a00a0d26"
        }
      ],
      "message": "[p2p] only attempt 1p1c when both txns provided by the same peer\n\nNow that we track all announcers of an orphan, it's not helpful to\nconsider an orphan provided by a peer that didn't send us this parent.\nIt can only hurt our chances of finding the right orphan when there are\nmultiple candidates.\n\nAdapt the 2 tests in p2p_opportunistic_1p1c.py that looked at 1p1c\npackages from different peers. Instead of checking that the right peer\nis punished, we now check that the package is not submitted. We can't\nuse the functional test to see that the package was not considered\nbecause the behavior is indistinguishable (except for the logs).",
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-12-06T12:25:37Z"
      },
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2024-08-20T10:39:18Z"
      },
      "sha": "f96df3d60a943b87eecd3a6915fcace0eee2838f"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15559661377,
      "node_id": "HRFPE_lADOABII586haVlzzwAAAAOfbZdB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15559661377",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-06T12:27:26Z"
    },
    {
      "event": "reviewed",
      "id": 2484617926,
      "node_id": "PRR_kwDOABII586UGELG",
      "url": null,
      "actor": null,
      "commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Changed to the new approach, cleaned up a bunch of things, addressed most comments. I think I have 1 or 2 more to get to, and need to write an RPC test.",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#pullrequestreview-2484617926",
      "submitted_at": "2024-12-06T12:27:28Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
    },
    {
      "event": "commented",
      "id": 2523122642,
      "node_id": "IC_kwDOABII586WY8vS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2523122642",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-06T12:33:58Z",
      "updated_at": "2024-12-06T12:33:58Z",
      "author_association": "MEMBER",
      "body": "The 2 main functional differences I noticed with this approach are\r\n(1) If there are multiple missing parents, we may be using different peers to request them.\r\n(2) We don't `EraseOrphanOfPeer` if orphan resolution expires. This also means we don't delete the orphan after we've exhausted all potential orphan resolution candidates. This is similar to what we have today - it'll stay for 20min before orphanage expires the entry.",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#issuecomment-2523122642",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31397"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865732564",
      "pull_request_review_id": 2472515530,
      "id": 1865732564,
      "node_id": "PRRC_kwDOABII585vNNHU",
      "diff_hunk": "@@ -12,12 +12,20 @@\n \n #include <cassert>\n \n-bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer, const std::vector<Txid>& parent_txids)\n {\n     const Txid& hash = tx->GetHash();\n     const Wtxid& wtxid = tx->GetWitnessHash();\n-    if (m_orphans.count(wtxid))\n+    auto it = m_orphans.find(wtxid);\n+    if (it != m_orphans.end()) {\n+        Assume(!it->second.announcers.empty());\n+        const auto ret = it->second.announcers.insert(peer);\n+        if (ret.second) {\n+            LogDebug(BCLog::TXPACKAGES, \"added peer=%d as announcer of orphan tx %s\\n\", peer, wtxid.ToString());\n+        }",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n    if (auto it{m_orphans.find(wtxid)}; it != m_orphans.end()) {\r\n        AddAnnouncer(wtxid, peer);\r\n```\r\n\r\nDuplicating the map lookup is better than duplicating the code imo.",
      "created_at": "2024-12-02T12:04:08Z",
      "updated_at": "2024-12-05T11:25:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1865732564",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1865732564"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866088979",
      "pull_request_review_id": 2473080499,
      "id": 1866088979,
      "node_id": "PRRC_kwDOABII585vOkIT",
      "diff_hunk": "@@ -239,20 +239,15 @@ def test_orphan_consensus_failure(self):\n         parent_txid_int = int(low_fee_parent[\"txid\"], 16)\n         bad_orphan_sender.wait_for_getdata([parent_txid_int])\n \n-        # 3. A different peer relays the parent. Parent+Child are evaluated as a package and rejected.\n-        parent_sender.send_message(msg_tx(low_fee_parent[\"tx\"]))\n+        # 3. A different peer relays the parent. Packages is not evaluated because the transactions\n+        # were not sent from the same peer.\n+        parent_sender.send_and_ping(msg_tx(low_fee_parent[\"tx\"]))\n \n         # 4. Transactions should not be in mempool.\n         node_mempool = node.getrawmempool()\n         assert low_fee_parent[\"txid\"] not in node_mempool\n         assert tx_orphan_bad_wit.rehash() not in node_mempool\n \n-        # 5. Peer that sent a consensus-invalid transaction should be disconnected.\n-        bad_orphan_sender.wait_for_disconnect()",
      "path": "test/functional/p2p_opportunistic_1p1c.py",
      "position": 27,
      "original_position": 25,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we should cause the disconnect still to make sure we're disconnecting on consensus failure",
      "created_at": "2024-12-02T15:45:56Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1866088979",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866088979"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 251,
      "original_line": 251,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866111901",
      "pull_request_review_id": 2473080499,
      "id": 1866111901,
      "node_id": "PRRC_kwDOABII585vOpud",
      "diff_hunk": "@@ -279,20 +274,17 @@ def test_parent_consensus_failure(self):\n         package_sender.wait_for_getdata([parent_txid_int])\n \n         # 3. A different node relays the parent. The parent is first evaluated by itself and\n-        # rejected for being too low feerate. Then it is evaluated as a package and, after passing\n-        # feerate checks, rejected for having a bad signature (consensus error).\n-        fake_parent_sender.send_message(msg_tx(tx_parent_bad_wit))\n+        # rejected for being too low feerate. It is not evaluated as a package because the child was\n+        # sent from a different peer, so we don't find out that the child is consensus-invalid.\n+        fake_parent_sender.send_and_ping(msg_tx(tx_parent_bad_wit))\n \n         # 4. Transactions should not be in mempool.\n         node_mempool = node.getrawmempool()\n         assert tx_parent_bad_wit.rehash() not in node_mempool\n         assert high_fee_child[\"txid\"] not in node_mempool\n \n-        # 5. Peer sent a consensus-invalid transaction.\n-        fake_parent_sender.wait_for_disconnect()\n-\n         self.log.info(\"Check that fake parent does not cause orphan to be deleted and real package can still be submitted\")\n-        # 6. Child-sending should not have been punished and the orphan should remain in orphanage.\n+        # 5. Child-sending should not have been punished and the orphan should remain in orphanage.",
      "path": "test/functional/p2p_opportunistic_1p1c.py",
      "position": 51,
      "original_position": 54,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "while we're touching this, we can directly assert via getorphantxs now",
      "created_at": "2024-12-02T15:58:56Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1866111901",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866111901"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 294,
      "original_line": 294,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866113157",
      "pull_request_review_id": 2473080499,
      "id": 1866113157,
      "node_id": "PRRC_kwDOABII585vOqCF",
      "diff_hunk": "@@ -356,34 +358,6 @@ std::optional<PackageToValidate> TxDownloadManagerImpl::Find1P1CPackage(const CT\n             return PackageToValidate{ptx, child, nodeid, nodeid};\n         }\n     }\n-\n-    // If no suitable candidate from the same peer is found, also try children that were provided by",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 113,
      "original_position": 19,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "3e16a36959f70da59846621f099c1f1df4a210ed love this cleanup of logic :)",
      "created_at": "2024-12-02T15:59:40Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1866113157",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1866113157"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 262,
      "original_line": 262,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868058869",
      "pull_request_review_id": 2473080499,
      "id": 1868058869,
      "node_id": "PRRC_kwDOABII585vWFD1",
      "diff_hunk": "@@ -308,7 +308,7 @@ node::RejectedTxTodo TxDownloadManagerImpl::MempoolRejectedTx(const CTransaction\n     // Whether we should call AddToCompactExtraTransactions at the end\n     bool add_extra_compact_tx{first_time_failure};\n     // Hashes to pass to AddKnownTx later\n-    std::vector<uint256> unique_parents;\n+    std::vector<Txid> unique_parents;",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 148,
      "original_position": 5,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "938659fbd8304ccc948e04d797a4a9d8cf669d3e",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: could also adapt the for loop over `unique_parents` in `ProcessInvalidTx`",
      "created_at": "2024-12-03T16:40:09Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868058869",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868058869"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 336,
      "original_line": 336,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868116284",
      "pull_request_review_id": 2473080499,
      "id": 1868116284,
      "node_id": "PRRC_kwDOABII585vWTE8",
      "diff_hunk": "@@ -84,6 +89,8 @@ class TxOrphanage {\n protected:\n     struct OrphanTx : public OrphanTxBase {\n         size_t list_pos;\n+        /** Txids of the missing parents to request. Determined by peerman. */",
      "path": "src/txorphanage.h",
      "position": 59,
      "original_position": 27,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "7badc7e004e288aef645404b1b09699be8b87d1e",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "as of introduction commit 7badc7e004e288aef645404b1b09699be8b87d1e this is storing all parent txids, missing or not. ",
      "created_at": "2024-12-03T17:17:28Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868116284",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868116284"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 96,
      "original_line": 96,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868119567",
      "pull_request_review_id": 2473080499,
      "id": 1868119567,
      "node_id": "PRRC_kwDOABII585vWT4P",
      "diff_hunk": "@@ -135,7 +135,7 @@ BOOST_AUTO_TEST_CASE(DoS_mapOrphans)\n         tx.vout[0].nValue = 1*CENT;\n         tx.vout[0].scriptPubKey = GetScriptForDestination(PKHash(key.GetPubKey()));\n \n-        orphanage.AddTx(MakeTransactionRef(tx), i);\n+        orphanage.AddTx(MakeTransactionRef(tx), i, {});",
      "path": "src/test/orphanage_tests.cpp",
      "position": 25,
      "original_position": 5,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "7badc7e004e288aef645404b1b09699be8b87d1e",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "7badc7e004e288aef645404b1b09699be8b87d1e In this test and the fuzz harness, I'm not sure I'm happy with this new field sometimes being populated and sometimes not.\r\n\r\nCould you make a test util that automatically fills in this argument properly via just looking at the tx inputs?",
      "created_at": "2024-12-03T17:19:52Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868119567",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868119567"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 129,
      "original_line": 129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868130046",
      "pull_request_review_id": 2473080499,
      "id": 1868130046,
      "node_id": "PRRC_kwDOABII585vWWb-",
      "diff_hunk": "@@ -152,6 +183,12 @@ bool TxOrphanage::HaveTx(const Wtxid& wtxid) const\n     return m_orphans.count(wtxid);\n }\n \n+bool TxOrphanage::HaveTxAndPeer(const Wtxid& wtxid, NodeId peer) const",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`s/HaveTxAndPeer/HaveTxFromPeer/` or similar?",
      "created_at": "2024-12-03T17:26:36Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868130046",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868130046"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868133288",
      "pull_request_review_id": 2473080499,
      "id": 1868133288,
      "node_id": "PRRC_kwDOABII585vWXOo",
      "diff_hunk": "@@ -80,7 +90,8 @@ class TxOrphanage {\n     /** Allows providing orphan information externally */\n     struct OrphanTxBase {\n         CTransactionRef tx;\n-        NodeId fromPeer;\n+        /** Peers added with AddTx or AddAnnouncer. */",
      "path": "src/txorphanage.h",
      "position": 50,
      "original_position": 41,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "noting as of acaa7c13fac3e35a55daf2c62c27ab85172b4964 `AddAnnouncer` isnt called\r\n\r\n~3~ 2 cases?\r\n\r\n1. announced as INV (AddAnnouncer @ c04d1a876cdbcd159c53dde55d57a55675c41f38)\r\n~2. parent of another orphan given (?)~ because txid, not wtxid\r\n3. given directly (AddTx on all tracked advertisements of it too)",
      "created_at": "2024-12-03T17:28:18Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868133288",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868133288"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 86,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868152050",
      "pull_request_review_id": 2473080499,
      "id": 1868152050,
      "node_id": "PRRC_kwDOABII585vWbzy",
      "diff_hunk": "@@ -16,8 +16,16 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer, const std::vecto\n {\n     const Txid& hash = tx->GetHash();\n     const Wtxid& wtxid = tx->GetWitnessHash();\n-    if (m_orphans.count(wtxid))\n+    auto it = m_orphans.find(wtxid);\n+    if (it != m_orphans.end()) {\n+        Assume(!it->second.announcers.empty());\n+        const auto ret = it->second.announcers.insert(peer);\n+        if (ret.second) {\n+            LogDebug(BCLog::TXPACKAGES, \"added peer=%d as announcer of orphan tx %s\\n\", peer, wtxid.ToString());\n+        }\n+        // Even if an announcer was added, no new orphan entry was created.",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```Suggestion\r\n        // Since an additional announcer was added, no new orphan entry was created.\r\n```",
      "created_at": "2024-12-03T17:40:34Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868152050",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868152050"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868163720",
      "pull_request_review_id": 2473080499,
      "id": 1868163720,
      "node_id": "PRRC_kwDOABII585vWeqI",
      "diff_hunk": "@@ -124,36 +124,41 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan transaction(s) from peer=%d\\n\", nErased, peer);\n }\n \n-void TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n+std::vector<Wtxid> TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n {\n+    std::vector<Wtxid> erased_and_evicted;\n     unsigned int nEvicted = 0;\n     auto nNow{Now<NodeSeconds>()};\n     if (m_next_sweep <= nNow) {\n         // Sweep out expired orphan pool entries:\n-        int nErased = 0;\n         auto nMinExpTime{nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL};\n         std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n         while (iter != m_orphans.end())\n         {\n             std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++;\n             if (maybeErase->second.nTimeExpire <= nNow) {\n-                nErased += EraseTx(maybeErase->second.tx->GetWitnessHash());\n+                const auto& wtxid = maybeErase->second.tx->GetWitnessHash();",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "83d276c7dd789ab7cf332a4ebbc7ed215340de8c",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "isn't MaybeErase.first the wtxid?",
      "created_at": "2024-12-03T17:48:43Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868163720",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868163720"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868164820",
      "pull_request_review_id": 2473080499,
      "id": 1868164820,
      "node_id": "PRRC_kwDOABII585vWe7U",
      "diff_hunk": "@@ -124,36 +124,41 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan transaction(s) from peer=%d\\n\", nErased, peer);\n }\n \n-void TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n+std::vector<Wtxid> TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n {\n+    std::vector<Wtxid> erased_and_evicted;\n     unsigned int nEvicted = 0;\n     auto nNow{Now<NodeSeconds>()};\n     if (m_next_sweep <= nNow) {\n         // Sweep out expired orphan pool entries:\n-        int nErased = 0;\n         auto nMinExpTime{nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL};\n         std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n         while (iter != m_orphans.end())\n         {\n             std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++;\n             if (maybeErase->second.nTimeExpire <= nNow) {\n-                nErased += EraseTx(maybeErase->second.tx->GetWitnessHash());\n+                const auto& wtxid = maybeErase->second.tx->GetWitnessHash();\n+                erased_and_evicted.emplace_back(wtxid);\n+                EraseTx(wtxid);\n             } else {\n                 nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n             }\n         }\n         // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n         m_next_sweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n-        if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+        if (!erased_and_evicted.empty()) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", erased_and_evicted.size());\n     }\n     while (m_orphans.size() > max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->second.tx->GetWitnessHash());\n+        const auto& wtxid = m_orphan_list[randompos]->second.tx->GetWitnessHash();",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "83d276c7dd789ab7cf332a4ebbc7ed215340de8c",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "not much shorter but `m_orphan_list[randompos]->first` is wtxid?",
      "created_at": "2024-12-03T17:49:37Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868164820",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868164820"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868195381",
      "pull_request_review_id": 2473080499,
      "id": 1868195381,
      "node_id": "PRRC_kwDOABII585vWmY1",
      "diff_hunk": "@@ -348,6 +348,12 @@ node::RejectedTxTodo TxDownloadManagerImpl::MempoolRejectedTx(const CTransaction\n                 }\n             }\n             if (!fRejectedParents) {",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 155,
      "original_position": 3,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "b64be9ed2ce9b68aef178684dac3be998f18bbdd",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "commit message b64be9ed2ce9b68aef178684dac3be998f18bbdd\r\n\r\n\"announcments,\"",
      "created_at": "2024-12-03T18:14:37Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868195381",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868195381"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 375,
      "original_line": 375,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868211986",
      "pull_request_review_id": 2473080499,
      "id": 1868211986,
      "node_id": "PRRC_kwDOABII585vWqcS",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "as of c04d1a876cdbcd159c53dde55d57a55675c41f38 `p2p_inv=false` has no usage aside from fuzz harness",
      "created_at": "2024-12-03T18:29:06Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868211986",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868211986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 181,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868238484",
      "pull_request_review_id": 2473080499,
      "id": 1868238484,
      "node_id": "PRRC_kwDOABII585vWw6U",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)\n {\n+    // If this is an inv received from a peer but it's an orphan we are trying to resolve, instead\n+    // of adding it to m_txrequest, remember this peer as a potential orphan resolution candidate.\n+    if (p2p_inv && m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) {\n+        // m_orphan_resolution_tracker only tracks wtxids\n+        if (gtxid.IsWtxid()) {\n+            if (auto delay{OrphanResolutionCandidate(peer, Wtxid::FromUint256(gtxid.GetHash()))}) {\n+                const auto& info = m_peer_info.at(peer).m_connection_info;\n+                m_orphanage.AddAnnouncer(Wtxid::FromUint256(gtxid.GetHash()), peer);\n+                m_orphan_resolution_tracker.ReceivedInv(peer, GenTxid::Wtxid(gtxid.GetHash()), info.m_preferred, now + *delay);\n+                LogDebug(BCLog::TXPACKAGES, \"added peer=%d as a candidate for resolving orphan %s\\n\", peer, gtxid.GetHash().ToString());\n+            }\n+        }\n+        return true;\n+    }\n+\n+    const bool already_had{AlreadyHaveTx(gtxid, /*include_reconsiderable=*/true)};\n+\n     // If this is an inv received from a peer and we already have it, we can drop it.\n     // If this is a request for the parent of an orphan, we don't drop transactions that we already have. In particular,\n     // we *do* want to request parents that are in m_lazy_recent_rejects_reconsiderable, since they can be CPFP'd.",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 45,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "these comments seem outdated since AddTxAnnouncement is only being called for explicit INV related reasons now",
      "created_at": "2024-12-03T18:52:14Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868238484",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868238484"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 202,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868239989",
      "pull_request_review_id": 2473080499,
      "id": 1868239989,
      "node_id": "PRRC_kwDOABII585vWxR1",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)\n {\n+    // If this is an inv received from a peer but it's an orphan we are trying to resolve, instead\n+    // of adding it to m_txrequest, remember this peer as a potential orphan resolution candidate.\n+    if (p2p_inv && m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) {\n+        // m_orphan_resolution_tracker only tracks wtxids\n+        if (gtxid.IsWtxid()) {\n+            if (auto delay{OrphanResolutionCandidate(peer, Wtxid::FromUint256(gtxid.GetHash()))}) {\n+                const auto& info = m_peer_info.at(peer).m_connection_info;\n+                m_orphanage.AddAnnouncer(Wtxid::FromUint256(gtxid.GetHash()), peer);\n+                m_orphan_resolution_tracker.ReceivedInv(peer, GenTxid::Wtxid(gtxid.GetHash()), info.m_preferred, now + *delay);\n+                LogDebug(BCLog::TXPACKAGES, \"added peer=%d as a candidate for resolving orphan %s\\n\", peer, gtxid.GetHash().ToString());\n+            }\n+        }\n+        return true;\n+    }\n+\n+    const bool already_had{AlreadyHaveTx(gtxid, /*include_reconsiderable=*/true)};",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 41,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`already_had` used exactly once, seems like we don't need it",
      "created_at": "2024-12-03T18:53:38Z",
      "updated_at": "2024-12-05T13:34:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1868239989",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868239989"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 198,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1869654727",
      "pull_request_review_id": 2478886117,
      "id": 1869654727,
      "node_id": "PRRC_kwDOABII585vcKrH",
      "diff_hunk": "@@ -204,8 +227,83 @@ bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid,\n     return false;\n }\n \n+std::optional<std::chrono::seconds> TxDownloadManagerImpl::OrphanResolutionCandidate(NodeId nodeid, const Wtxid& orphan_wtxid)\n+{\n+    if (m_peer_info.count(nodeid) == 0) return std::nullopt;\n+\n+    const auto& peer_entry = m_peer_info.at(nodeid);\n+    const auto& info = peer_entry.m_connection_info;\n+    // TODO: add delays and limits based on the amount of orphan resolution we are already doing\n+    // with this peer, how much they are using the orphanage, etc.\n+    if (!info.m_relay_permissions) {\n+        // This mirrors the delaying and dropping behavior in AddTxAnnouncement in order to preserve\n+        // existing behavior: drop if we are tracking too many invs for this peer already. Each\n+        // orphan resolution involves at least 1 transaction request which may or may not be\n+        // currently tracked in m_txrequest, so we include that in the count.\n+        if (m_txrequest.Count(nodeid) + m_orphan_resolution_tracker.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) return std::nullopt;",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 68,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ah, need to add the size of `unique_parents` to this. Surprised fuzzer has not tripped on it...",
      "created_at": "2024-12-04T14:34:41Z",
      "updated_at": "2024-12-04T14:34:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1869654727",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1869654727"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 243,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1871051453",
      "pull_request_review_id": 2472515530,
      "id": 1871051453,
      "node_id": "PRRC_kwDOABII585vhfq9",
      "diff_hunk": "@@ -624,6 +625,74 @@ def test_max_orphan_amount(self):\n             peer_1.send_and_ping(msg_tx(parent_orphan))\n         assert_equal(len(node.getorphantxs()),0)\n \n+    @cleanup\n+    def test_orphan_handling_prefer_outbound(self):\n+        self.log.info(\"Test that the node prefers requesting from outbound peers\")\n+        node = self.nodes[0]\n+        orphan_wtxid, orphan_tx, parent_tx = self.create_parent_and_child()\n+        orphan_inv = CInv(t=MSG_WTX, h=int(orphan_wtxid, 16))\n+\n+        peer_inbound = node.add_p2p_connection(PeerTxRelayer())\n+        peer_outbound = node.add_outbound_p2p_connection(PeerTxRelayer(), p2p_idx=1)\n+\n+        # Inbound peer relays the transaction.\n+        peer_inbound.send_and_ping(msg_inv([orphan_inv]))\n+        self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n+        peer_inbound.wait_for_getdata([int(orphan_wtxid, 16)])\n+\n+        # Both peers send invs for the orphan, so the node can expect both to know its ancestors.\n+        peer_outbound.send_and_ping(msg_inv([orphan_inv]))\n+\n+        # The outbound peer should be preferred for getting orphan parents\n+        peer_inbound.send_and_ping(msg_tx(orphan_tx))\n+        self.nodes[0].bumpmocktime(TXID_RELAY_DELAY)\n+        peer_outbound.wait_for_parent_requests([int(parent_tx.rehash(), 16)])\n+\n+        # There should be no request to the inbound peer\n+        peer_inbound.assert_never_requested(int(parent_tx.rehash(), 16))\n+\n+        self.log.info(\"Test that, if the preferred peer doesn't respond, the node sends another request\")\n+        self.nodes[0].bumpmocktime(ORPHAN_ANCESTOR_GETDATA_INTERVAL)\n+        peer_inbound.sync_with_ping()\n+        peer_inbound.wait_for_parent_requests([int(parent_tx.rehash(), 16)])\n+\n+    @cleanup\n+    def test_announcers_before_and_after(self):\n+        self.log.info(\"Test that the node uses all peers who announced the tx prior to realizing it's an orphan\")\n+        node = self.nodes[0]\n+        orphan_wtxid, orphan_tx, parent_tx = self.create_parent_and_child()\n+        orphan_inv = CInv(t=MSG_WTX, h=int(orphan_wtxid, 16))\n+\n+        # Announces before tx is sent, disconnects while node is requesting parents\n+        peer_early_disconnected = node.add_outbound_p2p_connection(PeerTxRelayer(), p2p_idx=3)\n+        # Announces before tx is sent, doesn't respond to parent request\n+        peer_early_unresponsive = node.add_p2p_connection(PeerTxRelayer())\n+\n+        # Announces after tx is sent\n+        peer_late_announcer = node.add_p2p_connection(PeerTxRelayer())\n+\n+        # Both peers send invs for the orphan, so the node an expect both to know its ancestors.",
      "path": "test/functional/p2p_orphan_handling.py",
      "position": null,
      "original_position": 58,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n        # Both peers send invs for the orphan, so the node can expect both to know its ancestors.\r\n```",
      "created_at": "2024-12-05T10:06:40Z",
      "updated_at": "2024-12-05T11:25:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1871051453",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1871051453"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 674,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873201629",
      "pull_request_review_id": 2484617926,
      "id": 1873201629,
      "node_id": "PRRC_kwDOABII585vpsnd",
      "diff_hunk": "@@ -356,34 +358,6 @@ std::optional<PackageToValidate> TxDownloadManagerImpl::Find1P1CPackage(const CT\n             return PackageToValidate{ptx, child, nodeid, nodeid};\n         }\n     }\n-\n-    // If no suitable candidate from the same peer is found, also try children that were provided by",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 113,
      "original_position": 19,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": 1866113157,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "That's why I made them separate functions! Easy deletion.",
      "created_at": "2024-12-06T11:55:10Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873201629",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873201629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 262,
      "original_line": 262,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873212631",
      "pull_request_review_id": 2484617926,
      "id": 1873212631,
      "node_id": "PRRC_kwDOABII585vpvTX",
      "diff_hunk": "@@ -348,6 +348,12 @@ node::RejectedTxTodo TxDownloadManagerImpl::MempoolRejectedTx(const CTransaction\n                 }\n             }\n             if (!fRejectedParents) {",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 155,
      "original_position": 3,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "b64be9ed2ce9b68aef178684dac3be998f18bbdd",
      "in_reply_to_id": 1868195381,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "fixed",
      "created_at": "2024-12-06T11:57:23Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873212631",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873212631"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 375,
      "original_line": 375,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873213296",
      "pull_request_review_id": 2484617926,
      "id": 1873213296,
      "node_id": "PRRC_kwDOABII585vpvdw",
      "diff_hunk": "@@ -204,8 +227,83 @@ bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid,\n     return false;\n }\n \n+std::optional<std::chrono::seconds> TxDownloadManagerImpl::OrphanResolutionCandidate(NodeId nodeid, const Wtxid& orphan_wtxid)\n+{\n+    if (m_peer_info.count(nodeid) == 0) return std::nullopt;\n+\n+    const auto& peer_entry = m_peer_info.at(nodeid);\n+    const auto& info = peer_entry.m_connection_info;\n+    // TODO: add delays and limits based on the amount of orphan resolution we are already doing\n+    // with this peer, how much they are using the orphanage, etc.\n+    if (!info.m_relay_permissions) {\n+        // This mirrors the delaying and dropping behavior in AddTxAnnouncement in order to preserve\n+        // existing behavior: drop if we are tracking too many invs for this peer already. Each\n+        // orphan resolution involves at least 1 transaction request which may or may not be\n+        // currently tracked in m_txrequest, so we include that in the count.\n+        if (m_txrequest.Count(nodeid) + m_orphan_resolution_tracker.Count(nodeid) >= MAX_PEER_TX_ANNOUNCEMENTS) return std::nullopt;",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 68,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": 1869654727,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "deleted, no longer applicable",
      "created_at": "2024-12-06T11:57:34Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873213296",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873213296"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 243,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873231864",
      "pull_request_review_id": 2484617926,
      "id": 1873231864,
      "node_id": "PRRC_kwDOABII585vpz_4",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": 1868211986,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "added a commit to clean this up",
      "created_at": "2024-12-06T12:01:14Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873231864",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873231864"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 181,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873231985",
      "pull_request_review_id": 2484617926,
      "id": 1873231985,
      "node_id": "PRRC_kwDOABII585vp0Bx",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)\n {\n+    // If this is an inv received from a peer but it's an orphan we are trying to resolve, instead\n+    // of adding it to m_txrequest, remember this peer as a potential orphan resolution candidate.\n+    if (p2p_inv && m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) {\n+        // m_orphan_resolution_tracker only tracks wtxids\n+        if (gtxid.IsWtxid()) {\n+            if (auto delay{OrphanResolutionCandidate(peer, Wtxid::FromUint256(gtxid.GetHash()))}) {\n+                const auto& info = m_peer_info.at(peer).m_connection_info;\n+                m_orphanage.AddAnnouncer(Wtxid::FromUint256(gtxid.GetHash()), peer);\n+                m_orphan_resolution_tracker.ReceivedInv(peer, GenTxid::Wtxid(gtxid.GetHash()), info.m_preferred, now + *delay);\n+                LogDebug(BCLog::TXPACKAGES, \"added peer=%d as a candidate for resolving orphan %s\\n\", peer, gtxid.GetHash().ToString());\n+            }\n+        }\n+        return true;\n+    }\n+\n+    const bool already_had{AlreadyHaveTx(gtxid, /*include_reconsiderable=*/true)};",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 41,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": 1868239989,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "cleaned up",
      "created_at": "2024-12-06T12:01:19Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873231985",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873231985"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 198,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873232108",
      "pull_request_review_id": 2484617926,
      "id": 1873232108,
      "node_id": "PRRC_kwDOABII585vp0Ds",
      "diff_hunk": "@@ -174,10 +180,27 @@ void TxDownloadManagerImpl::DisconnectedPeer(NodeId nodeid)\n \n bool TxDownloadManagerImpl::AddTxAnnouncement(NodeId peer, const GenTxid& gtxid, std::chrono::microseconds now, bool p2p_inv)\n {\n+    // If this is an inv received from a peer but it's an orphan we are trying to resolve, instead\n+    // of adding it to m_txrequest, remember this peer as a potential orphan resolution candidate.\n+    if (p2p_inv && m_orphanage.HaveTx(Wtxid::FromUint256(gtxid.GetHash()))) {\n+        // m_orphan_resolution_tracker only tracks wtxids\n+        if (gtxid.IsWtxid()) {\n+            if (auto delay{OrphanResolutionCandidate(peer, Wtxid::FromUint256(gtxid.GetHash()))}) {\n+                const auto& info = m_peer_info.at(peer).m_connection_info;\n+                m_orphanage.AddAnnouncer(Wtxid::FromUint256(gtxid.GetHash()), peer);\n+                m_orphan_resolution_tracker.ReceivedInv(peer, GenTxid::Wtxid(gtxid.GetHash()), info.m_preferred, now + *delay);\n+                LogDebug(BCLog::TXPACKAGES, \"added peer=%d as a candidate for resolving orphan %s\\n\", peer, gtxid.GetHash().ToString());\n+            }\n+        }\n+        return true;\n+    }\n+\n+    const bool already_had{AlreadyHaveTx(gtxid, /*include_reconsiderable=*/true)};\n+\n     // If this is an inv received from a peer and we already have it, we can drop it.\n     // If this is a request for the parent of an orphan, we don't drop transactions that we already have. In particular,\n     // we *do* want to request parents that are in m_lazy_recent_rejects_reconsiderable, since they can be CPFP'd.",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": null,
      "original_position": 45,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "c04d1a876cdbcd159c53dde55d57a55675c41f38",
      "in_reply_to_id": 1868238484,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "cleaned up",
      "created_at": "2024-12-06T12:01:25Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873232108",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873232108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 202,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873232567",
      "pull_request_review_id": 2484617926,
      "id": 1873232567,
      "node_id": "PRRC_kwDOABII585vp0K3",
      "diff_hunk": "@@ -12,12 +12,20 @@\n \n #include <cassert>\n \n-bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer)\n+bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer, const std::vector<Txid>& parent_txids)\n {\n     const Txid& hash = tx->GetHash();\n     const Wtxid& wtxid = tx->GetWitnessHash();\n-    if (m_orphans.count(wtxid))\n+    auto it = m_orphans.find(wtxid);\n+    if (it != m_orphans.end()) {\n+        Assume(!it->second.announcers.empty());\n+        const auto ret = it->second.announcers.insert(peer);\n+        if (ret.second) {\n+            LogDebug(BCLog::TXPACKAGES, \"added peer=%d as announcer of orphan tx %s\\n\", peer, wtxid.ToString());\n+        }",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": 1865732564,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "largely agree, done",
      "created_at": "2024-12-06T12:01:43Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873232567",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873232567"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": 19,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873236208",
      "pull_request_review_id": 2484617926,
      "id": 1873236208,
      "node_id": "PRRC_kwDOABII585vp1Dw",
      "diff_hunk": "@@ -16,8 +16,16 @@ bool TxOrphanage::AddTx(const CTransactionRef& tx, NodeId peer, const std::vecto\n {\n     const Txid& hash = tx->GetHash();\n     const Wtxid& wtxid = tx->GetWitnessHash();\n-    if (m_orphans.count(wtxid))\n+    auto it = m_orphans.find(wtxid);\n+    if (it != m_orphans.end()) {\n+        Assume(!it->second.announcers.empty());\n+        const auto ret = it->second.announcers.insert(peer);\n+        if (ret.second) {\n+            LogDebug(BCLog::TXPACKAGES, \"added peer=%d as announcer of orphan tx %s\\n\", peer, wtxid.ToString());\n+        }\n+        // Even if an announcer was added, no new orphan entry was created.",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 12,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": 1868152050,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We haven't necessarily added an announcer. But I updated this comment.",
      "created_at": "2024-12-06T12:05:04Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873236208",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873236208"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873237320",
      "pull_request_review_id": 2484617926,
      "id": 1873237320,
      "node_id": "PRRC_kwDOABII585vp1VI",
      "diff_hunk": "@@ -124,36 +124,41 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan transaction(s) from peer=%d\\n\", nErased, peer);\n }\n \n-void TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n+std::vector<Wtxid> TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n {\n+    std::vector<Wtxid> erased_and_evicted;\n     unsigned int nEvicted = 0;\n     auto nNow{Now<NodeSeconds>()};\n     if (m_next_sweep <= nNow) {\n         // Sweep out expired orphan pool entries:\n-        int nErased = 0;\n         auto nMinExpTime{nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL};\n         std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n         while (iter != m_orphans.end())\n         {\n             std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++;\n             if (maybeErase->second.nTimeExpire <= nNow) {\n-                nErased += EraseTx(maybeErase->second.tx->GetWitnessHash());\n+                const auto& wtxid = maybeErase->second.tx->GetWitnessHash();",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "83d276c7dd789ab7cf332a4ebbc7ed215340de8c",
      "in_reply_to_id": 1868163720,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "switched",
      "created_at": "2024-12-06T12:06:18Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873237320",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873237320"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873237986",
      "pull_request_review_id": 2484617926,
      "id": 1873237986,
      "node_id": "PRRC_kwDOABII585vp1fi",
      "diff_hunk": "@@ -124,36 +124,41 @@ void TxOrphanage::EraseForPeer(NodeId peer)\n     if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan transaction(s) from peer=%d\\n\", nErased, peer);\n }\n \n-void TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n+std::vector<Wtxid> TxOrphanage::LimitOrphans(unsigned int max_orphans, FastRandomContext& rng)\n {\n+    std::vector<Wtxid> erased_and_evicted;\n     unsigned int nEvicted = 0;\n     auto nNow{Now<NodeSeconds>()};\n     if (m_next_sweep <= nNow) {\n         // Sweep out expired orphan pool entries:\n-        int nErased = 0;\n         auto nMinExpTime{nNow + ORPHAN_TX_EXPIRE_TIME - ORPHAN_TX_EXPIRE_INTERVAL};\n         std::map<Wtxid, OrphanTx>::iterator iter = m_orphans.begin();\n         while (iter != m_orphans.end())\n         {\n             std::map<Wtxid, OrphanTx>::iterator maybeErase = iter++;\n             if (maybeErase->second.nTimeExpire <= nNow) {\n-                nErased += EraseTx(maybeErase->second.tx->GetWitnessHash());\n+                const auto& wtxid = maybeErase->second.tx->GetWitnessHash();\n+                erased_and_evicted.emplace_back(wtxid);\n+                EraseTx(wtxid);\n             } else {\n                 nMinExpTime = std::min(maybeErase->second.nTimeExpire, nMinExpTime);\n             }\n         }\n         // Sweep again 5 minutes after the next entry that expires in order to batch the linear scan.\n         m_next_sweep = nMinExpTime + ORPHAN_TX_EXPIRE_INTERVAL;\n-        if (nErased > 0) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", nErased);\n+        if (!erased_and_evicted.empty()) LogDebug(BCLog::TXPACKAGES, \"Erased %d orphan tx due to expiration\\n\", erased_and_evicted.size());\n     }\n     while (m_orphans.size() > max_orphans)\n     {\n         // Evict a random orphan:\n         size_t randompos = rng.randrange(m_orphan_list.size());\n-        EraseTx(m_orphan_list[randompos]->second.tx->GetWitnessHash());\n+        const auto& wtxid = m_orphan_list[randompos]->second.tx->GetWitnessHash();",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "83d276c7dd789ab7cf332a4ebbc7ed215340de8c",
      "in_reply_to_id": 1868164820,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "done",
      "created_at": "2024-12-06T12:07:02Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873237986",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873237986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 155,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873241172",
      "pull_request_review_id": 2484617926,
      "id": 1873241172,
      "node_id": "PRRC_kwDOABII585vp2RU",
      "diff_hunk": "@@ -152,6 +183,12 @@ bool TxOrphanage::HaveTx(const Wtxid& wtxid) const\n     return m_orphans.count(wtxid);\n }\n \n+bool TxOrphanage::HaveTxAndPeer(const Wtxid& wtxid, NodeId peer) const",
      "path": "src/txorphanage.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": 1868130046,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "changed",
      "created_at": "2024-12-06T12:09:44Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873241172",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873241172"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873241932",
      "pull_request_review_id": 2484617926,
      "id": 1873241932,
      "node_id": "PRRC_kwDOABII585vp2dM",
      "diff_hunk": "@@ -239,20 +239,15 @@ def test_orphan_consensus_failure(self):\n         parent_txid_int = int(low_fee_parent[\"txid\"], 16)\n         bad_orphan_sender.wait_for_getdata([parent_txid_int])\n \n-        # 3. A different peer relays the parent. Parent+Child are evaluated as a package and rejected.\n-        parent_sender.send_message(msg_tx(low_fee_parent[\"tx\"]))\n+        # 3. A different peer relays the parent. Packages is not evaluated because the transactions\n+        # were not sent from the same peer.\n+        parent_sender.send_and_ping(msg_tx(low_fee_parent[\"tx\"]))\n \n         # 4. Transactions should not be in mempool.\n         node_mempool = node.getrawmempool()\n         assert low_fee_parent[\"txid\"] not in node_mempool\n         assert tx_orphan_bad_wit.rehash() not in node_mempool\n \n-        # 5. Peer that sent a consensus-invalid transaction should be disconnected.\n-        bad_orphan_sender.wait_for_disconnect()",
      "path": "test/functional/p2p_opportunistic_1p1c.py",
      "position": 27,
      "original_position": 25,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": 1866088979,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Good point, added a line where this sender sends the parent too",
      "created_at": "2024-12-06T12:10:27Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873241932",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873241932"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 251,
      "original_line": 251,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873252743",
      "pull_request_review_id": 2484617926,
      "id": 1873252743,
      "node_id": "PRRC_kwDOABII585vp5GH",
      "diff_hunk": "@@ -80,7 +90,8 @@ class TxOrphanage {\n     /** Allows providing orphan information externally */\n     struct OrphanTxBase {\n         CTransactionRef tx;\n-        NodeId fromPeer;\n+        /** Peers added with AddTx or AddAnnouncer. */",
      "path": "src/txorphanage.h",
      "position": 50,
      "original_position": 41,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": 1868133288,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Correct. I think this is not too misleading? Added \"unused for now\" in the commit messages.",
      "created_at": "2024-12-06T12:20:06Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873252743",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873252743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 86,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873258530",
      "pull_request_review_id": 2484617926,
      "id": 1873258530,
      "node_id": "PRRC_kwDOABII585vp6gi",
      "diff_hunk": "@@ -624,6 +625,74 @@ def test_max_orphan_amount(self):\n             peer_1.send_and_ping(msg_tx(parent_orphan))\n         assert_equal(len(node.getorphantxs()),0)\n \n+    @cleanup\n+    def test_orphan_handling_prefer_outbound(self):\n+        self.log.info(\"Test that the node prefers requesting from outbound peers\")\n+        node = self.nodes[0]\n+        orphan_wtxid, orphan_tx, parent_tx = self.create_parent_and_child()\n+        orphan_inv = CInv(t=MSG_WTX, h=int(orphan_wtxid, 16))\n+\n+        peer_inbound = node.add_p2p_connection(PeerTxRelayer())\n+        peer_outbound = node.add_outbound_p2p_connection(PeerTxRelayer(), p2p_idx=1)\n+\n+        # Inbound peer relays the transaction.\n+        peer_inbound.send_and_ping(msg_inv([orphan_inv]))\n+        self.nodes[0].bumpmocktime(TXREQUEST_TIME_SKIP)\n+        peer_inbound.wait_for_getdata([int(orphan_wtxid, 16)])\n+\n+        # Both peers send invs for the orphan, so the node can expect both to know its ancestors.\n+        peer_outbound.send_and_ping(msg_inv([orphan_inv]))\n+\n+        # The outbound peer should be preferred for getting orphan parents\n+        peer_inbound.send_and_ping(msg_tx(orphan_tx))\n+        self.nodes[0].bumpmocktime(TXID_RELAY_DELAY)\n+        peer_outbound.wait_for_parent_requests([int(parent_tx.rehash(), 16)])\n+\n+        # There should be no request to the inbound peer\n+        peer_inbound.assert_never_requested(int(parent_tx.rehash(), 16))\n+\n+        self.log.info(\"Test that, if the preferred peer doesn't respond, the node sends another request\")\n+        self.nodes[0].bumpmocktime(ORPHAN_ANCESTOR_GETDATA_INTERVAL)\n+        peer_inbound.sync_with_ping()\n+        peer_inbound.wait_for_parent_requests([int(parent_tx.rehash(), 16)])\n+\n+    @cleanup\n+    def test_announcers_before_and_after(self):\n+        self.log.info(\"Test that the node uses all peers who announced the tx prior to realizing it's an orphan\")\n+        node = self.nodes[0]\n+        orphan_wtxid, orphan_tx, parent_tx = self.create_parent_and_child()\n+        orphan_inv = CInv(t=MSG_WTX, h=int(orphan_wtxid, 16))\n+\n+        # Announces before tx is sent, disconnects while node is requesting parents\n+        peer_early_disconnected = node.add_outbound_p2p_connection(PeerTxRelayer(), p2p_idx=3)\n+        # Announces before tx is sent, doesn't respond to parent request\n+        peer_early_unresponsive = node.add_p2p_connection(PeerTxRelayer())\n+\n+        # Announces after tx is sent\n+        peer_late_announcer = node.add_p2p_connection(PeerTxRelayer())\n+\n+        # Both peers send invs for the orphan, so the node an expect both to know its ancestors.",
      "path": "test/functional/p2p_orphan_handling.py",
      "position": null,
      "original_position": 58,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "3e16a36959f70da59846621f099c1f1df4a210ed",
      "in_reply_to_id": 1871051453,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "done",
      "created_at": "2024-12-06T12:25:47Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873258530",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873258530"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 674,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873259316",
      "pull_request_review_id": 2484617926,
      "id": 1873259316,
      "node_id": "PRRC_kwDOABII585vp6s0",
      "diff_hunk": "@@ -308,7 +308,7 @@ node::RejectedTxTodo TxDownloadManagerImpl::MempoolRejectedTx(const CTransaction\n     // Whether we should call AddToCompactExtraTransactions at the end\n     bool add_extra_compact_tx{first_time_failure};\n     // Hashes to pass to AddKnownTx later\n-    std::vector<uint256> unique_parents;\n+    std::vector<Txid> unique_parents;",
      "path": "src/node/txdownloadman_impl.cpp",
      "position": 148,
      "original_position": 5,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "938659fbd8304ccc948e04d797a4a9d8cf669d3e",
      "in_reply_to_id": 1868058869,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "done",
      "created_at": "2024-12-06T12:26:29Z",
      "updated_at": "2024-12-06T12:27:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873259316",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873259316"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 336,
      "original_line": 336,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873448610",
      "pull_request_review_id": 2485021835,
      "id": 1873448610,
      "node_id": "PRRC_kwDOABII585vqo6i",
      "diff_hunk": "@@ -80,7 +90,8 @@ class TxOrphanage {\n     /** Allows providing orphan information externally */\n     struct OrphanTxBase {\n         CTransactionRef tx;\n-        NodeId fromPeer;\n+        /** Peers added with AddTx or AddAnnouncer. */",
      "path": "src/txorphanage.h",
      "position": 50,
      "original_position": 41,
      "commit_id": "f96df3d60a943b87eecd3a6915fcace0eee2838f",
      "original_commit_id": "acaa7c13fac3e35a55daf2c62c27ab85172b4964",
      "in_reply_to_id": 1868133288,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "kind of just exposing my thoughts as I review!",
      "created_at": "2024-12-06T14:42:06Z",
      "updated_at": "2024-12-06T14:42:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31397#discussion_r1873448610",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1873448610"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31397"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 86,
      "original_line": 86,
      "side": "RIGHT"
    }
  ]
}