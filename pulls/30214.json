{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214",
    "id": 1898129875,
    "node_id": "PR_kwDOABII585xIynT",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30214",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30214.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30214.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/467528960689c2913c101ef75bc833e8f04bd0f3",
    "number": 30214,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "refactor: Improve assumeutxo state representation",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "This PR contains the first part of #28608, which tries to make assumeutxo code more maintainable, and improve it by not locking `cs_main` for a long time when the snapshot block is connected, and by deleting the snapshot validation chainstate when it is no longer used, instead of waiting until the next restart.\r\n\r\nThe changes in this PR are just refactoring. They make `Chainstate` objects self-contained, so for example, it is possible to determine what blocks to connect to a chainstate without querying `ChainstateManager`, and to determine whether a Chainstate is validated without basing it on inferences like `&cs != &ActiveChainstate()` or `GetAll().size() == 1`.\r\n\r\nThe PR also tries to make assumeutxo terminology less confusing, using \"current chainstate\" to refer to the chainstate targeting the current network tip, and \"historical chainstate\" to refer to the chainstate downloading old blocks and validating the assumeutxo snapshot. It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.",
    "labels": [
      {
        "id": 135961,
        "node_id": "MDU6TGFiZWwxMzU5NjE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
        "name": "Refactoring",
        "color": "E6F6D6",
        "default": false
      },
      {
        "id": 955867938,
        "node_id": "MDU6TGFiZWw5NTU4Njc5Mzg=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase",
        "name": "Needs rebase",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2024-05-31T14:53:10Z",
    "updated_at": "2025-03-18T21:26:48Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "e507a9e442667d455ead2333930a1dcc5521ddf2",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "ryanofsky:pr/cstate",
      "ref": "pr/cstate",
      "sha": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 69901633,
        "node_id": "MDEwOlJlcG9zaXRvcnk2OTkwMTYzMw==",
        "name": "bitcoin",
        "full_name": "ryanofsky/bitcoin",
        "owner": {
          "login": "ryanofsky",
          "id": 7133040,
          "node_id": "MDQ6VXNlcjcxMzMwNDA=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/ryanofsky",
          "html_url": "https://github.com/ryanofsky",
          "followers_url": "https://api.github.com/users/ryanofsky/followers",
          "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
          "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
          "repos_url": "https://api.github.com/users/ryanofsky/repos",
          "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/ryanofsky/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/ryanofsky/bitcoin",
        "archive_url": "https://api.github.com/repos/ryanofsky/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/ryanofsky/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/ryanofsky/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/ryanofsky/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/ryanofsky/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/ryanofsky/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/ryanofsky/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/ryanofsky/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/ryanofsky/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/ryanofsky/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/ryanofsky/bitcoin/events",
        "forks_url": "https://api.github.com/repos/ryanofsky/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/ryanofsky/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/ryanofsky/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/ryanofsky/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/ryanofsky/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/ryanofsky/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/ryanofsky/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/ryanofsky/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/ryanofsky/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/ryanofsky/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/ryanofsky/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:ryanofsky/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/ryanofsky/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/ryanofsky/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/ryanofsky/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/ryanofsky/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/ryanofsky/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/ryanofsky/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/ryanofsky/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/ryanofsky/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/ryanofsky/bitcoin/hooks",
        "svn_url": "https://github.com/ryanofsky/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 6,
        "stargazers_count": 16,
        "watchers_count": 16,
        "size": 278419,
        "default_branch": "master",
        "open_issues_count": 3,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-18T21:26:03Z",
        "created_at": "2016-10-03T19:05:43Z",
        "updated_at": "2025-02-09T01:43:29Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "223fc24c4ebc8dbaecf59ccd36e49193b58d422b",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36941,
        "stargazers_count": 82530,
        "watchers_count": 82530,
        "size": 278405,
        "default_branch": "master",
        "open_issues_count": 685,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-03-18T12:36:47Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-03-18T20:08:13Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 685,
    "deletions": 740,
    "changed_files": 39,
    "commits": 17,
    "review_comments": 34,
    "comments": 13
  },
  "events": [
    {
      "event": "commented",
      "id": 2142439540,
      "node_id": "IC_kwDOABII585_swh0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142439540",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T14:53:13Z",
      "updated_at": "2025-03-14T21:24:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/30214.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Approach ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30610](https://github.com/bitcoin/bitcoin/pull/30610) (validation: do not wipe utxo cache for stats/scans/snapshots by sipa)\n* [#30598](https://github.com/bitcoin/bitcoin/pull/30598) (assumeutxo: Drop block height from metadata by fjahr)\n* [#30342](https://github.com/bitcoin/bitcoin/pull/30342) (kernel, logging: Pass Logger instances to kernel objects by ryanofsky)\n* [#30221](https://github.com/bitcoin/bitcoin/pull/30221) (wallet: Ensure best block matches wallet scan state by achow101)\n* [#29680](https://github.com/bitcoin/bitcoin/pull/29680) (wallet: fix unrelated parent conflict doesn't cause child tx to be marked as conflict by Eunovo)\n* [#29652](https://github.com/bitcoin/bitcoin/pull/29652) (wallet: Avoid potentially writing incorrect best block locator by ryanofsky)\n* [#29641](https://github.com/bitcoin/bitcoin/pull/29641) (scripted-diff: Use LogInfo/LogDebug over LogPrintf/LogPrint by maflcko)\n* [#28616](https://github.com/bitcoin/bitcoin/pull/28616) (Show transactions as not fully confirmed during background validation by Sjors)\n* [#26593](https://github.com/bitcoin/bitcoin/pull/26593) (tracing: Only prepare tracepoint arguments when actually tracing by 0xB10C)\n* [#26022](https://github.com/bitcoin/bitcoin/pull/26022) (Add util::ResultPtr class by ryanofsky)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2142439540",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 13001884170,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMG-QIK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13001884170",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T14:53:15Z",
      "label": {
        "name": "Refactoring",
        "color": "E6F6D6"
      }
    },
    {
      "event": "labeled",
      "id": 13005246304,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMHLE9g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13005246304",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T19:56:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2142897707,
      "node_id": "IC_kwDOABII585_ugYr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142897707",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T19:56:39Z",
      "updated_at": "2024-05-31T19:56:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\nðŸš§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25656143496</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2142897707",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13026031143,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMIaXYn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13026031143",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "685e1e21d10ebf4892bb0ac892f142a18f7dbe70",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/685e1e21d10ebf4892bb0ac892f142a18f7dbe70",
      "created_at": "2024-06-03T19:38:28Z"
    },
    {
      "event": "unlabeled",
      "id": 13041415557,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMJVDWF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13041415557",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-04T20:15:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2155889026,
      "node_id": "IC_kwDOABII586AgEGC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155889026",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-08T09:21:00Z",
      "updated_at": "2024-06-08T09:21:00Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2155889026",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 13103465275,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMNBwM7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13103465275",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-10T15:31:29Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13188697652,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMSG440",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13188697652",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "26f3c7d53f192cf20467bb80bb4b7948d43449f8",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/26f3c7d53f192cf20467bb80bb4b7948d43449f8",
      "created_at": "2024-06-17T16:52:15Z"
    },
    {
      "event": "unlabeled",
      "id": 13188709437,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMSG7w9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13188709437",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T16:53:19Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13191760481,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMSSkph",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13191760481",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T21:15:41Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13192550228,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMSVldU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13192550228",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "created_at": "2024-06-17T22:54:13Z"
    },
    {
      "event": "unlabeled",
      "id": 13192801579,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMSWi0r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13192801579",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-17T23:28:48Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13273157528,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMXJE-Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13273157528",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-25T00:04:30Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2177291599,
      "node_id": "PRR_kwDOABII586BxtVP",
      "url": null,
      "actor": null,
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Approach ACK\r\n\r\nI think pretty much everything here is a worth while improvement and should set up the following improvements well. I am not so deep into the current state of the kernel work though, so I can not comment on that part, for example the newly introduced typing file. I guess @TheCharlatan could give his nod to that here.\r\n\r\n> It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.\r\n\r\nI think this is a bit confusing because it sounds like you are getting rid of this completely but it's actually just avoided where you touch the code, right? Cleaning the terms up everywhere can be a follow-up, I would like to try to rewrite the design doc a bit more anyway. But I think (selfishly) would like to break it up into design and usage docs because IMO that makes it way more manageable, i.e. the last commit of #29553.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599",
      "submitted_at": "2024-07-15T11:11:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "reviewed",
      "id": 2186500256,
      "node_id": "PRR_kwDOABII586CU1ig",
      "url": null,
      "actor": null,
      "commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2177291599\r\n\r\nThanks for reviewing! Will rebase and try to address comments. I'm especially interested if you have ideas on splitting up documentation and code changes into separate PRs.\r\n\r\n> I am not so deep into the current state of the kernel work though, so I can not comment on that part, for example the newly introduced typing file. I guess @TheCharlatan could give his nod to that here.\r\n\r\nSure, for background kernel/types.h is analogous to node/types.h, wallet/types.h, and common/types.h. The types files are used when libraries want to define shared struct and enum types that can be used by code NOT directly depending on the library. For example the gui code uses the `wallet::isminetype` enum type, but the gui should not depend on the wallet library, so the enum is defined in a shared header `wallet/types.h`. In this PR, wallet code uses the `kernel::ChainstateRole` struct type, but the wallet code should not depend on the kernel library, so the struct is defined in a shared header `kernel/types.h`. This pattern started with the wallet library, but has been useful for node and common libraries as well, so it is natural to extend to the kernel.\r\n\r\nA more stricter separation between libraries would be possible with a more complicated structure, but having shared types files has been a reasonable way to separate the libraries while having a 1 library = 1 directory = 1 namespace structure.\r\n\r\n> > It removes uses of the terms \"active chainstate,\" \"usable chainstate,\" \"disabled chainstate,\" \"ibd chainstate,\" and \"snapshot chainstate\" which are confusing for various reasons.\r\n>\r\n> I think this is a bit confusing because it sounds like you are getting rid of this completely but it's actually just avoided where you touch the code, right? Cleaning the terms up everywhere can be a follow-up, I would like to try to rewrite the design doc a bit more anyway. But I think (selfishly) would like to break it up into design and usage docs because IMO that makes it way more manageable, i.e. the last commit of #29553.\r\n\r\nYeah this description was written aspirationally before I implemented this PR and I did not get around to removing all the old language. I'd be interested if you have specific ideas on how to break this PR up better. I definitely think it could make sense to move documentation / comment changes to a separate PR, and I hope #29553 can be reviewed more and merged soon, before this PR. (This is a good reminder for me to re-ack #29553)\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2186500256",
      "submitted_at": "2024-07-18T18:41:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13582586904,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMpldQY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13582586904",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "created_at": "2024-07-19T21:52:57Z"
    },
    {
      "event": "reviewed",
      "id": 2189391816,
      "node_id": "PRR_kwDOABII586Cf3fI",
      "url": null,
      "actor": null,
      "commit_id": "2c1d8b426fa1832fa464c12f3cae7e2976584430",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Rebased 493d3844cfc8628fd63184fa7a657126d9b5dc95 -> 2c1d8b426fa1832fa464c12f3cae7e2976584430 ([`pr/cstate.4`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.4) -> [`pr/cstate.5`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.5), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.4-rebase..pr/cstate.5)) due to conflicts with various prs including #30267, #30388, #30395, #29996, #30406, #30320. Also made suggested simplifications.\r\nRebased 2c1d8b426fa1832fa464c12f3cae7e2976584430 -> 4c995842e3689974364c8c82ee220bfaa30f7f79 ([`pr/cstate.5`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.5) -> [`pr/cstate.6`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.6), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.5-rebase..pr/cstate.6)) due to conflict with #30111\r\nRebased 4c995842e3689974364c8c82ee220bfaa30f7f79 -> 7fd7960389254c7a2ba50614e1cbdf8911ef6a7d ([`pr/cstate.6`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.6) -> [`pr/cstate.7`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.7), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.6-rebase..pr/cstate.7)) due to conflict with #29656",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2189391816",
      "submitted_at": "2024-07-19T21:55:00Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "unlabeled",
      "id": 13583496678,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMpo7Xm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13583496678",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-19T22:21:05Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13627342485,
      "node_id": "LE_lADOABII586KwuWzzwAAAAMsQL6V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13627342485",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-24T09:07:55Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13633128345,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAMsmQeZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13633128345",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4c995842e3689974364c8c82ee220bfaa30f7f79",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/4c995842e3689974364c8c82ee220bfaa30f7f79",
      "created_at": "2024-07-24T16:14:04Z"
    },
    {
      "event": "unlabeled",
      "id": 13634114258,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAMsqBLS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13634114258",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-24T17:30:40Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13761754364,
      "node_id": "LE_lADOABII586KwuWzzwAAAAM0Q7T8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13761754364",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-05T10:01:38Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13796072129,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAM2T1rB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13796072129",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "created_at": "2024-08-07T18:06:48Z"
    },
    {
      "event": "unlabeled",
      "id": 13797187317,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAM2YF71",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13797187317",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-07T19:56:09Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13826041283,
      "node_id": "LE_lADOABII586KwuWzzwAAAAM4GKXD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13826041283",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-09T22:19:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2308980712,
      "node_id": "IC_kwDOABII586JoD_o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2308980712",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:01Z",
      "updated_at": "2024-08-25T20:20:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for addressing my feedback @ryanofsky ! I hope we can merge #29553 soon and then I will get back to this with another full review. But it does look very good to me already.\r\n\r\n> I'm especially interested if you have ideas on splitting up documentation and code changes into separate PRs.\r\n\r\nI'm unsure if it's really needed because I find clean refactoring commits like those here can be reviewed quicker than other changes, so I would be fine to keep it as is just based on volume of the change. But I did think about it and if that is feasible maybe splitting along the lines of everything that touches `ChainstateRole` and the rest (in whatever order you think works better) could be an idea. If you feel like splitting it that's fine for me but I think I would prefer to keep it as one PR as I have already passed everything so I am biased towards fewer fundamental changes ;)\r\n\r\nAh, and since the first is a fix you could just open that as a separate PR now. That should be an easy review and merge that doesn't conflict with anything else. The docs changes it feels like it's better to keep them along the code since you need to get your head into the topic either way. I often feel like reviewing docs and code side by side challenges your understanding and might lead to higher quality review.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2308980712",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "mentioned",
      "id": 14005196273,
      "node_id": "MEE_lADOABII586KwuWzzwAAAANCxlXx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14005196273",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:03Z"
    },
    {
      "event": "subscribed",
      "id": 14005196276,
      "node_id": "SE_lADOABII586KwuWzzwAAAANCxlX0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14005196276",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-25T20:20:03Z"
    },
    {
      "event": "commented",
      "id": 2403433476,
      "node_id": "IC_kwDOABII586PQXwE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2403433476",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-09T21:09:16Z",
      "updated_at": "2024-10-09T21:09:16Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2403433476",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "reviewed",
      "id": 2669420393,
      "node_id": "PRR_kwDOABII586fHB9p",
      "url": null,
      "actor": null,
      "commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2669420393",
      "submitted_at": "2025-03-09T12:57:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "commented",
      "id": 2718373984,
      "node_id": "IC_kwDOABII586iBxhg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2718373984",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T16:01:06Z",
      "updated_at": "2025-03-12T16:01:06Z",
      "author_association": "CONTRIBUTOR",
      "body": "Reading through commit a35a2a05887202de8c49727b6ea9166bf5f1a6f2 I am asking myself if with the addition of `m_target_blockhash`, the state of `m_validity` can just be computed on the fly without having to lug around and assert its state. For tracking the change in validity to `INVALID` once the tip reaches the target block the historical chainstate, could the presence of the `m_target_utxo_hash` (similar to how the belt-and-suspenders check is done later on) be checked instead? And for the current chainstate could the `ASSUMED_VALID` state be tracked with the presence of the snapshot base block and then the transition to the `VALIDATED` state by checking if the blocks up to the snapshot base block have `BLOCK_VALID_MASK`?",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2718373984",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2718492650,
      "node_id": "IC_kwDOABII586iCOfq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2718492650",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-12T16:42:25Z",
      "updated_at": "2025-03-12T16:42:25Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Reading through commit [a35a2a0](https://github.com/bitcoin/bitcoin/commit/a35a2a05887202de8c49727b6ea9166bf5f1a6f2) I am asking myself if with the addition of `m_target_blockhash`, the state of `m_validity` can just be computed on the fly without having to lug around and assert its state.\r\n\r\nI think it could probably work but two reasons not to do it might be:\r\n\r\n(1) to avoid performance regressions in parts of the code that are assuming it is possible to determine whether a chainstate is valid or valid instantly without without iterating over the chain\r\n(2) to make intent explicit and make code general and future proof\r\n\r\nTo explain (2) maybe it is safe right now to assume that any chain that is not invalid and not fully validated must be assumed-valid. But it's not clear that this should always be the case. Maybe a potential libbitcoinkernel application could be a fork-monitoring client that tracks multiple chains for some other reason and doesn't want to mark any of them as assume-valid. Having an explicit assume-valid state could make purpose of the chain more explicit and could let code dealing with multiple chainstates use chains based on how they are intended to be used without trying to infer intent from other attributes.\r\n\r\nMaybe what you are are suggesting could be an improvement, through, and it's been a while since I thought about this and reasons I listed above are speculative. Could try implementing the suggestion and see if it simplifies the code.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2718492650",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2720898462,
      "node_id": "IC_kwDOABII586iLZ2e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2720898462",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T11:18:14Z",
      "updated_at": "2025-03-13T11:56:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Maybe what you are are suggesting could be an improvement, through, and it's been a while since I thought about this and reasons I listed above are speculative. Could try implementing the suggestion and see if it simplifies the code.\r\n\r\nThis is what I had in mind: https://github.com/TheCharlatan/bitcoin/commit/9c89548c670e7b807a969e13408ff03df15143a2 (also rebased this branch to get cmake) . It is very broken in its current state though. There are a few problems with it, but I guess the fundamental problem is that the current application of a snapshot is done in relation to an existing chain and its state, and not against the block index and its state.  E.g. [the check](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L5835) for not loading a snapshot with less work only looks at the chain state, not the block index. If the chain is behind the block index, but the block index already has more fully-validated work, the snapshot application passes, but my new function would think it is already fully validated. The tests heavily rely on the current behaviour, where the best work chain is taken from the existing chainstate.\r\n\r\nThinking outside of this proposed change, is this really the desired behaviour though? Shouldn't the block index be our fundamental source of truth? I can think of a few scenarios outside of the tests where the chain being behind the fully-validated block index can be encountered, for example during a chainstate reindex, but I don't think they are something where snapshots should be supported.\r\n\r\n>  (2) to make intent explicit and make code general and future proof\r\n\r\nI would argue that adding this validity state could also make it more complicated to implement, or compose from existing functionality, parallel validation, or similar IBD speedups that might partition the chain even more.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2720898462",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16745661866,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPmHoWq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16745661866",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "58f62c2221d82e22e7c2d9cccedd58e4390ace5a",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/58f62c2221d82e22e7c2d9cccedd58e4390ace5a",
      "created_at": "2025-03-13T17:10:46Z"
    },
    {
      "event": "commented",
      "id": 2722056036,
      "node_id": "IC_kwDOABII586iP0dk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722056036",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:14:58Z",
      "updated_at": "2025-03-13T17:36:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased 7fd7960389254c7a2ba50614e1cbdf8911ef6a7d -> 58f62c2221d82e22e7c2d9cccedd58e4390ace5a ([`pr/cstate.7`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.7) -> [`pr/cstate.8`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.8), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.7-rebase..pr/cstate.8)) due to various conflicts.\r\nUpdated 58f62c2221d82e22e7c2d9cccedd58e4390ace5a -> d09b82156ced5d543d08226e8d7b8fda2e0ec532 ([`pr/cstate.8`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.8) -> [`pr/cstate.9`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.9), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.8..pr/cstate.9)) to fix \"error: private field 'm_is_memory' is not used\" https://github.com/bitcoin/bitcoin/pull/30214/checks?check_run_id=38726768015\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2720898462\r\n\r\n> Shouldn't the block index be our fundamental source of truth?\r\n\r\nI'm open to this idea but not sure the block index has enough information in this case to provide information efficiently since you can't know if a particular block is fully validated without iterating over the whole chain back to genesis. Also, if mulltiple chainstates might exist for different purposes, it may be useful to store information about the purpose of each chainstate and what assumptions it was created under in the chainstate itself not in blocks that it is pointing to. I think the `Chainstate::m_validity` member in this PR does both of these things in a pretty straightforward way, but if we want to replace it with something better, hopefully that should not be too hard since it is a private member, so the public Chainstate interface would not have change.\r\n\r\nOne thing this PR is trying to accomplish is making it possible determine status of `Chainstate` objects independently, without having to look at `ChainstateManager` objects and other `Chainstate` objects. But it should be fine for `Chainstate` methods to use BlockIndex flags to return their status.\r\n\r\n> I would argue that adding this validity state could also make it more complicated to implement, or compose from existing functionality, parallel validation, or similar IBD speedups that might partition the chain even more.\r\n\r\nI think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. I can easily see the `m_validity` field not being general enough to do that, but it's more easy for me to imagine it being replaced by another field than being eliminated entirely. But again I think the fact that it's a private field should make it easier to change or eliminate.\r\n\r\nShould also point out the that `m_validity` member added here is not really new. It's just replacing the previous `m_disabled` member with something more positive and less ambiguous.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722056036",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16746268914,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPmJ8jy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16746268914",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "created_at": "2025-03-13T17:34:03Z"
    },
    {
      "event": "labeled",
      "id": 16746274673,
      "node_id": "LE_lADOABII586KwuWzzwAAAAPmJ99x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16746274673",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:34:09Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2722127023,
      "node_id": "IC_kwDOABII586iQFyv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722127023",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T17:34:10Z",
      "updated_at": "2025-03-13T17:34:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/38726767974</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722127023",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "unlabeled",
      "id": 16747653095,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPmPOfn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16747653095",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T18:33:30Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 16747851374,
      "node_id": "UNLE_lADOABII586KwuWzzwAAAAPmP-5u",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16747851374",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T18:50:07Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2722641649,
      "node_id": "IC_kwDOABII586iSDbx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722641649",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T20:39:27Z",
      "updated_at": "2025-03-13T20:39:27Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. \r\n\r\nYes, I think I have come to a similar conclusion, and I think the introduced reliance here on the `m_target_blockhash` and `m_from_snapshot_blockhash` are very good changes. Having some kind of \"start\" and \"stop\" blocks for a chainstate seems like something that is easy to understand and might also be useful beyond assumeutxo.\r\n\r\n> since you can't know if a particular block is fully validated without iterating over the whole chain back to genesis\r\n\r\nIsn't that only true when iterating over the snapshot block or when you don't know if you might come across it? My understanding is that is also what the [docs](https://github.com/bitcoin/bitcoin/blob/master/src/chain.h#L111) say about `BLOCK_VALID_CHAIN` and `BLOCK_VALID_SCRIPTS` and is also checked in `CheckBlockIndex`.\r\n\r\n> I think if multiple chainstates will exist for different purposes, the chainstate objects will need to have some field describing their purpose and controlling their behavior. \r\n\r\nI would also like to see a future with more diverse modes of validation, but I feel like we already have the `ChainstateManager` class for controlling the behaviour of a `Chainstate`. In my mind a `Chainstate` should not have to know all the details of what it is being used for, or have rich descriptive state about its own behaviour. I feel like many of the self-describing behaviours, like passing the `ChainstateRole` through a notification, should actually be done by the `ChainstateManager`. I don't think the changes in this PR go diametrically against that goal, but I am also not sure yet if the changes here really make it easier to eventually go into that direction.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722641649",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "commented",
      "id": 2722882679,
      "node_id": "IC_kwDOABII586iS-R3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2722882679",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-13T23:08:56Z",
      "updated_at": "2025-03-13T23:08:56Z",
      "author_association": "CONTRIBUTOR",
      "body": "I think I agree with all that, and think chainstate objects should just contain information for chainstatemanager to deal with them, not to have \"rich\" data or application specific data. I also think depending on what you want to do with chainstates, block status flags may provide enough information, but they are not equivalent to the old `Chainstate::m_disabled` field or the new `Chainstate::m_validity` field replacing it, since block flags only tell you about validity back to the last snapshot block, not back to genesis block.\r\n\r\nI guess I'm not really sure what problems you see with chainstates knowing their role or validity, but it is true they continue to know some of that information after this PR just like they knew it before. If you want to move that information elsewhere like chainstate manager or derive it from block validity flags I don't think this PR should get in the way of that, and it probably even helps a little because it narrows the definition of `ChainstateRole` to not indicate assumeutxo status but only indicate basic information about whether the chainstate is validated and what block it is targeting. The PR should also help more if you are interested in using chainstate objects for applications other than assumeutxo, because it is dropping assumeutxo-specific assumptions many places in validation and networking code and adding a generic `ChainstateManager::m_chainstates` vector that can hold arbitrary chainstates.\r\n\r\nI'd also point out that the `Chainstate::m_validity` field only gets written in 2 places: in the `Chainstate` constructor and in the `ChainstateManager::MaybeCompleteSnapshotValidation` method, so I don't think it adds much maintenance burden even if you think other fields might be more useful.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2722882679",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "labeled",
      "id": 16754527220,
      "node_id": "LE_lADOABII586KwuWzzwAAAAPmpcv0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16754527220",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-14T03:48:18Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2723345159,
      "node_id": "IC_kwDOABII586iUvMH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2723345159",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-14T03:48:19Z",
      "updated_at": "2025-03-14T03:48:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\nðŸ™ This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#issuecomment-2723345159",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30214"
    },
    {
      "event": "reviewed",
      "id": 2685423528,
      "node_id": "PRR_kwDOABII586gEE-o",
      "url": null,
      "actor": null,
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Approach ACK\r\n\r\nI am not yet onvinced of the last three commits changing the code (5e22fdcdb2665c0bb5e47c53719796096afe2dd1, 58265b955a3d8622f22958943f79409129d58b36, ca48478fbfcc83cc6f8c928e57800707fe0c3b51), maybe they could do with some more motivation in the commit message? I guess the last of the commits ca48478fbfcc83cc6f8c928e57800707fe0c3b51 is kind of the result of the preceding two and it is nice not to have to construct the vector on the fly for every `GetAll()` call anymore.\r\n\r\nThere is an opportunity for also simplifying the pruning code a bit, I made a commit herehttps://github.com/TheCharlatan/bitcoin/commit/fe76cc3a04c94ca4fdbb9550d478909f3b13d8ec that removes the chainman arguments from the manual pruning function. I think it would fit in well with the patch set here.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528",
      "submitted_at": "2025-03-14T21:24:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGRmOTlmMTlkODE1MzdlY2ZiZjY2ZjY2NjJiYzk4MTRiNTk0ZWY4ZDI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/df99f19d81537ecfbf66f6662bc9814b594ef8d2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/df99f19d81537ecfbf66f6662bc9814b594ef8d2",
      "tree": {
        "sha": "53c59df0cc7338c1f97973d008c24cf0d5641fb7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/53c59df0cc7338c1f97973d008c24cf0d5641fb7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/223fc24c4ebc8dbaecf59ccd36e49193b58d422b",
          "sha": "223fc24c4ebc8dbaecf59ccd36e49193b58d422b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/223fc24c4ebc8dbaecf59ccd36e49193b58d422b"
        }
      ],
      "message": "test: Fix broken chainstatemanager_snapshot_init check\n\nThe following test code never checked anything because the if statement was\nalways false:\n\n    if (cs != &chainman_restarted.ActiveChainstate()) {\n        BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n    }\n\nAlso, the height of the background chainstate it was intending to check is 110,\nnot 109. Fix both problems by rewriting the check.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T10:53:50Z"
      },
      "sha": "df99f19d81537ecfbf66f6662bc9814b594ef8d2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI3NDU4NDBjNWYzZThlZWU0M2I4OGM3ODY2MmI4NmU0NmI1YzkwNTY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2745840c5f3e8eee43b88c78662b86e46b5c9056",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/2745840c5f3e8eee43b88c78662b86e46b5c9056",
      "tree": {
        "sha": "f79f08cb3ee1243f9f2c4a79695968e7c4942881",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f79f08cb3ee1243f9f2c4a79695968e7c4942881"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/df99f19d81537ecfbf66f6662bc9814b594ef8d2",
          "sha": "df99f19d81537ecfbf66f6662bc9814b594ef8d2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/df99f19d81537ecfbf66f6662bc9814b594ef8d2"
        }
      ],
      "message": "refactor: Add Chainstate::m_target_blockhash member\n\nMake Chainstate objects aware of what block they are targeting. This makes\nChainstate objects more self contained, so it's possible to determine what\nblocks should be downloaded and connected to them without needing to query\nChainstateManager or look at other Chainstate objects.\n\nThe motivation for this change is to make code more readable, so it only\nrequires knowing about Chainstate targets, not reasoning about the assumeutxo\nsnapshot validation sequence. This change also enables simplifications to the\nChainstateManager interface in subsequent commits, and could make it easier to\nimplement new features like creating new Chainstate objects to generate UTXO\nsnapshots or index UTXO data.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T00:27:27Z"
      },
      "sha": "2745840c5f3e8eee43b88c78662b86e46b5c9056"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGExZmQ1YTg4NjI1MmViZDgxM2VlNjkwMjlkY2YxN2RlNjg4M2UwNDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a1fd5a886252ebd813ee69029dcf17de6883e047",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a1fd5a886252ebd813ee69029dcf17de6883e047",
      "tree": {
        "sha": "e52fb48fb59ce355d2e951cd643a88a1c7de13a2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e52fb48fb59ce355d2e951cd643a88a1c7de13a2"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2745840c5f3e8eee43b88c78662b86e46b5c9056",
          "sha": "2745840c5f3e8eee43b88c78662b86e46b5c9056",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2745840c5f3e8eee43b88c78662b86e46b5c9056"
        }
      ],
      "message": "refactor: Add Chainstate m_validity and m_target_blockhash members\n\nGet rid of m_disabled/IsUsable members. Instead of marking chains disabled for\ndifferent reasons, record chainstate validity and validation progress\nexplicitly and use that information directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T12:55:17Z"
      },
      "sha": "a1fd5a886252ebd813ee69029dcf17de6883e047"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM4OTA5MjM5NzMzZDg2NTQxMDE2ZDNkNzE2NDRjZWRkZTY3ODY5NGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c8909239733d86541016d3d71644cedde678694a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c8909239733d86541016d3d71644cedde678694a",
      "tree": {
        "sha": "33cec128b568733dbc5c73323b4076182792b73d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/33cec128b568733dbc5c73323b4076182792b73d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a1fd5a886252ebd813ee69029dcf17de6883e047",
          "sha": "a1fd5a886252ebd813ee69029dcf17de6883e047",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a1fd5a886252ebd813ee69029dcf17de6883e047"
        }
      ],
      "message": "refactor: Deduplicate Chainstate activation code\n\nMove duplicate code from ChainstateManager::ActivateSnapshot and\nChainstateManager::ActivateExistingSnapshot methods to a new\nChainstateManager::AddChainstate method.\n\nThe \"AddChainstate\" method name doesn't mention snapshots even though it is\nonly used to add snapshot chainstates now, because it becomes more generalized\nin a later commit in this PR (\"refactor: Add ChainstateManager::m_chainstates\nmember\")",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T13:42:03Z"
      },
      "sha": "c8909239733d86541016d3d71644cedde678694a"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE5OWEyZWI4N2MzYWQ5MzgyZjJmZTRhZTk3NTI0MDk5MjI0YTdiMDQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/199a2eb87c3ad9382f2fe4ae97524099224a7b04",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/199a2eb87c3ad9382f2fe4ae97524099224a7b04",
      "tree": {
        "sha": "6e97c304bf542c7ad3a4b857b817ab8371cd3857",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6e97c304bf542c7ad3a4b857b817ab8371cd3857"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c8909239733d86541016d3d71644cedde678694a",
          "sha": "c8909239733d86541016d3d71644cedde678694a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c8909239733d86541016d3d71644cedde678694a"
        }
      ],
      "message": "refactor: Pass chainstate parameters to MaybeCompleteSnapshotValidation\n\nRemove hardcoded references to m_ibd_chainstate and m_snapshot_chainstate so\nMaybeCompleteSnapshotValidation function can be simpler and focus on validating\nthe snapshot without dealing with internal ChainstateManager states.\n\nThis is a step towards being able to validate the snapshot outside of\nActivateBestChain loop so cs_main is not locked for minutes when the snapshot\nblock is connected.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T13:17:10Z"
      },
      "sha": "199a2eb87c3ad9382f2fe4ae97524099224a7b04"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGU2MTE2NDBhYmQ4ZmFlNTFjMTNiNGFhODI1ZGI5MGNlZGY0NDY1ZTI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e611640abd8fae51c13b4aa825db90cedf4465e2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e611640abd8fae51c13b4aa825db90cedf4465e2",
      "tree": {
        "sha": "98170b61598374bea1ffa3bcfe10012712f49fa1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/98170b61598374bea1ffa3bcfe10012712f49fa1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/199a2eb87c3ad9382f2fe4ae97524099224a7b04",
          "sha": "199a2eb87c3ad9382f2fe4ae97524099224a7b04",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/199a2eb87c3ad9382f2fe4ae97524099224a7b04"
        }
      ],
      "message": "refactor: Add Chainstate::StoragePath() method\n\nUse to simplify code determining the chainstate leveldb paths.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T15:25:04Z"
      },
      "sha": "e611640abd8fae51c13b4aa825db90cedf4465e2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQxZjQzN2Y5ZjhjOWExYWI2YTUwNjU0YjY0YjM5MmQ2ZmViMTBmMDA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/41f437f9f8c9a1ab6a50654b64b392d6feb10f00",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/41f437f9f8c9a1ab6a50654b64b392d6feb10f00",
      "tree": {
        "sha": "6e7546aae473ef967ea8b4aff60849c5a4d8184d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6e7546aae473ef967ea8b4aff60849c5a4d8184d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e611640abd8fae51c13b4aa825db90cedf4465e2",
          "sha": "e611640abd8fae51c13b4aa825db90cedf4465e2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e611640abd8fae51c13b4aa825db90cedf4465e2"
        }
      ],
      "message": "refactor: Add ChainstateManager::CurrentChainstate() method\n\nCurrentChainstate() is basically the same as ActiveChainstate() except it\nrequires cs_main to be locked when it is called, instead of locking cs_main\ninternally.\n\nThe name \"current\" should also be less confusing than \"active\" because multiple\nchainstates can be active, and CurrentChainstate() returns the chainstate\ntargeting the current network tip, regardless of what chainstates are being\ndownloaded or how they are used.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T16:03:47Z"
      },
      "sha": "41f437f9f8c9a1ab6a50654b64b392d6feb10f00"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQwZDk2ZGEzYmEzMmVhNTVjYTUzMWVhOTRiZTJmMjkwNjQzMDAzMGI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d0d96da3ba32ea55ca531ea94be2f2906430030b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d0d96da3ba32ea55ca531ea94be2f2906430030b",
      "tree": {
        "sha": "b9849698b0206b58d5be1c666d6e4e767e605f9f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b9849698b0206b58d5be1c666d6e4e767e605f9f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/41f437f9f8c9a1ab6a50654b64b392d6feb10f00",
          "sha": "41f437f9f8c9a1ab6a50654b64b392d6feb10f00",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/41f437f9f8c9a1ab6a50654b64b392d6feb10f00"
        }
      ],
      "message": "refactor: Add ChainstateManager::ValidatedChainstate() method\n\nValidatedChainstate() accessor replaces GetChainstateForIndexing() with no\nchange in behavior.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T16:03:47Z"
      },
      "sha": "d0d96da3ba32ea55ca531ea94be2f2906430030b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDdmMmJiM2I4MTE5ZTg3ODNmOTg0YmZkNTVhNGEyYTAzOGY4Mjk2NjY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7f2bb3b8119e8783f984bfd55a4a2a038f829666",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7f2bb3b8119e8783f984bfd55a4a2a038f829666",
      "tree": {
        "sha": "e8060f2fcea4b607f0ffe96aff960fa8bee97717",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e8060f2fcea4b607f0ffe96aff960fa8bee97717"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d0d96da3ba32ea55ca531ea94be2f2906430030b",
          "sha": "d0d96da3ba32ea55ca531ea94be2f2906430030b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d0d96da3ba32ea55ca531ea94be2f2906430030b"
        }
      ],
      "message": "refactor: Convert ChainstateRole enum to struct\n\nChange ChainstateRole parameter passed to wallets and indexes. Wallets and\nindexes need to know whether chainstate is historical and whether it is fully\nvalidated. They should not be aware of the assumeutxo snapshot validation\nprocess.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-07-19T16:12:07Z"
      },
      "sha": "7f2bb3b8119e8783f984bfd55a4a2a038f829666"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFmMGZjNTU0YWQ4ZDU1OWQ0ODg1MWI5ZGUwNmI5MzM5Zjg3MWNiMDE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1f0fc554ad8d559d48851b9de06b9339f871cb01",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1f0fc554ad8d559d48851b9de06b9339f871cb01",
      "tree": {
        "sha": "8c5730235f7330a4894b66f20211f36a58235a46",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8c5730235f7330a4894b66f20211f36a58235a46"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7f2bb3b8119e8783f984bfd55a4a2a038f829666",
          "sha": "7f2bb3b8119e8783f984bfd55a4a2a038f829666",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7f2bb3b8119e8783f984bfd55a4a2a038f829666"
        }
      ],
      "message": "refactor: Delete ChainstateManager::IsSnapshotActive() method\n\nIsSnapshotActive() method is only called one place outside of tests and\nasserts, and is confusing because it returns true even after the snapshot is\nfully validated.\n\nThe documentation which said this \"implies that a background validation\nchainstate is also in use\" is also incorrect, because after the snapshot is\nvalidated, the background chainstate gets disabled and IsUsable() would return\nfalse.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-31T11:00:40Z"
      },
      "sha": "1f0fc554ad8d559d48851b9de06b9339f871cb01"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDdhOWM3OWVlNzFiYjNmNWJkODVhZWQ5MGZkMjE3ZjI0NmYzOGQ1ODg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7a9c79ee71bb3f5bd85aed90fd217f246f38d588",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7a9c79ee71bb3f5bd85aed90fd217f246f38d588",
      "tree": {
        "sha": "3ad8245c78dc10d0c874a449400d1ac7998a4220",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3ad8245c78dc10d0c874a449400d1ac7998a4220"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1f0fc554ad8d559d48851b9de06b9339f871cb01",
          "sha": "1f0fc554ad8d559d48851b9de06b9339f871cb01",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1f0fc554ad8d559d48851b9de06b9339f871cb01"
        }
      ],
      "message": "refactor: Delete ChainstateManager::IsSnapshotValidated() method\n\nIsSnapshotValidated() is only called one place outside of tests, and is use\nredundantly in some tests, asserting that a snapshot is not validated when a\nsnapshot chainstate does not even exist. Simplify by dropping the method and\nchecking Chainstate validity field directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T20:14:42Z"
      },
      "sha": "7a9c79ee71bb3f5bd85aed90fd217f246f38d588"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDZjZmUzZjFmYWQzNzBkMjJhZjg4YjAyNTllNGE1ZjZkZGQ1ZjJhZmI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb",
      "tree": {
        "sha": "6a50febd753bb944441c0924c498c0b7395257bb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6a50febd753bb944441c0924c498c0b7395257bb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7a9c79ee71bb3f5bd85aed90fd217f246f38d588",
          "sha": "7a9c79ee71bb3f5bd85aed90fd217f246f38d588",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7a9c79ee71bb3f5bd85aed90fd217f246f38d588"
        }
      ],
      "message": "refactor: Delete ChainstateManager::SnapshotBlockhash() method\n\nSnapshotBlockhash() is only called two places outside of tests, and is used\nredundantly in some tests, checking the same field as other checks. Simplify by\ndropping the method and using the m_from_snapshot_blockhash field directly.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T20:30:22Z"
      },
      "sha": "6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBjNDE5MDNhNzEwMGZmZTEyMjIyNGVhODg1MzlkYzhjZmYzOTQyYjQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0c41903a7100ffe122224ea88539dc8cff3942b4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0c41903a7100ffe122224ea88539dc8cff3942b4",
      "tree": {
        "sha": "d5492f87c5a0398392cb787e39d6c4e6345e2025",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d5492f87c5a0398392cb787e39d6c4e6345e2025"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb",
          "sha": "6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/6cfe3f1fad370d22af88b0259e4a5f6ddd5f2afb"
        }
      ],
      "message": "refactor: Add ChainstateManager::m_chainstates member\n\nUse to replace m_active_chainstate, m_ibd_chainstate, and m_snapshot_chainstate\nmembers. This has several benefits:\n\n- Ensures ChainstateManager treats chainstates instances equally, making\n  distinctions based on their attributes, not having special cases and making\n  assumptions based on their identities.\n\n- Normalizes ChainstateManager representation so states that should be\n  impossible to reach and validation code has no handling for (like\n  m_snapshot_chainstate being set and m_ibd_chainstate being unset, or both\n  being set but m_active_chainstate pointing to the m_ibd_chainstate) can no\n  longer be represented.\n\n- Makes ChainstateManager more extensible so new chainstates can be added for\n  different purposes, like indexing or generating and validating assumeutxo\n  snapshots without interrupting regular node operations. With the\n  m_chainstates member new chainstates can be added and handled without needing\n  to make changes all over validation code or copy/paste/modify the existing\n  code that's been already been written to handle m_ibd_chainstate and\n  m_snapshot_chainstate.\n\n- Avoids terms that are confusing and misleading:\n\n  - The term \"active chainstate\" term is confusing because multiple chainstates\n    will be active and in use at the same time. Before a snapshot is validated,\n    wallet code will use the snapshot chainstate, while indexes will use the IBD\n    chainstate, and netorking code will use both chainstates, downloading\n    snapshot blocks at higher priority, but also IBD blocks simultaneously.\n\n  - The term \"snapshot chainstate\" is ambiguous because it could refer either\n    to the chainstate originally loaded from a snapshot, or to the chainstate\n    being used to validate a snapshot that was loaded, or to a chainstate being\n    used to produce a snapshot, but it is arbitrary used to refer the first\n    thing. The terms \"most-work chainstate\" or \"assumed-valid chainstate\" should\n    be less ambiguous ways to refer to chainstates loaded from snapshots.\n\n  - The term \"IDB chainstate\" is not just ambiguous because actively confusing\n    because technically IDB ends and the node is considered synced when the\n    snapshot chainstate finishes syncing, and in practice the IDB chainstate\n    will mostly by synced after IDB is complete. The term \"fully-validated\" is\n    a better way of describing the characteristics and purpose of this\n    chainstate.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T17:26:01Z"
      },
      "sha": "0c41903a7100ffe122224ea88539dc8cff3942b4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI0N2M5ZmY0ZmE1MjEzYzFiMzQ3ZWJkZDhlZTQxNzlkYTcxYTVjZDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7",
      "tree": {
        "sha": "7bf5b1a702f49a22410b94b99f36a7929b759994",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7bf5b1a702f49a22410b94b99f36a7929b759994"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0c41903a7100ffe122224ea88539dc8cff3942b4",
          "sha": "0c41903a7100ffe122224ea88539dc8cff3942b4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0c41903a7100ffe122224ea88539dc8cff3942b4"
        }
      ],
      "message": "refactor: Add ChainstateManager::ActivateBestChains() method\n\nDeduplicate code looping over chainstate objects and calling\nActivateBestChain() and avoid need for code outside ChainstateManager to use\nthe GetAll() method.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T18:52:28Z"
      },
      "sha": "b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRjZWZkMTljMDNmZTk5NzBlMzVjZDRhMWEzZDkzYTM2ZGQwMmYyMWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b",
      "tree": {
        "sha": "193104238bdacfa785e196e4be4aae7a3e42c8db",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/193104238bdacfa785e196e4be4aae7a3e42c8db"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7",
          "sha": "b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b47c9ff4fa5213c1b347ebdd8ee4179da71a5cd7"
        }
      ],
      "message": "refactor: Delete ChainstateManager::GetAll() method\n\nJust use m_chainstates array instead.",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T23:45:14Z"
      },
      "sha": "4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGU4MjE1MmIwM2IwNjVjMzg4MmM5Y2NjMmQyZTM1ZjZkYTEyMTZlYjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e82152b03b065c3882c9ccc2d2e35f6da1216eb5",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e82152b03b065c3882c9ccc2d2e35f6da1216eb5",
      "tree": {
        "sha": "2f8f29a1c04b1c8fc1d1abff8012a764dc34b4be",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2f8f29a1c04b1c8fc1d1abff8012a764dc34b4be"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b",
          "sha": "4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4cefd19c03fe9970e35cd4a1a3d93a36dd02f21b"
        }
      ],
      "message": "refactor: Simplify pruning functions",
      "committer": {
        "name": "TheCharlatan",
        "email": "seb.kung@gmail.com",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "TheCharlatan",
        "email": "seb.kung@gmail.com",
        "date": "2025-03-14T21:19:17Z"
      },
      "sha": "e82152b03b065c3882c9ccc2d2e35f6da1216eb5"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ2NzUyODk2MDY4OWMyOTEzYzEwMWVmNzViYzgzM2U4ZjA0YmQwZjM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/467528960689c2913c101ef75bc833e8f04bd0f3",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/467528960689c2913c101ef75bc833e8f04bd0f3",
      "tree": {
        "sha": "d8012a175535287d379d8eecbcb3f7a16745d246",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d8012a175535287d379d8eecbcb3f7a16745d246"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e82152b03b065c3882c9ccc2d2e35f6da1216eb5",
          "sha": "e82152b03b065c3882c9ccc2d2e35f6da1216eb5",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e82152b03b065c3882c9ccc2d2e35f6da1216eb5"
        }
      ],
      "message": "doc: Improve ChainstateManager documentation, use consistent terms",
      "committer": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2025-03-18T12:36:41Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2024-05-30T23:50:47Z"
      },
      "sha": "467528960689c2913c101ef75bc833e8f04bd0f3"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 16849449200,
      "node_id": "HRFPE_lADOABII586KwuWzzwAAAAPsTjDw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16849449200",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/467528960689c2913c101ef75bc833e8f04bd0f3",
      "created_at": "2025-03-18T21:26:06Z"
    },
    {
      "event": "reviewed",
      "id": 2691157663,
      "node_id": "PRR_kwDOABII586gZ86f",
      "url": null,
      "actor": null,
      "commit_id": "d09b82156ced5d543d08226e8d7b8fda2e0ec532",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Rebased d09b82156ced5d543d08226e8d7b8fda2e0ec532 -> 467528960689c2913c101ef75bc833e8f04bd0f3 ([`pr/cstate.9`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.9) -> [`pr/cstate.10`](https://github.com/ryanofsky/bitcoin/commits/pr/cstate.10), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/cstate.9-rebase..pr/cstate.10)) due to conflict 31961 and implementing various suggestions.\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2685423528\r\n\r\nThanks for the review! I added comments to the `m_chainstates` commits to motivate them better, also added your simplification fe76cc3a04c94ca4fdbb9550d478909f3b13d8ec and implemented other suggestions below.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#pullrequestreview-2691157663",
      "submitted_at": "2025-03-18T21:26:48Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677573399",
      "pull_request_review_id": 2177291599,
      "id": 1677573399,
      "node_id": "PRRC_kwDOABII585j_b0X",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.",
      "created_at": "2024-07-15T09:49:39Z",
      "updated_at": "2024-07-15T11:11:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677573399"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677599944",
      "pull_request_review_id": 2177291599,
      "id": 1677599944,
      "node_id": "PRRC_kwDOABII585j_iTI",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why do you add this function around here instead of using `m_chainstates` as well?",
      "created_at": "2024-07-15T10:13:00Z",
      "updated_at": "2024-07-15T11:11:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677599944",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677599944"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677640152",
      "pull_request_review_id": 2177291599,
      "id": 1677640152,
      "node_id": "PRRC_kwDOABII585j_sHY",
      "diff_hunk": "@@ -535,11 +542,26 @@ class Chainstate\n         ChainstateManager& chainman,\n         std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n \n+    //! Return path to chainstate leveldb directory.\n+    fs::path StoragePath() const;\n+\n     //! Return the current role of the chainstate. See `ChainstateManager`\n     //! documentation for a description of the different types of chainstates.\n     //!\n     //! @sa ChainstateRole\n-    ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    kernel::ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 72,
      "original_position": 80,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Not sure why we need this when in another commit we remove `GetAll()` and instead use `m_chainstates`. Seems kind of inconsistent but maybe I am missing something.",
      "created_at": "2024-07-15T10:51:47Z",
      "updated_at": "2024-07-15T11:11:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677640152",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1677640152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 571,
      "original_line": 571,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252537",
      "pull_request_review_id": 2186500256,
      "id": 1683252537,
      "node_id": "PRRC_kwDOABII585kVGU5",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": 1677599944,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Why do you add this function around here instead of using `m_chainstates` as well?\r\n\r\nI need to double-check but IIRC, the issue is that m_chainstates requires a lock to access, and it would require larger changes and more verbosity in the tests if they had to be changed to access m_chainstates directly. Will follow up and add a comment describing purpose of this function.",
      "created_at": "2024-07-18T17:43:21Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683252537",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252537"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252990",
      "pull_request_review_id": 2186500256,
      "id": 1683252990,
      "node_id": "PRRC_kwDOABII585kVGb-",
      "diff_hunk": "@@ -535,11 +542,26 @@ class Chainstate\n         ChainstateManager& chainman,\n         std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n \n+    //! Return path to chainstate leveldb directory.\n+    fs::path StoragePath() const;\n+\n     //! Return the current role of the chainstate. See `ChainstateManager`\n     //! documentation for a description of the different types of chainstates.\n     //!\n     //! @sa ChainstateRole\n-    ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    kernel::ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 72,
      "original_position": 80,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "493d3844cfc8628fd63184fa7a657126d9b5dc95",
      "in_reply_to_id": 1677640152,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677640152\r\n\r\n> Not sure why we need this when in another commit we remove `GetAll()` and instead use `m_chainstates`. Seems kind of inconsistent but maybe I am missing something.\r\n\r\nIs this comment about the `Validity()` method? This is just supposed to be a public accessor for code that cannot access the private m_validity member/",
      "created_at": "2024-07-18T17:43:36Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683252990",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683252990"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 571,
      "original_line": 571,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683253240",
      "pull_request_review_id": 2186500256,
      "id": 1683253240,
      "node_id": "PRRC_kwDOABII585kVGf4",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": 1677573399,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399\r\n\r\n> nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.\r\n\r\nGood point, at least at first glance this looks reasonable to inline.",
      "created_at": "2024-07-18T17:43:47Z",
      "updated_at": "2024-07-18T18:41:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1683253240",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1683253240"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023046",
      "pull_request_review_id": 2189391816,
      "id": 1685023046,
      "node_id": "PRRC_kwDOABII585kb2lG",
      "diff_hunk": "@@ -29,6 +29,17 @@ using node::BlockManager;\n using node::KernelNotifications;\n using node::SnapshotMetadata;\n \n+static std::vector<Chainstate*> GetAll(const ChainstateManager& chainman)",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ce02d68008c2f61a6033b22df1a5ef54bba38d9f",
      "in_reply_to_id": 1677599944,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677599944\r\n\r\n> Why do you add this function around here instead of using `m_chainstates` as well?\r\n\r\nDropped this function now, it was not hard to get rid of.",
      "created_at": "2024-07-19T21:47:51Z",
      "updated_at": "2024-07-19T21:55:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1685023046",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023046"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 32,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023239",
      "pull_request_review_id": 2189391816,
      "id": 1685023239,
      "node_id": "PRRC_kwDOABII585kb2oH",
      "diff_hunk": "@@ -544,6 +546,18 @@ class Chainstate\n     //! @sa ChainstateRole\n     ChainstateRole GetRole() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return whether chain is fully validated, assumed valid, or invalid.\n+    ChainValidity Validity() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_validity;\n+    }\n+\n+    //! Return true if chainstate fully validated or is assumed valid.\n+    bool IsValid() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 55,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "cdc44e878a859a34dfe0c198641531ec26b0730d",
      "in_reply_to_id": 1677573399,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1677573399\r\n\r\n> nit: In other places similar checks are inlined without a helper method. That might be actually a bit more clear as well.\r\n\r\nYou're right, that is clearer. Updated different places where this was used.\r\n",
      "created_at": "2024-07-19T21:48:04Z",
      "updated_at": "2024-07-19T21:55:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1685023239",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1685023239"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 556,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1986316731",
      "pull_request_review_id": 2669420393,
      "id": 1986316731,
      "node_id": "PRRC_kwDOABII5852ZMm7",
      "diff_hunk": "@@ -3451,10 +3484,10 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n-    // Belt-and-suspenders check that we aren't attempting to advance the background\n-    // chainstate past the snapshot base block.\n-    if (WITH_LOCK(::cs_main, return m_disabled)) {\n-        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. \"\n+    // Belt-and-suspenders check that we aren't attempting to advance the\n+    // chainstate past the target block.\n+    if (WITH_LOCK(::cs_main, return m_target_utxohash)) {\n+        LogPrintf(\"m_target_utxohash is set - this chainstate should not be in operation. \"",
      "path": "src/validation.cpp",
      "position": 144,
      "original_position": 126,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've always been a bit puzzled of this check. Is it really required? If so, why don't we need to check it on every iteration of the do loop further down? What if it is actually reached, will validation on that chain just always be stuck in an unrecoverable state? Wouldn't a fatal error be more appropriate then?",
      "created_at": "2025-03-09T12:57:19Z",
      "updated_at": "2025-03-09T12:57:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1986316731",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1986316731"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3524,
      "original_line": 3524,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1987579951",
      "pull_request_review_id": 2671479089,
      "id": 1987579951,
      "node_id": "PRRC_kwDOABII5852eBAv",
      "diff_hunk": "@@ -3451,10 +3484,10 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n-    // Belt-and-suspenders check that we aren't attempting to advance the background\n-    // chainstate past the snapshot base block.\n-    if (WITH_LOCK(::cs_main, return m_disabled)) {\n-        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. \"\n+    // Belt-and-suspenders check that we aren't attempting to advance the\n+    // chainstate past the target block.\n+    if (WITH_LOCK(::cs_main, return m_target_utxohash)) {\n+        LogPrintf(\"m_target_utxohash is set - this chainstate should not be in operation. \"",
      "path": "src/validation.cpp",
      "position": 144,
      "original_position": 126,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7fd7960389254c7a2ba50614e1cbdf8911ef6a7d",
      "in_reply_to_id": 1986316731,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1986316731\r\n\r\n> I've always been a bit puzzled of this check. Is it really required? If so, why don't we need to check it on every iteration of the do loop further down? What if it is actually reached, will validation on that chain just always be stuck in an unrecoverable state? Wouldn't a fatal error be more appropriate then?\r\n\r\nThis is labeled as \"Belt-and-suspenders check\" so it should be safe to assume that it is not required. Sometimes it is useful to have checks for unexpected states that should never happen, so it is possible to detect bugs that may otherwise go unnoticed, or to provide better debug information if the unexpected state does lead to a problem later. \r\n\r\nSometimes unexpected states should trigger asserts or fatal errors, but sometimes they don't need to be fatal and can just trigger warnings like this one. In this case the unexpected state may cause the current snapshot to never get fully validated (if the background chainstate is disabled), but since the node will still be functional, and the user might be able to recover from it by loading another snapshot, maybe it is not worth causing a fatal error. Also it might make sense to have this check at the top of this function not in the loop below because it is checking a precondition: looking for an invalid state set by previous code, not invalid state set by this code. It may be possible to improve this by adding other checks, though. And it would probably be good to use `if (Assume(...))` here so if this condition is reached it will be detected in fuzz and debug builds.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
      "created_at": "2025-03-10T15:53:28Z",
      "updated_at": "2025-03-10T15:53:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1987579951",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1987579951"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3524,
      "original_line": 3524,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995503615",
      "pull_request_review_id": 2685423528,
      "id": 1995503615,
      "node_id": "PRRC_kwDOABII58528Pf_",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 502,
      "original_position": 139,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit 22bfd948f0d45083748724a304fa2c8482464028:\r\nJust a note: The removal of this particular check in this commit seems a bit random with all the following kind of redundant assertions, but the code does get cleaned up in later commits.",
      "created_at": "2025-03-14T12:52:06Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995503615",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995503615"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6112,
      "original_line": 6112,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995511334",
      "pull_request_review_id": 2685423528,
      "id": 1995511334,
      "node_id": "PRRC_kwDOABII58528RYm",
      "diff_hunk": "@@ -6161,14 +6182,7 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n         GetNotifications().fatalError(user_error);\n     };\n \n-    if (index_new.GetBlockHash() != snapshot_blockhash) {\n-        LogPrintf(\"[snapshot] supposed base block %s does not match the \"\n-          \"snapshot base block %s (height %d). Snapshot is not valid.\\n\",\n-          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n-        handle_invalid_snapshot();\n-        return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;",
      "path": "src/validation.cpp",
      "position": 549,
      "original_position": 166,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think this `SnapshotcompletionResult` variant can be removed, no?",
      "created_at": "2025-03-14T12:56:23Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995511334",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995511334"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6157,
      "original_line": 6157,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995597388",
      "pull_request_review_id": 2685423528,
      "id": 1995597388,
      "node_id": "PRRC_kwDOABII58528mZM",
      "diff_hunk": "@@ -1136,7 +1139,7 @@ class ChainstateManager\n     Chainstate* HistoricalChainstate() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex())\n     {\n         auto* cs{m_ibd_chainstate.get()};\n-        return IsUsable(cs) && cs->m_target_blockhash ? cs : nullptr;\n+        return cs && cs->Validity() != ChainValidity::INVALID && cs->m_target_blockhash && !cs->m_target_utxohash ? cs : nullptr;",
      "path": "src/validation.h",
      "position": null,
      "original_position": 96,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "9853c8384e1df9ad14c2801e780cc189ac20c6d0",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit 9853c8384e1df9ad14c2801e780cc189ac20c6d0:\r\nIs the validity check required? AFAICT the historic chainstate is never invalid.",
      "created_at": "2025-03-14T13:37:00Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995597388",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995597388"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995921074",
      "pull_request_review_id": 2685423528,
      "id": 1995921074,
      "node_id": "PRRC_kwDOABII585291ay",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers",
      "path": "src/kernel/types.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: Are we still doing `-present` now? I thought I saw some discussion about that recently, but can't find it anymore.",
      "created_at": "2025-03-14T16:52:32Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995921074",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995921074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995924122",
      "pull_request_review_id": 2685423528,
      "id": 1995924122,
      "node_id": "PRRC_kwDOABII585292Ka",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 20,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: `s/if is/if it is/`. I think there are some missing articles around here too.",
      "created_at": "2025-03-14T16:53:52Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995924122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995924122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995939302",
      "pull_request_review_id": 2685423528,
      "id": 1995939302,
      "node_id": "PRRC_kwDOABII5852953m",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an\n+    //! assumeutxo snapshot chainstate that has not been validated yet.\n+    bool validated{true};\n+\n+    //! Whether this a historical chainstate downloading old blocks to validate",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 24,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit: `s/this a/this is a/`",
      "created_at": "2025-03-14T16:58:26Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995939302",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1995939302"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996212305",
      "pull_request_review_id": 2685423528,
      "id": 1996212305,
      "node_id": "PRRC_kwDOABII5852-8hR",
      "diff_hunk": "@@ -3927,7 +3927,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n     // m_chain_tx_count value is not zero, assert that value is actually correct.\n     auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n     if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n-                pindexNew == CurrentChainstate().SnapshotBase())) {\n+                std::any_of(m_chainstates.begin(), m_chainstates.end(), [&](auto& cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->SnapshotBase() == pindexNew; }))) {",
      "path": "src/validation.cpp",
      "position": 211,
      "original_position": 14,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "5e22fdcdb2665c0bb5e47c53719796096afe2dd1",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't quite follow this change. What is wrong with using `CurrentChainstate` here?",
      "created_at": "2025-03-14T20:07:06Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996212305",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996212305"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3930,
      "original_line": 3930,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996244623",
      "pull_request_review_id": 2685423528,
      "id": 1996244623,
      "node_id": "PRRC_kwDOABII5852_EaP",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why is this not re-used for `ProcessNewBlock`?",
      "created_at": "2025-03-14T20:36:29Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996244623",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996244623"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996247059",
      "pull_request_review_id": 2685423528,
      "id": 1996247059,
      "node_id": "PRRC_kwDOABII5852_FAT",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const\n+{\n+    // We can't hold cs_main during ActivateBestChain even though we're accessing\n+    // the chainman unique_ptrs since ABC requires us not to be holding cs_main, so retrieve\n+    // the relevant pointers before the ABC call.\n+    std::vector<Chainstate*> chainstates;\n+    {\n+        LOCK(GetMutex());\n+        for (auto& chainstate : m_chainstates) {\n+            chainstates.emplace_back(chainstate.get());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Shouldn't this skip over the historical chainstate if `m_target_utxohash` is set?",
      "created_at": "2025-03-14T20:38:48Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996247059",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996247059"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996249639",
      "pull_request_review_id": 2685423528,
      "id": 1996249639,
      "node_id": "PRRC_kwDOABII5852_Fon",
      "diff_hunk": "@@ -310,8 +310,9 @@ void BlockManager::FindFilesToPrune(\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n     // Distribute our -prune budget over all chainstates.\n+    const int num_chainstates{chainman.HistoricalChainstate() ? 2 : 1};",
      "path": "src/node/blockstorage.cpp",
      "position": 43,
      "original_position": 4,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm surprised this is not just taking the `m_chainstates` size. Why is that?",
      "created_at": "2025-03-14T20:40:59Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996249639",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996249639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 317,
      "original_line": 317,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996263354",
      "pull_request_review_id": 2685423528,
      "id": 1996263354,
      "node_id": "PRRC_kwDOABII5852_I-6",
      "diff_hunk": "@@ -365,15 +369,17 @@ struct SnapshotTestSetup : TestChain100Setup {\n \n         BOOST_TEST_MESSAGE(\"Simulating node restart\");\n         {\n-            for (Chainstate* cs : chainman.GetAll()) {\n-                LOCK(::cs_main);\n-                cs->ForceFlushStateToDisk();\n+            LOCK(::cs_main);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 76,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": null,
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm a bit confused when it is appropriate to use `::cs_main` and when `chainman.GetMutex()`. Is there a rule to that?",
      "created_at": "2025-03-14T20:52:50Z",
      "updated_at": "2025-03-14T21:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996263354",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1996263354"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999102885",
      "pull_request_review_id": 2691157663,
      "id": 1999102885,
      "node_id": "PRRC_kwDOABII5853J-Ol",
      "diff_hunk": "@@ -6161,14 +6182,7 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n         GetNotifications().fatalError(user_error);\n     };\n \n-    if (index_new.GetBlockHash() != snapshot_blockhash) {\n-        LogPrintf(\"[snapshot] supposed base block %s does not match the \"\n-          \"snapshot base block %s (height %d). Snapshot is not valid.\\n\",\n-          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n-        handle_invalid_snapshot();\n-        return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;",
      "path": "src/validation.cpp",
      "position": 549,
      "original_position": 166,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995511334,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995511334\r\n\r\n> I think this `SnapshotcompletionResult` variant can be removed, no?\r\n\r\nGood catch, removed.",
      "created_at": "2025-03-17T16:04:13Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999102885",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999102885"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6157,
      "original_line": 6157,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999111743",
      "pull_request_review_id": 2691157663,
      "id": 1999111743,
      "node_id": "PRRC_kwDOABII5853KAY_",
      "diff_hunk": "@@ -6112,20 +6131,19 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation()\n     if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n             !this->IsUsable(m_snapshot_chainstate.get()) ||\n             !this->IsUsable(m_ibd_chainstate.get()) ||\n-            !m_ibd_chainstate->m_chain.Tip()) {\n-       // Nothing to do - this function only applies to the background\n-       // validation chainstate.\n+            !m_ibd_chainstate->m_target_blockhash ||\n+            !m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            *m_ibd_chainstate->m_target_blockhash != *m_snapshot_chainstate->m_from_snapshot_blockhash ||\n+            !m_ibd_chainstate->m_chain.Tip() ||\n+            !m_ibd_chainstate->ReachedTarget()) {\n+       // If validated chainstate is not targeting the snapshot block, or has\n+       // not reached the target block, or the snapshot is already validated,\n+       // there is nothing to do.\n        return SnapshotCompletionResult::SKIPPED;\n     }\n     const int snapshot_tip_height = this->ActiveHeight();\n     const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n     const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n-\n-    if (index_new.nHeight < snapshot_base_height) {",
      "path": "src/validation.cpp",
      "position": 502,
      "original_position": 139,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "22bfd948f0d45083748724a304fa2c8482464028",
      "in_reply_to_id": 1995503615,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995503615\r\n\r\n> In commit [22bfd94](https://github.com/bitcoin/bitcoin/commit/22bfd948f0d45083748724a304fa2c8482464028): Just a note: The removal of this particular check in this commit seems a bit random with all the following kind of redundant assertions, but the code does get cleaned up in later commits.\r\n\r\nWe might be noticing different things here so let me know if you have suggestions for improving this, but I don't think this change is random. This is replacing the `index_new.nHeight < snapshot_base_height` check with a `ReachedTarget()` check, and combining the `return SKIPPED` it triggers with the earlier one with a more complete comment about when SKIPPED is returned.\r\n\r\nThe other changes to this function that happen in later commit don't really affect these things, they just pass new parameters into this function so it can be more independent of ChainstateManager.",
      "created_at": "2025-03-17T16:06:10Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999111743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999111743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 6112,
      "original_line": 6112,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999397249",
      "pull_request_review_id": 2691157663,
      "id": 1999397249,
      "node_id": "PRRC_kwDOABII5853LGGB",
      "diff_hunk": "@@ -1136,7 +1139,7 @@ class ChainstateManager\n     Chainstate* HistoricalChainstate() const EXCLUSIVE_LOCKS_REQUIRED(GetMutex())\n     {\n         auto* cs{m_ibd_chainstate.get()};\n-        return IsUsable(cs) && cs->m_target_blockhash ? cs : nullptr;\n+        return cs && cs->Validity() != ChainValidity::INVALID && cs->m_target_blockhash && !cs->m_target_utxohash ? cs : nullptr;",
      "path": "src/validation.h",
      "position": null,
      "original_position": 96,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "9853c8384e1df9ad14c2801e780cc189ac20c6d0",
      "in_reply_to_id": 1995597388,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995597388\r\n\r\n> In commit [9853c83](https://github.com/bitcoin/bitcoin/commit/9853c8384e1df9ad14c2801e780cc189ac20c6d0): Is the validity check required? AFAICT the historic chainstate is never invalid.\r\n\r\nThat's true. This anticipates a later change but there is no reason to add that complexity here. Dropped this condition.",
      "created_at": "2025-03-17T18:35:07Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999397249",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999397249"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999444438",
      "pull_request_review_id": 2691157663,
      "id": 1999444438,
      "node_id": "PRRC_kwDOABII5853LRnW",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers",
      "path": "src/kernel/types.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995921074,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995921074\r\n\r\n> Nit: Are we still doing `-present` now? I thought I saw some discussion about that recently, but can't find it anymore.\r\n\r\nThe change to \"present\" never made sense to me because I think the only thing \"present\" could mean is \"when this line was written\", not what we might want it to mean like \"whenever the code here was last modified\" or \"whenever the code here was published.\"\r\n\r\nSince \"present\" just seems like a more ambiguous way of writing the current year, I'd be inclined to stick with a more a conventional approach. But I'm happy to change if the project wants to make a wider switch to \"present\" or someone can explain why writing \"present\" is better than writing the current year and never updating it. I couldn't find much discussion about this topic, but https://opensource.stackexchange.com/questions/4885/copyright-until-the-present-year-in-bsd-license seems to back up my suspicions here.",
      "created_at": "2025-03-17T19:04:43Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999444438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999444438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999459380",
      "pull_request_review_id": 2691157663,
      "id": 1999459380,
      "node_id": "PRRC_kwDOABII5853LVQ0",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 20,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995924122,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995924122\r\n\r\n> Nit: `s/if is/if it is/`. I think there are some missing articles around here too.\r\n\r\nThanks, fixed up various comments in this header.",
      "created_at": "2025-03-17T19:16:11Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999459380",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999459380"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999460229",
      "pull_request_review_id": 2691157663,
      "id": 1999460229,
      "node_id": "PRRC_kwDOABII5853LVeF",
      "diff_hunk": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2024 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+//! @file kernel/types.h is a home for simple enum and struct type definitions\n+//! that can be used internally by functions in the libbitcoin_kernel library,\n+//! but also used externally by node, wallet, and GUI code.\n+//!\n+//! This file is intended to define only simple types that do not have external\n+//! dependencies. More complicated types should be defined in dedicated header\n+//! files.\n+\n+#ifndef BITCOIN_KERNEL_TYPES_H\n+#define BITCOIN_KERNEL_TYPES_H\n+\n+namespace kernel {\n+//! Information about chainstate that notifications are sent from.\n+struct ChainstateRole {\n+    //! Whether this is a notification from chainstate that's been fully\n+    //! validated starting from the genesis block. False if is from an\n+    //! assumeutxo snapshot chainstate that has not been validated yet.\n+    bool validated{true};\n+\n+    //! Whether this a historical chainstate downloading old blocks to validate",
      "path": "src/kernel/types.h",
      "position": null,
      "original_position": 24,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "7e9ee9345ad86bfdc60c7d46b1ee4bce96cc558e",
      "in_reply_to_id": 1995939302,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1995939302\r\n\r\n> Nit: `s/this a/this is a/`\r\n\r\nThanks, fixed",
      "created_at": "2025-03-17T19:16:54Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1999460229",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1999460229"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001593749",
      "pull_request_review_id": 2691157663,
      "id": 2001593749,
      "node_id": "PRRC_kwDOABII5853TeWV",
      "diff_hunk": "@@ -3927,7 +3927,7 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n     // m_chain_tx_count value is not zero, assert that value is actually correct.\n     auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n     if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n-                pindexNew == CurrentChainstate().SnapshotBase())) {\n+                std::any_of(m_chainstates.begin(), m_chainstates.end(), [&](auto& cs) EXCLUSIVE_LOCKS_REQUIRED(cs_main) { return cs->SnapshotBase() == pindexNew; }))) {",
      "path": "src/validation.cpp",
      "position": 211,
      "original_position": 14,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "5e22fdcdb2665c0bb5e47c53719796096afe2dd1",
      "in_reply_to_id": 1996212305,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::m_chainstates member\" (5e22fdcdb2665c0bb5e47c53719796096afe2dd1)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996212305\r\n\r\n> I don't quite follow this change. What is wrong with using `CurrentChainstate` here?\r\n\r\nIMO chainstatemanager should generally just validate and update chainstates with incoming data and not rely on concept of a \"current\" chainstate. The concept of a current chainstate is a little vague and makes more sense at the appilcation level than this level. For example wallets will treat chainstates loaded from assumeutxo snapshots as the current chainstate while indexes ignore that chainstate and treat the fully validated background chainstate as the current one.\r\n\r\nMore specifically in this case avoiding `CurrentChainstate()` makes this code more correct, and would avoid a failed Assume check and a warning if multiple snapshot chainstates were loaded, since loading a snapshot updates the snapshots block's `m_chain_tx_count` value when when the previous block may have a 0 value. (We don't currently support loading multiple snapshot chainstates now, but there is no reason we could not allow it in the future, for example to support loading a new snapshot after an older one has been loaded.)",
      "created_at": "2025-03-18T17:30:05Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001593749",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001593749"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3930,
      "original_line": 3930,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594093",
      "pull_request_review_id": 2691157663,
      "id": 2001594093,
      "node_id": "PRRC_kwDOABII5853Tebt",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": 1996244623,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::ActivateBestChains() method\" (58265b955a3d8622f22958943f79409129d58b36)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996244623\r\n\r\n> Why is this not re-used for `ProcessNewBlock`?\r\n\r\n`ProcessNewBlock()` passes a non-null block pointer to `ActivateBestChain` so it can't directly reuse the new method. It might make sense for generalize the method, but the main goal here to get rid of unnecessary uses of ChainstateManager::GetAll() by outside code, so it's a bit outside the scope of what this particular commit is trying to do.",
      "created_at": "2025-03-18T17:30:13Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594093",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594093"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6510,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594456",
      "pull_request_review_id": 2691157663,
      "id": 2001594456,
      "node_id": "PRRC_kwDOABII5853TehY",
      "diff_hunk": "@@ -6514,3 +6506,24 @@ std::optional<std::pair<const CBlockIndex*, const CBlockIndex*>> ChainstateManag\n     if (!chainstate) return {};\n     return std::make_pair(chainstate->m_chain.Tip(), chainstate->TargetBlock());\n }\n+\n+util::Result<void> ChainstateManager::ActivateBestChains() const\n+{\n+    // We can't hold cs_main during ActivateBestChain even though we're accessing\n+    // the chainman unique_ptrs since ABC requires us not to be holding cs_main, so retrieve\n+    // the relevant pointers before the ABC call.\n+    std::vector<Chainstate*> chainstates;\n+    {\n+        LOCK(GetMutex());\n+        for (auto& chainstate : m_chainstates) {\n+            chainstates.emplace_back(chainstate.get());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "58265b955a3d8622f22958943f79409129d58b36",
      "in_reply_to_id": 1996247059,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Add ChainstateManager::ActivateBestChains() method\" (58265b955a3d8622f22958943f79409129d58b36)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996247059\r\n\r\n> Shouldn't this skip over the historical chainstate if `m_target_utxohash` is set?\r\n\r\nYes good catch. Updated this to be equivalent.",
      "created_at": "2025-03-18T17:30:21Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594456",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594456"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6519,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594940",
      "pull_request_review_id": 2691157663,
      "id": 2001594940,
      "node_id": "PRRC_kwDOABII5853Teo8",
      "diff_hunk": "@@ -310,8 +310,9 @@ void BlockManager::FindFilesToPrune(\n {\n     LOCK2(cs_main, cs_LastBlockFile);\n     // Distribute our -prune budget over all chainstates.\n+    const int num_chainstates{chainman.HistoricalChainstate() ? 2 : 1};",
      "path": "src/node/blockstorage.cpp",
      "position": 43,
      "original_position": 4,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": 1996249639,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Delete ChainstateManager::GetAll() method\" (ca48478fbfcc83cc6f8c928e57800707fe0c3b51)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996249639\r\n\r\n> I'm surprised this is not just taking the `m_chainstates` size. Why is that?\r\n\r\nWrote a better comment since existing comment wasn't really explaining what was happening here. It's possible this code might need to be updated to customize pruning behavior if more chainstates are added in the future. But I think default behavior should just be to reserve block storage for the two chainstates we know about: the most-work chainstate and a historical chainstate, not to reserve storage for an arbitrary number of chainstates which may or may not need it.",
      "created_at": "2025-03-18T17:30:32Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001594940",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001594940"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 317,
      "original_line": 317,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001595381",
      "pull_request_review_id": 2691157663,
      "id": 2001595381,
      "node_id": "PRRC_kwDOABII5853Tev1",
      "diff_hunk": "@@ -365,15 +369,17 @@ struct SnapshotTestSetup : TestChain100Setup {\n \n         BOOST_TEST_MESSAGE(\"Simulating node restart\");\n         {\n-            for (Chainstate* cs : chainman.GetAll()) {\n-                LOCK(::cs_main);\n-                cs->ForceFlushStateToDisk();\n+            LOCK(::cs_main);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 76,
      "commit_id": "467528960689c2913c101ef75bc833e8f04bd0f3",
      "original_commit_id": "ca48478fbfcc83cc6f8c928e57800707fe0c3b51",
      "in_reply_to_id": 1996263354,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"refactor: Delete ChainstateManager::GetAll() method\" (ca48478fbfcc83cc6f8c928e57800707fe0c3b51)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/30214#discussion_r1996263354\r\n\r\n> I'm a bit confused when it is appropriate to use `::cs_main` and when `chainman.GetMutex()`. Is there a rule to that?\r\n\r\nI don't really make any distinction between the two but probably it's better to use the latter so switched to that in these tests",
      "created_at": "2025-03-18T17:30:41Z",
      "updated_at": "2025-03-18T21:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30214#discussion_r2001595381",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2001595381"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30214"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 372,
      "side": "RIGHT"
    }
  ]
}