{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
    "id": 1363708248,
    "node_id": "PR_kwDOABII585RSIlY",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/27746",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/27746.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/27746.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/a733dd79e29068ad1e0532ac42a45188a040a7b9",
    "number": 27746,
    "state": "closed",
    "locked": true,
    "maintainer_can_modify": false,
    "title": "Rework validation logic for assumeutxo",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This PR proposes a clean up of the relationship between block storage and the chainstate objects, by moving the decision of whether to store a block on disk to something that is not chainstate-specific.  Philosophically, the decision of whether to store a block on disk is related to validation rules that do not require any UTXO state; for anti-DoS reasons we were using some chainstate-specific heuristics, and those have been reworked here to achieve the proposed separation.\r\n\r\nThis PR also fixes a bug in how a chainstate's `setBlockIndexCandidates` was being initialized; it should always have all the HAVE_DATA block index entries that have more work than the chain tip.  During startup, we were not fully populating `setBlockIndexCandidates` in some scenarios involving multiple chainstates.\r\n\r\nFurther, this PR establishes a concept that whenever we have 2 chainstates, that we always know the snapshotted chain's base block and the base block's hash must be an element of our block index. Given that, we can establish a new invariant that the background validation chainstate only needs to consider blocks leading to that snapshotted block entry as potential candidates for its tip. As a followup I would imagine that when writing net_processing logic to download blocks for the background chainstate, that we would use this concept to only download blocks towards the snapshotted entry as well.",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2023-05-24T19:57:32Z",
    "updated_at": "2024-09-10T20:44:40Z",
    "closed_at": "2023-07-31T20:18:35Z",
    "mergeable_state": "unknown",
    "merged_at": "2023-07-31T20:18:34Z",
    "merge_commit_sha": "f4f1d6d230dd390f0524b8852b8cfc912d006958",
    "assignees": [],
    "requested_reviewers": [
      {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      }
    ],
    "requested_teams": [],
    "head": {
      "label": "sdaftuar:2023-05-assumeutxo-validation-improvements",
      "ref": "2023-05-assumeutxo-validation-improvements",
      "sha": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 28761781,
        "node_id": "MDEwOlJlcG9zaXRvcnkyODc2MTc4MQ==",
        "name": "bitcoin",
        "full_name": "sdaftuar/bitcoin",
        "owner": {
          "login": "sdaftuar",
          "id": 7463573,
          "node_id": "MDQ6VXNlcjc0NjM1NzM=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sdaftuar",
          "html_url": "https://github.com/sdaftuar",
          "followers_url": "https://api.github.com/users/sdaftuar/followers",
          "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
          "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
          "repos_url": "https://api.github.com/users/sdaftuar/repos",
          "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/sdaftuar/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sdaftuar/bitcoin",
        "archive_url": "https://api.github.com/repos/sdaftuar/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sdaftuar/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sdaftuar/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sdaftuar/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sdaftuar/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sdaftuar/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sdaftuar/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sdaftuar/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sdaftuar/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sdaftuar/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sdaftuar/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sdaftuar/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sdaftuar/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sdaftuar/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sdaftuar/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sdaftuar/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sdaftuar/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sdaftuar/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sdaftuar/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sdaftuar/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sdaftuar/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sdaftuar/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sdaftuar/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sdaftuar/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sdaftuar/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sdaftuar/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sdaftuar/bitcoin/hooks",
        "svn_url": "https://github.com/sdaftuar/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 278769,
        "default_branch": "master",
        "open_issues_count": 1,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-09-05T23:33:32Z",
        "created_at": "2015-01-04T02:52:13Z",
        "updated_at": "2024-02-09T22:47:48Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "d23fda05842ba4539b225bbab01b94df0060f697",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36149,
        "stargazers_count": 78311,
        "watchers_count": 78311,
        "size": 268185,
        "default_branch": "master",
        "open_issues_count": 666,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-09-10T19:41:41Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-09-10T20:21:22Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 378,
    "deletions": 254,
    "changed_files": 14,
    "commits": 13,
    "review_comments": 163,
    "comments": 18
  },
  "events": [
    {
      "event": "commented",
      "id": 1561858383,
      "node_id": "IC_kwDOABII585dGBFP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T20:05:01Z",
      "updated_at": "2023-05-24T20:05:01Z",
      "author_association": "MEMBER",
      "body": "Great! Thanks for this. I'm active in these neighborhoods today as well, since adding some `-stopatheight`/restart logic to the functional tests in #27596 has turned up some issues with `CheckBlockIndex()`, which are maybe related to some of the changes here. So I'll be looking at this shortly.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1561858383",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "labeled",
      "id": 9332774600,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIsRtbI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9332774600",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T21:14:58Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9333086286,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAIsS5hO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9333086286",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T21:55:45Z"
    },
    {
      "event": "unlabeled",
      "id": 9333565467,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAIsUugb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9333565467",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-24T23:18:48Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1562326140,
      "node_id": "IC_kwDOABII585dHzR8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-25T06:05:23Z",
      "updated_at": "2023-07-31T20:07:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1652419820), [jamesob](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1552660659), [Sjors](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553302075), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1555524219) |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1485874548) |\n| Stale ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1512960883), [mzumsande](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1544102750) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28052](https://github.com/bitcoin/bitcoin/pull/28052) (blockstorage: XOR blocksdir *.dat files by MarcoFalke)\n* [#27866](https://github.com/bitcoin/bitcoin/pull/27866) (blockstorage: Return on fatal flush errors by TheCharlatan)\n* [#27460](https://github.com/bitcoin/bitcoin/pull/27460) (rpc: Add importmempool RPC by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1562326140",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "commented",
      "id": 1570566067,
      "node_id": "IC_kwDOABII585dnO-z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-05-31T16:41:24Z",
      "updated_at": "2023-05-31T16:41:24Z",
      "author_association": "MEMBER",
      "body": "The first two commits up to f50fa248f1d904be5f33a29c837f74a2cca8abc0 look good to me.\r\n\r\nHow do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n\r\n> Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nIn any case moving `AcceptBlock` from `Chainstate` to `ChainstateManager` seems an improvement.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1570566067",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "reviewed",
      "id": 1453921658,
      "node_id": "PRR_kwDOABII585WqRV6",
      "url": null,
      "actor": null,
      "commit_id": "379467ac0a8b73035f83f957396bda1255873c2f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "If you can split 534b6f99a3779465678f39ed2704da6049c6469d in ~half that would make it a bit easier to review. Maybe start with anything that's trivial to move, and then do the more involved changes in the second commit.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1453921658",
      "submitted_at": "2023-05-31T18:44:51Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1453931065,
      "node_id": "PRR_kwDOABII585WqTo5",
      "url": null,
      "actor": null,
      "commit_id": "379467ac0a8b73035f83f957396bda1255873c2f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1453931065",
      "submitted_at": "2023-05-31T19:10:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "labeled",
      "id": 9414285155,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIxIpdj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9414285155",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-02T13:25:10Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "commented",
      "id": 1577187405,
      "node_id": "IC_kwDOABII585eAfhN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-05T17:23:57Z",
      "updated_at": "2023-06-05T17:23:57Z",
      "author_association": "MEMBER",
      "body": "> How do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n> \r\n> > Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nI think of `BlockManager` as being a generic backend database of block (and undo) data, while any validation-related logic should live in `Chainstate` (if it relies on chainstate-specific information) or somewhere else (either a static function in validation or in `ChainstateManager` as I propose here) if not.\r\n\r\nI think `AcceptBlock` could also be a static function in `validation.cpp`; I mostly just wanted to get it out of `Chainstate` because I think that having block storage be coupled to a particular chainstate is a confusing idea, but I can go either way on whether it belongs in ChainstateManager or not.",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1577187405",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9451556627,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAIzW08T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9451556627",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-06T22:41:59Z"
    },
    {
      "event": "labeled",
      "id": 9451878107,
      "node_id": "LE_lADOABII585mzBjvzwAAAAIzYDbb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9451878107",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-06T23:46:09Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9491330275,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI1ujTj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9491330275",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-10T17:46:20Z"
    },
    {
      "event": "unsubscribed",
      "id": 9491485367,
      "node_id": "UE_lADOABII585mzBjvzwAAAAI1vJK3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9491485367",
      "actor": {
        "login": "joostjager",
        "id": 4638168,
        "node_id": "MDQ6VXNlcjQ2MzgxNjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4638168?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/joostjager",
        "html_url": "https://github.com/joostjager",
        "followers_url": "https://api.github.com/users/joostjager/followers",
        "following_url": "https://api.github.com/users/joostjager/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/joostjager/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/joostjager/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/joostjager/subscriptions",
        "organizations_url": "https://api.github.com/users/joostjager/orgs",
        "repos_url": "https://api.github.com/users/joostjager/repos",
        "events_url": "https://api.github.com/users/joostjager/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/joostjager/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-10T19:12:42Z"
    },
    {
      "event": "reviewed",
      "id": 1475849986,
      "node_id": "PRR_kwDOABII585X968C",
      "url": null,
      "actor": null,
      "commit_id": "0c447332e7587d901f4dfc20256685a18a5486ab",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1475849986",
      "submitted_at": "2023-06-12T21:31:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9518944602,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI3X5Fa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9518944602",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:05:13Z"
    },
    {
      "event": "commented",
      "id": 1589777766,
      "node_id": "IC_kwDOABII585ewhVm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1589777766",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:04Z",
      "updated_at": "2023-06-13T17:54:04Z",
      "author_association": "MEMBER",
      "body": "@sjors @achow101 Thanks for the review! I split up the big commit as @sjors suggested, and with the test fixes I think this is ready to be moved out of Draft status.\r\n",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1589777766",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9519408869,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI3Zqbl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519408869",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:04Z"
    },
    {
      "event": "subscribed",
      "id": 9519408883,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI3Zqbz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519408883",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:04Z"
    },
    {
      "event": "mentioned",
      "id": 9519408900,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI3ZqcE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519408900",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:04Z"
    },
    {
      "event": "subscribed",
      "id": 9519408913,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI3ZqcR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519408913",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:04Z"
    },
    {
      "event": "ready_for_review",
      "id": 9519409119,
      "node_id": "RFRE_lADOABII585mzBjvzwAAAAI3Zqff",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519409119",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:54:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9519465466,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI3Z4P6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519465466",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T17:59:49Z"
    },
    {
      "event": "renamed",
      "id": 9519478079,
      "node_id": "RTE_lADOABII585mzBjvzwAAAAI3Z7U_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9519478079",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-13T18:01:08Z",
      "rename": {
        "from": "Draft: rework validation logic for assumeutxo",
        "to": "Rework validation logic for assumeutxo"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9530166759,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI4Cs3n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9530166759",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-14T15:15:21Z"
    },
    {
      "event": "unlabeled",
      "id": 9531299286,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAI4HBXW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9531299286",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-14T17:02:59Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1478071545,
      "node_id": "PRR_kwDOABII585YGZT5",
      "url": null,
      "actor": null,
      "commit_id": "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1478071545",
      "submitted_at": "2023-06-14T21:59:37Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9543612726,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI41_k2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9543612726",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-15T18:22:36Z"
    },
    {
      "event": "reviewed",
      "id": 1484375498,
      "node_id": "PRR_kwDOABII585YecXK",
      "url": null,
      "actor": null,
      "commit_id": "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1484375498",
      "submitted_at": "2023-06-16T21:16:29Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1483231139,
      "node_id": "PRR_kwDOABII585YaE-j",
      "url": null,
      "actor": null,
      "commit_id": "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Partial code review ACK f02125f1c7ba1c77c6d4ddb028999090fe5298eb. I've looked at most of this, but not the whole thing yet, and all the changes seem very nice. This should help avoid bugs and make assumeutxo code more maintainable. I think it would be good to clean up documentation as part of this too. Here are documentation changes I would suggest:\r\n\r\n```diff\r\n--- a/doc/design/assumeutxo.md\r\n+++ b/doc/design/assumeutxo.md\r\n@@ -17,10 +17,9 @@ respectively generate and load UTXO snapshots. The utility script\r\n \r\n - A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\r\n   index entries that are required to be assumed-valid by a chainstate created\r\n-  from a UTXO snapshot. This flag is mostly used as a way to modify certain\r\n+  from a UTXO snapshot. This flag is used as a way to modify certain\r\n   CheckBlockIndex() logic to account for index entries that are pending validation by a\r\n-  chainstate running asynchronously in the background. We also use this flag to control\r\n-  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\r\n+  chainstate running asynchronously in the background.\r\n \r\n - The concept of UTXO snapshots is treated as an implementation detail that lives\r\n   behind the ChainstateManager interface. The external presentation of the changes\r\ndiff --git a/src/chain.h b/src/chain.h\r\nindex f5dd0fd31514..cb8bc7f04792 100644\r\n--- a/src/chain.h\r\n+++ b/src/chain.h\r\n@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\r\n     BLOCK_VALID_TRANSACTIONS =    3,\r\n \r\n     //! Outputs do not overspend inputs, no double spends, coinbase output ok, no immature coinbase spends, BIP30.\r\n-    //! Implies all parents are also at least CHAIN.\r\n+    //! Implies all parents are either at least VALID_CHAIN, or are ASSUMED_VALID\r\n     BLOCK_VALID_CHAIN        =    4,\r\n \r\n-    //! Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\r\n+    //! Scripts & signatures ok. Implies all parents are either at least VALID_SCRIPTS, or are ASSUMED_VALID.\r\n     BLOCK_VALID_SCRIPTS      =    5,\r\n \r\n     //! All validity bits.\r\n@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\r\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\r\n \r\n     /**\r\n-     * If set, this indicates that the block index entry is assumed-valid.\r\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\r\n-     * It almost certainly means that the block's full validation is pending\r\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\r\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\r\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\r\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated\r\n+     * based on an assumeutxo snapshot.\r\n+     *\r\n+     * When an assumeutxo snapshot is loaded, the ASSUMED_VALID flag is added to\r\n+     * unvalidated blocks below the snapshot height. Then, as the background\r\n+     * validation progresses, and these blocks are validated, the ASSUMED_VALID\r\n+     * flags are removed. See `doc/design/assumeutxo.md` for details.\r\n+     *\r\n+     * This flag is only used to implement checks in CheckBlockIndex() and\r\n+     * should not be used elsewhere.\r\n      */\r\n     BLOCK_ASSUMED_VALID      =   256,\r\n };\r\n\r\n```\r\n\r\n---\r\n\r\nre: PR description https://github.com/bitcoin/bitcoin/pull/27746#issue-1724651759\r\n> base block is: the block hash\r\n\r\nGrammar here seems off, maybe replace with \"base block, and the base block hash\"\r\n\r\n---\r\n\r\nre: PR description https://github.com/bitcoin/bitcoin/pull/27746#issue-1724651759\r\n\r\n> This code needs a lot of cleanup and test fixes and so I've marked it as a draft -- help from reviewers would be welcome!\r\n\r\nCould drop this part since PR seems to be a good state to review and merge.\r\n\r\n---\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1577187405\r\n> I think AcceptBlock could also be a static function in validation.cpp\r\n\r\nIMO, would be nice make it a standalone function (static or not). Unless a function is really tied to one particular class or needs access to its private state, better for it just be standalone and use the public interface.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1483231139",
      "submitted_at": "2023-06-16T23:01:06Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9558793926,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI5v57G",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9558793926",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T13:19:12Z"
    },
    {
      "event": "commented",
      "id": 1595757923,
      "node_id": "IC_kwDOABII585fHVVj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595757923",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T13:19:32Z",
      "updated_at": "2023-06-17T18:03:19Z",
      "author_association": "MEMBER",
      "body": "Thanks @ryanofsky for the detailed review.  I've addressed many of the comments in fixup commits, which are tagged here for easier review:  [27746.1](https://github.com/sdaftuar/bitcoin/tree/27746.1).  I've now squashed those fixups into place and pushed.  Still outstanding for me to look at:\r\n\r\n- [x] Move AcceptBlock to not be a member of ChainstateManager. I think you're right that this is better if we pull it out of the class. EDIT: took a stab at this in [14e56b9](https://github.com/bitcoin/bitcoin/pull/27746/commits/14e56b957a81495e69bb906cd2ea52b6febd2baa), if this looks good I can integrate this earlier in the commit history.\r\n- [x] Clean up the commits mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800\r\n- [x] Resolve the issue mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224\r\n- [x] Fix the usage of `pindex->IsAssumedValid()` that I mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062 (done in 78fcc8fbdc510c03dd021e6c34a10e6b35fc2c83)\r\n- [ ] See if I can add some kind of test that would have caught the bug you mentioned in CheckBlockIndex here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1595757923",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9558796032,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI5v6cA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9558796032",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T13:19:32Z"
    },
    {
      "event": "subscribed",
      "id": 9558796041,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI5v6cJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9558796041",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T13:19:32Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9558834140,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI5wDvc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9558834140",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T13:29:09Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9558988357,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI5wpZF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9558988357",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-17T15:03:49Z"
    },
    {
      "event": "reviewed",
      "id": 1485089804,
      "node_id": "PRR_kwDOABII585YhKwM",
      "url": null,
      "actor": null,
      "commit_id": "78fcc8fbdc510c03dd021e6c34a10e6b35fc2c83",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "",
      "user": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1485089804",
      "submitted_at": "2023-06-18T14:26:15Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "commented",
      "id": 1596205284,
      "node_id": "IC_kwDOABII585fJCjk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1596205284",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-18T16:48:37Z",
      "updated_at": "2023-06-18T16:48:37Z",
      "author_association": "MEMBER",
      "body": "I added a commit that moves `CheckBlockIndex()` from `Chainstate` to `ChainstateManager` and tightens up the sanity checks around `setBlockIndexCandidates` and `mapBlocksUnlinked`, to better match what is implemented in this PR, and reduce the places in `CheckBlockIndex` where we skip tests in the presence of assumed-valid blocks. \r\n\r\nThere's probably still room for improvement on the tests to better exercise all this logic (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177), and I haven't yet picked up the suggestion from @ryanofsky in https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233077487, which would give us a performance optimization by caching lookups into the block index when adding blocks to the background chainstate's `setBlockIndexCandidates`.  I could use explicit feedback on: (a) whether the performance optimization is important enough that we should do it; (b) whether the movement of `AcceptBlock` out of `ChainstateManager` is an improvement; (c) whether additional tests should be added prior to merge (if so, I can work on it, but would also welcome help to write more tests!); and (d) whether moving `CheckBlockIndex()` into `ChainstateManager` should be done in this PR.  With feedback on those items, I'll go back and squash the fixup commits into place to clean up the branch.",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1596205284",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9561571327,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI56f__",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9561571327",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-18T16:48:38Z"
    },
    {
      "event": "subscribed",
      "id": 9561571331,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI56gAD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9561571331",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-18T16:48:38Z"
    },
    {
      "event": "reviewed",
      "id": 1485874548,
      "node_id": "PRR_kwDOABII585YkKV0",
      "url": null,
      "actor": null,
      "commit_id": "4a699011048e88099545a612075b5483ff55f533",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\n> (b) whether the movement of AcceptBlock out of ChainstateManager is an improvement; \r\n\r\nI think this would make sense but if we are gonna pass `ChainstateManager` to static functions, then I think we should avoid reaching into its internals and use the available interfaces or define new ones. I left a couple comments about this inline.\r\n\r\nIt might also be better to do this in a separate PR and stick to the assumeutxo related improvements in this one. There are likely a lot more interface related cleanups/improvements to be made around `Chainstate` and `ChainstateManager` that would benefit from isolated review.",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1485874548",
      "submitted_at": "2023-06-19T11:02:57Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1491402431,
      "node_id": "PRR_kwDOABII585Y5P6_",
      "url": null,
      "actor": null,
      "commit_id": "4a699011048e88099545a612075b5483ff55f533",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK 4a699011048e88099545a612075b5483ff55f533 ([`jamesob/ackr/27746.1.sdaftuar.rework_validation_logic`](https://github.com/jamesob/bitcoin/tree/ackr/27746.1.sdaftuar.rework_validation_logic))\r\n\r\nReviewed locally and built each commit.\r\n\r\nThis change is a nice tightening up of the block index management code;\r\nthe CheckBlockIndex() clarifications are welcome, not to mention fixing the\r\nbuggy setBlockIndexCandidates initialization.\r\n\r\nThe latent bugs I introduced in the original code here say a lot to me about the\r\nwisdom (or lack thereof) of introducing unused code littered over a number of\r\nyears and PRs. I also wish I were smarter.\r\n\r\n---\r\n\r\nThe fixups need to be squashed in and I have a tiny question about the `UnloadBlockIndex()` change, but otherwise this is looking really good.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1491402431",
      "submitted_at": "2023-06-21T19:53:51Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "review_requested",
      "id": 9598637830,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAI8H5cG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9598637830",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-21T19:53:57Z",
      "requested_reviewer": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_requested",
      "id": 9598637852,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAI8H5cc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9598637852",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-21T19:53:57Z",
      "requested_reviewer": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "reviewed",
      "id": 1485181856,
      "node_id": "PRR_kwDOABII585YhhOg",
      "url": null,
      "actor": null,
      "commit_id": "4a699011048e88099545a612075b5483ff55f533",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Re your requests for feedback:\r\na) Looks simple enough for me to be included here\r\nb) Overall I think itâ€™s good but I agree with @dergoegge that the interface can be improved. But letâ€™s keep that for a follow-up along with further cleanup that will probably follow when assumeutxo is merged.\r\nc) Will think about what could be adding value\r\nd) It seems to have already received some review here so I would vote to keep it in as well\r\n\r\nI will try to do some manual testing with this and the assumeutxo PR in the next days as well.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1485181856",
      "submitted_at": "2023-06-22T22:01:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "commented",
      "id": 1605210547,
      "node_id": "IC_kwDOABII585frZGz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605210547",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-24T01:14:00Z",
      "updated_at": "2023-06-24T01:14:00Z",
      "author_association": "MEMBER",
      "body": "Would prefer to keep refactoring and bugfixes in separate PRs, if there's no reason they have to be together here?",
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1605210547",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "commented",
      "id": 1605245391,
      "node_id": "IC_kwDOABII585frhnP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1605245391",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-24T03:09:14Z",
      "updated_at": "2023-06-24T03:09:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Would prefer to keep refactoring and bugfixes in separate PRs, if there's no reason they have to be together here?\r\n\r\nIt's an internal bug and the only way to trigger it is to use #27596 and restart the node during background snapshot validation. The bug was introduced by code in 0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5 which was basically untested and broken, and the bug is fixed by c21624c14b83e30f32d5f8c653b3e64235625780 which depends on the earlier refactoring. Some more details about it are in https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071e\r\n\r\nThere's no good way to fix the bug without doing refactoring first, and probably no benefit to moving the bugfix to separate PR based on a refactoring PR, especially since the bug is internal and can't actually be triggered without modifying current code.\r\n",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1605245391",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9654419710,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI_csD-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654419710",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:13:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9654460678,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAI_c2EG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654460678",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:17:46Z"
    },
    {
      "event": "commented",
      "id": 1609852620,
      "node_id": "IC_kwDOABII585f9GbM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1609852620",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:19Z",
      "updated_at": "2023-06-27T16:25:19Z",
      "author_association": "MEMBER",
      "body": "Thanks all for the additional review.  I've updated based on feedback and cleaned up the commit history.\r\n\r\n> would make sense but if we are gonna pass ChainstateManager to static functions, then I think we should avoid reaching into its internals and use the available interfaces or define new ones. I left a couple comments about this inline.\r\n\r\n> It might also be better to do this in a separate PR and stick to the assumeutxo related improvements in this one. There are likely a lot more interface related cleanups/improvements to be made around Chainstate and ChainstateManager that would benefit from isolated review.\r\n\r\n@dergoegge I think I agree that this code movement would make sense in its own PR, so I decided to drop the movement of AcceptBlock out of ChainstateManager (and so therefore also ended up not taking the other changes you suggested about cleaning up the CSM interface, though I agree with you that those changes would make sense as well once AcceptBlock is moved out). \r\n\r\n@jamesob I think your comment here (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237579876) highlighted a bug in the code; if the background chainstate was disabled then we'd add entries to setBlockIndexCandidates that we shouldn't.  I think this is fixed now!\r\n\r\n@fjahr Thanks for the review, I took a couple of the fixes, and just had a question about one of the suggestions.\r\n\r\n",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1609852620",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9654542291,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI_dJ_T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542291",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "subscribed",
      "id": 9654542315,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI_dJ_r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542315",
      "actor": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "mentioned",
      "id": 9654542332,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI_dJ_8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542332",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "subscribed",
      "id": 9654542345,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI_dKAJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542345",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "mentioned",
      "id": 9654542367,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAI_dKAf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542367",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "subscribed",
      "id": 9654542382,
      "node_id": "SE_lADOABII585mzBjvzwAAAAI_dKAu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9654542382",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-06-27T16:25:20Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9697339332,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJCAafE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9697339332",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-01T19:21:25Z"
    },
    {
      "event": "labeled",
      "id": 9697710550,
      "node_id": "LE_lADOABII585mzBjvzwAAAAJCB1HW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9697710550",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-01T21:24:39Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 1511690655,
      "node_id": "PRR_kwDOABII585aGpGf",
      "url": null,
      "actor": null,
      "commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "ACK 03dfe04075668aa3b99a5d6d68adfcecffca0593 ([`jamesob/ackr/27746.3.sdaftuar.rework_validation_logic`](https://github.com/jamesob/bitcoin/tree/ackr/27746.3.sdaftuar.rework_validation_logic))\r\n\r\nReexamined commits locally. Built, tested each (or most). Examined [diff since\r\nlast review](https://gist.github.com/jamesob/8535a4b81fc29e890ce2eff9a0fb2f1d).\r\n\r\nChanges include\r\n\r\n- removing `BlockManager::AddDirty()`\r\n- comment typo fixes\r\n- AcceptBlock() under ChainMan (vs. standalone function)\r\n- add `Chainstate::SnapshotBase()`\r\n- rework/additional commentary for `Chainstate::TryAddBlockIndexCandidate`\r\n  - minor bugfix for disabled chainstates\r\n- put `ReceivedBlockTransactions` under ChainstateManager (vs. standalone)\r\n- leave `AcceptBlockHeader()` in place\r\n- `Active*()` rephrasings\r\n- move `AcceptBlock()` under ChainstateManager\r\n\r\nNot sure what's up with the arm failure, but tests pass for me locally.",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1511690655",
      "submitted_at": "2023-07-03T20:34:53Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1511762976,
      "node_id": "PRR_kwDOABII585aG6wg",
      "url": null,
      "actor": null,
      "commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code Review ACK 03dfe04075668aa3b99a5d6d68adfcecffca0593\r\n\r\nI reviewed the code again (didn't look that deep into the test changes), and did some manual testing.\r\n\r\n> Not sure what's up with the arm failure, but tests pass for me locally.\r\n\r\nPretty sure it's unrelated, same thing just happened on master: https://github.com/bitcoin/bitcoin/runs/14733904119 (some discussion in #27988)",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1511762976",
      "submitted_at": "2023-07-03T21:23:26Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1505486978,
      "node_id": "PRR_kwDOABII585Zu-iC",
      "url": null,
      "actor": null,
      "commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Partial code review ACK 03dfe04075668aa3b99a5d6d68adfcecffca0593. I've looked in detail at almost all of this except for tests. It seems like a big improvement and I haven't found any real issues at all. Am planning to review more soon.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1505486978",
      "submitted_at": "2023-07-03T21:51:59Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1512960883,
      "node_id": "PRR_kwDOABII585aLfNz",
      "url": null,
      "actor": null,
      "commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 03dfe04075668aa3b99a5d6d68adfcecffca0593\r\n\r\n(modulo my question about the rev file management)\r\n\r\nI will also sync a node with this code and report if I see anything unusual in the coming days.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1512960883",
      "submitted_at": "2023-07-04T16:19:25Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "labeled",
      "id": 9748543088,
      "node_id": "LE_lADOABII585mzBjvzwAAAAJFDvZw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9748543088",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-06T22:06:12Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 9752130348,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAJFRbMs",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9752130348",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-07T08:23:22Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZlODZhN2NkNDgwYjMyNDYzZGE5MDBkYjc2NGQyZDExYTJiZWEwOTU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fe86a7cd480b32463da900db764d2d11a2bea095",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fe86a7cd480b32463da900db764d2d11a2bea095",
      "tree": {
        "sha": "9f7db57e6636f0420fe1902daaefe0eb3b2a5b0a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9f7db57e6636f0420fe1902daaefe0eb3b2a5b0a"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/01e5d6b105861ebf1216df6f1682004e44dd2544",
          "sha": "01e5d6b105861ebf1216df6f1682004e44dd2544",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/01e5d6b105861ebf1216df6f1682004e44dd2544"
        }
      ],
      "message": "Explicitly track maximum block height stored in undo files\n\nWhen writing a new block to disk, if we have filled up the current block file,\nthen we flush and truncate that block file (to free allocated but unused\nspace) before advancing to the next one. When this happens, we have to\ndetermine whether to also flush and truncate the corresponding undo file.\n\nUndo data is only written when blocks are connected, not when blocks are\nreceived. Thus it's possible that the corresponding undo file already has all\nthe data it will ever have, and we should flush/truncate it as we advance\nfiles; or it's possible that there is more data we expect to write, and should\ntherefore defer flush/truncation until undo data is later written.\n\nPrior to this commit, we made the determination of whether the undo file was\nfull of all requisite data by comparing against the chain tip. This patch\nreplaces that dependence on validation data structures by instead just tracking\nthe highest height of any block written in the undo file as we go.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T18:47:00Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-04-28T22:50:33Z"
      },
      "sha": "fe86a7cd480b32463da900db764d2d11a2bea095"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFjZmM4ODdkMDBjNWQxZDQyODExMDdlM2IzZmY0NjQxYzZjMzQ2MzE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cfc887d00c5d1d4281107e3b3ff4641c6c34631",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1cfc887d00c5d1d4281107e3b3ff4641c6c34631",
      "tree": {
        "sha": "a619a7ffecb18407d1a09307cb048adb2a947d8d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a619a7ffecb18407d1a09307cb048adb2a947d8d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fe86a7cd480b32463da900db764d2d11a2bea095",
          "sha": "fe86a7cd480b32463da900db764d2d11a2bea095",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/fe86a7cd480b32463da900db764d2d11a2bea095"
        }
      ],
      "message": "Remove CChain dependency in node/blockstorage",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T18:54:57Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-04-28T23:31:56Z"
      },
      "sha": "1cfc887d00c5d1d4281107e3b3ff4641c6c34631"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9824982207,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJJnVS_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9824982207",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-14T19:15:46Z"
    },
    {
      "event": "unlabeled",
      "id": 9825870120,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAJJquEo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9825870120",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-14T20:55:54Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ3MWRhNWY2ZTc0YmFjNzFhZWZmZTJlYmM1ZmFmZjE0NWE2Y2JjZWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "tree": {
        "sha": "0f5e1071174223c085167c845c409b968e0b0943",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0f5e1071174223c085167c845c409b968e0b0943"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1cfc887d00c5d1d4281107e3b3ff4641c6c34631",
          "sha": "1cfc887d00c5d1d4281107e3b3ff4641c6c34631",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1cfc887d00c5d1d4281107e3b3ff4641c6c34631"
        }
      ],
      "message": "Move block-arrival information / preciousblock counters to ChainstateManager\n\nBlock arrival information (and the preciousblock RPC, a related concept) are\nboth chainstate-agnostic, so these are moved to ChainstateManager. This should\njust be a refactor, without any observable behavior changes.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T21:09:06Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T11:50:51Z"
      },
      "sha": "471da5f6e74bac71aeffe2ebc5faff145a6cbcea"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDEwYzA1NzEwY2UxNjAyZDkzMjAzN2Y3MmRjNmM0YmJjM2Y2ZjM0YmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/10c05710ce1602d932037f72dc6c4bbc3f6f34ba",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/10c05710ce1602d932037f72dc6c4bbc3f6f34ba",
      "tree": {
        "sha": "d12b055383b23c21c0805f218f24a606810a010e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d12b055383b23c21c0805f218f24a606810a010e"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
          "sha": "471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/471da5f6e74bac71aeffe2ebc5faff145a6cbcea"
        }
      ],
      "message": "Add wrapper for adding entries to a chainstate's block index candidates",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T21:09:06Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T13:10:10Z"
      },
      "sha": "10c05710ce1602d932037f72dc6c4bbc3f6f34ba"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI3MmZiYzM3MGM0ZTEzM2QzMWQ5ZjFkMzRlMzI3Y2MyNjVjNWZhZDI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/272fbc370c4e133d31d9f1d34e327cc265c5fad2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/272fbc370c4e133d31d9f1d34e327cc265c5fad2",
      "tree": {
        "sha": "2df5d18e2ea69dfa01c19529619f00e5728b7461",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2df5d18e2ea69dfa01c19529619f00e5728b7461"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/10c05710ce1602d932037f72dc6c4bbc3f6f34ba",
          "sha": "10c05710ce1602d932037f72dc6c4bbc3f6f34ba",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/10c05710ce1602d932037f72dc6c4bbc3f6f34ba"
        }
      ],
      "message": "Update CheckBlockIndex invariants for chains based on an assumeutxo snapshot",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T21:09:06Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T17:56:00Z"
      },
      "sha": "272fbc370c4e133d31d9f1d34e327cc265c5fad2"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9825992234,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJJrL4q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9825992234",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-14T21:09:33Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDNjZmM3NTM2NmU2NTk2OTQyY2JjODRmMzU0ZjQyZGZkN2ZjNWMwNzM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3cfc75366e6596942cbc84f354f42dfd7fc5c073",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/3cfc75366e6596942cbc84f354f42dfd7fc5c073",
      "tree": {
        "sha": "ea10a8c7df7e61a8b15b9308a20e5ebe0e69e5e5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ea10a8c7df7e61a8b15b9308a20e5ebe0e69e5e5"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/272fbc370c4e133d31d9f1d34e327cc265c5fad2",
          "sha": "272fbc370c4e133d31d9f1d34e327cc265c5fad2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/272fbc370c4e133d31d9f1d34e327cc265c5fad2"
        }
      ],
      "message": "test: Clear block index flags when testing snapshots\n\nWhen simulating a snapshot, remove the HAVE_DATA status for blocks below the\nsnapshot height, to simulate never having downloaded them at all. This makes\ntests more realistic (and more closely match what will happen when using\nassumeutxo).",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-14T21:10:49Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T22:35:37Z"
      },
      "sha": "3cfc75366e6596942cbc84f354f42dfd7fc5c073"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9826007797,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJJrPr1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9826007797",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-14T21:11:36Z"
    },
    {
      "event": "commented",
      "id": 1636603720,
      "node_id": "IC_kwDOABII585hjJdI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1636603720",
      "actor": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-15T01:07:08Z",
      "updated_at": "2023-07-15T01:07:08Z",
      "author_association": "MEMBER",
      "body": "Initial commit-by-commit build/review looks good, will do a full review.",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1636603720",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9839216167,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJKdoYn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9839216167",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-17T15:23:40Z"
    },
    {
      "event": "commented",
      "id": 1638374417,
      "node_id": "IC_kwDOABII585hp5wR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1638374417",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-17T15:25:51Z",
      "updated_at": "2023-07-17T15:25:51Z",
      "author_association": "MEMBER",
      "body": "Just pushed a new branch incorporating feedback from all of @ryanofsky's prior review.  Regarding https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251289117, I decided that it made the most sense to invoke `ActivateBestChain()` on both chainstates in `LoadExternalBlockFile` if pruning was enabled, even though I think it'll take some more work to figure out how pruning should function in the event that we're in the middle of assumeutxo-initiated background validation.\r\n\r\nRegarding the comment about `NotifyHeaderTip()` (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251292140), I wasn't sure if that was something to do in this PR or a future one?",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1638374417",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9839240553,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAJKduVp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9839240553",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-17T15:25:51Z"
    },
    {
      "event": "subscribed",
      "id": 9839240581,
      "node_id": "SE_lADOABII585mzBjvzwAAAAJKduWF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9839240581",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-17T15:25:51Z"
    },
    {
      "event": "reviewed",
      "id": 1533749512,
      "node_id": "PRR_kwDOABII585baykI",
      "url": null,
      "actor": null,
      "commit_id": "137762f34a845e491b80f9cea07efc4427cb38bf",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "This looks good, and thanks for all the clarifications. I'm just going over the commits another time in case I missed anything. Feel free to ignore all my suggestions, none are very important. Here's my progress so far:\r\n\r\n- [X] fe86a7cd480b32463da900db764d2d11a2bea095 Explicitly track maximum block height stored in undo files (1/12)\r\n- [X] 1cfc887d00c5d1d4281107e3b3ff4641c6c34631 Remove CChain dependency in node/blockstorage (2/12)\r\n- [X] 471da5f6e74bac71aeffe2ebc5faff145a6cbcea Move block-arrival information / preciousblock counters to ChainstateManager (3/12)\r\n- [X] 10c05710ce1602d932037f72dc6c4bbc3f6f34ba Add wrapper for adding entries to a chainstate's block index candidates (4/12)\r\n- [X] 272fbc370c4e133d31d9f1d34e327cc265c5fad2 Update CheckBlockIndex invariants for chains based on an assumeutxo snapshot (5/12)\r\n- [X] 3cfc75366e6596942cbc84f354f42dfd7fc5c073 test: Clear block index flags when testing snapshots (6/12)\r\n- [X] c8f4a8702851c3097ebd038a814d974dce4dcc78 Move block-storage-related logic to ChainstateManager (7/12)\r\n- [X] eb8ce95a2551fe521d00a5901ea773514395255b Tighten requirements for adding elements to setBlockIndexCandidates (8/12)\r\n- [ ] f41cef2ba1e1f033356691e520e39d9d75d5eb4f Fix initialization of setBlockIndexCandidates when working with multiple chainstates (9/12)\r\n- [ ] bef5acee93e128857d20137ea0c83f281a780211 Documentation improvements for assumeutxo (10/12)\r\n- [ ] f921887c1afdcd333cf71ca25e5efbf4991f806e Move CheckBlockIndex() from Chainstate to ChainstateManager (11/12)\r\n- [ ] 137762f34a845e491b80f9cea07efc4427cb38bf Cache block index entry corresponding ",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1533749512",
      "submitted_at": "2023-07-18T04:03:38Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1535703245,
      "node_id": "PRR_kwDOABII585biPjN",
      "url": null,
      "actor": null,
      "commit_id": "137762f34a845e491b80f9cea07efc4427cb38bf",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 137762f34a845e491b80f9cea07efc4427cb38bf. Left some more suggestions, but this looks good in its current form.\r\n\r\nJust so I don't forget, I want to note that that it might make sense to move `IsInitialBlockDownload` and `NotifyHeaderTip` functions from the `Chainstate` class to `ChainstateManager` as a followups to this PR (https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905, https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792)",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1535703245",
      "submitted_at": "2023-07-18T19:54:01Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "review_requested",
      "id": 9854917463,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAJLZhtX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9854917463",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-18T19:54:07Z",
      "requested_reviewer": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_requested",
      "id": 9854917479,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAJLZhtn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9854917479",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-18T19:54:07Z",
      "requested_reviewer": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_requested",
      "id": 9854917492,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAJLZht0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9854917492",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-18T19:54:07Z",
      "requested_reviewer": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQwZDQwZWE5YTY0NzhkODFkNzUzMWI3Y2ZjNTJhOGJkYWEwODgzZDY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
      "tree": {
        "sha": "09b498ed56c26f1a6b70e916d07a1a9540ea35f1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/09b498ed56c26f1a6b70e916d07a1a9540ea35f1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3cfc75366e6596942cbc84f354f42dfd7fc5c073",
          "sha": "3cfc75366e6596942cbc84f354f42dfd7fc5c073",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/3cfc75366e6596942cbc84f354f42dfd7fc5c073"
        }
      ],
      "message": "Move block-storage-related logic to ChainstateManager\n\nSeparate the notion of which blocks are stored on disk, and what data is in our\nblock index, from what tip a chainstate might be able to get to. We can use\nchainstate-agnostic data to determine when to store a block on disk (primarily,\nan anti-DoS set of criteria) and let the chainstates figure out for themselves\nwhen a block is of interest for being a candidate tip.\n\nNote: some of the invariants in CheckBlockIndex are modified, but more work is\nneeded (ie to move CheckBlockIndex to ChainstateManager, as most of what\nCheckBlockIndex is doing is checking the consistency of the block index, which\nis outside of Chainstate).",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-21T14:09:44Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-06T12:24:43Z"
      },
      "sha": "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6"
    },
    {
      "event": "commented",
      "id": 1648224098,
      "node_id": "IC_kwDOABII585iPedi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648224098",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T16:21:13Z",
      "updated_at": "2023-07-24T16:21:13Z",
      "author_association": "MEMBER",
      "body": "ACK 137762f34a845e491b80f9cea07efc4427cb38bf",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1648224098",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "review_request_removed",
      "id": 9902227032,
      "node_id": "RRRE_lADOABII585mzBjvzwAAAAJON_5Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9902227032",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T16:21:18Z",
      "requested_reviewer": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "reviewed",
      "id": 1544102750,
      "node_id": "PRR_kwDOABII585cCSNe",
      "url": null,
      "actor": null,
      "commit_id": "137762f34a845e491b80f9cea07efc4427cb38bf",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code Review ACK 137762f34a845e491b80f9cea07efc4427cb38bf\r\n\r\nI reviewed all commits again and did a bit of testing with snapshots on signet.",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1544102750",
      "submitted_at": "2023-07-24T19:14:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQ0M2ExZjFhMmZhMzVkMzc3YzdhOWFkN2FiOTJkMWFlMzI1YmRlM2Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d",
      "tree": {
        "sha": "70fa9a43405fdb21eb4321a5f5e08c542d9172a7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/70fa9a43405fdb21eb4321a5f5e08c542d9172a7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
          "sha": "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6"
        }
      ],
      "message": "Tighten requirements for adding elements to setBlockIndexCandidates\n\nWhen using assumeutxo, we only need the background chainstate to consider\nblocks that are on the chain leading to the snapshotted block.\n\nNote that this introduces the new invariant that we can only have an assumeutxo\nsnapshot where the snapshotted blockhash is in our block index. Unknown block\nhashes that are somehow passed in will cause assertion failures when processing\nnew blocks.\n\nIncludes test fixes and improvements by Andrew Chow and Fabian Jahr.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:23:38Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T17:38:32Z"
      },
      "sha": "d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc2ODY5MGI3Y2U1NTFjZDQwM2Y4ZTJhMDk5MzcyOTE1ZjYwMjJhZDQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/768690b7ce551cd403f8e2a099372915f6022ad4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/768690b7ce551cd403f8e2a099372915f6022ad4",
      "tree": {
        "sha": "31853fae11b8f8765559b91e2c05348271123713",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/31853fae11b8f8765559b91e2c05348271123713"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d",
          "sha": "d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d43a1f1a2fa35d377c7a9ad7ab92d1ae325bde3d"
        }
      ],
      "message": "Fix initialization of setBlockIndexCandidates when working with multiple chainstates\n\nWhen using assumeutxo and multiple chainstates are active, the background\nchainstate should consider all HAVE_DATA blocks that are ancestors of the\nsnapshotted block and that have more work than the tip as potential candidates.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:23:38Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-05-24T17:56:37Z"
      },
      "sha": "768690b7ce551cd403f8e2a099372915f6022ad4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBjZTgwNWI2MzJkY2I5ODk0NGE5MzFmNzU4Zjc2ZjUzMGY1Y2U1ZjI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "tree": {
        "sha": "46fa6d64bbdb7dd61fe36266f6b55da57be18112",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/46fa6d64bbdb7dd61fe36266f6b55da57be18112"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/768690b7ce551cd403f8e2a099372915f6022ad4",
          "sha": "768690b7ce551cd403f8e2a099372915f6022ad4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/768690b7ce551cd403f8e2a099372915f6022ad4"
        }
      ],
      "message": "Documentation improvements for assumeutxo",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:23:38Z"
      },
      "author": {
        "name": "Ryan Ofsky",
        "email": "ryan@ofsky.org",
        "date": "2023-06-17T00:42:24Z"
      },
      "sha": "0ce805b632dcb98944a931f758f76f530f5ce5f2"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDM1NTZiODUwMjIxYmMwZTU5N2Q3ZGQ3NDlkNGQ0N2FiNThkYzgwODM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "tree": {
        "sha": "f6756b8b1c7911ec648f28a64aee6a6d5dd0e999",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f6756b8b1c7911ec648f28a64aee6a6d5dd0e999"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0ce805b632dcb98944a931f758f76f530f5ce5f2",
          "sha": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0ce805b632dcb98944a931f758f76f530f5ce5f2"
        }
      ],
      "message": "Move CheckBlockIndex() from Chainstate to ChainstateManager\n\nAlso rewrite CheckBlockIndex() to perform tests on all chainstates.\n\nThis increases sanity-check coverage, as any place in our code where we were\ninvoke CheckBlockIndex() on a single chainstate will now invoke the sanity\nchecks on all chainstates.\n\nThis change also tightens up the checks on setBlockIndexCandidates and\nmapBlocksUnlinked, to more precisely match what we aim for even in the presence\nof assumed-valid blocks.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:23:38Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-18T16:33:58Z"
      },
      "sha": "3556b850221bc0e597d7dd749d4d47ab58dc8083"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQ0YTExYWJiMTk3MmI1NGYwYmFiZGNjZmJiMmZkZTk3YWI4ODU5MzM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d4a11abb1972b54f0babdccfbb2fde97ab885933",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d4a11abb1972b54f0babdccfbb2fde97ab885933",
      "tree": {
        "sha": "ae48398820384ca2a159c80887e378c11884f82c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ae48398820384ca2a159c80887e378c11884f82c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3556b850221bc0e597d7dd749d4d47ab58dc8083",
          "sha": "3556b850221bc0e597d7dd749d4d47ab58dc8083",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/3556b850221bc0e597d7dd749d4d47ab58dc8083"
        }
      ],
      "message": "Cache block index entry corresponding to assumeutxo snapshot base blockhash\n\nThis is to (a) avoid repeated lookups into the block index for an entry that\nshould never change and (b) emphasize that the snapshot base should always\nexist when set and not change during the runtime of the program.\n\nThanks to Russ Yanofsky for suggesting this approach.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:23:38Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-06-27T16:11:34Z"
      },
      "sha": "d4a11abb1972b54f0babdccfbb2fde97ab885933"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9904385707,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJOWO6r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9904385707",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T20:25:03Z"
    },
    {
      "event": "commented",
      "id": 1648555652,
      "node_id": "IC_kwDOABII585iQvaE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1648555652",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T20:26:38Z",
      "updated_at": "2023-07-24T20:29:53Z",
      "author_association": "MEMBER",
      "body": "Thanks all for the additional review. I pushed a branch that I think addresses all of @ryanofsky's latest feedback (previous branch is tagged [here](https://github.com/sdaftuar/bitcoin/commits/27746.3) for reference).\r\n\r\nOh one open question is here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270716655",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1648555652",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "mentioned",
      "id": 9904398676,
      "node_id": "MEE_lADOABII585mzBjvzwAAAAJOWSFU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9904398676",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T20:26:39Z"
    },
    {
      "event": "subscribed",
      "id": 9904398694,
      "node_id": "SE_lADOABII585mzBjvzwAAAAJOWSFm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9904398694",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T20:26:39Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGE3MzNkZDc5ZTI5MDY4YWQxZTA1MzJhYzQyYTQ1MTg4YTA0MGE3Yjk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "tree": {
        "sha": "3af276d60a817324afca9cec0858029fa4eb3d5e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3af276d60a817324afca9cec0858029fa4eb3d5e"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d4a11abb1972b54f0babdccfbb2fde97ab885933",
          "sha": "d4a11abb1972b54f0babdccfbb2fde97ab885933",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d4a11abb1972b54f0babdccfbb2fde97ab885933"
        }
      ],
      "message": "Remove unused function `reliesOnAssumedValid`",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-24T20:27:04Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2023-07-21T14:27:12Z"
      },
      "sha": "a733dd79e29068ad1e0532ac42a45188a040a7b9"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9904403325,
      "node_id": "HRFPE_lADOABII585mzBjvzwAAAAJOWTN9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9904403325",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T20:27:17Z"
    },
    {
      "event": "labeled",
      "id": 9905397768,
      "node_id": "LE_lADOABII585mzBjvzwAAAAJOaGAI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9905397768",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-24T22:36:23Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 9906146516,
      "node_id": "UNLE_lADOABII585mzBjvzwAAAAJOc8zU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9906146516",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-25T01:30:20Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 1652419820,
      "node_id": "IC_kwDOABII585ifezs",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652419820",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:05:26Z",
      "updated_at": "2023-07-26T20:05:26Z",
      "author_association": "MEMBER",
      "body": "ACK a733dd79e29068ad1e0532ac42a45188a040a7b9\r\n\r\nChanges since last are mainly responding to review comments.",
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1652419820",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "review_requested",
      "id": 9928251006,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAJPxRZ-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9928251006",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:05:31Z",
      "requested_reviewer": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "review_requested",
      "id": 9928251023,
      "node_id": "RRE_lADOABII585mzBjvzwAAAAJPxRaP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9928251023",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:05:31Z",
      "requested_reviewer": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      }
    },
    {
      "event": "reviewed",
      "id": 1552110152,
      "node_id": "PRR_kwDOABII585cg1JI",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "The documentation commit made me wonder if we can use `BLOCK_VALID_TRANSACTIONS` (the first check beyond headers) instead of `BLOCK_VALID_SCRIPTS` to set `BLOCK_ASSUMED_VALID`.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1552110152",
      "submitted_at": "2023-07-28T14:25:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1552660659,
      "node_id": "PRR_kwDOABII585ci7iz",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "reACK a733dd79e29068ad1e0532ac42a45188a040a7b9 ([`jamesob/ackr/27746.5.sdaftuar.rework_validation_logic`](https://github.com/jamesob/bitcoin/tree/ackr/27746.5.sdaftuar.rework_validation_logic))\r\n\r\nChanges incorporate feedback discussed above.\r\n\r\n\r\n<details><summary>Show signature data</summary>\r\n<p>\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nreACK a733dd79e29068ad1e0532ac42a45188a040a7b9 ([`jamesob/ackr/27746.5.sdaftuar.rework_validation_logic`](https://github.com/jamesob/bitcoin/tree/ackr/27746.5.sdaftuar.rework_validation_logic))\r\n\r\nChanges incorporate feedback discussed above.\r\n\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQIzBAEBCgAdFiEEGNRVI1NPYuZCSIrGepNdrbLETwUFAmTEAMQACgkQepNdrbLE\r\nTwWP5g//REGb6Fc8/xAok0xHNy81xhAF8B/egKZzUJOHMON/4k6R4rXH0XGYr8Cg\r\nsUH7dHsCFRCHIghFYMLJArKwIOa1mmd/XPuztzl8E4Ki1FscylUkPxadPsH4D7Rz\r\ntFqmAUdiLprrmDV9CauI//QHvI0feoxDS3YMneUUiqtCzPGKvfY9TAXK0UmkIQbY\r\n4wNKWrfpT8dLzWuiEosEHErJxcMpzK8OYY0IPtU4CmZ4OOXuMHL9hHqjtppPIpVJ\r\nyoOy10KEBbdWG6ydmFgexAc9tNC1diF+Q2TmJTPdP/9bJXfaMi+8IwPTUbJXwQLZ\r\nUMdXHnAeOMk++/PCtlY3PVG/T65nCdEUrzVMRf243iwiJCEK/DF0d8xcsVs6rgf/\r\nEfHQ2Kz2CAxLVwIr8myeig4LTy1EErkvs4Duk69jjpIOjIvkrHUkIGm/pTB3qGD7\r\nylxkfffQBtM0CVQt5tIWqHB00rdN1xVZNna8AzB1++WxxOJHsLmk6PsJrRFc2qAV\r\nZxO9FnJr+GVqZ9hwFmjIcexS7Nz9mCZOiCUG2efilHyxkWkCXZ3ZQxUXPmD8Vi8W\r\nppePxNNKlq/8aursxx9Em2Thru5HdhPNiO6ta/r+wfvGLqvp8hTXtpB5Z1gXLyuO\r\nNWSI19+tYx4pp1DjpsuOaDCmNWuLtmPdQMSscv0xD1lLpVU87/U=\r\n=xs8R\r\n-----END PGP SIGNATURE-----\r\n\r\n```\r\n\r\n</p></details>\r\n\r\n<details><summary>Show platform data</summary>\r\n<p>\r\n\r\n```\r\nTested on Linux-6.4.6-arch1-1-x86_64-with-glibc2.37\r\n\r\nConfigured with ./configure 'BDB_LIBS=-L/home/james/src/bitcoin/db4/lib -ldb_cxx-4.8' BDB_CFLAGS=-I/home/james/src/bitcoin/db4/include 'CXXFLAGS=-fPIE -pipe -O2 -g -Wthread-safety-analysis -Wall -Werror=sign-compare ' --disable-gui-tests --disable-fuzz-binary --enable-wallet --enable-debug --with-daemon --enable-natpmp-default CXX=/usr/bin/clang++ CC=/usr/bin/clang --disable-shared --with-pic --enable-benchmark=no --enable-module-recovery --disable-module-ecdh --no-create --no-recursion\r\n\r\nCompiled with /usr/bin/ccache /usr/bin/clang++ -std=c++17 -mavx -mavx2 -mpclmul -fPIE -pipe -O2 -g -Wthread-safety-analysis -Wall -Werror=sign-compare  -O0 -g3 -ftrapv -fdebug-prefix-map=$(abs_top_srcdir)=.  -Wstack-protector -fstack-protector-all -fcf-protection=full -fstack-clash-protection -msse4.1 -msse4.2 -msse4 -msha  i\r\n\r\nCompiler version: clang version 15.0.7\r\n```\r\n\r\n</p></details>\r\n\r\n",
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1552660659",
      "submitted_at": "2023-07-28T17:53:27Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1552855193,
      "node_id": "PRR_kwDOABII585cjrCZ",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Also reviewed a733dd79e29068ad1e0532ac42a45188a040a7b9, d4a11abb1972b54f0babdccfbb2fde97ab885933, 3556b850221bc0e597d7dd749d4d47ab58dc8083 and read through all of `CheckBlockIndex()`. Will continue later (going mostly in reverse order).",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1552855193",
      "submitted_at": "2023-07-28T20:15:15Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1553292155,
      "node_id": "PRR_kwDOABII585clVt7",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Comments around 768690b7ce551cd403f8e2a099372915f6022ad4. \r\n\r\nIt would be nice if the documentation for `setBlockIndexCandidates` and `m_blocks_unlinked` explained their purpose (as opposed to merely describing what's in them).\r\n\r\n```cpp\r\n/** \r\n* The set of all CBlockIndex entries that are - or recently\r\n* were - candidates for a new tip. These are as good as our\r\n* current tip or better, and must either have BLOCK_VALID_TRANSACTIONS\r\n* (for itself and all ancestors) *or* BLOCK_ASSUMED_VALID (if using\r\n* background chainstates). Entries may be failed, though, and\r\n* pruning nodes may be missing the data for the block.\r\n*/\r\nâ€¦ setBlockIndexCandidates\r\n\r\n/**\r\n* CBlockIndex entries removed from setBlockIndexCandidates due\r\n* to pruned data for themselves or their ancestors.\r\n*/\r\nâ€¦ m_blocks_unlinked`\r\n```\r\n\r\n(The above still doesn't satisfyingly explain _why_ we hold them in `m_blocks_unlinked` rather than treat them as any other block index entry. I assume it's because we use the list to proactively aks for these blocks?)\r\n\r\nSuggested documentation for `TryAddBlockIndexCandidate`:\r\n\r\n```\r\n/**\r\n* Add CBlockIndex entry to setBlockIndexCandidates if it has more\r\n* work than the current tip. For the background chainstate, we only\r\n* consider connecting blocks towards the snapshot base \r\n*/\r\n```",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553292155",
      "submitted_at": "2023-07-29T15:11:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "reviewed",
      "id": 1553302075,
      "node_id": "PRR_kwDOABII585clYI7",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Code review ACK a733dd79e29068ad1e0532ac42a45188a040a7b9.\r\n\r\nMy comments above can all wait for a followup, if any.\r\n\r\nI'd like to take this for a spin in a rebased #27596 with `-checkblockindex` to see if we didn't miss anything (without pruning, since that has a clear TODO).",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553302075",
      "submitted_at": "2023-07-29T16:54:42Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "commented",
      "id": 1658351829,
      "node_id": "IC_kwDOABII585i2HDV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658351829",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-31T13:14:34Z",
      "updated_at": "2023-07-31T13:14:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1553292155\r\n\r\n> (The above still doesn't satisfyingly explain _why_ we hold them in `m_blocks_unlinked` rather than treat them as any other block index entry. I assume it's because we use the list to proactively aks for these blocks?)\r\n\r\nI also found this pretty confusing when I was reviewing it and found a helpful explanation here: https://en.bitcoin.it/wiki/Bitcoin_Core_0.11_(ch_6):_The_Blockchain. The description of `m_blocks_unlinked` (which used to be `mapBlocksUnlinked`) is:\r\n\r\n> Multimap containing \"all pairs A->B, where A (or one if its ancestors) misses transactions, but B has transactions.\" (comment at main.cpp:125).\r\n>\r\n>The purpose of mapBlocksUnlinked is to quickly attach blocks we've already received to the blockchain when we receive a missing, intermediate block.\r\n>\r\n>The alternative would be to search the entire mapBlockIndex; however, it is more efficient to keep track of unlinked blocks in a separate data structure. \r\n\r\nSo I think the map just exists for efficiency, not to proactively do anything. It would be great to improve documentation in the actual code, though.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1658351829",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "reviewed",
      "id": 1555524219,
      "node_id": "PRR_kwDOABII585ct2p7",
      "url": null,
      "actor": null,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK a733dd79e29068ad1e0532ac42a45188a040a7b9. Just suggested changes since the last review. There are various small things that could be followed up on, but I think this is ready for merge.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1555524219",
      "submitted_at": "2023-07-31T20:07:50Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "merged",
      "id": 9968526037,
      "node_id": "ME_lADOABII585mzBjvzwAAAAJSK6LV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9968526037",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f4f1d6d230dd390f0524b8852b8cfc912d006958",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f4f1d6d230dd390f0524b8852b8cfc912d006958",
      "created_at": "2023-07-31T20:18:34Z"
    },
    {
      "event": "closed",
      "id": 9968526110,
      "node_id": "CE_lADOABII585mzBjvzwAAAAJSK6Me",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9968526110",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-31T20:18:35Z"
    },
    {
      "event": "commented",
      "id": 1659814327,
      "node_id": "IC_kwDOABII585i7sG3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1659814327",
      "actor": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-01T08:22:22Z",
      "updated_at": "2023-08-01T08:22:22Z",
      "author_association": "CONTRIBUTOR",
      "body": "Post-merge ACK a733dd79e29068ad1e0532ac42a45188a040a7b9\r\n\r\nVery happy with the separation of concerns between blockstorage and validation.",
      "user": {
        "login": "TheCharlatan",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheCharlatan",
        "html_url": "https://github.com/TheCharlatan",
        "followers_url": "https://api.github.com/users/TheCharlatan/followers",
        "following_url": "https://api.github.com/users/TheCharlatan/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheCharlatan/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheCharlatan/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheCharlatan/subscriptions",
        "organizations_url": "https://api.github.com/users/TheCharlatan/orgs",
        "repos_url": "https://api.github.com/users/TheCharlatan/repos",
        "events_url": "https://api.github.com/users/TheCharlatan/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheCharlatan/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1659814327",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "commented",
      "id": 1660993936,
      "node_id": "IC_kwDOABII585jAMGQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1660993936",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-01T19:59:31Z",
      "updated_at": "2023-08-01T19:59:51Z",
      "author_association": "CONTRIBUTOR",
      "body": "Post-merge code review ACK a733dd79e29068ad1e0532ac42a45188a040a7b9\r\n\r\nI also synced and kept a node running for a few days with the status of my previous ACK and didn't see anything unusual.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1660993936",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27746"
    },
    {
      "event": "referenced",
      "id": 10013139267,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJU1GFD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10013139267",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "509a967cbc069921d4dd366f72a34a277ab96494",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/509a967cbc069921d4dd366f72a34a277ab96494",
      "created_at": "2023-08-04T21:09:25Z"
    },
    {
      "event": "referenced",
      "id": 10013193925,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJU1TbF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10013193925",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "3d70aa3c60f07ed6c9eed237b2c82a59674239cf",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/3d70aa3c60f07ed6c9eed237b2c82a59674239cf",
      "created_at": "2023-08-04T21:18:39Z"
    },
    {
      "event": "referenced",
      "id": 10039738598,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJWakDm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10039738598",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "bda557e5ebe7f754984a34ddfd33d2540c0303b9",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/bda557e5ebe7f754984a34ddfd33d2540c0303b9",
      "created_at": "2023-08-08T20:16:19Z"
    },
    {
      "event": "referenced",
      "id": 10051176790,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJXGMlW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10051176790",
      "actor": {
        "login": "sidhujag",
        "id": 6238042,
        "node_id": "MDQ6VXNlcjYyMzgwNDI=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6238042?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sidhujag",
        "html_url": "https://github.com/sidhujag",
        "followers_url": "https://api.github.com/users/sidhujag/followers",
        "following_url": "https://api.github.com/users/sidhujag/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sidhujag/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sidhujag/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sidhujag/subscriptions",
        "organizations_url": "https://api.github.com/users/sidhujag/orgs",
        "repos_url": "https://api.github.com/users/sidhujag/repos",
        "events_url": "https://api.github.com/users/sidhujag/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sidhujag/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "bdd3a75e2d6fd2d13a780a0b4f0362e2bb0c9725",
      "commit_url": "https://api.github.com/repos/syscoin/syscoin/commits/bdd3a75e2d6fd2d13a780a0b4f0362e2bb0c9725",
      "created_at": "2023-08-09T19:02:08Z"
    },
    {
      "event": "referenced",
      "id": 10131848161,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJb57vh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10131848161",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "7e207be21295ec2ac2337d27631aa3cf7e6a9b5b",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/7e207be21295ec2ac2337d27631aa3cf7e6a9b5b",
      "created_at": "2023-08-18T16:50:57Z"
    },
    {
      "event": "referenced",
      "id": 10131848223,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJb57wf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10131848223",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "00a2e4362ffb50f446eb781c7fa5da2231031986",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/00a2e4362ffb50f446eb781c7fa5da2231031986",
      "created_at": "2023-08-18T16:50:57Z"
    },
    {
      "event": "referenced",
      "id": 10131862261,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJb5_L1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10131862261",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "94a98fbd1d14a4ea10629b917771d50f3191e944",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/94a98fbd1d14a4ea10629b917771d50f3191e944",
      "created_at": "2023-08-18T16:52:58Z"
    },
    {
      "event": "referenced",
      "id": 10143391271,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJcl94n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10143391271",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "723f1c669f9b6babfcb789b7b10bb98d1341da60",
      "commit_url": "https://api.github.com/repos/bitcoin-core/gui/commits/723f1c669f9b6babfcb789b7b10bb98d1341da60",
      "created_at": "2023-08-21T09:55:44Z"
    },
    {
      "event": "referenced",
      "id": 10327951308,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJnmAfM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10327951308",
      "actor": {
        "login": "janus",
        "id": 6726,
        "node_id": "MDQ6VXNlcjY3MjY=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6726?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/janus",
        "html_url": "https://github.com/janus",
        "followers_url": "https://api.github.com/users/janus/followers",
        "following_url": "https://api.github.com/users/janus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/janus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/janus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/janus/subscriptions",
        "organizations_url": "https://api.github.com/users/janus/orgs",
        "repos_url": "https://api.github.com/users/janus/repos",
        "events_url": "https://api.github.com/users/janus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/janus/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "622fd40c9bd3df84b8c09b9b97d0dc4fe763d160",
      "commit_url": "https://api.github.com/repos/BitgesellOfficial/bitgesell/commits/622fd40c9bd3df84b8c09b9b97d0dc4fe763d160",
      "created_at": "2023-09-11T01:34:54Z"
    },
    {
      "event": "reviewed",
      "id": 1618995679,
      "node_id": "PRR_kwDOABII585gf-nf",
      "url": null,
      "actor": null,
      "commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1618995679",
      "submitted_at": "2023-09-11T01:40:33Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
    },
    {
      "event": "referenced",
      "id": 10548085747,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ0twPz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10548085747",
      "actor": {
        "login": "Retropex",
        "id": 74937347,
        "node_id": "MDQ6VXNlcjc0OTM3MzQ3",
        "avatar_url": "https://avatars.githubusercontent.com/u/74937347?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Retropex",
        "html_url": "https://github.com/Retropex",
        "followers_url": "https://api.github.com/users/Retropex/followers",
        "following_url": "https://api.github.com/users/Retropex/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Retropex/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Retropex/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Retropex/subscriptions",
        "organizations_url": "https://api.github.com/users/Retropex/orgs",
        "repos_url": "https://api.github.com/users/Retropex/repos",
        "events_url": "https://api.github.com/users/Retropex/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Retropex/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "6fc6f11c505c82462ccdabf6eee243afb9354e8e",
      "commit_url": "https://api.github.com/repos/Retropex/bitcoin/commits/6fc6f11c505c82462ccdabf6eee243afb9354e8e",
      "created_at": "2023-10-04T08:54:44Z"
    },
    {
      "event": "referenced",
      "id": 10548345184,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ0uvlg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10548345184",
      "actor": {
        "login": "Retropex",
        "id": 74937347,
        "node_id": "MDQ6VXNlcjc0OTM3MzQ3",
        "avatar_url": "https://avatars.githubusercontent.com/u/74937347?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Retropex",
        "html_url": "https://github.com/Retropex",
        "followers_url": "https://api.github.com/users/Retropex/followers",
        "following_url": "https://api.github.com/users/Retropex/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Retropex/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Retropex/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Retropex/subscriptions",
        "organizations_url": "https://api.github.com/users/Retropex/orgs",
        "repos_url": "https://api.github.com/users/Retropex/repos",
        "events_url": "https://api.github.com/users/Retropex/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Retropex/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "5f62ed90f6d6629477617872cd808fdbd8efe169",
      "commit_url": "https://api.github.com/repos/Retropex/bitcoin/commits/5f62ed90f6d6629477617872cd808fdbd8efe169",
      "created_at": "2023-10-04T09:16:03Z"
    },
    {
      "event": "referenced",
      "id": 10579939464,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ2nRCI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10579939464",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "12b3a6b205b6c20d2a8da2fa63de11b2b5cc8405",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/12b3a6b205b6c20d2a8da2fa63de11b2b5cc8405",
      "created_at": "2023-10-06T21:42:32Z"
    },
    {
      "event": "referenced",
      "id": 10609227341,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ4W_ZN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10609227341",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f8701707f16616a248141775257741ebdfc56115",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/f8701707f16616a248141775257741ebdfc56115",
      "created_at": "2023-10-10T20:20:34Z"
    },
    {
      "event": "referenced",
      "id": 10623662378,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ5ODkq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10623662378",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "c6122e4c737b1465a30a9839b77db9df3a6d7c44",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/c6122e4c737b1465a30a9839b77db9df3a6d7c44",
      "created_at": "2023-10-11T20:14:24Z"
    },
    {
      "event": "referenced",
      "id": 10633400885,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ5zNI1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10633400885",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "4ee775ed1e39dbddeaf1b84c11f8bc1069001934",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/4ee775ed1e39dbddeaf1b84c11f8bc1069001934",
      "created_at": "2023-10-12T15:44:06Z"
    },
    {
      "event": "referenced",
      "id": 10633713282,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ50ZaC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10633713282",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "decf338fa57de3d2bae868d1607c5d719a0d0fc6",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/decf338fa57de3d2bae868d1607c5d719a0d0fc6",
      "created_at": "2023-10-12T16:06:56Z"
    },
    {
      "event": "referenced",
      "id": 10633713417,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ50ZcJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10633713417",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "2738b971fc8558ee4dc9489e561917d1c2c432e1",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/2738b971fc8558ee4dc9489e561917d1c2c432e1",
      "created_at": "2023-10-12T16:06:57Z"
    },
    {
      "event": "referenced",
      "id": 10636372495,
      "node_id": "REFE_lADOABII585mzBjvzwAAAAJ5-ioP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/10636372495",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "70484b7178ab8cc1e63bc3efb2b569241129445f",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/70484b7178ab8cc1e63bc3efb2b569241129445f",
      "created_at": "2023-10-12T20:07:44Z"
    },
    {
      "event": "referenced",
      "id": 11906014502,
      "node_id": "REFE_lADOABII585mzBjvzwAAAALFp10m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11906014502",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "638841e2ba5c6f534253b970e2acbb3238d8ab1f",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/638841e2ba5c6f534253b970e2acbb3238d8ab1f",
      "created_at": "2024-02-23T16:50:50Z"
    },
    {
      "event": "referenced",
      "id": 11906014562,
      "node_id": "REFE_lADOABII585mzBjvzwAAAALFp11i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/11906014562",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "35d0519c4728a43c0c4ac495692dc63be98543a2",
      "commit_url": "https://api.github.com/repos/ryanofsky/bitcoin/commits/35d0519c4728a43c0c4ac495692dc63be98543a2",
      "created_at": "2024-02-23T16:50:50Z"
    },
    {
      "event": "locked",
      "id": 14205478449,
      "node_id": "LOE_lADOABII585mzBjvzwAAAANOtmYx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14205478449",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-10T20:44:40Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654",
      "pull_request_review_id": 1453921658,
      "id": 1212154654,
      "node_id": "PRRC_kwDOABII585IQAMe",
      "diff_hunk": "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 157,
      "original_position": 101,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: this function seems to come out of nowhere and is only used in a test. ",
      "created_at": "2023-05-31T18:43:09Z",
      "updated_at": "2023-05-31T18:44:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 969,
      "original_line": 969,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483",
      "pull_request_review_id": 1453931065,
      "id": 1212161483,
      "node_id": "PRRC_kwDOABII585IQB3L",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: maybe use this refactor as an opportunity to add a comment explaining the somewhat obtuse line above",
      "created_at": "2023-05-31T18:48:56Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200",
      "pull_request_review_id": 1453931065,
      "id": 1212164200,
      "node_id": "PRRC_kwDOABII585IQCho",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d if it's broken in master, can we fix it _before_ refactoring? Alternatively there could be a `This will be fixed in the next commit` comment.\r\n\r\nI'm also confused by the comment. `TryAddBlockIndexCandidate` is only called from `ReceivedBlockTransactions` after it sets `BLOCK_VALID_TRANSACTIONS`. So are you saying we're currently too strict? Was there a regression somewhere? \r\n",
      "created_at": "2023-05-31T18:50:12Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301",
      "pull_request_review_id": 1453931065,
      "id": 1212173301,
      "node_id": "PRRC_kwDOABII585IQEv1",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d: `\"active\" :\"background\"`?",
      "created_at": "2023-05-31T18:54:47Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629",
      "pull_request_review_id": 1453931065,
      "id": 1212186629,
      "node_id": "PRRC_kwDOABII585IQIAF",
      "diff_hunk": "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 355,
      "original_position": 206,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "534b6f99a3779465678f39ed2704da6049c6469d Previously `LoadExternalBlockFile` was only called on the `ActiveChainstate()`, now you're looping over both. This is ok? If possible, it would be good to move the change to `LoadExternalBlockFile` into a separate commit.",
      "created_at": "2023-05-31T19:06:19Z",
      "updated_at": "2023-05-31T19:10:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4603,
      "original_line": 4603,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047",
      "pull_request_review_id": 1475849986,
      "id": 1227262047,
      "node_id": "PRRC_kwDOABII585JJohf",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this test case expected to fail with the changes in this commit or is it just expected to be incorrect? I tried re-enabling it and it passes.",
      "created_at": "2023-06-12T21:27:34Z",
      "updated_at": "2023-06-12T21:31:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861",
      "pull_request_review_id": 1475849986,
      "id": 1227262861,
      "node_id": "PRRC_kwDOABII585JJouN",
      "diff_hunk": "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 70,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this check expected to fail? I tried uncommenting it and the test passes.",
      "created_at": "2023-06-12T21:28:41Z",
      "updated_at": "2023-06-12T21:31:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 354,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509",
      "pull_request_review_id": 1475849986,
      "id": 1227265509,
      "node_id": "PRRC_kwDOABII585JJpXl",
      "diff_hunk": "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 78,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nThis diff makes the test work, assuming that `TryAddBlockIndexCandidate` is working as it is supposed to be.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 8fab53c5c5..b9fe054a64 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -413,7 +411,6 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\r\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\r\n //!   even those assumed-valid.\r\n //!\r\n-#if 0\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n {\r\n     ChainstateManager& chainman = *Assert(m_node.chainman);\r\n@@ -427,6 +424,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     const int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\r\n \r\n     CBlockIndex* validated_tip{nullptr};\r\n+    CBlockIndex* assumed_base{nullptr};\r\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\r\n \r\n     auto reload_all_block_indexes = [&]() {\r\n@@ -440,10 +438,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\r\n     };\r\n \r\n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\r\n-    // tip candidates.\r\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\r\n+    // considered as a candidate.\r\n     reload_all_block_indexes();\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n@@ -462,27 +460,33 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n             validated_tip = index;\r\n             BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n+        // Note the block after the last assumed valid block as the snapshot base\r\n+        if (i == last_assumed_valid_idx) {\r\n+            assumed_base = index;\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n+        }\r\n     }\r\n \r\n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\r\n \r\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\r\n-        return chainman.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\r\n+\r\n+    // Set tip of the fully validated chain to be the validated tip\r\n+    cs1.m_chain.SetTip(*validated_tip);\r\n \r\n     reload_all_block_indexes();\r\n \r\n-    // The fully validated chain only has candidates up to the start of the assumed-valid\r\n-    // blocks.\r\n+    // The fully validated chain should have the current validated tip, the assumed valid\r\n+    // blocks, and the assumed valid base as candidates.\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), expected_assumed_valid + 2);\r\n \r\n     // The assumed-valid tolerant chain has all blocks as candidates.\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\r\n }\r\n-#endif\r\n \r\n //! Ensure that snapshot chainstates initialize properly when found on disk.\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n```",
      "created_at": "2023-06-12T21:31:38Z",
      "updated_at": "2023-06-12T21:31:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 416,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590",
      "pull_request_review_id": 1477683984,
      "id": 1228448590,
      "node_id": "PRRC_kwDOABII585JOKNO",
      "diff_hunk": "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 157,
      "original_position": 101,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212154654,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Split this out into its own commit.",
      "created_at": "2023-06-13T17:06:01Z",
      "updated_at": "2023-06-13T17:06:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 969,
      "original_line": 969,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099",
      "pull_request_review_id": 1477684761,
      "id": 1228449099,
      "node_id": "PRRC_kwDOABII585JOKVL",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212161483,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think this should be a bit better now?",
      "created_at": "2023-06-13T17:06:32Z",
      "updated_at": "2023-06-13T17:06:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071",
      "pull_request_review_id": 1477717138,
      "id": 1228470071,
      "node_id": "PRRC_kwDOABII585JOPc3",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212164200,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Sorry that comment was confusing.  I dropped it, and instead change the behavior around managing `setBlockIndexCandidates` in the last two commits. \r\n\r\nI think master has a couple bugs. When we start up, in `LoadBlockIndex()` we weren't adding blocks that have been downloaded and have more work than the background chainstate's tip to `setBlockIndexCandidates`, which prevents those blocks from being validated and connected on startup.  Also, because `AcceptBlock()` is a member of `Chainstate`, it's at best confusing to reason about whether a block that would advance the tip of a chainstate would always be added to a chainstate's `setBlockIndexCandidates` (it depends on yet-more logic around where a block came from and guessing about which chainstate might need it).\r\n\r\nThe new code tries to simplify things by establishing that the background chainstate is only trying to connect blocks towards the snapshot block, and that all blocks for which we HAVE_DATA and have more work than the background chainstate's tip (and which are ancestors of the snapshot block) will be added to the background chainstate's `setBlockIndexCandidates`. Also, the logic bug in `LoadBlockIndex` should be fixed in the last commit here.",
      "created_at": "2023-06-13T17:27:27Z",
      "updated_at": "2023-06-13T17:27:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308",
      "pull_request_review_id": 1477719362,
      "id": 1228471308,
      "node_id": "PRRC_kwDOABII585JOPwM",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 37,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212173301,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This LogPrintf() disappeared during my edits, so this is gone now.",
      "created_at": "2023-06-13T17:28:46Z",
      "updated_at": "2023-06-13T17:28:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690",
      "pull_request_review_id": 1477726472,
      "id": 1228475690,
      "node_id": "PRRC_kwDOABII585JOQ0q",
      "diff_hunk": "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 355,
      "original_position": 206,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212186629,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "If you're asking if it's ok to call `ActivateBestChain()` on both chainstates, the answer to that is essentially always \"yes\".  ABC() doesn't do anything if no new candidates for most-work chain have been added to our block index; but if any block that has more work than our tip is now available we want to try to connect it.\r\n\r\nWhen calling `LoadExternalBlockFile()`, we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate.\r\n\r\nI'm not sure how easy this would be to separate out into its own commit, because this invokes `AcceptBlock()` as well...  Hopefully the commit is more manageable now that I've split a bunch of other stuff out?  Let me know if you see a good way to shrink this commit more and I can take a stab at it.",
      "created_at": "2023-06-13T17:33:03Z",
      "updated_at": "2023-06-13T17:33:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4603,
      "original_line": 4603,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418",
      "pull_request_review_id": 1477727655,
      "id": 1228476418,
      "node_id": "PRRC_kwDOABII585JORAC",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262047,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ah, thanks for noticing this. I believe I had an earlier version of this branch with `assert()`'s added in to ensure that the snapshot base was never `nullptr`, and so this test had been failing.  I guess I removed those asserts before pushing...  I've re-enabled the test for now, but really this test should be re-written so that snapshots are always at blocks in the block index.",
      "created_at": "2023-06-13T17:33:50Z",
      "updated_at": "2023-06-13T17:33:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327",
      "pull_request_review_id": 1477729042,
      "id": 1228477327,
      "node_id": "PRRC_kwDOABII585JOROP",
      "diff_hunk": "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 70,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262861,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I have no idea why I commented this out -- I've re-added as well.",
      "created_at": "2023-06-13T17:34:46Z",
      "updated_at": "2023-06-13T17:34:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 354,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661",
      "pull_request_review_id": 1477759637,
      "id": 1228498661,
      "node_id": "PRRC_kwDOABII585JOWbl",
      "diff_hunk": "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 78,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227265509,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks, I took these changes and re-enabled the test.",
      "created_at": "2023-06-13T17:51:47Z",
      "updated_at": "2023-06-13T17:51:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 416,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228",
      "pull_request_review_id": 1478071545,
      "id": 1228709228,
      "node_id": "PRRC_kwDOABII585JPJ1s",
      "diff_hunk": "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "path": "src/validation.h",
      "position": null,
      "original_position": 114,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "typo: is -> if\r\nAlso, another way for `AcceptBlock()` to return false is if the block/header are valid, but `SaveBlockToDisk()` failed for some reason (e.g. missing disk space).",
      "created_at": "2023-06-13T21:21:13Z",
      "updated_at": "2023-06-14T21:59:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228709228",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1158,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689",
      "pull_request_review_id": 1479818774,
      "id": 1229850689,
      "node_id": "PRRC_kwDOABII585JTghB",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262047,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> this test should be re-written so that snapshots are always at blocks in the block index.\r\n\r\nDoes it? AFAICT, it doesn't test anything within the block index at all, and the only part that does is `LoadGenesisBlock`.",
      "created_at": "2023-06-14T15:57:05Z",
      "updated_at": "2023-06-14T15:57:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664",
      "pull_request_review_id": 1479831868,
      "id": 1229858664,
      "node_id": "PRRC_kwDOABII585JTido",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262047,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "See https://github.com/bitcoin/bitcoin/pull/27746/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bL141\r\n\r\n```c++\r\nChainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n```\r\n\r\nTrying to activate a snapshot for a block that is not in the block index ought to be an illegal operation.",
      "created_at": "2023-06-14T16:03:01Z",
      "updated_at": "2023-06-14T16:09:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387",
      "pull_request_review_id": 1479901411,
      "id": 1229903387,
      "node_id": "PRRC_kwDOABII585JTtYb",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262047,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ah I see. Seems like this could be easily resolved by using `TestChain100Setup`\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 2d0e1705fd..3d90bdcc26 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -105,7 +105,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\r\n }\r\n \r\n //! Test rebalancing the caches associated with each chainstate.\r\n-BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_rebalance_caches, TestChain100Setup)\r\n {\r\n     ChainstateManager& manager = *m_node.chainman;\r\n     CTxMemPool& mempool = *m_node.mempool;\r\n@@ -118,7 +118,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a legacy (IBD) chainstate.\r\n     //\r\n-    Chainstate& c1 = WITH_LOCK(::cs_main, return manager.InitializeChainstate(&mempool));\r\n+    Chainstate& c1 = manager.ActiveChainstate();\r\n     chainstates.push_back(&c1);\r\n     c1.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -126,8 +126,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c1.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c1.LoadGenesisBlock());\r\n-        c1.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n@@ -136,7 +134,8 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a snapshot-based chainstate.\r\n     //\r\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\r\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\r\n     chainstates.push_back(&c2);\r\n     c2.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -144,8 +143,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c2.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());\r\n-        c2.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n```",
      "created_at": "2023-06-14T16:42:20Z",
      "updated_at": "2023-06-14T16:42:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759",
      "pull_request_review_id": 1478071545,
      "id": 1230085759,
      "node_id": "PRRC_kwDOABII585JUZ5_",
      "diff_hunk": "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "how about inserting and returning here in the `!is_bg_chainstate` case, so that we can skip the `GetAncestor()` call when dealing with the snapshot chainstate?",
      "created_at": "2023-06-14T19:42:25Z",
      "updated_at": "2023-06-14T21:59:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230085759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3412,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278",
      "pull_request_review_id": 1478071545,
      "id": 1230212278,
      "node_id": "PRRC_kwDOABII585JU4y2",
      "diff_hunk": "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 42,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I don't think this line does anything. It's called during init from `LoadChainstate() -> DetectSnapshotChainstate()`, at which point `m_snapshot_chainstate->m_snapshot_entry` isn't set yet. That only happens right after, in `CompleteChainstateInitialization() -> LoadBlockIndex()`.\r\n\r\nThe ctor of `Chainstate` also wouldn't have set `m_snapshot_entry` for the same reason (the block index is loaded after the chainstate).",
      "created_at": "2023-06-14T21:58:00Z",
      "updated_at": "2023-06-14T22:25:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230212278",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5662,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094",
      "pull_request_review_id": 1482164683,
      "id": 1231392094,
      "node_id": "PRRC_kwDOABII585JZY1e",
      "diff_hunk": "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "in_reply_to_id": 1227262047,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thank you! I took this and updated the commit where this test was changed.",
      "created_at": "2023-06-15T18:22:15Z",
      "updated_at": "2023-06-15T18:22:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392094",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 108,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237",
      "pull_request_review_id": 1482165009,
      "id": 1231392237,
      "node_id": "PRRC_kwDOABII585JZY3t",
      "diff_hunk": "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "path": "src/validation.h",
      "position": null,
      "original_position": 114,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "in_reply_to_id": 1228709228,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed.",
      "created_at": "2023-06-15T18:22:24Z",
      "updated_at": "2023-06-15T18:22:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392237",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1158,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858",
      "pull_request_review_id": 1482165706,
      "id": 1231392858,
      "node_id": "PRRC_kwDOABII585JZZBa",
      "diff_hunk": "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "in_reply_to_id": 1230085759,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed, good idea.",
      "created_at": "2023-06-15T18:22:53Z",
      "updated_at": "2023-06-15T18:22:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392858",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3412,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061",
      "pull_request_review_id": 1482165883,
      "id": 1231393061,
      "node_id": "PRRC_kwDOABII585JZZEl",
      "diff_hunk": "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 42,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "in_reply_to_id": 1230212278,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good catch, removed this and left a comment there instead.",
      "created_at": "2023-06-15T18:23:02Z",
      "updated_at": "2023-06-15T18:23:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231393061",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5662,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866",
      "pull_request_review_id": 1483231139,
      "id": 1232107866,
      "node_id": "PRRC_kwDOABII585JcHla",
      "diff_hunk": "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Explicitly track maximum block height stored in undo files\" (6cc09f4759444218d1b493a1bcf44bb63f3160d2)\r\n\r\nWhen I first read this comment, I misinterpreted \"whose undo data is in m_last_blockfile\" to mean \"whose undo data belongs in m_last_blockfile\" as opposed to \"whose undo data has already been written to m_last_blockfile\". So I was confused about how it was working. Would suggest changing this sentence to something like \"Track the height of the highest block in m_last_blockfile whose undo data has been written.\"\r\n\r\nI also don't think if would hurt if there could be more explanation after this like: \"Block data is written to block files in download order, but is written to undo files in validation order, which is usually in order by height. To avoid wasting disk space, undo files will be will trimmed whenever the corresponding block file is finalized and the height of the highest block written to the block file equals the height of the highest block written to the undo file. This is a heuristic and can sometimes preemptively trim undo files that will write more data later, and sometimes fail to trim undo files that can't have more data written later.\"",
      "created_at": "2023-06-16T11:07:14Z",
      "updated_at": "2023-06-16T23:01:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232107866",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800",
      "pull_request_review_id": 1483231139,
      "id": 1232240800,
      "node_id": "PRRC_kwDOABII585JcoCg",
      "diff_hunk": "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (2ebdfa8529b222de0db6d7114e9e5a1622fecfd0)\r\n\r\nJust IMO, but I think it would good to delete the `m_chainman.nBlockSequenceId = 1` line in this commit instead of next commit \"Add wrapper for adding entries to a chainstates block index candidates\" (df6576d48e4daff2b9787fe7d2d254ffce2eb998). I also think it would also be good to rename `UnloadBlockIndex` to `ClearBlockIndexCandidates` here. Doing these things would leave the code in a less confusing state after this commit, even if it makes this diff a little bigger.",
      "created_at": "2023-06-16T13:17:30Z",
      "updated_at": "2023-06-16T23:01:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4373,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431",
      "pull_request_review_id": 1483231139,
      "id": 1232489431,
      "node_id": "PRRC_kwDOABII585JdkvX",
      "diff_hunk": "@@ -138,16 +134,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n \n     // Create a snapshot-based chainstate.\n     //\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 79,
      "original_position": 78,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (b0b48b3e986319fe8cd5a80052099070279ce5c0)\r\n\r\nNote for reviewers: A real hash is being passed instead of GetRandHash() now, because of discussion https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047, because `ActivateExistingSnapshot` should not be expected to work when called with an invalid blockhash even if it does work now.",
      "created_at": "2023-06-16T16:39:26Z",
      "updated_at": "2023-06-16T23:01:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232489431",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 142,
      "original_line": 142,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002",
      "pull_request_review_id": 1483231139,
      "id": 1232578002,
      "node_id": "PRRC_kwDOABII585Jd6XS",
      "diff_hunk": "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "path": "src/validation.cpp",
      "position": 435,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499):\r\n\r\nI think this also needs to add `if (pindex == pindexFirstAssumeValid) pindexFirstAssumeValid = nullptr;` at line 4881 to reset `pindexFirstAssumeValid` when moving to a sibling.",
      "created_at": "2023-06-16T18:08:43Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232578002",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4731,
      "original_line": 4731,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541",
      "pull_request_review_id": 1483231139,
      "id": 1232705541,
      "node_id": "PRRC_kwDOABII585JeZgF",
      "diff_hunk": "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the\n         // full block yet.\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA) && !pindex->IsAssumedValid()) {",
      "path": "src/validation.cpp",
      "position": 439,
      "original_position": 11,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nNote: This change is partially reverting [`8f5710f`](https://github.com/bitcoin/bitcoin/pull/21526/commits/8f5710fd0ac5173b577e5d00708485170b321bcc) from #21526",
      "created_at": "2023-06-16T20:03:10Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232705541",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4725,
      "original_line": 4725,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285",
      "pull_request_review_id": 1483231139,
      "id": 1232733285,
      "node_id": "PRRC_kwDOABII585JegRl",
      "diff_hunk": "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nShould also delete this \"Assumed-valid index entries will not have data\" comment, I think, since it doesn't really explain anything and no longer seems relevant here",
      "created_at": "2023-06-16T20:14:07Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232733285",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4719,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393",
      "pull_request_review_id": 1483231139,
      "id": 1232743393,
      "node_id": "PRRC_kwDOABII585Jeivh",
      "diff_hunk": "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 46,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nThis is very pedantic but the phrase \"snapshotted chain\" here and in the commit description doesn't really parse for me. It sounds like a chain a snapshot was created from, not a chain created from a snapshot. Could maybe replace \"snapshotted chain\" with \"chain based on assumeutxo snapshot\"",
      "created_at": "2023-06-16T20:25:25Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232743393",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857",
      "pull_request_review_id": 1483231139,
      "id": 1232771857,
      "node_id": "PRRC_kwDOABII585JepsR",
      "diff_hunk": "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "path": "src/validation.cpp",
      "position": 252,
      "original_position": 14,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f02125f1c7ba1c77c6d4ddb028999090fe5298eb)\r\n\r\nI think it would be good to drop this whole for-loop. The loop was originally added in [`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 to compute `first_assumed_valid_height`. Adding the asserts there was really an afterthought, so keeping this loop just to make assertions about ChainStateManager doesn't seem worth it. Dropping the loop and asserts would also allow dropping the reliesOnAssumedValid method, which would be nice to get rid of.",
      "created_at": "2023-06-16T20:54:46Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232771857",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4419,
      "original_line": 4419,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481",
      "pull_request_review_id": 1484375498,
      "id": 1232772481,
      "node_id": "PRRC_kwDOABII585Jep2B",
      "diff_hunk": "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "in_reply_to_id": null,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In b0b48b3e986319fe8cd5a80052099070279ce5c0 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nnit: can inline\r\n\r\n```suggestion\r\n            if (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex) {\r\n```",
      "created_at": "2023-06-16T20:55:51Z",
      "updated_at": "2023-06-16T21:16:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232772481",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": 3427,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3428,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224",
      "pull_request_review_id": 1483231139,
      "id": 1232795224,
      "node_id": "PRRC_kwDOABII585JevZY",
      "diff_hunk": "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "path": "src/validation.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Explicitly track snapshot block header when using multiple chainstates\" (d2ccbd3541622147ab0d4b808a1b9388ddcd7948)\r\n\r\nI don't think adding this `Chainstate::m_snapshot_entry` variable is a good idea. I don't like how it has different meanings for different chainstates (starting point of validation for the snapshot chainstate, and ending point for the background chainstate), and the lack of documentation, and the complicated initialization which happens in the Chainstate constructor for the snapshot chainstate, but also in `ActivateSnapshot` for both chainstates, and then again in `LoadBlockIndex` for both chainstates, and pointedly _not_ in `ActivateExistingSnapshot` according to a new comment there saying it will be initialized later... It just seems like a lot of complexity for new variable which is redundant with the existing `m_from_snapshot_blockhash` variable and is only used one place, in `Chainstate::TryAddBlockIndexCandidate`.\r\n\r\nI think it would be better if `Chainstate::TryAddBlockIndexCandidate` just used snapshot chainstate's `m_from_snapshot_blockhash` value directly. Or if that is too inefficient, we could add a `m_from_snapshot_blockindex` member that mirrors `m_from_snapshot_blockhash` and is const and could be initialized straightforwardly in the `ChainState` constructor.",
      "created_at": "2023-06-16T21:25:58Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 497,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245",
      "pull_request_review_id": 1483231139,
      "id": 1232807245,
      "node_id": "PRRC_kwDOABII585JeyVN",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212164200,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071e\r\n\r\n> I think master has a couple bugs.\r\n\r\nI'm curious if there is actually more than one bug. The one bug I know about is the bug introduced \r\n[`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 where `LoadBlockIndex` is misinterpreting the `BLOCK_ASSUMED_VALID` flag, and setting `first_assumed_valid_height` to the height of the first assumed valid block, instead of the height of the first block after the last assumed valid block (i.e. the snapshot height). I think it's pretty bad that we didn't catch this bug in review, or push for a more realistic test that would have caught it, or followed up on the suggestion from Marco https://github.com/bitcoin/bitcoin/pull/23174#discussion_r768600512 to just add blocks to `setBlockIndexCandidates` linearly, which is what this PR does, and is much more straightforward.\r\n\r\nAre there other known bugs? Are the changes to `AcceptBlock` meant to fix a bug or more to prevent a potential bug? Does the change to `ChainstateManager::ReceivedBlockTransactions` fix a bug? It seems like maybe it could prevent inappropriate blocks being added as candidates to the background chainstate, but it's not clear.",
      "created_at": "2023-06-16T21:37:44Z",
      "updated_at": "2023-06-16T23:01:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232807245",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270",
      "pull_request_review_id": 1484538346,
      "id": 1232868270,
      "node_id": "PRRC_kwDOABII585JfBOu",
      "diff_hunk": "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "path": "src/validation.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "in_reply_to_id": 1232795224,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think I concur with @ryanofsky here. I'll have to double check, but in actual usage in #27596, I think I found that the one usage of this had another (existing) way of getting at this data. I'm afk for a few days, but will verify when I get back.",
      "created_at": "2023-06-16T23:06:31Z",
      "updated_at": "2023-06-16T23:06:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232868270",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 497,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513",
      "pull_request_review_id": 1484629167,
      "id": 1232921513,
      "node_id": "PRRC_kwDOABII585JfOOp",
      "diff_hunk": "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "path": "src/validation.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "in_reply_to_id": 1232795224,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I agree with your criticisms that the way this is written is pretty confusing (it took me a while to get it right in the first place, and I found this hard to reason about).  \r\n\r\nI wanted to capture the idea that the hash `m_from_snapshot_blockhash` must always be in our block index, so that we never have to worry when we look it up in the block index that it might be missing, and we have to deal with a nullptr case.\r\n\r\nHowever, I couldn't see how to make it a const that is straightforwardly initialized in `Chainstate`, because there are two different cases to consider (activating a snapshot for the first time, versus detecting that we have a snapshot on restart).\r\n\r\nAlso, while this PR introduces one place where this CBlockIndex is used, I expect that we'll use it again in the `net_processing` code which will download blocks toward the snapshot base.\r\n\r\nHere are a few options I can think of to improve this:\r\n* just look the hash up every time we need to use it (both in `TryAddBlockIndexCandidate` and wherever it is needed in `net_processing`, likely one additional place), avoiding the storage of redundant information\r\n* lazily fill it in so that we only look it up once, and then use the looked-up value for future requests\r\n* move the knowledge of the snapshot base to `ChainstateManager`, so that we don't store redundant information in both chainstates (this could be done along with either of the first two ideas, I think?)\r\n\r\nEDIT: Gah, I just noticed `ChainstateManager::GetSnapshotBaseBlock()`, didn't realize we already had that.  I think I know what to do now to fix this!",
      "created_at": "2023-06-17T01:19:05Z",
      "updated_at": "2023-06-17T14:50:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 497,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766",
      "pull_request_review_id": 1484629417,
      "id": 1232921766,
      "node_id": "PRRC_kwDOABII585JfOSm",
      "diff_hunk": "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 16,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "in_reply_to_id": 1232772481,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done in 0274b79285f781c3374678208dc3e00607907c7f",
      "created_at": "2023-06-17T01:21:07Z",
      "updated_at": "2023-06-17T01:21:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921766",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": 3427,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3428,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860",
      "pull_request_review_id": 1484629548,
      "id": 1232921860,
      "node_id": "PRRC_kwDOABII585JfOUE",
      "diff_hunk": "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "in_reply_to_id": 1232107866,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks -- this is much better, took your language in daeba143a718c95b11432aed909781affe33efea.",
      "created_at": "2023-06-17T01:22:04Z",
      "updated_at": "2023-06-17T01:22:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921860",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177",
      "pull_request_review_id": 1484629997,
      "id": 1232922177,
      "node_id": "PRRC_kwDOABII585JfOZB",
      "diff_hunk": "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "path": "src/validation.cpp",
      "position": 435,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": 1232578002,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed in 95680a6e90bbf27183dcf09b5c450494d356ebe5.\r\nGood catch, thanks.  It seems unfortunate that this wasn't caught by any unit tests; perhaps we should come up with a test case that will more fully exercise all of the `CheckBlockIndex()` logic?",
      "created_at": "2023-06-17T01:22:51Z",
      "updated_at": "2023-06-17T01:22:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4731,
      "original_line": 4731,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226",
      "pull_request_review_id": 1484630070,
      "id": 1232922226,
      "node_id": "PRRC_kwDOABII585JfOZy",
      "diff_hunk": "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 9,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": 1232733285,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good catch, that comment was incorrect (blocks retain their assumevalid status until they are validated, which can be some time after they are downloaded).  Removed this comment in 95680a6e90bbf27183dcf09b5c450494d356ebe5.",
      "created_at": "2023-06-17T01:23:14Z",
      "updated_at": "2023-06-17T01:23:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922226",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4719,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290",
      "pull_request_review_id": 1484630205,
      "id": 1232922290,
      "node_id": "PRRC_kwDOABII585JfOay",
      "diff_hunk": "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 46,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bb47ea918c19cd7063f529c0087bd156af18b499",
      "in_reply_to_id": 1232743393,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good point, fixed in this place in the code in 95680a6e90bbf27183dcf09b5c450494d356ebe5.  Will try to fix up the commit descriptions when I squash/rebase. \r\n\r\nEdit: this is now fixed in the commit messages as well.",
      "created_at": "2023-06-17T01:23:50Z",
      "updated_at": "2023-06-17T13:20:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922290",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062",
      "pull_request_review_id": 1484631732,
      "id": 1232923062,
      "node_id": "PRRC_kwDOABII585JfOm2",
      "diff_hunk": "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "path": "src/validation.cpp",
      "position": 252,
      "original_position": 14,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "in_reply_to_id": 1232771857,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ah, ok -- I've removed this in 1aebb99a10f9977e1d1bf4b923e2a2e984c76160.\r\n\r\nSo, one thing I haven't fixed yet is the reference to `pindex->IsAssumedValid()` just below this for loop:\r\n\r\n```c++\r\n\r\n        for (CBlockIndex* pindex : vSortedByHeight) {\r\n            if (ShutdownRequested()) return false;\r\n            if (pindex->IsAssumedValid() ||\r\n                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n                     (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\r\n\r\n                for (Chainstate* chainstate : GetAll()) {\r\n                    chainstate->TryAddBlockIndexCandidate(pindex);\r\n                }\r\n            }\r\n```\r\n\r\nReally, the assumed-valid status bit has nothing to do with whether a block index should be a most-work-chain candidate, except that right when a snapshot is activated, we need the base block to be added to `setBlockIndexCandidates` for the chain that is based on that snapshot.  Probably I should fix this in this PR as well?",
      "created_at": "2023-06-17T01:27:09Z",
      "updated_at": "2023-06-17T01:27:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4419,
      "original_line": 4419,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887",
      "pull_request_review_id": 1484635600,
      "id": 1232925887,
      "node_id": "PRRC_kwDOABII585JfPS_",
      "diff_hunk": "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212164200,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I guess the fairest thing to say is that the changes to `AcceptBlock()` are to prevent a future bug -- it's possible that we could write code that somehow gets it right, but the design of selectively adding blocks to one chainstate's block index, and not the other, is one that I found very confusing. \r\n\r\nAs an example, if you took #24008 (which proposed logic for determining which chainstate to invoke AcceptBlock() on) and combined that with changing the logic in `AcceptBlock()` so that the background chainstate wouldn't bother processing blocks that are past the snapshot base, then that would be problematic if we were to allow pruning the snapshot-based-chain while the background sync is running (because according to the logic in #24008, if the block is already on the active chain, then we give it to the background chainstate to process).  That's 2 hypotheticals so certainly this is speculative, but I think that those changes would all make sense on their own, so the fact that they fail to compose with the code in master is a sign to me that we should take a different design.",
      "created_at": "2023-06-17T01:46:17Z",
      "updated_at": "2023-06-17T01:46:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232925887",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3449,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742",
      "pull_request_review_id": 1484825023,
      "id": 1233062742,
      "node_id": "PRRC_kwDOABII585JfwtW",
      "diff_hunk": "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "in_reply_to_id": 1232240800,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done in latest push.",
      "created_at": "2023-06-17T13:29:42Z",
      "updated_at": "2023-06-17T13:29:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233062742",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4373,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233077487",
      "pull_request_review_id": 1484840490,
      "id": 1233077487,
      "node_id": "PRRC_kwDOABII585Jf0Tv",
      "diff_hunk": "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "path": "src/validation.h",
      "position": null,
      "original_position": 7,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "in_reply_to_id": 1232795224,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513\r\n\r\n> EDIT: Gah, I just noticed ChainstateManager::GetSnapshotBaseBlock(), didn't realize we already had that. I think I know what to do now to fix this!\r\n\r\nThanks, I didn't realize how clunky ChainstateManager initialization was when I made that suggestion. Particularly how it allowed construction with that snapshot block that wasn't actually in the index. I think initialization can definitely be simplified later. But even without doing that I experimented a little and came up with a change that adds `CS::SnapshotBase()` and `CSM::ActiveSnapshotBase()` methods that I think should provide a good interface for external code to use, while allowing us to clean up the internal representation and init process later:\r\n\r\n```diff\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -528,12 +528,8 @@ protected:\r\n     //! is set to true on the snapshot chainstate.\r\n     bool m_disabled GUARDED_BY(::cs_main) {false};\r\n \r\n-    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n-        { m_snapshot_entry = entry; }\r\n-\r\n-    //! Track the snapshot entry\r\n-    const CBlockIndex* m_snapshot_entry GUARDED_BY(::cs_main) {nullptr};\r\n-\r\n+    //! Cached result of LookupBlockIndex(*m_from_snapshot_blockhash)\r\n+    const CBlockIndex* m_cached_snapshot_base GUARDED_BY(::cs_main) {nullptr};\r\n \r\n public:\r\n     //! Reference to a BlockManager instance which itself is shared across all\r\n@@ -586,6 +582,13 @@ public:\r\n      */\r\n     const std::optional<uint256> m_from_snapshot_blockhash;\r\n \r\n+    /**\r\n+     * The base of the snapshot this chainstate was created from.\r\n+     *\r\n+     * nullptr if this chainstate was not created from a snapshot.\r\n+     */\r\n+    const CBlockIndex* SnapshotBase() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+\r\n     //! Return true if this chainstate relies on blocks that are assumed-valid. In\r\n     //! practice this means it was created based on a UTXO snapshot.\r\n     bool reliesOnAssumedValid() { return m_from_snapshot_blockhash.has_value(); }\r\n@@ -1093,6 +1096,11 @@ public:\r\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\r\n     }\r\n \r\n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+    {\r\n+        return m_active_chainstate ? m_active_chainstate->SnapshotBase() : nullptr;\r\n+    }\r\n+\r\n     /**\r\n      * Import blocks from an external file\r\n      *\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1579,9 +1579,13 @@ Chainstate::Chainstate(\r\n       m_chainman(chainman),\r\n       m_from_snapshot_blockhash(from_snapshot_blockhash)\r\n {\r\n-    if (m_from_snapshot_blockhash) {\r\n-        m_snapshot_entry = WITH_LOCK(::cs_main, return m_chainman.m_blockman.LookupBlockIndex(*m_from_snapshot_blockhash));\r\n-    }\r\n+}\r\n+\r\n+const CBlockIndex* Chainstate::SnapshotBase()\r\n+{\r\n+    if (!m_from_snapshot_blockhash) return nullptr;\r\n+    if (!m_cached_snapshot_base) m_cached_snapshot_base = Assert(m_chainman.m_blockman.LookupBlockIndex(*m_from_snapshot_blockhash));\r\n+    return m_cached_snapshot_base;\r\n }\r\n \r\n void Chainstate::InitCoinsDB(\r\n@@ -3423,8 +3427,9 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\r\n             // For the background chainstate, we only consider connecting blocks\r\n             // towards the snapshot base (which can't be nullptr or else we'll\r\n             // never make progress).\r\n-            assert(m_snapshot_entry != nullptr);\r\n-            if (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex) {\r\n+            const CBlockIndex* snapshot_base{m_chainman.ActiveSnapshotBase()};\r\n+            assert(snapshot_base != nullptr);\r\n+            if (snapshot_base->GetAncestor(pindex->nHeight) == pindex) {\r\n                 setBlockIndexCandidates.insert(pindex);\r\n             }\r\n         }\r\n@@ -4416,14 +4421,6 @@ bool ChainstateManager::LoadBlockIndex()\r\n         bool ret{m_blockman.LoadBlockIndexDB()};\r\n         if (!ret) return false;\r\n \r\n-        // If we already have 2 chainstates, then we need to update the\r\n-        // snapshot base to point to the correct block entry.\r\n-        if (IsSnapshotActive()) {\r\n-            CBlockIndex *entry = m_blockman.LookupBlockIndex(*SnapshotBlockhash());\r\n-            m_ibd_chainstate->UpdateSnapshotBaseEntry(entry);\r\n-            m_snapshot_chainstate->UpdateSnapshotBaseEntry(entry);\r\n-        }\r\n-\r\n         m_blockman.ScanAndUnlinkAlreadyPrunedFiles();\r\n \r\n         std::vector<CBlockIndex*> vSortedByHeight{m_blockman.GetAllBlockIndices()};\r\n@@ -5142,8 +5139,6 @@ bool ChainstateManager::ActivateSnapshot(\r\n             m_snapshot_chainstate->CoinsTip().DynamicMemoryUsage() / (1000 * 1000));\r\n \r\n         this->MaybeRebalanceCaches();\r\n-\r\n-        m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;\r\n     }\r\n     return true;\r\n }\r\n@@ -5623,8 +5618,6 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\r\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\r\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\r\n     m_active_chainstate = m_snapshot_chainstate.get();\r\n-    // Note: m_snapshot_entry will be populated after the block index is\r\n-    // loaded; see ChainstateManager::LoadBlockIndex.\r\n     return *m_snapshot_chainstate;\r\n }\r\n \r\n```\r\n\r\n",
      "created_at": "2023-06-17T15:16:18Z",
      "updated_at": "2023-06-17T15:16:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233077487",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233077487"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 497,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233278470",
      "pull_request_review_id": 1485089804,
      "id": 1233278470,
      "node_id": "PRRC_kwDOABII585JglYG",
      "diff_hunk": "@@ -28,20 +28,20 @@ BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n     BlockManager blockman{blockman_opts};\n     CChain chain {};\n     // simulate adding a genesis block normally\n-    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);",
      "path": "src/test/blockmanager_tests.cpp",
      "position": 7,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "in_reply_to_id": null,
      "user": {
        "login": "darosior",
        "id": 22457751,
        "node_id": "MDQ6VXNlcjIyNDU3NzUx",
        "avatar_url": "https://avatars.githubusercontent.com/u/22457751?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/darosior",
        "html_url": "https://github.com/darosior",
        "followers_url": "https://api.github.com/users/darosior/followers",
        "following_url": "https://api.github.com/users/darosior/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/darosior/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/darosior/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/darosior/subscriptions",
        "organizations_url": "https://api.github.com/users/darosior/orgs",
        "repos_url": "https://api.github.com/users/darosior/repos",
        "events_url": "https://api.github.com/users/darosior/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/darosior/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `CChain chain {};` above is now unused.",
      "created_at": "2023-06-18T13:05:32Z",
      "updated_at": "2023-06-18T14:26:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233278470",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233278470"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 34,
      "original_line": 34,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233337055",
      "pull_request_review_id": 1485148184,
      "id": 1233337055,
      "node_id": "PRRC_kwDOABII585Jgzrf",
      "diff_hunk": "@@ -28,20 +28,20 @@ BOOST_AUTO_TEST_CASE(blockmanager_find_block_pos)\n     BlockManager blockman{blockman_opts};\n     CChain chain {};\n     // simulate adding a genesis block normally\n-    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, chain, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);\n+    BOOST_CHECK_EQUAL(blockman.SaveBlockToDisk(params->GenesisBlock(), 0, nullptr).nPos, BLOCK_SERIALIZATION_HEADER_SIZE);",
      "path": "src/test/blockmanager_tests.cpp",
      "position": 7,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "in_reply_to_id": 1233278470,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed in 4a699011048e88099545a612075b5483ff55f533.",
      "created_at": "2023-06-18T16:41:45Z",
      "updated_at": "2023-06-18T16:42:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233337055",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233337055"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 34,
      "original_line": 34,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233368008",
      "pull_request_review_id": 1485181856,
      "id": 1233368008,
      "node_id": "PRRC_kwDOABII585Jg7PI",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 3,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks for adding the comment. I would much prefer it if this line was a guard clause. Currently, it wraps the entire function body. I find guard clauses improve readability significantly in that case.",
      "created_at": "2023-06-18T19:49:01Z",
      "updated_at": "2023-06-22T22:01:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233368008",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233368008"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233829135",
      "pull_request_review_id": 1485874548,
      "id": 1233829135,
      "node_id": "PRRC_kwDOABII585Jir0P",
      "diff_hunk": "@@ -3453,21 +3453,21 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n             pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-            pindex->nSequenceId = nBlockSequenceId++;\n-            for (Chainstate *c : GetAll()) {\n+            pindex->nSequenceId = chainman.nBlockSequenceId++;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 29,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`nBlockSequenceId` should only ever increase, so I would suggest wrapping this in a `ChainstateManger::GetNewBlockSequenceId` (or similar) and making `nBlockSequenceId` private.",
      "created_at": "2023-06-19T10:06:27Z",
      "updated_at": "2023-06-19T11:02:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233829135",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233829135"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3456,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233857394",
      "pull_request_review_id": 1485874548,
      "id": 1233857394,
      "node_id": "PRRC_kwDOABII585Jiyty",
      "diff_hunk": "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.\n+ * @param[in]   fRequested      Whether we requested this block from a\n+ *                              peer.\n+ * @param[in]   dbp             The location on disk, if we are importing\n+ *                              this block from prior storage.\n+ * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+ *                              been done by caller for headers chain\n+ *\n+ * @param[out]  state       The state of the block validation.\n+ * @param[out]  ppindex     Optional return parameter to get the\n+ *                          CBlockIndex pointer for this block.\n+ * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+ *                          block is new to our storage.\n+ *\n+ * @returns   False if the block or header is invalid, or if saving to disk fails (likely a fatal error); true otherwise.\n+ */\n+bool AcceptBlock(const std::shared_ptr<const CBlock>& pblock, ChainstateManager& chainman, BlockValidationState& state, CBlockIndex** ppindex, bool fRequested, const FlatFilePos* dbp, bool* fNewBlock, bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+void ReceivedBlockTransactions(const CBlock& block, ChainstateManager& chainman, CBlockIndex* pindexNew, const FlatFilePos& pos) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "path": "src/validation.h",
      "position": null,
      "original_position": 39,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "turbo nit: All params except chainman are related to the block you are passing in, so having the chainman in the middle feels a bit out of order. Would suggest placing it first or last.",
      "created_at": "2023-06-19T10:24:48Z",
      "updated_at": "2023-06-19T11:02:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233857394",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233857394"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": 373,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 375,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233860685",
      "pull_request_review_id": 1485874548,
      "id": 1233860685,
      "node_id": "PRRC_kwDOABII585JizhN",
      "diff_hunk": "@@ -3816,13 +3816,13 @@ bool ChainstateManager::AcceptBlockHeader(const CBlockHeader& block, BlockValida\n             // hasn't been validated up to BLOCK_VALID_SCRIPTS. This is a performance\n             // optimization, in the common case of adding a new block to the tip,\n             // we don't need to iterate over the failed blocks list.\n-            for (const CBlockIndex* failedit : m_failed_blocks) {\n+            for (const CBlockIndex* failedit : chainman.m_failed_blocks) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 103,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Accessing `m_failed_blocks` directly doesn't seem like a clean interface. I think it would be nicer if this entire for loop would be wrapped in a method on chainman.",
      "created_at": "2023-06-19T10:28:00Z",
      "updated_at": "2023-06-19T11:02:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233860685",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233860685"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3819,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237396224",
      "pull_request_review_id": 1491402431,
      "id": 1237396224,
      "node_id": "PRRC_kwDOABII585JwSsA",
      "diff_hunk": "@@ -604,7 +604,7 @@ fs::path BlockManager::GetBlockPosFilename(const FlatFilePos& pos) const\n     return BlockFileSeq().FileName(pos);",
      "path": "src/node/blockstorage.cpp",
      "position": 1,
      "original_position": 1,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "59b085f4d8bb5120c14b055ce394c06fe129dc60",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "(General note on https://github.com/bitcoin/bitcoin/pull/27746/commits/59b085f4d8bb5120c14b055ce394c06fe129dc60)\r\n\r\nReviewers may be interested to take a look at a related future commit in #27596, https://github.com/bitcoin/bitcoin/pull/27596/commits/906ae54c11d873cfc1803078b9ce7822fc00bfd4, where I propose adding `chainstate_role` as a simple enum parameter to `FindBlockPos()` so that we may segment block storage by chainstate type.",
      "created_at": "2023-06-21T18:10:43Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237396224",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237396224"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 618,
      "original_line": 618,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237406346",
      "pull_request_review_id": 1491402431,
      "id": 1237406346,
      "node_id": "PRRC_kwDOABII585JwVKK",
      "diff_hunk": "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "path": "src/node/chainstate.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "96cd3b06357c08a894d43e45acc456e4f0350e09",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No need to call `ResetBlockSequenceCounters()` here to preserve existing behavior?",
      "created_at": "2023-06-21T18:18:34Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237406346",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237406346"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 224,
      "original_line": 224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237491817",
      "pull_request_review_id": 1491402431,
      "id": 1237491817,
      "node_id": "PRRC_kwDOABII585JwqBp",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nIf you happen to retouch, could `ActiveChain().Tip()` -> `ActiveTip()`.",
      "created_at": "2023-06-21T19:04:25Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237491817",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237491817"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3925,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237494340",
      "pull_request_review_id": 1491402431,
      "id": 1237494340,
      "node_id": "PRRC_kwDOABII585JwqpE",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);\n     // Blocks that are too out-of-order needlessly limit the effectiveness of\n     // pruning, because pruning will not delete block files that contain any\n     // blocks which are too close in height to the tip.  Apply this test\n     // regardless of whether pruning is enabled; it should generally be safe to\n     // not process unrequested blocks.\n-    bool fTooFarAhead{pindex->nHeight > m_chain.Height() + int(MIN_BLOCKS_TO_KEEP)};\n+    bool fTooFarAhead{pindex->nHeight > ActiveChain().Height() + int(MIN_BLOCKS_TO_KEEP)};",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 63,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nIf you happen to retouch, `ActiveHeight()`.",
      "created_at": "2023-06-21T19:04:50Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237494340",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237494340"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3931,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237511461",
      "pull_request_review_id": 1491402431,
      "id": 1237511461,
      "node_id": "PRRC_kwDOABII585Jwu0l",
      "diff_hunk": "@@ -3978,9 +3980,16 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n         return AbortNode(state, std::string(\"System error: \") + e.what());\n     }\n \n-    FlushStateToDisk(state, FlushStateMode::NONE);\n+    // TODO: FlushStateToDisk() handles flushing of both block and chainstate\n+    // data, so we should move this to ChainstateManager so that we can be more\n+    // intelligent about how we flush.\n+    // For now, since FlushStateMode::NONE is used, all that can happen is that\n+    // the block files may be pruned, so we can just call this on one\n+    // chainstate (particularly if we haven't implemented pruning with\n+    // background validation yet).\n+    ActiveChainstate().FlushStateToDisk(state, FlushStateMode::NONE);\n \n-    CheckBlockIndex();\n+    ActiveChainstate().CheckBlockIndex();",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 108,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/943bd665e2523e5cd483aa2a77a511b967dee509\r\n\r\nProbably no need to use `ActiveChainstate()` for these (vs. `this->`) given the TODO above, but seems fine.",
      "created_at": "2023-06-21T19:07:24Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237511461",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237511461"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3992,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237552792",
      "pull_request_review_id": 1491402431,
      "id": 1237552792,
      "node_id": "PRRC_kwDOABII585Jw46Y",
      "diff_hunk": "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "path": "src/validation.cpp",
      "position": 388,
      "original_position": 179,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Note: it seems like we can default to the active chainstate here because the underlying notification that this sends (`KernelNotifications::headerTip()`) isn't really particular to any chainstate.",
      "created_at": "2023-06-21T19:15:33Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237552792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4637,
      "original_line": 4637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237579876",
      "pull_request_review_id": 1491402431,
      "id": 1237579876,
      "node_id": "PRRC_kwDOABII585Jw_hk",
      "diff_hunk": "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "in_reply_to_id": 1230085759,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nIf you retouch, I think you can simply say `bool is_bg_chainstate = this != &ActiveChainstate();`",
      "created_at": "2023-06-21T19:24:39Z",
      "updated_at": "2023-06-21T19:53:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237579876",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237579876"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3412,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237583806",
      "pull_request_review_id": 1491402431,
      "id": 1237583806,
      "node_id": "PRRC_kwDOABII585JxAe-",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            const CBlockIndex* snapshot_entry = m_chainman.GetSnapshotBaseBlock();\n+            assert(snapshot_entry != nullptr);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nIf you retrouch, I think you could remove this line and just do `... snapshot_entry = Assert(m_chainman.GetSnapshotBaseBlock());`\r\n\r\nAlso could move the `snapshot_entry` initialization out of the loop if this gets slow for some reason.",
      "created_at": "2023-06-21T19:26:53Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237583806",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237583806"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3422,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237586189",
      "pull_request_review_id": 1491402431,
      "id": 1237586189,
      "node_id": "PRRC_kwDOABII585JxBEN",
      "diff_hunk": "@@ -1047,6 +1047,12 @@ class ChainstateManager\n     //!          that a background validation chainstate is also in use.\n     bool IsSnapshotActive() const;\n \n+    //! @returns true if the chainstate is the background chainstate\n+    bool IsBackgroundChainstate(const Chainstate *chainstate) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return chainstate == m_ibd_chainstate.get();\n+    }",
      "path": "src/validation.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/55e27ee995944d188d7453c6e78a6538f6739d64\r\n\r\nMaybe not necessary in lieu of `this != &ActiveChainstate()`? Not hurting anything though.",
      "created_at": "2023-06-21T19:29:03Z",
      "updated_at": "2023-06-21T19:53:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237586189",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237586189"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1054,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237593280",
      "pull_request_review_id": 1491402431,
      "id": 1237593280,
      "node_id": "PRRC_kwDOABII585JxCzA",
      "diff_hunk": "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated\n+     * based on an assumeutxo snapshot.\n+     *\n+     * When an assumeutxo snapshot is loaded, the ASSUMED_VALID flag is added to\n+     * unvalidated blocks below the snapshot height. Then, as the background\n+     * validation progresses, and these blocks are validated, the ASSUMED_VALID\n+     * flags are removed. See `doc/design/assumeutxo.md` for details.\n+     *\n+     * This flag is only used to implement checks in CheckBlockIndex() and\n+     * should not be used elsewhere.",
      "path": "src/chain.h",
      "position": 32,
      "original_position": 32,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "2d20f75b0bad0b680cd45fc057c54704ac2a9d66",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "https://github.com/bitcoin/bitcoin/pull/27746/commits/2d20f75b0bad0b680cd45fc057c54704ac2a9d66\r\n\r\nNot entirely true since we have a small usage (by way of `IsAssumedValid()`) in LoadBlockIndex().\r\n\r\nEdit: oops nevermind, not as of the fixup commit: https://github.com/bitcoin/bitcoin/pull/27746/commits/78fcc8fbdc510c03dd021e6c34a10e6b35fc2c83",
      "created_at": "2023-06-21T19:34:59Z",
      "updated_at": "2023-06-21T19:53:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237593280",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1237593280"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 148,
      "original_line": 148,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238721079",
      "pull_request_review_id": 1485181856,
      "id": 1238721079,
      "node_id": "PRRC_kwDOABII585J1WI3",
      "diff_hunk": "@@ -126,6 +126,19 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo\n+    // data has been written. Block data is written to block files in download\n+    // order, but is written to undo files in validation order, which is\n+    // usually in order by height. To avoid wasting disk space, undo files will\n+    // be will trimmed whenever the corresponding block file is finalized and",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 9,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3fe223c36f9320f89af0eb31dabf55609bf2a0c7",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: `be will` => `be`",
      "created_at": "2023-06-22T15:46:26Z",
      "updated_at": "2023-06-22T22:01:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1238721079",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1238721079"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239034939",
      "pull_request_review_id": 1485181856,
      "id": 1239034939,
      "node_id": "PRRC_kwDOABII585J2iw7",
      "diff_hunk": "@@ -77,6 +77,13 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n+    // Grab block 1 from disk; we'll add it back to the background chain later.",
      "path": "src/test/validation_chainstate_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think \"back\" isn't technically correct here, it wasn't in there before",
      "created_at": "2023-06-22T21:11:17Z",
      "updated_at": "2023-06-22T22:01:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239034939",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239034939"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 80,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239044564",
      "pull_request_review_id": 1485181856,
      "id": 1239044564,
      "node_id": "PRRC_kwDOABII585J2lHU",
      "diff_hunk": "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,",
      "path": "src/validation.h",
      "position": null,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`chainman`",
      "created_at": "2023-06-22T21:24:13Z",
      "updated_at": "2023-06-22T22:01:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239044564",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239044564"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 349,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239045554",
      "pull_request_review_id": 1485181856,
      "id": 1239045554,
      "node_id": "PRRC_kwDOABII585J2lWy",
      "diff_hunk": "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.",
      "path": "src/validation.h",
      "position": null,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "chainman is missing from the list of params",
      "created_at": "2023-06-22T21:25:37Z",
      "updated_at": "2023-06-22T22:01:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1239045554",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239045554"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 357,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243705025",
      "pull_request_review_id": 1500819150,
      "id": 1243705025,
      "node_id": "PRRC_kwDOABII585KIW7B",
      "diff_hunk": "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "path": "src/node/chainstate.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "96cd3b06357c08a894d43e45acc456e4f0350e09",
      "in_reply_to_id": 1237406346,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It doesn't seem necessary to me, because the block arrival information is something that seems unrelated to setting up a chainstate (and I don't see why it would need to be reset in the event of a chainstate activation).\r\n\r\nI think if we need to reset the counters it would be for tests, which is the only place outside of `init.cpp` where we use this...  I thought I addressed adding `ResetBlockSequenceCounters()` where it was necessary, but I should look at that again to see if I missed a case.",
      "created_at": "2023-06-27T13:06:52Z",
      "updated_at": "2023-06-27T13:06:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243705025",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243705025"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 224,
      "original_line": 224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243732248",
      "pull_request_review_id": 1500862619,
      "id": 1243732248,
      "node_id": "PRRC_kwDOABII585KIdkY",
      "diff_hunk": "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "in_reply_to_id": 1230085759,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good idea -- and it looks like my code here is wrong anyway, because if we're a disabled background chainstate, then we'll be adding blocks to setBlockIndexCandidates as long as they have more work than the tip!",
      "created_at": "2023-06-27T13:22:12Z",
      "updated_at": "2023-06-27T13:22:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243732248",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243732248"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3412,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243773140",
      "pull_request_review_id": 1500920535,
      "id": 1243773140,
      "node_id": "PRRC_kwDOABII585KInjU",
      "diff_hunk": "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "path": "src/validation.cpp",
      "position": 388,
      "original_position": 179,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237552792,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah my thought was that this notification wasn't something that made sense for the background chain -- the existing UI notifications for should be oblivious to background validation (and if we want to change that then we likely need new functionality/a new interface for whatever notifications we want to set up).",
      "created_at": "2023-06-27T13:46:08Z",
      "updated_at": "2023-06-27T13:46:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243773140",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1243773140"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4637,
      "original_line": 4637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244021660",
      "pull_request_review_id": 1501387488,
      "id": 1244021660,
      "node_id": "PRRC_kwDOABII585KJkOc",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237491817,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed, done.",
      "created_at": "2023-06-27T16:21:08Z",
      "updated_at": "2023-06-27T16:21:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244021660",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244021660"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3925,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244022042",
      "pull_request_review_id": 1501388043,
      "id": 1244022042,
      "node_id": "PRRC_kwDOABII585KJkUa",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveChain().Tip() ? pindex->nChainWork >= ActiveChain().Tip()->nChainWork : true);\n     // Blocks that are too out-of-order needlessly limit the effectiveness of\n     // pruning, because pruning will not delete block files that contain any\n     // blocks which are too close in height to the tip.  Apply this test\n     // regardless of whether pruning is enabled; it should generally be safe to\n     // not process unrequested blocks.\n-    bool fTooFarAhead{pindex->nHeight > m_chain.Height() + int(MIN_BLOCKS_TO_KEEP)};\n+    bool fTooFarAhead{pindex->nHeight > ActiveChain().Height() + int(MIN_BLOCKS_TO_KEEP)};",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 63,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237494340,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2023-06-27T16:21:28Z",
      "updated_at": "2023-06-27T16:21:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244022042",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244022042"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3931,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244023980",
      "pull_request_review_id": 1501390684,
      "id": 1244023980,
      "node_id": "PRRC_kwDOABII585KJkys",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            const CBlockIndex* snapshot_entry = m_chainman.GetSnapshotBaseBlock();\n+            assert(snapshot_entry != nullptr);",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 15,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1237583806,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done (combined with taking @ryanofsky's approach for caching this value).",
      "created_at": "2023-06-27T16:23:01Z",
      "updated_at": "2023-06-27T16:23:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244023980",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244023980"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3422,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244024243",
      "pull_request_review_id": 1501391048,
      "id": 1244024243,
      "node_id": "PRRC_kwDOABII585KJk2z",
      "diff_hunk": "@@ -1047,6 +1047,12 @@ class ChainstateManager\n     //!          that a background validation chainstate is also in use.\n     bool IsSnapshotActive() const;\n \n+    //! @returns true if the chainstate is the background chainstate\n+    bool IsBackgroundChainstate(const Chainstate *chainstate) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return chainstate == m_ibd_chainstate.get();\n+    }",
      "path": "src/validation.h",
      "position": null,
      "original_position": 8,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1237586189,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed, gone now.",
      "created_at": "2023-06-27T16:23:13Z",
      "updated_at": "2023-06-27T16:23:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244024243",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244024243"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1054,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025126",
      "pull_request_review_id": 1501392246,
      "id": 1244025126,
      "node_id": "PRRC_kwDOABII585KJlEm",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 3,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1233368008,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Can you explain a bit more what you have in mind for rewriting this function?  Not sure I follow but happy to try to make this more readable/less error-prone.",
      "created_at": "2023-06-27T16:23:55Z",
      "updated_at": "2023-06-27T16:23:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025126",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025126"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025319",
      "pull_request_review_id": 1501392459,
      "id": 1244025319,
      "node_id": "PRRC_kwDOABII585KJlHn",
      "diff_hunk": "@@ -126,6 +126,19 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+\n+    // Track the height of the highest block in m_last_blockfile whose undo\n+    // data has been written. Block data is written to block files in download\n+    // order, but is written to undo files in validation order, which is\n+    // usually in order by height. To avoid wasting disk space, undo files will\n+    // be will trimmed whenever the corresponding block file is finalized and",
      "path": "src/node/blockstorage.h",
      "position": null,
      "original_position": 9,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3fe223c36f9320f89af0eb31dabf55609bf2a0c7",
      "in_reply_to_id": 1238721079,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed, thanks.",
      "created_at": "2023-06-27T16:24:02Z",
      "updated_at": "2023-06-27T16:24:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244025319",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244025319"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244026109",
      "pull_request_review_id": 1501393654,
      "id": 1244026109,
      "node_id": "PRRC_kwDOABII585KJlT9",
      "diff_hunk": "@@ -77,6 +77,13 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n+    // Grab block 1 from disk; we'll add it back to the background chain later.",
      "path": "src/test/validation_chainstate_tests.cpp",
      "position": null,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1239034939,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Fixed.",
      "created_at": "2023-06-27T16:24:41Z",
      "updated_at": "2023-06-27T16:24:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244026109",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244026109"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 80,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244027946",
      "pull_request_review_id": 1501396073,
      "id": 1244027946,
      "node_id": "PRRC_kwDOABII585KJlwq",
      "diff_hunk": "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,\n+    BlockValidationState& state,\n+    CBlockIndex** ppindex,\n+    bool min_pow_checked) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+ * Sufficiently validate a block for disk storage (and store on disk).\n+ *\n+ * @param[in]   pblock          The block we want to process.",
      "path": "src/validation.h",
      "position": null,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": 1239045554,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No longer relevant now that AcceptBlock is staying in CSM.",
      "created_at": "2023-06-27T16:26:00Z",
      "updated_at": "2023-06-27T16:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244027946",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244027946"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 357,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244028312",
      "pull_request_review_id": 1501396527,
      "id": 1244028312,
      "node_id": "PRRC_kwDOABII585KJl2Y",
      "diff_hunk": "@@ -337,9 +337,46 @@ class CScriptCheck\n /** Context-independent validity checks */\n bool CheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n \n+/**\n+ * If a block header hasn't already been seen, call CheckBlockHeader on it, ensure\n+ * that it doesn't descend from an invalid block, and then add it to m_block_index.\n+ * Caller must set min_pow_checked=true in order to add a new header to the\n+ * block index (permanent memory storage), indicating that the header is\n+ * known to be part of a sufficiently high-work chain (anti-dos check).\n+ */\n+bool AcceptBlockHeader(\n+    const CBlockHeader& block,\n+    ChainstateManager& chaiman,",
      "path": "src/validation.h",
      "position": null,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3110dbcee2965dad7cbf46923126599d691b3c7a",
      "in_reply_to_id": 1239044564,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "No longer relevant now that AcceptBlock/AcceptBlockHeader are staying in CSM.",
      "created_at": "2023-06-27T16:26:18Z",
      "updated_at": "2023-06-27T16:26:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244028312",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244028312"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 349,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244328552",
      "pull_request_review_id": 1501811866,
      "id": 1244328552,
      "node_id": "PRRC_kwDOABII585KKvJo",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 3,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1233368008,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This is what I had in mind: https://github.com/fjahr/bitcoin/commit/e26c89251b9fc2ae24c2c7ff90b8fd5490335ee5",
      "created_at": "2023-06-27T20:42:59Z",
      "updated_at": "2023-06-27T20:43:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1244328552",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1244328552"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246740699",
      "pull_request_review_id": 1505486978,
      "id": 1246740699,
      "node_id": "PRRC_kwDOABII585KT8Db",
      "diff_hunk": "@@ -981,6 +970,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 157,
      "original_position": 42,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nIt would be nice to have a documentation comment for this function saying what it is for, especially since it is only called in a test. If the counter values are basically arbitrary and only used for ordering, I'm not sure why if they actually ever need to be reset, or if that's just a nice thing to do?",
      "created_at": "2023-06-29T14:56:55Z",
      "updated_at": "2023-07-03T21:51:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246740699",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246740699"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 969,
      "original_line": 969,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246753697",
      "pull_request_review_id": 1505486978,
      "id": 1246753697,
      "node_id": "PRRC_kwDOABII585KT_Oh",
      "diff_hunk": "@@ -4367,10 +4367,9 @@ bool Chainstate::NeedsRedownload() const\n     return false;\n }\n \n-void Chainstate::UnloadBlockIndex()\n+void Chainstate::ClearBlockIndexCandidates()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;",
      "path": "src/validation.cpp",
      "position": 229,
      "original_position": 41,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nIIUC removing this line is not a change in behavior because the `nBlockSequenceId` variable was never used again after the `UnloadBlockIndex` call, outside of tests. Now there is new `ResetBlockSequenceCounters` function that tests can use to reset it separately. EDIT: Another review comment https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1243705025 also seems to say resetting nBlockSequenceId is unnecessary outside of tests\r\n\r\nIt might be good to say explicitly in commit message that this commit is supposed to be a refactoring which does not change behavior.",
      "created_at": "2023-06-29T15:06:21Z",
      "updated_at": "2023-07-03T21:51:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246753697",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246753697"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4385,
      "original_line": 4385,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246815739",
      "pull_request_review_id": 1505486978,
      "id": 1246815739,
      "node_id": "PRRC_kwDOABII585KUOX7",
      "diff_hunk": "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating",
      "path": "src/test/util/chainstate.h",
      "position": 13,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e8168cd56c490609f59e1dc89add58b1be18b516",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"test: Clear block index flags when testing snapshots\" (e8168cd56c490609f59e1dc89add58b1be18b516)\r\n\r\nThis seems like a good change that makes test setup more realistic, but the could the commit message be updated to say what is motivating this change? Is it just for realism, or will a future change, or a certain kind of test depend on it?",
      "created_at": "2023-06-29T15:40:53Z",
      "updated_at": "2023-07-03T21:51:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246815739",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246815739"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 88,
      "original_line": 88,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246822305",
      "pull_request_review_id": 1505486978,
      "id": 1246822305,
      "node_id": "PRRC_kwDOABII585KUP-h",
      "diff_hunk": "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating\n+            // never-having-downloaded them in the first place.\n+            // TODO: perhaps we could improve this by using pruning to delete\n+            // these blocks instead\n+            CBlockIndex *pindex = orig_tip;\n+            while (pindex && pindex != chain.m_chain.Tip()) {\n+                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n+                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n+                pindex->nStatus |= BLOCK_ASSUMED_VALID;",
      "path": "src/test/util/chainstate.h",
      "position": 25,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e8168cd56c490609f59e1dc89add58b1be18b516",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"test: Clear block index flags when testing snapshots\" (e8168cd56c490609f59e1dc89add58b1be18b516)\r\n\r\nAdding `BLOCK_ASSUMED_VALID` here seems surprising since I would expect `ActivateSnapshot` below to be setting `BLOCK_ASSUMED_VALID`, and comment above doesn't mention this flag. I think it would be good to drop this line or add a comment explaining why it is necessary.",
      "created_at": "2023-06-29T15:46:07Z",
      "updated_at": "2023-07-03T21:51:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246822305",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246822305"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 100,
      "original_line": 100,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246833752",
      "pull_request_review_id": 1505486978,
      "id": 1246833752,
      "node_id": "PRRC_kwDOABII585KUSxY",
      "diff_hunk": "@@ -431,9 +431,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\n \n     auto reload_all_block_indexes = [&]() {\n+        WITH_LOCK(::cs_main, return chainman.ResetBlockSequenceCounters());",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 114,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (0dbc5805ca4371b7621bee0b7a553dac1a481614)\r\n\r\nThe test seems to pass without this line, at least in this commit.\r\n\r\nIf this is needed for a future change, would be good to say that in commit message. Or if this is just done for completeness would be good to say that in a code comment.",
      "created_at": "2023-06-29T15:54:07Z",
      "updated_at": "2023-07-03T21:51:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246833752",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246833752"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 437,
      "original_line": 437,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246842096",
      "pull_request_review_id": 1505486978,
      "id": 1246842096,
      "node_id": "PRRC_kwDOABII585KUUzw",
      "diff_hunk": "@@ -3439,8 +3439,10 @@ void Chainstate::ReceivedBlockTransactions(const CBlock& block, CBlockIndex* pin\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n             pindex->nChainTx = (pindex->pprev ? pindex->pprev->nChainTx : 0) + pindex->nTx;\n-            pindex->nSequenceId = m_chainman.nBlockSequenceId++;\n-            TryAddBlockIndexCandidate(pindex);\n+            pindex->nSequenceId = nBlockSequenceId++;\n+            for (Chainstate *c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 106,
      "original_position": 25,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNotes: It seems logical to call `GetAll` here for all chainstates and let the `TryAddBlockIndexCandidate` and `FindMostWorkChain` functions figure out how to use the block and which chain to attach it to.\r\n\r\nThere is a change in behavior here if there are multiple chainstates, because previously this would only add blocks to `setBlockIndexCandidates` for the active chain, and now it will add all blocks with enough work to `setBlockIndexCandidates` for active and background chains.\r\n\r\nI think this means it will now add blocks above the snapshot height to the background chainstate, which [`ChainstateManager::LoadBlockIndex`](https://github.com/bitcoin/bitcoin/blob/600c595b8d2f4bf049b9182d4a0aa88e4b34458d/src/validation.cpp#L4421-L4446) was trying to avoid. This is inefficient, but not really a problem because [`Chainstate::FindMostWorkChain`](https://github.com/bitcoin/bitcoin/blob/600c595b8d2f4bf049b9182d4a0aa88e4b34458d/src/validation.cpp#L2880) will ignore and remove the blocks when it finds their ancestors have missing data. \r\n\r\nFollowup commit f18ab9ee7deb92c25bdc68a5c4bef973f5e995f0 \"Tighten requirements for adding elements to setBlockIndexCandidates\" will make this more efficient by not adding these blocks to `setBlockIndexCandidates`\r\n",
      "created_at": "2023-06-29T16:00:03Z",
      "updated_at": "2023-07-03T21:53:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246842096",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246842096"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3478,
      "original_line": 3478,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246844224",
      "pull_request_review_id": 1505486978,
      "id": 1246844224,
      "node_id": "PRRC_kwDOABII585KUVVA",
      "diff_hunk": "@@ -3910,8 +3912,8 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     CBlockIndex *pindexDummy = nullptr;\n     CBlockIndex *&pindex = ppindex ? *ppindex : pindexDummy;\n \n-    bool accepted_header{m_chainman.AcceptBlockHeader(block, state, &pindex, min_pow_checked)};\n-    CheckBlockIndex();\n+    bool accepted_header{AcceptBlockHeader(block, state, &pindex, min_pow_checked)};\n+    ActiveChainstate().CheckBlockIndex();",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 47,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNote: This change to the `CheckBlockIndex()` call is temporary and will revert back in later commit fb9c405506d6cfb6896e21b79789d7b6e638f6f2 \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" when it becomes a `ChainstateManager` method.\r\n\r\nThere is not a change in behavior here in this commit, because in both places where\r\n`Chainstate::AcceptBlock` was called previously (in `ProcessNewBlock` and `LoadExternalBlockFile`), it was only called on the active chainstate.",
      "created_at": "2023-06-29T16:02:03Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246844224",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246844224"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3916,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246868905",
      "pull_request_review_id": 1505486978,
      "id": 1246868905,
      "node_id": "PRRC_kwDOABII585KUbWp",
      "diff_hunk": "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "path": "src/validation.cpp",
      "position": 182,
      "original_position": 89,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nDo you think it would be good if the `IsInitialBlockDownload` method were moved to `ChainstateManager`. Is there any place it should be actually called on the background chainstate rather than the active chainstate? Could add a TODO comment if IsInitialBlockDownload method should move like other methods are moving.",
      "created_at": "2023-06-29T16:25:50Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246868905"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4003,
      "original_line": 4003,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246903052",
      "pull_request_review_id": 1505486978,
      "id": 1246903052,
      "node_id": "PRRC_kwDOABII585KUjsM",
      "diff_hunk": "@@ -4417,62 +4417,14 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (ShutdownRequested()) return false;\n-            if (pindex->IsAssumedValid() ||\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 29,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "c2bc5cfd9977838af334844675d77090fe9c3c74",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (c2bc5cfd9977838af334844675d77090fe9c3c74)\r\n\r\nCan add a comment here explaining the logic? I guess the `pindex == GetSnapshotBaseBlock()` case needs to be a special case because the snapshot block may not have transactions?\r\n\r\nMaybe also would be more efficient to call `ActiveSnapshotBase` instead of `GetSnapshotBaseBlock` here. I think I would move the commit introducing the `ActiveSnapshotBase` method earlier, so it's also not necessary to replace `GetSnapshotBaseBlock` with `ActiveSnapshotBase` in later commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (ddb77d838c4cd7a4776c5ec70d96331fc8137900)\r\n",
      "created_at": "2023-06-29T16:57:26Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246903052",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1246903052"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4450,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1248935619",
      "pull_request_review_id": 1508881991,
      "id": 1248935619,
      "node_id": "PRRC_kwDOABII585KcT7D",
      "diff_hunk": "@@ -3409,7 +3409,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 3,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "55e27ee995944d188d7453c6e78a6538f6739d64",
      "in_reply_to_id": 1233368008,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks!  I've incorporated that here.",
      "created_at": "2023-07-01T19:21:39Z",
      "updated_at": "2023-07-01T19:21:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1248935619",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1248935619"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3419,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251222347",
      "pull_request_review_id": 1511690655,
      "id": 1251222347,
      "node_id": "PRRC_kwDOABII585KlCNL",
      "diff_hunk": "@@ -459,15 +460,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n-            BOOST_CHECK(!index->IsAssumedValid());\n+            BOOST_CHECK(index->IsAssumedValid());\n         }",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 153,
      "original_position": 33,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776",
      "in_reply_to_id": null,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776\r\n\r\nNit: feel like it may have been okay to leave in the previous assertion too (although this is sorted of indirectly tested by the `expected_assumed_valid` comparison). No need to change.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex a936a96577..f0ed54a521 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -464,6 +464,8 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         if (i == last_assumed_valid_idx - 1) {\r\n             assumed_base = index;\r\n             BOOST_CHECK(index->IsAssumedValid());\r\n+        } else if (i == last_assumed_valid_idx) {\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n     }\r\n```",
      "created_at": "2023-07-03T19:33:59Z",
      "updated_at": "2023-07-03T20:34:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251222347",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251222347"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 476,
      "original_line": 476,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271660",
      "pull_request_review_id": 1511762976,
      "id": 1251271660,
      "node_id": "PRRC_kwDOABII585KlOPs",
      "diff_hunk": "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 28,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Now `ChainstateManager` has `ActiveSnapshotBase()` and `GetSnapshotBaseBlock()` which, as far as I understand it, do the same thing except for the caching.\r\nWould it have been possible to add the caching to the existing `GetSnapshotBaseBlock()` instead?",
      "created_at": "2023-07-03T20:47:02Z",
      "updated_at": "2023-07-03T21:23:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271660",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271660"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1074,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271941",
      "pull_request_review_id": 1505486978,
      "id": 1251271941,
      "node_id": "PRRC_kwDOABII585KlOUF",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": 149,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nIt seems like `fHasMoreOrSameWork` will always be false for blocks that were downloaded to be added to the background chain, because they will have less work than the active snapshot chain.\r\n\r\nIs that intentional? It would helpful to have a comment here either that either explains why this ok, or adds a TODO indicating that there will be some change later.\r\n\r\nI do understand there is not a change in behavior here in this commit because in both places where\r\n`Chainstate::AcceptBlock` was called previously (in `ProcessNewBlock` and `LoadExternalBlockFile`), it was only called on the active chainstate, so it is still only looking at the active chainstate now.",
      "created_at": "2023-07-03T20:47:30Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251271941",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251271941"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3961,
      "original_line": 3961,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251282221",
      "pull_request_review_id": 1505486978,
      "id": 1251282221,
      "node_id": "PRRC_kwDOABII585KlQ0t",
      "diff_hunk": "@@ -4495,26 +4504,24 @@ bool Chainstate::LoadGenesisBlock()\n             return error(\"%s: writing genesis block to disk failed\", __func__);\n         }\n         CBlockIndex* pindex = m_blockman.AddToBlockIndex(block, m_chainman.m_best_header);\n-        ReceivedBlockTransactions(block, pindex, blockPos);\n+        m_chainman.ReceivedBlockTransactions(block, pindex, blockPos);\n     } catch (const std::runtime_error& e) {\n         return error(\"%s: failed to write genesis block: %s\", __func__, e.what());\n     }\n \n     return true;\n }\n \n-void Chainstate::LoadExternalBlockFile(\n+void ChainstateManager::LoadExternalBlockFile(\n     FILE* fileIn,\n     FlatFilePos* dbp,\n     std::multimap<uint256, FlatFilePos>* blocks_with_unknown_parent)\n {\n-    AssertLockNotHeld(m_chainstate_mutex);",
      "path": "src/validation.cpp",
      "position": 328,
      "original_position": 140,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nNote: It seems fine to drop this assert, because the only code that is using this mutex is the `ActivateBestChain` function called below, and `ActivateBestChain` already has this same assert at the top of the function.",
      "created_at": "2023-07-03T21:08:52Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251282221",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251282221"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4517,
      "original_line": 4517,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251283534",
      "pull_request_review_id": 1505486978,
      "id": 1251283534,
      "node_id": "PRRC_kwDOABII585KlRJO",
      "diff_hunk": "@@ -4600,7 +4607,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {\n+                        if (!c->ActivateBestChain(state, nullptr)) {",
      "path": "src/validation.cpp",
      "position": 357,
      "original_position": 158,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nI think it would be a little clearer to move the `BlockValidationState state;` variable declaration down into the `for` loop so it is obvious the variable is ignored and not used to share state between `ActivateBestChain` calls",
      "created_at": "2023-07-03T21:11:47Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251283534",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251283534"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4605,
      "original_line": 4605,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251289117",
      "pull_request_review_id": 1505486978,
      "id": 1251289117,
      "node_id": "PRRC_kwDOABII585KlSgd",
      "diff_hunk": "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 355,
      "original_position": 206,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212186629,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896) in `LoadExternalBlockFile`:\r\n\r\nIt seems inconsistent to call `ActivateBestChain` on _all_ chainstates here for the genesis block, but only call `ActivateBestChain` on the _active_ chainstate a few lines below (line 4631).\r\n\r\nI think I can understand the reasons from the discussion above (\"we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate\") and from pruning context below. But in both cases I think the code would be clearer if there were explicit comments saying why `ActiveChainstate()` is used and why `GetAll()` is used in each place.\r\n\r\n",
      "created_at": "2023-07-03T21:23:35Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251289117",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251289117"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4603,
      "original_line": 4603,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251292140",
      "pull_request_review_id": 1505486978,
      "id": 1251292140,
      "node_id": "PRRC_kwDOABII585KlTPs",
      "diff_hunk": "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "path": "src/validation.cpp",
      "position": 388,
      "original_position": 179,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237552792,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (034f920d1755cff752d46b089ad37bdd703bf896)\r\n\r\nIt seems like `NotifyHeaderTip` is a \"block-storage-related\" function just like other functions that are moving from `Chainstate` to `ChainstateManager` so it would be cleaner if  `NotifyHeaderTip` took a `ChainstateManager` argument instead of a `Chainstate` one, and if it called `ActiveChainstate()` internally so `NotifyHeaderTip` callers don't have to consider how the UI reflects background validation.\r\n",
      "created_at": "2023-07-03T21:30:58Z",
      "updated_at": "2023-07-03T21:52:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1251292140",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1251292140"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4637,
      "original_line": 4637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252074194",
      "pull_request_review_id": 1512960883,
      "id": 1252074194,
      "node_id": "PRRC_kwDOABII585KoSLS",
      "diff_hunk": "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "path": "src/node/blockstorage.cpp",
      "position": 30,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "in_reply_to_id": null,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I must either be missing something about this line or it might be unnecessary. If I understand correctly this is updating `m_undo_height_in_last_blockfile` when the next block is connected after the flush happened. However, why not update it right away when the flush happens? I tried that by removing this line it seems like all tests are still passing without it.",
      "created_at": "2023-07-04T14:05:35Z",
      "updated_at": "2023-07-04T16:19:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252074194",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252074194"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 753,
      "original_line": 753,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252331248",
      "pull_request_review_id": 1513367979,
      "id": 1252331248,
      "node_id": "PRRC_kwDOABII585KpQ7w",
      "diff_hunk": "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "path": "src/node/blockstorage.cpp",
      "position": 30,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "in_reply_to_id": 1252074194,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I must either be missing something about this line or it might be unnecessary. If I understand correctly this is updating `m_undo_height_in_last_blockfile` when the next block is connected after the flush happened. However, why not update it right away when the flush happens? I tried that by removing this line it seems like all tests are still passing without it.\r\n\r\nIt's not surprising that there's no test coverage for this. But to explain: the goal of the code is to flush the undo file when the height of the highest block in the undo file equals the height of the highest block in the corresponding block file. There are two cases where this can happen. The first case is on line 633 above, where the undo file and block file are flushed together because the undo data is not far behind the block data. The second case is on line 737 above when undo data is delayed and undo file gets flushed after the block file. The `m_undo_height_in_last_blockfile` needs to be set here so the `m_blockfile_info[nFile].nHeightLast == m_undo_height_in_last_blockfile` check in the first case line 633 can work.",
      "created_at": "2023-07-04T20:17:00Z",
      "updated_at": "2023-07-04T20:17:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1252331248",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1252331248"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 753,
      "original_line": 753,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254538118",
      "pull_request_review_id": 1516705680,
      "id": 1254538118,
      "node_id": "PRRC_kwDOABII585KxruG",
      "diff_hunk": "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 28,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "in_reply_to_id": 1251271660,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "@mzumsande Yep, I don't see any reason that couldn't be done.",
      "created_at": "2023-07-06T14:37:47Z",
      "updated_at": "2023-07-06T14:37:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1254538118",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1254538118"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1074,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177843",
      "pull_request_review_id": 1531050604,
      "id": 1264177843,
      "node_id": "PRRC_kwDOABII585LWdKz",
      "diff_hunk": "@@ -459,15 +460,16 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n-            BOOST_CHECK(!index->IsAssumedValid());\n+            BOOST_CHECK(index->IsAssumedValid());\n         }",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 153,
      "original_position": 33,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "4a9f0dae7ff64ba2c2f1eb1b44d0ca563726b776",
      "in_reply_to_id": 1251222347,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2023-07-14T21:09:31Z",
      "updated_at": "2023-07-14T21:09:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177843",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 476,
      "original_line": 476,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177911",
      "pull_request_review_id": 1531050704,
      "id": 1264177911,
      "node_id": "PRRC_kwDOABII585LWdL3",
      "diff_hunk": "@@ -1055,6 +1065,11 @@ class ChainstateManager\n         return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;\n     }\n \n+    const CBlockIndex* ActiveSnapshotBase() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": null,
      "original_position": 28,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "03dfe04075668aa3b99a5d6d68adfcecffca0593",
      "in_reply_to_id": 1251271660,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done, thanks!",
      "created_at": "2023-07-14T21:09:39Z",
      "updated_at": "2023-07-14T21:09:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264177911",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264177911"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1074,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178108",
      "pull_request_review_id": 1531050946,
      "id": 1264178108,
      "node_id": "PRRC_kwDOABII585LWdO8",
      "diff_hunk": "@@ -981,6 +970,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "path": "src/validation.h",
      "position": 157,
      "original_position": 42,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": 1246740699,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think it's just a nice thing to do to ensure that all state is reset when the block index is cleared out and re-initialized; it might be surprising if state were leftover?  But I agree that it doesn't seem strictly necessary.  Added a comment to clarify.",
      "created_at": "2023-07-14T21:09:59Z",
      "updated_at": "2023-07-14T21:09:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178108",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 969,
      "original_line": 969,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178256",
      "pull_request_review_id": 1531051166,
      "id": 1264178256,
      "node_id": "PRRC_kwDOABII585LWdRQ",
      "diff_hunk": "@@ -4367,10 +4367,9 @@ bool Chainstate::NeedsRedownload() const\n     return false;\n }\n \n-void Chainstate::UnloadBlockIndex()\n+void Chainstate::ClearBlockIndexCandidates()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;",
      "path": "src/validation.cpp",
      "position": 229,
      "original_position": 41,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": 1246753697,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Updated the commit message.",
      "created_at": "2023-07-14T21:10:16Z",
      "updated_at": "2023-07-14T21:10:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178256",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178256"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4385,
      "original_line": 4385,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178307",
      "pull_request_review_id": 1531051260,
      "id": 1264178307,
      "node_id": "PRRC_kwDOABII585LWdSD",
      "diff_hunk": "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating",
      "path": "src/test/util/chainstate.h",
      "position": 13,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e8168cd56c490609f59e1dc89add58b1be18b516",
      "in_reply_to_id": 1246815739,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I'd say mostly for realism.  My intuition for how this is designed is that if you don't reset the HAVE_DATA flags, then you'd immediately expect the background chain to process and validate all the blocks for which we HAVE_DATA and thus arrive at the original tip, as soon as you call ActivateBestChain().\r\n\r\nUpdated commit message.",
      "created_at": "2023-07-14T21:10:23Z",
      "updated_at": "2023-07-14T21:11:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264178307",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264178307"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 88,
      "original_line": 88,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179053",
      "pull_request_review_id": 1531052550,
      "id": 1264179053,
      "node_id": "PRRC_kwDOABII585LWddt",
      "diff_hunk": "@@ -83,6 +84,18 @@ CreateAndActivateUTXOSnapshot(\n             chain.setBlockIndexCandidates.insert(node.chainman->m_blockman.LookupBlockIndex(gen_hash));\n             chain.LoadChainTip();\n             node.chainman->MaybeRebalanceCaches();\n+\n+            // Reset the HAVE_DATA flags below the snapshot height, simulating\n+            // never-having-downloaded them in the first place.\n+            // TODO: perhaps we could improve this by using pruning to delete\n+            // these blocks instead\n+            CBlockIndex *pindex = orig_tip;\n+            while (pindex && pindex != chain.m_chain.Tip()) {\n+                pindex->nStatus &= ~BLOCK_HAVE_DATA;\n+                pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n+                pindex->nStatus |= BLOCK_ASSUMED_VALID;",
      "path": "src/test/util/chainstate.h",
      "position": 25,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "e8168cd56c490609f59e1dc89add58b1be18b516",
      "in_reply_to_id": 1246822305,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "We need this due to the CheckBlockIndex() invariant that you can't have a block index entry with nTx > 0 and without HAVE_DATA unless you've either pruned or used ASSUMED_VALID.  Added a comment to clarify.",
      "created_at": "2023-07-14T21:11:42Z",
      "updated_at": "2023-07-14T21:11:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179053",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 100,
      "original_line": 100,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179160",
      "pull_request_review_id": 1531052884,
      "id": 1264179160,
      "node_id": "PRRC_kwDOABII585LWdfY",
      "diff_hunk": "@@ -431,9 +431,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\n \n     auto reload_all_block_indexes = [&]() {\n+        WITH_LOCK(::cs_main, return chainman.ResetBlockSequenceCounters());",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 114,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0dbc5805ca4371b7621bee0b7a553dac1a481614",
      "in_reply_to_id": 1246833752,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Added a comment.",
      "created_at": "2023-07-14T21:11:54Z",
      "updated_at": "2023-07-14T21:11:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1264179160",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1264179160"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 437,
      "original_line": 437,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265452083",
      "pull_request_review_id": 1532940105,
      "id": 1265452083,
      "node_id": "PRRC_kwDOABII585LbUQz",
      "diff_hunk": "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "path": "src/validation.cpp",
      "position": 182,
      "original_position": 89,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": 1246868905,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I haven't done a careful review of all the places we use `IsInitialBlockDownload()` to confirm this, but my intuition would be that if we're using an assumeutxo snapshot, what we care about is whether our snapshot-based chainstate is caught up or not -- basically by definition, the background chainstate will always be \"in initial block download\" until it finishes and is no longer in use, so it wouldn't make sense to condition anything on whether it's behind or not.\r\n\r\nSo yeah I think moving this to ChainstateManager would probably make sense...",
      "created_at": "2023-07-17T14:27:40Z",
      "updated_at": "2023-07-17T14:27:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265452083",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265452083"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4003,
      "original_line": 4003,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265477633",
      "pull_request_review_id": 1532979663,
      "id": 1265477633,
      "node_id": "PRRC_kwDOABII585LbagB",
      "diff_hunk": "@@ -4417,62 +4417,14 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (ShutdownRequested()) return false;\n-            if (pindex->IsAssumedValid() ||\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 29,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "c2bc5cfd9977838af334844675d77090fe9c3c74",
      "in_reply_to_id": 1246903052,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "We may not have received the snapshot base block, and it's only when we call `ReceivedBlockTransactions` on a block that we set VALID_TRANSACTIONS on the block index entry.  So the snapshot base block may not otherwise be considered a block index candidate, but the snapshot base block could be the tip of the snapshot chain so we need to be able to call `TryAddBlockIndexCandidate()`.  \r\n\r\nI'll push an update that adds a comment explaining this.",
      "created_at": "2023-07-17T14:44:35Z",
      "updated_at": "2023-07-17T14:44:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265477633",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265477633"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4450,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265513530",
      "pull_request_review_id": 1533034955,
      "id": 1265513530,
      "node_id": "PRRC_kwDOABII585LbjQ6",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": 149,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": 1251271941,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The idea here is that this check is part of a heuristic that we use when we receive a block that was not requested.  For anti-DoS reasons, back in #5875 we introduced logic to generally not process unrequested blocks, but we left in an optimization that was intended to not throw away blocks that would immediately advance our tip, in case we had some peer (like Matt's old fast-relay-network, if I remember right) that was sending such blocks (see eg comment here https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-86743016).\r\n\r\nMy view is that we don't need to process unrequested blocks in general, and that if we do so it's just an optimization to make block relay at the tip work better.  We could probably add special-case logic to allow processing of unrequested blocks that we haven't yet validated that are ancestors of the ancestor block, but this doesn't strike me as something that is at all necessary (and perhaps not desirable?).",
      "created_at": "2023-07-17T15:08:06Z",
      "updated_at": "2023-07-17T15:08:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265513530",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265513530"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3961,
      "original_line": 3961,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265542867",
      "pull_request_review_id": 1533080104,
      "id": 1265542867,
      "node_id": "PRRC_kwDOABII585LbqbT",
      "diff_hunk": "@@ -734,8 +735,9 @@ bool BlockManager::WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValid\n         // the FindBlockPos function\n         if (_pos.nFile < m_last_blockfile && static_cast<uint32_t>(block.nHeight) == m_blockfile_info[_pos.nFile].nHeightLast) {\n             FlushUndoFile(_pos.nFile, true);\n+        } else if (_pos.nFile == m_last_blockfile && static_cast<uint32_t>(block.nHeight) > m_undo_height_in_last_blockfile) {",
      "path": "src/node/blockstorage.cpp",
      "position": 30,
      "original_position": 21,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "ad8b21dfe3176691211d7979c3b374447d3a561d",
      "in_reply_to_id": 1252074194,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "For context, the issue was originally reported in #17890 and was fixed in #17994.  It took me a while to understand exactly what this logic was for and how it worked, so a test to ensure we don't introduce a regression would be helpful!",
      "created_at": "2023-07-17T15:28:20Z",
      "updated_at": "2023-07-17T15:28:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265542867",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265542867"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 753,
      "original_line": 753,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265932265",
      "pull_request_review_id": 1533749512,
      "id": 1265932265,
      "node_id": "PRRC_kwDOABII585LdJfp",
      "diff_hunk": "@@ -3962,7 +3964,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+    if (!ActiveChainstate().IsInitialBlockDownload() && ActiveTip() == pindex->pprev)",
      "path": "src/validation.cpp",
      "position": 182,
      "original_position": 89,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": 1246868905,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1246868905\r\n\r\nThanks, it makes sense that the background chainstate only has one state because it is deleted as soon as it finishes syncing.\r\n\r\nWould be great if a followup PR moved `IsInitialBlockDownload` from `Chainstate` class to `ChainstateManager`  so the `IsInitialBlockDownload` implementation could refer directly to the active chainstate, and `IsInitialBlockDownload` callers wouldn't need to figure out which chainstate to call it on.",
      "created_at": "2023-07-17T21:41:36Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265932265",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265932265"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4003,
      "original_line": 4003,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265971359",
      "pull_request_review_id": 1533749512,
      "id": 1265971359,
      "node_id": "PRRC_kwDOABII585LdTCf",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": 149,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": 1251271941,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746/commits/c8f4a8702851c3097ebd038a814d974dce4dcc78#r1251271941\r\n\r\nThanks, that makes sense, and thanks for linking to #5875.\r\n\r\nTo make this less confusing, I think \"Try to process all requested blocks\" code comment above could be updated to mention the active chain and better match the code.\r\n\r\nWould suggest: \"// Check all requested blocks that we do not already have for validity and save them to disk. Skip processing of unrequested blocks as an anti-Dos measure, unless the blocks have more work than the active chain tip, and aren't too far ahead of it, so are likely to be attached soon.\"\r\n\r\n",
      "created_at": "2023-07-17T22:43:48Z",
      "updated_at": "2023-07-18T04:03:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265971359",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265971359"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3961,
      "original_line": 3961,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265976213",
      "pull_request_review_id": 1533749512,
      "id": 1265976213,
      "node_id": "PRRC_kwDOABII585LdUOV",
      "diff_hunk": "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "path": "src/validation.cpp",
      "position": 355,
      "original_position": 206,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "534b6f99a3779465678f39ed2704da6049c6469d",
      "in_reply_to_id": 1212186629,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-storage-related logic to ChainstateManager\" (c8f4a8702851c3097ebd038a814d974dce4dcc78)\r\n\r\n> It seems inconsistent to call `ActivateBestChain` on _all_ chainstates here for the genesis block, but only call `ActivateBestChain` on the _active_ chainstate a few lines below (line 4631).\r\n\r\nThis inconsistency is resolved now in commit \"Move block-storage-related logic to ChainstateManager\" (c8f4a8702851c3097ebd038a814d974dce4dcc78) by calling `ActivateBestChain` on all chains in both cases.\r\n\r\nSince the case below is a pruning case, and pruning already has problems when snapshot activated and a background chainstate is being loaded, skipping the `ActivateBestChain` for the background chainstate probably did not cause any issues. But if pruning is going to be supported in the future, probably better if the code starts off treating chainstates the same and doesn't have unexplained inconsistencies.",
      "created_at": "2023-07-17T22:52:31Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265976213",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265976213"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4603,
      "original_line": 4603,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265982685",
      "pull_request_review_id": 1533749512,
      "id": 1265982685,
      "node_id": "PRRC_kwDOABII585LdVzd",
      "diff_hunk": "@@ -4614,13 +4628,13 @@ void Chainstate::LoadExternalBlockFile(\n                     // called by concurrent network message processing. but, that is not\n                     // reliable for the purpose of pruning while importing.\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, pblock)) {\n+                    if (!ActiveChainstate().ActivateBestChain(state, pblock)) {\n                         LogPrint(BCLog::REINDEX, \"failed to activate chain (%s)\\n\", state.ToString());\n                         break;\n                     }\n                 }\n \n-                NotifyHeaderTip(*this);\n+                NotifyHeaderTip(ActiveChainstate());",
      "path": "src/validation.cpp",
      "position": 388,
      "original_position": 179,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237552792,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1638374417, https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237552792\r\n\r\n> I wasn't sure if that was something to do in this PR or a future one?\r\n\r\nI think it would be a good as a followup. Doing it wouldn't simplify this PR so it's probably good not to add it here.",
      "created_at": "2023-07-17T23:06:21Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1265982685",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1265982685"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4637,
      "original_line": 4637,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266007380",
      "pull_request_review_id": 1533749512,
      "id": 1266007380,
      "node_id": "PRRC_kwDOABII585Ldb1U",
      "diff_hunk": "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "path": "src/node/chainstate.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (471da5f6e74bac71aeffe2ebc5faff145a6cbcea)\r\n\r\nThe \"reload of the block index\" comment now seems out of date. And actually I don't see why this `ClearBlockIndexCandidates` call is necessary here. After the InitializeChainstate call above, the active chainstate should be newly created and `setBlockIndexCandidates` should already be empty. So I think it would be good to drop this `ClearBlockIndexCandidates` call, or add a new comment to explain what it's doing.",
      "created_at": "2023-07-17T23:36:08Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266007380",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266007380"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": 222,
      "original_start_line": 222,
      "start_side": "RIGHT",
      "line": 224,
      "original_line": 224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266117889",
      "pull_request_review_id": 1533749512,
      "id": 1266117889,
      "node_id": "PRRC_kwDOABII585Ld20B",
      "diff_hunk": "@@ -3978,9 +3980,16 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n         return AbortNode(state, std::string(\"System error: \") + e.what());\n     }\n \n-    FlushStateToDisk(state, FlushStateMode::NONE);\n+    // TODO: FlushStateToDisk() handles flushing of both block and chainstate\n+    // data, so we should move this to ChainstateManager so that we can be more\n+    // intelligent about how we flush.\n+    // For now, since FlushStateMode::NONE is used, all that can happen is that\n+    // the block files may be pruned, so we can just call this on one\n+    // chainstate (particularly if we haven't implemented pruning with\n+    // background validation yet).\n+    ActiveChainstate().FlushStateToDisk(state, FlushStateMode::NONE);\n \n-    CheckBlockIndex();\n+    ActiveChainstate().CheckBlockIndex();",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 108,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "943bd665e2523e5cd483aa2a77a511b967dee509",
      "in_reply_to_id": 1237511461,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1237511461\r\n \r\n> Probably no need to use `ActiveChainstate()` for these (vs. `this->`) given the TODO above, but seems fine.\r\n\r\nMarking resolved since later commit \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" (f921887c1afdcd333cf71ca25e5efbf4991f806e) drops this.\r\n",
      "created_at": "2023-07-18T02:34:54Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266117889",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266117889"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3992,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266147442",
      "pull_request_review_id": 1533749512,
      "id": 1266147442,
      "node_id": "PRRC_kwDOABII585Ld-By",
      "diff_hunk": "@@ -118,18 +121,18 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // once it is changed to support multiple chainstates.\n     {\n         LOCK(::cs_main);\n-        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        bool checked = CheckBlock(*pblockone, state, chainparams.GetConsensus());",
      "path": "src/test/validation_chainstate_tests.cpp",
      "position": 32,
      "original_position": 32,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nNote: test here is changed to add the real block 1, instead of a random block, so the block will not be ignored by the new `snapshot_base->GetAncestor(pindex->nHeight) == pindex` check in TryAddBlockIndexCandidate",
      "created_at": "2023-07-18T03:18:35Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266147442",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266147442"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 124,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266149966",
      "pull_request_review_id": 1533749512,
      "id": 1266149966,
      "node_id": "PRRC_kwDOABII585Ld-pO",
      "diff_hunk": "@@ -3419,9 +3419,24 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n {\n     AssertLockHeld(cs_main);\n-    // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n-    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+    // The block only is a candidate for the most-work-chain if it has more work than our current tip.\n+    if (m_chain.Tip() != nullptr && setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        return;\n+    }\n+\n+    bool is_active_chainstate = this == &m_chainman.ActiveChainstate();\n+    if (is_active_chainstate) {\n+        // The active chainstate should always add entries that have more\n+        // work than the tip.\n         setBlockIndexCandidates.insert(pindex);\n+    } else if (!m_disabled) {\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base (which can't be nullptr or else we'll\n+        // never make progress).\n+        const CBlockIndex* snapshot_base = Assert(m_chainman.GetSnapshotBaseBlock());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nIs this comment in the commit message still accurate?\r\n\r\n> Note that this introduces the new invariant that we can only have an assumeutxo\r\n> snapshot where the snapshotted blockhash is in our block index. As a followup,\r\n> unit tests that mock creating a snapshot ought to be updated to reflect this.\r\n\r\nThe only way I can see that it relates to code changes in this commit is the new Assert on this line, and it's confusing because I would have not have thought loading a snapshot with an unknown block hash worked before this code change, either. Also I'm not sure what unit tests \"ought to be updated\" means if tests are already updated this commit.\r\n\r\nI think it would be good to drop this comment, or add more specifics about what's actually changing here and what followup needs to be done later.\r\n\r\nEDIT: Rereading this, I guess the commit message is just referring to an internal change that affects unit tests, not a bigger change that affects what snapshots are able to be loaded. Maybe a a clearer commit message would be: \"After this change, `ActivateExistingSnapshot` needs to be passed a valid block hash to avoid assert errors when accepting new blocks.\" Maybe it would be good to add an assert to ActivateExistingSnapshot to catch potential problems with this earlier, too.",
      "created_at": "2023-07-18T03:24:55Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266149966",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266149966"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266153816",
      "pull_request_review_id": 1533749512,
      "id": 1266153816,
      "node_id": "PRRC_kwDOABII585Ld_lY",
      "diff_hunk": "@@ -49,6 +49,9 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     c1.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n     WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n+    c1.LoadGenesisBlock();",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 4,
      "original_position": 4,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nNote: IIUC, it's necessary to load the genesis block here so the ActivateExistingSnapshot call below can be passed a known block hash of a block in `m_block_index`, not a random block.",
      "created_at": "2023-07-18T03:30:56Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266153816",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266153816"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 52,
      "original_line": 52,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266156727",
      "pull_request_review_id": 1533749512,
      "id": 1266156727,
      "node_id": "PRRC_kwDOABII585LeAS3",
      "diff_hunk": "@@ -99,16 +101,12 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 44,
      "original_position": 44,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (eb8ce95a2551fe521d00a5901ea773514395255b)\r\n\r\nSeems like it might be useful to check `BOOST_CHECK_EQUAL(exp_tip, exp_tip2);` now to verify `ActivateBestChain` actually did arrive at the expected CBlockIndex*, not just the right block block hash.",
      "created_at": "2023-07-18T03:34:38Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266156727",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266156727"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 104,
      "original_line": 104,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266161430",
      "pull_request_review_id": 1533749512,
      "id": 1266161430,
      "node_id": "PRRC_kwDOABII585LeBcW",
      "diff_hunk": "@@ -139,16 +135,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n \n     // Create a snapshot-based chainstate.\n     //\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\n     chainstates.push_back(&c2);\n     c2.InitCoinsDB(\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\n \n     {\n         LOCK(::cs_main);\n         c2.InitCoinsCache(1 << 23);\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 89,
      "original_position": 88,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (b0b48b3e986319fe8cd5a80052099070279ce5c0)\r\n\r\nNote: It seems like this LoadGenesis/SetBestBlock step was never necessary, so good to drop now. Dropping it maybe makes the test a little less realistic, but simplifies things and keeps the test more focused on verifying cache sizes.",
      "created_at": "2023-07-18T03:40:49Z",
      "updated_at": "2023-07-18T04:03:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1266161430",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1266161430"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 150,
      "original_line": 150,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267180167",
      "pull_request_review_id": 1535703245,
      "id": 1267180167,
      "node_id": "PRRC_kwDOABII585Lh6KH",
      "diff_hunk": "@@ -4431,62 +4431,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||\n                     (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                      (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n \n-                // Fill each chainstate's block candidate set. Only add assumed-valid\n-                // blocks to the tip candidate set if the chainstate is allowed to rely on\n-                // assumed-valid blocks.\n-                //\n-                // If all setBlockIndexCandidates contained the assumed-valid blocks, the\n-                // background chainstate's ActivateBestChain() call would add assumed-valid\n-                // blocks to the chain (based on how FindMostWorkChain() works). Obviously\n-                // we don't want this since the purpose of the background validation chain\n-                // is to validate assued-valid blocks.\n-                //\n-                // Note: This is considering all blocks whose height is greater or equal to\n-                // the first assumed-valid block to be assumed-valid blocks, and excluding\n-                // them from the background chainstate's setBlockIndexCandidates set. This\n-                // does mean that some blocks which are not technically assumed-valid\n-                // (later blocks on a fork beginning before the first assumed-valid block)\n-                // might not get added to the background chainstate, but this is ok,\n-                // because they will still be attached to the active chainstate if they\n-                // actually contain more work.\n-                //\n-                // Instead of this height-based approach, an earlier attempt was made at\n-                // detecting \"holistically\" whether the block index under consideration\n-                // relied on an assumed-valid ancestor, but this proved to be too slow to\n-                // be practical.\n                 for (Chainstate* chainstate : GetAll()) {\n-                    if (chainstate->reliesOnAssumedValid() ||",
      "path": "src/validation.cpp",
      "position": 295,
      "original_position": 62,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nIt would be good to remove the reliesOnAssumedValid() function since it is no longer used after this.",
      "created_at": "2023-07-18T18:50:41Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267180167",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267180167"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4456,
      "original_line": 4456,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267184143",
      "pull_request_review_id": 1535703245,
      "id": 1267184143,
      "node_id": "PRRC_kwDOABII585Lh7IP",
      "diff_hunk": "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 130,
      "original_position": 9,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nNote: the reason why all entries were added previously was because `pindex->nHeight < first_assumed_valid_height` check was always true, because `first_assumed_valid_height` was `std::numeric_limits<int>::max()`",
      "created_at": "2023-07-18T18:55:12Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267184143",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267184143"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 448,
      "original_line": 448,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267187714",
      "pull_request_review_id": 1535703245,
      "id": 1267187714,
      "node_id": "PRRC_kwDOABII585Lh8AC",
      "diff_hunk": "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\n \n-    // Mark some region of the chain assumed-valid.\n+    // Mark some region of the chain assumed-valid, and remove the HAVE_DATA flag.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 134,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nHAVE_DATA flag doesn't actualy seem to be removed here. Should it be? And since the test is already passing withtout this would the reason just removing HAVE_DATA flag be to satisfy CheckBlockIndex checks?",
      "created_at": "2023-07-18T18:59:18Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267187714",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267187714"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 452,
      "original_line": 452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267204896",
      "pull_request_review_id": 1535703245,
      "id": 1267204896,
      "node_id": "PRRC_kwDOABII585LiAMg",
      "diff_hunk": "@@ -464,15 +465,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 158,
      "original_position": 39,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nThis is true, but it seems like it might make the test less confusing and more realistic if we just added a ` cs2.m_chain.SetTip(* assumed_base)` call below the `cs1.m_chain.SetTip(*validated_tip);` call. I think if this was done the cs2.setBlockIndexCandidates would just contain blocks after the snapshot.\r\n\r\n",
      "created_at": "2023-07-18T19:17:48Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267204896",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267204896"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 481,
      "original_line": 481,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267209493",
      "pull_request_review_id": 1535703245,
      "id": 1267209493,
      "node_id": "PRRC_kwDOABII585LiBUV",
      "diff_hunk": "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes - num_assumed_valid + 1);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": null,
      "original_position": 64,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nCommand at the top of the test saying it checks cs2 \"contains all blocks, even those assumed-valid\" is out of date. Should be \"contains all blocks except those assumed-valid, because they don't have data\"",
      "created_at": "2023-07-18T19:20:07Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267209493",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267209493"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 499,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267213310",
      "pull_request_review_id": 1535703245,
      "id": 1267213310,
      "node_id": "PRRC_kwDOABII585LiCP-",
      "diff_hunk": "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 185,
      "original_position": 60,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f41cef2ba1e1f033356691e520e39d9d75d5eb4f)\r\n\r\nI'm actually confused about how this is working because the HAVE_DATA flag doesn't seem to be removed above.",
      "created_at": "2023-07-18T19:22:00Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267213310",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267213310"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 501,
      "original_line": 501,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267226100",
      "pull_request_review_id": 1535703245,
      "id": 1267226100,
      "node_id": "PRRC_kwDOABII585LiFX0",
      "diff_hunk": "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated",
      "path": "src/chain.h",
      "position": null,
      "original_position": 23,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bef5acee93e128857d20137ea0c83f281a780211",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Documentation improvements for assumeutxo\" (bef5acee93e128857d20137ea0c83f281a780211)\r\n\r\n\"it has\" should be \"it may have\"",
      "created_at": "2023-07-18T19:28:21Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267226100",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267226100"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": 138,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 139,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267227843",
      "pull_request_review_id": 1535703245,
      "id": 1267227843,
      "node_id": "PRRC_kwDOABII585LiFzD",
      "diff_hunk": "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it has\n+     * descendant blocks with VALID_SCRIPTS set, because they were validated\n+     * based on an assumeutxo snapshot.\n+     *\n+     * When an assumeutxo snapshot is loaded, the ASSUMED_VALID flag is added to\n+     * unvalidated blocks below the snapshot height. Then, as the background",
      "path": "src/chain.h",
      "position": null,
      "original_position": 27,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "bef5acee93e128857d20137ea0c83f281a780211",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Documentation improvements for assumeutxo\" (bef5acee93e128857d20137ea0c83f281a780211)\r\n\r\n\"below the snapshot height\" should be \"at the snapshot height and below\"",
      "created_at": "2023-07-18T19:30:22Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267227843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267227843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 143,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267230477",
      "pull_request_review_id": 1535703245,
      "id": 1267230477,
      "node_id": "PRRC_kwDOABII585LiGcN",
      "diff_hunk": "@@ -4750,8 +4751,8 @@ void Chainstate::CheckBlockIndex()\n         // Begin: actual consistency checks.\n         if (pindex->pprev == nullptr) {\n             // Genesis block checks.\n-            assert(pindex->GetBlockHash() == m_chainman.GetConsensus().hashGenesisBlock); // Genesis block's hash must match.\n-            assert(pindex == m_chain.Genesis()); // The current active chain's genesis block must be this block.\n+            assert(pindex->GetBlockHash() == GetConsensus().hashGenesisBlock); // Genesis block's hash must match.\n+            assert(pindex == ActiveChain().Genesis()); // The current active chain's genesis block must be this block.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 74,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f921887c1afdcd333cf71ca25e5efbf4991f806e",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Move CheckBlockIndex() from Chainstate to ChainstateManager\" (f921887c1afdcd333cf71ca25e5efbf4991f806e)\r\n\r\nI think it would be a little better to use `GetAll` instead of `ActiveChain()` here. All the chains should have the same genesis block.",
      "created_at": "2023-07-18T19:33:56Z",
      "updated_at": "2023-07-18T19:54:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1267230477",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267230477"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 4755,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270716655",
      "pull_request_review_id": 1541223509,
      "id": 1270716655,
      "node_id": "PRRC_kwDOABII585LvZjv",
      "diff_hunk": "@@ -221,7 +221,7 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n \n         // A reload of the block index is required to recompute setBlockIndexCandidates\n         // for the fully validated chainstate.\n-        chainman.ActiveChainstate().UnloadBlockIndex();\n+        chainman.ActiveChainstate().ClearBlockIndexCandidates();",
      "path": "src/node/chainstate.cpp",
      "position": 5,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "471da5f6e74bac71aeffe2ebc5faff145a6cbcea",
      "in_reply_to_id": 1266007380,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I agree that this seems redundant; the original call to `UnloadBlockIndex()` was added in #25740, and if I'm reading correctly I don't think it should have been necessary then either. @jamesob Wondering if you agree, or if we're overlooking something?",
      "created_at": "2023-07-21T14:04:49Z",
      "updated_at": "2023-07-21T14:04:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270716655",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270716655"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": 222,
      "original_start_line": 222,
      "start_side": "RIGHT",
      "line": 224,
      "original_line": 224,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270720379",
      "pull_request_review_id": 1541229429,
      "id": 1270720379,
      "node_id": "PRRC_kwDOABII585Lvad7",
      "diff_hunk": "@@ -3419,9 +3419,24 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n {\n     AssertLockHeld(cs_main);\n-    // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n-    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+    // The block only is a candidate for the most-work-chain if it has more work than our current tip.\n+    if (m_chain.Tip() != nullptr && setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        return;\n+    }\n+\n+    bool is_active_chainstate = this == &m_chainman.ActiveChainstate();\n+    if (is_active_chainstate) {\n+        // The active chainstate should always add entries that have more\n+        // work than the tip.\n         setBlockIndexCandidates.insert(pindex);\n+    } else if (!m_disabled) {\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base (which can't be nullptr or else we'll\n+        // never make progress).\n+        const CBlockIndex* snapshot_base = Assert(m_chainman.GetSnapshotBaseBlock());",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": 1266149966,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I agree that it would be good to add an assert to catch this earlier, but we discussed before that due to the different ways that chainstates can be constructed and the order in which snapshot block hashes can be passed in (relative to when the block index is populated on startup), that there wasn't a clear  way to do this at an earlier point in the code.\r\n\r\nI'll update the code comment though to make it more clear what will break if an invalid hash is passed in.",
      "created_at": "2023-07-21T14:08:17Z",
      "updated_at": "2023-07-21T14:08:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1270720379",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1270720379"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272483470",
      "pull_request_review_id": 1543838205,
      "id": 1272483470,
      "node_id": "PRRC_kwDOABII585L2I6O",
      "diff_hunk": "@@ -442,16 +442,17 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n     };\n \n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n-    // tip candidates.\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\n+    // considered as a candidate.\n     reload_all_block_indexes();\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\n \n-    // Mark some region of the chain assumed-valid.\n+    // Mark some region of the chain assumed-valid, and remove the HAVE_DATA flag.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 134,
      "original_position": 13,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": 1267187714,
      "user": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The blocks being marked `ASSUMED_VALID` have their `nStatus` completely reset to the expected values for assumed valid, which includes the omission of `HAVE_DATA`.",
      "created_at": "2023-07-24T16:18:19Z",
      "updated_at": "2023-07-24T16:18:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272483470",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272483470"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 452,
      "original_line": 452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272692040",
      "pull_request_review_id": 1544165673,
      "id": 1272692040,
      "node_id": "PRRC_kwDOABII585L271I",
      "diff_hunk": "@@ -481,16 +485,18 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n \n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 185,
      "original_position": 60,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "f41cef2ba1e1f033356691e520e39d9d75d5eb4f",
      "in_reply_to_id": 1267213310,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "See @achow's explanation: https://github.com/bitcoin/bitcoin/pull/27746/files#r1272483470",
      "created_at": "2023-07-24T19:58:06Z",
      "updated_at": "2023-07-24T19:58:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272692040",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272692040"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 501,
      "original_line": 501,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272722353",
      "pull_request_review_id": 1544223967,
      "id": 1272722353,
      "node_id": "PRRC_kwDOABII585L3DOx",
      "diff_hunk": "@@ -99,16 +101,12 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 44,
      "original_position": 44,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "eb8ce95a2551fe521d00a5901ea773514395255b",
      "in_reply_to_id": 1266156727,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Done.",
      "created_at": "2023-07-24T20:29:24Z",
      "updated_at": "2023-07-24T20:29:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1272722353",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1272722353"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 104,
      "original_line": 104,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277540196",
      "pull_request_review_id": 1552110152,
      "id": 1277540196,
      "node_id": "PRRC_kwDOABII585MJbdk",
      "diff_hunk": "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it may have",
      "path": "src/chain.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "0ce805b632dcb98944a931f758f76f530f5ce5f2: why not `less than BLOCK_VALID_TRANSACTIONS`? Since the minimum requirement to download an assumed-valid block is that we have its headers, i.e. we're at `BLOCK_VALID_TREE` or above.\r\n\r\nSame question for `RaiseValidity`, which this PR doesn't touch. Contrast that to `CheckBlockIndex()` which skips checks for `BLOCK_VALID_TRANSACTIONS`, `BLOCK_VALID_CHAIN` and `BLOCK_VALID_SCRIPTS` when assume valid is set.\r\n\r\nI tried changing `BLOCK_VALID_SCRIPTS` to `BLOCK_VALID_TRANSACTIONS ` in `PopulateAndValidateSnapshot`:\r\n\r\n```\r\n        // Mark unvalidated block index entries beneath the snapshot base block as assumed-valid.\r\n        if (!index->IsValid(BLOCK_VALID_SCRIPTS)) {\r\n```\r\n\r\nThat didn't break a test and makes more intuitive sense to me. It also seems more consistent with `setBlockIndexCandidates`.",
      "created_at": "2023-07-28T13:21:15Z",
      "updated_at": "2023-07-28T14:25:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277540196",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277540196"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 138,
      "original_line": 138,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277557586",
      "pull_request_review_id": 1552110152,
      "id": 1277557586,
      "node_id": "PRRC_kwDOABII585MJftS",
      "diff_hunk": "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "path": "src/chain.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "0ce805b632dcb98944a931f758f76f530f5ce5f2: why isn't `BLOCK_VALID_TRANSACTIONS` also alternatively `ASSUMED_VALID`?",
      "created_at": "2023-07-28T13:38:19Z",
      "updated_at": "2023-07-28T14:25:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277557586",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277557586"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 113,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277559238",
      "pull_request_review_id": 1552110152,
      "id": 1277559238,
      "node_id": "PRRC_kwDOABII585MJgHG",
      "diff_hunk": "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,\n \n     //! Outputs do not overspend inputs, no double spends, coinbase output ok, no immature coinbase spends, BIP30.\n-    //! Implies all parents are also at least CHAIN.\n+    //! Implies all parents are either at least VALID_CHAIN, or are ASSUMED_VALID\n     BLOCK_VALID_CHAIN        =    4,\n \n-    //! Scripts & signatures ok. Implies all parents are also at least SCRIPTS.\n+    //! Scripts & signatures ok. Implies all parents are either at least VALID_SCRIPTS, or are ASSUMED_VALID.\n     BLOCK_VALID_SCRIPTS      =    5,\n \n     //! All validity bits.",
      "path": "src/chain.h",
      "position": 12,
      "original_position": 12,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "0ce805b632dcb98944a931f758f76f530f5ce5f2: maybe make this:\r\n\r\n```cpp\r\n//! All (non-assumed) validity bits.\r\n```\r\n\r\nWhich makes functions that use this more readable:\r\n\r\n<img width=\"659\" alt=\"SchermÂ­afbeelding 2023-07-28 om 15 44 16\" src=\"https://github.com/bitcoin/bitcoin/assets/10217/2b309b0c-ac4a-42ff-9257-03cb75c057ee\">\r\n",
      "created_at": "2023-07-28T13:39:55Z",
      "updated_at": "2023-07-28T14:25:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277559238",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277559238"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 122,
      "original_line": 122,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277639934",
      "pull_request_review_id": 1552271924,
      "id": 1277639934,
      "node_id": "PRRC_kwDOABII585MJzz-",
      "diff_hunk": "@@ -134,10 +134,18 @@ enum BlockStatus : uint32_t {\n     BLOCK_OPT_WITNESS        =   128, //!< block data in blk*.dat was received with a witness-enforcing client\n \n     /**\n-     * If set, this indicates that the block index entry is assumed-valid.\n-     * Certain diagnostics will be skipped in e.g. CheckBlockIndex().\n-     * It almost certainly means that the block's full validation is pending\n-     * on a background chainstate. See `doc/design/assumeutxo.md`.\n+     * If ASSUMED_VALID is set, it means that this block has not been validated\n+     * and has validity status less than VALID_SCRIPTS. Also that it may have",
      "path": "src/chain.h",
      "position": 22,
      "original_position": 22,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": 1277540196,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> why not `less than BLOCK_VALID_TRANSACTIONS`?\r\n\r\nI asked myself the same question recently and came to the conclusion that it's because when we finally end up downloading the assumed-valid blocks, there will be a period in time where we've saved the block (and therefore raised its validity to `BLOCK_VALID_TRANSACTIONS`) but haven't connected it yet to the background chainstate (so it's still `ASSUMED_VALID`).",
      "created_at": "2023-07-28T14:42:06Z",
      "updated_at": "2023-07-28T14:42:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277639934",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1277639934"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 138,
      "original_line": 138,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278023724",
      "pull_request_review_id": 1552855193,
      "id": 1278023724,
      "node_id": "PRRC_kwDOABII585MLRgs",
      "diff_hunk": "@@ -4798,27 +4803,32 @@ void Chainstate::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n-            if (pindexFirstInvalid == nullptr) {\n-                const bool is_active = this == &m_chainman.ActiveChainstate();\n-\n-                // If this block sorts at least as good as the current tip and\n-                // is valid and we have all data for its parents, it must be in\n-                // setBlockIndexCandidates.  m_chain.Tip() must also be there\n-                // even if some data has been pruned.\n-                //\n-                // Don't perform this check for the background chainstate since\n-                // its setBlockIndexCandidates shouldn't have some entries (i.e. those past the\n-                // snapshot block) which do exist in the block index for the active chainstate.\n-                if (is_active && (pindexFirstMissing == nullptr || pindex == m_chain.Tip())) {\n-                    assert(setBlockIndexCandidates.count(pindex));\n+        // Chainstate-specific checks on setBlockIndexCandidates\n+        for (auto c : GetAll()) {\n+            if (c->m_chain.Tip() == nullptr) continue;\n+            if (!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {",
      "path": "src/validation.cpp",
      "position": 495,
      "original_position": 103,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "3556b850221bc0e597d7dd749d4d47ab58dc8083: if you have to retouch, can you add a comment that `!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip())` means \"pindex has more work than the tip or was received earlier\"",
      "created_at": "2023-07-28T19:49:02Z",
      "updated_at": "2023-07-28T20:15:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278023724",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278023724"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4816,
      "original_line": 4809,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278035016",
      "pull_request_review_id": 1552855193,
      "id": 1278035016,
      "node_id": "PRRC_kwDOABII585MLURI",
      "diff_hunk": "@@ -4798,27 +4803,32 @@ void Chainstate::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n-            if (pindexFirstInvalid == nullptr) {\n-                const bool is_active = this == &m_chainman.ActiveChainstate();\n-\n-                // If this block sorts at least as good as the current tip and\n-                // is valid and we have all data for its parents, it must be in\n-                // setBlockIndexCandidates.  m_chain.Tip() must also be there\n-                // even if some data has been pruned.\n-                //\n-                // Don't perform this check for the background chainstate since\n-                // its setBlockIndexCandidates shouldn't have some entries (i.e. those past the\n-                // snapshot block) which do exist in the block index for the active chainstate.\n-                if (is_active && (pindexFirstMissing == nullptr || pindex == m_chain.Tip())) {\n-                    assert(setBlockIndexCandidates.count(pindex));\n+        // Chainstate-specific checks on setBlockIndexCandidates\n+        for (auto c : GetAll()) {\n+            if (c->m_chain.Tip() == nullptr) continue;\n+            if (!CBlockIndexWorkComparator()(pindex, c->m_chain.Tip()) && pindexFirstNeverProcessed == nullptr) {\n+                if (pindexFirstInvalid == nullptr) {\n+                    const bool is_active = c == &ActiveChainstate();\n+                    // If this block sorts at least as good as the current tip and\n+                    // is valid and we have all data for its parents, it must be in\n+                    // setBlockIndexCandidates.  m_chain.Tip() must also be there\n+                    // even if some data has been pruned.\n+                    //\n+                    if ((pindexFirstMissing == nullptr || pindex == c->m_chain.Tip())) {\n+                        // The active chainstate should always have this block\n+                        // as a candidate, but a background chainstate should\n+                        // only have it if it is an ancestor of the snapshot base.\n+                        if (is_active || GetSnapshotBaseBlock()->GetAncestor(pindex->nHeight) == pindex) {\n+                            assert(c->setBlockIndexCandidates.count(pindex));\n+                        }\n+                    }\n+                    // If some parent is missing, then it could be that this block was in\n+                    // setBlockIndexCandidates but had to be removed because of the missing data.\n+                    // In this case it must be in m_blocks_unlinked -- see test below.\n                 }\n-                // If some parent is missing, then it could be that this block was in\n-                // setBlockIndexCandidates but had to be removed because of the missing data.\n-                // In this case it must be in m_blocks_unlinked -- see test below.\n+            } else { // If this block sorts worse than the current tip or some ancestor's block has never been seen, it cannot be in setBlockIndexCandidates.",
      "path": "src/validation.cpp",
      "position": 518,
      "original_position": 126,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "3556b850221bc0e597d7dd749d4d47ab58dc8083",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "3556b850221bc0e597d7dd749d4d47ab58dc8083: there's a tie breaker in the comparator for if two blocks with equal work were loaded from disk. Presumably that only matters if you restart right during a reorg in some weird way.",
      "created_at": "2023-07-28T20:00:16Z",
      "updated_at": "2023-07-28T20:15:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278035016",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278035016"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4836,
      "original_line": 4829,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308074",
      "pull_request_review_id": 1553292155,
      "id": 1278308074,
      "node_id": "PRRC_kwDOABII585MMW7q",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate",
      "path": "src/validation.cpp",
      "position": 265,
      "original_position": 32,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "768690b7ce551cd403f8e2a099372915f6022ad4: Maybe clarify that initially this only applies to the snapshot chainstate, which uses the base block as its starting point. For the background chainstate, as well an active chainstate not created from a snapshot, `GetSnapshotBaseBlock()` is `nullptr` so the special-case won't apply. But the background state will consider it a candidate once it's been downloaded.",
      "created_at": "2023-07-29T14:48:39Z",
      "updated_at": "2023-07-29T15:12:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308074",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4448,
      "original_line": 4440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308558",
      "pull_request_review_id": 1553292155,
      "id": 1278308558,
      "node_id": "PRRC_kwDOABII585MMXDO",
      "diff_hunk": "@@ -412,7 +412,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n //!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 96,
      "original_position": 2,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "768690b7ce551cd403f8e2a099372915f6022ad4\r\n\r\n```cpp\r\n//!\r\n//! - Run LoadBlockIndex() and ensure that setBlockIndexCandidates of the first ...\r\n```",
      "created_at": "2023-07-29T14:54:01Z",
      "updated_at": "2023-07-29T15:11:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308558",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278308558"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 413,
      "original_line": 413,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278312526",
      "pull_request_review_id": 1553292155,
      "id": 1278312526,
      "node_id": "PRRC_kwDOABII585MMYBO",
      "diff_hunk": "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 187,
      "original_position": 76,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "768690b7ce551cd403f8e2a099372915f6022ad4: this had me confused, but it's because the test considers a scenario where the snapshot base block has been downloaded. It could be nice to include the moment _before_ it's downloaded where this should be `0`.",
      "created_at": "2023-07-29T15:10:33Z",
      "updated_at": "2023-07-29T15:11:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278312526",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278312526"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 503,
      "original_line": 503,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278315696",
      "pull_request_review_id": 1553302075,
      "id": 1278315696,
      "node_id": "PRRC_kwDOABII585MMYyw",
      "diff_hunk": "@@ -3920,13 +3922,13 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n     // process an unrequested block if it's new and has enough work to\n     // advance our tip, and isn't too many blocks ahead.\n     bool fAlreadyHave = pindex->nStatus & BLOCK_HAVE_DATA;\n-    bool fHasMoreOrSameWork = (m_chain.Tip() ? pindex->nChainWork >= m_chain.Tip()->nChainWork : true);\n+    bool fHasMoreOrSameWork = (ActiveTip() ? pindex->nChainWork >= ActiveTip()->nChainWork : true);",
      "path": "src/validation.cpp",
      "position": 149,
      "original_position": 56,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "034f920d1755cff752d46b089ad37bdd703bf896",
      "in_reply_to_id": 1251271941,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6 Maybe add: `Background validation always ignores unrequested blocks.`",
      "created_at": "2023-07-29T15:49:20Z",
      "updated_at": "2023-07-29T16:54:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278315696",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278315696"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3961,
      "original_line": 3961,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278316042",
      "pull_request_review_id": 1553302075,
      "id": 1278316042,
      "node_id": "PRRC_kwDOABII585MMY4K",
      "diff_hunk": "@@ -3974,7 +3977,7 @@ bool Chainstate::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockV\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n     // (but if it does not build on our best tip, let the SendMessages loop relay it)",
      "path": "src/validation.cpp",
      "position": 180,
      "original_position": 92,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "d0d40ea9a6478d81d7531b7cfc52a8bdaa0883d6: `// We don't relay background validation blocks.` ",
      "created_at": "2023-07-29T15:53:44Z",
      "updated_at": "2023-07-29T16:54:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278316042",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1278316042"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4002,
      "original_line": 3979,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279727266",
      "pull_request_review_id": 1555524219,
      "id": 1279727266,
      "node_id": "PRRC_kwDOABII585MRxai",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate",
      "path": "src/validation.cpp",
      "position": 265,
      "original_position": 32,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1278308074,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278308074\r\n\r\n> `GetSnapshotBaseBlock()` is `nullptr` so the special-case won't apply\r\n\r\nI may be misunderstanding, but I don't think it's true that `GetSnapshotBaseBlock` is null for the background chainstate. This is a ChainstateManager method, so `GetSnapshotBaseBlock` is going to be non-null if any snapshot is loaded, and this code will try to add the snapshot block to both chainstates, even though it's not needed for the background chainstate. It might be clearer if the code narrowed the special case, and only added the snapshot block to the snapshot chainstate where it was actually needed, not to both chainstates. But that might make the code more complicated.\r\n\r\nI do think it might be better if the comment said \"assumeutxo snapshot chainstate\" instead of \"assumeutxo-based chainstate\" to be more specific about when this special case is needed, but I don't think it need to go into detail about other cases where the check is harmless and not needed.",
      "created_at": "2023-07-31T18:36:28Z",
      "updated_at": "2023-07-31T20:07:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279727266",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279727266"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4448,
      "original_line": 4440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279760417",
      "pull_request_review_id": 1555524219,
      "id": 1279760417,
      "node_id": "PRRC_kwDOABII585MR5gh",
      "diff_hunk": "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 186,
      "original_position": 75,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nWould be good to directly verify the snapshot block is included:\r\n\r\n```c++\r\n// block before the snapshot is excluded (as well as earlier blocks)\r\nBOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base->pprev), 0); \r\n// snapshot block is included (as well as later blocks)\r\nBOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_base), 1);\r\n```",
      "created_at": "2023-07-31T19:12:44Z",
      "updated_at": "2023-07-31T20:07:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279760417",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279760417"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 502,
      "original_line": 502,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279767675",
      "pull_request_review_id": 1555524219,
      "id": 1279767675,
      "node_id": "PRRC_kwDOABII585MR7R7",
      "diff_hunk": "@@ -466,33 +467,41 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n             validated_tip = index;\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n-        // Note the block after the last assumed valid block as the snapshot base\n-        if (i == last_assumed_valid_idx) {\n+        // Note the last assumed valid block as the snapshot base\n+        if (i == last_assumed_valid_idx - 1) {\n             assumed_base = index;\n+            BOOST_CHECK(index->IsAssumedValid());\n+        } else if (i == last_assumed_valid_idx) {\n             BOOST_CHECK(!index->IsAssumedValid());\n         }\n     }\n \n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n \n+    // Note: cs2's tip is not set when ActivateExistingSnapshot is called.\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\n         return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\n \n     // Set tip of the fully validated chain to be the validated tip\n     cs1.m_chain.SetTip(*validated_tip);\n \n+    // Set tip of the assume-valid-based chain to the assume-valid block\n+    cs2.m_chain.SetTip(*assumed_base);\n+\n     reload_all_block_indexes();\n \n-    // The fully validated chain only has candidates up to the start of the assumed-valid\n-    // blocks.\n+    // The fully validated chain should have the current validated tip\n+    // and the assumed valid base as candidates.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 2);\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_base), 1);\n \n-    // The assumed-valid tolerant chain has all blocks as candidates.\n-    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    // The assumed-valid tolerant chain has the assumed valid base as a\n+    // candidate, but otherwise has none of the assumed-valid (which do not\n+    // HAVE_DATA) blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 0);\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 187,
      "original_position": 76,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1278312526,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1278312526\r\n\r\n> [768690b](https://github.com/bitcoin/bitcoin/commit/768690b7ce551cd403f8e2a099372915f6022ad4): this had me confused, but it's because the test considers a scenario where the snapshot base block has been downloaded. It could be nice to include the moment _before_ it's downloaded where this should be `0`.\r\n\r\nThis review comment does not match my understanding. The snapshot block is `assumed_base` at height 39 and it does not have data. This line is checking `assumed_tip` block at height 100 which does have data.\r\n\r\nI think all the variable names in this test are pretty confusing, and it would probably be clearer if blocks were referred to directly by height, but that's the was the test style, so it's not changing.",
      "created_at": "2023-07-31T19:20:46Z",
      "updated_at": "2023-07-31T20:07:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279767675",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279767675"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 503,
      "original_line": 503,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279781965",
      "pull_request_review_id": 1555524219,
      "id": 1279781965,
      "node_id": "PRRC_kwDOABII585MR-xN",
      "diff_hunk": "@@ -412,7 +412,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n //!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n+//!   except those marked assume-valid, because those entries don't HAVE_DATA.",
      "path": "src/test/validation_chainstatemanager_tests.cpp",
      "position": 99,
      "original_position": 5,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nI think it's a little misleading to say the other chainstate contains all block except those marked assume-valid because:\r\n\r\n- It actually does contain one block marked assumed-valid, which is the snapshot base (block 39)\r\n- It also excludes other blocks which are not assumed-valid because they don't have more work than the tip (blocks 1-19)\r\n\r\nI think this comment could incorporate sjors suggestion above and just say \"Run LoadBlockIndex() and ensure that setBlockIndexCandidates of the first chainstate only contains blocks leading to the snapshot base, and that setBlockIndexCandidates of the second chainstate only contains blocks following the snapshot base.\"\r\n\r\nOr could leave out the details and say \"Run LoadBlockIndex() and check setBlockIndexCandidates of both chainstates.\"",
      "created_at": "2023-07-31T19:35:55Z",
      "updated_at": "2023-07-31T20:07:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279781965",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279781965"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 415,
      "original_line": 415,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279811734",
      "pull_request_review_id": 1555524219,
      "id": 1279811734,
      "node_id": "PRRC_kwDOABII585MSGCW",
      "diff_hunk": "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "path": "src/chain.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": 1277557586,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277557586\r\n\r\n> [0ce805b](https://github.com/bitcoin/bitcoin/commit/0ce805b632dcb98944a931f758f76f530f5ce5f2): why isn't `BLOCK_VALID_TRANSACTIONS` also alternatively `ASSUMED_VALID`?\r\n\r\nI'm not sure what this review comment is asking. The code comment above still seems accurate to me, but it maybe it could be improved.",
      "created_at": "2023-07-31T19:49:36Z",
      "updated_at": "2023-07-31T20:07:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1279811734",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1279811734"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 113,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1280251267",
      "pull_request_review_id": 1556389934,
      "id": 1280251267,
      "node_id": "PRRC_kwDOABII585MTxWD",
      "diff_hunk": "@@ -113,10 +113,10 @@ enum BlockStatus : uint32_t {\n     BLOCK_VALID_TRANSACTIONS =    3,",
      "path": "src/chain.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "0ce805b632dcb98944a931f758f76f530f5ce5f2",
      "in_reply_to_id": 1277557586,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It's related to https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1277639934\r\n\r\n(it suggests a further refactor, not changing the comment)",
      "created_at": "2023-08-01T08:02:26Z",
      "updated_at": "2023-08-01T08:02:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1280251267",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1280251267"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 113,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320915269",
      "pull_request_review_id": 1618995679,
      "id": 1320915269,
      "node_id": "PRRC_kwDOABII585Ou5FF",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (768690b7ce551cd403f8e2a099372915f6022ad4)\r\n\r\nIt looks like there may be a  bug in this code because this `pindex == GetSnapshotBaseBlock()` special case will add the snapshot block to `setBlockIndexCandidates` whether or not it has data, but there is also an assert in `FindMostWorkChain` which asserts that blocks in `setBlockIndexCandidates` do have data:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2914 \r\n\r\nI think it's not possible to hit this assert for the snapshot chainstate, but it may be possible to hit this assert for the background chainstate.\r\n\r\nFor the snapshot chainstate, I think the assert won't be reached because after the snapshot is loaded the `Chainstate::LoadChainTip` function should immediately set the chain tip to the snapshot block index:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L4153\r\n\r\nso the `m_chain.Contains(pindexTest)` check before the assert will be false and the assert will not run:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2913-L2914\r\n\r\nBut for the background chainstate, it seems possible assert could be hit if `FindMostWorkChain` is called before the snapshot block is downloaded.\r\n\r\nIn any case, this special `pindex == GetSnapshotBaseBlock()` case seems overbroad. It seems like it should only apply to the snapshot chainstate, not the background chainstate, and I'm not actually sure why it is necessary to have at all if `Chainstate::LoadChainTip` is already going to set the snapshot block as the snapshot chainstate tip.\r\n\r\nI think the interaction between these checks and the checks inside the `TryAddBlockIndexCandidate` are also unnecessarily confusing, and it would be nice whether there is a bug or not to move all the move all the checks inside `TryAddBlockIndexCandidate` and call it unconditionally. This should make it easeir to avoid adding the snapshot block the background chainstate candidate set before it is downloaded. It would also be great to drop the snapshot block special case entirely if it is not needed.\r\n\r\n\r\n",
      "created_at": "2023-09-11T01:40:32Z",
      "updated_at": "2023-09-11T01:40:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1320915269",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1320915269"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321815541",
      "pull_request_review_id": 1620419583,
      "id": 1321815541,
      "node_id": "PRRC_kwDOABII585OyU31",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> It looks like there may be a bug in this code because this pindex == GetSnapshotBaseBlock() special case will add the snapshot block to setBlockIndexCandidates whether or not it has data, but there is also an assert in FindMostWorkChain which asserts that blocks in setBlockIndexCandidates do have data:\r\n> \r\n> [bitcoin/src/validation.cpp](https://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2914)\r\n> Line 2914 in [c5a63ea](https://github.com/bitcoin/bitcoin/commit/c5a63ea56f8347139bd84e1669b378ecfb234c3c)\r\n>  ```cpp\r\n>  assert(pindexTest->HaveTxsDownloaded() || pindexTest->nHeight == 0); \r\n>  ```\r\n> I think it's not possible to hit this assert for the snapshot chainstate, but it may be possible to hit this assert for the background chainstate.\r\n\r\nIf I'm reading `FindMostWorkChain()` correctly, this assert _won't_ be hit for a background chainstate, because the second clause of this condition \r\n```cpp\r\nwhile (pindexTest && !m_chain.Contains(pindexTest)) {\r\n```\r\nwill exclude the snapshot base block from consideration without data (since it is not in the background chainstate's `m_chain` until it is actually downloaded, and so has data). So as far as I can tell, there's no bug here - but I'm glad you're double checking this; the `setBlockIndexCandidates` code is very confusing indeed, and I'm amenable to any way we can make it more easily understandable.",
      "created_at": "2023-09-11T16:41:43Z",
      "updated_at": "2023-09-11T16:41:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321815541",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321815541"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321839150",
      "pull_request_review_id": 1620456569,
      "id": 1321839150,
      "node_id": "PRRC_kwDOABII585Oyaou",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321815541\r\n\r\nThe way I'm reading e code:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c5a63ea56f8347139bd84e1669b378ecfb234c3c/src/validation.cpp#L2913-L2914\r\n\r\nIf a snapshot is loaded and `pindexTest` points to the snapshot block and the snapshot block is not yet downloaded, and `m_chain` is the background chain, then `m_chain.Contains(pindexTest)` will be false, so the while loop condition will be true, and the assert could be be hit.\r\n\r\nYou seem to be saying that `m_chain.Contains(pindexTest)` will be false, so the while condition _won't_ be hit?\r\n\r\n\r\n",
      "created_at": "2023-09-11T17:05:12Z",
      "updated_at": "2023-09-11T17:05:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321839150",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321839150"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321843193",
      "pull_request_review_id": 1620462979,
      "id": 1321843193,
      "node_id": "PRRC_kwDOABII585Oybn5",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I'm sorry, my previous comment was more or less incorrect. Another reason why the assert you mention doesn't pose a problem is because, confusingly, `HaveTxsDownloaded()` is just an alias for `nChainTx != 0`. Since we manually set nChainTx for the snapshot base block (https://github.com/bitcoin/bitcoin/pull/27596/commits/315586f25b9ec0ed0c807d8c4455e6a73a3c4990) this check (again, very confusingly) passes. At some point long ago I made a note somewhere about fixing that method's misleading name...\r\n\r\nSo the long story short is that `FindMostWorkChain()` eventually works for the background chainstate because it detects, correctly, that there are blocks with missing data between the IBD tip and the snapshot base, and correctly rewinds `m_chain` back to the actual IBD tip. I think when @sdaftuar first proposed this change I was confused about why the `LoadBlockIndex()` simplification could actually work, and this is the reason.",
      "created_at": "2023-09-11T17:09:31Z",
      "updated_at": "2023-09-11T17:09:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321843193",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321843193"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321858810",
      "pull_request_review_id": 1620488083,
      "id": 1321858810,
      "node_id": "PRRC_kwDOABII585Oyfb6",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> So the long story short is that FindMostWorkChain() eventually works for the background chainstate because it detects, correctly, that there are blocks with missing data between the IBD tip and the snapshot base, and correctly rewinds m_chain back to the actual IBD tip.\r\n\r\nAgain I'm wrong: snapshot base block never makes it into background chainstate's `m_chain` because `LoadChainTip()` (when called from the init code in `src/node/chainstate.cpp`) sets the background chainstate's tip to the correct IBD tip (on the basis of the coinscache `GetBestBlock()`), which is before the snapshot base block.",
      "created_at": "2023-09-11T17:26:00Z",
      "updated_at": "2023-09-11T17:26:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321858810",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321858810"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321872262",
      "pull_request_review_id": 1620509865,
      "id": 1321872262,
      "node_id": "PRRC_kwDOABII585OyiuG",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks, I missed that HaveTxsDownloaded was checking `nChainTx` not `nTx`.\r\n\r\nI guess the main thing I'm confused about now is why this `pindex == GetSnapshotBaseBlock() ||` special case is needed at all? If `LoadChainTip()` already sets the snapshot block to be the snapshot tip, why does the snapshot block need to be added to the candidate set?",
      "created_at": "2023-09-11T17:40:35Z",
      "updated_at": "2023-09-11T17:40:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321872262",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321872262"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321885192",
      "pull_request_review_id": 1620530072,
      "id": 1321885192,
      "node_id": "PRRC_kwDOABII585Oyl4I",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> I guess the main thing I'm confused about now is why this pindex == GetSnapshotBaseBlock() || special case is needed at all? If LoadChainTip() already sets the snapshot block to be the snapshot tip, why does the snapshot block need to be added to the candidate set?\r\n\r\nI'm not sure if there's a more fundamental reason, but various assertions fail if this case is stripped out of LoadBlockIndex(); e.g. the `!setBlockIndexCandidates.empty()` assertion fails during `PruneBlockIndexCandidates()` if this special case is not included.\r\n\r\nThe true purpose of setBlockIndexCandidates has always been somewhat mysterious to me, but the most essential use seems to be in FindMostWorkChain(), to supply candidates for activation in `ActivateBestChain()`.",
      "created_at": "2023-09-11T17:54:20Z",
      "updated_at": "2023-09-11T17:54:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321885192",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321885192"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321887435",
      "pull_request_review_id": 1620533510,
      "id": 1321887435,
      "node_id": "PRRC_kwDOABII585OymbL",
      "diff_hunk": "@@ -4432,62 +4432,19 @@ bool ChainstateManager::LoadBlockIndex()\n         std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n                   CBlockIndexHeightOnlyComparator());\n \n-        // Find start of assumed-valid region.\n-        int first_assumed_valid_height = std::numeric_limits<int>::max();\n-\n-        for (const CBlockIndex* block : vSortedByHeight) {\n-            if (block->IsAssumedValid()) {\n-                auto chainstates = GetAll();\n-\n-                // If we encounter an assumed-valid block index entry, ensure that we have\n-                // one chainstate that tolerates assumed-valid entries and another that does\n-                // not (i.e. the background validation chainstate), since assumed-valid\n-                // entries should always be pending validation by a fully-validated chainstate.\n-                auto any_chain = [&](auto fnc) { return std::any_of(chainstates.cbegin(), chainstates.cend(), fnc); };\n-                assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n-                assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n-\n-                first_assumed_valid_height = block->nHeight;\n-                LogPrintf(\"Saw first assumedvalid block at height %d (%s)\\n\",\n-                        first_assumed_valid_height, block->ToString());\n-                break;\n-            }\n-        }\n-\n         for (CBlockIndex* pindex : vSortedByHeight) {\n             if (m_interrupt) return false;\n-            if (pindex->IsAssumedValid() ||\n+            // If we have an assumeutxo-based chainstate, then the snapshot\n+            // block will be a candidate for the tip, but it may not be\n+            // VALID_TRANSACTIONS (eg if we haven't yet downloaded the block),\n+            // so we special-case the snapshot block as a potential candidate\n+            // here.\n+            if (pindex == GetSnapshotBaseBlock() ||",
      "path": "src/validation.cpp",
      "position": 267,
      "original_position": 34,
      "commit_id": "a733dd79e29068ad1e0532ac42a45188a040a7b9",
      "original_commit_id": "768690b7ce551cd403f8e2a099372915f6022ad4",
      "in_reply_to_id": 1320915269,
      "user": {
        "login": "jamesob",
        "id": 73197,
        "node_id": "MDQ6VXNlcjczMTk3",
        "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jamesob",
        "html_url": "https://github.com/jamesob",
        "followers_url": "https://api.github.com/users/jamesob/followers",
        "following_url": "https://api.github.com/users/jamesob/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jamesob/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jamesob/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
        "organizations_url": "https://api.github.com/users/jamesob/orgs",
        "repos_url": "https://api.github.com/users/jamesob/repos",
        "events_url": "https://api.github.com/users/jamesob/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jamesob/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I've added some documentation for `HaveTxsDownloaded()` (https://github.com/bitcoin/bitcoin/pull/27596/commits/9f9ffb655e4236f8d567b961102f53c5933e8aa8), and I'm happy to add more for the confusing process discussed above.",
      "created_at": "2023-09-11T17:56:32Z",
      "updated_at": "2023-09-11T17:56:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1321887435",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1321887435"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 4450,
      "original_line": 4442,
      "side": "RIGHT"
    }
  ]
}