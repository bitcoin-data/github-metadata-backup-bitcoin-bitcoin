{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421",
    "id": 2837615883,
    "node_id": "PR_kwDOABII586pIpUL",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/33421",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/33421.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/33421.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
    "number": 33421,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "node: add `BlockTemplateCache`",
    "user": {
      "login": "ismaelsadeeq",
      "id": 48946461,
      "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
      "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ismaelsadeeq",
      "html_url": "https://github.com/ismaelsadeeq",
      "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
      "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
      "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
      "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
      "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "This PR implements the first step of #33389.\r\n\r\nMain motivation and design rationale are discussed in #33389.\r\n\r\nIt introduces a `BlockTemplateCache` exposed via the node interfaces.\r\n\r\nBlock template requests from other node components should go through the cache. Each request specifies the **maximum age** of the template in seconds. If a cached template exists with matching configuration and is still fresh, it is returned; otherwise, a new template with the requested configuration is generated and added to the cache.\r\n\r\nThe `BlockTemplateCache` subscribes to the validation interface `BlockConnected` notification and clears the cache when a new block is connected, preventing stale templates from being served.\r\n\r\nThe cache has a configurable maximum size (default 10).\r\n\r\n---\r\nIf `test_block_validity` is true in the request block creation options and the found cached template has not been validated yet, it is checked and returned. This is the reason `GetBlockTemplate` also locks `cs_main`; otherwise, the method can run with only  locking `m_mutex` .\r\n\r\n`MakeBlockTemplateCache` returns a shared pointer so it can be registered with the validation interface using `RegisterSharedValidationInterface` hence not requiring explicit unregistration.\r\n\r\n",
    "labels": [],
    "created_at": "2025-09-17T18:47:09Z",
    "updated_at": "2025-10-29T16:21:10Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "3ad055e5a814cd819ed893b085384713916557ac",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "ismaelsadeeq:09-2025-minerman",
      "ref": "09-2025-minerman",
      "sha": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 577730599,
        "node_id": "R_kgDOIm94Jw",
        "name": "bitcoin",
        "full_name": "ismaelsadeeq/bitcoin",
        "owner": {
          "login": "ismaelsadeeq",
          "id": 48946461,
          "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
          "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/ismaelsadeeq",
          "html_url": "https://github.com/ismaelsadeeq",
          "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
          "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
          "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
          "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
          "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/ismaelsadeeq/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/ismaelsadeeq/bitcoin",
        "archive_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/events",
        "forks_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/ismaelsadeeq/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:ismaelsadeeq/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/ismaelsadeeq/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/hooks",
        "svn_url": "https://github.com/ismaelsadeeq/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 0,
        "watchers_count": 0,
        "size": 289269,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-10-29T16:59:59Z",
        "created_at": "2022-12-13T11:54:34Z",
        "updated_at": "2023-03-10T09:46:26Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "f54ffb4bc141ffcc6fffe574edbcbbb21f001476",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38127,
        "stargazers_count": 86501,
        "watchers_count": 86501,
        "size": 295471,
        "default_branch": "master",
        "open_issues_count": 730,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-10-29T16:53:46Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-10-29T16:53:55Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 307,
    "deletions": 16,
    "changed_files": 10,
    "commits": 3,
    "review_comments": 19,
    "comments": 4
  },
  "events": [
    {
      "event": "renamed",
      "id": 19757369361,
      "node_id": "RTE_lADOABII587MSilzzwAAAASZoYgR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19757369361",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T18:47:12Z",
      "rename": {
        "from": "node: add `BlockTemplateCache` ",
        "to": "node: add `BlockTemplateCache`"
      }
    },
    {
      "event": "commented",
      "id": 3304174608,
      "node_id": "IC_kwDOABII587E8bQQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3304174608",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T18:47:14Z",
      "updated_at": "2025-10-29T16:21:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33421.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/33421#pullrequestreview-3268268351) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33676](https://github.com/bitcoin/bitcoin/pull/33676) (interfaces: enable cancelling running `waitNext` calls by ismaelsadeeq)\n* [#33629](https://github.com/bitcoin/bitcoin/pull/33629) (Cluster mempool by sdaftuar)\n* [#33591](https://github.com/bitcoin/bitcoin/pull/33591) (Cluster mempool followups by sdaftuar)\n* [#31382](https://github.com/bitcoin/bitcoin/pull/31382) (kernel: Flush in ChainstateManager destructor by TheCharlatan)\n* [#30214](https://github.com/bitcoin/bitcoin/pull/30214) (refactor: Improve assumeutxo state representation by ryanofsky)\n* [#29700](https://github.com/bitcoin/bitcoin/pull/29700) (kernel, refactor: return error status on all fatal errors by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#issuecomment-3304174608",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19757403800,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAASZog6Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19757403800",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "9682ea7dddf0715021b549f2c19c650ce1111b11",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/9682ea7dddf0715021b549f2c19c650ce1111b11",
      "created_at": "2025-09-17T18:48:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19757416817,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAASZokFx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19757416817",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "dca8200c71bb568ffe4821c68209e07a305db80d",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/dca8200c71bb568ffe4821c68209e07a305db80d",
      "created_at": "2025-09-17T18:49:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19868476470,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAASgQOQ2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19868476470",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "16d55585aa2d26e9177734927b8446faa72570e7",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/16d55585aa2d26e9177734927b8446faa72570e7",
      "created_at": "2025-09-23T14:46:52Z"
    },
    {
      "event": "commented",
      "id": 3324812123,
      "node_id": "IC_kwDOABII587GLJtb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3324812123",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-23T16:45:54Z",
      "updated_at": "2025-09-23T16:45:54Z",
      "author_association": "MEMBER",
      "body": "Forced pushed from dca8200c71bb568ffe4821c68209e07a305db80d to 16d55585aa2d26e9177734927b8446faa72570e7 [5db80d..16d5558](https://github.com/bitcoin/bitcoin/compare/dca8200c71bb568ffe4821c68209e07a305db80d..16d55585aa2d26e9177734927b8446faa72570e7)\r\n\r\nMain Changes are\r\n1. Moved the `BlockTemplateCache` to `src/node/miner.cpp` to fix the circular dependency issue\r\n2. The response now return the block template creation time\r\n3. We search for match from right to left to return the fresh hit first\r\n4. Added a fuzz test that test various cache condition and add more coverage to the BlockAssembler Code.",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#issuecomment-3324812123",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421"
    },
    {
      "event": "commented",
      "id": 3324859282,
      "node_id": "IC_kwDOABII587GLVOS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3324859282",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-23T17:01:06Z",
      "updated_at": "2025-09-23T17:05:03Z",
      "author_association": "MEMBER",
      "body": "It seems the new fuzz test in [16d5558](https://github.com/bitcoin/bitcoin/pull/33421/commits/16d55585aa2d26e9177734927b8446faa72570e7)\r\ncaught a minor UndefinedBehaviorSanitizer: unsigned-integer-overflow  issue on master.\r\n\r\n\r\n```\r\n/home/admin/actions-runner/_work/_temp/src/node/miner.cpp:414:47: runtime error: unsigned integer overflow: 2000 - 4000 cannot be represented in type 'size_t' (aka 'unsigned long')\r\n    #0 0x5b2b2753aee0 in node::BlockAssembler::addPackageTxs(int&, int&) /home/admin/actions-runner/_work/_temp/build/src/./node/miner.cpp:414:47\r\n\r\n\r\nSUMMARY: UndefinedBehaviorSanitizer: unsigned-integer-overflow /home/admin/actions-runner/_work/_temp/src/node/miner.cpp:414:47 \r\nMS: 5 PersAutoDict-PersAutoDict-EraseBytes-CopyPart-InsertRepeatedBytes- DE: \"\\000\\000\\000\\000\"-\"\\001\\000\\000\\000\\000\\000\\000\\000\"-; base unit: 05fe405753166f125559e7c9ac558654f107c7e9\r\n0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x27,0x27,0x27,0x27,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,\r\n\\001\\000\\000\\000\\000\\000\\000\\000''''\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\\000\r\nartifact_prefix='./'; Test unit written to ./crash-52e81f820b02d40ce3132a4d8e27726deb8eb132\r\nBase64: AQAAAAAAAAAnJycnAAAAAAAAAAAAAAAAAA==\r\n```\r\n\r\nhttps://github.com/bitcoin/bitcoin/actions/runs/17949962995/job/51047356983?pr=33421\r\n\r\nThis is possible on master when node is started with `-blockmaxweight=2000` , `-blockreservedweight=2000` or just `blockmaxweight=2000`  and mining interface `createNewBlock` pass blockReservedWeight as `2000`.\r\n\r\nThis undefined behaviour is possible after #32355 because it introduced a fixed `BLOCK_FULL_ENOUGH_WEIGHT_DELTA` with value `4000`.\r\nBefore #32355 the delta was tied to the `options.blockreservedweight` so will just be `2000 - 2000` which will result in a valid `size_t` value.\r\n\r\nI'll push a commit with a fix soon.\r\n ",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#issuecomment-3324859282",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19894590336,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAAShz1uA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19894590336",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "2dffe160fb056742346c756d40018e0b2402294e",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/2dffe160fb056742346c756d40018e0b2402294e",
      "created_at": "2025-09-24T14:33:08Z"
    },
    {
      "event": "labeled",
      "id": 19898348337,
      "node_id": "LE_lADOABII587MSilzzwAAAASiCLMx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898348337",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:39:29Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "labeled",
      "id": 19898348349,
      "node_id": "LE_lADOABII587MSilzzwAAAASiCLM9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898348349",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:39:29Z",
      "label": {
        "name": "Needs backport (29.x)",
        "color": "dd7200"
      }
    },
    {
      "event": "labeled",
      "id": 19898348355,
      "node_id": "LE_lADOABII587MSilzzwAAAASiCLND",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898348355",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:39:29Z",
      "label": {
        "name": "Needs backport (30.x)",
        "color": "dd7200"
      }
    },
    {
      "event": "unlabeled",
      "id": 19898637647,
      "node_id": "UNLE_lADOABII587MSilzzwAAAASiDR1P",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898637647",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:54:29Z",
      "label": {
        "name": "Bug",
        "color": "FBBAAB"
      }
    },
    {
      "event": "unlabeled",
      "id": 19898637657,
      "node_id": "UNLE_lADOABII587MSilzzwAAAASiDR1Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898637657",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:54:29Z",
      "label": {
        "name": "Needs backport (29.x)",
        "color": "dd7200"
      }
    },
    {
      "event": "unlabeled",
      "id": 19898637666,
      "node_id": "UNLE_lADOABII587MSilzzwAAAASiDR1i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19898637666",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:54:29Z",
      "label": {
        "name": "Needs backport (30.x)",
        "color": "dd7200"
      }
    },
    {
      "event": "commented",
      "id": 3330050997,
      "node_id": "IC_kwDOABII587GfIu1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3330050997",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T17:55:33Z",
      "updated_at": "2025-09-24T17:55:33Z",
      "author_association": "MEMBER",
      "body": "> It seems the new fuzz test in [16d5558](https://github.com/bitcoin/bitcoin/pull/33421/commits/16d55585aa2d26e9177734927b8446faa72570e7)\r\ncaught a minor UndefinedBehaviorSanitizer: unsigned-integer-overflow issue on master.\r\n\r\nNice! Sorry for the labeling noise, I meant to label #33475",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#issuecomment-3330050997",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33421"
    },
    {
      "event": "referenced",
      "id": 19918132563,
      "node_id": "REFE_lADOABII587MSilzzwAAAASjNpVT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19918132563",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "05d984b1a4fb6402d93a436203e986cde60fd99f",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05d984b1a4fb6402d93a436203e986cde60fd99f",
      "created_at": "2025-09-25T12:18:24Z"
    },
    {
      "event": "labeled",
      "id": 19920540404,
      "node_id": "LE_lADOABII587MSilzzwAAAASjW1L0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19920540404",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-25T13:51:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19924504544,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAASjl8_g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19924504544",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "ed482dedb510e7b05ae267b7f3c8aa599540a211",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/ed482dedb510e7b05ae267b7f3c8aa599540a211",
      "created_at": "2025-09-25T16:33:21Z"
    },
    {
      "event": "unlabeled",
      "id": 19926582453,
      "node_id": "UNLE_lADOABII587MSilzzwAAAASjt4S1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19926582453",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-25T18:25:54Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 20450223272,
      "node_id": "LE_lADOABII587MSilzzwAAAATC7aSo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20450223272",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-23T10:04:47Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20451840060,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAATDBlA8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20451840060",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "0480018a63723b51d445db18da2f59ee9be55313",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/0480018a63723b51d445db18da2f59ee9be55313",
      "created_at": "2025-10-23T11:28:57Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGJkOWJlZDQ2MmUyNTFhNWQzYmQ2ZTM3NmYyNTA2MGFlYmE5NTM5ZDQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bd9bed462e251a5d3bd6e376f25060aeba9539d4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bd9bed462e251a5d3bd6e376f25060aeba9539d4",
      "tree": {
        "sha": "914c6bcda67dc256555f47aa97f8b56fe9de17fb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/914c6bcda67dc256555f47aa97f8b56fe9de17fb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f54ffb4bc141ffcc6fffe574edbcbbb21f001476",
          "sha": "f54ffb4bc141ffcc6fffe574edbcbbb21f001476",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f54ffb4bc141ffcc6fffe574edbcbbb21f001476"
        }
      ],
      "message": "node/miner: allow generation of oversized templates\n\nConstructing a BlockAssembler with ALLOW_OVERSIZED_BLOCKS allows oversized blocks.",
      "committer": {
        "name": "ismaelsadeeq",
        "email": "abubakarsadiqismail@proton.me",
        "date": "2025-10-27T09:13:07Z"
      },
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2025-08-21T00:47:59Z"
      },
      "sha": "bd9bed462e251a5d3bd6e376f25060aeba9539d4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDRkZTc4ODdjYTQ3MTk3NjU0ZjQ4MDQ3MWRiMDQ3NTBkNDRlNDA1ZGU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4de7887ca47197654f480471db04750d44e405de",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4de7887ca47197654f480471db04750d44e405de",
      "tree": {
        "sha": "7c9fc63a672fe06679396dbe39a9721a7f2ecbe1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7c9fc63a672fe06679396dbe39a9721a7f2ecbe1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bd9bed462e251a5d3bd6e376f25060aeba9539d4",
          "sha": "bd9bed462e251a5d3bd6e376f25060aeba9539d4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bd9bed462e251a5d3bd6e376f25060aeba9539d4"
        }
      ],
      "message": "node: add block template cache to miner",
      "committer": {
        "name": "ismaelsadeeq",
        "email": "abubakarsadiqismail@proton.me",
        "date": "2025-10-27T09:31:36Z"
      },
      "author": {
        "name": "ismaelsadeeq",
        "email": "abubakarsadiqismail@proton.me",
        "date": "2025-09-17T16:21:50Z"
      },
      "sha": "4de7887ca47197654f480471db04750d44e405de"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDVmNzk4YjRhM2IxYTk3OGI4YWM5NTRkYjU0ZTllOGRmYzdkYTYzMTk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "tree": {
        "sha": "03020084a7ace9358ed319155c641273904a31fb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/03020084a7ace9358ed319155c641273904a31fb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4de7887ca47197654f480471db04750d44e405de",
          "sha": "4de7887ca47197654f480471db04750d44e405de",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4de7887ca47197654f480471db04750d44e405de"
        }
      ],
      "message": "test: add blocktemplatecache fuzz test",
      "committer": {
        "name": "ismaelsadeeq",
        "email": "abubakarsadiqismail@proton.me",
        "date": "2025-10-27T09:31:39Z"
      },
      "author": {
        "name": "ismaelsadeeq",
        "email": "abubakarsadiqismail@proton.me",
        "date": "2025-09-23T12:53:55Z"
      },
      "sha": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20520075418,
      "node_id": "HRFPE_lADOABII587MSilzzwAAAATHF4Ca",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20520075418",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "commit_url": "https://api.github.com/repos/ismaelsadeeq/bitcoin/commits/5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "created_at": "2025-10-27T09:33:11Z"
    },
    {
      "event": "unlabeled",
      "id": 20521286142,
      "node_id": "UNLE_lADOABII587MSilzzwAAAATHKfn-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20521286142",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T10:23:34Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 3268268351,
      "node_id": "PRR_kwDOABII587CzdE_",
      "url": null,
      "actor": null,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-10-29T16:21:06Z",
      "author_association": "CONTRIBUTOR",
      "body": "Code review ACK 5f798b4a3b1a978b8ac954db54e9e8dfc7da6319, though I didn't look closely at the fuzz test. Sorry for the delay in reviewing this, I've been meaning to get to it for some time. I think all the changes seem good and look correct, but I did suggest a number of possible updates below, mostly simplifications that should make the PR smaller.\n\nI do think while the code changes seem good, it would be good to have more clarity about the cases where cache hits are expected and this cache is most likely to be useful. This seems like something that could be mentioned in the BlockTemplateCache documentation. I know the issue #33389 mentioned a number of cases but it's unclear if these would be helped by the caching implemented here or if more changes like sharing templates with different options would be required.\n\nIf you have more changes building on this, or planned changes, it would be helpful to have a pointer or description. I don't know if #31664 would benefit from the caching implemented here, for example.\n\nI tend to think even if this PR is only used to improve `getblocktemplate` and remove global state [[1]](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L776), [[2]](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/rpc/mining.cpp#L859-L861), [[3]](https://github.com/bitcoin/bitcoin/blob/292ea0eb8982faef460c210bd4215d603f487463/src/node/miner.h#L186-L189), the changes might be worth it but I'm not sure if you implemented or are planning that.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#pullrequestreview-3268268351",
      "submitted_at": "2025-10-29T16:21:06Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2379497293",
      "pull_request_review_id": 3268268351,
      "id": 2379497293,
      "node_id": "PRRC_kwDOABII586N1D9N",
      "diff_hunk": "@@ -93,6 +93,14 @@ BlockAssembler::BlockAssembler(Chainstate& chainstate, const CTxMemPool* mempool\n {\n }\n \n+BlockAssembler::BlockAssembler(Chainstate& chainstate, const CTxMemPool* mempool, const Options& options, AllowOversizedBlocks_tag)",
      "path": "src/node/miner.cpp",
      "position": 30,
      "original_position": 4,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "9ad0c9cc15e2132b0b1c9eb1734060448ccac67f",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node/miner: allow generation of oversized templates\" (bd9bed462e251a5d3bd6e376f25060aeba9539d4)\r\n\r\nThis ALLOW_OVERSIZED_BLOCKS tag approach seems reasonable, but not ideal because:\r\n\r\n- It doesn't only allow larger blocks. It also stops enforcing coinbase sigops limits and stops enforcing minimum clamp values.\r\n- It duplicates code between `BlockAssembler::BlockAssembler` constructors.\r\n\r\nI think adding a new `BlockAssembler::Options` `bool allow_oversized_blocks{false}` option instead would be a more direct and extensible approach.\r\n\r\nSeparately (doesn't need to be part of this PR) I also think it would be good to reverse 7392b8b084be14b75536887b7ff216152d0a3307 (#33222), and throw exceptions when values are out of range instead of clamping them. Clamping values seems likely to hide configuration errors that should be fixed and lead to unintended behavior.",
      "created_at": "2025-09-25T15:09:40Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2379497293",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2379497293"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 102,
      "original_line": 102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2472926339",
      "pull_request_review_id": 3268268351,
      "id": 2472926339,
      "node_id": "PRRC_kwDOABII586TZdyD",
      "diff_hunk": "@@ -1825,6 +1826,9 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     ChainstateManager& chainman = *Assert(node.chainman);\n     auto& kernel_notifications{*Assert(node.notifications)};\n \n+    node.block_template_cache = node::MakeBlockTemplateCache(node.mempool.get(), chainman);\n+    validation_signals.RegisterSharedValidationInterface(node.block_template_cache);",
      "path": "src/init.cpp",
      "position": 13,
      "original_position": 13,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nNot very important, but would be good to call UnregisterValidationInterface in Shutdown to unregister this. Otherwise, in theory if Init/Shutdown were called multiple times (e.g. in unit tests) there would be a memory leak. `node.block_template_cache` can be handled the same way as `node.fee_estimator` in `Shutdown`.",
      "created_at": "2025-10-29T12:59:05Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2472926339",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2472926339"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1830,
      "original_line": 1830,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2472932269",
      "pull_request_review_id": 3268268351,
      "id": 2472932269,
      "node_id": "PRRC_kwDOABII586TZfOt",
      "diff_hunk": "@@ -70,6 +71,7 @@ struct NodeContext {\n     std::unique_ptr<CBlockPolicyEstimator> fee_estimator;\n     std::unique_ptr<PeerManager> peerman;\n     std::unique_ptr<ChainstateManager> chainman;\n+    std::shared_ptr<BlockTemplateCache> block_template_cache;",
      "path": "src/node/context.h",
      "position": 12,
      "original_position": 12,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nI think it would probably be better for this to use unique_ptr instead shared_ptr (like fee_estimator and other members), so lifetime of the BlockTemplateCache is more explicit and predictable.",
      "created_at": "2025-10-29T13:01:06Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2472932269",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2472932269"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 74,
      "original_line": 74,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473041954",
      "pull_request_review_id": 3268268351,
      "id": 2473041954,
      "node_id": "PRRC_kwDOABII586TZ6Ai",
      "diff_hunk": "@@ -225,6 +231,49 @@ class BlockAssembler\n     void SortForBlock(const CTxMemPool::setEntries& package, std::vector<CTxMemPool::txiter>& sortedEntries);\n };\n \n+/**\n+ * BlockTemplateCache provides a thread-safe interface for creating and reusing\n+ * block templates with configurable cache size.\n+ *\n+ * The cache stores templates with their respective config options.\n+ * When a block template is requested:\n+ * - If a template with matching options exists and the interval\n+ *   has not elapsed, the cached template is returned.\n+ * - If no template exists or the interval has elapsed, a new template is generated,\n+ *   stored in the cache, and returned.\n+ * - After insertion, we evict the oldest template if the cache overflows.\n+ *\n+ * The cache inherits from CValidationInterface to receive notifications\n+ * about connected blocks, which triggers cache invalidation,\n+ * ensuring stale templates are not returned.\n+ */\n+class BlockTemplateCache : public CValidationInterface\n+{\n+public:\n+    virtual ~BlockTemplateCache() = default;\n+\n+    /**\n+     * If a cached template exists with identical options and its age does not\n+     * exceed the specified interval, the cached template is returned.\n+     * Otherwise, a new template is created and stored in the cache.\n+     *\n+     * @param options The block assembly options to use.\n+     * @param interval Maximum age of a cached template to be considered fresh.\n+     * @return std::shared_ptr<CBlockTemplate> Shared pointer to the block template.\n+     */\n+    virtual std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(",
      "path": "src/node/miner.h",
      "position": 84,
      "original_position": 65,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nIt seems like there are a number of things here making this code more rigid and complicated than it needs to be which aren't explained. It seems like it would be more straightforward to:\r\n\r\n- Make `BlockTemplateCache::GetBlockTemplate` method non-virtual\r\n- Drop `MakeBlockTemplateCache` function, and just give `GetBlockTemplate` class a constructor.\r\n- Drop `BlockTemplateCacheImpl` class and just implement functionality in `BlockTemplateCache` class.\r\n- Drop requirement that users of `BlockTemplateCache` need to deal with `shared_ptr`. Let them use cache objects with more predictable lifetimes.\r\n\r\nI think these changes would make code simpler, PR more straightforward to review and the `BlockTemplateCache` class easier to use and test.\r\n\r\nIf there really is a need for the shared_ptr / virtual requirements, that would be also be ok, but they should be explained somewhere.\r\n\r\n---\r\n\r\nEDIT: I see PR description does provide a rationale: \"`MakeBlockTemplateCache` returns a shared pointer so it can be registered with the validation interface using `RegisterSharedValidationInterface` hence not requiring explicit unregistration.\"\r\n\r\nI think this rationale doesn't really hold though, because unregistration is still needed to prevent memory leaks. Also `RegisterSharedValidationInterface` was really intended for use by the wallet, because wallets can be unloaded at any time and need a way to unregister from events while events are still being sent and avoid race conditions. For the block template cache, it makes more sense to use `RegisterValidationInterface` instead and avoid `shared_ptr` virality and unpredictability.",
      "created_at": "2025-10-29T13:25:44Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473041954",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473041954"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 264,
      "original_line": 264,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473203366",
      "pull_request_review_id": 3268268351,
      "id": 2473203366,
      "node_id": "PRRC_kwDOABII586Taham",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;\n+    size_t m_cache_size;\n+    mutable Mutex m_mutex;\n+};\n+\n+BlockTemplateCacheImpl::BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+    : m_mempool(mempool), m_chainman(chainman), m_cache_size(cache_size) {}\n+\n+std::shared_ptr<BlockTemplateCache> MakeBlockTemplateCache(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+{\n+    return std::make_shared<BlockTemplateCacheImpl>(mempool, chainman, cache_size);\n+}\n+\n+void BlockTemplateCacheImpl::BlockConnected(\n+    ChainstateRole /*unused*/,\n+    const std::shared_ptr<const CBlock>& /*unused*/,\n+    const CBlockIndex* /*unused*/)\n+{\n+    LOCK(m_mutex);\n+    m_block_templates.clear();\n+}\n+\n+bool BlockTemplateCacheImpl::Template::IntervalElapsed(const std::chrono::seconds& interval) const\n+{\n+    auto now = NodeClock::now();\n+    auto elapsed = std::chrono::duration_cast<std::chrono::seconds>(now - m_time_generated);\n+    if (elapsed < std::chrono::seconds::zero()) {\n+        // m_time_generated is in the future; node clock is bumped to the past\n+        // hence no way to check the elapsed time just assume interval elapsed.\n+        return true;\n+    }\n+    return elapsed >= interval;\n+}\n+\n+bool BlockTemplateCacheImpl::Template::OptionsEqual(const BlockAssembler::Options& other) const\n+{\n+    return m_options.use_mempool == other.use_mempool &&",
      "path": "src/node/miner.cpp",
      "position": 105,
      "original_position": 90,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nWould be good to have a comment saying this is intentionally not comparing the `coinbase_output_script` field and why that is safe (assuming it is safe).\r\n\r\nAlso would be good to point out this is intentionally skipping `test_block_validity`.",
      "created_at": "2025-10-29T13:51:22Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473203366",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473203366"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 517,
      "original_line": 517,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473223014",
      "pull_request_review_id": 3268268351,
      "id": 2473223014,
      "node_id": "PRRC_kwDOABII586TamNm",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;\n+    size_t m_cache_size;\n+    mutable Mutex m_mutex;\n+};\n+\n+BlockTemplateCacheImpl::BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+    : m_mempool(mempool), m_chainman(chainman), m_cache_size(cache_size) {}\n+\n+std::shared_ptr<BlockTemplateCache> MakeBlockTemplateCache(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+{\n+    return std::make_shared<BlockTemplateCacheImpl>(mempool, chainman, cache_size);\n+}\n+\n+void BlockTemplateCacheImpl::BlockConnected(\n+    ChainstateRole /*unused*/,\n+    const std::shared_ptr<const CBlock>& /*unused*/,\n+    const CBlockIndex* /*unused*/)\n+{\n+    LOCK(m_mutex);\n+    m_block_templates.clear();\n+}\n+\n+bool BlockTemplateCacheImpl::Template::IntervalElapsed(const std::chrono::seconds& interval) const\n+{\n+    auto now = NodeClock::now();\n+    auto elapsed = std::chrono::duration_cast<std::chrono::seconds>(now - m_time_generated);\n+    if (elapsed < std::chrono::seconds::zero()) {\n+        // m_time_generated is in the future; node clock is bumped to the past\n+        // hence no way to check the elapsed time just assume interval elapsed.\n+        return true;\n+    }\n+    return elapsed >= interval;\n+}\n+\n+bool BlockTemplateCacheImpl::Template::OptionsEqual(const BlockAssembler::Options& other) const",
      "path": "src/node/miner.cpp",
      "position": 103,
      "original_position": 88,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nWould seem nice to implement these comparisons in `operator==` helpers or other functions directly attached to BlockCreateOptions and `BlockAssembler::Options` structs. This way if new members are added to the structs, the comparison functions should not get out of date.\r\n\r\nOtherwise it would be good to have comments in the two structs pointing out that this function may need to be updated if new fields are added.\r\n\r\nI think it could also be nice to introduce options-comparing functionality in a separate commit to make this commit simpler.\r\n\r\n\r\n",
      "created_at": "2025-10-29T13:54:23Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473223014",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473223014"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 515,
      "original_line": 515,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473250518",
      "pull_request_review_id": 3268268351,
      "id": 2473250518,
      "node_id": "PRRC_kwDOABII586Tas7W",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {",
      "path": "src/node/miner.cpp",
      "position": 58,
      "original_position": 43,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\n`Template` name doesn't seem very descriptive. I'd consider calling it `CachedBlockTemplate` to be unambiguous, and also making it a top level struct instead of an inner struct so it is less entwined with the `BlockTemplateCacheImpl` class, and could be forward declared, accessed from tests, etc.",
      "created_at": "2025-10-29T13:57:51Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473250518",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473250518"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 470,
      "original_line": 470,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473275740",
      "pull_request_review_id": 3268268351,
      "id": 2473275740,
      "node_id": "PRRC_kwDOABII586TazFc",
      "diff_hunk": "@@ -24,6 +27,7 @@\n #include <boost/multi_index_container.hpp>\n \n class ArgsManager;\n+class BlockTemplateCache;",
      "path": "src/node/miner.h",
      "position": 18,
      "original_position": 18,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nThis doesn't seem to be right because it is forward declaring a global `::BlockTemplateCache` class not in the `::node` namespace. Probably this should just be dropped.",
      "created_at": "2025-10-29T14:01:38Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473275740",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473275740"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 30,
      "original_line": 30,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473282308",
      "pull_request_review_id": 3268268351,
      "id": 2473282308,
      "node_id": "PRRC_kwDOABII586Ta0sE",
      "diff_hunk": "@@ -38,6 +42,8 @@ namespace node {\n class KernelNotifications;\n \n static const bool DEFAULT_PRINT_MODIFIED_FEE = false;\n+static constexpr size_t DEFAULT_CACHE_SIZE{10};",
      "path": "src/node/miner.h",
      "position": 26,
      "original_position": 26,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\n`DEFAULT_CACHE_SIZE` is a very generic name for a global, maybe `DEFAULT_BLOCK_TEMPLATE_CACHE_SIZE` would be better.",
      "created_at": "2025-10-29T14:02:51Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473282308",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473282308"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 45,
      "original_line": 45,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473298969",
      "pull_request_review_id": 3268268351,
      "id": 2473298969,
      "node_id": "PRRC_kwDOABII586Ta4wZ",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;\n+    size_t m_cache_size;\n+    mutable Mutex m_mutex;\n+};\n+\n+BlockTemplateCacheImpl::BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+    : m_mempool(mempool), m_chainman(chainman), m_cache_size(cache_size) {}\n+\n+std::shared_ptr<BlockTemplateCache> MakeBlockTemplateCache(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+{\n+    return std::make_shared<BlockTemplateCacheImpl>(mempool, chainman, cache_size);\n+}\n+\n+void BlockTemplateCacheImpl::BlockConnected(\n+    ChainstateRole /*unused*/,\n+    const std::shared_ptr<const CBlock>& /*unused*/,\n+    const CBlockIndex* /*unused*/)\n+{\n+    LOCK(m_mutex);\n+    m_block_templates.clear();",
      "path": "src/node/miner.cpp",
      "position": 88,
      "original_position": 73,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nI'd think cache should be cleared when blocks are disconnected as well as when they are connected. Should there be a `BlockDisconnected` method that also clears the cache?\r\n\r\nAlso this should probably have `if (role == ChainstateRole::BACKGROUND) return;` to work properly when an assumeutxo snapshot is loaded.",
      "created_at": "2025-10-29T14:05:42Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473298969",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473298969"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 500,
      "original_line": 500,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473412280",
      "pull_request_review_id": 3268268351,
      "id": 2473412280,
      "node_id": "PRRC_kwDOABII586TbUa4",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;\n+    size_t m_cache_size;\n+    mutable Mutex m_mutex;\n+};\n+\n+BlockTemplateCacheImpl::BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+    : m_mempool(mempool), m_chainman(chainman), m_cache_size(cache_size) {}\n+\n+std::shared_ptr<BlockTemplateCache> MakeBlockTemplateCache(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+{\n+    return std::make_shared<BlockTemplateCacheImpl>(mempool, chainman, cache_size);\n+}\n+\n+void BlockTemplateCacheImpl::BlockConnected(\n+    ChainstateRole /*unused*/,\n+    const std::shared_ptr<const CBlock>& /*unused*/,\n+    const CBlockIndex* /*unused*/)\n+{\n+    LOCK(m_mutex);\n+    m_block_templates.clear();\n+}\n+\n+bool BlockTemplateCacheImpl::Template::IntervalElapsed(const std::chrono::seconds& interval) const",
      "path": "src/node/miner.cpp",
      "position": 91,
      "original_position": 76,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nNothing about this function is really specific to caching templates. I think the both the caching code and the time code could be easier to understand if this was made into a helper function like:\r\n\r\n```c++\r\n// Return true if current time is greater or equal to `time + interval`, or if\r\n// `time` is greater than the current time (indicating clock moved backward).\r\nstatic inline bool IntervalElapsed(NodeClock::time_point time, std::chrono::seconds interval)\r\n{\r\n    const NodeClock::time_point now = NodeClock::now();\r\n    return now < time || (now - time) >= interval;\r\n}\r\n```",
      "created_at": "2025-10-29T14:22:21Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473412280",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473412280"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 503,
      "original_line": 503,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473491581",
      "pull_request_review_id": 3268268351,
      "id": 2473491581,
      "node_id": "PRRC_kwDOABII586Tbnx9",
      "diff_hunk": "@@ -225,6 +231,49 @@ class BlockAssembler\n     void SortForBlock(const CTxMemPool::setEntries& package, std::vector<CTxMemPool::txiter>& sortedEntries);\n };\n \n+/**\n+ * BlockTemplateCache provides a thread-safe interface for creating and reusing\n+ * block templates with configurable cache size.\n+ *\n+ * The cache stores templates with their respective config options.\n+ * When a block template is requested:\n+ * - If a template with matching options exists and the interval\n+ *   has not elapsed, the cached template is returned.\n+ * - If no template exists or the interval has elapsed, a new template is generated,\n+ *   stored in the cache, and returned.\n+ * - After insertion, we evict the oldest template if the cache overflows.\n+ *\n+ * The cache inherits from CValidationInterface to receive notifications\n+ * about connected blocks, which triggers cache invalidation,\n+ * ensuring stale templates are not returned.\n+ */\n+class BlockTemplateCache : public CValidationInterface\n+{\n+public:\n+    virtual ~BlockTemplateCache() = default;\n+\n+    /**\n+     * If a cached template exists with identical options and its age does not\n+     * exceed the specified interval, the cached template is returned.\n+     * Otherwise, a new template is created and stored in the cache.",
      "path": "src/node/miner.h",
      "position": 78,
      "original_position": 59,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nMight be good to say if that if interval is 0 a new template is always created.",
      "created_at": "2025-10-29T14:35:01Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473491581",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473491581"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 258,
      "original_line": 258,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473499003",
      "pull_request_review_id": 3268268351,
      "id": 2473499003,
      "node_id": "PRRC_kwDOABII586Tbpl7",
      "diff_hunk": "@@ -225,6 +231,49 @@ class BlockAssembler\n     void SortForBlock(const CTxMemPool::setEntries& package, std::vector<CTxMemPool::txiter>& sortedEntries);\n };\n \n+/**\n+ * BlockTemplateCache provides a thread-safe interface for creating and reusing\n+ * block templates with configurable cache size.\n+ *\n+ * The cache stores templates with their respective config options.\n+ * When a block template is requested:\n+ * - If a template with matching options exists and the interval\n+ *   has not elapsed, the cached template is returned.\n+ * - If no template exists or the interval has elapsed, a new template is generated,\n+ *   stored in the cache, and returned.\n+ * - After insertion, we evict the oldest template if the cache overflows.\n+ *\n+ * The cache inherits from CValidationInterface to receive notifications\n+ * about connected blocks, which triggers cache invalidation,\n+ * ensuring stale templates are not returned.\n+ */\n+class BlockTemplateCache : public CValidationInterface\n+{\n+public:\n+    virtual ~BlockTemplateCache() = default;\n+\n+    /**\n+     * If a cached template exists with identical options and its age does not\n+     * exceed the specified interval, the cached template is returned.",
      "path": "src/node/miner.h",
      "position": 77,
      "original_position": 58,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nI think s/does not exceed/is less than/",
      "created_at": "2025-10-29T14:36:13Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473499003",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473499003"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": 256,
      "original_start_line": 256,
      "start_side": "RIGHT",
      "line": 257,
      "original_line": 257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473636918",
      "pull_request_review_id": 3268268351,
      "id": 2473636918,
      "node_id": "PRRC_kwDOABII586TcLQ2",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;",
      "path": "src/node/miner.cpp",
      "position": 69,
      "original_position": 54,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nIt probably makes more sense for this to contain a `Chainstate` reference than a `ChainstateManager` reference, since code here is only calling `m_chainman.ActiveChainstate` on it anyway. Also logically, it makes more sense to have a per-chainstate cache, instead of a cache over multiple chainstates.",
      "created_at": "2025-10-29T14:59:26Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473636918",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473636918"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 481,
      "original_line": 481,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473664992",
      "pull_request_review_id": 3268268351,
      "id": 2473664992,
      "node_id": "PRRC_kwDOABII586TcSHg",
      "diff_hunk": "@@ -520,14 +623,9 @@ std::unique_ptr<CBlockTemplate> WaitAndCreateNewBlock(ChainstateManager& chainma\n          * We'll also create a new template if the tip changed during this iteration.\n          */\n         if (options.fee_threshold < MAX_MONEY || tip_changed) {\n-            auto new_tmpl{BlockAssembler{\n-                chainman.ActiveChainstate(),\n-                mempool,\n-                assemble_options}\n-                              .CreateNewBlock()};\n-\n+            auto new_tmpl{block_template_cache->GetBlockTemplate(assemble_options, std::chrono::seconds{0}).first};",
      "path": "src/node/miner.cpp",
      "position": 168,
      "original_position": 153,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nWould be good to note that `0` interval means this will always generate a new template, not use a cached one.\r\n\r\nIt could make sense to add a `max_age` or similar option to BlockCreateOptions so this is configurable by the caller.",
      "created_at": "2025-10-29T15:04:10Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473664992",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473664992"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 626,
      "original_line": 626,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473682869",
      "pull_request_review_id": 3268268351,
      "id": 2473682869,
      "node_id": "PRRC_kwDOABII586TcWe1",
      "diff_hunk": "@@ -520,14 +623,9 @@ std::unique_ptr<CBlockTemplate> WaitAndCreateNewBlock(ChainstateManager& chainma\n          * We'll also create a new template if the tip changed during this iteration.\n          */\n         if (options.fee_threshold < MAX_MONEY || tip_changed) {\n-            auto new_tmpl{BlockAssembler{\n-                chainman.ActiveChainstate(),\n-                mempool,\n-                assemble_options}\n-                              .CreateNewBlock()};\n-\n+            auto new_tmpl{block_template_cache->GetBlockTemplate(assemble_options, std::chrono::seconds{0}).first};\n             // If the tip changed, return the new template regardless of its fees.\n-            if (tip_changed) return new_tmpl;\n+            if (tip_changed) return std::make_unique<CBlockTemplate>(*new_tmpl);",
      "path": "src/node/miner.cpp",
      "position": 171,
      "original_position": 156,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nIs this temporary? Since `GetBlockTemplate` returns a `shared_ptr`, I think it would make sense for `WaitAndCreateNewBlock` to return a `shared_ptr` as well to avoid these copies.",
      "created_at": "2025-10-29T15:07:12Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473682869",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473682869"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 628,
      "original_line": 628,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473714111",
      "pull_request_review_id": 3268268351,
      "id": 2473714111,
      "node_id": "PRRC_kwDOABII586TceG_",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;",
      "path": "src/node/miner.cpp",
      "position": 61,
      "original_position": 46,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nI think this type should be `std::shared_ptr<const CBlockTemplate>` (adding const) here and other places to avoid outside callers mutating the template and potentially messing up the cache. Or if adding const isn't possible for some reason, it would be good to have a comment here explaining that.\r\n\r\nIt might also be handy to define a type alias like `using BlockTemplateRef = std::shared_ptr<const CBlockTemplate>` similar to `CTransactionRef`.\r\n\r\n",
      "created_at": "2025-10-29T15:12:11Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473714111",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473714111"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 473,
      "original_line": 473,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473809097",
      "pull_request_review_id": 3268268351,
      "id": 2473809097,
      "node_id": "PRRC_kwDOABII586Tc1TJ",
      "diff_hunk": "@@ -225,6 +231,49 @@ class BlockAssembler\n     void SortForBlock(const CTxMemPool::setEntries& package, std::vector<CTxMemPool::txiter>& sortedEntries);\n };\n \n+/**\n+ * BlockTemplateCache provides a thread-safe interface for creating and reusing\n+ * block templates with configurable cache size.\n+ *\n+ * The cache stores templates with their respective config options.\n+ * When a block template is requested:\n+ * - If a template with matching options exists and the interval\n+ *   has not elapsed, the cached template is returned.\n+ * - If no template exists or the interval has elapsed, a new template is generated,\n+ *   stored in the cache, and returned.\n+ * - After insertion, we evict the oldest template if the cache overflows.\n+ *\n+ * The cache inherits from CValidationInterface to receive notifications\n+ * about connected blocks, which triggers cache invalidation,\n+ * ensuring stale templates are not returned.\n+ */\n+class BlockTemplateCache : public CValidationInterface\n+{\n+public:\n+    virtual ~BlockTemplateCache() = default;\n+\n+    /**\n+     * If a cached template exists with identical options and its age does not\n+     * exceed the specified interval, the cached template is returned.\n+     * Otherwise, a new template is created and stored in the cache.\n+     *\n+     * @param options The block assembly options to use.\n+     * @param interval Maximum age of a cached template to be considered fresh.\n+     * @return std::shared_ptr<CBlockTemplate> Shared pointer to the block template.\n+     */\n+    virtual std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(\n+        const BlockAssembler::Options& options,\n+        std::chrono::seconds interval",
      "path": "src/node/miner.h",
      "position": 86,
      "original_position": 67,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nWould it make sense for this to use milliseconds or another unit instead of seconds so callers could have more granularity?\r\n\r\nAlso as suggested elsewhere I think it could make sense for interval to be a `BlockCreateOptions` field (called `max_age` or similar) so existing interfaces would not need to be modified to start taking advantage of template caching.",
      "created_at": "2025-10-29T15:27:55Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2473809097",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2473809097"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 266,
      "original_line": 266,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2474149528",
      "pull_request_review_id": 3268268351,
      "id": 2474149528,
      "node_id": "PRRC_kwDOABII586TeIaY",
      "diff_hunk": "@@ -449,6 +454,104 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n     }\n }\n \n+class BlockTemplateCacheImpl final: public BlockTemplateCache\n+{\n+public:\n+    BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size);\n+    std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+\n+    /** Overridden from CValidationInterface. */\n+    void BlockConnected(ChainstateRole /*unused*/, const std::shared_ptr<const CBlock>& /*unused*/, const CBlockIndex * /*unused*/)\n+        override EXCLUSIVE_LOCKS_REQUIRED(!m_mutex);\n+private:\n+     std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> CreateBlockTemplateInternal(const BlockAssembler::Options& options) EXCLUSIVE_LOCKS_REQUIRED(m_mutex);\n+\n+    struct Template {\n+        BlockAssembler::Options m_options;\n+        NodeClock::time_point m_time_generated;\n+        std::shared_ptr<CBlockTemplate> m_block_template;\n+\n+        bool IntervalElapsed(const std::chrono::seconds& interval) const;\n+        bool OptionsEqual(const BlockAssembler::Options& options) const;\n+    };\n+\n+    std::deque<Template> m_block_templates;\n+    CTxMemPool* m_mempool{nullptr};\n+    ChainstateManager& m_chainman;\n+    size_t m_cache_size;\n+    mutable Mutex m_mutex;\n+};\n+\n+BlockTemplateCacheImpl::BlockTemplateCacheImpl(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+    : m_mempool(mempool), m_chainman(chainman), m_cache_size(cache_size) {}\n+\n+std::shared_ptr<BlockTemplateCache> MakeBlockTemplateCache(CTxMemPool* mempool, ChainstateManager& chainman, size_t cache_size)\n+{\n+    return std::make_shared<BlockTemplateCacheImpl>(mempool, chainman, cache_size);\n+}\n+\n+void BlockTemplateCacheImpl::BlockConnected(\n+    ChainstateRole /*unused*/,\n+    const std::shared_ptr<const CBlock>& /*unused*/,\n+    const CBlockIndex* /*unused*/)\n+{\n+    LOCK(m_mutex);\n+    m_block_templates.clear();\n+}\n+\n+bool BlockTemplateCacheImpl::Template::IntervalElapsed(const std::chrono::seconds& interval) const\n+{\n+    auto now = NodeClock::now();\n+    auto elapsed = std::chrono::duration_cast<std::chrono::seconds>(now - m_time_generated);\n+    if (elapsed < std::chrono::seconds::zero()) {\n+        // m_time_generated is in the future; node clock is bumped to the past\n+        // hence no way to check the elapsed time just assume interval elapsed.\n+        return true;\n+    }\n+    return elapsed >= interval;\n+}\n+\n+bool BlockTemplateCacheImpl::Template::OptionsEqual(const BlockAssembler::Options& other) const\n+{\n+    return m_options.use_mempool == other.use_mempool &&\n+           m_options.block_reserved_weight == other.block_reserved_weight &&\n+           m_options.coinbase_output_max_additional_sigops == other.coinbase_output_max_additional_sigops &&\n+           m_options.nBlockMaxWeight == other.nBlockMaxWeight &&\n+           m_options.blockMinFeeRate == other.blockMinFeeRate;\n+}\n+\n+std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> BlockTemplateCacheImpl::CreateBlockTemplateInternal(const BlockAssembler::Options& options)\n+{\n+    BlockAssembler assembler{m_chainman.ActiveChainstate(), m_mempool, options, BlockAssembler::ALLOW_OVERSIZED_BLOCKS};\n+    Template t;\n+    t.m_block_template = assembler.CreateNewBlock();\n+    t.m_options = options;\n+    t.m_time_generated = NodeClock::now();\n+    Assume(m_block_templates.size() <= m_cache_size);\n+    m_block_templates.emplace_back(t);\n+    if (m_block_templates.size() > m_cache_size) m_block_templates.pop_front();\n+    return std::make_pair(t.m_block_template, t.m_time_generated);\n+}\n+\n+std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> BlockTemplateCacheImpl::GetBlockTemplate(const BlockAssembler::Options& options, std::chrono::seconds interval)\n+{\n+    LOCK2(cs_main, m_mutex);\n+    for (auto it = m_block_templates.rbegin(); it != m_block_templates.rend(); it++){\n+        if (it->OptionsEqual(options) && !it->IntervalElapsed(interval)) {\n+            if (options.test_block_validity && !it->m_options.test_block_validity) {\n+                if (BlockValidationState state{TestBlockValidity(m_chainman.ActiveChainstate(), it->m_block_template->block,\n+                                    /*check_pow=*/false, /*check_merkle_root=*/false)}; !state.IsValid()) {\n+                    throw std::runtime_error(strprintf(\"TestBlockValidity failed: %s\", state.ToString()));\n+                }\n+                it->m_options.test_block_validity = true;\n+            }",
      "path": "src/node/miner.cpp",
      "position": 136,
      "original_position": 121,
      "commit_id": "5f798b4a3b1a978b8ac954db54e9e8dfc7da6319",
      "original_commit_id": "4de7887ca47197654f480471db04750d44e405de",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In commit \"node: add block template cache to miner\" (4de7887ca47197654f480471db04750d44e405de)\r\n\r\nCould be nice to dedup this part of the code with CreateNewBlock\r\n\r\n<details><summary>diff</summary>\r\n<p>\r\n\r\n```diff\r\n--- a/src/node/miner.cpp\r\n+++ b/src/node/miner.cpp\r\n@@ -38,6 +38,16 @@\r\n \r\n namespace node {\r\n \r\n+static void EnforceValidity(Chainstate& chainstate, const BlockAssembler::Options& options, const CBlock& block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+{\r\n+    AssertLockHeld(::cs_main);\r\n+    if (options.test_block_validity) {\r\n+       if (BlockValidationState state{TestBlockValidity(chainstate, block, /*check_pow=*/false, /*check_merkle_root=*/false)}; !state.IsValid()) {\r\n+           throw std::runtime_error(strprintf(\"TestBlockValidity failed: %s\", state.ToString()));\r\n+       }\r\n+    }\r\n+}\r\n+\r\n int64_t GetMinimumTime(const CBlockIndex* pindexPrev, const int64_t difficulty_adjustment_interval)\r\n {\r\n     int64_t min_time{pindexPrev->GetMedianTimePast() + 1};\r\n@@ -191,12 +201,8 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock()\r\n     UpdateTime(pblock, chainparams.GetConsensus(), pindexPrev);\r\n     pblock->nBits          = GetNextWorkRequired(pindexPrev, pblock, chainparams.GetConsensus());\r\n     pblock->nNonce         = 0;\r\n+    EnforceValidity(m_chainstate, m_options, *pblock);\r\n \r\n-    if (m_options.test_block_validity) {\r\n-        if (BlockValidationState state{TestBlockValidity(m_chainstate, *pblock, /*check_pow=*/false, /*check_merkle_root=*/false)}; !state.IsValid()) {\r\n-            throw std::runtime_error(strprintf(\"TestBlockValidity failed: %s\", state.ToString()));\r\n-        }\r\n-    }\r\n     const auto time_2{SteadyClock::now()};\r\n \r\n     LogDebug(BCLog::BENCH, \"CreateNewBlock() packages: %.2fms (%d packages, %d updated descendants), validity: %.2fms (total %.2fms)\\n\",\r\n@@ -540,11 +546,8 @@ std::pair<std::shared_ptr<CBlockTemplate>, NodeClock::time_point> BlockTemplateC\r\n     for (auto it = m_block_templates.rbegin(); it != m_block_templates.rend(); it++){\r\n         if (it->OptionsEqual(options) && !it->IntervalElapsed(interval)) {\r\n             if (options.test_block_validity && !it->m_options.test_block_validity) {\r\n-                if (BlockValidationState state{TestBlockValidity(m_chainman.ActiveChainstate(), it->m_block_template->block,\r\n-                                    /*check_pow=*/false, /*check_merkle_root=*/false)}; !state.IsValid()) {\r\n-                    throw std::runtime_error(strprintf(\"TestBlockValidity failed: %s\", state.ToString()));\r\n-                }\r\n                 it->m_options.test_block_validity = true;\r\n+                EnforceValidity(m_chainman.ActiveChainstate(), it->m_options, it->m_block_template->block);\r\n             }\r\n             return std::make_pair(it->m_block_template, it->m_time_generated);\r\n         }\r\n```\r\n</p>\r\n</details>",
      "created_at": "2025-10-29T16:20:34Z",
      "updated_at": "2025-10-29T16:21:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33421#discussion_r2474149528",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2474149528"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33421"
        }
      },
      "start_line": 542,
      "original_start_line": 542,
      "start_side": "RIGHT",
      "line": 548,
      "original_line": 548,
      "side": "RIGHT"
    }
  ]
}