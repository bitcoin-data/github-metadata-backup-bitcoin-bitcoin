{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165",
    "id": 1450858997,
    "node_id": "PR_kwDOABII585Weln1",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/28165",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/28165.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/28165.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
    "number": 28165,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "net: transport abstraction",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This PR furthers the P2P message serialization/deserialization abstraction introduced in #16202 and #16562, in preparation for introducing the BIP324 v2 transport (making this part of #27634). However, nothing in this PR is BIP324-specific, and it contains a number of independently useful improvements.\r\n\r\nThe overall idea is to have a single object in every `CNode` (called `m_transport`) that is responsible for converting sent messages to wire bytes, and for converting received wire bytes back to messages, while having as little as possible knowledge about this conversion process in higher-level net code. To accomplish that, there is an abstract `Transport` class with (currently) a single `V1Transport` implementation.\r\n\r\nStructurally, the above is accomplished by:\r\n* Merging the `TransportDeserializer` and `TransportSerializer` classes into a single `Transport` class, which encompasses both the sending and receiving side. For `V1Transport` these two sides are entirely separate, but this assumption doesn't hold for the BIP324 transport where e.g. the sending encryption key depends on the DH key negotiation data received from the other side. Merging the two means a future `V2Transport` can handle all this interaction without callers needing to be aware.\r\n* Removing the assumption that each message is sent using a computed header followed by (unmodified) data bytes. To achieve that, the sending side of `Transport` mirrors what the receiver side does: callers can set a message to be sent, then ask what bytes must be sent out, and then allowing them to transition to the next message.\r\n* Adding internal locks to protect the sending and receiving state of the `V1Transport` implementation. I believe these aren't strictly needed (opinions welcome) as there is no real way to use `Transport` objects in a multi-threaded fashion without some form of external synchronization (e.g. \"get next bytes to send\" isn't meaningful to call from multiple threads at the same time without mechanism to control the order they'll actually get sent). Still, I feel it's cleaner to make the object responsible for its own consistency (as we definitely do not want the entire object to be under a single external GUARDED_BY, as that'd prevent simultaneous sending and receiving).\r\n* Moving the conversion of messages to bytes on the sending side from `PushMessage` to `SocketSendData`, which is needed to deal with the fact that a transport may not immediately be able to send messages.\r\n\r\nThis PR is not a refactor, though some commits are. Among the semantic changes are:\r\n* Changing the send buffer pushback mechanism to trigger based on the memory usage of the buffer rather than the amount of bytes to be sent. This is both closer to the desired behavior, and makes the buffering independent from transport details (which is why it's included here).\r\n* When optimistic send is not applicable, the V1 message checksum calculation now runs in the net thread rather than the message handling thread. I believe that's generally an improvement, as the message handling thread is far more computationally bottlenecked already.\r\n* The checksum calculation now runs under the `CNode::cs_vSend` lock, which does mean no two checksum calculations for messages sent to the same node can run in parallel, even if running in separate threads. Despite that limitation, having the checksum for non-optimistic sends moved in the net thread is still an improvement, I believe.\r\n* Statistics for per-message-type sent bytes are now updated when the bytes are actually handed to the OS rather than in `PushMessage`. This is because the actual serialized sizes aren't known until they've gone through the transport object.\r\n\r\nA fuzz test of the entire `V1Transport` is included. More elaborate rationale for each of the changes can be found in the commit messages.",
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "created_at": "2023-07-26T20:04:07Z",
    "updated_at": "2023-08-14T15:56:18Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "11e134e767ea3c8ae51c52bad6bea532f23e144d",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "sipa:202307_merge_sers",
      "ref": "202307_merge_sers",
      "sha": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 1458655,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNDU4NjU1",
        "name": "bitcoin",
        "full_name": "sipa/bitcoin",
        "owner": {
          "login": "sipa",
          "id": 548488,
          "node_id": "MDQ6VXNlcjU0ODQ4OA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sipa",
          "html_url": "https://github.com/sipa",
          "followers_url": "https://api.github.com/users/sipa/followers",
          "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
          "organizations_url": "https://api.github.com/users/sipa/orgs",
          "repos_url": "https://api.github.com/users/sipa/repos",
          "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sipa/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/sipa/bitcoin",
        "description": "Bitcoin integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sipa/bitcoin",
        "archive_url": "https://api.github.com/repos/sipa/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sipa/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sipa/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sipa/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sipa/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sipa/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sipa/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sipa/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sipa/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sipa/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sipa/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sipa/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sipa/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sipa/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sipa/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sipa/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sipa/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sipa/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sipa/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sipa/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sipa/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sipa/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sipa/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sipa/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sipa/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sipa/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sipa/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sipa/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sipa/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sipa/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sipa/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sipa/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sipa/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sipa/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sipa/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sipa/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sipa/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sipa/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sipa/bitcoin/hooks",
        "svn_url": "https://github.com/sipa/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "TypeScript",
        "forks_count": 22,
        "stargazers_count": 85,
        "watchers_count": 85,
        "size": 218371,
        "default_branch": "lows",
        "open_issues_count": 16,
        "is_template": false,
        "topics": [],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": true,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-14T04:12:27Z",
        "created_at": "2011-03-09T10:46:59Z",
        "updated_at": "2023-08-13T14:25:22Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "44b05bf3fef2468783dcebf651654fdd30717e7e",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35524,
        "stargazers_count": 70839,
        "watchers_count": 70839,
        "size": 236419,
        "default_branch": "master",
        "open_issues_count": 684,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-14T15:51:43Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-08-14T15:48:50Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 421,
    "deletions": 131,
    "changed_files": 7,
    "commits": 8,
    "review_comments": 28,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 1652418427,
      "node_id": "IC_kwDOABII585ifed7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1652418427",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:04:10Z",
      "updated_at": "2023-08-12T21:25:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1658115391), [jonatack](https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1662963276), [Sjors](https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1560842698), [theStack](https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1566293438), [vincenzopalazzo](https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1575433253) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#28222](https://github.com/bitcoin/bitcoin/pull/28222) (Use shared_ptr for CNode inside CConnman by willcl-ark)\n* [#28196](https://github.com/bitcoin/bitcoin/pull/28196) (BIP324 connection support by sipa)\n* [#27981](https://github.com/bitcoin/bitcoin/pull/27981) (Fix potential network stalling bug by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1652418427",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165"
    },
    {
      "event": "labeled",
      "id": 9928241366,
      "node_id": "LE_lADOABII585sqgK1zwAAAAJPxPDW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9928241366",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:04:11Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-26T20:06:23Z",
      "updated_at": "2023-07-26T20:06:23Z",
      "source": {
        "issue": {
          "id": 1707054771,
          "node_id": "I_kwDOABII585lv5az",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27634",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27634/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27634/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27634/events",
          "html_url": "https://github.com/bitcoin/bitcoin/issues/27634",
          "number": 27634,
          "state": "open",
          "state_reason": null,
          "title": "BIP324 tracking issue",
          "body": "This issue will be updated to reflect the current state of [BIP324](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki) integration.\r\n\r\nPRs ready for review:\r\n* #28165\r\n\r\nOverall plan:\r\n* [x] ElligatorSwift integration in Bitcoin Core: #27479 \r\n  * [x] Dependency: ElligatorSwift support in libsecp256k1: bitcoin-core/secp256k1#1129\r\n  * [x] Dependency: update libsecp256k1 subtree: currently part of 27479.\r\n* [x] Cipher suite implementation (formerly 25361):\r\n  * [x] Support for not wasting ChaCha20 stream bytes: #26153\r\n  * [x] Support for RFC8439 variant of ChaCha20: #27985\r\n  * [x] Support for incremental Poly1305 computation: #27993\r\n  * [x] Cipher suite: #28008\r\n* [ ] P2P v2 connection support (formerly 23561, 23233, 24545):\r\n  * [ ] P2P transport abstraction: #28165\r\n  * [ ] BIP324 connection support: #28196\r\n* [ ] P2P v2 signalling integration (formerly 24545): no PR yet\r\n* [ ] BIP324 functional tests: #24748:\r\n   * [x] Dependency: ElligatorSwift support in functional tests: #24005\r\n   * [x] Dependency: Field element support in functional tests: #26222\r\n* [ ] P2P_V2 service flag support in DNS seeder: sipa/bitcoin-seeder#102\r\n* [x] Prehistory:\r\n  * [x] Old ChaCha20Poly1305@Bitcoin cipher: #15649\r\n  * [x] Preparing for multiple transport layers: #16202 and #16562\r\n  * [x] Miscellaneous fixes: #22331 #23271\r\n  * [x] ChaCha20 performance: #24946 \r\n",
          "user": {
            "login": "sipa",
            "id": 548488,
            "node_id": "MDQ6VXNlcjU0ODQ4OA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sipa",
            "html_url": "https://github.com/sipa",
            "followers_url": "https://api.github.com/users/sipa/followers",
            "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
            "organizations_url": "https://api.github.com/users/sipa/orgs",
            "repos_url": "https://api.github.com/users/sipa/repos",
            "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/sipa/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 1,
          "created_at": "2023-05-12T07:00:54Z",
          "updated_at": "2023-08-14T12:04:35Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-27T05:39:20Z",
      "updated_at": "2023-07-27T05:39:20Z",
      "source": {
        "issue": {
          "id": 1775568246,
          "node_id": "PR_kwDOABII585T9n4e",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27981",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27981/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27981/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27981/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/27981",
          "number": 27981,
          "state": "open",
          "state_reason": null,
          "title": "Fix potential network stalling bug",
          "body": "See https://github.com/ElementsProject/elements/issues/1233. There, it has been observed that if both sides of a P2P connection have a significant amount of data to send, a stall can occur, where both try to drain their own send queue before trying to receive. The same issue seems to apply to the current Bitcoin Core codebase, though I don't know whether it's a frequent issue for us.\r\n\r\nThe core issue is that whenever our optimistic send fails to fully send a message, we do subsequently not even select() for receiving; if it then turns out that sending is not possible either, no progress is made at all. To address this, the solution used in this PR is to still select() for both sending and receiving when an optimistic send fails, but skip receiving if sending succeeded, and (still) doesn't fully drain the send queue.\r\n\r\nThis is a significant reduction in how aggressive the \"receive pushback\" mechanism is, because now it will only mildly push back while sending progress is made; if the other side stops receiving entirely, the pushback disappears. I don't think that's a serious problem though:\r\n* We still have a pushback mechanism at the application buffer level (when the application receive buffer overflows, receiving is paused until messages in the buffer get processed; waiting on our own net_processing thread, not on the remote party).\r\n* There are cases where the existing mechanism is too aggressive; e.g. when the send queue is non-empty, but tiny, and can be sent with a single send() call. In that case, I think we'd prefer to still receive within the same processing loop of the network thread.\r\n",
          "user": {
            "login": "sipa",
            "id": 548488,
            "node_id": "MDQ6VXNlcjU0ODQ4OA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sipa",
            "html_url": "https://github.com/sipa",
            "followers_url": "https://api.github.com/users/sipa/followers",
            "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
            "organizations_url": "https://api.github.com/users/sipa/orgs",
            "repos_url": "https://api.github.com/users/sipa/repos",
            "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/sipa/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 12,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27981",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/27981",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/27981.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/27981.patch"
          },
          "created_at": "2023-06-26T20:37:36Z",
          "updated_at": "2023-08-11T11:37:34Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-27T08:33:42Z",
      "updated_at": "2023-07-27T08:33:42Z",
      "source": {
        "issue": {
          "id": 1652089479,
          "node_id": "PR_kwDOABII585Nfb4D",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27407",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27407/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27407/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/27407/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/27407",
          "number": 27407,
          "state": "closed",
          "state_reason": null,
          "title": "net, refactor: Privatise CNode send queue",
          "body": "The send queue members on `CNode` should not be part of the public interface. This PR makes all of them private and creates a clear interface for the send queue.\r\n\r\nThe interface after this PR consists of:\r\n* `CNode::PushMessage` for appending a message onto the send queue\r\n* `CNode::SocketSendData` for pushing as many messages from the send queue as possible onto the wire\r\n* `CNode::IsSendQueueEmpty` for checking if the send queue is empty\r\n* (`CNode::TestOnlyClearSendQueue` a test-only utility for clearing the send queue)",
          "user": {
            "login": "dergoegge",
            "id": 8077169,
            "node_id": "MDQ6VXNlcjgwNzcxNjk=",
            "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/dergoegge",
            "html_url": "https://github.com/dergoegge",
            "followers_url": "https://api.github.com/users/dergoegge/followers",
            "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
            "organizations_url": "https://api.github.com/users/dergoegge/orgs",
            "repos_url": "https://api.github.com/users/dergoegge/repos",
            "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/dergoegge/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            },
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 1,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/27407",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/27407",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/27407.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/27407.patch"
          },
          "closed_at": "2023-08-07T14:02:48Z",
          "created_at": "2023-04-03T13:36:50Z",
          "updated_at": "2023-08-07T14:02:48Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9955413836,
      "node_id": "HRFPE_lADOABII585sqgK1zwAAAAJRY49M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9955413836",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-29T20:56:43Z"
    },
    {
      "event": "commented",
      "id": 1658115391,
      "node_id": "IC_kwDOABII585i1NU_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1658115391",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-31T10:41:11Z",
      "updated_at": "2023-07-31T10:41:11Z",
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\n> Merging the two means a future V2Transport can handle all this interaction without callers needing to be aware.\r\n\r\nðŸš€",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1658115391",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDhmNWM2NWE0NjRiN2VkNDc5MzlhMDU1YTRiNjUyODZkMjBhNWIxMjY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8f5c65a464b7ed47939a055a4b65286d20a5b126",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/8f5c65a464b7ed47939a055a4b65286d20a5b126",
      "tree": {
        "sha": "be08f21da0e28f4bd10a41365d813ad637708250",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/be08f21da0e28f4bd10a41365d813ad637708250"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/44b05bf3fef2468783dcebf651654fdd30717e7e",
          "sha": "44b05bf3fef2468783dcebf651654fdd30717e7e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/44b05bf3fef2468783dcebf651654fdd30717e7e"
        }
      ],
      "message": "refactor: merge transport serializer and deserializer into Transport class\n\nThis allows state that is shared between both directions to be encapsulated\ninto a single object. Specifically the v2 transport protocol introduced by\nBIP324 has sending state (the encryption keys) that depends on received\nmessages (the DH key exchange). Having a single object for both means it can\nhide logic from callers related to the key exchange.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:39:26Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-05T20:22:52Z"
      },
      "sha": "8f5c65a464b7ed47939a055a4b65286d20a5b126"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM3NzIwODQ0YTQzNTdhYTQ5NzM2MmZkNWI0ODFiYzFhOWMyNzY4N2Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c7720844a4357aa497362fd5b481bc1a9c27687d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c7720844a4357aa497362fd5b481bc1a9c27687d",
      "tree": {
        "sha": "92d198b1d2f06d4311da5fc00b04b1fb19406de0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/92d198b1d2f06d4311da5fc00b04b1fb19406de0"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8f5c65a464b7ed47939a055a4b65286d20a5b126",
          "sha": "8f5c65a464b7ed47939a055a4b65286d20a5b126",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/8f5c65a464b7ed47939a055a4b65286d20a5b126"
        }
      ],
      "message": "net: add V1Transport lock protecting receive state\n\nRather than relying on the caller to prevent concurrent calls to the\nvarious receive-side functions of Transport, introduce a private m_cs_recv\ninside the implementation to protect the lock state.\n\nOf course, this does not remove the need for callers to synchronize calls\nentirely, as it is a stateful object, and e.g. the order in which Receive(),\nComplete(), and GetMessage() are called matters. It seems impossible to use\na Transport object in a meaningful way in a multi-threaded way without some\nform of external synchronization, but it still feels safer to make the\ntransport object itself responsible for protecting its internal state.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:39:26Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-26T17:19:31Z"
      },
      "sha": "c7720844a4357aa497362fd5b481bc1a9c27687d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGY5N2FkYmYzZTkzZTg5YjFlOGNlMWRjMjEyZTg0YWM2YjI4Nzk0NjM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "tree": {
        "sha": "153ddcf6b3de5c407e5b69ab9284995cd4806ccf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/153ddcf6b3de5c407e5b69ab9284995cd4806ccf"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c7720844a4357aa497362fd5b481bc1a9c27687d",
          "sha": "c7720844a4357aa497362fd5b481bc1a9c27687d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c7720844a4357aa497362fd5b481bc1a9c27687d"
        }
      ],
      "message": "net: abstract sending side of transport serialization further\n\nThis makes the sending side of P2P transports mirror the receiver side: caller provides\nmessage (consisting of type and payload) to be sent, and then asks what bytes must be\nsent. Once the message has been fully sent, a new message can be provided.\n\nThis removes the assumption that P2P serialization of messages follows a strict structure\nof header (a function of type and payload), followed by (unmodified) payload, and instead\nlets transports decide the structure themselves.\n\nIt also removes the assumption that a message must always be sent at once, or that no\nbytes are even sent on the wire when there is no message. This opens the door for\nsupporting traffic shaping mechanisms in the future.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:39:26Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-21T20:31:59Z"
      },
      "sha": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE5MzdhNWZjZjc5NTE0OWM0NGI3ZjRmMDE2YzA1MDAwYWMzYWRhZjk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "tree": {
        "sha": "cee3272a3800489e98f50c1049c1ae64dfa469c6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cee3272a3800489e98f50c1049c1ae64dfa469c6"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
          "sha": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f97adbf3e93e89b1e8ce1dc212e84ac6b2879463"
        }
      ],
      "message": "net: measure send buffer fullness based on memory usage\n\nThis more accurately captures the intent of limiting send buffer size, as\nmany small messages can have a larger overhead that is not counted with the\ncurrent approach.\n\nIt also means removing the dependency on the header size (which will become\na function of the transport choice) from the send buffer calculations.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:39:26Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-24T17:23:39Z"
      },
      "sha": "1937a5fcf795149c44b7f4f016c05000ac3adaf9"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDY4ZTQ4YTAxODU3NTFkMjRlZWNiMTk0YjhlZmQ3MDI4YzhiNTkwZjM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/68e48a0185751d24eecb194b8efd7028c8b590f3",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/68e48a0185751d24eecb194b8efd7028c8b590f3",
      "tree": {
        "sha": "4bb2aeb099855d6c385ad992e146bde0206e34a8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4bb2aeb099855d6c385ad992e146bde0206e34a8"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1937a5fcf795149c44b7f4f016c05000ac3adaf9",
          "sha": "1937a5fcf795149c44b7f4f016c05000ac3adaf9",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1937a5fcf795149c44b7f4f016c05000ac3adaf9"
        }
      ],
      "message": "net: move message serialization from PushMessage to SocketSendData\n\nThis furthers transport abstraction by removing the assumption that a message\ncan always immediately be converted to wire bytes. This assumption does not hold\nfor the v2 transport proposed by BIP324, as no messages can be sent before the\nhandshake completes.\n\nThis is not a pure refactor, and has the following effects even for the current\nv1 transport:\n\n* Checksum calculation now happens in SocketSendData rather than PushMessage.\n  For non-optimistic-send messages, that means this computation now happens in\n  the network thread rather than the message handler thread (generally a good\n  thing, as the message handler thread is more of a computational bottleneck).\n* Checksum calculation now happens while holding the cs_vSend lock. This is\n  technically unnecessary for the v1 transport, as messages are encoded\n  independent from one another, but is untenable for the v2 transport anyway.\n* Statistics updates about per-message sent bytes now happen when those bytes\n  are actually handed to the OS, rather than at PushMessage time.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:47:49Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-24T23:15:44Z"
      },
      "sha": "68e48a0185751d24eecb194b8efd7028c8b590f3"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGJkNjIzNDU4MGFlNTZjOTU0YWU4MTJkYjU5ZDRiZmFiYTRhMThiN2E",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bd6234580ae56c954ae812db59d4bfaba4a18b7a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bd6234580ae56c954ae812db59d4bfaba4a18b7a",
      "tree": {
        "sha": "92f05c70605eef9aa5d7b0df63592710fb90b1db",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/92f05c70605eef9aa5d7b0df63592710fb90b1db"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/68e48a0185751d24eecb194b8efd7028c8b590f3",
          "sha": "68e48a0185751d24eecb194b8efd7028c8b590f3",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/68e48a0185751d24eecb194b8efd7028c8b590f3"
        }
      ],
      "message": "refactor: make Transport::Read just return success/fail",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:48:42Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-29T17:59:35Z"
      },
      "sha": "bd6234580ae56c954ae812db59d4bfaba4a18b7a"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDAyYzU0MjUzZjQwOTVhZjdiZTg3NmFhZDEwZmI1YTBjMjc0ODZmZjg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/02c54253f4095af7be876aad10fb5a0c27486ff8",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/02c54253f4095af7be876aad10fb5a0c27486ff8",
      "tree": {
        "sha": "f2ab1cf6f728ad637358b9f634446ca1575152e6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f2ab1cf6f728ad637358b9f634446ca1575152e6"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bd6234580ae56c954ae812db59d4bfaba4a18b7a",
          "sha": "bd6234580ae56c954ae812db59d4bfaba4a18b7a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bd6234580ae56c954ae812db59d4bfaba4a18b7a"
        }
      ],
      "message": "net: make V1Transport implicitly use current chainparams\n\nThe rest of net.cpp already uses Params() to determine chainparams in many\nplaces (and even V1Transport itself does so in some places).\n\nSince the only chainparams dependency is through the message start characters,\njust store those directly in the transport.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:48:42Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-27T19:35:41Z"
      },
      "sha": "02c54253f4095af7be876aad10fb5a0c27486ff8"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI3YTdlZDcwZDA2YWIzZjk5NGZmNThlM2EwYzk5MTA1ZWU4OGFiNmU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "tree": {
        "sha": "c7e88f935f4d73298d0b19c8f29f889cbda13326",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c7e88f935f4d73298d0b19c8f29f889cbda13326"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/02c54253f4095af7be876aad10fb5a0c27486ff8",
          "sha": "02c54253f4095af7be876aad10fb5a0c27486ff8",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/02c54253f4095af7be876aad10fb5a0c27486ff8"
        }
      ],
      "message": "fuzz: add bidirectional fragmented transport test\n\nThis adds a simulation test, with two V1Transport objects, which send messages\nto each other, with sending and receiving fragmented into multiple pieces that\nmay be interleaved. It primarily verifies that the sending and receiving side\nare compatible with each other, plus a few sanity checks.",
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-31T16:48:42Z"
      },
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2023-07-25T21:38:32Z"
      },
      "sha": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 9966489038,
      "node_id": "HRFPE_lADOABII585sqgK1zwAAAAJSDI3O",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/9966489038",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-07-31T16:54:25Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-01T17:56:59Z",
      "updated_at": "2023-08-01T17:56:59Z",
      "source": {
        "issue": {
          "id": 1831769418,
          "node_id": "PR_kwDOABII585W74nW",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28196",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28196/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28196/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28196/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/28196",
          "number": 28196,
          "state": "open",
          "state_reason": null,
          "title": "BIP324 connection support",
          "body": "Builds on top of #28008 and #28165, and part of #27634. Draft while dependencies and (more) tests are missing.\r\n\r\nThis implements the BIP324 v2 transport and application layer. It is currently only accessible through the test-only `-bip324=` command-line option, which specifies IPs, host names, or subnets for which to use BIP324 connections. This option is only added in order to make experimentation possible; I don't expect it will be supported long-term (or should even remain in this PR).\r\n\r\nStill missing features are:\r\n* Support for the `NODE_P2P_V2` service flag.\r\n* Automatically trying V2 connections when the service flag is set.\r\n* Retrying downgrade to V1 when attempted outbound V2 connections immediately fail.\r\n* P2P functional tests (only a fuzz test for the transport is included, and a few bitcoind-to-bitcoind functional tests)\r\n\r\nOther than that, support for V2 connections is functionally complete, including:\r\n* Autodetection of incoming V1 connections.\r\n* Garbage, both sending and receiving.\r\n* Short message type IDs, both sending and receiving.\r\n* Ignore packets (receiving only, and untested).\r\n* Session IDs are visible in `getpeerinfo` output (for manual comparison).\r\n",
          "user": {
            "login": "sipa",
            "id": 548488,
            "node_id": "MDQ6VXNlcjU0ODQ4OA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/sipa",
            "html_url": "https://github.com/sipa",
            "followers_url": "https://api.github.com/users/sipa/followers",
            "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
            "organizations_url": "https://api.github.com/users/sipa/orgs",
            "repos_url": "https://api.github.com/users/sipa/repos",
            "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/sipa/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": false,
          "comments": 1,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28196",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/28196",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/28196.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/28196.patch"
          },
          "created_at": "2023-08-01T17:56:58Z",
          "updated_at": "2023-08-11T02:00:12Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "commented",
      "id": 1662963276,
      "node_id": "IC_kwDOABII585jHs5M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1662963276",
      "actor": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-02T21:04:45Z",
      "updated_at": "2023-08-02T21:04:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "jonatack",
        "id": 2415484,
        "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jonatack",
        "html_url": "https://github.com/jonatack",
        "followers_url": "https://api.github.com/users/jonatack/followers",
        "following_url": "https://api.github.com/users/jonatack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jonatack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jonatack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
        "organizations_url": "https://api.github.com/users/jonatack/orgs",
        "repos_url": "https://api.github.com/users/jonatack/repos",
        "events_url": "https://api.github.com/users/jonatack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jonatack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1662963276",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165"
    },
    {
      "event": "reviewed",
      "id": 1560842698,
      "node_id": "PRR_kwDOABII585dCJHK",
      "url": null,
      "actor": null,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\nMostly happy with b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e. Minor inline suggestions and/or making sure I understand what the code is doing.\r\n\r\nI also checked that all intermediate commits compile and ran the new fuzzer for several hours (but didn't study it very carefully).\r\n\r\n* 1937a5fcf795149c44b7f4f016c05000ac3adaf9: `-maxsendbuffer` help could be changed to say \"Maximum per-connection memory use for the send buffer\"\r\n* 68e48a0185751d24eecb194b8efd7028c8b590f3: can you elaborate a bit in the commit description why `nSendOffset` can be dropped?",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1560842698",
      "submitted_at": "2023-08-03T17:07:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
    },
    {
      "event": "commented",
      "id": 1664651486,
      "node_id": "IC_kwDOABII585jOJDe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1664651486",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-03T21:09:23Z",
      "updated_at": "2023-08-03T21:10:26Z",
      "author_association": "MEMBER",
      "body": "> https://github.com/bitcoin/bitcoin/commit/68e48a0185751d24eecb194b8efd7028c8b590f3: can you elaborate a bit in the commit description why nSendOffset can be dropped?\r\n\r\nIn the current codebase, the send buffering (= remembering the to-be-sent bytes which we haven't managed to send yet) is done using `vSendMsg` (a queue of *byte arrays*) + `nSendOffset` (the position within `vSendMsg[0]` up to where we've sent things). After this PR, `vSendMsg` is turned into a queue of *messages*, which have not yet been converted to bytes-on-the-wire; this conversion is now handled by `m_transport`, and it's the transport that remembers what/how much has been sent yet.",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#issuecomment-1664651486",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28165"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-08-05T20:31:01Z",
      "updated_at": "2023-08-05T20:31:01Z",
      "source": {
        "issue": {
          "id": 1837671308,
          "node_id": "PR_kwDOABII585XPvx_",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28222",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28222/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28222/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/28222/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/28222",
          "number": 28222,
          "state": "open",
          "state_reason": null,
          "title": "Use shared_ptr for CNode inside CConnman",
          "body": "Switch to using smart pointers to `CNode`s inside of `CConnman`.\r\n\r\nCurrently we are manually refcounting CNodes which is potentially error-prone and makes operations such as deleting them from multiple threads difficult without introducing new locks or other synchronisation operations (see https://github.com/bitcoin/bitcoin/pull/27912).\r\n\r\nSwitch to using `std::shared_ptr` references to `CNode`s inside of `m_nodes` and `m_nodes_disconnected` to give us better memory safety today, and in the future allow `AttemptToEvictConnection` (and optionally other sites) to safely synchronously disconnect nodes when needed.\r\n\r\nOpening as draft for now as I want to both gauge feedback on the approach, and see which PRs this may conflict with (#27213?) before moving it forwards.\r\n\r\nCC @vasild ",
          "user": {
            "login": "willcl-ark",
            "id": 6606587,
            "node_id": "MDQ6VXNlcjY2MDY1ODc=",
            "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/willcl-ark",
            "html_url": "https://github.com/willcl-ark",
            "followers_url": "https://api.github.com/users/willcl-ark/followers",
            "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
            "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
            "repos_url": "https://api.github.com/users/willcl-ark/repos",
            "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 5334691551,
              "node_id": "LA_kwDOABII588AAAABPfju3w",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
              "name": "CI failed",
              "description": "",
              "color": "cccccc",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 10,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28222",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/28222",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/28222.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/28222.patch"
          },
          "created_at": "2023-08-05T09:45:10Z",
          "updated_at": "2023-08-14T07:57:02Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "reviewed",
      "id": 1566293438,
      "node_id": "PRR_kwDOABII585dW72-",
      "url": null,
      "actor": null,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nSlowly working my way through, reviewed up to f97adbf3e93e89b1e8ce1dc212e84ac6b2879463 (commit 3/8), looks good so far.\r\nOne potential code deduplication nit (though I'm not sure if it gains that much in readability): seems like for V1Transport,  `HaveBytesToSend()` and `DoneSendingMessage()` are in an inverse relation (or however one would call that), so one could be expressed through the other, e.g.:\r\n```diff\r\nindex 887669e32b..af0fa5c603 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -863,8 +863,7 @@ void V1Transport::SetMessageToSend(CSerializedNetMsg&& msg) noexcept\r\n \r\n bool V1Transport::HaveBytesToSend() const noexcept\r\n {\r\n-    LOCK(m_cs_send);\r\n-    return m_sending_header || m_bytes_sent != m_message_to_send.data.size();\r\n+    return !DoneSendingMessage();\r\n }\r\n \r\n Transport::BytesToSend V1Transport::GetBytesToSend() const noexcept\r\n```",
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1566293438",
      "submitted_at": "2023-08-08T00:09:29Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
    },
    {
      "event": "reviewed",
      "id": 1575433253,
      "node_id": "PRR_kwDOABII585d5zQl",
      "url": null,
      "actor": null,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "Concept ACK till https://github.com/bitcoin/bitcoin/pull/28165/commits/1937a5fcf795149c44b7f4f016c05000ac3adaf9\r\n\r\nI will continue later on it",
      "user": {
        "login": "vincenzopalazzo",
        "id": 17150045,
        "node_id": "MDQ6VXNlcjE3MTUwMDQ1",
        "avatar_url": "https://avatars.githubusercontent.com/u/17150045?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vincenzopalazzo",
        "html_url": "https://github.com/vincenzopalazzo",
        "followers_url": "https://api.github.com/users/vincenzopalazzo/followers",
        "following_url": "https://api.github.com/users/vincenzopalazzo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vincenzopalazzo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vincenzopalazzo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vincenzopalazzo/subscriptions",
        "organizations_url": "https://api.github.com/users/vincenzopalazzo/orgs",
        "repos_url": "https://api.github.com/users/vincenzopalazzo/repos",
        "events_url": "https://api.github.com/users/vincenzopalazzo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vincenzopalazzo/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#pullrequestreview-1575433253",
      "submitted_at": "2023-08-12T21:25:45Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283037011",
      "pull_request_review_id": 1560842698,
      "id": 1283037011,
      "node_id": "PRRC_kwDOABII585MeZdT",
      "diff_hunk": "@@ -306,29 +307,38 @@ class V1Transport final : public Transport\n         hasher.Reset();\n     }\n \n+    bool CompleteInternal() const noexcept EXCLUSIVE_LOCKS_REQUIRED(m_cs_recv)",
      "path": "src/net.h",
      "position": 114,
      "original_position": 40,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "c7720844a4357aa497362fd5b481bc1a9c27687d",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "c7720844a4357aa497362fd5b481bc1a9c27687d: I assume this separation of `CompleteInternal()` is because `EXCLUSIVE_LOCKS_REQUIRED` is only set for `V1Transport` rather than on `Transport`?",
      "created_at": "2023-08-03T11:03:06Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283037011",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283037011"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 331,
      "original_line": 310,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283084032",
      "pull_request_review_id": 1560842698,
      "id": 1283084032,
      "node_id": "PRRC_kwDOABII585Mek8A",
      "diff_hunk": "@@ -783,6 +783,8 @@ CNetMessage V1Transport::GetMessage(const std::chrono::microseconds time, bool&\n {\n     // Initialize out parameter\n     reject_message = false;\n+\n+    LOCK(m_cs_recv);",
      "path": "src/net.cpp",
      "position": 99,
      "original_position": 5,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463 this `LOCK` should have been moved in the previous commit. Otherwise it gives a thread safety warning.",
      "created_at": "2023-08-03T11:48:42Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283084032",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283084032"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 804,
      "original_line": 787,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283202700",
      "pull_request_review_id": 1560842698,
      "id": 1283202700,
      "node_id": "PRRC_kwDOABII585MfB6M",
      "diff_hunk": "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "path": "src/net.h",
      "position": 46,
      "original_position": 13,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: `NoPendingSend()` ? That makes it more clear this method doesn't mark something done. Also it applies before the first message too.",
      "created_at": "2023-08-03T13:25:31Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283202700",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283202700"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 282,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283265993",
      "pull_request_review_id": 1560842698,
      "id": 1283265993,
      "node_id": "PRRC_kwDOABII585MfRXJ",
      "diff_hunk": "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 98,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: this new `assert` and the one below had me a bit worried, but they disappear in 68e48a0185751d24eecb194b8efd7028c8b590f3.\r\n\r\nI think they're ok here though:\r\n\r\n1. The very first message it's trivially clear this won't be a problem: `m_sending_header` starts out `false`, `m_bytes_sent` at `0` and `m_message_to_send.data` is initialised empty.\r\n2. `MarkBytesSent` sets these things back when (exactly) all bytes have been put in the send buffer (`vSendMsg`). In v1 this is always the case after the second (header only) or third call to `GetBytesToSend()`, after which we leave the while loop.",
      "created_at": "2023-08-03T14:11:11Z",
      "updated_at": "2023-08-03T17:09:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283265993",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283265993"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2919,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283288152",
      "pull_request_review_id": 1560842698,
      "id": 1283288152,
      "node_id": "PRRC_kwDOABII585MfWxY",
      "diff_hunk": "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 101,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: could add a comment here:\r\n\r\n```cpp\r\n// In v1 transport GetBytesToSend first returns a header and next the data (if any).\r\n```",
      "created_at": "2023-08-03T14:26:56Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283288152",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283288152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2922,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283297036",
      "pull_request_review_id": 1560842698,
      "id": 1283297036,
      "node_id": "PRRC_kwDOABII585MfY8M",
      "diff_hunk": "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 103,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: Since we're notifying two different things about these sent bytes - and also setting `nSendSize` - I suggested some extra comments...\r\n\r\n```cpp\r\n// Update statistics per message type\r\n```",
      "created_at": "2023-08-03T14:32:34Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283297036",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283297036"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2924,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283298309",
      "pull_request_review_id": 1560842698,
      "id": 1283298309,
      "node_id": "PRRC_kwDOABII585MfZQF",
      "diff_hunk": "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;\n+            pnode->AccountForSentBytes(msg_type, bytes.size());\n+            pnode->nSendSize += bytes.size();\n+            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n+            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 107,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463\r\n\r\n```cpp\r\n// Notify Transport that bytes have been processed\r\n```\r\n",
      "created_at": "2023-08-03T14:33:28Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283298309",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283298309"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2928,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283301879",
      "pull_request_review_id": 1560842698,
      "id": 1283301879,
      "node_id": "PRRC_kwDOABII585MfaH3",
      "diff_hunk": "@@ -2866,23 +2911,25 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         msg.data.data()\n     );\n \n-    // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_transport->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n-\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n         bool optimisticSend(pnode->vSendMsg.empty());\n \n-        //log total amount of bytes per message type\n-        pnode->AccountForSentBytes(msg.m_type, nTotalSize);\n-        pnode->nSendSize += nTotalSize;\n+        assert(pnode->m_transport->DoneSendingMessage());\n+        pnode->m_transport->SetMessageToSend(std::move(msg));\n+\n+        while (true) {\n+            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n+            if (bytes.empty()) break;\n+            pnode->AccountForSentBytes(msg_type, bytes.size());",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 104,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463\r\n\r\n```cpp\r\n// Update bytes in send buffer\r\n```\r\n\r\n(becomes \"Update memory use of send buffer\" in the next commit)",
      "created_at": "2023-08-03T14:36:03Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283301879",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283301879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2925,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283305145",
      "pull_request_review_id": 1560842698,
      "id": 1283305145,
      "node_id": "PRRC_kwDOABII585Mfa65",
      "diff_hunk": "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;\n+    /** Set a message to send (only allowed if DoneSendingMessage()). */\n+    virtual void SetMessageToSend(CSerializedNetMsg&& msg) noexcept = 0;\n+    /** Whether there are bytes to send on the wire. */\n+    virtual bool HaveBytesToSend() const noexcept = 0;\n+    /** Return type for GetBytesToSend, consisting of:\n+     *  - Span<const uint8_t>: span of bytes to be sent over the wire (empty if !HaveBytesToSend())\n+     *  - bool: whether more bytes to be sent follow after the ones in the span have been sent\n+     *  - const std::string&: message type on behalf of which this is being sent (or \"\" if n/a)\n+     */\n+    using BytesToSend = std::tuple<Span<const uint8_t>, bool, const std::string&>;\n+    /** Get bytes to send on the wire. */\n+    virtual BytesToSend GetBytesToSend() const noexcept = 0;\n+    /** Report how many bytes returned by GetBytesToSend() have been sent. No effect if 0. */\n+    virtual void MarkBytesSent(size_t bytes_sent) noexcept = 0;",
      "path": "src/net.h",
      "position": 60,
      "original_position": 27,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463: could we just assume bytes will get sent this if `GetBytesToSend()` has been called? Afaik there's no way to handle a failure anyway. But I guess it's safer to track it explicitly.\r\n\r\nUpdate: in 68e48a0185751d24eecb194b8efd7028c8b590f3 this function becomes more important, and is used to track when not all bytes are sent.",
      "created_at": "2023-08-03T14:38:24Z",
      "updated_at": "2023-08-03T17:12:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283305145",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283305145"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 296,
      "original_line": 293,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283320253",
      "pull_request_review_id": 1560842698,
      "id": 1283320253,
      "node_id": "PRRC_kwDOABII585Mfem9",
      "diff_hunk": "@@ -827,8 +834,46 @@ void V1Transport::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsign\n     memcpy(hdr.pchChecksum, hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n     // serialize header\n-    header.reserve(CMessageHeader::HEADER_SIZE);",
      "path": "src/net.cpp",
      "position": 125,
      "original_position": 36,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463 this `reserve` wasn't useful?",
      "created_at": "2023-08-03T14:49:03Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283320253",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283320253"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 829,
      "original_line": 830,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283352376",
      "pull_request_review_id": 1560842698,
      "id": 1283352376,
      "node_id": "PRRC_kwDOABII585Mfmc4",
      "diff_hunk": "@@ -2923,11 +2940,11 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n             const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n             if (bytes.empty()) break;\n             pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->nSendSize += bytes.size();\n-            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n             pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n+            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n             pnode->m_transport->MarkBytesSent(bytes.size());\n         }\n+        if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;",
      "path": "src/net.cpp",
      "position": 300,
      "original_position": 70,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "1937a5fcf795149c44b7f4f016c05000ac3adaf9  Isn't `>m_transport->GetSendMemoryUsage()` 0 since we just sent the message and cleared it?\r\n\r\n(but that changes in the next commit 68e48a0185751d24eecb194b8efd7028c8b590f3)",
      "created_at": "2023-08-03T15:13:16Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283352376",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283352376"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2951,
      "original_line": 2947,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283416754",
      "pull_request_review_id": 1560842698,
      "id": 1283416754,
      "node_id": "PRRC_kwDOABII585Mf2Ky",
      "diff_hunk": "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();",
      "path": "src/net.cpp",
      "position": 298,
      "original_position": 104,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "68e48a0185751d24eecb194b8efd7028c8b590f3: this is much readable than the intermediate calculation introduced in 1937a5fcf795149c44b7f4f016c05000ac3adaf9. It might be worth moving that commit after here.",
      "created_at": "2023-08-03T16:03:02Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283416754",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283416754"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2949,
      "original_line": 2941,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283427444",
      "pull_request_review_id": 1560842698,
      "id": 1283427444,
      "node_id": "PRRC_kwDOABII585Mf4x0",
      "diff_hunk": "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();\n+        pnode->vSendMsg.push_back(std::move(msg));\n         if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;\n \n-        assert(pnode->m_transport->DoneSendingMessage());\n-\n         // If write queue empty, attempt \"optimistic write\"",
      "path": "src/net.cpp",
      "position": 302,
      "original_position": 110,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "68e48a0185751d24eecb194b8efd7028c8b590f3: This could be a good time to document what optimistic send actually is. From 1817398b397afebcc857c40a16d201c84878cb89:\r\n\r\n```cpp\r\n// Because the poll/select loop may pause for 100msec before actually doing a\r\n// send, and we have no way to force the loop awake, try sending from the calling\r\n// thread if the queue is empty.\r\n```\r\n\r\nOr shorter: `// which avoids a delay of up to SELECT_TIMEOUT_MILLISECONDS.`\r\n",
      "created_at": "2023-08-03T16:12:01Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283427444",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283427444"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2953,
      "original_line": 2945,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283440338",
      "pull_request_review_id": 1560842698,
      "id": 1283440338,
      "node_id": "PRRC_kwDOABII585Mf77S",
      "diff_hunk": "@@ -1298,7 +1301,9 @@ Sock::EventsPerSock CConnman::GenerateWaitSockets(Span<CNode* const> nodes)\n         bool select_send;\n         {\n             LOCK(pnode->cs_vSend);\n-            select_send = !pnode->vSendMsg.empty();\n+            // This relies on optimistic send to make sure the transport always has a message to\n+            // send if there are any.",
      "path": "src/net.cpp",
      "position": 261,
      "original_position": 81,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "68e48a0185751d24eecb194b8efd7028c8b590f3 Is the above comment still correct? \"As this only happens when optimistic write failed\"",
      "created_at": "2023-08-03T16:23:16Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283440338",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283440338"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1313,
      "original_line": 1305,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283461349",
      "pull_request_review_id": 1560842698,
      "id": 1283461349,
      "node_id": "PRRC_kwDOABII585MgBDl",
      "diff_hunk": "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "path": "src/net.cpp",
      "position": 198,
      "original_position": 21,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "68e48a0185751d24eecb194b8efd7028c8b590f3\r\n\r\n```cpp\r\n// Leave message in the transport for when the socket is available.\r\n// v2 transport would also require waiting for the handshake to complete\r\n```\r\n\r\nWith v2 I assume we can't even call `GetBytesToSend` before the handshake?",
      "created_at": "2023-08-03T16:41:56Z",
      "updated_at": "2023-08-03T17:07:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283461349",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283461349"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 921,
      "original_line": 913,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283605312",
      "pull_request_review_id": 1561694994,
      "id": 1283605312,
      "node_id": "PRRC_kwDOABII585MgkNA",
      "diff_hunk": "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "path": "src/net.cpp",
      "position": 198,
      "original_position": 21,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": 1283461349,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "We can - In fact the handshake itself is sent this way (that's the nice part about this abstraction, the caller doesn't know or care whether bytes being sent are on behalf of a message we're trying to send or something else).",
      "created_at": "2023-08-03T19:02:32Z",
      "updated_at": "2023-08-03T19:02:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283605312",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283605312"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 921,
      "original_line": 913,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283606280",
      "pull_request_review_id": 1561696448,
      "id": 1283606280,
      "node_id": "PRRC_kwDOABII585MgkcI",
      "diff_hunk": "@@ -2923,11 +2940,11 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n             const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n             if (bytes.empty()) break;\n             pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->nSendSize += bytes.size();\n-            if (pnode->nSendSize > nSendBufferMaxSize) pnode->fPauseSend = true;\n             pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n+            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n             pnode->m_transport->MarkBytesSent(bytes.size());\n         }\n+        if (pnode->m_send_memusage + pnode->m_transport->GetSendMemoryUsage() > nSendBufferMaxSize) pnode->fPauseSend = true;",
      "path": "src/net.cpp",
      "position": 300,
      "original_position": 70,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "1937a5fcf795149c44b7f4f016c05000ac3adaf9",
      "in_reply_to_id": 1283352376,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah, it should be 0 at this point, but that won't remain with the next commit. A temporary explanation message could be added to explain that here.",
      "created_at": "2023-08-03T19:03:41Z",
      "updated_at": "2023-08-03T19:03:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283606280",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283606280"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2951,
      "original_line": 2947,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283610490",
      "pull_request_review_id": 1561702502,
      "id": 1283610490,
      "node_id": "PRRC_kwDOABII585Mgld6",
      "diff_hunk": "@@ -306,29 +307,38 @@ class V1Transport final : public Transport\n         hasher.Reset();\n     }\n \n+    bool CompleteInternal() const noexcept EXCLUSIVE_LOCKS_REQUIRED(m_cs_recv)",
      "path": "src/net.h",
      "position": 114,
      "original_position": 40,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "c7720844a4357aa497362fd5b481bc1a9c27687d",
      "in_reply_to_id": 1283037011,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It's because I don't want a recursive lock, and I'm introducing a caller of `CompleteInternal()` that already holds `m_cs_recv`.",
      "created_at": "2023-08-03T19:08:23Z",
      "updated_at": "2023-08-03T19:08:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283610490",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283610490"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 331,
      "original_line": 310,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283633525",
      "pull_request_review_id": 1561737078,
      "id": 1283633525,
      "node_id": "PRRC_kwDOABII585MgrF1",
      "diff_hunk": "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;\n+    /** Set a message to send (only allowed if DoneSendingMessage()). */\n+    virtual void SetMessageToSend(CSerializedNetMsg&& msg) noexcept = 0;\n+    /** Whether there are bytes to send on the wire. */\n+    virtual bool HaveBytesToSend() const noexcept = 0;\n+    /** Return type for GetBytesToSend, consisting of:\n+     *  - Span<const uint8_t>: span of bytes to be sent over the wire (empty if !HaveBytesToSend())\n+     *  - bool: whether more bytes to be sent follow after the ones in the span have been sent\n+     *  - const std::string&: message type on behalf of which this is being sent (or \"\" if n/a)\n+     */\n+    using BytesToSend = std::tuple<Span<const uint8_t>, bool, const std::string&>;\n+    /** Get bytes to send on the wire. */\n+    virtual BytesToSend GetBytesToSend() const noexcept = 0;\n+    /** Report how many bytes returned by GetBytesToSend() have been sent. No effect if 0. */\n+    virtual void MarkBytesSent(size_t bytes_sent) noexcept = 0;",
      "path": "src/net.h",
      "position": 60,
      "original_position": 27,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": 1283305145,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In general, it's true that the new sending interface is overly complicated for how it is used initially, and then it only becomes apparent in the next commit. \r\n\r\nHere specifically, indeed, everything returned by `GetBytesToSend` is initially always marked sent, but in the next commit that changes, as the buffering responsibility is moved from `vSendMsg` to `m_transport`. I'm happy to add (possibly temporary) comments to explain what's happening.",
      "created_at": "2023-08-03T19:29:45Z",
      "updated_at": "2023-08-03T19:29:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283633525",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283633525"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 296,
      "original_line": 293,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283660977",
      "pull_request_review_id": 1561776670,
      "id": 1283660977,
      "node_id": "PRRC_kwDOABII585Mgxyx",
      "diff_hunk": "@@ -2931,23 +2936,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     size_t nBytesSent = 0;\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n-\n-        assert(pnode->m_transport->DoneSendingMessage());\n-        pnode->m_transport->SetMessageToSend(std::move(msg));\n+        bool optimisticSend{pnode->vSendMsg.empty() && pnode->m_transport->DoneSendingMessage()};\n \n-        while (true) {\n-            const auto& [bytes, more, msg_type] = pnode->m_transport->GetBytesToSend();\n-            if (bytes.empty()) break;\n-            pnode->AccountForSentBytes(msg_type, bytes.size());\n-            pnode->vSendMsg.push_back({bytes.begin(), bytes.end()});\n-            pnode->m_send_memusage += sizeof(pnode->vSendMsg.back()) + memusage::DynamicUsage(pnode->vSendMsg.back());\n-            pnode->m_transport->MarkBytesSent(bytes.size());\n-        }\n+        pnode->m_send_memusage += msg.GetMemoryUsage();",
      "path": "src/net.cpp",
      "position": 298,
      "original_position": 104,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": 1283416754,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I don't reordering works without (even) more intermediary complexity. The issue is \"net: move message serialization from PushMessage to SocketSendData\" changes the data type of `vSendMsg` from bytes-to-be-sent to messages-to-be-sent, and the latter just don't have a known size-on-the-wire (unless an additional API to transports is added for that, or hardcoding the V1 message encoding size rules). That's why this PR first changes the notion of send buffer size: the old notion just doesn't really make sense anymore after the buffer changes introduced here.",
      "created_at": "2023-08-03T20:00:47Z",
      "updated_at": "2023-08-03T20:00:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283660977",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283660977"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2949,
      "original_line": 2941,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283674053",
      "pull_request_review_id": 1561795385,
      "id": 1283674053,
      "node_id": "PRRC_kwDOABII585Mg0_F",
      "diff_hunk": "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "path": "src/net.h",
      "position": 46,
      "original_position": 13,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": 1283202700,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Actually, that name would be confusing for V2, where it's possible that there is no pending message, but also no message can be provided (yet) because the handshake has not completed.\r\n\r\nPerhaps `CanSetNewMessageToSend()` is better? (let the bikesheddening begin!)",
      "created_at": "2023-08-03T20:15:35Z",
      "updated_at": "2023-08-03T20:15:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283674053",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1283674053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 282,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284194811",
      "pull_request_review_id": 1562506904,
      "id": 1284194811,
      "node_id": "PRRC_kwDOABII585Mi0H7",
      "diff_hunk": "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "path": "src/net.cpp",
      "position": 198,
      "original_position": 21,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": 1283461349,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I guess it's not entirely clear to me whose responsibility it is to ensure the handshake has been done: https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1283674053 (I assume it will be in the main PR)",
      "created_at": "2023-08-04T09:22:28Z",
      "updated_at": "2023-08-04T09:22:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284194811",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284194811"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 921,
      "original_line": 913,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284382381",
      "pull_request_review_id": 1562808679,
      "id": 1284382381,
      "node_id": "PRRC_kwDOABII585Mjh6t",
      "diff_hunk": "@@ -897,37 +897,39 @@ size_t CConnman::SocketSendData(CNode& node) const\n     auto it = node.vSendMsg.begin();\n     size_t nSentSize = 0;\n \n-    while (it != node.vSendMsg.end()) {\n-        const auto& data = *it;\n-        assert(data.size() > node.nSendOffset);\n+    while (true) {\n+        bool progress = false;\n+        if (it != node.vSendMsg.end() && node.m_transport->DoneSendingMessage()) {\n+            // If possible, move one message from the send queue to the transport.\n+            node.m_send_memusage -= it->GetMemoryUsage();\n+            node.m_transport->SetMessageToSend(std::move(*it));\n+            ++it;\n+            progress = true;\n+        }\n+        const auto& [data, more, msg_type] = node.m_transport->GetBytesToSend();\n         int nBytes = 0;\n-        {\n+        if (!data.empty()) {\n             LOCK(node.m_sock_mutex);\n             if (!node.m_sock) {",
      "path": "src/net.cpp",
      "position": 198,
      "original_position": 21,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "68e48a0185751d24eecb194b8efd7028c8b590f3",
      "in_reply_to_id": 1283461349,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "My view is that anything that is different between v1 and v2 connections ought to be handled by the respective transport class.\n\nIn V2 there are multiple stages a connection goes through (pubkey, garbage+terminator, garbage authentication packet, version negotiation packet, and finally application data during which bitcoin P2P messages can be sent); this will be implemented using a finite state machine on sender and receiver side to control what state we are in. Only during the last phase (application data) can `SetMessageToSend` be called.\n\n`GetBytesToSend` can always be called. If there is nothing to send, it'll return empty. If there is, (at least) some part of it will be returned.\n* For V1, `GetBytesToSend()` is non-empty whenever there is a header or a payload to be sent.\n* For V2, `GetBytesToSend()` is non-empty whenever there are handshake bytes (pubkey, garbage, garbage auth, version packet) or an application packet (encoding a message) to be sent.",
      "created_at": "2023-08-04T12:50:49Z",
      "updated_at": "2023-08-04T14:14:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1284382381",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1284382381"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 921,
      "original_line": 913,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286479195",
      "pull_request_review_id": 1566293059,
      "id": 1286479195,
      "node_id": "PRRC_kwDOABII585Mrh1b",
      "diff_hunk": "@@ -271,10 +271,26 @@ class Transport {\n     // decomposes a message from the context\n     virtual CNetMessage GetMessage(std::chrono::microseconds time, bool& reject_message) = 0;\n \n-    // 2. Sending side functions:\n-\n-    // prepare message for transport (header construction, error-correction computation, payload encryption, etc.)\n-    virtual void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) const = 0;\n+    // 2. Sending side functions, for serializing messages into bytes to be sent over the wire.\n+    // Callers must guarantee that none of these functions are called concurrently w.r.t. one\n+    // another.\n+\n+    /** Whether the last provided message has been sent, and a new one can be provided. */\n+    virtual bool DoneSendingMessage() const noexcept = 0;",
      "path": "src/net.h",
      "position": 46,
      "original_position": 13,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": 1283202700,
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "FWIW, I agree that the `Done` prefix of the method name is quite confusing, for both the reasons Sjors lined out. `CanSetNewMessageToSend()` sounds much better to me (maybe even just `CanSetMessageToSend`, to have the full name of the method included which can be called if `true` is returned?).",
      "created_at": "2023-08-08T00:08:50Z",
      "updated_at": "2023-08-08T00:08:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1286479195",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1286479195"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 282,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292498404",
      "pull_request_review_id": 1575430346,
      "id": 1292498404,
      "node_id": "PRRC_kwDOABII585NCfXk",
      "diff_hunk": "@@ -827,8 +834,46 @@ void V1Transport::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsign\n     memcpy(hdr.pchChecksum, hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n     // serialize header\n-    header.reserve(CMessageHeader::HEADER_SIZE);",
      "path": "src/net.cpp",
      "position": 125,
      "original_position": 36,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": 1283320253,
      "user": {
        "login": "vincenzopalazzo",
        "id": 17150045,
        "node_id": "MDQ6VXNlcjE3MTUwMDQ1",
        "avatar_url": "https://avatars.githubusercontent.com/u/17150045?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/vincenzopalazzo",
        "html_url": "https://github.com/vincenzopalazzo",
        "followers_url": "https://api.github.com/users/vincenzopalazzo/followers",
        "following_url": "https://api.github.com/users/vincenzopalazzo/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/vincenzopalazzo/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/vincenzopalazzo/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/vincenzopalazzo/subscriptions",
        "organizations_url": "https://api.github.com/users/vincenzopalazzo/orgs",
        "repos_url": "https://api.github.com/users/vincenzopalazzo/repos",
        "events_url": "https://api.github.com/users/vincenzopalazzo/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/vincenzopalazzo/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Mh looks like that `header` is no longer used?",
      "created_at": "2023-08-12T21:20:11Z",
      "updated_at": "2023-08-12T21:20:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1292498404",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292498404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 829,
      "original_line": 830,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292945676",
      "pull_request_review_id": 1576023745,
      "id": 1292945676,
      "node_id": "PRRC_kwDOABII585NEMkM",
      "diff_hunk": "@@ -827,8 +834,46 @@ void V1Transport::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsign\n     memcpy(hdr.pchChecksum, hash.begin(), CMessageHeader::CHECKSUM_SIZE);\n \n     // serialize header\n-    header.reserve(CMessageHeader::HEADER_SIZE);",
      "path": "src/net.cpp",
      "position": 125,
      "original_position": 36,
      "commit_id": "b7a7ed70d06ab3f994ff58e3a0c99105ee88ab6e",
      "original_commit_id": "f97adbf3e93e89b1e8ce1dc212e84ac6b2879463",
      "in_reply_to_id": 1283320253,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The `header` argument no longer exists (as the caller doesn't have any notion of headers anymore, that's local to the transport implementation). Instead there is an `m_header_to_send` variable, but it's reused across messages, so (repeated) reserving makes no sense.",
      "created_at": "2023-08-14T03:49:59Z",
      "updated_at": "2023-08-14T03:50:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/28165#discussion_r1292945676",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1292945676"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/28165"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 829,
      "original_line": 830,
      "side": "LEFT"
    }
  ]
}