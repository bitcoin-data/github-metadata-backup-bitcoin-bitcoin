{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122",
    "id": 2134676355,
    "node_id": "PR_kwDOABII585_PJOD",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31122",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31122.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31122.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/57a03569e29a629ccedf339caad59eb2a3a31aeb",
    "number": 31122,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": false,
    "title": "cluster mempool: Implement changeset interface for mempool",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "part of cluster mempool: #30289 \r\n\r\nIt became clear while working on cluster mempool that it would be helpful for transaction validation if we could consider a full set of proposed changes to the mempool -- consisting of a set of transactions to add, and a set of transactions (ie conflicts) to simultaneously remove -- and perform calculations on what the mempool would look like if the proposed changes were to be applied.  Two specific examples of where we'd like to do this:\r\n\r\n- Determining if ancestor/descendant/TRUC limits would be violated (in the future, cluster limits) if either a single transaction or a package of transactions were to be accepted\r\n- Determining if an RBF would make the mempool \"better\", however that idea is defined, both in the single transaction and package of transaction cases\r\n\r\nIn preparation for cluster mempool, I have pulled this reworking of the mempool interface out of #28676 so it can be reviewed on its own.  I have not re-implemented ancestor/descendant limits to be run through the changeset, since with cluster mempool those limits will be going away, so this seems like wasted effort.  However, I have rebased #28676 on top of this branch so reviewers can see what the new mempool interface could look like in the cluster mempool setting.\r\n\r\nThere are some minor behavior changes here, which I believe are inconsequential:\r\n- In the package validation setting, transactions would be added to the mempool before the `ConsensusScriptChecks()` are run. In theory, `ConsensusScriptChecks()` should always pass if the `PolicyScriptChecks()` have passed and it's just a belt-and-suspenders for us, but if somehow they were to diverge then there could be some small behavior change from adding transactions and then removing them, versus never adding them at all.\r\n- The error reporting on `CheckConflictTopology()` has slightly changed due to no longer distinguishing between direct conflicts and indirect conflicts. I believe this should be entirely inconsequential because there shouldn't be a logical difference between those two ideas from the perspective of this function, but I did have to update some error strings in some tests.\r\n- Because, in a package setting, RBFs now happen as part of the entire package being accepted, the logging has changed slightly because we do not know which transaction specifically evicted a given removed transaction. \r\n  -  Specifically, the \"package hash\" is now used to reference the set of transactions that are being accepted, rather than any single txid. The log message relating to package RBF that happen in the `TXPACKAGES` category has been updated as well to include the package hash, so that it's possible to see which specific set of transactions are being referenced by that package hash.\r\n  - Relatedly, the tracepoint logging in the package rbf case has been updated as well to reference the package hash, rather than a transaction hash.",
    "labels": [
      {
        "id": 164208572,
        "node_id": "MDU6TGFiZWwxNjQyMDg1NzI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool",
        "name": "Mempool",
        "color": "fef2c0",
        "default": false
      }
    ],
    "created_at": "2024-10-20T17:46:28Z",
    "updated_at": "2024-10-24T09:58:08Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "3a26a1de9be3c9531853c8c54812454b5ae28166",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "sdaftuar:2024-10-mempool-changeset",
      "ref": "2024-10-mempool-changeset",
      "sha": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 28761781,
        "node_id": "MDEwOlJlcG9zaXRvcnkyODc2MTc4MQ==",
        "name": "bitcoin",
        "full_name": "sdaftuar/bitcoin",
        "owner": {
          "login": "sdaftuar",
          "id": 7463573,
          "node_id": "MDQ6VXNlcjc0NjM1NzM=",
          "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sdaftuar",
          "html_url": "https://github.com/sdaftuar",
          "followers_url": "https://api.github.com/users/sdaftuar/followers",
          "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
          "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
          "repos_url": "https://api.github.com/users/sdaftuar/repos",
          "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/sdaftuar/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sdaftuar/bitcoin",
        "archive_url": "https://api.github.com/repos/sdaftuar/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sdaftuar/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sdaftuar/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sdaftuar/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sdaftuar/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sdaftuar/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sdaftuar/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sdaftuar/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sdaftuar/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sdaftuar/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sdaftuar/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sdaftuar/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sdaftuar/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sdaftuar/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sdaftuar/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sdaftuar/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sdaftuar/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sdaftuar/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sdaftuar/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sdaftuar/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sdaftuar/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sdaftuar/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sdaftuar/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sdaftuar/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sdaftuar/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sdaftuar/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sdaftuar/bitcoin/hooks",
        "svn_url": "https://github.com/sdaftuar/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 2,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 280714,
        "default_branch": "master",
        "open_issues_count": 1,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-10-24T09:58:07Z",
        "created_at": "2015-01-04T02:52:13Z",
        "updated_at": "2024-02-09T22:47:48Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "d94adc7270ba615599eef1e4af849568c155694e",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36268,
        "stargazers_count": 79004,
        "watchers_count": 79004,
        "size": 270057,
        "default_branch": "master",
        "open_issues_count": 651,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-10-24T09:09:46Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-10-24T09:44:59Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 576,
    "deletions": 357,
    "changed_files": 22,
    "commits": 13,
    "review_comments": 30,
    "comments": 4
  },
  "events": [
    {
      "event": "commented",
      "id": 2425149525,
      "node_id": "IC_kwDOABII586QjNhV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2425149525",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-20T17:46:31Z",
      "updated_at": "2024-10-23T19:23:53Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/31122).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2383546169), [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2385159381), [instagibbs](https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2389151891) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30391](https://github.com/bitcoin/bitcoin/pull/30391) (BlockAssembler: return selected packages vsize and feerate by ismaelsadeeq)\n* [#30157](https://github.com/bitcoin/bitcoin/pull/30157) (Fee Estimation via Fee rate Forecasters by ismaelsadeeq)\n* [#29680](https://github.com/bitcoin/bitcoin/pull/29680) (wallet: fix unrelated parent conflict doesn't cause child tx to be marked as conflict by Eunovo)\n* [#28676](https://github.com/bitcoin/bitcoin/pull/28676) ([WIP] Cluster mempool implementation by sdaftuar)\n* [#26593](https://github.com/bitcoin/bitcoin/pull/26593) (tracing: Only prepare tracepoint arguments when actually tracing by 0xB10C)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#issuecomment-2425149525",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122"
    },
    {
      "event": "labeled",
      "id": 14754851711,
      "node_id": "LE_lADOABII586bBCeXzwAAAANvdSt_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14754851711",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-20T17:48:00Z",
      "label": {
        "name": "Mempool",
        "color": "fef2c0"
      }
    },
    {
      "event": "labeled",
      "id": 14755142049,
      "node_id": "LE_lADOABII586bBCeXzwAAAANveZmh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14755142049",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-20T19:19:58Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2425184701,
      "node_id": "IC_kwDOABII586QjWG9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2425184701",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-20T19:19:59Z",
      "updated_at": "2024-10-20T19:19:59Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/31793556861</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#issuecomment-2425184701",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14755665335,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANvgZW3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14755665335",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-20T23:38:55Z"
    },
    {
      "event": "unlabeled",
      "id": 14755962530,
      "node_id": "UNLE_lADOABII586bBCeXzwAAAANvhh6i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14755962530",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-21T00:55:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unsubscribed",
      "id": 14758033128,
      "node_id": "UE_lADOABII586bBCeXzwAAAANvpbbo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14758033128",
      "actor": {
        "login": "gsannikov",
        "id": 52405655,
        "node_id": "MDQ6VXNlcjUyNDA1NjU1",
        "avatar_url": "https://avatars.githubusercontent.com/u/52405655?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gsannikov",
        "html_url": "https://github.com/gsannikov",
        "followers_url": "https://api.github.com/users/gsannikov/followers",
        "following_url": "https://api.github.com/users/gsannikov/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gsannikov/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gsannikov/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gsannikov/subscriptions",
        "organizations_url": "https://api.github.com/users/gsannikov/orgs",
        "repos_url": "https://api.github.com/users/gsannikov/repos",
        "events_url": "https://api.github.com/users/gsannikov/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gsannikov/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-21T05:36:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14763926218,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANv_6LK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14763926218",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-21T12:30:32Z"
    },
    {
      "event": "reviewed",
      "id": 2383546169,
      "node_id": "PRR_kwDOABII586OEgc5",
      "url": null,
      "actor": null,
      "commit_id": "aeefd31c973b9933afcf38109f1f25c76ab9f689",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK, did a first pass",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2383546169",
      "submitted_at": "2024-10-22T02:04:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
    },
    {
      "event": "reviewed",
      "id": 2385138219,
      "node_id": "PRR_kwDOABII586OKlIr",
      "url": null,
      "actor": null,
      "commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2385138219",
      "submitted_at": "2024-10-22T13:02:26Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
    },
    {
      "event": "reviewed",
      "id": 2385150906,
      "node_id": "PRR_kwDOABII586OKoO6",
      "url": null,
      "actor": null,
      "commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2385150906",
      "submitted_at": "2024-10-22T13:07:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
    },
    {
      "event": "reviewed",
      "id": 2385159381,
      "node_id": "PRR_kwDOABII586OKqTV",
      "url": null,
      "actor": null,
      "commit_id": "aeefd31c973b9933afcf38109f1f25c76ab9f689",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "Concept ACK\r\n\r\nThe changes are straightforward to understand, and the large diff is primarily due to changes in the error message and the removal of `addUnchecked`.",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2385159381",
      "submitted_at": "2024-10-22T13:10:16Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14789278739,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANxgnwT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14789278739",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T16:55:28Z"
    },
    {
      "event": "commented",
      "id": 2429804570,
      "node_id": "IC_kwDOABII586Q0-Aa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2429804570",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T17:01:08Z",
      "updated_at": "2024-10-22T17:01:08Z",
      "author_association": "MEMBER",
      "body": "Thanks @glozow and @ismaelsadeeq for the review; I've incorporated some of the comments.  If you have suggestions for how the logging can be improved in the package RBF case (and how the USDT tracing messages can be improved, similarly) please let me know your thoughts.\r\n\r\nAlso, I wanted to flag that the locking is a bit of a mess in this branch.  Initially, I tried to add lock annotations to the `CTxMemPoolChangeSet` functions to guarantee that the mempool itself was locked whenever any of those functions were invoked.  I had mixed results with the compiler understanding those annotations, and ran into a roadblock at some point with a unit test which was taking the mempool lock and should have satisfied the annotations, but the compiler wasn't recognizing the lock as being the same one that needed to be held.  I assume the complication is mostly that the changeset is a different object than the mempool, so one thing I could try is moving all the changeset methods to instead be methods of the mempool itself (which take a changeset as an argument, potentially) -- but that also seems like a little bit of a mess to me, so wasn't sure if that was worth doing.",
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#issuecomment-2429804570",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122"
    },
    {
      "event": "mentioned",
      "id": 14789364117,
      "node_id": "MEE_lADOABII586bBCeXzwAAAANxg8mV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14789364117",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T17:01:10Z"
    },
    {
      "event": "subscribed",
      "id": 14789364142,
      "node_id": "SE_lADOABII586bBCeXzwAAAANxg8mu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14789364142",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T17:01:10Z"
    },
    {
      "event": "mentioned",
      "id": 14789364185,
      "node_id": "MEE_lADOABII586bBCeXzwAAAANxg8nZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14789364185",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T17:01:10Z"
    },
    {
      "event": "subscribed",
      "id": 14789364201,
      "node_id": "SE_lADOABII586bBCeXzwAAAANxg8np",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14789364201",
      "actor": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T17:01:10Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14791754763,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANxqEQL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14791754763",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T19:49:45Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14793672164,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANxxYXk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14793672164",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T22:10:08Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14793691023,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANxxc-P",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14793691023",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T22:12:00Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI1NDYzNDJjYWYzZDJhM2E0MjgzNjQwNTJlNjkzYWNmN2YzNjk5NWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b546342caf3d2a3a428364052e693acf7f36995a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b546342caf3d2a3a428364052e693acf7f36995a",
      "tree": {
        "sha": "45b483e9a91a42699adc0ef53887a11f764e7780",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/45b483e9a91a42699adc0ef53887a11f764e7780"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e8f72aefd20049eac81b150e7f0d33709acd18ed",
          "sha": "e8f72aefd20049eac81b150e7f0d33709acd18ed",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e8f72aefd20049eac81b150e7f0d33709acd18ed"
        }
      ],
      "message": "Add package hash to package-rbf log message",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-23T16:46:00Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-23T16:24:41Z"
      },
      "sha": "b546342caf3d2a3a428364052e693acf7f36995a"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDE5Y2VmOTViNTIwN2ZiMzA2MDY5MTIyZWYyYWQzYzViMjA0MDY2ZDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/19cef95b5207fb306069122ef2ad3c5b204066d7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/19cef95b5207fb306069122ef2ad3c5b204066d7",
      "tree": {
        "sha": "4fcbc2756561fd5fc7e8f62ee93a068259217fe0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4fcbc2756561fd5fc7e8f62ee93a068259217fe0"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b546342caf3d2a3a428364052e693acf7f36995a",
          "sha": "b546342caf3d2a3a428364052e693acf7f36995a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b546342caf3d2a3a428364052e693acf7f36995a"
        }
      ],
      "message": "refactor: introduce mempool changesets\n\nIntroduce the CTxMemPoolChangeSet, a wrapper for creating (potential) new\nmempool entries and removing conflicts.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-23T16:46:00Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-08-23T22:45:49Z"
      },
      "sha": "19cef95b5207fb306069122ef2ad3c5b204066d7"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM3ZWU5M2VkYjk5ZTMzZmZkZjAwZGNiY2JlZGRjMGYyYWU0NDUxMmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a",
      "tree": {
        "sha": "bb8c63850ad7097d878ce5b5edfe7aafbf20eb0c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bb8c63850ad7097d878ce5b5edfe7aafbf20eb0c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/19cef95b5207fb306069122ef2ad3c5b204066d7",
          "sha": "19cef95b5207fb306069122ef2ad3c5b204066d7",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/19cef95b5207fb306069122ef2ad3c5b204066d7"
        }
      ],
      "message": "Move changeset from workspace to subpackage",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-23T16:46:00Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-08-24T10:53:43Z"
      },
      "sha": "c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14823422433,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAANzi3nh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14823422433",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T16:46:15Z"
    },
    {
      "event": "labeled",
      "id": 14824292920,
      "node_id": "LE_lADOABII586bBCeXzwAAAANzmMI4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14824292920",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T17:12:19Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2432901486,
      "node_id": "IC_kwDOABII586RAyFu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2432901486",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T17:12:20Z",
      "updated_at": "2024-10-23T17:12:20Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/31962210262</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#issuecomment-2432901486",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31122"
    },
    {
      "event": "reviewed",
      "id": 2389151891,
      "node_id": "PRR_kwDOABII586OZ5CT",
      "url": null,
      "actor": null,
      "commit_id": "dcbfe98b7c2314c4f50c5a0f1ef6867ce444c168",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "body": "first pass through, concept ACK",
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#pullrequestreview-2389151891",
      "submitted_at": "2024-10-23T19:23:50Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
    },
    {
      "event": "unlabeled",
      "id": 14829380137,
      "node_id": "UNLE_lADOABII586bBCeXzwAAAANz5mIp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14829380137",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T19:44:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14845466657,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAAN029gh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14845466657",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T09:37:54Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDkxNDZkNTI3ZGE4MDNiNjI5Mzc1NWU0YWRkZWUyODM1M2M1ZWEzYmI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9146d527da803b6293755e4addee28353c5ea3bb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9146d527da803b6293755e4addee28353c5ea3bb",
      "tree": {
        "sha": "e79be99a28f4d782613e11832d40b25a8fc21616",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e79be99a28f4d782613e11832d40b25a8fc21616"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a",
          "sha": "c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c7ee93edb99e33ffdf00dcbcbeddc0f2ae44512a"
        }
      ],
      "message": "Move LimitMempoolSize to take place outside FinalizeSubpackage",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-08-24T11:26:09Z"
      },
      "sha": "9146d527da803b6293755e4addee28353c5ea3bb"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDM4Yjc1ZWJkMzcyNjdhYjBhZTE3MDM1YWI0NzliYjk1YTdlY2IyOGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/38b75ebd37267ab0ae17035ab479bb95a7ecb28c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/38b75ebd37267ab0ae17035ab479bb95a7ecb28c",
      "tree": {
        "sha": "3eee206c2709ea7b0d1a6835d2bec55b9342b24d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3eee206c2709ea7b0d1a6835d2bec55b9342b24d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9146d527da803b6293755e4addee28353c5ea3bb",
          "sha": "9146d527da803b6293755e4addee28353c5ea3bb",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9146d527da803b6293755e4addee28353c5ea3bb"
        }
      ],
      "message": "Clean up FinalizeSubpackage to avoid workspace-specific information\n\nAlso, use the \"package hash\" for logging replacements in the package rbf\nsetting.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-08-24T11:26:09Z"
      },
      "sha": "38b75ebd37267ab0ae17035ab479bb95a7ecb28c"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBjMmIxM2U3ZGNmY2EwYWYxZjE4MmRlODQyMmJlNGFhYzI4NmRiZWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0c2b13e7dcfca0af1f182de8422be4aac286dbef",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0c2b13e7dcfca0af1f182de8422be4aac286dbef",
      "tree": {
        "sha": "2e0ef09da327139b6c948115fa7bd43d451f218e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2e0ef09da327139b6c948115fa7bd43d451f218e"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/38b75ebd37267ab0ae17035ab479bb95a7ecb28c",
          "sha": "38b75ebd37267ab0ae17035ab479bb95a7ecb28c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/38b75ebd37267ab0ae17035ab479bb95a7ecb28c"
        }
      ],
      "message": "Apply mempool changeset transactions directly into the mempool\n\nRather than individually calling addUnchecked for each transaction added in a\nchangeset (after removing all the to-be-removed transactions), instead we can\ntake advantage of boost::multi_index's splicing features to extract and insert\nentries directly from the staging multi_index into mapTx.\n\nThis has the immediate advantage of saving allocation overhead for mempool\nentries which have already been allocated once. This also means that the memory\nlocations of mempool entries will not change when transactions go from staging\nto the main mempool.\n\nAdditionally, eliminate addUnchecked and require all new transactions to enter\nthe mempool via a CTxMemPoolChangeSet.",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-10T18:59:23Z"
      },
      "sha": "0c2b13e7dcfca0af1f182de8422be4aac286dbef"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFjOGY3ZjhmMmI2NjFmNTk2ZDZhYjhlMTRiMzgxZGVhOTgxYjcwYWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1c8f7f8f2b661f596d6ab8e14b381dea981b70af",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1c8f7f8f2b661f596d6ab8e14b381dea981b70af",
      "tree": {
        "sha": "fe0c6883ec16b018b6439831e1588ffecd0783d6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fe0c6883ec16b018b6439831e1588ffecd0783d6"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0c2b13e7dcfca0af1f182de8422be4aac286dbef",
          "sha": "0c2b13e7dcfca0af1f182de8422be4aac286dbef",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0c2b13e7dcfca0af1f182de8422be4aac286dbef"
        }
      ],
      "message": "Enforce that there is only one changeset at a time",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-14T14:19:44Z"
      },
      "sha": "1c8f7f8f2b661f596d6ab8e14b381dea981b70af"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDM2YzhjZWVjMGQ4ZmM0ZmEwYjY5YWUwMjdmYTM3NGE0MmRjOGZiMjQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24",
      "tree": {
        "sha": "5cc88ae7388e886db40c144a0984f3499b56d1f1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5cc88ae7388e886db40c144a0984f3499b56d1f1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1c8f7f8f2b661f596d6ab8e14b381dea981b70af",
          "sha": "1c8f7f8f2b661f596d6ab8e14b381dea981b70af",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1c8f7f8f2b661f596d6ab8e14b381dea981b70af"
        }
      ],
      "message": "Duplicate transactions are not permitted within a changeset",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-14T14:27:27Z"
      },
      "sha": "36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQzOTBhZjhhYjQzOTBhMzMxNjE4ZjhlMGE1ZmJmNDBjOTM5NjkzN2E",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4390af8ab4390a331618f8e0a5fbf40c9396937a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4390af8ab4390a331618f8e0a5fbf40c9396937a",
      "tree": {
        "sha": "b01410633d6f740510fec4796dcd60612663f1b0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b01410633d6f740510fec4796dcd60612663f1b0"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24",
          "sha": "36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/36c8ceec0d8fc4fa0b69ae027fa374a42dc8fb24"
        }
      ],
      "message": "Don't distinguish between direct conflicts and all conflicts when doing cluster-size-2-rbf checks",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-14T15:11:17Z"
      },
      "sha": "4390af8ab4390a331618f8e0a5fbf40c9396937a"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI5YmIxOTExMjhhNWZlYjBmOTQ3MTRkYWQwYWIyODMzMTNhNDc3MGQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b9bb191128a5feb0f94714dad0ab283313a4770d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b9bb191128a5feb0f94714dad0ab283313a4770d",
      "tree": {
        "sha": "6dbb0191483c1c804e29b07f55c3ab23e1470132",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6dbb0191483c1c804e29b07f55c3ab23e1470132"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4390af8ab4390a331618f8e0a5fbf40c9396937a",
          "sha": "4390af8ab4390a331618f8e0a5fbf40c9396937a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4390af8ab4390a331618f8e0a5fbf40c9396937a"
        }
      ],
      "message": "Move CalculateChunksForRBF() to the mempool changeset",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-16T13:09:44Z"
      },
      "sha": "b9bb191128a5feb0f94714dad0ab283313a4770d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGI0ZGZhZjZjNWIxZDBiYTJiOTdhNjUxOWVlMTgzMGZmMmJjZmQ4YmY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf",
      "tree": {
        "sha": "c33ec5bd3c68301f41aedf915ab9eeda5fb4a0c7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c33ec5bd3c68301f41aedf915ab9eeda5fb4a0c7"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b9bb191128a5feb0f94714dad0ab283313a4770d",
          "sha": "b9bb191128a5feb0f94714dad0ab283313a4770d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b9bb191128a5feb0f94714dad0ab283313a4770d"
        }
      ],
      "message": "Move prioritisation into changeset",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-16T20:36:36Z"
      },
      "sha": "b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDlmZTRhNWU3ZDBmNDFmMGRhYmJmM2IzNThiZjYzMTU3MjBkMDc2ZWM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec",
      "tree": {
        "sha": "c1069d309f3d5841b753509d3976a26dfddcc9b3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c1069d309f3d5841b753509d3976a26dfddcc9b3"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf",
          "sha": "b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/b4dfaf6c5b1d0ba2b97a6519ee1830ff2bcfd8bf"
        }
      ],
      "message": "Assume() no mempool removals are permitted while changeset is outstanding",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2024-10-18T14:36:36Z"
      },
      "sha": "9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU3YTAzNTY5ZTI5YTYyOWNjZWRmMzM5Y2FhZDU5ZWIyYTNhMzFhZWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "tree": {
        "sha": "a0a8f00616ef2c41f067bdcfc217b3511f058fba",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a0a8f00616ef2c41f067bdcfc217b3511f058fba"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec",
          "sha": "9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9fe4a5e7d0f41f0dabbf3b358bf6315720d076ec"
        }
      ],
      "message": "Ensure that we don't add duplicate transactions in rbf fuzz tests",
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-24T09:54:23Z"
      },
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@chaincode.com",
        "date": "2024-10-19T14:18:53Z"
      },
      "sha": "57a03569e29a629ccedf339caad59eb2a3a31aeb"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14845813514,
      "node_id": "HRFPE_lADOABII586bBCeXzwAAAAN04SMK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14845813514",
      "actor": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T09:58:08Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809704580",
      "pull_request_review_id": 2383546169,
      "id": 1809704580,
      "node_id": "PRRC_kwDOABII585r3eaE",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle AddTx(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void RemoveTx(CTxMemPool::txiter it) { m_all_conflicts.insert(it); }",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 16,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "fc03c77f8b9a50459076bce3000d18e687f52820",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "`StageAddition` and `StageRemoval` seem a bit more intuitive, but it's a nit",
      "created_at": "2024-10-22T00:57:53Z",
      "updated_at": "2024-10-22T02:04:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1809704580",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809704580"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 830,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 831,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809735446",
      "pull_request_review_id": 2383546169,
      "id": 1809735446,
      "node_id": "PRRC_kwDOABII585r3l8W",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle AddTx(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void RemoveTx(CTxMemPool::txiter it) { m_all_conflicts.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_stage_tx;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order\n+        // map from the stage_tx index to the ancestors for the transaction\n+        std::map<CTxMemPool::txiter, CTxMemPool::setEntries, CompareIteratorByHash> m_ancestors;\n+        CTxMemPool::setEntries m_all_conflicts;",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 34,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "fc03c77f8b9a50459076bce3000d18e687f52820",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Similarly, `m_stage_tx` and `m_all_conflicts` could be `m_to_add` and `m_to_remove`?",
      "created_at": "2024-10-22T01:50:03Z",
      "updated_at": "2024-10-22T02:04:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1809735446",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809735446"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 845,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809737214",
      "pull_request_review_id": 2383546169,
      "id": 1809737214,
      "node_id": "PRRC_kwDOABII585r3mX-",
      "diff_hunk": "@@ -847,7 +847,14 @@ class CTxMemPool\n         friend class CTxMemPool;\n     };\n \n-    std::unique_ptr<CTxMemPoolChangeSet> GetChangeSet() EXCLUSIVE_LOCKS_REQUIRED(cs) { return std::make_unique<CTxMemPoolChangeSet>(this); }\n+    std::unique_ptr<CTxMemPoolChangeSet> GetChangeSet() EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        Assume(m_changeset == nullptr);\n+        auto ret = std::make_unique<CTxMemPoolChangeSet>(this);\n+        m_changeset = ret.get();\n+        return ret;\n+    }\n+\n+    CTxMemPoolChangeSet* m_changeset GUARDED_BY(cs){nullptr};",
      "path": "src/txmempool.h",
      "position": 124,
      "original_position": 21,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "1282bc0ac2820c1e7217c5c974c0d6756a48d820",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Question: why isn't this a `shared_ptr` / what's the purpose of the `unique_ptr`? I get that there should only ever be one changeset, but I'm confused by the fact that this carries a copy of the underlying raw pointer, as the `unique_ptr` then doesn't seem very unique.",
      "created_at": "2024-10-22T01:53:37Z",
      "updated_at": "2024-10-22T02:04:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1809737214",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809737214"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": 850,
      "original_start_line": 852,
      "start_side": "RIGHT",
      "line": 855,
      "original_line": 855,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809741165",
      "pull_request_review_id": 2383546169,
      "id": 1809741165,
      "node_id": "PRRC_kwDOABII585r3nVt",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": null,
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "You could use `m_subpackage.m_total_modified_fees, m_subpackage.m_total_vsize` here? Unless you feel that `CTxMemPoolChangeSet::GetAggregateFeeRate` will be useful in the future.",
      "created_at": "2024-10-22T02:00:17Z",
      "updated_at": "2024-10-22T02:04:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1809741165",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1809741165"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1312,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1810686447",
      "pull_request_review_id": 2385138219,
      "id": 1810686447,
      "node_id": "PRRC_kwDOABII585r7OHv",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 50,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Should this be just logged once; i.e after replacing the transactions.",
      "created_at": "2024-10-22T13:02:25Z",
      "updated_at": "2024-10-22T13:02:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1810686447",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1810686447"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 1313,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1330,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1810694092",
      "pull_request_review_id": 2385150906,
      "id": 1810694092,
      "node_id": "PRRC_kwDOABII585r7P_M",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }\n         TRACE7(mempool, replaced,\n                 it->GetTx().GetHash().data(),\n                 it->GetTxSize(),\n                 it->GetFee(),\n                 std::chrono::duration_cast<std::chrono::duration<std::uint64_t>>(it->GetTime()).count(),\n-                hash.data(),\n-                workspaces[0].m_tx_handle->GetTxSize(),\n-                workspaces[0].m_tx_handle->GetFee()\n+                m_subpackage.m_changeset->GetTx(0).GetHash().data(),",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 59,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Why are we only tracing the first tx in the package",
      "created_at": "2024-10-22T13:07:08Z",
      "updated_at": "2024-10-22T13:07:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1810694092",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1810694092"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1329,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811061628",
      "pull_request_review_id": 2385759109,
      "id": 1811061628,
      "node_id": "PRRC_kwDOABII585r8pt8",
      "diff_hunk": "@@ -847,7 +847,14 @@ class CTxMemPool\n         friend class CTxMemPool;\n     };\n \n-    std::unique_ptr<CTxMemPoolChangeSet> GetChangeSet() EXCLUSIVE_LOCKS_REQUIRED(cs) { return std::make_unique<CTxMemPoolChangeSet>(this); }\n+    std::unique_ptr<CTxMemPoolChangeSet> GetChangeSet() EXCLUSIVE_LOCKS_REQUIRED(cs) {\n+        Assume(m_changeset == nullptr);\n+        auto ret = std::make_unique<CTxMemPoolChangeSet>(this);\n+        m_changeset = ret.get();\n+        return ret;\n+    }\n+\n+    CTxMemPoolChangeSet* m_changeset GUARDED_BY(cs){nullptr};",
      "path": "src/txmempool.h",
      "position": 124,
      "original_position": 21,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "1282bc0ac2820c1e7217c5c974c0d6756a48d820",
      "in_reply_to_id": 1809737214,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This only exists for sanity checking that we don't have more than one changeset at a time.  We could just as easily replace this with a `bool`; I made it a pointer mostly for debugging purposes, if the `Assume()` were ever hit.\r\n\r\nThe idea behind the `unique_ptr` is that I wanted all the state in the ChangeSet to magically go away whenever the object goes out of scope, so that I didn't have to explicitly clean up state everywhere that a transaction might fail validation (which seems like a lot of places).  In this PR, there's not a ton of state, but I expect that when we implement cluster mempool that we'll be creating similar staging data structures within the `TxGraph` layer that will exist one level below the mempool (for computing clusters and feerate diagrams for candidate transactions), and I thought this mechanism of ending a staging when the changeset goes out of scope would be an easy way to manage things at that layer as well.  So in the future you could imagine that in the `CTxMemPoolChangeSet` constructor, we might initiate a staging in the underlying `TxGraph`; in the mempool `Apply()` function we might also apply the staging to the `TxGraph`; and in the `CTxMemPoolChangeSet` destructor we might abort a staging in the underlying `TxGraph`.\r\n\r\nThe paradigm I'm looking for is that you can have at most one changeset at a time, and when there's a changeset outstanding that serves as a lock on the mempool so that you can't otherwise add/remove things (except via the changeset) until the changes are either applied or aborted, and the changeset is the destroyed.  However if there's a better way to implement that than what I tried here, I'm certainly open to suggestions.",
      "created_at": "2024-10-22T16:39:56Z",
      "updated_at": "2024-10-22T16:39:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811061628",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811061628"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": 850,
      "original_start_line": 852,
      "start_side": "RIGHT",
      "line": 855,
      "original_line": 855,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811072822",
      "pull_request_review_id": 2385780065,
      "id": 1811072822,
      "node_id": "PRRC_kwDOABII585r8sc2",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 50,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810686447,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I tried to make this code analogous to the old code, which repeated information for each transaction.  I'm open to changing the logging but I am always a little afraid of breaking user's scripts or habits if people are used to grepping for a transaction ID and seeing more information? (Though I guess this PR already is breaking the logging for package RBF... so maybe not a big concern.)",
      "created_at": "2024-10-22T16:48:25Z",
      "updated_at": "2024-10-22T16:48:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811072822",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811072822"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 1313,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1330,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811074008",
      "pull_request_review_id": 2385781647,
      "id": 1811074008,
      "node_id": "PRRC_kwDOABII585r8svY",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }\n         TRACE7(mempool, replaced,\n                 it->GetTx().GetHash().data(),\n                 it->GetTxSize(),\n                 it->GetFee(),\n                 std::chrono::duration_cast<std::chrono::duration<std::uint64_t>>(it->GetTime()).count(),\n-                hash.data(),\n-                workspaces[0].m_tx_handle->GetTxSize(),\n-                workspaces[0].m_tx_handle->GetFee()\n+                m_subpackage.m_changeset->GetTx(0).GetHash().data(),",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 59,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810694092,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not sure if the tracing API is well-specified for package based replacement.  I'm open to doing something different than what I propose here though, suggestions?",
      "created_at": "2024-10-22T16:49:14Z",
      "updated_at": "2024-10-22T16:49:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811074008",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811074008"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1329,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811083143",
      "pull_request_review_id": 2385796227,
      "id": 1811083143,
      "node_id": "PRRC_kwDOABII585r8u-H",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle AddTx(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void RemoveTx(CTxMemPool::txiter it) { m_all_conflicts.insert(it); }",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 16,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "fc03c77f8b9a50459076bce3000d18e687f52820",
      "in_reply_to_id": 1809704580,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed, done.",
      "created_at": "2024-10-22T16:55:51Z",
      "updated_at": "2024-10-22T16:55:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811083143",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811083143"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 830,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 831,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811083287",
      "pull_request_review_id": 2385796501,
      "id": 1811083287,
      "node_id": "PRRC_kwDOABII585r8vAX",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle AddTx(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void RemoveTx(CTxMemPool::txiter it) { m_all_conflicts.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_stage_tx;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order\n+        // map from the stage_tx index to the ancestors for the transaction\n+        std::map<CTxMemPool::txiter, CTxMemPool::setEntries, CompareIteratorByHash> m_ancestors;\n+        CTxMemPool::setEntries m_all_conflicts;",
      "path": "src/txmempool.h",
      "position": null,
      "original_position": 34,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "fc03c77f8b9a50459076bce3000d18e687f52820",
      "in_reply_to_id": 1809735446,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed, done.",
      "created_at": "2024-10-22T16:56:00Z",
      "updated_at": "2024-10-22T16:56:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811083287",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811083287"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 845,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811084319",
      "pull_request_review_id": 2385798008,
      "id": 1811084319,
      "node_id": "PRRC_kwDOABII585r8vQf",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1809741165,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks that is much better; the only reason I had introduced `GetAggregateFeeRate()` was for access in this one place, so now that is gone.",
      "created_at": "2024-10-22T16:56:43Z",
      "updated_at": "2024-10-22T16:56:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1811084319",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1811084319"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1312,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812617677",
      "pull_request_review_id": 2388430909,
      "id": 1812617677,
      "node_id": "PRRC_kwDOABII585sClnN",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 50,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810686447,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yeah will break existing grepping scripts, but I think we will need to do this anyway to improve the logging for package replacements. \r\n\r\nI think we should log the new package or new transaction replacement only once after logging all the replaced transactions:\r\n\r\n1. First, log all replaced transactions with their ID, witness, fee, and size.\r\n2. Then:\r\n   - For a single transaction replacement, log its ID, witness, fee, and size.\r\n   - For a package replacement, log that a new package has been received, along with the package's number of transactions, fees, and vsize. Then, log each transaction ID and witness in the package.\r\n\r\nThis approach preserves the previous logging behavior for individual transactions.\r\nCurrently, in this PR, for a single transaction, the logs show the following:\r\n\r\n```\r\n2024-10-23T10:26:03.802679Z [httpworker.3] [src/validation.cpp:1310] [FinalizeSubpackage] [mempool] replacing mempool tx 6ae77ff52efae84e0cca125e4b5acfe2f3415298f4f98e850b40f89a2aa5990f (wtxid=57f1edd04c15f6532cdddf4a7c8393f5c5e5584f00003855df8c490053027ac8, fees=10000000, vsize=104).\r\n2024-10-23T10:26:03.802686Z [httpworker.3] [src/validation.cpp:1317] [FinalizeSubpackage] [mempool] New tx e089a6391ae23d41baeed46fb1d8ac04cd0db73e82b4b330275f7d7cafcda33c (wtxid=db89e399619446928fb74a41a5207164beb0fd99972ba147b806a6a24f140e13, fees=490000000, vsize=104)\r\n```\r\n\r\nFor a package, we see duplicate removal logs, which makes it seem like multiple packages are being added for each replacement:\r\n\r\n```\r\n2024-10-23T10:30:28.361089Z [httpworker.3] [src/validation.cpp:1310] [FinalizeSubpackage] [mempool] replacing mempool tx 05ad4c0db1a2fe169acd15bf5d8d1f4fa0ff834b5e8259baab4219f3d20b8991 (wtxid=39676091a39b5f77ee0865c2c52ac4bb8378ff7283fc1668738155ec247c3868, fees=10000, vsize=104).\r\n2024-10-23T10:30:28.361110Z [httpworker.3] [src/validation.cpp:1322] [FinalizeSubpackage] [mempool] New package with 2 txs, fees=50000, vsize=208\r\n2024-10-23T10:30:28.361127Z [httpworker.3] [src/validation.cpp:1310] [FinalizeSubpackage] [mempool] replacing mempool tx 992204e731c78b7afc6e4b17e14adf0f6b93d472fddc4ba184dd86e1899a83d1 (wtxid=05d9f03194089441530d7503a12b7f36086a2c41deac0960e238e426ed59e5f4, fees=10000, vsize=104).\r\n2024-10-23T10:30:28.361139Z [httpworker.3] [src/validation.cpp:1322] [FinalizeSubpackage] [mempool] New package with 2 txs, fees=50000, vsize=208\r\n```\r\n\r\nWith the idea above, the logs for individual transactions will remain the same, but for packages, the logs will look like this:\r\n\r\n```\r\n2024-10-23T11:46:49.459665Z [httpworker.2] [src/validation.cpp:1312] [operator()] [mempool] Replacing mempool tx 05ad4c0db1a2fe169acd15bf5d8d1f4fa0ff834b5e8259baab4219f3d20b8991 (wtxid=39676091a39b5f77ee0865c2c52ac4bb8378ff7283fc1668738155ec247c3868, fees=10000, vsize=104).\r\n2024-10-23T11:46:49.459683Z [httpworker.2] [src/validation.cpp:1312] [operator()] [mempool] Replacing mempool tx 992204e731c78b7afc6e4b17e14adf0f6b93d472fddc4ba184dd86e1899a83d1 (wtxid=05d9f03194089441530d7503a12b7f36086a2c41deac0960e238e426ed59e5f4, fees=10000, vsize=104).\r\n2024-10-23T11:46:49.459696Z [httpworker.2] [src/validation.cpp:1342] [FinalizeSubpackage] [mempool] New package (txs=2, fees=50000, vsize=208)\r\n2024-10-23T11:46:49.459709Z [httpworker.2] [src/validation.cpp:1330] [operator()] [mempool] tx acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe6831535e8cf8ce662ba36b6331fa072babc06f08c)\r\n2024-10-23T11:46:49.459721Z [httpworker.2] [src/validation.cpp:1330] [operator()] [mempool] tx 28deb9d38a4490c3f542f0fd173805eb6c2c8309aa12d5e1669fc71a453d23fe (wtxid=8f8a74f38ed9deada97ef37bb5138b46d16f448da7585e33fc861b4142f764d5)\r\n```\r\n\r\nThis will make the logs much easier to parse with a script. \r\nSee naive diff implementing this change suggestion https://github.com/ismaelsadeeq/bitcoin/commit/555b05680d8e782fbe0d7b4807d2fce23f512b44",
      "created_at": "2024-10-23T12:14:48Z",
      "updated_at": "2024-10-23T12:14:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1812617677",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812617677"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 1313,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1330,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812631628",
      "pull_request_review_id": 2388452698,
      "id": 1812631628,
      "node_id": "PRRC_kwDOABII585sCpBM",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }\n         TRACE7(mempool, replaced,\n                 it->GetTx().GetHash().data(),\n                 it->GetTxSize(),\n                 it->GetFee(),\n                 std::chrono::duration_cast<std::chrono::duration<std::uint64_t>>(it->GetTime()).count(),\n-                hash.data(),\n-                workspaces[0].m_tx_handle->GetTxSize(),\n-                workspaces[0].m_tx_handle->GetFee()\n+                m_subpackage.m_changeset->GetTx(0).GetHash().data(),",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 59,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810694092,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Its not specified, I think we have to specify tracing api for packages;\r\n\r\nShould be something like\r\n\r\n#### Tracepoint `mempool:replaced_by_package`\r\n\r\nIs called when a transaction in the node's mempool is getting replaced by a package.\r\nPasses information about the replaced transaction and  the replacement package.\r\n\r\nArguments passed:\r\n1. Replaced transaction ID (hash) as `pointer to unsigned chars` (i.e. 32 bytes in little-endian)\r\n2. Replaced transaction virtual size as `int32`\r\n3. Replaced transaction fee as `int64`\r\n4. Replaced transaction mempool entry time (epoch) as `uint64`\r\n5. Replacement package virtual size as `int32`\r\n6. Replacement package fee as `int64`\r\n\r\n",
      "created_at": "2024-10-23T12:21:00Z",
      "updated_at": "2024-10-23T12:21:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1812631628",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812631628"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1329,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813013432",
      "pull_request_review_id": 2389151891,
      "id": 1813013432,
      "node_id": "PRRC_kwDOABII585sEGO4",
      "diff_hunk": "@@ -1306,25 +1312,23 @@ bool MemPoolAccept::Finalize(const ATMPArgs& args, Workspace& ws)\n                 it->GetTxSize(),\n                 hash.ToString(),\n                 tx.GetWitnessHash().ToString(),\n-                entry->GetFee(),\n-                entry->GetTxSize());\n+                ws.m_tx_handle->GetFee(),\n+                ws.m_tx_handle->GetTxSize());\n         TRACE7(mempool, replaced,\n                 it->GetTx().GetHash().data(),\n                 it->GetTxSize(),\n                 it->GetFee(),\n                 std::chrono::duration_cast<std::chrono::duration<std::uint64_t>>(it->GetTime()).count(),\n                 hash.data(),\n-                entry->GetTxSize(),\n-                entry->GetFee()\n+                ws.m_tx_handle->GetTxSize(),\n+                ws.m_tx_handle->GetFee()\n         );\n         m_subpackage.m_replaced_transactions.push_back(it->GetSharedTx());\n     }\n-    m_pool.RemoveStaged(m_subpackage.m_all_conflicts, false, MemPoolRemovalReason::REPLACED);\n+    ws.m_changeset->Apply();\n     // Don't attempt to process the same conflicts repeatedly during subpackage evaluation:\n     // they no longer exist on subsequent calls to Finalize() post-RemoveStaged",
      "path": "src/validation.cpp",
      "position": 207,
      "original_position": 107,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "88e109f1091561639aca323cb455180317a12b32",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "s/RemoveStaged/Apply/",
      "created_at": "2024-10-23T15:13:14Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813013432",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813013432"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1346,
      "original_line": 1346,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813066539",
      "pull_request_review_id": 2389151891,
      "id": 1813066539,
      "node_id": "PRRC_kwDOABII585sETMr",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle StageAddition(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void StageRemoval(CTxMemPool::txiter it) { m_to_remove.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_to_add;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order\n+        // map from the m_to_add index to the ancestors for the transaction\n+        std::map<CTxMemPool::txiter, CTxMemPool::setEntries, CompareIteratorByHash> m_ancestors;",
      "path": "src/txmempool.h",
      "position": 111,
      "original_position": 33,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "88e109f1091561639aca323cb455180317a12b32",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "note: circa 88e109f1091561639aca323cb455180317a12b32 this field is set but never read from making the `CalculateMemPoolAncestors` wrapper a bit mysterious. Could a motivating comment be given?",
      "created_at": "2024-10-23T15:41:49Z",
      "updated_at": "2024-10-23T19:24:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813066539",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813066539"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 842,
      "original_line": 842,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813069337",
      "pull_request_review_id": 2389151891,
      "id": 1813069337,
      "node_id": "PRRC_kwDOABII585sET4Z",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle StageAddition(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void StageRemoval(CTxMemPool::txiter it) { m_to_remove.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_to_add;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order",
      "path": "src/txmempool.h",
      "position": 109,
      "original_position": 31,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "88e109f1091561639aca323cb455180317a12b32",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "what order should caller call things, e.g. `StageAddition`? I think some notes for this class would help with assumptions for caller.",
      "created_at": "2024-10-23T15:43:07Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813069337",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813069337"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 840,
      "original_line": 840,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813100135",
      "pull_request_review_id": 2389151891,
      "id": 1813100135,
      "node_id": "PRRC_kwDOABII585sEbZn",
      "diff_hunk": "@@ -1312,20 +1315,21 @@ bool MemPoolAccept::Finalize(const ATMPArgs& args, Workspace& ws)\n                 it->GetTxSize(),\n                 hash.ToString(),\n                 tx.GetWitnessHash().ToString(),\n-                ws.m_tx_handle->GetFee(),\n-                ws.m_tx_handle->GetTxSize());\n+                workspaces[0].m_tx_handle->GetFee(),\n+                workspaces[0].m_tx_handle->GetTxSize());\n         TRACE7(mempool, replaced,\n                 it->GetTx().GetHash().data(),\n                 it->GetTxSize(),\n                 it->GetFee(),\n                 std::chrono::duration_cast<std::chrono::duration<std::uint64_t>>(it->GetTime()).count(),\n                 hash.data(),\n-                ws.m_tx_handle->GetTxSize(),\n-                ws.m_tx_handle->GetFee()\n+                workspaces[0].m_tx_handle->GetTxSize(),\n+                workspaces[0].m_tx_handle->GetFee()\n         );\n         m_subpackage.m_replaced_transactions.push_back(it->GetSharedTx());\n     }\n-    ws.m_changeset->Apply();\n+    m_subpackage.m_changeset->Apply();\n+    m_subpackage.m_changeset.reset();",
      "path": "src/validation.cpp",
      "position": 205,
      "original_position": 118,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "32101330ec6f6e9c4d467dec370c848cf4d14f23",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I think \"cleanup\" of `m_subpackage` can now all be managed inside `ClearSubPackageState`, including the `m_all_conflicts` clear below.",
      "created_at": "2024-10-23T16:02:43Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813100135",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813100135"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1344,
      "original_line": 1344,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813104310",
      "pull_request_review_id": 2389151891,
      "id": 1813104310,
      "node_id": "PRRC_kwDOABII585sEca2",
      "diff_hunk": "@@ -1381,7 +1381,13 @@ void CTxMemPool::CTxMemPoolChangeSet::Apply()\n     m_pool->RemoveStaged(m_to_remove, false, MemPoolRemovalReason::REPLACED);\n     for (size_t i=0; i<m_entry_vec.size(); ++i) {\n         auto tx_entry = m_entry_vec[i];\n-        m_pool->addUnchecked(*tx_entry);\n+        if (i == 0 && m_ancestors.count(tx_entry)) {",
      "path": "src/txmempool.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "32101330ec6f6e9c4d467dec370c848cf4d14f23",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "as of 32101330ec6f6e9c4d467dec370c848cf4d14f23 , now the *first* entry of m_entry_vec now uses `m_ancestors` but no others.\r\n\r\nAm I understanding the extend of its use?",
      "created_at": "2024-10-23T16:05:18Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813104310",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813104310"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813106158",
      "pull_request_review_id": 2389324835,
      "id": 1813106158,
      "node_id": "PRRC_kwDOABII585sEc3u",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 50,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810686447,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Thanks for pointing out how the logging looks in this PR -- my intent was to preserve the existing behavior in the single transaction replacement case, and not introduce a new line break.  (I think the behavior of `LogDebug()` changed recently in #30929, which made what I wrote here no longer do what I expected.)\r\n\r\nSo we're all on the same page, here's what the logging looks like today (I grabbed this output from the functional tests `feature_rbf.py` and `mempool_package_rbf.py`), in the single transaction and package replacement cases:\r\n\r\nsingle transaction:\r\n```\r\n2024-10-23T14:08:01.250431Z [httpworker.3] [../../src/validation.cpp:1302] [Finalize] [mempool] replacing mempool tx 38335600f2465c0f8bb2b86d5830a34851d86fa879800c0e1434ddfc78c42898 (wtxid=c033cd3efd301c369d66cf759769159609471bd4f9efb3ee30e7209e57b74778, fees=31200, vsize=104). New tx b4001854dc577e21fde7acb4016a9179c3dd5a5af076295d8b0b7c47c35e2032 (wtxid=1f0a0b164999ac0843a8865df347e4fb63191ea3eec539d685b94dcdbeb39fae, fees=10031200, vsize=104)\r\n```\r\n\r\npackage:\r\n```\r\n2024-10-23T14:10:19.726907Z [httpworker.2] [../../src/validation.cpp:1219] [PackageMempoolChecks] [txpackages] package RBF checks passed: parent acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe68315\r\n35e8cf8ce662ba36b6331fa072babc06f08c), child 28deb9d38a4490c3f542f0fd173805eb6c2c8309aa12d5e1669fc71a453d23fe (wtxid=8f8a74f38ed9deada97ef37bb5138b46d16f448da7585e33fc861b4142f764d5)\r\n2024-10-23T14:10:19.727195Z [httpworker.2] [../../src/validation.cpp:1302] [Finalize] [mempool] replacing mempool tx 05ad4c0db1a2fe169acd15bf5d8d1f4fa0ff834b5e8259baab4219f3d20b8991 (wtxid=39676091a39b5f77ee0865c2c52ac4bb8378ff7283fc1668738155ec247c3868, fees=10000, vsize=104). New tx acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe6831535e8cf8ce662ba36b6331fa072babc06f08c, fees=10000, vsize=104)\r\n2024-10-23T14:10:19.727212Z [httpworker.2] [../../src/validation.cpp:1302] [Finalize] [mempool] replacing mempool tx 992204e731c78b7afc6e4b17e14adf0f6b93d472fddc4ba184dd86e1899a83d1 (wtxid=05d9f03194089441530d7503a12b7f36086a2c41deac0960e238e426ed59e5f4, fees=10000, vsize=104). New tx acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe6831535e8cf8ce662ba36b6331fa072babc06f08c, fees=10000, vsize=104)\r\n```\r\n\r\nHere's what the logging would look like in the commit you shared:\r\n\r\nsingle transaction:\r\n```\r\n2024-10-23T13:51:10.728066Z [httpworker.3] [../../src/validation.cpp:1312] [operator()] [mempool] Replacing mempool tx 38335600f2465c0f8bb2b86d5830a34851d86fa879800c0e1434ddfc78c42898 (wtxid=c033cd3efd301c369d66cf759769159609471bd4f9efb3ee30e7209e57b74778, fees=31200, vsize=104).\r\n2024-10-23T13:51:10.728089Z [httpworker.3] [../../src/validation.cpp:1333] [operator()] [mempool] New tx b4001854dc577e21fde7acb4016a9179c3dd5a5af076295d8b0b7c47c35e2032 (wtxid=1f0a0b164999ac0843a8865df347e4fb63191ea3eec539d685b94dcdbeb39fae, fees=10031200, vsize=104)\r\n```\r\n\r\npackage:\r\n```\r\n2024-10-23T13:56:13.459972Z [httpworker.1] [../../src/validation.cpp:1230] [PackageMempoolChecks] [txpackages] package RBF checks passed: parent acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe68315\r\n35e8cf8ce662ba36b6331fa072babc06f08c), child 28deb9d38a4490c3f542f0fd173805eb6c2c8309aa12d5e1669fc71a453d23fe (wtxid=8f8a74f38ed9deada97ef37bb5138b46d16f448da7585e33fc861b4142f764d5)\r\n2024-10-23T13:56:13.460177Z [httpworker.1] [../../src/validation.cpp:1312] [operator()] [mempool] Replacing mempool tx 05ad4c0db1a2fe169acd15bf5d8d1f4fa0ff834b5e8259baab4219f3d20b8991 (wtxid=39676091a39b5f77ee0865c2c52ac4bb8378ff7283fc1668738155ec247c3868, fees=10000, vsize=104).\r\n2024-10-23T13:56:13.460227Z [httpworker.1] [../../src/validation.cpp:1312] [operator()] [mempool] Replacing mempool tx 992204e731c78b7afc6e4b17e14adf0f6b93d472fddc4ba184dd86e1899a83d1 (wtxid=05d9f03194089441530d7503a12b7f36086a2c41deac0960e238e426ed59e5f4, fees=10000, vsize=104).\r\n2024-10-23T13:56:13.460243Z [httpworker.1] [../../src/validation.cpp:1342] [FinalizeSubpackage] [mempool] New package (txs=2, fees=50000, vsize=208)\r\n2024-10-23T13:56:13.460260Z [httpworker.1] [../../src/validation.cpp:1330] [operator()] [mempool] tx acd7ea806cd261b6c8cdb6d15210dad53daabbe68d5cb99f7df31646a769b69d (wtxid=8a867c2e5aea0d89831d3fe6831535e8cf8ce662ba36b6331fa072babc06f08c)\r\n2024-10-23T13:56:13.460274Z [httpworker.1] [../../src/validation.cpp:1330] [operator()] [mempool] tx 28deb9d38a4490c3f542f0fd173805eb6c2c8309aa12d5e1669fc71a453d23fe (wtxid=8f8a74f38ed9deada97ef37bb5138b46d16f448da7585e33fc861b4142f764d5)\r\n```\r\n\r\nMy proposal would be to leave the single-transaction case exactly as-is, so I can just fix what I tried to before to avoid the extra line break. For the package case, given that the `txpackages` log level is already reporting what transactions are in the package, does it make sense to duplicate that information in the `mempool` log category as well?\r\n\r\nAn issue that occurred to me with splitting up log messages for what's in a package across multiple lines is that other threads may be logging simultaneously and cause messages to be interleaved, making the resulting log difficult to parse.\r\n\r\nAnother option would be to simply augment the existing `txpackages` log message to include the aggregate fee/size of the package, and reference the cumulative fee/size of the package that evicted a transaction.  Or we could be even more precise and use some kind of identifier for the package (perhaps BIP 331's \"Combined Hash\"?) in our logging. Now that I think about it, this may make the most sense: if we logged the combined hash in the `txpackages` log message, and referenced the combined hash in the replacement message, I think that would be pretty good.  And we could use the same combined in the tracepoints as well... Thoughts?\r\n",
      "created_at": "2024-10-23T16:06:14Z",
      "updated_at": "2024-10-23T16:06:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813106158",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813106158"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 1313,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1330,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813115879",
      "pull_request_review_id": 2389151891,
      "id": 1813115879,
      "node_id": "PRRC_kwDOABII585sEfPn",
      "diff_hunk": "@@ -1381,7 +1381,13 @@ void CTxMemPool::CTxMemPoolChangeSet::Apply()\n     m_pool->RemoveStaged(m_to_remove, false, MemPoolRemovalReason::REPLACED);\n     for (size_t i=0; i<m_entry_vec.size(); ++i) {\n         auto tx_entry = m_entry_vec[i];\n-        m_pool->addUnchecked(*tx_entry);\n+        if (i == 0 && m_ancestors.count(tx_entry)) {",
      "path": "src/txmempool.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "32101330ec6f6e9c4d467dec370c848cf4d14f23",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "```Suggestion\r\n        if (i == 0 && m_ancestors.contains(tx_entry)) {\r\n```",
      "created_at": "2024-10-23T16:10:43Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813115879",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813115879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1384,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813159728",
      "pull_request_review_id": 2389398286,
      "id": 1813159728,
      "node_id": "PRRC_kwDOABII585sEp8w",
      "diff_hunk": "@@ -1295,36 +1295,41 @@ bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args, std::vector<Workspace>& workspaces)\n+void MemPoolAccept::FinalizeSubpackage(const ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     AssertLockHeld(m_pool.cs);\n-    const CTransaction& tx = *workspaces.front().m_ptx;\n-    const uint256& hash = workspaces.front().m_hash;\n-    TxValidationState& state = workspaces.front().m_state;\n-    const bool bypass_limits = args.m_bypass_limits;\n \n     if (!m_subpackage.m_all_conflicts.empty()) Assume(args.m_allow_replacement);\n     // Remove conflicting transactions from the mempool\n     for (CTxMemPool::txiter it : m_subpackage.m_all_conflicts)\n     {\n-        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+        LogDebug(BCLog::MEMPOOL, \"replacing mempool tx %s (wtxid=%s, fees=%s, vsize=%s). \",\n                 it->GetTx().GetHash().ToString(),\n                 it->GetTx().GetWitnessHash().ToString(),\n                 it->GetFee(),\n-                it->GetTxSize(),\n-                hash.ToString(),\n-                tx.GetWitnessHash().ToString(),\n-                workspaces[0].m_tx_handle->GetFee(),\n-                workspaces[0].m_tx_handle->GetTxSize());\n+                it->GetTxSize());\n+        FeeFrac feerate = m_subpackage.m_changeset->GetAggregateFeeRate();\n+        if (m_subpackage.m_changeset->GetTxCount() == 1) {\n+            const CTransaction& tx = m_subpackage.m_changeset->GetTx(0);\n+            LogDebug(BCLog::MEMPOOL, \"New tx %s (wtxid=%s, fees=%s, vsize=%s)\\n\",\n+                    tx.GetHash().ToString(),\n+                    tx.GetWitnessHash().ToString(),\n+                    feerate.fee, feerate.size);\n+        } else {\n+            LogDebug(BCLog::MEMPOOL, \"New package with %lu txs, fees=%s, vsize=%s\\n\",\n+                    m_subpackage.m_changeset->GetTxCount(),\n+                    feerate.fee,\n+                    feerate.size);\n+        }",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 50,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a8d3118d0cf39e0e49e54814c7a75150b7db2b44",
      "in_reply_to_id": 1810686447,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> For the package case, given that the txpackages log level is already reporting what transactions are in the package, does it make sense to duplicate that information in the mempool log category as well\r\n\r\nNo it does not\r\n\r\n> An issue that occurred to me with splitting up log messages for what's in a package across multiple lines is that other threads may be logging simultaneously and cause messages to be interleaved, making the resulting log difficult to parse.\r\n\r\nGood point\r\n\r\n> if we logged the combined hash in the txpackages log message, and referenced the combined hash in the replacement message, I think that would be pretty good. And we could use the same combined in the tracepoints as well\r\n\r\nThis makes sense +1. \r\n\r\nAt some point I was thinking whether we should add the package sponsor tx id in the tracing API, but I think the combinedHash is better.",
      "created_at": "2024-10-23T16:35:28Z",
      "updated_at": "2024-10-23T16:35:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813159728",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813159728"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": 1313,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 1330,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813272637",
      "pull_request_review_id": 2389151891,
      "id": 1813272637,
      "node_id": "PRRC_kwDOABII585sFFg9",
      "diff_hunk": "@@ -1467,11 +1471,16 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n                                             ws.m_base_fees, effective_feerate, single_wtxid);\n     }\n \n-    if (!FinalizeSubpackage(args, workspaces)) {\n-        // The only possible failure reason is fee-related (mempool full).\n-        // Failed for fee reasons. Provide the effective feerate and which txns were included.\n-        Assume(ws.m_state.GetResult() == TxValidationResult::TX_RECONSIDERABLE);\n-        return MempoolAcceptResult::FeeFailure(ws.m_state, CFeeRate(ws.m_modified_fees, ws.m_vsize), {ws.m_ptx->GetWitnessHash()});\n+    FinalizeSubpackage(args);\n+\n+    // Limit the mempool, if appropriate.\n+    if (!args.m_bypass_limits) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 135,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "1360fd36d1234be142372f05713a1fb011fae577",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "The dropping of `m_package_submission` seems problematic, since that's the original use-case for the argument: https://github.com/bitcoin/bitcoin/pull/28251\r\n\r\nIn this PR it's essentially no longer used.\r\n\r\nit has a regression test that isn't failing in this commit/PR, so either it's resolved a different way or the test fell over or I don't understand what's going on: https://github.com/bitcoin/bitcoin/pull/28251/commits/32c1dd1ad65af0ad4d36a56d2ca32a8481237e68#diff-63dc84ee23b871d1f4931c4f261b3c6b815bd8d5a65098a61bce8ea9b6b81965R81",
      "created_at": "2024-10-23T17:49:59Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813272637",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813272637"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1477,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813383434",
      "pull_request_review_id": 2389151891,
      "id": 1813383434,
      "node_id": "PRRC_kwDOABII585sFgkK",
      "diff_hunk": "@@ -104,10 +104,18 @@ FUZZ_TARGET(package_rbf, .init = initialize_package_rbf)\n     std::vector<CTransaction> mempool_txs;\n     size_t iter{0};\n \n-    int32_t replacement_vsize = fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(1, 1000000);\n-\n     // Keep track of the total vsize of CTxMemPoolEntry's being added to the mempool to avoid overflow\n     // Add replacement_vsize since this is added to new diagram during RBF check\n+    std::optional<CMutableTransaction> replacement_tx = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider, TX_WITH_WITNESS);",
      "path": "src/test/fuzz/rbf.cpp",
      "position": 27,
      "original_position": 8,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "1c33e133db5f876f2ba6eeb28877a5dcf3f6ac04",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "noting that this isn't actually required to get variable vsize transactions since `ConsumeTxMemPoolEntry` injects a fuzz-selected sigops value. Simpler if you just build a minimal tx then allow `ConsumeTxMemPoolEntry` to choose how big it is in vbytes?",
      "created_at": "2024-10-23T19:02:56Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813383434",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813383434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 113,
      "original_line": 113,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813400339",
      "pull_request_review_id": 2389151891,
      "id": 1813400339,
      "node_id": "PRRC_kwDOABII585sFksT",
      "diff_hunk": "@@ -184,14 +184,10 @@ std::optional<std::string> PaysForRBF(CAmount original_fees,\n     return std::nullopt;\n }\n \n-std::optional<std::pair<DiagramCheckError, std::string>> ImprovesFeerateDiagram(CTxMemPool& pool,\n-                                                const CTxMemPool::setEntries& direct_conflicts,\n-                                                const CTxMemPool::setEntries& all_conflicts,\n-                                                CAmount replacement_fees,\n-                                                int64_t replacement_vsize)\n+std::optional<std::pair<DiagramCheckError, std::string>> ImprovesFeerateDiagram(CTxMemPool::CTxMemPoolChangeSet& changeset)",
      "path": "src/policy/rbf.cpp",
      "position": 9,
      "original_position": 9,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "1c33e133db5f876f2ba6eeb28877a5dcf3f6ac04",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "at commit 1c33e133db5f876f2ba6eeb28877a5dcf3f6ac04 are we not applying priority values when computing RBFs, since they're only being applied during `Apply()` stage?\r\n\r\nsubsequent commit 2b5268ebac8daee0521ea82c2688e5e4fac885bc pulls it into changeset, meaning it can act on it?\r\n\r\nDo we have coverage of package rbf with priority?",
      "created_at": "2024-10-23T19:14:38Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813400339",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813400339"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 187,
      "original_line": 187,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813404075",
      "pull_request_review_id": 2389151891,
      "id": 1813404075,
      "node_id": "PRRC_kwDOABII585sFlmr",
      "diff_hunk": "@@ -1810,6 +1810,8 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n         AcceptSubPackage(txns_package_eval, args);\n     PackageValidationState& package_state_final = multi_submission_result.m_state;\n \n+    ClearSubPackageState();",
      "path": "src/validation.cpp",
      "position": 347,
      "original_position": 4,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "b431ab44b0ad04ea9aed9e73a15c1eb599a131dd",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "This shouldn't be necessary, but shouldn't hurt either. `AcceptSubPackage` calls it already for each subpackage.",
      "created_at": "2024-10-23T19:17:04Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813404075",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813404075"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 1813,
      "original_line": 1813,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813408039",
      "pull_request_review_id": 2389151891,
      "id": 1813408039,
      "node_id": "PRRC_kwDOABII585sFmkn",
      "diff_hunk": "@@ -149,7 +154,9 @@ FUZZ_TARGET(package_rbf, .init = initialize_package_rbf)\n             mempool_txs.pop_back();\n             break;\n         }\n-        AddToMempool(pool, child_entry);\n+        if (!pool.GetIter(child_entry.GetTx().GetHash())) {",
      "path": "src/test/fuzz/rbf.cpp",
      "position": 55,
      "original_position": 32,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "a981f07f037b1a154a71ab8f42aebf3965ef4ea5",
      "in_reply_to_id": null,
      "user": {
        "login": "instagibbs",
        "id": 5767891,
        "node_id": "MDQ6VXNlcjU3Njc4OTE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/instagibbs",
        "html_url": "https://github.com/instagibbs",
        "followers_url": "https://api.github.com/users/instagibbs/followers",
        "following_url": "https://api.github.com/users/instagibbs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/instagibbs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/instagibbs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
        "organizations_url": "https://api.github.com/users/instagibbs/orgs",
        "repos_url": "https://api.github.com/users/instagibbs/repos",
        "events_url": "https://api.github.com/users/instagibbs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/instagibbs/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "belt-and-suspenders are fine, but it \"shouldn't happen\" since each tx chain is sourced from a new `g_outpoints`?",
      "created_at": "2024-10-23T19:19:21Z",
      "updated_at": "2024-10-23T19:23:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813408039",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813408039"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 157,
      "original_line": 157,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813525410",
      "pull_request_review_id": 2390542403,
      "id": 1813525410,
      "node_id": "PRRC_kwDOABII585sGDOi",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle StageAddition(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void StageRemoval(CTxMemPool::txiter it) { m_to_remove.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_to_add;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order\n+        // map from the m_to_add index to the ancestors for the transaction\n+        std::map<CTxMemPool::txiter, CTxMemPool::setEntries, CompareIteratorByHash> m_ancestors;",
      "path": "src/txmempool.h",
      "position": 111,
      "original_position": 33,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "88e109f1091561639aca323cb455180317a12b32",
      "in_reply_to_id": 1813066539,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "My thought process here was to mimic the old behavior of having the in-mempool ancestors calculated once and then cached for any further needs, such as adding the transaction to the mempool (in the single transaction case).\r\n\r\nIn the package setting, we calculate the in-mempool ancestors of each transaction in a package, and I believe we use that information for some policy checks, but we throw it away as transactions get added.\r\n\r\nThis all goes away with cluster mempool, so I didn't spend a lot of time thinking about this.  Possibly it would be clearer to just not bother with the caching at all, but then we lose the optimization...  Thoughts?",
      "created_at": "2024-10-23T20:42:43Z",
      "updated_at": "2024-10-23T20:42:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813525410",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813525410"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 842,
      "original_line": 842,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813525748",
      "pull_request_review_id": 2390543066,
      "id": 1813525748,
      "node_id": "PRRC_kwDOABII585sGDT0",
      "diff_hunk": "@@ -816,6 +816,40 @@ class CTxMemPool\n         assert(m_epoch.guarded()); // verify guard even when it==nullopt\n         return !it || visited(*it);\n     }\n+\n+    class CTxMemPoolChangeSet {\n+    public:\n+        explicit CTxMemPoolChangeSet(CTxMemPool* pool) : m_pool(pool) {}\n+        ~CTxMemPoolChangeSet() = default;\n+\n+        CTxMemPoolChangeSet(const CTxMemPoolChangeSet&) = delete;\n+        CTxMemPoolChangeSet& operator=(const CTxMemPoolChangeSet&) = delete;\n+\n+        using TxHandle = CTxMemPool::txiter;\n+\n+        TxHandle StageAddition(const CTransactionRef& tx, const CAmount fee, int64_t time, unsigned int entry_height, uint64_t entry_sequence, bool spends_coinbase, int64_t sigops_cost, LockPoints lp);\n+        void StageRemoval(CTxMemPool::txiter it) { m_to_remove.insert(it); }\n+\n+        util::Result<CTxMemPool::setEntries> CalculateMemPoolAncestors(TxHandle tx, const Limits& limits) {\n+            LOCK(m_pool->cs);\n+            auto ret = m_pool->CalculateMemPoolAncestors(*tx, limits);\n+            if (ret) m_ancestors.insert({tx, *ret});\n+            else m_ancestors.erase(tx);\n+            return ret;\n+        }\n+\n+        void Apply() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    private:\n+        CTxMemPool* m_pool;\n+        CTxMemPool::indexed_transaction_set m_to_add;\n+        std::vector<CTxMemPool::txiter> m_entry_vec; // track the added transactions' insertion order",
      "path": "src/txmempool.h",
      "position": 109,
      "original_position": 31,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "88e109f1091561639aca323cb455180317a12b32",
      "in_reply_to_id": 1813069337,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "My intention was to allow calling `StageAddition` and `StageRemoval` in any order.  I can add comments to that effect.",
      "created_at": "2024-10-23T20:42:50Z",
      "updated_at": "2024-10-23T20:42:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813525748",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813525748"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 840,
      "original_line": 840,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813527740",
      "pull_request_review_id": 2390547949,
      "id": 1813527740,
      "node_id": "PRRC_kwDOABII585sGDy8",
      "diff_hunk": "@@ -1381,7 +1381,13 @@ void CTxMemPool::CTxMemPoolChangeSet::Apply()\n     m_pool->RemoveStaged(m_to_remove, false, MemPoolRemovalReason::REPLACED);\n     for (size_t i=0; i<m_entry_vec.size(); ++i) {\n         auto tx_entry = m_entry_vec[i];\n-        m_pool->addUnchecked(*tx_entry);\n+        if (i == 0 && m_ancestors.count(tx_entry)) {",
      "path": "src/txmempool.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "57a03569e29a629ccedf339caad59eb2a3a31aeb",
      "original_commit_id": "32101330ec6f6e9c4d467dec370c848cf4d14f23",
      "in_reply_to_id": 1813104310,
      "user": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sdaftuar/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sdaftuar/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Yes this matches the old behavior, I believe.",
      "created_at": "2024-10-23T20:43:33Z",
      "updated_at": "2024-10-23T20:43:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31122#discussion_r1813527740",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813527740"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31122"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1384,
      "side": "RIGHT"
    }
  ]
}