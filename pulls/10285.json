{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285",
    "id": 117836799,
    "node_id": "MDExOlB1bGxSZXF1ZXN0MTE3ODM2Nzk5",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10285",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/10285.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/10285.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10285",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10285/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/1d94e2ebe470cb8842223520a0c57513ca77e940",
    "number": 10285,
    "state": "closed",
    "locked": true,
    "maintainer_can_modify": false,
    "title": "net: refactor the connection process. moving towards async connections.",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This untangles our current connection logic and moves toward async connections/resolves. Before merging, I'd like to construct a matrix of different connection configs, and make sure that each one has test coverage. I'm PRing now to get a feel for whether this is reviewable as-is or not.\r\n\r\nIn short, switch from \"here's what we know, connect please!\" to \"walk through the individual connection steps in-order\".\r\n\r\nThis moves the entire process into one function, but the next step will be to break out the individual steps (input checking, resolving, connection, node creation).\r\n\r\nSee the individual commit messages for more detail.",
    "labels": [
      {
        "id": 135961,
        "node_id": "MDU6TGFiZWwxMzU5NjE=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
        "name": "Refactoring",
        "color": "E6F6D6",
        "default": false
      },
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "active_lock_reason": "resolved",
    "created_at": "2017-04-27T00:24:46Z",
    "updated_at": "2021-09-08T11:43:22Z",
    "closed_at": "2017-05-18T01:30:12Z",
    "mergeable_state": "unknown",
    "merge_commit_sha": "7740b36e5c699f8446a0febdf44b4ae3980727b2",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "head": {
      "label": "theuni:connman-events6",
      "ref": "connman-events6",
      "sha": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 10302141,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMDMwMjE0MQ==",
        "name": "bitcoin",
        "full_name": "theuni/bitcoin",
        "owner": {
          "login": "theuni",
          "id": 417043,
          "node_id": "MDQ6VXNlcjQxNzA0Mw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/theuni",
          "html_url": "https://github.com/theuni",
          "followers_url": "https://api.github.com/users/theuni/followers",
          "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
          "organizations_url": "https://api.github.com/users/theuni/orgs",
          "repos_url": "https://api.github.com/users/theuni/repos",
          "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/theuni/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/theuni/bitcoin",
        "description": "Bitcoin integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/theuni/bitcoin",
        "archive_url": "https://api.github.com/repos/theuni/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/theuni/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/theuni/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/theuni/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/theuni/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/theuni/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/theuni/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/theuni/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/theuni/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/theuni/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/theuni/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/theuni/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/theuni/bitcoin/events",
        "forks_url": "https://api.github.com/repos/theuni/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/theuni/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/theuni/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/theuni/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/theuni/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/theuni/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/theuni/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/theuni/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/theuni/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/theuni/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/theuni/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/theuni/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/theuni/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/theuni/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/theuni/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/theuni/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:theuni/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/theuni/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/theuni/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/theuni/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/theuni/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/theuni/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/theuni/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/theuni/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/theuni/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/theuni/bitcoin/hooks",
        "svn_url": "https://github.com/theuni/bitcoin",
        "homepage": "http://www.bitcoin.org",
        "language": "C++",
        "forks_count": 3,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 223311,
        "default_branch": "trivial-next",
        "open_issues_count": 2,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-07-07T14:16:01Z",
        "created_at": "2013-05-26T18:55:06Z",
        "updated_at": "2023-07-29T06:29:25Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "47535d7c3ec79c5978cdcc03a5351ddbbb22538d",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35475,
        "stargazers_count": 70607,
        "watchers_count": 70607,
        "size": 236222,
        "default_branch": "master",
        "open_issues_count": 668,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2023-08-02T16:22:18Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2023-08-02T16:22:48Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 186,
    "deletions": 172,
    "changed_files": 4,
    "commits": 8,
    "review_comments": 25,
    "comments": 3
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MjQ1MTA3NGMyYmIxM2RjMzViNDFmMTA1MWZmNjI4MmVlMGQzYTZj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
      "tree": {
        "sha": "2a8280b0f1021c680b32c94d4bd5ad2a94f7ca9d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2a8280b0f1021c680b32c94d4bd5ad2a94f7ca9d"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a6548a47a5548b4b43510c548a9418673ab751de",
          "sha": "a6548a47a5548b4b43510c548a9418673ab751de",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a6548a47a5548b4b43510c548a9418673ab751de"
        }
      ],
      "message": "net: pass a reference into ConnectNode and copy it there\n\nNo functional change, just preparation for the following commits.",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T22:18:43Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T21:56:29Z"
      },
      "sha": "82451074c2bb13dc35b41f1051ff6282ee0d3a6c"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0MDQ0ZTgyMjBkYzQ0ZjIyNThjZWUzZDZmMDBiNjE2NjNkZDk1YzU0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "tree": {
        "sha": "760bdabff09adedf343d095a51390e9f40e614bb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/760bdabff09adedf343d095a51390e9f40e614bb"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
          "sha": "82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/82451074c2bb13dc35b41f1051ff6282ee0d3a6c"
        }
      ],
      "message": "net: combine OpenNetworkConnection and ConnectNode\n\nConnectNode is only called by OpenNetworkConnection, and only in one place.\nCombine them for preparation of splitting them into functions that are\nfriendlier for callbacks.",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T22:24:37Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T22:15:16Z"
      },
      "sha": "4044e8220dc44f2258cee3d6f00b61663dd95c54"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMDU3NzEzM2NiMThjMTBjZmUzNDFkODJhNjZlMGYwYzUwN2ViYjhk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c0577133cb18c10cfe341d82a66e0f0c507ebb8d",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c0577133cb18c10cfe341d82a66e0f0c507ebb8d",
      "tree": {
        "sha": "7423abc00b5ca44914c897e7210dd961ac30dafc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7423abc00b5ca44914c897e7210dd961ac30dafc"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4044e8220dc44f2258cee3d6f00b61663dd95c54",
          "sha": "4044e8220dc44f2258cee3d6f00b61663dd95c54",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4044e8220dc44f2258cee3d6f00b61663dd95c54"
        }
      ],
      "message": "net: split socket creation out of connection",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T22:35:44Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-21T22:35:44Z"
      },
      "sha": "c0577133cb18c10cfe341d82a66e0f0c507ebb8d"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YTUyNzJhNWIwODg5MGU0YmNkN2YzOTI3ZmM4ZjIxYmE4OTk1ZDAz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a5272a5b08890e4bcd7f3927fc8f21ba8995d03",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/5a5272a5b08890e4bcd7f3927fc8f21ba8995d03",
      "tree": {
        "sha": "886aeccde43018d86419cb3f75b4c2e1bfe83af1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/886aeccde43018d86419cb3f75b4c2e1bfe83af1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c0577133cb18c10cfe341d82a66e0f0c507ebb8d",
          "sha": "c0577133cb18c10cfe341d82a66e0f0c507ebb8d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c0577133cb18c10cfe341d82a66e0f0c507ebb8d"
        }
      ],
      "message": "net: expose a few functions/structs from netbase\n\nThe next commits will move the connection logic out of netbase into net.",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T19:51:01Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T19:50:58Z"
      },
      "sha": "5a5272a5b08890e4bcd7f3927fc8f21ba8995d03"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZTE0ZmRhOTE1ODhjN2YzYjkyYTA4YWZkMzI4Yzk4NGUwM2MzYzQ4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ae14fda91588c7f3b92a08afd328c984e03c3c48",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ae14fda91588c7f3b92a08afd328c984e03c3c48",
      "tree": {
        "sha": "793bed6158e5d6877357cff844ced40390882fbd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/793bed6158e5d6877357cff844ced40390882fbd"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a5272a5b08890e4bcd7f3927fc8f21ba8995d03",
          "sha": "5a5272a5b08890e4bcd7f3927fc8f21ba8995d03",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/5a5272a5b08890e4bcd7f3927fc8f21ba8995d03"
        }
      ],
      "message": "net: refactor the outgoing connection process\n\nThis is the next step towards asynchronous connections.\n\nThe current code confuses connection steps and tends to obfuscate what's going\non. Here, I've tried to create individual stages. The logic has all moved into\na single function for now:\n\n- Global checks: Should any connection be attempted?\n- Input checks: is there something valid to connect to?\n- Resolving: If the address string may be valid, attempt to resolve it (if\n    allowed by the user's dns settings and proxy config)\n- Proxy config\n- Socket creation\n- Connect to the destination\n- If proxied, attempt the remote connection\n- Create the node with the resulting connection\n\nWith this done, resolves and connections can trigger callbacks so that a\nconnection attempt requires no return value. At that point, they can be made\nasynchronous via libevent.",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T23:53:27Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T20:54:13Z"
      },
      "sha": "ae14fda91588c7f3b92a08afd328c984e03c3c48"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMzVkYzAxZmMwNDU4YWJkNDQ5MGQwNjAyYWRjOGM0MmZlODFlOGZm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "tree": {
        "sha": "f0f43199f94a6ec5b3ec0b2da7fdd22613582f67",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f0f43199f94a6ec5b3ec0b2da7fdd22613582f67"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ae14fda91588c7f3b92a08afd328c984e03c3c48",
          "sha": "ae14fda91588c7f3b92a08afd328c984e03c3c48",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ae14fda91588c7f3b92a08afd328c984e03c3c48"
        }
      ],
      "message": "net: remove now-unused functions",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T23:56:46Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-04-26T20:54:45Z"
      },
      "sha": "235dc01fc0458abd4490d0602adc8c42fe81e8ff"
    },
    {
      "event": "labeled",
      "id": 1059595033,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDEwNTk1OTUwMzM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1059595033",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-04-27T00:29:16Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "labeled",
      "id": 1059595035,
      "node_id": "MDEyOkxhYmVsZWRFdmVudDEwNTk1OTUwMzU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1059595035",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-04-27T00:29:16Z",
      "label": {
        "name": "Refactoring",
        "color": "E6F6D6"
      }
    },
    {
      "event": "commented",
      "id": 297578336,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI5NzU3ODMzNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297578336",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-04-27T00:31:10Z",
      "updated_at": "2017-04-27T00:31:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "Vague Concept ACK.",
      "user": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#issuecomment-297578336",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10285"
    },
    {
      "event": "added_to_project",
      "id": 1061060243,
      "node_id": "MDE5OkFkZGVkVG9Qcm9qZWN0RXZlbnQxMDYxMDYwMjQz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1061060243",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-04-27T19:51:03Z",
      "project_card": {
        "id": 2689514,
        "url": "https://api.github.com/projects/columns/cards/2689514",
        "project_id": 481835,
        "project_url": "https://api.github.com/projects/481835",
        "column_name": "Blockers"
      }
    },
    {
      "event": "commented",
      "id": 298621881,
      "node_id": "MDEyOklzc3VlQ29tbWVudDI5ODYyMTg4MQ==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298621881",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-02T12:32:03Z",
      "updated_at": "2017-05-02T12:32:03Z",
      "author_association": "MEMBER",
      "body": "utACK, going to test this",
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#issuecomment-298621881",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10285"
    },
    {
      "event": "reviewed",
      "id": 35790305,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTAzMDU=",
      "url": null,
      "actor": null,
      "commit_id": "4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Review turned up a few bugs that should be fixed, though most of them not your fault :/.",
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#pullrequestreview-35790305",
      "submitted_at": "2017-05-02T19:54:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNDEzM2JkNjY1OWVkMDIwMDJmYWFkNzU3ZGEzODU2MmRmMDczMGFl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/34133bd6659ed02002faad757da38562df0730ae",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/34133bd6659ed02002faad757da38562df0730ae",
      "tree": {
        "sha": "e15767882b381ef7bf590ab9aefe955c1ac290ab",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e15767882b381ef7bf590ab9aefe955c1ac290ab"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/235dc01fc0458abd4490d0602adc8c42fe81e8ff",
          "sha": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/235dc01fc0458abd4490d0602adc8c42fe81e8ff"
        }
      ],
      "message": "net: Add a quick RAII socket closer",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-05-02T21:31:30Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-05-02T21:30:35Z"
      },
      "sha": "34133bd6659ed02002faad757da38562df0730ae"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZDk0ZTJlYmU0NzBjYjg4NDIyMjM1MjBhMGM1NzUxM2NhNzdlOTQw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1d94e2ebe470cb8842223520a0c57513ca77e940",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1d94e2ebe470cb8842223520a0c57513ca77e940",
      "tree": {
        "sha": "1c13da530859df47dd98d8d5955a4b2757cd28c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1c13da530859df47dd98d8d5955a4b2757cd28c2"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/34133bd6659ed02002faad757da38562df0730ae",
          "sha": "34133bd6659ed02002faad757da38562df0730ae",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/34133bd6659ed02002faad757da38562df0730ae"
        }
      ],
      "message": "squashme: review fixups\n\n- Only check IsLocal if pszDest is unset\n- Fix function name string in CreateSocket",
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-05-03T00:10:34Z"
      },
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-05-03T00:10:27Z"
      },
      "sha": "1d94e2ebe470cb8842223520a0c57513ca77e940"
    },
    {
      "event": "reviewed",
      "id": 36590966,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTA5NjY=",
      "url": null,
      "actor": null,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#pullrequestreview-36590966",
      "submitted_at": "2017-05-05T19:29:12Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
    },
    {
      "event": "reviewed",
      "id": 37432810,
      "node_id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzI4MTA=",
      "url": null,
      "actor": null,
      "commit_id": "82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "utACK 1d94e2ebe470cb8842223520a0c57513ca77e940. \r\n\r\nWould be nice to squash review fixes into place.\r\n\r\nI don't think this PR is a pure improvement because `OpenNetworkConnection` is now a big monolith, but there are nice changes here and presumably there will be more cleanup in the future.",
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#pullrequestreview-37432810",
      "submitted_at": "2017-05-10T22:53:08Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
    },
    {
      "event": "commented",
      "id": 302275523,
      "node_id": "MDEyOklzc3VlQ29tbWVudDMwMjI3NTUyMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/302275523",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-18T01:30:12Z",
      "updated_at": "2017-05-18T01:30:12Z",
      "author_association": "MEMBER",
      "body": "Closing this for now. I'm working on getting this fully refactored with libevent instead.\r\n\r\nBreaking this out and serializing the logic was very helpful as an intermediary step, but I now agree that it doesn't make much sense to review/merge those changes alone.",
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#issuecomment-302275523",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10285"
    },
    {
      "event": "closed",
      "id": 1087008706,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTA4NzAwODcwNg==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1087008706",
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-18T01:30:12Z"
    },
    {
      "event": "removed_from_project",
      "id": 1087318933,
      "node_id": "MDIzOlJlbW92ZWRGcm9tUHJvamVjdEV2ZW50MTA4NzMxODkzMw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1087318933",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-05-18T08:00:45Z",
      "project_card": {
        "id": 2689514,
        "url": "https://api.github.com/projects/columns/cards/2689514",
        "project_id": 481835,
        "project_url": "https://api.github.com/projects/481835",
        "column_name": "Blockers"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2017-06-24T00:45:15Z",
      "updated_at": "2017-06-24T00:45:15Z",
      "source": {
        "issue": {
          "id": 238282363,
          "node_id": "MDExOlB1bGxSZXF1ZXN0MTI3MzA5ODI5",
          "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10663",
          "repository_url": "https://api.github.com/repos/bitcoin/bitcoin",
          "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10663/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10663/comments",
          "events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10663/events",
          "html_url": "https://github.com/bitcoin/bitcoin/pull/10663",
          "number": 10663,
          "state": "closed",
          "state_reason": null,
          "title": "net: split resolve out of connect",
          "body": "This is a greatly simplified version of #10285, which only aims to address async resolving.\r\n\r\nIt essentially breaks up two wrapper functions for things only used in one place (ConnectSocketDirectly/ConnectThroughProxy) in favor of calling them directly. This allows us to fully handle resolves before attempting a connection, as is necessary for async connections.\r\n\r\nAs a bonus, I believe the logic is now much easier to follow than before.",
          "user": {
            "login": "theuni",
            "id": 417043,
            "node_id": "MDQ6VXNlcjQxNzA0Mw==",
            "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/theuni",
            "html_url": "https://github.com/theuni",
            "followers_url": "https://api.github.com/users/theuni/followers",
            "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
            "organizations_url": "https://api.github.com/users/theuni/orgs",
            "repos_url": "https://api.github.com/users/theuni/repos",
            "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/theuni/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 135961,
              "node_id": "MDU6TGFiZWwxMzU5NjE=",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring",
              "name": "Refactoring",
              "color": "E6F6D6",
              "default": false
            },
            {
              "id": 98298007,
              "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
              "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
              "name": "P2P",
              "color": "006b75",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "MEMBER",
          "locked": true,
          "active_lock_reason": "resolved",
          "comments": 4,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10663",
            "html_url": "https://github.com/bitcoin/bitcoin/pull/10663",
            "diff_url": "https://github.com/bitcoin/bitcoin/pull/10663.diff",
            "patch_url": "https://github.com/bitcoin/bitcoin/pull/10663.patch"
          },
          "closed_at": "2017-09-28T15:06:56Z",
          "created_at": "2017-06-24T00:45:15Z",
          "updated_at": "2021-09-08T11:45:07Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "referenced",
      "id": 1269991011,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDEyNjk5OTEwMTE=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/1269991011",
      "actor": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "9d31ed2e69fd5cde5fbc5208bd04276a58afd132",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9d31ed2e69fd5cde5fbc5208bd04276a58afd132",
      "created_at": "2017-09-28T15:07:33Z"
    },
    {
      "event": "referenced",
      "id": 2903019175,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5MDMwMTkxNzU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2903019175",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "3a6067ada0ddd919b3722a6cd0c7a0c65bd02c35",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/3a6067ada0ddd919b3722a6cd0c7a0c65bd02c35",
      "created_at": "2019-12-22T04:47:23Z"
    },
    {
      "event": "referenced",
      "id": 2919018650,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5MTkwMTg2NTA=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2919018650",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "c637771b9df614b2b0e5a254145633447788fd4b",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/c637771b9df614b2b0e5a254145633447788fd4b",
      "created_at": "2020-01-02T22:59:27Z"
    },
    {
      "event": "referenced",
      "id": 2921937367,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5MjE5MzczNjc=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2921937367",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "efa150fb3eeb2c78ece139de35410509c71c016f",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/efa150fb3eeb2c78ece139de35410509c71c016f",
      "created_at": "2020-01-04T16:52:27Z"
    },
    {
      "event": "referenced",
      "id": 2940914114,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MTQxMTQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940914114",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "58c58e1f128b96c50a37b7063b6e9887e574d6b2",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/58c58e1f128b96c50a37b7063b6e9887e574d6b2",
      "created_at": "2020-01-12T00:03:06Z"
    },
    {
      "event": "referenced",
      "id": 2940920334,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MjAzMzQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940920334",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "d17fbc84ba741578dac94f58499cb1d4c6fdfa11",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/d17fbc84ba741578dac94f58499cb1d4c6fdfa11",
      "created_at": "2020-01-12T00:18:57Z"
    },
    {
      "event": "referenced",
      "id": 2940921116,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MjExMTY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940921116",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "25e686e7f1557c24783f8bfecc062e142546cce8",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/25e686e7f1557c24783f8bfecc062e142546cce8",
      "created_at": "2020-01-12T00:20:39Z"
    },
    {
      "event": "referenced",
      "id": 2940922055,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MjIwNTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940922055",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "09ca7339133c6d2630622a852cf865baec796047",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/09ca7339133c6d2630622a852cf865baec796047",
      "created_at": "2020-01-12T00:23:00Z"
    },
    {
      "event": "referenced",
      "id": 2940924204,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MjQyMDQ=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940924204",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "f411c5cd94e5b08888ae07167ce437e83a9f3c8a",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/f411c5cd94e5b08888ae07167ce437e83a9f3c8a",
      "created_at": "2020-01-12T00:28:45Z"
    },
    {
      "event": "referenced",
      "id": 2940932036,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDI5NDA5MzIwMzY=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/2940932036",
      "actor": {
        "login": "PastaPastaPasta",
        "id": 6443210,
        "node_id": "MDQ6VXNlcjY0NDMyMTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/PastaPastaPasta",
        "html_url": "https://github.com/PastaPastaPasta",
        "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
        "following_url": "https://api.github.com/users/PastaPastaPasta/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/PastaPastaPasta/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/PastaPastaPasta/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
        "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
        "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
        "events_url": "https://api.github.com/users/PastaPastaPasta/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "19180b33574117908ef5d4b84d73103f366377f5",
      "commit_url": "https://api.github.com/repos/PastaPastaPasta/dash/commits/19180b33574117908ef5d4b84d73103f366377f5",
      "created_at": "2020-01-12T00:48:56Z"
    },
    {
      "event": "referenced",
      "id": 4517981595,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ1MTc5ODE1OTU=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4517981595",
      "actor": {
        "login": "ckti",
        "id": 7046769,
        "node_id": "MDQ6VXNlcjcwNDY3Njk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7046769?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ckti",
        "html_url": "https://github.com/ckti",
        "followers_url": "https://api.github.com/users/ckti/followers",
        "following_url": "https://api.github.com/users/ckti/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ckti/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ckti/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ckti/subscriptions",
        "organizations_url": "https://api.github.com/users/ckti/orgs",
        "repos_url": "https://api.github.com/users/ckti/repos",
        "events_url": "https://api.github.com/users/ckti/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ckti/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "edf5d1faf0d846b14cada65546db4c798e1bf868",
      "commit_url": "https://api.github.com/repos/ckti-ioncore-current/ion/commits/edf5d1faf0d846b14cada65546db4c798e1bf868",
      "created_at": "2021-03-28T10:02:59Z"
    },
    {
      "event": "referenced",
      "id": 4938062472,
      "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ5MzgwNjI0NzI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/4938062472",
      "actor": {
        "login": "gades",
        "id": 4200730,
        "node_id": "MDQ6VXNlcjQyMDA3MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/4200730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gades",
        "html_url": "https://github.com/gades",
        "followers_url": "https://api.github.com/users/gades/followers",
        "following_url": "https://api.github.com/users/gades/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gades/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gades/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gades/subscriptions",
        "organizations_url": "https://api.github.com/users/gades/orgs",
        "repos_url": "https://api.github.com/users/gades/repos",
        "events_url": "https://api.github.com/users/gades/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gades/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": "a6d5b1a7048a873806ef87a3777e2cbf250f5145",
      "commit_url": "https://api.github.com/repos/cosanta/cosanta-core/commits/a6d5b1a7048a873806ef87a3777e2cbf250f5145",
      "created_at": "2021-06-25T05:13:03Z"
    },
    {
      "event": "locked",
      "id": 5271750776,
      "node_id": "LOE_lADOABII584NY6vGzwAAAAE6OIh4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/5271750776",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2021-09-08T11:43:22Z",
      "lock_reason": "resolved"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114333281",
      "pull_request_review_id": 35790305,
      "id": 114333281,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDMzMzI4MQ==",
      "diff_hunk": "@@ -340,19 +340,29 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(const CAddress& addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Shouldnt this only be if !pszDest?",
      "created_at": "2017-05-02T14:36:07Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114333281",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114333281"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 356,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114387767",
      "pull_request_review_id": 35790305,
      "id": 114387767,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDM4Nzc2Nw==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: Move this into the previous block, and maybe move the addrDest.IsValid() check into it as well. Then you can always require addrDest.IsValid() for non-named addresses as well, which seems reasonable.",
      "created_at": "2017-05-02T18:17:28Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114387767",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114387767"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114390273",
      "pull_request_review_id": 35790305,
      "id": 114390273,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDM5MDI3Mw==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114387767,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Generally the point here is to have top-level ifs like if (strDest.empty()) and then put the logic inside of that, instead of repeated ifs for similar branches which are just confusing.",
      "created_at": "2017-05-02T18:28:10Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114390273",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114390273"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114401222",
      "pull_request_review_id": 35790305,
      "id": 114401222,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQwMTIyMg==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));",
      "path": "src/netbase.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "nit: needs a string change here for \\_\\_func__.",
      "created_at": "2017-05-02T19:15:54Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114401222",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114401222"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114403174",
      "pull_request_review_id": 35790305,
      "id": 114403174,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQwMzE3NA==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n+\n+    // Create socket\n+    SOCKET hSocket = INVALID_SOCKET;\n+    if (proxy.IsValid()) {\n+        if (!CreateSocket(proxy.proxy, hSocket)) {\n+            return false;\n+        }\n+    } else {\n+        if (!CreateSocket(addrDest, hSocket)) {\n+            return false;\n+        }\n+    }\n+    if (!IsSelectableSocket(hSocket)) {\n+        LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n+        CloseSocket(hSocket);\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Connect\n+    bool connected = false;\n+    if (proxy.IsValid()) {\n+        if (!ConnectSocketDirectly(proxy.proxy, hSocket, nConnectTimeout)) {\n+            // This does not count as an addrman attempt, since the address was never actually tried.\n+            return false;\n+        }\n+        ProxyCredentials random_auth;\n+        const ProxyCredentials* proxy_auth = nullptr;\n+        if (proxy.randomize_credentials) {\n+            static std::atomic_int counter;\n+            random_auth.username = random_auth.password = strprintf(\"%i\", counter++);\n+            proxy_auth = &random_auth;\n+        }\n+        if (addrDest.IsValid()) {\n+            strDest = addrDest.ToStringIP();\n+            port = addrDest.GetPort();\n+        }\n+        connected = Socks5(strDest, (unsigned short)port, proxy_auth, hSocket);\n+    } else {\n+        connected = ConnectSocketDirectly(addrDest, hSocket, nConnectTimeout);\n     }\n \n-    return NULL;\n+    addrman.Attempt(addrDest, fCountFailure);\n+\n+    if (!connected) {\n+        return false;",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 181,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Not strictly your fault, but I think you're exposing a bug in Socks5 here - Socks5 fails to CloseSocket() prior to returning false in one place (Proxy username or password too long), so I think it'd be better to just CloseSocket here instead of further down to make it harder to miss such things.",
      "created_at": "2017-05-02T19:25:03Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114403174",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114403174"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 473,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114408458",
      "pull_request_review_id": 35790305,
      "id": 114408458,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQwODQ1OA==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));",
      "path": "src/netbase.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114401222,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Oh, also think we need a CloseSocket here.",
      "created_at": "2017-05-02T19:49:33Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114408458",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114408458"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114408569",
      "pull_request_review_id": 35790305,
      "id": 114408569,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQwODU2OQ==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));\n \n+    hSocketRet = hSocket;\n+    return true;\n+}\n+\n+bool ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocket, int nTimeout)\n+{\n+    struct sockaddr_storage sockaddr;\n+    socklen_t len = sizeof(sockaddr);\n+    if (!addrConnect.GetSockAddr((struct sockaddr*)&sockaddr, &len)) {\n+        LogPrintf(\"Cannot connect to %s: unsupported network\\n\", addrConnect.ToString());",
      "path": "src/netbase.cpp",
      "position": 47,
      "original_position": 44,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Need a CloseSocket here (but, really, lets just move all the CloseSockets up to OpenNetworkConnection post-CreateSocket instead of them being sprinkled all over everywhere?).",
      "created_at": "2017-05-02T19:50:06Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114408569",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114408569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 451,
      "original_line": 451,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114411229",
      "pull_request_review_id": 35875038,
      "id": 114411229,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMTIyOQ==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114387767,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I avoided coalescing on purpose. The current code does a bunch of steps at once, depending on what the input is. That's what I'm trying to undo here.\r\n\r\nThe previous block handles resolving, and will be moved out to a new function as a next step. By keeping the connection flow separated like this, it's trivial to factor out that way.",
      "created_at": "2017-05-02T20:02:40Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114411229",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114411229"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114411793",
      "pull_request_review_id": 35875713,
      "id": 114411793,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMTc5Mw==",
      "diff_hunk": "@@ -340,19 +340,29 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(const CAddress& addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "in_reply_to_id": 114333281,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "yes, thanks. Will fix.",
      "created_at": "2017-05-02T20:05:34Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114411793",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114411793"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 356,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412081",
      "pull_request_review_id": 35876035,
      "id": 114412081,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMjA4MQ==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n+\n+    // Create socket\n+    SOCKET hSocket = INVALID_SOCKET;\n+    if (proxy.IsValid()) {\n+        if (!CreateSocket(proxy.proxy, hSocket)) {\n+            return false;\n+        }\n+    } else {\n+        if (!CreateSocket(addrDest, hSocket)) {\n+            return false;\n+        }\n+    }\n+    if (!IsSelectableSocket(hSocket)) {\n+        LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n+        CloseSocket(hSocket);\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Connect\n+    bool connected = false;\n+    if (proxy.IsValid()) {\n+        if (!ConnectSocketDirectly(proxy.proxy, hSocket, nConnectTimeout)) {\n+            // This does not count as an addrman attempt, since the address was never actually tried.\n+            return false;\n+        }\n+        ProxyCredentials random_auth;\n+        const ProxyCredentials* proxy_auth = nullptr;\n+        if (proxy.randomize_credentials) {\n+            static std::atomic_int counter;\n+            random_auth.username = random_auth.password = strprintf(\"%i\", counter++);\n+            proxy_auth = &random_auth;\n+        }\n+        if (addrDest.IsValid()) {\n+            strDest = addrDest.ToStringIP();\n+            port = addrDest.GetPort();\n+        }\n+        connected = Socks5(strDest, (unsigned short)port, proxy_auth, hSocket);\n+    } else {\n+        connected = ConnectSocketDirectly(addrDest, hSocket, nConnectTimeout);\n     }\n \n-    return NULL;\n+    addrman.Attempt(addrDest, fCountFailure);\n+\n+    if (!connected) {\n+        return false;",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 181,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114403174,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Agreed.",
      "created_at": "2017-05-02T20:06:44Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114412081",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412081"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 473,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412487",
      "pull_request_review_id": 35876466,
      "id": 114412487,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMjQ4Nw==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));",
      "path": "src/netbase.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114401222,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Will fix __func__.\r\n\r\nSetSocketNonBlocking should take care of closing the socket, but an explicit one here wouldn't hurt either.\r\n\r\nCloseSocket is really annoying. I'll RAII it directly after this PR.",
      "created_at": "2017-05-02T20:08:38Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114412487",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412487"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412799",
      "pull_request_review_id": 35876847,
      "id": 114412799,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMjc5OQ==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));\n \n+    hSocketRet = hSocket;\n+    return true;\n+}\n+\n+bool ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocket, int nTimeout)\n+{\n+    struct sockaddr_storage sockaddr;\n+    socklen_t len = sizeof(sockaddr);\n+    if (!addrConnect.GetSockAddr((struct sockaddr*)&sockaddr, &len)) {\n+        LogPrintf(\"Cannot connect to %s: unsupported network\\n\", addrConnect.ToString());",
      "path": "src/netbase.cpp",
      "position": 47,
      "original_position": 44,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114408569,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ugh. I'll see how much work it would be to RAII it as part of this pull.",
      "created_at": "2017-05-02T20:10:12Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114412799",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114412799"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 451,
      "original_line": 451,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114413522",
      "pull_request_review_id": 35877610,
      "id": 114413522,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMzUyMg==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114387767,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Ahh, OK, didnt realize that the next step would be to pull it out.",
      "created_at": "2017-05-02T20:13:39Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114413522",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114413522"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114413576",
      "pull_request_review_id": 35877683,
      "id": 114413576,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDQxMzU3Ng==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));",
      "path": "src/netbase.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114401222,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Good, CloseSocket were half the issues here :(",
      "created_at": "2017-05-02T20:13:58Z",
      "updated_at": "2017-05-03T00:41:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114413576",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114413576"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114534232",
      "pull_request_review_id": 36007394,
      "id": 114534232,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNDUzNDIzMg==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n+\n+    // Create socket\n+    SOCKET hSocket = INVALID_SOCKET;\n+    if (proxy.IsValid()) {\n+        if (!CreateSocket(proxy.proxy, hSocket)) {\n+            return false;\n+        }\n+    } else {\n+        if (!CreateSocket(addrDest, hSocket)) {\n+            return false;\n+        }\n+    }\n+    if (!IsSelectableSocket(hSocket)) {\n+        LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n+        CloseSocket(hSocket);\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Connect\n+    bool connected = false;\n+    if (proxy.IsValid()) {\n+        if (!ConnectSocketDirectly(proxy.proxy, hSocket, nConnectTimeout)) {\n+            // This does not count as an addrman attempt, since the address was never actually tried.\n+            return false;\n+        }\n+        ProxyCredentials random_auth;\n+        const ProxyCredentials* proxy_auth = nullptr;\n+        if (proxy.randomize_credentials) {\n+            static std::atomic_int counter;\n+            random_auth.username = random_auth.password = strprintf(\"%i\", counter++);\n+            proxy_auth = &random_auth;\n+        }\n+        if (addrDest.IsValid()) {\n+            strDest = addrDest.ToStringIP();\n+            port = addrDest.GetPort();\n+        }\n+        connected = Socks5(strDest, (unsigned short)port, proxy_auth, hSocket);\n+    } else {\n+        connected = ConnectSocketDirectly(addrDest, hSocket, nConnectTimeout);\n     }\n \n-    return NULL;\n+    addrman.Attempt(addrDest, fCountFailure);\n+\n+    if (!connected) {\n+        return false;",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 181,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114403174,
      "user": {
        "login": "laanwj",
        "id": 126646,
        "node_id": "MDQ6VXNlcjEyNjY0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/laanwj",
        "html_url": "https://github.com/laanwj",
        "followers_url": "https://api.github.com/users/laanwj/followers",
        "following_url": "https://api.github.com/users/laanwj/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/laanwj/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/laanwj/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
        "organizations_url": "https://api.github.com/users/laanwj/orgs",
        "repos_url": "https://api.github.com/users/laanwj/repos",
        "events_url": "https://api.github.com/users/laanwj/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/laanwj/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "+1 for the SocketCloser",
      "created_at": "2017-05-03T12:45:45Z",
      "updated_at": "2017-05-03T12:45:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r114534232",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114534232"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 473,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115071588",
      "pull_request_review_id": 36590966,
      "id": 115071588,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTA3MTU4OA==",
      "diff_hunk": "@@ -340,71 +340,160 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (!pszDest) {\n+        if (IsLocal(addrConnect) || FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Create socket and make sure that it is closed in the event of an error\n+    SOCKET hSocket = INVALID_SOCKET;\n+    CSocketCloser sockCloser(hSocket);",
      "path": "src/net.cpp",
      "position": 135,
      "original_position": 135,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "in_reply_to_id": null,
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "It seems strange to create the CSocketCloser and then give it a reference to the socket - why not just have the CSocketCloser hold the SOCKET variable (publicly) and then set it to INVALID_SOCKET upon close/release (and return it from release) to make it feel more like a unique_ptr?",
      "created_at": "2017-05-05T19:29:12Z",
      "updated_at": "2017-05-05T19:29:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115071588",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115071588"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 428,
      "original_line": 428,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115856249",
      "pull_request_review_id": 37432810,
      "id": 115856249,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg1NjI0OQ==",
      "diff_hunk": "@@ -340,7 +340,7 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+CNode* CConnman::ConnectNode(const CAddress& addrConnect, const char *pszDest, bool fCountFailure)",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 5,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "82451074c2bb13dc35b41f1051ff6282ee0d3a6c",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"net: pass a reference into ConnectNode and copy it there\" (82451074c2bb13dc35b41f1051ff6282ee0d3a6c)\r\n\r\nCorresponding change to net.h is missing so this commit doesn't compile.",
      "created_at": "2017-05-10T21:23:47Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115856249",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115856249"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 343,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115858254",
      "pull_request_review_id": 37432810,
      "id": 115858254,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg1ODI1NA==",
      "diff_hunk": "@@ -340,19 +340,29 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(const CAddress& addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {",
      "path": "src/net.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "4044e8220dc44f2258cee3d6f00b61663dd95c54",
      "in_reply_to_id": 114333281,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Note: Fixed in 1d94e2ebe470cb8842223520a0c57513ca77e940.",
      "created_at": "2017-05-10T21:33:06Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115858254",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115858254"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 356,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115859939",
      "pull_request_review_id": 37432810,
      "id": 115859939,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg1OTkzOQ==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));",
      "path": "src/netbase.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114401222,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Isn't seems strange for `SetSocketNonBlocking` to try to destroy the socket if it doesn't succeed. Maybe consider removing `CloseSocket` calls from `SetSocketNonBlocking` after adding the RAII here.",
      "created_at": "2017-05-10T21:41:58Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115859939",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115859939"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 440,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115860223",
      "pull_request_review_id": 37432810,
      "id": 115860223,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg2MDIyMw==",
      "diff_hunk": "@@ -445,6 +439,19 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));\n \n+    hSocketRet = hSocket;\n+    return true;\n+}\n+\n+bool ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocket, int nTimeout)\n+{\n+    struct sockaddr_storage sockaddr;\n+    socklen_t len = sizeof(sockaddr);\n+    if (!addrConnect.GetSockAddr((struct sockaddr*)&sockaddr, &len)) {\n+        LogPrintf(\"Cannot connect to %s: unsupported network\\n\", addrConnect.ToString());",
      "path": "src/netbase.cpp",
      "position": 47,
      "original_position": 44,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114408569,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "Note: fixed in 34133bd6659ed02002faad757da38562df0730ae.",
      "created_at": "2017-05-10T21:43:28Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115860223",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115860223"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 451,
      "original_line": 451,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115861480",
      "pull_request_review_id": 37432810,
      "id": 115861480,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg2MTQ4MA==",
      "diff_hunk": "@@ -445,6 +445,22 @@ bool static ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocketRe\n     if (!SetSocketNonBlocking(hSocket, true))\n         return error(\"ConnectSocketDirectly: Setting socket to non-blocking failed, error %s\\n\", NetworkErrorString(WSAGetLastError()));\n \n+    hSocketRet = hSocket;\n+    return true;\n+}\n+\n+bool ConnectSocketDirectly(const CService &addrConnect, SOCKET& hSocket, int nTimeout)",
      "path": "src/netbase.cpp",
      "position": 42,
      "original_position": 17,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "c0577133cb18c10cfe341d82a66e0f0c507ebb8d",
      "in_reply_to_id": null,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "In commit \"net: split socket creation out of connection\"\r\n\r\nThis commit drops `static`, but the function isn't exposed publicly in a header until the next commit.\r\n\r\n",
      "created_at": "2017-05-10T21:49:36Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115861480",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115861480"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 446,
      "original_line": 452,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115868857",
      "pull_request_review_id": 37432810,
      "id": 115868857,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg2ODg1Nw==",
      "diff_hunk": "@@ -340,71 +340,160 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (!pszDest) {\n+        if (IsLocal(addrConnect) || FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Create socket and make sure that it is closed in the event of an error\n+    SOCKET hSocket = INVALID_SOCKET;\n+    CSocketCloser sockCloser(hSocket);",
      "path": "src/net.cpp",
      "position": 135,
      "original_position": 135,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "in_reply_to_id": 115071588,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> It seems strange to create the CSocketCloser and then give it a reference to the socket\r\n\r\nIt is strange, just like CloseSocket taking a reference is strange. But I'd think as long as one of these is taking a reference, the other probably should as well for consistency.\r\n\r\n",
      "created_at": "2017-05-10T22:34:38Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115868857",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115868857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 428,
      "original_line": 428,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115870542",
      "pull_request_review_id": 37432810,
      "id": 115870542,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg3MDU0Mg==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114387767,
      "user": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "> By keeping the connection flow separated like this, it's trivial to factor out that way.\r\n\r\nProbably there is something going over my head, but I don't understand the reasoning.\r\n\r\nCurrently this does:\r\n\r\n```\r\nif (condition) {\r\n  // bunch of code\r\n} else {\r\n  // other code\r\n}\r\nif (equivalent condition) {\r\n  // code that you want to factor out\r\n}\r\nif (equivalent condition) {\r\n  // more code that you want to factor out\r\n}\r\n```\r\n\r\nI don't see why it would be any harder to refactor later with:\r\n\r\n```\r\nif (condition) {\r\n  // bunch of code\r\n  // code that you want to factor out\r\n  // more code that you want to factor out\r\n} else {\r\n  // other code\r\n}\r\n```",
      "created_at": "2017-05-10T22:46:03Z",
      "updated_at": "2017-05-10T22:53:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115870542",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115870542"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115878962",
      "pull_request_review_id": 37456993,
      "id": 115878962,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTg3ODk2Mg==",
      "diff_hunk": "@@ -340,71 +340,160 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (!pszDest) {\n+        if (IsLocal(addrConnect) || FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {\n+        // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+        // In that case, drop the connection that was just created, and return the existing CNode instead.\n+        // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+        // name catch this early.\n+        LOCK(cs_vNodes);\n+        CNode* pnode = FindNode((CService)addrDest);\n+        if (pnode)\n+        {\n+            pnode->MaybeSetAddrName(std::string(pszDest));\n+            LogPrintf(\"Failed to open new connection, already connected\\n\");\n+            return false;\n+        }\n+    }\n \n-        // Add node\n-        NodeId id = GetNewNodeId();\n-        uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n-        CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->AddRef();\n+    // Configure proxy, if any. At this point, addrDest is resolved and valid unless we're connecting through\n+    // a proxy which will be handling the resolve.\n+    proxyType proxy;\n+    if (addrDest.IsValid()) {\n+        GetProxy(addrDest.GetNetwork(), proxy);\n+    } else if (!GetNameProxy(proxy)) {\n+        return false;\n+    }\n \n-        return pnode;\n-    } else if (!proxyConnectionFailed) {\n-        // If connecting to the node failed, and failure is not caused by a problem connecting to\n-        // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect, fCountFailure);\n+    // Create socket and make sure that it is closed in the event of an error\n+    SOCKET hSocket = INVALID_SOCKET;\n+    CSocketCloser sockCloser(hSocket);",
      "path": "src/net.cpp",
      "position": 135,
      "original_position": 135,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "in_reply_to_id": 115071588,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "I gave it a reference because several calls further down the chain set the value to -1. For example, if ConnectSocketDirectly() fails. If storing a value, CSocketCloser would attempt to close it again at destruction if we weren't careful about resetting it, which would defeat the point of using RAII.\r\n\r\nThe alternative would be to audit for CloseSocket()s (or make a full-blown RAII CSocket with Close() as a member), which would make for a much larger diff.",
      "created_at": "2017-05-10T23:51:47Z",
      "updated_at": "2017-05-10T23:51:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115878962",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115878962"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 428,
      "original_line": 428,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115904892",
      "pull_request_review_id": 37483162,
      "id": 115904892,
      "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDExNTkwNDg5Mg==",
      "diff_hunk": "@@ -340,71 +340,161 @@ bool CConnman::CheckIncomingNonce(uint64_t nonce)\n     return true;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n+// if successful, this moves the passed grant to the constructed node\n+bool CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot, bool fFeeler, bool fAddnode)\n {\n-    if (pszDest == NULL) {\n-        if (IsLocal(addrConnect))\n-            return NULL;\n+    //\n+    // Initiate outbound network connection\n+    //\n \n-        // Look for an existing connection\n-        CNode* pnode = FindNode((CService)addrConnect);\n-        if (pnode)\n-        {\n-            LogPrintf(\"Failed to open new connection, already connected\\n\");\n-            return NULL;\n-        }\n+    if (interruptNet) {\n+        return false;\n+    }\n+    if (!fNetworkActive) {\n+        return false;\n+    }\n+    if (IsLocal(addrConnect)) {\n+        return false;\n+    }\n+\n+    if (!pszDest) {\n+        if (FindNode((CNetAddr)addrConnect) || IsBanned(addrConnect) ||\n+            FindNode(addrConnect.ToStringIPPort()))\n+            return false;\n+    } else if (FindNode(std::string(pszDest))) {\n+        return false;\n     }\n \n     /// debug print\n     LogPrint(BCLog::NET, \"trying connection %s lastseen=%.1fhrs\\n\",\n         pszDest ? pszDest : addrConnect.ToString(),\n         pszDest ? 0.0 : (double)(GetAdjustedTime() - addrConnect.nTime)/3600.0);\n \n-    // Connect\n-    SOCKET hSocket;\n-    bool proxyConnectionFailed = false;\n-    if (pszDest ? ConnectSocketByName(addrConnect, hSocket, pszDest, Params().GetDefaultPort(), nConnectTimeout, &proxyConnectionFailed) :\n-                  ConnectSocket(addrConnect, hSocket, nConnectTimeout, &proxyConnectionFailed))\n-    {\n-        if (!IsSelectableSocket(hSocket)) {\n-            LogPrintf(\"Cannot create connection: non-selectable socket created (fd >= FD_SETSIZE ?)\\n\");\n-            CloseSocket(hSocket);\n-            return NULL;\n+    std::string strDest;\n+    int port = Params().GetDefaultPort();\n+    CAddress addrDest;\n+\n+    // Check input.\n+    // If pszDest is set:\n+    // - It must contain parseable host, and optionally a port.\n+    // - If no port is supplied, the default is used.\n+    // Otherwise, addrDest must be valid.\n+    if (pszDest) {\n+        SplitHostPort(std::string(pszDest), port, strDest);\n+        if (strDest.empty()) {\n+            return false;\n+        }\n+    } else {\n+        addrDest = addrConnect;\n+        if (!addrDest.IsValid()) {\n+            return false;\n         }\n+    }\n \n-        if (pszDest && addrConnect.IsValid()) {\n-            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n-            // In that case, drop the connection that was just created, and return the existing CNode instead.\n-            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n-            // name catch this early.\n-            LOCK(cs_vNodes);\n-            CNode* pnode = FindNode((CService)addrConnect);\n-            if (pnode)\n-            {\n-                pnode->MaybeSetAddrName(std::string(pszDest));\n-                CloseSocket(hSocket);\n-                LogPrintf(\"Failed to open new connection, already connected\\n\");\n-                return NULL;\n+    if (!strDest.empty()) {\n+        // Resolve strDest, if set. Only actually perform a dns lookup if they're enabled\n+        // by the current settings. Note that if strDest is already an ip address, this will\n+        // succeed regardless of the lookup setting.\n+        std::vector<CService> addrResolved;\n+        if (Lookup(strDest.c_str(), addrResolved, port, fNameLookup && !HaveNameProxy(), 256)) {\n+            if (addrResolved.size() > 0) {\n+                addrDest = CAddress(addrResolved[GetRand(addrResolved.size())], NODE_NONE);\n             }\n         }\n+    }\n \n-        addrman.Attempt(addrConnect, fCountFailure);\n+    if (!strDest.empty() && addrDest.IsValid()) {",
      "path": "src/net.cpp",
      "position": 98,
      "original_position": 102,
      "commit_id": "1d94e2ebe470cb8842223520a0c57513ca77e940",
      "original_commit_id": "235dc01fc0458abd4490d0602adc8c42fe81e8ff",
      "in_reply_to_id": 114387767,
      "user": {
        "login": "theuni",
        "id": 417043,
        "node_id": "MDQ6VXNlcjQxNzA0Mw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theuni",
        "html_url": "https://github.com/theuni",
        "followers_url": "https://api.github.com/users/theuni/followers",
        "following_url": "https://api.github.com/users/theuni/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theuni/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theuni/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
        "organizations_url": "https://api.github.com/users/theuni/orgs",
        "repos_url": "https://api.github.com/users/theuni/repos",
        "events_url": "https://api.github.com/users/theuni/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theuni/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "While it may make sense to lump a few actions together if they meet the same conditions now because a connection is just one long synchronous operation, my intention is to clarify which conditions really need to be met at which stage, so that we can break that operation up into smaller asynchronous ones.\r\n\r\nSome of these tests (like whether or not we resolved successfully) will just move in an obvious way to callbacks, so I guess it makes sense to combine them here. Others though, will need to be re-checked on separate threads.\r\n\r\nI'll clarify this in the code by setting some variables rather than repeating conditions, so that it's more clear what the intent is.\r\n\r\nI'll rebase while I'm at it.",
      "created_at": "2017-05-11T04:53:20Z",
      "updated_at": "2017-05-11T04:53:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/10285#discussion_r115904892",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/115904892"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10285"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 402,
      "original_line": 406,
      "side": "RIGHT"
    }
  ]
}