{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611",
    "id": 2011069202,
    "node_id": "PR_kwDOABII58533nsS",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30611",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30611.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30611.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/b37452ca437856ed5d8effce2cef737d9df479c1",
    "number": 30611,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "validation: write chainstate to disk every hour",
    "user": {
      "login": "andrewtoth",
      "id": 237213,
      "node_id": "MDQ6VXNlcjIzNzIxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andrewtoth",
      "html_url": "https://github.com/andrewtoth",
      "followers_url": "https://api.github.com/users/andrewtoth/followers",
      "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
      "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
      "repos_url": "https://api.github.com/users/andrewtoth/repos",
      "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "Since #28233, periodically writing the chainstate to disk every 24 hours does not clear the dbcache. Since #28280, periodically writing the chainstate to disk is proportional only to the amount of dirty entries in the cache. Due to these changes, it is no longer beneficial to only write the chainstate to disk every 24 hours. The periodic flush interval was necessary because every write of the chainstate would clear the dbcache. Now, we can get rid of the periodic flush interval and simply write the chainstate along with blocks and block index at least every hour.\r\n\r\nThree benefits of doing this:\r\n1. For IBD or reindex-chainstate with a combination of large dbcache setting, slow CPU, slow internet speed/unreliable peers, it could be up to 24 hours until the chainstate is persisted to disk. A power outage or crash could potentially lose up to 24 hours of progress. If there is a very large amount of dirty cache entries, writing to disk when a flush finally does occur will take a very long time. Crashing during this window of writing can cause https://github.com/bitcoin/bitcoin/issues/11600. By syncing every hour in unison with the block index we avoid this problem. Only a maximum of one hour of progress can be lost, and the window for crashing during writing is much smaller. For IBD with lower dbcache settings, faster CPU, or better internet speed/reliable peers, chainstate writes are already triggered more often than every hour so this change will have no effect on IBD.\r\n2. Based on discussion in #28280, writing only once every 24 hours during long running operation of a node causes IO spikes. Writing smaller chainstate changes every hour like we do with blocks and block index will reduce IO spikes.\r\n3. Faster shutdown speeds. All dirty chainstate entries must be persisted to disk on shutdown. If we have a lot of dirty entries, such as when close to 24 hours or if we sync with a large dbcache, it can take a long time to shutdown. By keeping the chainstate clean we avoid this problem.\r\n\r\nInspired by [this comment](https://github.com/bitcoin/bitcoin/pull/28280#issuecomment-2121088705).\r\n\r\nResolves https://github.com/bitcoin/bitcoin/issues/11600",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2024-08-08T18:21:05Z",
    "updated_at": "2024-12-31T03:51:51Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "ededde80b698365074cb168d286baabb94e32a49",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "andrewtoth:write-chainstate-every-hour",
      "ref": "write-chainstate-every-hour",
      "sha": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 156145027,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNTYxNDUwMjc=",
        "name": "bitcoin",
        "full_name": "andrewtoth/bitcoin",
        "owner": {
          "login": "andrewtoth",
          "id": 237213,
          "node_id": "MDQ6VXNlcjIzNzIxMw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/andrewtoth",
          "html_url": "https://github.com/andrewtoth",
          "followers_url": "https://api.github.com/users/andrewtoth/followers",
          "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
          "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
          "repos_url": "https://api.github.com/users/andrewtoth/repos",
          "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/andrewtoth/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/andrewtoth/bitcoin",
        "archive_url": "https://api.github.com/repos/andrewtoth/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/andrewtoth/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/andrewtoth/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/andrewtoth/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/andrewtoth/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/andrewtoth/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/andrewtoth/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/andrewtoth/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/andrewtoth/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/andrewtoth/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/andrewtoth/bitcoin/events",
        "forks_url": "https://api.github.com/repos/andrewtoth/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/andrewtoth/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/andrewtoth/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/andrewtoth/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/andrewtoth/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/andrewtoth/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/andrewtoth/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/andrewtoth/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/andrewtoth/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/andrewtoth/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:andrewtoth/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/andrewtoth/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/andrewtoth/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/andrewtoth/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/andrewtoth/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/andrewtoth/bitcoin/hooks",
        "svn_url": "https://github.com/andrewtoth/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 267916,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-28T15:32:06Z",
        "created_at": "2018-11-05T01:43:59Z",
        "updated_at": "2022-12-23T04:16:30Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "9355578a77978a0c2f189bd7315a2883142d8119",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36449,
        "stargazers_count": 80946,
        "watchers_count": 80946,
        "size": 273774,
        "default_branch": "master",
        "open_issues_count": 684,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-12-30T21:40:15Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-12-31T03:32:27Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 93,
    "deletions": 51,
    "changed_files": 4,
    "commits": 5,
    "review_comments": 50,
    "comments": 33
  },
  "events": [
    {
      "event": "commented",
      "id": 2276408912,
      "node_id": "IC_kwDOABII586Hrz5Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2276408912",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-08T18:21:08Z",
      "updated_at": "2024-12-31T03:51:51Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/30611.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [l0rinc](https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2564375695) |\n\nIf your review is incorrectly listed, please react with ðŸ‘Ž to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#30610](https://github.com/bitcoin/bitcoin/pull/30610) (validation: do not wipe utxo cache for stats/scans/snapshots by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2276408912",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "labeled",
      "id": 13810695676,
      "node_id": "LE_lADOABII586SaWKgzwAAAAM3Ln38",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13810695676",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-08T18:21:10Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13810731181,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAAM3Lwit",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13810731181",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "created_at": "2024-08-08T18:24:53Z"
    },
    {
      "event": "commented",
      "id": 2276630980,
      "node_id": "IC_kwDOABII586HsqHE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2276630980",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-08T20:51:14Z",
      "updated_at": "2024-08-08T20:53:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "Before someone suggests that it should do this every block,  a reason to not do this too much is that delaying writes prevents many writes from ever happening at all because many outputs are quickly spent.\r\n\r\nI don't see a particular problem for this, there will be some write traffic increase but I don't expect it will be enough to meaningfully reduce the life time of flash on cheap devices (and if that were a concern the default level of logging is probably more of an issue).  It's the sort of thing someone could test, however.\r\n\r\nSomeone might also want to test the latency impact (e.g. on block template creation) of the traversal.\r\n\r\nThough long term it would be preferable to introduce a data structure to track pending writes and keep a constantly flushing going which always lags the tip by N blocks, both avoiding the latency spikes and preventing unnecessary writes of entries that are just going to be spent in the next couple blocks.\r\n",
      "user": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2276630980",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "reviewed",
      "id": 2230536256,
      "node_id": "PRR_kwDOABII586E80hA",
      "url": null,
      "actor": null,
      "commit_id": "81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Did you check if this would slow down IBD noticeably when running with a large dbcache?\r\nIf i understand it right, coins that are created and destroyed more than 1 hour of syncing apart would not have been written to disk before, but will be written and deleted after this PR - though presumably this is not a frequent event, so there wouldn't be much of an impact?!",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2230536256",
      "submitted_at": "2024-08-09T15:49:43Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "commented",
      "id": 2278349582,
      "node_id": "IC_kwDOABII586HzNsO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2278349582",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-09T16:47:34Z",
      "updated_at": "2024-08-09T16:47:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Before someone suggests that it should do this every block, a reason to not do this too much is that delaying writes prevents many writes from ever happening at all because many outputs are quickly spent.\r\n\r\n> If i understand it right, coins that are created and destroyed more than 1 hour of syncing apart would not have been written to disk before, but will be written and deleted after this PR\r\n\r\nCorrect, there will be significantly less utxo cut through with this PR.\r\n\r\n> I don't see a particular problem for this, there will be some write traffic increase but I don't expect it will be enough to meaningfully reduce the life time of flash on cheap devices (and if that were a concern the default level of logging is probably more of an issue). It's the sort of thing someone could test, however.\r\n\r\n> though presumably this is not a frequent event, so there wouldn't be much of an impact?!\r\n\r\nFor normal operation, this would mean writing 10s of MB every hour, vs 100s of MB every 24 hours. I don't think that we should be concerned about that increase in disk IO? Seems negligible to me.\r\n\r\n> Did you check if this would slow down IBD noticeably when running with a large dbcache?\r\n\r\nNot yet. I will run a reindex-chainstate benchmark with max dbcache and see what the impact is.\r\n\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2278349582",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2278726067,
      "node_id": "IC_kwDOABII586H0pmz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2278726067",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-09T20:40:11Z",
      "updated_at": "2024-08-09T20:41:50Z",
      "author_association": "MEMBER",
      "body": "It would be good to know what impact it has on IBD, as it's necessarily going to make things slower (more syncs means more disk writes, and more memory/cpu to remember UTXOs which must be marked spent on disk), for the benefit of reducing losses in case of crashes. The question is how much time & I/O it adds.\r\n\r\nRegarding doing it for every block (during steady state), the trade-off there is different but still exists. On the pro side there is a reduction of latency spikes instead of reducing crash losses (as these are inherently less relevant in steady state). On the con side there is an increase in frequency of writes (and the latency spikes they bring, albeit smaller ones) instead of a sync speed slowdown.\r\n\r\nWe don't necessarily need to use the same sync frequency during IBD and during steady state, but the effects during steady state seem harder to measure, so it's hard to say what is acceptable there.\r\n\r\nOne related idea: maybe we should randomize the sync event times a bit (say, uniformly random intervals between 50 and 70 minutes) to prevent a situation where the network over time settles into a few cohorts of synchronized syncers (think like communicating metronomes: they start randomly, but have synchronized events (blocks arriving) that slightly delay sync events if they were to coincide).",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2278726067",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2278793149,
      "node_id": "IC_kwDOABII586H05-9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2278793149",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-09T21:44:31Z",
      "updated_at": "2024-08-09T21:44:31Z",
      "author_association": "CONTRIBUTOR",
      "body": "> It would be good to know what impact it has on IBD, as it's necessarily going to make things slower\n\nNote that it is only necessarily slower when running with very high dbcache settings. For default settings the cache fills up and is flushed far more often than every hour, so this will have no effect.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2278793149",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2281899749,
      "node_id": "IC_kwDOABII586IAwbl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2281899749",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-10T13:54:13Z",
      "updated_at": "2024-08-10T13:54:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "This change didn't appear to have any speed impact for a reindex-chainstate using max dbcache. Ran the following benchmark:\r\n```\r\nnohup hyperfine \\\r\n--export-markdown ~/bench.md \\\r\n--show-output \\\r\n--parameter-list commit 81508954f1f89f95b6fdca10c3c471cdb6566c80,27a770b34b8f1dbb84760f442edb3e23a0c2420b \\\r\n--prepare 'git checkout {commit} && \\\r\nmake -j$(nproc) src/bitcoind; \\\r\nsync; sudo /sbin/sysctl vm.drop_caches=3;' \\\r\n-M 2 \\\r\n'echo '{commit}' && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-reindex-chainstate \\\r\n-dbcache=16384 \\\r\n-printtoconsole=0 \\\r\n-connect=0 \\\r\n-stopatheight=820000' &\r\n```\r\n\r\nResults are the same:\r\n\r\n```\r\nBenchmark 1: echo 81508954f1f89f95b6fdca10c3c471cdb6566c80 && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-reindex-chainstate \\\r\n-dbcache=16384 \\\r\n-printtoconsole=0 \\\r\n-connect=0 \\\r\n-stopatheight=820000\r\n\r\n81508954f1f89f95b6fdca10c3c471cdb6566c80\r\n  Time (mean Â± Ïƒ):     12239.620 s Â±  3.156 s    [User: 12366.988 s, System: 562.121 s]\r\n  Range (min â€¦ max):   12237.388 s â€¦ 12241.851 s    2 runs\r\n \r\nBenchmark 2: echo 27a770b34b8f1dbb84760f442edb3e23a0c2420b && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-reindex-chainstate \\\r\n-dbcache=16384 \\\r\n-printtoconsole=0 \\\r\n-connect=0 \\\r\n-stopatheight=820000\r\n\r\n27a770b34b8f1dbb84760f442edb3e23a0c2420b\r\n  Time (mean Â± Ïƒ):     12243.072 s Â±  6.588 s    [User: 12382.386 s, System: 559.349 s]\r\n  Range (min â€¦ max):   12238.413 s â€¦ 12247.730 s    2 runs\r\n \r\nSummary\r\n  'echo 81508954f1f89f95b6fdca10c3c471cdb6566c80 && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-reindex-chainstate \\\r\n-dbcache=16384 \\\r\n-printtoconsole=0 \\\r\n-connect=0 \\\r\n-stopatheight=820000' ran\r\n    1.00 Â± 0.00 times faster than 'echo 27a770b34b8f1dbb84760f442edb3e23a0c2420b && \\\r\n./src/bitcoind -datadir=/home/user/.bitcoin \\\r\n-reindex-chainstate \\\r\n-dbcache=16384 \\\r\n-printtoconsole=0 \\\r\n-connect=0 \\\r\n-stopatheight=820000'\r\n```\r\n\r\nSo, I would say this PR is strictly beneficial for IBD/reindex-chainstate. It is the same speed, but protects against data loss.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2281899749",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2282238485,
      "node_id": "IC_kwDOABII586ICDIV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2282238485",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-10T18:32:49Z",
      "updated_at": "2024-08-10T18:32:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "I didn't comment on IBD because I figured a hit per hour isn't that significant in the context of IBD and likely pays for itself in improving crash robustness.  I'm a little surprised that the effect is quite so small, but it does probably improve performance too by making writes a little more concurrent.\r\n\r\nSipa: good point on the injection locking, I've previously wondered if the the 24 hour behavior could sync up.",
      "user": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2282238485",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2290369678,
      "node_id": "IC_kwDOABII586IhESO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2290369678",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-15T02:14:10Z",
      "updated_at": "2024-08-15T02:58:49Z",
      "author_association": "CONTRIBUTOR",
      "body": ">  I'm a little surprised that the effect is quite so small\r\n\r\n@gmaxwell I was as well, so I ran the same benchmark with `-reindex` as well and it gave me similar results:\r\n\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 81508954f1f89f95b6fdca10c3c471cdb6566c80 && ./src/bitcoind -datadir=/home/user/.bitcoin -reindex -dbcache=16384 -printtoconsole=0 -connect=0 -stopatheight=820000` | 40765.075 Â± 132.452 | 40671.417 | 40858.733 | 1.01 Â± 0.00 |\r\n| `echo 27a770b34b8f1dbb84760f442edb3e23a0c2420b && ./src/bitcoind -datadir=/home/user/.bitcoin -reindex -dbcache=16384 -printtoconsole=0 -connect=0 -stopatheight=820000` | 40536.484 Â± 46.379 | 40503.689 | 40569.279 | 1.00 |\r\n\r\n\r\nWill get some measurements for total chainstate bytes written and total time writing chainstate before and after this change during steady state. But, this will take a few weeks to get meaningful data. Even then there will be a lot of variance depending on how many utxos are being eagerly spent within 24 hours vs 1 hour at the time I am measuring.\r\n\r\n> Someone might also want to test the latency impact (e.g. on block template creation) of the traversal.\r\n\r\nI'm not sure I understand what you are suggesting to measure here, or what you mean by traversal. We can measure the total time writing chainstate to disk with `-debug=bench`, which would be the latency impact if that's what you mean.\r\n\r\n> Though long term it would be preferable to introduce a data structure to track pending writes and keep a constantly flushing going which always lags the tip by N blocks, both avoiding the latency spikes and preventing unnecessary writes of entries that are just going to be spent in the next couple blocks.\r\n\r\nYou mentioned a similar idea a while ago [here](https://github.com/bitcoin/bitcoin/pull/15265#issuecomment-457792904). I agree with you there that it is a much bigger project. If this change is accepted and merged, would there really be a benefit anymore of adding something like that?",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2290369678",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "mentioned",
      "id": 13890066178,
      "node_id": "MEE_lADOABII586SaWKgzwAAAAM76ZcC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13890066178",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-15T02:14:11Z"
    },
    {
      "event": "subscribed",
      "id": 13890066189,
      "node_id": "SE_lADOABII586SaWKgzwAAAAM76ZcN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13890066189",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-15T02:14:11Z"
    },
    {
      "event": "commented",
      "id": 2296577863,
      "node_id": "IC_kwDOABII586I4v9H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2296577863",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-19T13:26:54Z",
      "updated_at": "2024-08-19T13:26:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'll review this in more detail later, but I have a question first:\r\nWhenever a production change is made without corresponding test changes (yet the build passes), it suggests to me that there might be a gap in our coverage.\r\nDo you think it would make sense to add a test that reproduces some aspect of the old behavior before making the changeâ€”one that would need to be updated in the commit that introduces the change?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2296577863",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2296587174,
      "node_id": "IC_kwDOABII586I4yOm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2296587174",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-19T13:31:03Z",
      "updated_at": "2024-08-19T13:31:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "> it would make sense to add a test that reproduces some aspect of the old behavior before making the changeâ€”one that would need to be updated in the commit that introduces the change?\r\n\r\nGood point, I can add a test that that expects flush every 24 hours, then reduce it to 1 hour after this change.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2296587174",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "reviewed",
      "id": 2245573919,
      "node_id": "PRR_kwDOABII586F2L0f",
      "url": null,
      "actor": null,
      "commit_id": "81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2245573919",
      "submitted_at": "2024-08-19T13:37:04Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "subscribed",
      "id": 14034224085,
      "node_id": "SE_lADOABII586SaWKgzwAAAANEgUPV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14034224085",
      "actor": {
        "login": "eragmus",
        "id": 11140618,
        "node_id": "MDQ6VXNlcjExMTQwNjE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11140618?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/eragmus",
        "html_url": "https://github.com/eragmus",
        "followers_url": "https://api.github.com/users/eragmus/followers",
        "following_url": "https://api.github.com/users/eragmus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/eragmus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/eragmus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/eragmus/subscriptions",
        "organizations_url": "https://api.github.com/users/eragmus/orgs",
        "repos_url": "https://api.github.com/users/eragmus/repos",
        "events_url": "https://api.github.com/users/eragmus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/eragmus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-27T20:05:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14092316217,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANH9645",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14092316217",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "ff65e951b761199820e70e11637c8891ef79d907",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ff65e951b761199820e70e11637c8891ef79d907",
      "created_at": "2024-08-31T17:43:35Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14092323836,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANH98v8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14092323836",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "66499fb5d8adcff27db0d7486d07f939d84755c0",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/66499fb5d8adcff27db0d7486d07f939d84755c0",
      "created_at": "2024-08-31T17:47:20Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14092348373,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANH-CvV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14092348373",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "created_at": "2024-08-31T17:58:59Z"
    },
    {
      "event": "labeled",
      "id": 14092348455,
      "node_id": "LE_lADOABII586SaWKgzwAAAANH-Cwn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14092348455",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-31T17:59:03Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2322994750,
      "node_id": "IC_kwDOABII586KdhY-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2322994750",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-31T17:59:04Z",
      "updated_at": "2024-08-31T17:59:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/29514781087</sub>\n\n<details><summary>Hints</summary>\n\nMake sure to run all tests locally, according to the documentation.\n\nThe failure may happen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2322994750",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "unlabeled",
      "id": 14092510957,
      "node_id": "UNLE_lADOABII586SaWKgzwAAAANH-qbt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14092510957",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-08-31T19:28:30Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2274461800,
      "node_id": "PRR_kwDOABII586HkYho",
      "url": null,
      "actor": null,
      "commit_id": "1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2274461800",
      "submitted_at": "2024-09-01T17:40:03Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "commented",
      "id": 2323622796,
      "node_id": "IC_kwDOABII586Kf6uM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2323622796",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T01:50:30Z",
      "updated_at": "2024-09-08T16:43:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "I got some stats for running in steady state for this branch and master.\r\nI ran 4 nodes for 11 days and 18 hours using identical aws t2-small instances backed by 20GB EBS volumes all connected to another node in the same VPC.\r\n\r\n|  Branch | Total time writing chainstate | Total bytes written |\r\n|-----------:|----------:|----------:|\r\n| master 1 | 26372ms |497 MiB |\r\n| master 2 | 28188ms | 497 MiB |\r\n| branch 1 | 32496ms | 760 MiB |\r\n| branch 2 | 32566ms | 760 MiB |\r\n\r\nBy writing every hour, we write about 50% more data, but we are only spending 20% more time writing.\r\nOn master we write about 42 MiB every 24 hours which locks the main thread for 2.3 seconds.\r\nOn this branch we write about 2.7 MiB every hour which locks the main thread for 115 milliseconds.\r\nSo it's about 0.9 MiB more data written every hour, which I think is a negligible amount. Note that this extra data is ephemeral and will be erased as these extra utxos are spent. It will not cause nodes to have to store more data.\r\n\r\nHere are the write operations charts for the time period. You can see the write operations are more evenly spaced out by writing every hour.\r\n![Master 1](https://github.com/user-attachments/assets/8770d491-4783-4503-9c26-f0dabce6af84)\r\n![Master 2](https://github.com/user-attachments/assets/776a21f1-3a1f-4cd5-b3b6-d5f39345cb14)\r\n![Branch 2](https://github.com/user-attachments/assets/6c2f25c9-2ab8-4aeb-bb01-9fb53247e91d)\r\n![Branch 1](https://github.com/user-attachments/assets/95ce7896-d483-4dc3-a106-17d75e7973c4)\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2323622796",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14096668820,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIOhiU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096668820",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "ff9c90b9599155c8743df879a9592b72cc3f9431",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ff9c90b9599155c8743df879a9592b72cc3f9431",
      "created_at": "2024-09-02T02:23:57Z"
    },
    {
      "event": "commented",
      "id": 2323654975,
      "node_id": "IC_kwDOABII586KgCk_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2323654975",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:46Z",
      "updated_at": "2024-09-02T02:26:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "@gmaxwell @l0rinc @mzumsande @sipa thank you all for your reviews! I've updated the PR to have a random window for periodic flushes of between 50 and 70 minutes. I've also added a unit test that checks for a flush in this window. That unit test can be cherry-picked to master and verified that it does not pass.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2323654975",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "mentioned",
      "id": 14096683053,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANIOlAt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683053",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "subscribed",
      "id": 14096683058,
      "node_id": "SE_lADOABII586SaWKgzwAAAANIOlAy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683058",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "mentioned",
      "id": 14096683064,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANIOlA4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683064",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "subscribed",
      "id": 14096683068,
      "node_id": "SE_lADOABII586SaWKgzwAAAANIOlA8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683068",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "mentioned",
      "id": 14096683074,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANIOlBC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683074",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "subscribed",
      "id": 14096683078,
      "node_id": "SE_lADOABII586SaWKgzwAAAANIOlBG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683078",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "mentioned",
      "id": 14096683083,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANIOlBL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683083",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "subscribed",
      "id": 14096683086,
      "node_id": "SE_lADOABII586SaWKgzwAAAANIOlBO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14096683086",
      "actor": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T02:26:47Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14097202202,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIQjwa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14097202202",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "created_at": "2024-09-02T04:12:33Z"
    },
    {
      "event": "commented",
      "id": 2324700313,
      "node_id": "IC_kwDOABII586KkByZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2324700313",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T12:57:04Z",
      "updated_at": "2024-09-02T12:57:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "The test runs unreliably for some reason, we need to fix that first.\r\n\r\nNACK 5cad9d16dd07859a76c6637789695bf1b4f36e1c\r\n\r\n> On this branch [...] main thread for 115 milliseconds.\r\n\r\nThis sounds awesome!\r\n\r\n> Good point, I can add a test that that expects flush every 24 hours, then reduce it to 1 hour after this change.\r\n\r\nDo you think we could still do something like this, i.e. add a test as a very first commit, which reproduces the old behavior first?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2324700313",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "reviewed",
      "id": 2275381925,
      "node_id": "PRR_kwDOABII586Hn5Kl",
      "url": null,
      "actor": null,
      "commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2275381925",
      "submitted_at": "2024-09-02T12:57:23Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14104308029,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIrqk9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14104308029",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "d4eb96c3bcf3adac77c16eebb482302ae8104e36",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d4eb96c3bcf3adac77c16eebb482302ae8104e36",
      "created_at": "2024-09-02T14:15:33Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14104447003,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIsMgb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14104447003",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "b7a0cd85d27ca2f44b9cba079ba8f3d90c02fa14",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b7a0cd85d27ca2f44b9cba079ba8f3d90c02fa14",
      "created_at": "2024-09-02T14:26:28Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14104705306,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANItLka",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14104705306",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "dcec44505af0cb695116a40b5ca81e4da5b9dff4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/dcec44505af0cb695116a40b5ca81e4da5b9dff4",
      "created_at": "2024-09-02T14:47:57Z"
    },
    {
      "event": "commented",
      "id": 2324918318,
      "node_id": "IC_kwDOABII586Kk3Au",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2324918318",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-02T14:48:43Z",
      "updated_at": "2024-09-02T14:48:43Z",
      "author_association": "CONTRIBUTOR",
      "body": "> add a test as a very first commit, which reproduces the old behavior first?\r\n\r\nYeah, I realize the test commit can't be cherry-picked cleanly to master. Updated to have the test commit first, and update the test for each change.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2324918318",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14105073703,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIulgn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14105073703",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "created_at": "2024-09-02T15:20:26Z"
    },
    {
      "event": "reviewed",
      "id": 2275958237,
      "node_id": "PRR_kwDOABII586HqF3d",
      "url": null,
      "actor": null,
      "commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2275958237",
      "submitted_at": "2024-09-02T16:17:10Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "reviewed",
      "id": 2275960774,
      "node_id": "PRR_kwDOABII586HqGfG",
      "url": null,
      "actor": null,
      "commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2275960774",
      "submitted_at": "2024-09-02T16:19:58Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14105786185,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANIxTdJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14105786185",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "a2e8f7df1ca94c662183702ad3f41228c5ed7d17",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a2e8f7df1ca94c662183702ad3f41228c5ed7d17",
      "created_at": "2024-09-02T16:41:47Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14108470347,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANI7ixL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14108470347",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1b448f5bca7fba361da773c72633ae9056ee0d23",
      "created_at": "2024-09-03T02:32:52Z"
    },
    {
      "event": "unsubscribed",
      "id": 14112195340,
      "node_id": "UE_lADOABII586SaWKgzwAAAANJJwMM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14112195340",
      "actor": {
        "login": "eragmus",
        "id": 11140618,
        "node_id": "MDQ6VXNlcjExMTQwNjE4",
        "avatar_url": "https://avatars.githubusercontent.com/u/11140618?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/eragmus",
        "html_url": "https://github.com/eragmus",
        "followers_url": "https://api.github.com/users/eragmus/followers",
        "following_url": "https://api.github.com/users/eragmus/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/eragmus/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/eragmus/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/eragmus/subscriptions",
        "organizations_url": "https://api.github.com/users/eragmus/orgs",
        "repos_url": "https://api.github.com/users/eragmus/repos",
        "events_url": "https://api.github.com/users/eragmus/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/eragmus/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-03T09:31:43Z"
    },
    {
      "event": "reviewed",
      "id": 2276771072,
      "node_id": "PRR_kwDOABII586HtMUA",
      "url": null,
      "actor": null,
      "commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for quick responses, my main concern at this stage is that the commit messages don't explain the changes in enough detail and some symbols might need a rename after the change",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2276771072",
      "submitted_at": "2024-09-03T09:34:31Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "labeled",
      "id": 14172743633,
      "node_id": "LE_lADOABII586SaWKgzwAAAANMwufR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14172743633",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-07T22:11:25Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14174510157,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANM3dxN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14174510157",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "ffc9df87a0da35b451720556bdb3f0f65f315c8f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ffc9df87a0da35b451720556bdb3f0f65f315c8f",
      "created_at": "2024-09-08T15:58:11Z"
    },
    {
      "event": "unlabeled",
      "id": 14174715265,
      "node_id": "UNLE_lADOABII586SaWKgzwAAAANM4P2B",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14174715265",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-08T17:49:22Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2336783216,
      "node_id": "IC_kwDOABII586LSHtw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2336783216",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-08T18:39:04Z",
      "updated_at": "2024-09-08T19:51:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "Running\r\n```bash\r\nhyperfine \\\r\n--runs 5 \\\r\n--export-json /mnt/ibd_full.json \\\r\n--parameter-list COMMIT 8aabdfa6,1b448f5b \\\r\n--prepare 'git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build && cmake --build build -j8 && rm -rf /mnt/BitcoinData/*' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0'\r\n```\r\non a `HDD SATA 2,0 TB Enterprise` resulted in:\r\n```python\r\n Benchmark 1: COMMIT=8aabdfa6 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0\r\n  Time (mean Â± Ïƒ):     33934.695 s Â± 530.080 s    [User: 27857.218 s, System: 1873.581 s]\r\n  Range (min â€¦ max):   33208.510 s â€¦ 34511.668 s    5 runs\r\n```\r\n```python\r\nBenchmark 2: COMMIT=1b448f5b ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0\r\n  Time (mean Â± Ïƒ):     36605.266 s Â± 584.663 s    [User: 29487.564 s, System: 2228.572 s]\r\n  Range (min â€¦ max):   35846.681 s â€¦ 37275.497 s    5 runs\r\n```\r\n```python\r\nSummary\r\n  COMMIT=8aabdfa6 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0 ran\r\n    1.08 Â± 0.02 times faster than COMMIT=1b448f5b ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0\r\n ```\r\n\r\n<details>\r\n<summary>ibd_full.json</summary>\r\n\r\n```json\r\n \"results\": [\r\n    {\r\n      \"command\": \"COMMIT=8aabdfa6 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0\",\r\n      \"mean\": 33934.69470762795,\r\n      \"stddev\": 530.0799467530879,\r\n      \"median\": 34177.67060207214,\r\n      \"user\": 27857.2184555,\r\n      \"system\": 1873.58075582,\r\n      \"min\": 33208.50992151314,\r\n      \"max\": 34511.66842756214,\r\n      \"times\": [\r\n        33208.50992151314,\r\n        34511.66842756214,\r\n        33571.37685305914,\r\n        34177.67060207214,\r\n        34204.24773393314\r\n      ],\r\n      \"exit_codes\": [\r\n        0,\r\n        0,\r\n        0,\r\n        0,\r\n        0\r\n      ],\r\n      \"parameters\": {\r\n        \"COMMIT\": \"8aabdfa6\"\r\n      }\r\n    },\r\n    {\r\n      \"command\": \"COMMIT=1b448f5b ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=820000 -dbcache=16384 -printtoconsole=0\",\r\n      \"mean\": 36605.26595186774,\r\n      \"stddev\": 584.6634786404139,\r\n      \"median\": 36732.99369363214,\r\n      \"user\": 29487.564016900003,\r\n      \"system\": 2228.57235822,\r\n      \"min\": 35846.68126299314,\r\n      \"max\": 37275.49678005814,\r\n      \"times\": [\r\n        36182.10911623014,\r\n        37275.49678005814,\r\n        36732.99369363214,\r\n        36989.04890642514,\r\n        35846.68126299314\r\n      ],\r\n      \"exit_codes\": [\r\n        0,\r\n        0,\r\n        0,\r\n        0,\r\n        0\r\n      ],\r\n      \"parameters\": {\r\n        \"COMMIT\": \"1b448f5b\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n</details>\r\n\r\n \r\nSo running the benchmark for almost 100 hours, having a standard deviation of ~9 minutes for both benchmarks (5 runs per commit) reveals that the full pre-assumevalid IBD consistently takes ~45 minutes (8%) longer after the change.\r\n\r\nNote that this was also run with actual nodes (i.e. non-local copies) to be as realistic as possible and was using a HDD.\r\n\r\nEdit: could we maybe test a 100-200 minute window instead of 60?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2336783216",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "mentioned",
      "id": 14174804653,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANM4lqt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14174804653",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-08T18:39:05Z"
    },
    {
      "event": "subscribed",
      "id": 14174804657,
      "node_id": "SE_lADOABII586SaWKgzwAAAANM4lqx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14174804657",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-08T18:39:05Z"
    },
    {
      "event": "labeled",
      "id": 14186856474,
      "node_id": "LE_lADOABII586SaWKgzwAAAANNmkAa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14186856474",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-09T17:23:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 14253803620,
      "node_id": "UNLE_lADOABII586SaWKgzwAAAANRl8hk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14253803620",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T20:02:18Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14354632445,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAANXmk79",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14354632445",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "391c87640d78d9821b87e3f3de755af40a191d24",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/391c87640d78d9821b87e3f3de755af40a191d24",
      "created_at": "2024-09-22T13:09:46Z"
    },
    {
      "event": "commented",
      "id": 2366787167,
      "node_id": "IC_kwDOABII586NEk5f",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2366787167",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-22T13:23:15Z",
      "updated_at": "2024-09-22T18:02:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased to benchmark `reindex-chainstate` with #28358 and a cache size holding the entire utxo set.\r\n\r\n>  the full pre-assumevalid IBD consistently takes ~45 minutes (8%) longer after the change\r\n\r\nI got a hold of an HDD, and surprisingly my benchmarks show the opposite. I kept the blocksdir on the SSD and only had the datadir on the HDD to isolate the effects of this change. When changing from writing at the end to writing every hour, writing every hour was ~25 minutes (6%) faster.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 484aee0e16aff9c5fcfe66157c67bf29c66baa2a && ./build/src/bitcoind -datadir=/media/user/Barracuda/bitcoin -blocksdir=/home/user/.bitcoin -dbcache=27000 -reindex-chainstate -printtoconsole=0 -connect=0 -stopatheight=840000` | 25447.840 Â± 390.609 | 25171.638 | 25724.043 | 1.00 |\r\n| `echo 17cf3d64b8a56763b9aff8b8af6ac8bd2b100ff6 && ./build/src/bitcoind -datadir=/media/user/Barracuda/bitcoin -blocksdir=/home/user/.bitcoin -dbcache=27000 -reindex-chainstate -printtoconsole=0 -connect=0 -stopatheight=840000` | 26932.607 Â± 232.182 | 26768.430 | 27096.785 | 1.06 Â± 0.02 |\r\n\r\nNotably, before this change flushing the chainstate to disk at the end of the reindex took longer than the entire reindex into memory on an HDD (4 hours of flushing and ~7.5 hours total time). During that entire flush bitcoind will be unresponsive as the main lock is held. So, this change is also a UX improvement because the writes will be more spaced out and not block RPC responses.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2366787167",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2374018307,
      "node_id": "IC_kwDOABII586NgKUD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2374018307",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-25T12:58:33Z",
      "updated_at": "2024-09-25T13:06:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "I did a rebased `-reindex-chainstate` as well, this seems to be basically the same as before:\r\n\r\n<details>\r\n<summary>Benchmark</summary>\r\n\r\n```bash\r\n# git checkout 33adc7521cc8bb24b941d959022b084002ba7c60\r\nHEAD is now at 33adc7521c Merge bitcoin/bitcoin#30765: refactor: Allow `CScript`'s `operator<<` to accept spans, not just vectors\r\n\r\n# git checkout 391c87640d78d9821b87e3f3de755af40a191d24\r\nHEAD is now at 391c87640d validation: add randomness to periodic write interval\r\n\r\nhyperfine \\\r\n--runs 3 \\\r\n--export-json /mnt/ibd_full-30611.json \\\r\n--parameter-list COMMIT 33adc7521cc8bb24b941d959022b084002ba7c60,391c87640d78d9821b87e3f3de755af40a191d24 \\\r\n--prepare 'git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build && cmake --build build -j8' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -reindex-chainstate -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n> Benchmark 1: COMMIT=33adc7521cc8bb24b941d959022b084002ba7c60 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -reindex-chainstate -printtoconsole=0\r\n```\r\n  Time (mean Â± Ïƒ):     22795.930 s Â± 42.220 s    [User: 19545.844 s, System: 926.963 s]\r\n  Range (min â€¦ max):   22756.042 s â€¦ 22840.149 s    3 runs\r\n```\r\n\r\n> Benchmark 2: COMMIT=391c87640d78d9821b87e3f3de755af40a191d24 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -reindex-chainstate -printtoconsole=0\r\n```\r\n  Time (mean Â± Ïƒ):     22962.909 s Â± 457.340 s    [User: 19563.315 s, System: 923.347 s]\r\n  Range (min â€¦ max):   22461.120 s â€¦ 23356.337 s    3 runs\r\n```\r\n\r\n<details>\r\n<summary>Summary</summary>\r\n\r\n```bash\r\n  COMMIT=33adc7521cc8bb24b941d959022b084002ba7c60 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -reindex-chainstate -printtoconsole=0 ran\r\n    1.01 Â± 0.02 times faster than COMMIT=391c87640d78d9821b87e3f3de755af40a191d24 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -reindex-chainstate -printtoconsole=0\r\n```\r\n\r\n</details>\r\n\r\n-----\r\n\r\nI'll rerun on a full IBD for the same params:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```bash\r\nhyperfine \\\r\n--runs 3 \\\r\n--export-json /mnt/ibd-30611-full.json \\\r\n--parameter-list COMMIT 33adc7521cc8bb24b941d959022b084002ba7c60,391c87640d78d9821b87e3f3de755af40a191d24 \\\r\n--prepare 'git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build && cmake --build build -j8 && rm -rf /mnt/BitcoinData/*' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0'\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2374018307",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2374069851,
      "node_id": "IC_kwDOABII586NgW5b",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2374069851",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-25T13:20:13Z",
      "updated_at": "2024-09-25T13:20:13Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I did a rebased -reindex-chainstate as well, this seems to be basically the same as before:\r\n\r\nNice, so there's no speed regression but crash resistance gained!\r\n\r\nAlso, I benchmarked only at 484aee0e16aff9c5fcfe66157c67bf29c66baa2a instead of 391c87640d78d9821b87e3f3de755af40a191d24 so that there's no randomness in the benchmarks. It can give us a better picture of what this PR affects.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2374069851",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2374081579,
      "node_id": "IC_kwDOABII586NgZwr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2374081579",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-25T13:24:55Z",
      "updated_at": "2024-09-25T13:24:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "> so that there's no randomness in the benchmarks\r\n\r\nI've rebased on master to have up-to-date data. What kind of randomness are you referring to?\r\n\r\n> there's no speed regression\r\n\r\n3 benchmarks, all showed different things.\r\nWe have to find out what causes these differences, that's why I want to try a complete IBD again (which seems like the only downside so far), since ultimately most people won't have blocksdir on the SSD and datadir on the HDD doing a reindex.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2374081579",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2374093681,
      "node_id": "IC_kwDOABII586Ngctx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2374093681",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-25T13:29:45Z",
      "updated_at": "2024-09-25T13:29:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "> What kind of randomness are you referring to?\r\n\r\nThe random window for when this PR will flush introduced in the last commit. That is good for steady state operation to not have all nodes converge on the same flush time. But, for benchmarking a reindex or IBD it will just add randomness to the results.\r\n\r\n> 3 benchmarks, all showed different things.\r\n\r\nWell, they are all different benchmarks with different variables. Changing more variables by running different benchmarks won't necessarily give us a clearer picture.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2374093681",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2380875224,
      "node_id": "IC_kwDOABII586N6UXY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2380875224",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-28T19:36:37Z",
      "updated_at": "2024-09-28T19:39:53Z",
      "author_association": "CONTRIBUTOR",
      "body": "> running different benchmarks won't necessarily give us a clearer picture.\r\n\r\nIt could get confusing if they're not pointing in the same direction (which seems to be the case here).\r\nBut we need to investigate, we can't have surprises, right?\r\n\r\n----\r\n\r\nI reran the previous full IBD on the previous setup with HDD, but this time until 860000 with 30gb memory.\r\n\r\n<details>\r\n<summary>benchmark</summary>\r\n\r\n```bash\r\nhyperfine --runs 3 \\\r\n--export-json /mnt/ibd-30611-full.json \\\r\n--parameter-list COMMIT 33adc7521cc8bb24b941d959022b084002ba7c60,391c87640d78d9821b87e3f3de755af40a191d24 \\\r\n--prepare 'git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build && cmake --build build -j8 && rm -rf /mnt/BitcoinData/*' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n> Benchmark 1: COMMIT=33adc7521cc8bb24b941d959022b084002ba7c60 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0\r\n```\r\n  Time (mean Â± Ïƒ):     37410.149 s Â± 264.840 s    [User: 32792.866 s, System: 1938.561 s]\r\n  Range (min â€¦ max):   37105.210 s â€¦ 37582.606 s    3 runs\r\n```\r\n\r\nI.e. the three independent measurements before the change were:\r\n* 10.42 hours\r\n* 10.43 hours\r\n* 10.30 hours\r\n\r\n<details>\r\n<summary>raw measurements in seconds</summary>\r\n\r\n* 37542.6300163161\r\n* 37582.6056244741\r\n* 37105.2102307041\r\n\r\n</details>\r\n\r\n> Benchmark 2: COMMIT=391c87640d78d9821b87e3f3de755af40a191d24 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0\r\n  Time (mean Â± Ïƒ):     41970.584 s Â± 995.527 s    [User: 35046.785 s, System: 2172.531 s]\r\n  Range (min â€¦ max):   41203.415 s â€¦ 43095.560 s    3 runs\r\n  \r\nHaving the measurements: \r\n* 11.44 hours\r\n* 11.97 hours\r\n* 11.55 hours\r\n\r\n<details>\r\n<summary>raw measurements in seconds</summary>\r\n\r\n* 41203.4147152671\r\n* 43095.5604828261\r\n* 41612.7761091461\r\n\r\n</details>\r\n\r\n---\r\n\r\n> Summary\r\n  COMMIT=33adc7521cc8bb24b941d959022b084002ba7c60 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0 ran\r\n    1.12 Â± 0.03 times faster than COMMIT=391c87640d78d9821b87e3f3de755af40a191d24 ./build/src/bitcoind -datadir=/mnt/BitcoinData -stopatheight=860000 -dbcache=30000 -printtoconsole=0\r\n\r\ni.e. 10% slower, roughly 1 hour longer IBD on a HDD if we flush every hour.\r\n\r\nAs you can see the measurements are pretty consistently faster before and slower after.\r\nRepeated the same experiment twice, 5 times first time, 3 times now, it doesn't seem like a fluke.\r\n\r\nI understand that it's inconvenient (as the change makes theoretical sense to me), but maybe we can find a different interval (e.g. 100 minutes maybe?) where the difference isn't *this* big.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2380875224",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2382959425,
      "node_id": "IC_kwDOABII586OCRNB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2382959425",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T11:44:53Z",
      "updated_at": "2024-09-30T11:44:53Z",
      "author_association": "CONTRIBUTOR",
      "body": "@davidgumberg mentioned that it's possible flushing the block index is causing the regression. This could also explain why there isn't a regression when the blocksdir is on an SSD and the coinsdb is not.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2382959425",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "mentioned",
      "id": 14454612249,
      "node_id": "MEE_lADOABII586SaWKgzwAAAANdj-EZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14454612249",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T11:44:54Z"
    },
    {
      "event": "subscribed",
      "id": 14454612269,
      "node_id": "SE_lADOABII586SaWKgzwAAAANdj-Et",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14454612269",
      "actor": {
        "login": "davidgumberg",
        "id": 2257631,
        "node_id": "MDQ6VXNlcjIyNTc2MzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/2257631?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/davidgumberg",
        "html_url": "https://github.com/davidgumberg",
        "followers_url": "https://api.github.com/users/davidgumberg/followers",
        "following_url": "https://api.github.com/users/davidgumberg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/davidgumberg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/davidgumberg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/davidgumberg/subscriptions",
        "organizations_url": "https://api.github.com/users/davidgumberg/orgs",
        "repos_url": "https://api.github.com/users/davidgumberg/repos",
        "events_url": "https://api.github.com/users/davidgumberg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/davidgumberg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-30T11:44:54Z"
    },
    {
      "event": "commented",
      "id": 2408917989,
      "node_id": "IC_kwDOABII586PlSvl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2408917989",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-13T10:18:43Z",
      "updated_at": "2024-10-13T13:33:03Z",
      "author_association": "CONTRIBUTOR",
      "body": "I redid the benchmarks on an SSD with 100-120 second range:\r\n* (before) 5e90501abe test: chainstate write test for periodic chainstate flush\r\n* (write every 50-70 minutes) ffc9df87a0 validation: add randomness to periodic write interval\r\n* (write every 100-120 minutes) f5e7b1508a Increase DATABASE_WRITE_INTERVAL MIN/MAX to 100/120\r\n\r\n<details>\r\n<summary>benchmark</summary>\r\n\r\n```bash\r\nhyperfine \\\r\n--runs 1 \\\r\n--export-json /mnt/my_storage/ibd_full-write-chainstate-every-hour.json \\\r\n--parameter-list COMMIT 5e90501abe13731579c61b13092b31b9fc4f8c4d,ffc9df87a0da35b451720556bdb3f0f65f315c8f,f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f \\\r\n--prepare 'rm -rf /mnt/my_storage/BitcoinData/* && git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake \\\r\n--build build -j$(nproc)' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n```bash\r\nBenchmark 1: COMMIT=5e90501abe13731579c61b13092b31b9fc4f8c4d ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        30685.829 s               [User: 29155.745 s, System: 4840.419 s]\r\n\r\nBenchmark 2: COMMIT=ffc9df87a0da35b451720556bdb3f0f65f315c8f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        31140.007 s               [User: 29761.900 s, System: 4909.715 s]\r\n\r\nBenchmark 3: COMMIT=f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        31935.055 s               [User: 29501.483 s, System: 4915.473 s]\r\n\r\nSummary\r\n  'COMMIT=5e90501abe13731579c61b13092b31b9fc4f8c4d ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0' ran\r\n    1.01 times faster than 'COMMIT=ffc9df87a0da35b451720556bdb3f0f65f315c8f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0'\r\n    1.04 times faster than 'COMMIT=f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0'\r\n```\r\n\r\nThe measurements are pretty close this time, I'll try the same on an HDD as well.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2408917989",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2412512371,
      "node_id": "IC_kwDOABII586PzARz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2412512371",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-14T23:26:01Z",
      "updated_at": "2024-10-14T23:26:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "Finished the same benchmarks on a HDD with very similar results:\r\n\r\n<details>\r\n<summary>benchmark</summary>\r\n\r\n```\r\n# hyperfine \\\r\n--runs 1 \\\r\n--export-json /mnt/my_storage/ibd_full-write-chainstate-every-hour.json \\\r\n--parameter-list COMMIT 5e90501abe13731579c61b13092b31b9fc4f8c4d,ffc9df87a0da35b451720556bdb3f0f65f315c8f,f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f \\\r\n--prepare 'rm -rf /mnt/my_storage/BitcoinData/* && git checkout {COMMIT} && git clean -fxd && git reset \\\r\n--hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake \\\r\n--build build -j$(nproc)' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n```bash\r\nBenchmark 1: COMMIT=5e90501abe13731579c61b13092b31b9fc4f8c4d ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        35216.011 s               [User: 28946.209 s, System: 4439.914 s]\r\n\r\nBenchmark 2: COMMIT=ffc9df87a0da35b451720556bdb3f0f65f315c8f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        35007.008 s               [User: 28473.073 s, System: 4140.873 s]\r\n\r\nBenchmark 3: COMMIT=f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n  Time (abs â‰¡):        35625.822 s               [User: 28383.805 s, System: 4280.052 s]\r\n\r\nSummary\r\n  COMMIT=ffc9df87a0da35b451720556bdb3f0f65f315c8f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0 ran\r\n    1.01 times faster than COMMIT=5e90501abe13731579c61b13092b31b9fc4f8c4d ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n    1.02 times faster than COMMIT=f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=2000 -printtoconsole=0\r\n```\r\n\r\n<details>\r\n<summary>commits</summary>\r\n\r\n# git checkout 5e90501abe13731579c61b13092b31b9fc4f8c4d\r\nHEAD is now at 5e90501abe test: chainstate write test for periodic chainstate flush\r\n# git checkout ffc9df87a0da35b451720556bdb3f0f65f315c8f\r\nHEAD is now at ffc9df87a0 validation: add randomness to periodic write interval\r\n# git checkout f5e7b1508a06c0c7a9c06d1ac270840fd72e9e6f\r\nHEAD is now at f5e7b1508a Increase DATABASE_WRITE_INTERVAL MIN/MAX to 100/120\r\n\r\n</details>\r\n\r\n\r\n----\r\n\r\n\r\nBased on these I'm fine with 50/70 or 100/120 minute writes.\r\nApproach ACK - let's discuss whether this is the final form.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2412512371",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "labeled",
      "id": 15248872807,
      "node_id": "LE_lADOABII586SaWKgzwAAAAOM51Vn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15248872807",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-11T11:47:49Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15251891805,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAAONFWZd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15251891805",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "5cf6dcb08a1e64f763dd90ae2d749eb022126cf8",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5cf6dcb08a1e64f763dd90ae2d749eb022126cf8",
      "created_at": "2024-11-11T15:25:01Z"
    },
    {
      "event": "commented",
      "id": 2468440155,
      "node_id": "IC_kwDOABII586TIWhb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2468440155",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-11T15:26:42Z",
      "updated_at": "2024-11-11T15:26:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased for renaming `TRACE5` -> `TRACEPOINT`.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2468440155",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "unlabeled",
      "id": 15252427233,
      "node_id": "UNLE_lADOABII586SaWKgzwAAAAONHZHh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15252427233",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-11T16:04:50Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15518119878,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAAOc87fG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518119878",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "52898da879a9d87c6f2c6803fb58ba4562de0d2c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/52898da879a9d87c6f2c6803fb58ba4562de0d2c",
      "created_at": "2024-12-04T01:47:44Z"
    },
    {
      "event": "commented",
      "id": 2515985691,
      "node_id": "IC_kwDOABII586V9uUb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2515985691",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:49:55Z",
      "updated_at": "2024-12-04T01:49:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased to test performance with #30039.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2515985691",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2525270023,
      "node_id": "IC_kwDOABII586WhJAH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2525270023",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-07T18:27:27Z",
      "updated_at": "2024-12-09T11:05:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "Reran the benchmarks after the rebase (2 sets of reindex-chainstate of 800k blocks) - ~and there doesn't seem to be any speed regression whatsoever because of this change now.~\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```bash\r\n# hyperfine \\\r\n--runs 2 \\\r\n--export-json /mnt/my_storage/ibd_full-write-chainstate-every-hour-rebased.json \\\r\n--parameter-list COMMIT 1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe,5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee \\\r\n--prepare 'git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake --build build -j$(nproc)' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=30000 -printtoconsole=0 -reindex-chainstate -connect=0'             \r\n```\r\n\r\n```                          \r\nBenchmark 1: COMMIT=1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=30000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n  Time (mean Â± Ïƒ):     13914.554 s Â± 45.835 s    [User: 14777.415 s, System: 621.571 s]\r\n  Range (min â€¦ max):   13882.143 s â€¦ 13946.964 s    2 runs\r\n  \r\nBenchmark 2: COMMIT=5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=30000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n  Time (mean Â± Ïƒ):     13803.626 s Â±  6.910 s    [User: 14715.296 s, System: 619.771 s]\r\n  Range (min â€¦ max):   13798.740 s â€¦ 13808.512 s    2 runs\r\n  \r\nSummary\r\n  COMMIT=b981f7e9c010ebd26e49a66a58f5a3e6e2efb3f5 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=30000 -printtoconsole=0 -reindex-chainstate -connect=0 ran\r\n    1.01 Â± 0.00 times faster than COMMIT=1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=800000 -dbcache=30000 -printtoconsole=0 -reindex-chainstate -connect=0\r\n```\r\n\r\n</details>\r\n\r\n~i.e. basically the same speed as before, given enough memory (where this feature shines)~\r\n\r\n\r\n-----\r\n\r\nEdit:\r\nTo make sure the reindex measurements don't cheat (i.e. are representative of an actual IBD), I redid them until 870k blocks with full IBD:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\nhyperfine \\\r\n--runs 1 \\\r\n--export-json /mnt/my_storage/ibd_full-write-chainstate-every-hour-rebased.json \\\r\n--parameter-list COMMIT 1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe,5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee,b981f7e9c010ebd26e49a66a58f5a3e6e2efb3f5 \\\r\n--prepare 'rm -rf /mnt/my_storage/BitcoinData/* && git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake --build build -j$(nproc)' \\\r\n'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0'\r\n```\r\nWhere the commits are:\r\n```\r\n# git show --quiet 1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe                                                                    \r\n    test: chainstate write test for periodic chainstate flush                                                                                                                             \r\n# git show --quiet 5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee                                                                     \r\n    validation: add randomness to periodic write interval                                                                                                                                 \r\n# git show --quiet b981f7e9c010ebd26e49a66a58f5a3e6e2efb3f5                                                                     \r\n    Increase DATABASE_WRITE_INTERVAL MIN/MAX to 100/120                                                                                                                                   \r\n```\r\nmeasuring:\r\n```\r\nBenchmark 1: COMMIT=1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0\r\n  Time (abs â‰¡):        37811.719 s               [User: 43400.650 s, System: 1956.739 s]\r\n  \r\nBenchmark 2: COMMIT=5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0\r\n  Time (abs â‰¡):        39494.552 s               [User: 44407.945 s, System: 1865.964 s]\r\n  \r\nBenchmark 3: COMMIT=b981f7e9c010ebd26e49a66a58f5a3e6e2efb3f5 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0\r\n  Time (abs â‰¡):        39363.239 s               [User: 44125.045 s, System: 1974.385 s]\r\n```\r\nwhich indicates a 4% slowdown (even with 100-120 minutes)\r\n```  \r\nSummary\r\n  COMMIT=1a5d7e0ff5ff8fb73139dc2141dbe231b12f68fe ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0 ran\r\n    1.04 times faster than COMMIT=b981f7e9c010ebd26e49a66a58f5a3e6e2efb3f5 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0\r\n    1.04 times faster than COMMIT=5ae300e55ca18b5398f1255d53dd1c50ba5cd6ee ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=870000 -dbcache=30000 -printtoconsole=0\r\n```\r\n\r\n</details>\r\n\r\n----\r\n\r\n\r\nSo this change seems to slow down actual IBD by roughly 4% - we have to decide if that's acceptable.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2525270023",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "reviewed",
      "id": 2488440265,
      "node_id": "PRR_kwDOABII586UUpXJ",
      "url": null,
      "actor": null,
      "commit_id": "52898da879a9d87c6f2c6803fb58ba4562de0d2c",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "I'm mostly okay with this change, but we need to decide if the 4% IBD slowdown is worth the improved consistency (or if the performance hit can be mitigated somehow).",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2488440265",
      "submitted_at": "2024-12-09T11:00:41Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15639902328,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAAOkNfh4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15639902328",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "5326e68bd645ab9a1b0a6e9095a2695e4e1eeaf7",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5326e68bd645ab9a1b0a6e9095a2695e4e1eeaf7",
      "created_at": "2024-12-12T19:56:09Z"
    },
    {
      "event": "commented",
      "id": 2539896893,
      "node_id": "IC_kwDOABII586XY8A9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2539896893",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-12T19:58:37Z",
      "updated_at": "2024-12-12T20:00:07Z",
      "author_association": "CONTRIBUTOR",
      "body": "> we need to decide if the 4% IBD slowdown is worth the improved consistency (or if the performance hit can be mitigated somehow).\r\n\r\nI think it's definitely worth it. It's a very small difference, and IBD performance is only impacted if running with a very high dbcache anyways. Presumably you are in a rush if you are doing that and you don't want to have to redo everything if it crashes midway through.\r\n\r\nThe improvements to steady state IO spikiness and shutdown speed are well worth it IMO.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2539896893",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2539947984,
      "node_id": "IC_kwDOABII586XZIfQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2539947984",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-12T20:24:31Z",
      "updated_at": "2024-12-17T11:18:07Z",
      "author_association": "CONTRIBUTOR",
      "body": "ACK 5326e68bd645ab9a1b0a6e9095a2695e4e1eeaf7\r\n\r\nThis will make IBD more consistent and only affect the speed when the cache size is already maxed out.\r\nIn such cases, we aim to avoid the very long flushing process at the end.\r\nThis change will even out the process, resulting in much more predictable behavior.\r\n\r\nEdit:\r\nSince this PR is meant to [alleviate hanging](https://github.com/bitcoin/bitcoin/issues/31326#issuecomment-2504596389) at the end for bigger cache sizes, it could make sense to add a warning for the final flush if the used `dbcache` is big (e.g. >1 GiB i.e. `2024-12-17T10:59:30Z UpdateTip: ... cache=5816.9MiB(42730941txo)`)",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2539947984",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "commented",
      "id": 2549027130,
      "node_id": "IC_kwDOABII586X7xE6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2549027130",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-17T16:54:34Z",
      "updated_at": "2024-12-17T16:54:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Since this PR is meant to alleviate hanging at the end for bigger cache sizes, it could make sense to add a warning for the final flush if the used dbcache is big (e.g. >1 GiB i.e. 2024-12-17T10:59:30Z UpdateTip: ... cache=5816.9MiB(42730941txo))\n\n@l0rinc I think something like that could be made in a separate PR without this change. Just add a warning log for any large flush. It's not really related to this change.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2549027130",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "mentioned",
      "id": 15689562830,
      "node_id": "MEE_lADOABII586SaWKgzwAAAAOnK7rO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15689562830",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-17T16:54:36Z"
    },
    {
      "event": "subscribed",
      "id": 15689562855,
      "node_id": "SE_lADOABII586SaWKgzwAAAAOnK7rn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15689562855",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-17T16:54:36Z"
    },
    {
      "event": "referenced",
      "id": 15773334393,
      "node_id": "REFE_lADOABII586SaWKgzwAAAAOsKft5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15773334393",
      "actor": {
        "login": "ryanofsky",
        "id": 7133040,
        "node_id": "MDQ6VXNlcjcxMzMwNDA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ryanofsky",
        "html_url": "https://github.com/ryanofsky",
        "followers_url": "https://api.github.com/users/ryanofsky/followers",
        "following_url": "https://api.github.com/users/ryanofsky/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ryanofsky/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ryanofsky/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
        "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
        "repos_url": "https://api.github.com/users/ryanofsky/repos",
        "events_url": "https://api.github.com/users/ryanofsky/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "9355578a77978a0c2f189bd7315a2883142d8119",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9355578a77978a0c2f189bd7315a2883142d8119",
      "created_at": "2024-12-27T14:54:21Z"
    },
    {
      "event": "labeled",
      "id": 15773425387,
      "node_id": "LE_lADOABII586SaWKgzwAAAAOsK17r",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15773425387",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-27T15:08:50Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2524345746,
      "node_id": "PRR_kwDOABII586WdnWS",
      "url": null,
      "actor": null,
      "commit_id": "e31152233db142b1b2c957fe4d392bfcf20cd899",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#pullrequestreview-2524345746",
      "submitted_at": "2024-12-27T19:48:05Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDBhZDdkN2FiZGJjZmZjMTFhNDY0MTM1NDVhMjE0YTcxNmY1NmRjOTU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0ad7d7abdbcffc11a46413545a214a716f56dc95",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0ad7d7abdbcffc11a46413545a214a716f56dc95",
      "tree": {
        "sha": "6d47886531f8b78211e757b27c8598844e5667c8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6d47886531f8b78211e757b27c8598844e5667c8"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 6d47886531f8b78211e757b27c8598844e5667c8\nparent 9355578a77978a0c2f189bd7315a2883142d8119\nauthor Andrew Toth <andrewstoth@gmail.com> 1725126111 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1735398841 -0500\n\ntest: chainstate write test for periodic chainstate flush\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmdwFbkACgkQYAB6/Ik4\nsBjD2Q//c4PVaMfTm7aMWz4r5mWRlHdDZsnl1lStWGgXfGmbzeH8bhP5pE2wVz/O\np9z3Hb/dVM2IQboAjgkpcfFIgtTBDf3LjTQAt0JLHPweYU++bu17zc4gZvzut1MV\np3oSJlrw6HJp1F2AU0lo/ykDuf+kbXa6e5G9li9ERvMwHrWFNt3Bb2XGlrTNBegm\nbGkmP4sVH0ItKCaTNGd8HqvFEL7m1DB46Y2mP34aMzmU9r2+1j2xfIUMyJdyLq0V\ncFwVF7rch+TBFGKanO7X4KjgtiX7Mx1jsmhiYPM7SaEgIzHZhwbXnEdvT8yV087K\nadkqkxpg/ELiRSPPCxRSA49dmn7XN6QF46wGCWl8F64aAzuTpQMf/Sxl3FUZnqWB\nThZHdpu8IDO8V6GxliI8EXVyPWkjO2l+lIeVWpsHlTdqFRRZLCJl06BaG0ThEZ1Y\nA5ZwdAegyuF7W//YD8Wab/qnaCp923ScGCrAtSEQkxaMiXpVu4yhz5RhTtmipeXL\n1DuJi7eCIdulpYsWYCId11kLm/H/mRU9igGpneo0/MEFXCkOlFApY9V7p3kvys8m\nyQOxPARjeffWsuP7dwAaK5uTuG2bnE/5x3fd1SOf6He2xqca/JDPdGm5mWVE7FVw\n2oQQo1uj1X0M+q6B1oi9gKl+6ho7NAjOJ3KWnwc8F96zzB0tMlw=\n=T41+\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9355578a77978a0c2f189bd7315a2883142d8119",
          "sha": "9355578a77978a0c2f189bd7315a2883142d8119",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9355578a77978a0c2f189bd7315a2883142d8119"
        }
      ],
      "message": "test: chainstate write test for periodic chainstate flush",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-12-28T15:14:01Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-08-31T17:41:51Z"
      },
      "sha": "0ad7d7abdbcffc11a46413545a214a716f56dc95"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc5OThlZGEwMzQwMmE4ZGQ4MjI3YTUwNmMwMjJmOGJlZjgxZjM4ZWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7998eda03402a8dd8227a506c022f8bef81f38ef",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7998eda03402a8dd8227a506c022f8bef81f38ef",
      "tree": {
        "sha": "0a45897089034bac3c8dd9056275537d07c47d58",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0a45897089034bac3c8dd9056275537d07c47d58"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 0a45897089034bac3c8dd9056275537d07c47d58\nparent 0ad7d7abdbcffc11a46413545a214a716f56dc95\nauthor Andrew Toth <andrewstoth@gmail.com> 1725117191 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1735399744 -0500\n\nvalidation: write chainstate to disk every hour\n\nRemove the 24 hour periodic flush interval and\nwrite the chainstate along with blocks and block\nindex every hour\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmdwGUMACgkQYAB6/Ik4\nsBgphw//fly2dDhEPW6I/V4yjBOiCXJbRqPttYC5jUiPyxWlYkxywcaONaWVqrt1\nU4THtZqHDqmOAsmSpUBu2kBWBuyTnpmD5oUp9ZZ0JndO+gfTrxyCl/1R5v7FPrRT\nBJlCdMPayByWzJiRytRL1YdfMeYFI5VpGjzeVDyGD02mvMyAAnnE/LZ0scoANcHn\nibfa1GQ3PSCcY3PJNJOEQLfx6jUw0DEQO7bjGP8iSmog7vgTbMO7xF4LJvpxEzF9\nSGLY94WXRoyvltz4clkITUTNlgm2mnM+yXjDfbz2qdoEYwln3g/jxAkN4RFbzNnn\nPwwU4fEUx81yc3I+rP7+wgpWXKzlkjMhmQDgui34O9cIR3jvsMbKyCSNHEGwEeUt\nNAFYJtghSfmzhEULc8iQQHPC9ju/VYdilKDs7notE2JyFPm/hHsOTgIBY3igRFdS\nA/tME9ZOpTeMZ9PFA/gw05IKSVS+g2e1IymJj4lvQyqS1Q3qyXlbQ/Q2lsyN/WlM\nTndLKgUB18m7PiQucOjfL4ghDUbcPy55g6i3BQ6uZBiWboou+BPfx6gyBZMU4hbb\nSpmcmjOZ54RfQOuoLNOTeG+zLlwRiZNkQHLMpJXyTZTJk2cJnhAmtMCAinag3Esm\neKHsnh/fxXRGmD6VQFwjkETZbauG/QyW/Dxe5gDYE8UxUl/aVCc=\n=FOtj\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0ad7d7abdbcffc11a46413545a214a716f56dc95",
          "sha": "0ad7d7abdbcffc11a46413545a214a716f56dc95",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0ad7d7abdbcffc11a46413545a214a716f56dc95"
        }
      ],
      "message": "validation: write chainstate to disk every hour\n\nRemove the 24 hour periodic flush interval and\nwrite the chainstate along with blocks and block\nindex every hour",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-12-28T15:29:04Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-08-31T15:13:11Z"
      },
      "sha": "7998eda03402a8dd8227a506c022f8bef81f38ef"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGEzM2FhYWRiMmQzZGE3NTUxMmI4MGMxNzkzZDkyYzc1MzZjMGI4MDE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a33aaadb2d3da75512b80c1793d92c7536c0b801",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a33aaadb2d3da75512b80c1793d92c7536c0b801",
      "tree": {
        "sha": "3ca71b3f62ec18372cddbd19cf00b3b549344af8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3ca71b3f62ec18372cddbd19cf00b3b549344af8"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 3ca71b3f62ec18372cddbd19cf00b3b549344af8\nparent 7998eda03402a8dd8227a506c022f8bef81f38ef\nauthor Andrew Toth <andrewstoth@gmail.com> 1725117258 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1735399747 -0500\n\nrefactor: rename fDoFullFlush to should_write\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmdwGUMACgkQYAB6/Ik4\nsBhDcxAAr/Rlr0O9tdKMvmGqFDvOkadfS8nfW2/jYIgxp05h9bjjQzwNuCi4sFcA\nC49SBSjTf2Lgpoqmk0IYe2BQNY6lcPQb71Mokqhlc5T0/lziBLHTkJWDjsv40BLA\nlcrPYJSHW43QdlqP25wODjU3bzM8rqnN1tBX4AxmaJFsFjyjLBHtKOQL716sEIUy\nGWD8SpGC/j09+6Kr2Fg5vB4UPaeAfhNjGKDmD9kbD3DhU4QFvur3XR8StJcXT35L\n+297jGwWrHeMqztT93yGfKvONnjUXa7q8/+OESQgyHyTjAziQOcxRlaFlb+X01U8\nCGK2/4MjhQ7VXswGSrIgEpt05zJX1nouzUPphbYo+ZNkxKpNPxC/OeCb48+o6Oi2\nKmBXD+65Gcx5BofO+vRXdjlN7GKV5e9P9QzpqxojdgEWlhzO+0nOQ3VOQJQj3Fi9\ns5tsloeSsyEgyyzvstMDAE0ne6mUlrQ2LDaIhb6eFAhOpLCcj8qD++2X9wmhojFN\nYixYLDVKcIz8dicBVnF/AUXDxB4afsyeS7S2dkvuqGzvrS1ylCRg16DqW+weI1VL\nKwdnCqZM9BimczvjcZOWc0DhvnCZ7vNbGG5uVFYL/7GmYKpXDcF9kPDsW7F/uH/A\nj77xbjab6ezZM7jI9ff0FsvruAfATgqvh6Z/u2JMA/pRAEfACHo=\n=Dxph\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7998eda03402a8dd8227a506c022f8bef81f38ef",
          "sha": "7998eda03402a8dd8227a506c022f8bef81f38ef",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7998eda03402a8dd8227a506c022f8bef81f38ef"
        }
      ],
      "message": "refactor: rename fDoFullFlush to should_write",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-12-28T15:29:07Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-08-31T15:14:18Z"
      },
      "sha": "a33aaadb2d3da75512b80c1793d92c7536c0b801"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDY5MDcyOTU3N2RiMDZkM2VmN2Q5NDhlNWYwOGMxNTM0YzIxMjJmNWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/690729577db06d3ef7d948e5f08c1534c2122f5e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/690729577db06d3ef7d948e5f08c1534c2122f5e",
      "tree": {
        "sha": "31c0908bd140b1717b4051e7f26f35d674c546e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/31c0908bd140b1717b4051e7f26f35d674c546e0"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 31c0908bd140b1717b4051e7f26f35d674c546e0\nparent a33aaadb2d3da75512b80c1793d92c7536c0b801\nauthor Andrew Toth <andrewstoth@gmail.com> 1725810533 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1735399802 -0500\n\nrefactor: replace m_last_write with m_next_write\n\nCo-Authored-By: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmdwGXsACgkQYAB6/Ik4\nsBjy5BAAixwdQUqAdrcVXfyx/adThuFaYnA4OBCAjF9+v+W+gvFqS68N/c2Lqnz2\nQKv0niUdxMe0Of9X/lsEU8kogZmUxwS1Erp/2pl1l02CsB3EPlF3m+F2a45cPXLf\nTybprzdm92qGF+Q7IHo9tfzQGVlJdgQ9hK4IWPHFPCg5o5+isfpYVK1HCe+dG1Lm\nnja16RCAGk0eJlJdqFPkuIKhS1UlSgMxRkOUCPUHKujW5ZNfXMK4tviLp+/DOK9y\n2MBWD31WoxA7Eq6AHpTFSXp3Xg+IoBSh2WIsFYaEIVxmDLEJLV+JgWri4yqtjT/H\nEUETyvPVb6R+s4Q6ra8dLRWFv3NY1uQtNl1dsU0Ty7o/hCOZ+nVRG+pY/ZKAP1ga\ndeg19UmFJvb9EJflzNrk5moBYlrrWsd7gkYTMP7rVhrilCYFSvl50ipI89VUkRxK\nPpMocrg2meCtQGgV8JD+74Zy9gAAzaW5pMuNQsx+VfDDTEGNtvr7nQB3nUfkL5ng\nauQKVGLRBZLtn7XCbpHESKfYJa2s+QYcDQ2qiuahibaXY2nTZQ+O1dGe2uhTfopz\nzSsK4fRC5H5jOO7AoduHRVkZOq+BlgcJMX67+xH15hy6ySwm4Vuz20x4TFXcMGSm\n8YfVpkze1DoPHEVTnCCP4TlTEdhhr02WmgIH+YGm2/HdISoEx20=\n=l88f\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a33aaadb2d3da75512b80c1793d92c7536c0b801",
          "sha": "a33aaadb2d3da75512b80c1793d92c7536c0b801",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a33aaadb2d3da75512b80c1793d92c7536c0b801"
        }
      ],
      "message": "refactor: replace m_last_write with m_next_write\n\nCo-Authored-By: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-12-28T15:30:02Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-09-08T15:48:53Z"
      },
      "sha": "690729577db06d3ef7d948e5f08c1534c2122f5e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGIzNzQ1MmNhNDM3ODU2ZWQ1ZDhlZmZjZTJjZWY3MzdkOWRmNDc5YzE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b37452ca437856ed5d8effce2cef737d9df479c1",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/b37452ca437856ed5d8effce2cef737d9df479c1",
      "tree": {
        "sha": "9304ed8344bf602e38a749ad254b3209695ab84d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9304ed8344bf602e38a749ad254b3209695ab84d"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 9304ed8344bf602e38a749ad254b3209695ab84d\nparent 690729577db06d3ef7d948e5f08c1534c2122f5e\nauthor Andrew Toth <andrewstoth@gmail.com> 1725810673 -0400\ncommitter Andrew Toth <andrewstoth@gmail.com> 1735399803 -0500\n\nvalidation: add randomness to periodic write interval\n\nCo-Authored-By: Pieter Wuille <pieter@wuille.net>\nCo-Authored-By: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAmdwGXsACgkQYAB6/Ik4\nsBgl7g/+NCd+K32qPwEzJtsfr7JWjc5sfXYm+hjoB1Ao99/b/vU5S0ytds+XG3Zx\nn5X2+votgYnAGopig+wCyhB1xDRZ3ZG9pH6QT+QYmMkV9JW2tj8PJy9tR4AreAqq\nVD6P2HuIYuvIEwjK1NvWfuM5n4ab2vPXUvI4yy0YxjB/H75L2u6LKECslA25y7cL\nnatFJzM6o2Ycc0TbElb98+A/rX/y8pwUIuSvSFKqFC93m6THpgoBFo8xPXx/Lt2t\nt254R+/ERnhjSEVE5RvshS473LzNg5vR+gmBUaOnP4c3O/TUnrYM3SCRdInnyrf3\nkkWUnLv2Tiu2fDHQ9nuO7VYENVMrm2P7RLQC8KkoD9Tz0BwNqy3FWR3GzJT5PNEg\nHfAz+O2syxbEr49LcPFwieR7wPTQXT+3iG/NcItfq9SC5wjG1JE77M2NF1Nui/d7\nRni1GtJxT9Ldf2wrZJ60U5tWut9Bl7Ew7gF8wsmpv1mX1FlI3n3Yo1eGjHTG8age\nMZx7aQMKesXCgtlxAKvyuba/TIwnpaHfWNtl39pRfKRg3SPYthFGBvmc/zTLLrRH\nKvNxhOON/LzLwPGm6LsYhsZU7hYdX2fDHPMGx3QuK2010ii8mfFNoLDps3Cc8rrn\nWxaUkgdKJl3vgKvpsf7Wbl/DdK2hYU/fx4di98o6i9zJqJk9X5U=\n=uR8i\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/690729577db06d3ef7d948e5f08c1534c2122f5e",
          "sha": "690729577db06d3ef7d948e5f08c1534c2122f5e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/690729577db06d3ef7d948e5f08c1534c2122f5e"
        }
      ],
      "message": "validation: add randomness to periodic write interval\n\nCo-Authored-By: Pieter Wuille <pieter@wuille.net>\nCo-Authored-By: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-12-28T15:30:03Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2024-09-08T15:51:13Z"
      },
      "sha": "b37452ca437856ed5d8effce2cef737d9df479c1"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15777820046,
      "node_id": "HRFPE_lADOABII586SaWKgzwAAAAOsbm2O",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15777820046",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b37452ca437856ed5d8effce2cef737d9df479c1",
      "created_at": "2024-12-28T15:32:08Z"
    },
    {
      "event": "commented",
      "id": 2564363281,
      "node_id": "IC_kwDOABII586Y2RQR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2564363281",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-28T15:33:26Z",
      "updated_at": "2024-12-28T15:33:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased due to conflicts from #31534.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2564363281",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    },
    {
      "event": "unlabeled",
      "id": 15777873969,
      "node_id": "UNLE_lADOABII586SaWKgzwAAAAOsb0Ax",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15777873969",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-28T16:13:36Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2564375695,
      "node_id": "IC_kwDOABII586Y2USP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2564375695",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-28T16:35:39Z",
      "updated_at": "2024-12-28T16:35:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "ACK b37452ca437856ed5d8effce2cef737d9df479c1\r\n\r\nThe differences since last ACK:\r\n* the conflicting new logging - which had to be reindented;\r\n* `chain state` and `reindex` mentioned in the comment of `fPeriodicWrite`.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#issuecomment-2564375695",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30611"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1721803828",
      "pull_request_review_id": 2245573919,
      "id": 1721803828,
      "node_id": "PRRC_kwDOABII585moKQ0",
      "diff_hunk": "@@ -2842,21 +2839,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n-        // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n+        // It's been a while since we wrote the block index and chainstate to disk. Do this frequently, so we don't need to redownload and reindex after a crash.\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n-        // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage.\n-        bool fPeriodicFlush = mode == FlushStateMode::PERIODIC && nNow > m_last_flush + DATABASE_FLUSH_INTERVAL;\n         // Combine all conditions that result in a full cache flush.\n-        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicFlush || fFlushForPrune;\n+        bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "To simplify review, could you please separate the concerns - having low-risk changes (e.g. moves, renames, inlines, rewording) in separate commits from high risk ones?",
      "created_at": "2024-08-19T13:37:04Z",
      "updated_at": "2024-08-19T13:37:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1721803828",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1721803828"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1739870290",
      "pull_request_review_id": 2274071126,
      "id": 1739870290,
      "node_id": "PRRC_kwDOABII585ntFBS",
      "diff_hunk": "@@ -2842,21 +2839,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n-        // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n+        // It's been a while since we wrote the block index and chainstate to disk. Do this frequently, so we don't need to redownload and reindex after a crash.\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n-        // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage.\n-        bool fPeriodicFlush = mode == FlushStateMode::PERIODIC && nNow > m_last_flush + DATABASE_FLUSH_INTERVAL;\n         // Combine all conditions that result in a full cache flush.\n-        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicFlush || fFlushForPrune;\n+        bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 38,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81508954f1f89f95b6fdca10c3c471cdb6566c80",
      "in_reply_to_id": 1721803828,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "There really isn't much I am doing here that can be split up. I added a second commit for moving the declaration of `fDoFullFlush` here.",
      "created_at": "2024-08-31T17:44:32Z",
      "updated_at": "2024-08-31T17:44:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1739870290",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1739870290"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740167716",
      "pull_request_review_id": 2274461800,
      "id": 1740167716,
      "node_id": "PRRC_kwDOABII585nuNok",
      "diff_hunk": "@@ -2837,26 +2836,22 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n-        }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n+            m_random_write_delay = std::chrono::minutes{(FastRandomContext().randrange(DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE))};",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "in_reply_to_id": null,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "It'd be a bit cleaner (and more granular) to have:\r\n\r\n```c++\r\nstatic constexpr auto DATABASE_WRITE_INTERVAL_MIN{50min};\r\nstatic constexpr auto DATABASE_WRITE_INTERVAL_MAX{70min};\r\n...\r\nm_random_write_delay = DATABASE_WRITE_INTERVAL_MIN +\r\n    FastRandomContext().rand_uniform_duration<NodeClock>(DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN);`\r\n```\r\n",
      "created_at": "2024-09-01T17:40:03Z",
      "updated_at": "2024-09-01T17:40:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740167716",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740167716"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2843,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740188239",
      "pull_request_review_id": 2274481459,
      "id": 1740188239,
      "node_id": "PRRC_kwDOABII585nuSpP",
      "diff_hunk": "@@ -2837,26 +2836,22 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n-        }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n+            m_random_write_delay = std::chrono::minutes{(FastRandomContext().randrange(DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE))};",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "in_reply_to_id": 1740167716,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "given that this delay is written multiple times, would that be more verbose?\r\nAlternatively maybe we could add an `m_next_write` next to `m_last_write`, like:\r\n```patch\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex b54446be4e..e2c7272531 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -86,10 +86,9 @@ using node::CBlockIndexHeightOnlyComparator;\r\n using node::CBlockIndexWorkComparator;\r\n using node::SnapshotMetadata;\r\n \r\n-/** Time to wait between writing blocks/block index and chainstate to disk. */\r\n-static constexpr std::chrono::minutes DATABASE_WRITE_INTERVAL{50};\r\n-/** Range of random delay to add to DATABASE_WRITE_INTERVAL */\r\n-static constexpr uint32_t DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE{20};\r\n+/** Minimum and maximum time to wait between writing blocks/block index and chainstate to disk. */\r\n+static constexpr auto DATABASE_WRITE_INTERVAL_MIN{50min};\r\n+static constexpr auto DATABASE_WRITE_INTERVAL_MAX{70min};\r\n /** Maximum age of our tip for us to be considered current for fee estimation */\r\n static constexpr std::chrono::hours MAX_FEE_ESTIMATION_TIP_AGE{3};\r\n const std::vector<std::string> CHECKLEVEL_DOC {\r\n@@ -2776,6 +2775,11 @@ CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(\r\n     return CoinsCacheSizeState::OK;\r\n }\r\n \r\n+NodeClock::time_point Chainstate::CalculateNextWrite(NodeClock::time_point after) const\r\n+{\r\n+    return FastRandomContext().rand_uniform_delay(after + DATABASE_WRITE_INTERVAL_MIN, DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN);\r\n+}\r\n+\r\n bool Chainstate::FlushStateToDisk(\r\n     BlockValidationState &state,\r\n     FlushStateMode mode,\r\n@@ -2840,14 +2844,14 @@ bool Chainstate::FlushStateToDisk(\r\n         // Avoid writing/flushing immediately after startup.\r\n         if (m_last_write == decltype(m_last_write){}) {\r\n             m_last_write = nNow;\r\n-            m_random_write_delay = std::chrono::minutes{(FastRandomContext().randrange(DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE))};\r\n+            m_next_write = CalculateNextWrite(m_last_write);\r\n         }\r\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\r\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\r\n         // The cache is over the limit, we have to write now.\r\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\r\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\r\n-        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL + m_random_write_delay;\r\n+        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow >= m_next_write;\r\n         // Combine all conditions that result in a full cache flush.\r\n         bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;\r\n         // Write blocks, block index and best chain related state to disk.\r\n@@ -2882,7 +2886,7 @@ bool Chainstate::FlushStateToDisk(\r\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\r\n             }\r\n             m_last_write = nNow;\r\n-            m_random_write_delay = std::chrono::minutes{(FastRandomContext().randrange(DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE))};\r\n+            m_next_write = CalculateNextWrite(m_last_write);\r\n \r\n             if (!CoinsTip().GetBestBlock().IsNull()) {\r\n                 LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex dfe33b8e29..953793bdf7 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -810,7 +810,9 @@ private:\r\n         EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     NodeClock::time_point m_last_write{};\r\n-    std::chrono::minutes m_random_write_delay{};\r\n+    NodeClock::time_point m_next_write{};\r\n+\r\n+    NodeClock::time_point CalculateNextWrite(NodeClock::time_point after) const;\r\n \r\n     /**\r\n      * In case of an invalid snapshot, rename the coins leveldb directory so\r\n```\r\n\r\nnote: this way it should probably be `nNow >= m_next_write` instead of `nNow > m_next_write` to be consistent with the naming.",
      "created_at": "2024-09-01T20:19:51Z",
      "updated_at": "2024-09-01T20:19:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740188239",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740188239"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2843,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740263238",
      "pull_request_review_id": 2274581511,
      "id": 1740263238,
      "node_id": "PRRC_kwDOABII585nuk9G",
      "diff_hunk": "@@ -2837,26 +2836,22 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n-        }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n+            m_random_write_delay = std::chrono::minutes{(FastRandomContext().randrange(DATABASE_WRITE_INTERVAL_RANDOM_DELAY_RANGE))};",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1c1b63a041b7075ef0580f769d1c62a1f9fa8df6",
      "in_reply_to_id": 1740167716,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Thanks for the suggestions! I could not get @sipa's to compile, so went with @l0rinc's.",
      "created_at": "2024-09-02T02:25:06Z",
      "updated_at": "2024-09-02T02:25:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740263238",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740263238"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2843,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740758502",
      "pull_request_review_id": 2275381925,
      "id": 1740758502,
      "node_id": "PRRC_kwDOABII585nwd3m",
      "diff_hunk": "@@ -2774,6 +2775,11 @@ CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(\n     return CoinsCacheSizeState::OK;\n }\n \n+SteadyClock::time_point CalculateNextWrite(SteadyClock::time_point after)\n+{\n+    return FastRandomContext().rand_uniform_delay(after + DATABASE_WRITE_INTERVAL_MIN, DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN);\n+}",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "c529a595dc90be213c265b201ccb0e7bb7278245",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I was a bit hasty yesterday - the MIN/MAX naming indicates that the interval is closed (i.e. can actually reach the values), so we should add 1 minute to the range:\r\n```suggestion\r\nNodeClock::time_point CalculateNextWrite(const NodeClock::time_point after)\r\n{\r\n    const auto time{after + DATABASE_WRITE_INTERVAL_MIN};\r\n    constexpr auto range{DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN + 1min};\r\n    return FastRandomContext().rand_uniform_delay(time, range);\r\n}\r\n```\r\n\r\nSee:\r\n```C++\r\nBOOST_AUTO_TEST_CASE(CalculateNextWrite_interval)\r\n{\r\n    NodeClock::time_point after = NodeClock::now();\r\n    std::set<int64_t> results;\r\n    for (int i = 0; i < 100; ++i) {\r\n        auto next = CalculateNextWrite(after);\r\n        auto diff = (next - after) / std::chrono::minutes(1);\r\n        results.insert(diff);\r\n    }\r\n    BOOST_CHECK_EQUAL(results.size(), 21);\r\n}\r\n```",
      "created_at": "2024-09-02T11:27:37Z",
      "updated_at": "2024-09-02T12:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740758502",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740758502"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": 2778,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 2786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740812194",
      "pull_request_review_id": 2275381925,
      "id": 1740812194,
      "node_id": "PRRC_kwDOABII585nwq-i",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // Time window to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The initial run should never flush, right?\r\n`SetMockTime(GetTime<std::chrono::minutes>() + 55min);` passes also, so we should likely update the test\r\n.\r\nActually, sometimes it passes, other times it fails - this is the reason for my NACK\r\n```\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval        \r\nRunning 1 test case...\r\nsrc/test/chainstate_write_tests.cpp:35: error: in \"chainstate_write_tests/chainstate_write_interval\": check !sub->m_did_flush has failed\r\n\r\n*** 1 failure is detected in the test module \"Bitcoin Core Test Suite\"\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval        \r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n% build/src/test/test_bitcoin --run_test=chainstate_write_tests/chainstate_write_interval\r\nRunning 1 test case...\r\nsrc/test/chainstate_write_tests.cpp:35: error: in \"chainstate_write_tests/chainstate_write_interval\": check !sub->m_did_flush has failed\r\n\r\n*** 1 failure is detected in the test module \"Bitcoin Core Test Suite\"\r\n```",
      "created_at": "2024-09-02T12:11:02Z",
      "updated_at": "2024-09-02T12:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740812194",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740812194"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740868062",
      "pull_request_review_id": 2275381925,
      "id": 1740868062,
      "node_id": "PRRC_kwDOABII585nw4ne",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 13,
      "original_position": 24,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Besides the stability and the initial run, I think we should test the valid values as well inside the range, e.g.\r\n```C++\r\nBOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\r\n{\r\n    auto DATABASE_WRITE_INTERVAL_MIN{50min};\r\n    auto DATABASE_WRITE_INTERVAL_MAX{70min};\r\n    auto now = GetTime<std::chrono::minutes>();\r\n    auto sub{std::make_shared<TestSubscriber>()};\r\n    m_node.validation_signals->RegisterSharedValidationInterface(sub);\r\n    auto test_flush = [&](std::chrono::minutes offset) {\r\n        assert(!sub->m_did_flush);\r\n        Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\r\n        BlockValidationState state_dummy{};\r\n\r\n        SetMockTime(now + offset);\r\n        chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\r\n        m_node.validation_signals->SyncWithValidationInterfaceQueue();\r\n        return sub->m_did_flush;\r\n    };\r\n\r\n    // Initial run shouldn't flush\r\n    BOOST_CHECK_EQUAL(test_flush(DATABASE_WRITE_INTERVAL_MIN + 5min), false);\r\n\r\n    // Test all values (+1) in the interval\r\n    BOOST_CHECK_EQUAL(test_flush(DATABASE_WRITE_INTERVAL_MIN - 1min), false);\r\n    for (auto m = DATABASE_WRITE_INTERVAL_MIN; m <= DATABASE_WRITE_INTERVAL_MAX + 1min; m += 1min) {\r\n        BOOST_CHECK_EQUAL(test_flush(m), true);\r\n    }\r\n}\r\n```",
      "created_at": "2024-09-02T12:41:21Z",
      "updated_at": "2024-09-02T12:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740868062",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740868062"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 13,
      "original_line": 13,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740870587",
      "pull_request_review_id": 2275381925,
      "id": 1740870587,
      "node_id": "PRRC_kwDOABII585nw5O7",
      "diff_hunk": "@@ -86,10 +86,9 @@ using node::CBlockIndexHeightOnlyComparator;\n using node::CBlockIndexWorkComparator;\n using node::SnapshotMetadata;\n \n-/** Time to wait between writing blocks/block index to disk. */\n-static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\n-/** Time to wait between flushing chainstate to disk. */\n-static constexpr std::chrono::hours DATABASE_FLUSH_INTERVAL{24};\n+/** Time window to wait between writing blocks/block index and chainstate to disk. */",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "can we add @sipa's reasoning here for why it's not a fixed value?",
      "created_at": "2024-09-02T12:43:25Z",
      "updated_at": "2024-09-02T12:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740870587",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740870587"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740880618",
      "pull_request_review_id": 2275381925,
      "id": 1740880618,
      "node_id": "PRRC_kwDOABII585nw7rq",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "If my understanding is correct:\r\n* at startup we never want to flush, but the initial value of `m_next_write` would trigger one, so we have to set the next write value in that case quickly to prevent one\r\n* when we do flush, we want to set the next flush's time again\r\n\r\nI think we can deduplicate setting this value twice (which also enables us to inline `CalculateNextWrite`):\r\n* setting m_next_write to max, which won't trigger `fDoFullFlush` since it's `>> nNow`\r\n* add another boolean where we check for initial run i.e. `m_next_write == NodeClock::time_point::max()` (or we can inline this, it's only used once)\r\n* set the next flush time when `fInitialRun || fDoFullFlush`, independently from the ` if (fDoFullFlush) {` block\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 6b401799bb..33fcc30806 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -2775,11 +2775,6 @@ CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(\r\n     return CoinsCacheSizeState::OK;\r\n }\r\n \r\n-NodeClock::time_point CalculateNextWrite(NodeClock::time_point after)\r\n-{\r\n-    return FastRandomContext().rand_uniform_delay(after + DATABASE_WRITE_INTERVAL_MIN, DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN);\r\n-}\r\n-\r\n bool Chainstate::FlushStateToDisk(\r\n     BlockValidationState &state,\r\n     FlushStateMode mode,\r\n@@ -2841,10 +2836,6 @@ bool Chainstate::FlushStateToDisk(\r\n             }\r\n         }\r\n         const auto nNow{NodeClock::now()};\r\n-        // Avoid writing/flushing immediately after startup.\r\n-        if (m_next_write == decltype(m_next_write){}) {\r\n-            m_next_write = CalculateNextWrite(nNow);\r\n-        }\r\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\r\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\r\n         // The cache is over the limit, we have to write now.\r\n@@ -2853,6 +2844,15 @@ bool Chainstate::FlushStateToDisk(\r\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow >= m_next_write;\r\n         // Combine all conditions that result in a full cache flush.\r\n         bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;\r\n+        // Avoid writing/flushing immediately after startup\r\n+        bool fInitialRun = m_next_write == NodeClock::time_point::max();\r\n+\r\n+        if (fInitialRun || fDoFullFlush) {\r\n+            const auto time{nNow + DATABASE_WRITE_INTERVAL_MIN};\r\n+            constexpr auto range{DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN + 1min};\r\n+            m_next_write = FastRandomContext().rand_uniform_delay(time, range);\r\n+        }\r\n+\r\n         // Write blocks, block index and best chain related state to disk.\r\n         if (fDoFullFlush) {\r\n             // Ensure we can write block index\r\n@@ -2884,7 +2884,6 @@ bool Chainstate::FlushStateToDisk(\r\n \r\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\r\n             }\r\n-            m_next_write = CalculateNextWrite(nNow);\r\n \r\n             if (!CoinsTip().GetBestBlock().IsNull()) {\r\n                 LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 1c2fd0bd3c..ea737a9c4c 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -808,7 +808,7 @@ private:\r\n     void UpdateTip(const CBlockIndex* pindexNew)\r\n         EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n-    NodeClock::time_point m_next_write{};\r\n+    NodeClock::time_point m_next_write{NodeClock::time_point::max()};\r\n \r\n     /**\r\n      * In case of an invalid snapshot, rename the coins leveldb directory so\r\n```",
      "created_at": "2024-09-02T12:51:25Z",
      "updated_at": "2024-09-02T12:57:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740880618",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740880618"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740962468",
      "pull_request_review_id": 2275726379,
      "id": 1740962468,
      "node_id": "PRRC_kwDOABII585nxPqk",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // Time window to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740812194,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Well, changing the test to periodically flush after 55 minutes makes it a different test. That would mean the first flush is in the window and could randomly trigger a flush or not.\r\nWas the failure after changing to `55min`?",
      "created_at": "2024-09-02T13:55:52Z",
      "updated_at": "2024-09-02T13:55:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740962468",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740962468"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740966394",
      "pull_request_review_id": 2275732464,
      "id": 1740966394,
      "node_id": "PRRC_kwDOABII585nxQn6",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 13,
      "original_position": 24,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740868062,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why would we need to test every  value in the window? Testing the edges of the window accomplishes the same thing, no?",
      "created_at": "2024-09-02T13:59:00Z",
      "updated_at": "2024-09-02T13:59:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740966394",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740966394"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 13,
      "original_line": 13,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740969969",
      "pull_request_review_id": 2275738211,
      "id": 1740969969,
      "node_id": "PRRC_kwDOABII585nxRfx",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740880618,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm not sure this is an improvement. We would be adding a new variable, instead of calling a function twice. Seems like a wash to me.",
      "created_at": "2024-09-02T14:01:50Z",
      "updated_at": "2024-09-02T14:01:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740969969",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740969969"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740986718",
      "pull_request_review_id": 2275766119,
      "id": 1740986718,
      "node_id": "PRRC_kwDOABII585nxVle",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // Time window to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 35,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740812194,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ahh, I see what you mean. We need to trigger an initial flush to set `m_next_write` first before testing the periodic flush window. Fixed.",
      "created_at": "2024-09-02T14:16:18Z",
      "updated_at": "2024-09-02T14:16:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740986718",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740986718"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740999482",
      "pull_request_review_id": 2275788354,
      "id": 1740999482,
      "node_id": "PRRC_kwDOABII585nxYs6",
      "diff_hunk": "@@ -2774,6 +2775,11 @@ CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(\n     return CoinsCacheSizeState::OK;\n }\n \n+SteadyClock::time_point CalculateNextWrite(SteadyClock::time_point after)\n+{\n+    return FastRandomContext().rand_uniform_delay(after + DATABASE_WRITE_INTERVAL_MIN, DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN);\n+}",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 19,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "c529a595dc90be213c265b201ccb0e7bb7278245",
      "in_reply_to_id": 1740758502,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-09-02T14:27:06Z",
      "updated_at": "2024-09-02T14:27:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740999482",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740999482"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": 2778,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 2786,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740999675",
      "pull_request_review_id": 2275788661,
      "id": 1740999675,
      "node_id": "PRRC_kwDOABII585nxYv7",
      "diff_hunk": "@@ -86,10 +86,9 @@ using node::CBlockIndexHeightOnlyComparator;\n using node::CBlockIndexWorkComparator;\n using node::SnapshotMetadata;\n \n-/** Time to wait between writing blocks/block index to disk. */\n-static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\n-/** Time to wait between flushing chainstate to disk. */\n-static constexpr std::chrono::hours DATABASE_FLUSH_INTERVAL{24};\n+/** Time window to wait between writing blocks/block index and chainstate to disk. */",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 8,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740870587,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-09-02T14:27:14Z",
      "updated_at": "2024-09-02T14:27:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1740999675",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1740999675"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741091951",
      "pull_request_review_id": 2275932444,
      "id": 1741091951,
      "node_id": "PRRC_kwDOABII585nxvRv",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740880618,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we don't have to add a variable, we can just inline it to:\r\n```C++\r\nif (fDoFullFlush || m_next_write == NodeClock::time_point::max()) {\r\n```\r\n\r\nWhich would simplify a few places (logically, making it obvious when we're queuing the next run, and also codewise, reducing duplication), removing the helper method and explanatory comments and multiple assignments (i.e. business logic being spread around).",
      "created_at": "2024-09-02T15:53:39Z",
      "updated_at": "2024-09-02T16:21:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741091951",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741091951"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741107409",
      "pull_request_review_id": 2275955713,
      "id": 1741107409,
      "node_id": "PRRC_kwDOABII585nxzDR",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 13,
      "original_position": 24,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740868062,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "~Using SteadyClock in https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741105265 seems to have stabilized the tests.~\r\n\r\nEdit: it seems the addition of the `first periodic flush` stabilized the test.\r\n\r\nApproach ACK",
      "created_at": "2024-09-02T16:14:21Z",
      "updated_at": "2024-09-02T16:57:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741107409",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741107409"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 13,
      "original_line": 13,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741109081",
      "pull_request_review_id": 2275958237,
      "id": 1741109081,
      "node_id": "PRRC_kwDOABII585nxzdZ",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);\n+\n+    // Time to periodically flush is between 50 and 70 minutes",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n    // Time to periodically flush is between 50 and 70 minutes (inclusive)\r\n```",
      "created_at": "2024-09-02T16:17:10Z",
      "updated_at": "2024-09-02T18:23:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741109081",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741109081"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741110745",
      "pull_request_review_id": 2275960774,
      "id": 1741110745,
      "node_id": "PRRC_kwDOABII585nxz3Z",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);\n+\n+    // Time to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "if you decide to keep this structure, please add boundary test for `50min` turning `m_did_flush` to true.\r\nWould also cover `+ 71min` for the same reason.",
      "created_at": "2024-09-02T16:19:57Z",
      "updated_at": "2024-09-02T16:19:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741110745",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741110745"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741111508",
      "pull_request_review_id": 2275961957,
      "id": 1741111508,
      "node_id": "PRRC_kwDOABII585nx0DU",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);\n+\n+    // Time to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "in_reply_to_id": 1741110745,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't think it would be true, because it's random.",
      "created_at": "2024-09-02T16:21:15Z",
      "updated_at": "2024-09-02T17:13:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741111508",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741111508"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741182975",
      "pull_request_review_id": 2276060005,
      "id": 1741182975,
      "node_id": "PRRC_kwDOABII585nyFf_",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);\n+\n+    // Time to periodically flush is between 50 and 70 minutes\n+    SetMockTime(GetTime<std::chrono::minutes>() + 49min);\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": 37,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "in_reply_to_id": 1741110745,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "got it, you can resolve this comment",
      "created_at": "2024-09-02T18:25:02Z",
      "updated_at": "2024-09-02T18:25:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741182975",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741182975"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 37,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741250422",
      "pull_request_review_id": 2276155633,
      "id": 1741250422,
      "node_id": "PRRC_kwDOABII585nyV92",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740880618,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This seems like just replacing `if (m_next_write == decltype(m_next_write){}) {` with `if (m_next_write == NodeClock::time_point::max()) {`, and since it's max we can just move the `if` block below `fPeriodicWrite` assignment. I don't see how this is an improvement? Doesn't having multiple checks for `fDoFullFlush` make it more complex?",
      "created_at": "2024-09-02T21:15:20Z",
      "updated_at": "2024-09-02T21:15:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741250422",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741250422"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741253014",
      "pull_request_review_id": 2276158937,
      "id": 1741253014,
      "node_id": "PRRC_kwDOABII585nyWmW",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740880618,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "it's not just replacing the if, please apply this patch on top to see what I mean:\r\n```patch\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 87a144cb99..6fdc070db3 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -2778,13 +2778,6 @@ CoinsCacheSizeState Chainstate::GetCoinsCacheSizeState(\r\n     return CoinsCacheSizeState::OK;\r\n }\r\n \r\n-NodeClock::time_point CalculateNextWrite(NodeClock::time_point after)\r\n-{\r\n-    const auto time{after + DATABASE_WRITE_INTERVAL_MIN};\r\n-    constexpr auto range{DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN + 1min};\r\n-    return FastRandomContext().rand_uniform_delay(time, range);\r\n-}\r\n-\r\n bool Chainstate::FlushStateToDisk(\r\n     BlockValidationState &state,\r\n     FlushStateMode mode,\r\n@@ -2846,10 +2839,6 @@ bool Chainstate::FlushStateToDisk(\r\n             }\r\n         }\r\n         const auto nNow{NodeClock::now()};\r\n-        // Avoid writing/flushing immediately after startup.\r\n-        if (m_next_write == decltype(m_next_write){}) {\r\n-            m_next_write = CalculateNextWrite(nNow);\r\n-        }\r\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\r\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\r\n         // The cache is over the limit, we have to write now.\r\n@@ -2858,6 +2847,12 @@ bool Chainstate::FlushStateToDisk(\r\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow >= m_next_write;\r\n         // Combine all conditions that result in a full cache flush.\r\n         bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;\r\n+\r\n+        if (fDoFullFlush || m_next_write == NodeClock::time_point::max()) {\r\n+            constexpr auto range{DATABASE_WRITE_INTERVAL_MAX - DATABASE_WRITE_INTERVAL_MIN + 1min};\r\n+            m_next_write = FastRandomContext().rand_uniform_delay(nNow + DATABASE_WRITE_INTERVAL_MIN, range);\r\n+        }\r\n+\r\n         // Write blocks, block index and best chain related state to disk.\r\n         if (fDoFullFlush) {\r\n             // Ensure we can write block index\r\n@@ -2889,7 +2884,6 @@ bool Chainstate::FlushStateToDisk(\r\n \r\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\r\n             }\r\n-            m_next_write = CalculateNextWrite(nNow);\r\n \r\n             if (!CoinsTip().GetBestBlock().IsNull()) {\r\n                 LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 1c2fd0bd3c..ea737a9c4c 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -808,7 +808,7 @@ private:\r\n     void UpdateTip(const CBlockIndex* pindexNew)\r\n         EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n-    NodeClock::time_point m_next_write{};\r\n+    NodeClock::time_point m_next_write{NodeClock::time_point::max()};\r\n \r\n     /**\r\n      * In case of an invalid snapshot, rename the coins leveldb directory so\r\n```",
      "created_at": "2024-09-02T21:24:02Z",
      "updated_at": "2024-09-02T21:24:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741253014",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741253014"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741358607",
      "pull_request_review_id": 2276304661,
      "id": 1741358607,
      "node_id": "PRRC_kwDOABII585nywYP",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush\n+    chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n+    m_node.validation_signals->SyncWithValidationInterfaceQueue();\n+    BOOST_CHECK(!sub->m_did_flush);\n+\n+    // Time to periodically flush is between 50 and 70 minutes",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 36,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1d50f72d16bf8a07540b6e53015deff4598c9ea3",
      "in_reply_to_id": 1741109081,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-09-03T02:32:58Z",
      "updated_at": "2024-09-03T02:32:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741358607",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741358607"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741358669",
      "pull_request_review_id": 2276304765,
      "id": 1741358669,
      "node_id": "PRRC_kwDOABII585nywZN",
      "diff_hunk": "@@ -2837,26 +2840,21 @@ bool Chainstate::FlushStateToDisk(\n                 }\n             }\n         }\n-        const auto nNow{SteadyClock::now()};\n+        const auto nNow{NodeClock::now()};\n         // Avoid writing/flushing immediately after startup.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 40,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "5cad9d16dd07859a76c6637789695bf1b4f36e1c",
      "in_reply_to_id": 1740880618,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ok, done!",
      "created_at": "2024-09-03T02:33:07Z",
      "updated_at": "2024-09-03T02:33:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741358669",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741358669"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2849,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741658439",
      "pull_request_review_id": 2276771072,
      "id": 1741658439,
      "node_id": "PRRC_kwDOABII585nz5lH",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 31,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we don't have `m_last_write` anymore",
      "created_at": "2024-09-03T08:34:32Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741658439",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741658439"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 31,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741663448",
      "pull_request_review_id": 2276771072,
      "id": 1741663448,
      "node_id": "PRRC_kwDOABII585nz6zY",
      "diff_hunk": "@@ -28,17 +28,18 @@ BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n     Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n     BlockValidationState state_dummy{};\n \n-    // The first periodic flush sets m_last_flush and does not flush\n+    // The first periodic flush sets m_last_write and does not flush\n     chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n     m_node.validation_signals->SyncWithValidationInterfaceQueue();\n     BOOST_CHECK(!sub->m_did_flush);\n \n-    SetMockTime(GetTime<std::chrono::minutes>() + 23h + 59min);\n+    // Time to periodically flush is 1 hour",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "nit: 1 hour is a *duration* or *interval* or *period*, but technically not a *time*:\r\n```suggestion\r\n    // The periodic flush interval is 1 hour\r\n```",
      "created_at": "2024-09-03T08:38:01Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741663448",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741663448"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741667937",
      "pull_request_review_id": 2276771072,
      "id": 1741667937,
      "node_id": "PRRC_kwDOABII585nz75h",
      "diff_hunk": "@@ -86,10 +86,8 @@ using node::CBlockIndexHeightOnlyComparator;\n using node::CBlockIndexWorkComparator;\n using node::SnapshotMetadata;\n \n-/** Time to wait between writing blocks/block index to disk. */\n+/** Time to wait between writing blocks/block index and chainstate to disk. */\n static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\n-/** Time to wait between flushing chainstate to disk. */\n-static constexpr std::chrono::hours DATABASE_FLUSH_INTERVAL{24};",
      "path": "src/validation.cpp",
      "position": 7,
      "original_position": 8,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "could you please explain the `flush` removal in the corresponding commit message as well?",
      "created_at": "2024-09-03T08:41:08Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741667937",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741667937"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 96,
      "original_line": 96,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741685428",
      "pull_request_review_id": 2276771072,
      "id": 1741685428,
      "node_id": "PRRC_kwDOABII585n0AK0",
      "diff_hunk": "@@ -2842,21 +2840,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n-        // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage.\n-        bool fPeriodicFlush = mode == FlushStateMode::PERIODIC && nNow > m_last_flush + DATABASE_FLUSH_INTERVAL;\n         // Combine all conditions that result in a full cache flush.\n-        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicFlush || fFlushForPrune;\n-        // Write blocks and block index to disk.\n-        if (fDoFullFlush || fPeriodicWrite) {\n+        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 31,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "is the name still accurate, now that a periodic write can also trigger it (i.e. not just flushes, like before)?",
      "created_at": "2024-09-03T08:52:37Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741685428",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741685428"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2850,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741697957",
      "pull_request_review_id": 2276771072,
      "id": 1741697957,
      "node_id": "PRRC_kwDOABII585n0DOl",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {",
      "path": "src/validation.cpp",
      "position": 90,
      "original_position": 60,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Is it even possible for this to be false, given that we skip flush on first run?\r\n\r\nnit: just an observation, the starting `!` hides well here, if you think it read better, here's an alternative (though I see that IsNull is used in a few other places):\r\n```suggestion\r\n            if (CoinsTip().GetBestBlock() != uint256::ZERO) {\r\n```",
      "created_at": "2024-09-03T09:01:17Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741697957",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741697957"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2929,
      "original_line": 2929,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741725078",
      "pull_request_review_id": 2276771072,
      "id": 1741725078,
      "node_id": "PRRC_kwDOABII585n0J2W",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {\n+                LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n+                    coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n+\n+                // Typical Coin structures on disk are around 48 bytes in size.\n+                // Pushing a new one to the database can cause it to be written\n+                // twice (once in the log, and once in the tables). This is already\n+                // an overestimation, as most will delete an existing entry or\n+                // overwrite one. Still, use a conservative safety factor of 2.\n+                if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n+                    return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n+                }\n+                // Flush the chainstate (which may refer to block index entries).\n+                const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n+                if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {",
      "path": "src/validation.cpp",
      "position": 105,
      "original_position": 74,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I know this line didn't change here, I'm looking for answers:\r\nI find it quite confusing that most of the side-effects of this method are actually done inside if conditions - I wanted to understand whether the name `fDoFullFlush` is accurate, but had a hard time understanding which methods are just checking state (e.g. `CheckDiskSpace`, I assume) and which ones are changing state (e.g. `empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()`).\r\nSo my question is whether it's fair to call the condition `fDoFullFlush`, when sometimes it just `Sync`s (if I understand the algo correctly)?",
      "created_at": "2024-09-03T09:19:09Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741725078",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741725078"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2944,
      "original_line": 2944,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741737264",
      "pull_request_review_id": 2276771072,
      "id": 1741737264,
      "node_id": "PRRC_kwDOABII585n0M0w",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think the convention is:\r\n```suggestion\r\n// Copyright (c) 2024-present The Bitcoin Core developers\r\n``` ",
      "created_at": "2024-09-03T09:27:39Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741737264",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741737264"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741741467",
      "pull_request_review_id": 2276771072,
      "id": 1741741467,
      "node_id": "PRRC_kwDOABII585n0N2b",
      "diff_hunk": "@@ -2835,18 +2839,20 @@ bool Chainstate::FlushStateToDisk(\n             }\n         }\n         const auto nNow{NodeClock::now()};\n-        // Avoid writing/flushing immediately after startup.\n-        if (m_last_write == decltype(m_last_write){}) {\n-            m_last_write = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n-        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n+        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow >= m_next_write;\n         // Combine all conditions that result in a full cache flush.\n         bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;\n+\n+        if (fDoFullFlush || m_next_write == NodeClock::time_point::max()) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "we do more than `add randomness to periodic write interval` in this commit now, could you please split it up a bit more?",
      "created_at": "2024-09-03T09:30:33Z",
      "updated_at": "2024-09-03T09:34:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1741741467",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1741741467"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2851,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742321442",
      "pull_request_review_id": 2277879334,
      "id": 1742321442,
      "node_id": "PRRC_kwDOABII585n2bci",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {",
      "path": "src/validation.cpp",
      "position": 90,
      "original_position": 60,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741697957,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "> Is it even possible for this to be false, given that we skip flush on first run?\r\n\r\nCan we logically determine it will never be false? If so, we can simplify this quite a bit. ",
      "created_at": "2024-09-03T16:02:46Z",
      "updated_at": "2024-09-03T16:02:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1742321442",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742321442"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2929,
      "original_line": 2929,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742323569",
      "pull_request_review_id": 2277882916,
      "id": 1742323569,
      "node_id": "PRRC_kwDOABII585n2b9x",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {\n+                LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n+                    coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n+\n+                // Typical Coin structures on disk are around 48 bytes in size.\n+                // Pushing a new one to the database can cause it to be written\n+                // twice (once in the log, and once in the tables). This is already\n+                // an overestimation, as most will delete an existing entry or\n+                // overwrite one. Still, use a conservative safety factor of 2.\n+                if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n+                    return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n+                }\n+                // Flush the chainstate (which may refer to block index entries).\n+                const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n+                if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {",
      "path": "src/validation.cpp",
      "position": 105,
      "original_position": 74,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741725078,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yeah we could rename `fDoFullFlush`. What about `should_write`?",
      "created_at": "2024-09-03T16:04:29Z",
      "updated_at": "2024-09-03T16:04:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1742323569",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742323569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2944,
      "original_line": 2944,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742340130",
      "pull_request_review_id": 2277911230,
      "id": 1742340130,
      "node_id": "PRRC_kwDOABII585n2gAi",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {",
      "path": "src/validation.cpp",
      "position": 90,
      "original_position": 60,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741697957,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "what would happen when we restart with a different data directory, it will have to refetch everything, right? Or if we had a reorg on the very first block maybe?\r\nMaybe @sipa can help us out here...",
      "created_at": "2024-09-03T16:17:32Z",
      "updated_at": "2024-09-03T16:17:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1742340130",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1742340130"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2929,
      "original_line": 2929,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1747533292",
      "pull_request_review_id": 2286897702,
      "id": 1747533292,
      "node_id": "PRRC_kwDOABII585oKT3s",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {",
      "path": "src/validation.cpp",
      "position": 90,
      "original_position": 60,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741697957,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Hmm there are a lot of entry points to `FlushStateToDisk`, and many places where `SetBestBlock` is called. I think this PR should leave this as is to not complicate review.\r\n\r\nI was thinking we could remove the `full_flush_completed` variable if we didn't have this check.",
      "created_at": "2024-09-06T18:08:52Z",
      "updated_at": "2024-09-06T18:08:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1747533292",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1747533292"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2929,
      "original_line": 2929,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277512",
      "pull_request_review_id": 2288563523,
      "id": 1749277512,
      "node_id": "PRRC_kwDOABII585oQ9tI",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n+    BlockValidationState state_dummy{};\n+\n+    // The first periodic flush sets m_last_write and does not flush",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 31,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": 1741658439,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Fixed.",
      "created_at": "2024-09-08T15:58:31Z",
      "updated_at": "2024-09-08T15:58:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277512",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277512"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 31,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277546",
      "pull_request_review_id": 2288563546,
      "id": 1749277546,
      "node_id": "PRRC_kwDOABII585oQ9tq",
      "diff_hunk": "@@ -28,17 +28,18 @@ BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n     Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\n     BlockValidationState state_dummy{};\n \n-    // The first periodic flush sets m_last_flush and does not flush\n+    // The first periodic flush sets m_last_write and does not flush\n     chainstate.FlushStateToDisk(state_dummy, FlushStateMode::PERIODIC);\n     m_node.validation_signals->SyncWithValidationInterfaceQueue();\n     BOOST_CHECK(!sub->m_did_flush);\n \n-    SetMockTime(GetTime<std::chrono::minutes>() + 23h + 59min);\n+    // Time to periodically flush is 1 hour",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 11,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741663448,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Fixed.",
      "created_at": "2024-09-08T15:58:41Z",
      "updated_at": "2024-09-08T15:58:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277546",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277546"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277622",
      "pull_request_review_id": 2288563578,
      "id": 1749277622,
      "node_id": "PRRC_kwDOABII585oQ9u2",
      "diff_hunk": "@@ -86,10 +86,8 @@ using node::CBlockIndexHeightOnlyComparator;\n using node::CBlockIndexWorkComparator;\n using node::SnapshotMetadata;\n \n-/** Time to wait between writing blocks/block index to disk. */\n+/** Time to wait between writing blocks/block index and chainstate to disk. */\n static constexpr std::chrono::hours DATABASE_WRITE_INTERVAL{1};\n-/** Time to wait between flushing chainstate to disk. */\n-static constexpr std::chrono::hours DATABASE_FLUSH_INTERVAL{24};",
      "path": "src/validation.cpp",
      "position": 7,
      "original_position": 8,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741667937,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Added a sentence in the commit message.",
      "created_at": "2024-09-08T15:58:57Z",
      "updated_at": "2024-09-08T15:58:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277622",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277622"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 96,
      "original_line": 96,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277694",
      "pull_request_review_id": 2288563594,
      "id": 1749277694,
      "node_id": "PRRC_kwDOABII585oQ9v-",
      "diff_hunk": "@@ -2842,21 +2840,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n-        // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage.\n-        bool fPeriodicFlush = mode == FlushStateMode::PERIODIC && nNow > m_last_flush + DATABASE_FLUSH_INTERVAL;\n         // Combine all conditions that result in a full cache flush.\n-        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicFlush || fFlushForPrune;\n-        // Write blocks and block index to disk.\n-        if (fDoFullFlush || fPeriodicWrite) {\n+        fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 31,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741685428,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Renamed to `should_write`.",
      "created_at": "2024-09-08T15:59:07Z",
      "updated_at": "2024-09-08T15:59:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277694",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2850,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277743",
      "pull_request_review_id": 2288563618,
      "id": 1749277743,
      "node_id": "PRRC_kwDOABII585oQ9wv",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {\n+                LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n+                    coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n+\n+                // Typical Coin structures on disk are around 48 bytes in size.\n+                // Pushing a new one to the database can cause it to be written\n+                // twice (once in the log, and once in the tables). This is already\n+                // an overestimation, as most will delete an existing entry or\n+                // overwrite one. Still, use a conservative safety factor of 2.\n+                if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n+                    return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n+                }\n+                // Flush the chainstate (which may refer to block index entries).\n+                const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n+                if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {",
      "path": "src/validation.cpp",
      "position": 105,
      "original_position": 74,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741725078,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Renamed.",
      "created_at": "2024-09-08T15:59:17Z",
      "updated_at": "2024-09-08T15:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2944,
      "original_line": 2944,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277789",
      "pull_request_review_id": 2288563647,
      "id": 1749277789,
      "node_id": "PRRC_kwDOABII585oQ9xd",
      "diff_hunk": "@@ -0,0 +1,48 @@\n+// Copyright (c) 2024- The Bitcoin Core developers",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 1,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": 1741737264,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Removed the dates altogether.",
      "created_at": "2024-09-08T15:59:29Z",
      "updated_at": "2024-09-08T15:59:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277789",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277789"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277815",
      "pull_request_review_id": 2288563664,
      "id": 1749277815,
      "node_id": "PRRC_kwDOABII585oQ9x3",
      "diff_hunk": "@@ -2835,18 +2839,20 @@ bool Chainstate::FlushStateToDisk(\n             }\n         }\n         const auto nNow{NodeClock::now()};\n-        // Avoid writing/flushing immediately after startup.\n-        if (m_last_write == decltype(m_last_write){}) {\n-            m_last_write = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n-        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > m_last_write + DATABASE_WRITE_INTERVAL;\n+        bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow >= m_next_write;\n         // Combine all conditions that result in a full cache flush.\n         bool fDoFullFlush = (mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical || fPeriodicWrite || fFlushForPrune;\n+\n+        if (fDoFullFlush || m_next_write == NodeClock::time_point::max()) {",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 33,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "1b448f5bca7fba361da773c72633ae9056ee0d23",
      "in_reply_to_id": 1741741467,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Split into 2 commits.",
      "created_at": "2024-09-08T15:59:39Z",
      "updated_at": "2024-09-08T15:59:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749277815",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749277815"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2851,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749324715",
      "pull_request_review_id": 2288586741,
      "id": 1749324715,
      "node_id": "PRRC_kwDOABII585oRJOr",
      "diff_hunk": "@@ -2887,33 +2880,32 @@ bool Chainstate::FlushStateToDisk(\n                 m_blockman.UnlinkPrunedFiles(setFilesToPrune);\n             }\n             m_last_write = nNow;\n-        }\n-        // Flush best chain related state. This can only be done if the blocks / block index write was also done.\n-        if (fDoFullFlush && !CoinsTip().GetBestBlock().IsNull()) {\n-            LOG_TIME_MILLIS_WITH_CATEGORY(strprintf(\"write coins cache to disk (%d coins, %.2fkB)\",\n-                coins_count, coins_mem_usage / 1000), BCLog::BENCH);\n-\n-            // Typical Coin structures on disk are around 48 bytes in size.\n-            // Pushing a new one to the database can cause it to be written\n-            // twice (once in the log, and once in the tables). This is already\n-            // an overestimation, as most will delete an existing entry or\n-            // overwrite one. Still, use a conservative safety factor of 2.\n-            if (!CheckDiskSpace(m_chainman.m_options.datadir, 48 * 2 * 2 * CoinsTip().GetCacheSize())) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Disk space is too low!\"));\n-            }\n-            // Flush the chainstate (which may refer to block index entries).\n-            const auto empty_cache{(mode == FlushStateMode::ALWAYS) || fCacheLarge || fCacheCritical};\n-            if (empty_cache ? !CoinsTip().Flush() : !CoinsTip().Sync()) {\n-                return FatalError(m_chainman.GetNotifications(), state, _(\"Failed to write to coin database.\"));\n+\n+            if (!CoinsTip().GetBestBlock().IsNull()) {",
      "path": "src/validation.cpp",
      "position": 90,
      "original_position": 60,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "81e9d97b86eb76191f16e26a4457974151ca5f62",
      "in_reply_to_id": 1741697957,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "you can resolve this comment",
      "created_at": "2024-09-08T18:49:45Z",
      "updated_at": "2024-09-08T18:49:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1749324715",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1749324715"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2929,
      "original_line": 2929,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1875770795",
      "pull_request_review_id": 2488440265,
      "id": 1875770795,
      "node_id": "PRRC_kwDOABII585vzf2r",
      "diff_hunk": "@@ -0,0 +1,47 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "a030c105c9f8021f8a8b9ab214958612e9bc906f",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think we can simplify the test structure here a bit:\r\n* `struct` in `TestSubscriber` already implies `public` inheritance\r\n* we can remove the explicitly defined default constructor\r\n* make the validator test local\r\n* remove unused param names, they're just noise here\r\n* avoid repeated `chainstate`\r\n```suggestion\r\nBOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\r\n{\r\n    struct TestSubscriber final : CValidationInterface {\r\n        bool m_did_flush{false};\r\n        void ChainStateFlushed(ChainstateRole, const CBlockLocator&) override { m_did_flush = true; }\r\n    };\r\n    const auto sub{std::make_shared<TestSubscriber>()};\r\n    m_node.validation_signals->RegisterSharedValidationInterface(sub);\r\n    auto& chainstate{Assert(m_node.chainman)->ActiveChainstate()};\r\n```\r\n\r\n",
      "created_at": "2024-12-09T10:52:19Z",
      "updated_at": "2024-12-09T11:01:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1875770795",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1875770795"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": 13,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1882801667",
      "pull_request_review_id": 2500653639,
      "id": 1882801667,
      "node_id": "PRRC_kwDOABII585wOUYD",
      "diff_hunk": "@@ -0,0 +1,47 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+#include <validationinterface.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_AUTO_TEST_SUITE(chainstate_write_tests)\n+\n+struct TestSubscriber final : public CValidationInterface {\n+    bool m_did_flush{false};\n+\n+    TestSubscriber() = default;\n+\n+    void ChainStateFlushed(ChainstateRole role, const CBlockLocator& locator) override\n+    {\n+        m_did_flush = true;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(chainstate_write_interval, TestingSetup)\n+{\n+    const auto sub{std::make_shared<TestSubscriber>()};\n+    m_node.validation_signals->RegisterSharedValidationInterface(sub);\n+    Chainstate& chainstate{Assert(m_node.chainman)->ActiveChainstate()};",
      "path": "src/test/chainstate_write_tests.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "a030c105c9f8021f8a8b9ab214958612e9bc906f",
      "in_reply_to_id": 1875770795,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-12-12T19:56:38Z",
      "updated_at": "2024-12-12T19:56:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1882801667",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1882801667"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": 13,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1898689788",
      "pull_request_review_id": 2524345746,
      "id": 1898689788,
      "node_id": "PRRC_kwDOABII585xK7T8",
      "diff_hunk": "@@ -2881,21 +2879,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "e31152233db142b1b2c957fe4d392bfcf20cd899",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This comment could be adjusted - `fPeriodicWrite` is no longer just about the block index.",
      "created_at": "2024-12-27T19:48:05Z",
      "updated_at": "2024-12-27T19:48:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1898689788",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1898689788"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2886,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1898942778",
      "pull_request_review_id": 2524757750,
      "id": 1898942778,
      "node_id": "PRRC_kwDOABII585xL5E6",
      "diff_hunk": "@@ -2881,21 +2879,16 @@ bool Chainstate::FlushStateToDisk(\n         if (m_last_write == decltype(m_last_write){}) {\n             m_last_write = nNow;\n         }\n-        if (m_last_flush == decltype(m_last_flush){}) {\n-            m_last_flush = nNow;\n-        }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n         // The cache is over the limit, we have to write now.\n         bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.",
      "path": "src/validation.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "b37452ca437856ed5d8effce2cef737d9df479c1",
      "original_commit_id": "e31152233db142b1b2c957fe4d392bfcf20cd899",
      "in_reply_to_id": 1898689788,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Adjusted, thanks:\r\n>         // It's been a while since we wrote the block index and chain state to disk. Do this frequently, so we don't need to redownload or reindex after a crash.\r\n",
      "created_at": "2024-12-28T15:32:48Z",
      "updated_at": "2024-12-28T15:32:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30611#discussion_r1898942778",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1898942778"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30611"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2886,
      "side": "RIGHT"
    }
  ]
}