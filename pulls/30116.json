{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116",
    "id": 1871961574,
    "node_id": "PR_kwDOABII585vk93m",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30116",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30116.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30116.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
    "number": 30116,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "p2p: Fill reconciliation sets (Erlay) attempt 2",
    "user": {
      "login": "sr-gi",
      "id": 6665628,
      "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sr-gi",
      "html_url": "https://github.com/sr-gi",
      "followers_url": "https://api.github.com/users/sr-gi/followers",
      "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
      "organizations_url": "https://api.github.com/users/sr-gi/orgs",
      "repos_url": "https://api.github.com/users/sr-gi/repos",
      "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/sr-gi/received_events",
      "type": "User",
      "site_admin": false,
      "patch_url": null
    },
    "body": "This is a re-attempt of https://github.com/bitcoin/bitcoin/pull/28765\r\n\r\nThe main differences from it are:\r\n- Most outstanding comments have been addressed (or responded to on the original PR)\r\n- The description of how a node is picked in `IsFanoutTarget` has been updated to reflect what the algorithm is doing (not how it is doing it)\r\n- The way `hash_key` is seeded in `IsFanoutTarget` has changed (from `m_k0` to `node_id`). This is to prevent using `m_k0` for something it is not intended to, given what data we feed to the randomizer should not matter for this\r\n- The cache in `IsFanoutTarget` was only being fed data to, but never checked. This has been reworked to make use of it\r\n- `destinations/target` has been renamed to `n` in `ShouldFanoutTo/IsFanoutTarget` \r\n- The PR has been rebased\r\n\r\nAlso, the following things have been added/changed to the approach:\r\n- Deal with short id collisions by fanning out both transactions\r\n- Deal with ancestors being present on the mempool when a child needs to be placed in the fanout or reconciliation sets (as opposed to dealing with parents, which was the wrong approach)\r\n- Move fanout/reconcile logic from INV creation to `RelayTransaction`\r\n    - Create a delayed set where transactions that are added for reconciliation but still not offered to peers (for privacy reasons) live. This is analogous to how fanout works, where transactions are only made available on trickle intervals\r\n\r\nErlay Project Tracking: https://github.com/bitcoin/bitcoin/issues/30249",
    "labels": [
      {
        "id": 98298007,
        "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
        "name": "P2P",
        "color": "006b75",
        "default": false
      }
    ],
    "created_at": "2024-05-15T20:01:38Z",
    "updated_at": "2024-11-26T20:29:05Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "df8a40a27df1d8f62f61a2fc9a3d6abdc881cc4d",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "sr-gi:2023-11-erlay2.1",
      "ref": "2023-11-erlay2.1",
      "sha": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 217783888,
        "node_id": "MDEwOlJlcG9zaXRvcnkyMTc3ODM4ODg=",
        "name": "bitcoin",
        "full_name": "sr-gi/bitcoin",
        "owner": {
          "login": "sr-gi",
          "id": 6665628,
          "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
          "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/sr-gi",
          "html_url": "https://github.com/sr-gi",
          "followers_url": "https://api.github.com/users/sr-gi/followers",
          "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
          "organizations_url": "https://api.github.com/users/sr-gi/orgs",
          "repos_url": "https://api.github.com/users/sr-gi/repos",
          "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/sr-gi/received_events",
          "type": "User",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/sr-gi/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/sr-gi/bitcoin",
        "archive_url": "https://api.github.com/repos/sr-gi/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/sr-gi/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/sr-gi/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/sr-gi/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/sr-gi/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/sr-gi/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/sr-gi/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/sr-gi/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/sr-gi/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/sr-gi/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/sr-gi/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/sr-gi/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/sr-gi/bitcoin/events",
        "forks_url": "https://api.github.com/repos/sr-gi/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/sr-gi/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/sr-gi/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/sr-gi/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/sr-gi/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/sr-gi/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/sr-gi/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/sr-gi/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/sr-gi/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/sr-gi/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/sr-gi/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/sr-gi/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/sr-gi/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/sr-gi/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/sr-gi/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/sr-gi/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:sr-gi/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/sr-gi/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/sr-gi/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/sr-gi/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/sr-gi/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/sr-gi/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/sr-gi/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/sr-gi/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/sr-gi/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/sr-gi/bitcoin/hooks",
        "svn_url": "https://github.com/sr-gi/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 0,
        "stargazers_count": 0,
        "watchers_count": 0,
        "size": 253763,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-11-14T21:22:51Z",
        "created_at": "2019-10-27T00:01:30Z",
        "updated_at": "2024-05-28T15:33:59Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "2d944e982c473e4ee4b8f99105f6ce7172c401be",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 36474,
        "stargazers_count": 79838,
        "watchers_count": 79838,
        "size": 272716,
        "default_branch": "master",
        "open_issues_count": 665,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-11-26T19:58:55Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-11-26T19:59:03Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
      }
    },
    "author_association": "MEMBER",
    "draft": false,
    "additions": 927,
    "deletions": 35,
    "changed_files": 8,
    "commits": 12,
    "review_comments": 146,
    "comments": 15
  },
  "events": [
    {
      "event": "commented",
      "id": 2113359903,
      "node_id": "IC_kwDOABII585991Af",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113359903",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:01:40Z",
      "updated_at": "2024-11-15T06:22:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/30116.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#31153](https://github.com/bitcoin/bitcoin/pull/31153) (bench: Remove various extraneous benchmarks by dergoegge)\n* [#31001](https://github.com/bitcoin/bitcoin/pull/31001) (refactor: ensure type safety for txid and wtxid in `RelayTransaction` by marcofleon)\n* [#30987](https://github.com/bitcoin/bitcoin/pull/30987) (Don't zero-after-free `DataStream`: Faster IBD on some configurations by davidgumberg)\n* [#29415](https://github.com/bitcoin/bitcoin/pull/29415) (Broadcast own transactions only via short-lived Tor or I2P connections by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2113359903",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "labeled",
      "id": 12823068376,
      "node_id": "LE_lADOABII586JBASVzwAAAAL8UH7Y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12823068376",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:01:42Z",
      "label": {
        "name": "P2P",
        "color": "006b75"
      }
    },
    {
      "event": "commented",
      "id": 2113365602,
      "node_id": "IC_kwDOABII585992Zi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2113365602",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:05:34Z",
      "updated_at": "2024-05-15T20:05:34Z",
      "author_association": "MEMBER",
      "body": "I've talked to @naumenkogs about picking this up and he was happy about it. I'm happy to close this if he changes his mind.",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2113365602",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "mentioned",
      "id": 12823105634,
      "node_id": "MEE_lADOABII586JBASVzwAAAAL8URBi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12823105634",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:05:35Z"
    },
    {
      "event": "subscribed",
      "id": 12823105651,
      "node_id": "SE_lADOABII586JBASVzwAAAAL8URBz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12823105651",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:05:35Z"
    },
    {
      "event": "renamed",
      "id": 12823155636,
      "node_id": "RTE_lADOABII586JBASVzwAAAAL8UdO0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12823155636",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-15T20:10:39Z",
      "rename": {
        "from": "p2p: Fill reconciliation sets (Erlay) attempt: 2",
        "to": "p2p: Fill reconciliation sets (Erlay) attempt 2"
      }
    },
    {
      "event": "reviewed",
      "id": 2059094027,
      "node_id": "PRR_kwDOABII5856u0gL",
      "url": null,
      "actor": null,
      "commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2059094027",
      "submitted_at": "2024-05-15T22:03:28Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2059097014,
      "node_id": "PRR_kwDOABII5856u1O2",
      "url": null,
      "actor": null,
      "commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2059097014",
      "submitted_at": "2024-05-15T22:06:36Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2060684244,
      "node_id": "PRR_kwDOABII585604vU",
      "url": null,
      "actor": null,
      "commit_id": "3f59bf83a41b7787f9c43c277b5e62f327a72c3e",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2060684244",
      "submitted_at": "2024-05-16T13:02:43Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12835250927,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAL9CmLv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12835250927",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T14:45:13Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12835330239,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAL9C5i_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12835330239",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T14:49:59Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12835446695,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAL9DV-n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12835446695",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-16T14:57:26Z"
    },
    {
      "event": "reviewed",
      "id": 2071518907,
      "node_id": "PRR_kwDOABII5857eN67",
      "url": null,
      "actor": null,
      "commit_id": "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2071518907",
      "submitted_at": "2024-05-22T14:51:49Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 12987634269,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMGH5Jd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/12987634269",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-30T15:08:35Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13003134824,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMHDBdo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13003134824",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T16:26:41Z"
    },
    {
      "event": "commented",
      "id": 2142608188,
      "node_id": "IC_kwDOABII585_tZs8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142608188",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T16:29:34Z",
      "updated_at": "2024-05-31T16:29:34Z",
      "author_association": "MEMBER",
      "body": "I've slightly extended the approach adding 3 commits to deal with short id collisions, which were not taken into account. Some of this may be squashable, I've added them separately for now so they are easy to diff/review.\r\n\r\nThis would be missing an additional commit/amend to deal with https://github.com/bitcoin/bitcoin/pull/28765#discussion_r1401014445, which I overlooked when addressing the outstanding comments",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2142608188",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13003204753,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMHDSiR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13003204753",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T16:32:45Z"
    },
    {
      "event": "labeled",
      "id": 13003205680,
      "node_id": "LE_lADOABII586JBASVzwAAAAMHDSww",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13003205680",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T16:32:49Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2142612746,
      "node_id": "IC_kwDOABII585_ta0K",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2142612746",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-05-31T16:32:50Z",
      "updated_at": "2024-05-31T16:32:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\n At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25659971810</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2142612746",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13022605803,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMINTHr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13022605803",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T14:50:04Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13023750405,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMIRqkF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13023750405",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T16:09:16Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13024748224,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMIVeLA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13024748224",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T17:35:28Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13024766610,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMIViqS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13024766610",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T17:37:16Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13026060825,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMIaeoZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13026060825",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T19:41:32Z"
    },
    {
      "event": "unlabeled",
      "id": 13027532810,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAMIgGAK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13027532810",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-03T22:08:01Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13084081040,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAML3zuQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13084081040",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-07T18:10:18Z"
    },
    {
      "event": "convert_to_draft",
      "id": 13084155278,
      "node_id": "CTDE_lADOABII586JBASVzwAAAAML4F2O",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13084155278",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-07T18:19:12Z"
    },
    {
      "event": "commented",
      "id": 2155312276,
      "node_id": "IC_kwDOABII586Ad3SU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155312276",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-07T18:21:05Z",
      "updated_at": "2024-06-07T18:21:05Z",
      "author_association": "MEMBER",
      "body": "I added two more commits, moving the fanout/reconciling logic to `RelayTransaction` instead of send message, plus dealing with ancestors in mempool, instead of descendants (which seemed to be the wrong approach).\r\n\r\nI'm moving this to draft for now until I clean it a bit, plus get some feedback on the approach",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2155312276",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "labeled",
      "id": 13087363305,
      "node_id": "LE_lADOABII586JBASVzwAAAAMMEVDp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13087363305",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-08T05:17:03Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2155814489,
      "node_id": "IC_kwDOABII586Afx5Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2155814489",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-08T05:17:04Z",
      "updated_at": "2024-06-08T05:17:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\n At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/25955152377</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2155814489",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "reviewed",
      "id": 2106130875,
      "node_id": "PRR_kwDOABII5859iQG7",
      "url": null,
      "actor": null,
      "commit_id": "5bd1a958d264910799fcfd985b12d41ab5f4ee91",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "",
      "user": {
        "login": "Saraeutsza",
        "id": 162553652,
        "node_id": "U_kgDOCbBfNA",
        "avatar_url": "https://avatars.githubusercontent.com/u/162553652?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Saraeutsza",
        "html_url": "https://github.com/Saraeutsza",
        "followers_url": "https://api.github.com/users/Saraeutsza/followers",
        "following_url": "https://api.github.com/users/Saraeutsza/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Saraeutsza/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Saraeutsza/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Saraeutsza/subscriptions",
        "organizations_url": "https://api.github.com/users/Saraeutsza/orgs",
        "repos_url": "https://api.github.com/users/Saraeutsza/repos",
        "events_url": "https://api.github.com/users/Saraeutsza/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Saraeutsza/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2106130875",
      "submitted_at": "2024-06-09T10:05:05Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13106290356,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMNMh60",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13106290356",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-10T19:08:29Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13106325951,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMNMqm_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13106325951",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-10T19:12:09Z"
    },
    {
      "event": "reviewed",
      "id": 2110226626,
      "node_id": "PRR_kwDOABII5859x4DC",
      "url": null,
      "actor": null,
      "commit_id": "edb007255bb01526e63637f6d5fe5a6b413d1607",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "body": "",
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2110226626",
      "submitted_at": "2024-06-11T12:09:44Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13121277143,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMOFszX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13121277143",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-11T18:34:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13122274271,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMOJgPf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13122274271",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-11T20:10:28Z"
    },
    {
      "event": "unlabeled",
      "id": 13125496881,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAMOVzAx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13125496881",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-12T03:52:50Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13151080419,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMP3Y_j",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13151080419",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-13T18:14:22Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13151661694,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMP5m5-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13151661694",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-13T19:07:50Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13151963458,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMP6wlC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13151963458",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-13T19:39:09Z"
    },
    {
      "event": "ready_for_review",
      "id": 13152164843,
      "node_id": "RFRE_lADOABII586JBASVzwAAAAMP7hvr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13152164843",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-13T20:00:25Z"
    },
    {
      "event": "commented",
      "id": 2166667309,
      "node_id": "IC_kwDOABII586BJLgt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2166667309",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-13T20:01:47Z",
      "updated_at": "2024-06-13T20:01:47Z",
      "author_association": "MEMBER",
      "body": "This should be ready for review now.",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2166667309",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "reviewed",
      "id": 2116801594,
      "node_id": "PRR_kwDOABII585-K9Q6",
      "url": null,
      "actor": null,
      "commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2116801594",
      "submitted_at": "2024-06-13T20:02:50Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13163667629,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMQnaCt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13163667629",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-14T17:09:51Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13163687257,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMQne1Z",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13163687257",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-14T17:12:11Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13205630580,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMTHe50",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13205630580",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-18T19:30:54Z"
    },
    {
      "event": "labeled",
      "id": 13208301312,
      "node_id": "LE_lADOABII586JBASVzwAAAAMTRq8A",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13208301312",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-19T00:42:30Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 13213873919,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAMTm7b_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13213873919",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-19T10:06:59Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 13232750661,
      "node_id": "LE_lADOABII586JBASVzwAAAAMUu8BF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13232750661",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T18:04:33Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13233226272,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAMUwwIg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13233226272",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T18:49:49Z"
    },
    {
      "event": "unlabeled",
      "id": 13233996642,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAMUzsNi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13233996642",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T20:08:42Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2208699739,
      "node_id": "IC_kwDOABII586DphVb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2208699739",
      "actor": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-04T11:03:59Z",
      "updated_at": "2024-07-04T11:07:18Z",
      "author_association": "MEMBER",
      "body": "Needs rebase (for #29625)",
      "user": {
        "login": "glozow",
        "id": 25183001,
        "node_id": "MDQ6VXNlcjI1MTgzMDAx",
        "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/glozow",
        "html_url": "https://github.com/glozow",
        "followers_url": "https://api.github.com/users/glozow/followers",
        "following_url": "https://api.github.com/users/glozow/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/glozow/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/glozow/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
        "organizations_url": "https://api.github.com/users/glozow/orgs",
        "repos_url": "https://api.github.com/users/glozow/repos",
        "events_url": "https://api.github.com/users/glozow/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/glozow/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2208699739",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "labeled",
      "id": 13393420581,
      "node_id": "LE_lADOABII586JBASVzwAAAAMeT2El",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13393420581",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-04T11:16:54Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2161914223,
      "node_id": "PRR_kwDOABII586A3DFv",
      "url": null,
      "actor": null,
      "commit_id": "2e0b6742b82e60ea685afd25f2d19b8b558678ce",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2161914223",
      "submitted_at": "2024-07-07T19:52:13Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "commented",
      "id": 2214110228,
      "node_id": "IC_kwDOABII586D-KQU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2214110228",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-07-08T13:40:47Z",
      "updated_at": "2024-07-08T13:40:47Z",
      "author_association": "MEMBER",
      "body": "> Needs rebase (for #29625)\r\n\r\nCurrently working on some simulations, will rebase soon",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2214110228",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14253630400,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANRlSPA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14253630400",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T19:45:27Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14253779453,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANRl2n9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14253779453",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T19:59:42Z"
    },
    {
      "event": "labeled",
      "id": 14253780141,
      "node_id": "LE_lADOABII586JBASVzwAAAANRl2yt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14253780141",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T19:59:46Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2350062970,
      "node_id": "IC_kwDOABII586MEx16",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2350062970",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T19:59:47Z",
      "updated_at": "2024-09-13T19:59:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/30127266270</sub>\n\n<details><summary>Hints</summary>\n\nMake sure to run all tests locally, according to the documentation.\n\nThe failure may happen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2350062970",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "unlabeled",
      "id": 14253885408,
      "node_id": "UNLE_lADOABII586JBASVzwAAAANRmQfg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14253885408",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T20:09:45Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14254269463,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANRnuQX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14254269463",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T20:43:36Z"
    },
    {
      "event": "unlabeled",
      "id": 14254871836,
      "node_id": "UNLE_lADOABII586JBASVzwAAAANRqBUc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14254871836",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-09-13T21:56:03Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2319731127,
      "node_id": "PRR_kwDOABII586KREm3",
      "url": null,
      "actor": null,
      "commit_id": "3879f550d3c513c83ab34df7bc390e33c89e7e72",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2319731127",
      "submitted_at": "2024-09-21T12:47:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2341627272,
      "node_id": "PRR_kwDOABII586LkmWI",
      "url": null,
      "actor": null,
      "commit_id": "41ae26695f4c98a3dc05ca083e355ef93774ce8f",
      "commit_url": null,
      "created_at": null,
      "author_association": "NONE",
      "user": {
        "login": "Saraeutsza",
        "id": 162553652,
        "node_id": "U_kgDOCbBfNA",
        "avatar_url": "https://avatars.githubusercontent.com/u/162553652?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Saraeutsza",
        "html_url": "https://github.com/Saraeutsza",
        "followers_url": "https://api.github.com/users/Saraeutsza/followers",
        "following_url": "https://api.github.com/users/Saraeutsza/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Saraeutsza/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Saraeutsza/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Saraeutsza/subscriptions",
        "organizations_url": "https://api.github.com/users/Saraeutsza/orgs",
        "repos_url": "https://api.github.com/users/Saraeutsza/repos",
        "events_url": "https://api.github.com/users/Saraeutsza/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Saraeutsza/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2341627272",
      "submitted_at": "2024-10-01T23:37:24Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14490723464,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANftuSI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14490723464",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:18:44Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14490804720,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANfuCHw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14490804720",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:23:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14490857764,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANfuPEk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14490857764",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:26:08Z"
    },
    {
      "event": "commented",
      "id": 2388991602,
      "node_id": "IC_kwDOABII586OZR5y",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2388991602",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:35:48Z",
      "updated_at": "2024-10-02T15:35:48Z",
      "author_association": "MEMBER",
      "body": "I've added a commit introducing a delayed set to store transactions that are being reconciled, but won't be added to the sketch should it be constructed at this time. This is to mimic the fanout trickling logic where transactions are only made available to peers if they would have been INVed to them. This was already part of @naumenkogs approach, but was scrapped out when reworking when data is added to the reconciliation set in a22b2364f5942266596c78ad306b1e32aa89aa0f",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2388991602",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "mentioned",
      "id": 14491040573,
      "node_id": "MEE_lADOABII586JBASVzwAAAANfu7s9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14491040573",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:35:50Z"
    },
    {
      "event": "subscribed",
      "id": 14491040599,
      "node_id": "SE_lADOABII586JBASVzwAAAANfu7tX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14491040599",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T15:35:50Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14494613798,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANf8kEm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14494613798",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-02T20:01:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14508130816,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANgwIIA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14508130816",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-03T17:45:35Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14509510880,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANg1ZDg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14509510880",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-03T19:38:56Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14509608301,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANg1w1t",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14509608301",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-03T19:48:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14509715522,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAANg2LBC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14509715522",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-03T19:58:34Z"
    },
    {
      "event": "reviewed",
      "id": 2363929991,
      "node_id": "PRR_kwDOABII586M5rWH",
      "url": null,
      "actor": null,
      "commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "commit_url": null,
      "created_at": null,
      "author_association": "CONTRIBUTOR",
      "body": "I fuzzed the `txreconciliation` class with `-DSANITIZERS=fuzzer,undefined,integer` and two related runtime errors occurred:\r\n\r\n<details>\r\n<summary>errors</summary>\r\n\r\n```bash\r\n../../src/node/txreconciliation.cpp:457:46: runtime error: unsigned integer overflow: 1 - 3 cannot be represented in type 'size_t' (aka 'unsigned long')\r\n    #0 0x55ddab3b7d99 in TxReconciliationTracker::Impl::ShouldFanoutTo(transaction_identifier<true> const&, long, unsigned long, unsigned long) erlayfuzzbuild/src/../../src/node/txreconciliation.cpp:457:46\r\n    #1 0x55ddaa5521c7 in txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7::operator()() const erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/txreconciliation.cpp:118:46\r\n    #2 0x55ddaa5521c7 in unsigned long CallOneOf<txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_0, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_1, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_2, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_3, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_4, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_5, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_6, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_8>(FuzzedDataProvider&, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_0, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_1, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_2, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_3, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_4, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_5, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_6, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_8) erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/util.h:42:27\r\n    #3 0x55ddaa5521c7 in txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>) erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/txreconciliation.cpp:68:9\r\n    #4 0x55ddaa6bf726 in std::function<void (std::span<unsigned char const, 18446744073709551615ul>)>::operator()(std::span<unsigned char const, 18446744073709551615ul>) const /usr/bin/../lib/gcc/x86_64-linux-gnu/12/../../../../include/c++/12/bits/std_function.h:591:9\r\n    #5 0x55ddaa6bf726 in LLVMFuzzerTestOneInput erlayfuzzbuild/src/test/fuzz/util/../../../../../src/test/fuzz/fuzz.cpp:209:5\r\n    #6 0x55ddaa04a840 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e6840) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #7 0x55ddaa049f75 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e5f75) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #8 0x55ddaa04b705 in fuzzer::Fuzzer::MutateAndTestOne() (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e7705) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #9 0x55ddaa04c305 in fuzzer::Fuzzer::Loop(std::vector<fuzzer::SizedFile, std::allocator<fuzzer::SizedFile>>&) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e8305) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #10 0x55ddaa03a52f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19d652f) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #11 0x55ddaa0638e2 in main (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19ff8e2) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #12 0x7fcd32ab6249  (/lib/x86_64-linux-gnu/libc.so.6+0x27249) (BuildId: 58254ca972028402bc40624f81388d85ec95f70d)\r\n    #13 0x7fcd32ab6304 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x27304) (BuildId: 58254ca972028402bc40624f81388d85ec95f70d)\r\n    #14 0x55ddaa02f920 in _start (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19cb920) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\nSUMMARY: UndefinedBehaviorSanitizer: unsigned-integer-overflow ../../src/node/txreconciliation.cpp:457:46 \r\n\r\n../../src/node/txreconciliation.cpp:401:100: runtime error: 7.92282e+28 is outside the range of representable values of type 'unsigned long'\r\n    #0 0x55ddab3c704a in TxReconciliationTracker::Impl::IsFanoutTarget(transaction_identifier<true> const&, long, bool, double) erlayfuzzbuild/src/../../src/node/txreconciliation.cpp:401:100\r\n    #1 0x55ddab3b7b83 in TxReconciliationTracker::Impl::ShouldFanoutTo(transaction_identifier<true> const&, long, unsigned long, unsigned long) erlayfuzzbuild/src/../../src/node/txreconciliation.cpp:471:16\r\n    #2 0x55ddaa5521c7 in txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7::operator()() const erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/txreconciliation.cpp:118:46\r\n    #3 0x55ddaa5521c7 in unsigned long CallOneOf<txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_0, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_1, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_2, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_3, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_4, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_5, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_6, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_8>(FuzzedDataProvider&, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_0, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_1, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_2, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_3, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_4, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_5, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_6, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_7, txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>)::$_8) erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/util.h:42:27\r\n    #4 0x55ddaa5521c7 in txreconciliation_fuzz_target(std::span<unsigned char const, 18446744073709551615ul>) erlayfuzzbuild/src/test/fuzz/../../../../src/test/fuzz/txreconciliation.cpp:68:9\r\n    #5 0x55ddaa6bf726 in std::function<void (std::span<unsigned char const, 18446744073709551615ul>)>::operator()(std::span<unsigned char const, 18446744073709551615ul>) const /usr/bin/../lib/gcc/x86_64-linux-gnu/12/../../../../include/c++/12/bits/std_function.h:591:9\r\n    #6 0x55ddaa6bf726 in LLVMFuzzerTestOneInput erlayfuzzbuild/src/test/fuzz/util/../../../../../src/test/fuzz/fuzz.cpp:209:5\r\n    #7 0x55ddaa04a840 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e6840) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #8 0x55ddaa049f75 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e5f75) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #9 0x55ddaa04b705 in fuzzer::Fuzzer::MutateAndTestOne() (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e7705) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #10 0x55ddaa04c305 in fuzzer::Fuzzer::Loop(std::vector<fuzzer::SizedFile, std::allocator<fuzzer::SizedFile>>&) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19e8305) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #11 0x55ddaa03a52f in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19d652f) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #12 0x55ddaa0638e2 in main (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19ff8e2) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\n    #13 0x7fcd32ab6249  (/lib/x86_64-linux-gnu/libc.so.6+0x27249) (BuildId: 58254ca972028402bc40624f81388d85ec95f70d)\r\n    #14 0x7fcd32ab6304 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x27304) (BuildId: 58254ca972028402bc40624f81388d85ec95f70d)\r\n    #15 0x55ddaa02f920 in _start (/root/bitcoin/erlayfuzzbuild/src/test/fuzz/fuzz+0x19cb920) (BuildId: 9429992cf566016ee2d3d51625e57700f09635fc)\r\nSUMMARY: UndefinedBehaviorSanitizer: float-cast-overflow ../../src/node/txreconciliation.cpp:401:100 \r\n==222068== ERROR: libFuzzer: out-of-memory (used: 4046Mb; limit: 2048Mb)\r\n   To change the out-of-memory limit use -rss_limit_mb=<N>\r\n\r\nMS: 4 ChangeBinInt-ChangeBit-CrossOver-CrossOver-; base unit: 0cbe4c9fe667ead352437139e9ea437783de5c0c\r\n0xad,0xad,0xad,0x60,0x0,0x0,0x0,0x0,0x0,0x0,0x37,0xff,0xff,0xff,0xff,0xd2,0xff,0xff,0xff,0xd2,0xd2,0xd2,0xd2,0xd2,0xd2,0xd2,0xd2,0x3b,0xd2,0xd2,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xdf,0xff,0x0,0xff,0xff,0x9,0x0,0x0,0x0,0x0,0x0,0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x75,0xff,0xff,0xff,0xd2,0xd2,0xd2,0xd2,0xd2,0xd2,0xbf,0xff,0x0,0x0,0x0,0x52,0xad,0xad,0xbf,0x6a,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xa0,0xad,0x1,0x0,0x0,\r\n\\255\\255\\255`\\000\\000\\000\\000\\000\\0007\\377\\377\\377\\377\\322\\377\\377\\377\\322\\322\\322\\322\\322\\322\\322\\322;\\322\\322\\377\\377\\377\\377\\377\\377\\377\\377\\337\\377\\000\\377\\377\\011\\000\\000\\000\\000\\000\\377\\000\\000\\000\\000\\000\\000\\000u\\377\\377\\377\\322\\322\\322\\322\\322\\322\\277\\377\\000\\000\\000R\\255\\255\\277j\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\240\\255\\001\\000\\000\r\nartifact_prefix='./'; Test unit written to ./oom-b217ee9df2670caf13a47abe1623c2f80e6d1f02\r\nBase64: ra2tYAAAAAAAADf/////0v///9LS0tLS0tLSO9LS///////////f/wD//wkAAAAAAP8AAAAAAAAAdf///9LS0tLS0r//AAAAUq2tv2qgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgrQEAAA==\r\nSUMMARY: libFuzzer: out-of-memory\r\n```\r\n\r\n</details>\r\n\r\n[oom-b217ee9df2670caf13a47abe1623c2f80e6d1f02.txt](https://github.com/user-attachments/files/17350703/oom-b217ee9df2670caf13a47abe1623c2f80e6d1f02.txt)\r\n\r\n\r\nLeft a question about it below.\r\n\r\n",
      "user": {
        "login": "marcofleon",
        "id": 95179662,
        "node_id": "U_kgDOBaxTjg",
        "avatar_url": "https://avatars.githubusercontent.com/u/95179662?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/marcofleon",
        "html_url": "https://github.com/marcofleon",
        "followers_url": "https://api.github.com/users/marcofleon/followers",
        "following_url": "https://api.github.com/users/marcofleon/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/marcofleon/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/marcofleon/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/marcofleon/subscriptions",
        "organizations_url": "https://api.github.com/users/marcofleon/orgs",
        "repos_url": "https://api.github.com/users/marcofleon/repos",
        "events_url": "https://api.github.com/users/marcofleon/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/marcofleon/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2363929991",
      "submitted_at": "2024-10-12T16:19:21Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2398229655,
      "node_id": "PRR_kwDOABII586O8hSX",
      "url": null,
      "actor": null,
      "commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2398229655",
      "submitted_at": "2024-10-28T09:31:25Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14968630280,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAN8MywI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968630280",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:47:07Z"
    },
    {
      "event": "commented",
      "id": 2442487595,
      "node_id": "IC_kwDOABII586RlWcr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2442487595",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:50:36Z",
      "updated_at": "2024-10-28T19:50:36Z",
      "author_association": "MEMBER",
      "body": "Squashed @naumenkogs fix on @marcofleon comment in ad95b2c0e21f1e865f967aa9463ef99bc252550a, plus added a commit replacing `IsFanoutTarget` with `GetFanoutTargets` so the cache for fanout can be dropped. After this, the fanout targets are computed just once per transaction",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2442487595",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "mentioned",
      "id": 14968671489,
      "node_id": "MEE_lADOABII586JBASVzwAAAAN8M80B",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968671489",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:50:38Z"
    },
    {
      "event": "subscribed",
      "id": 14968671507,
      "node_id": "SE_lADOABII586JBASVzwAAAAN8M80T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968671507",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:50:38Z"
    },
    {
      "event": "mentioned",
      "id": 14968671528,
      "node_id": "MEE_lADOABII586JBASVzwAAAAN8M80o",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968671528",
      "actor": {
        "login": "marcofleon",
        "id": 95179662,
        "node_id": "U_kgDOBaxTjg",
        "avatar_url": "https://avatars.githubusercontent.com/u/95179662?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/marcofleon",
        "html_url": "https://github.com/marcofleon",
        "followers_url": "https://api.github.com/users/marcofleon/followers",
        "following_url": "https://api.github.com/users/marcofleon/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/marcofleon/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/marcofleon/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/marcofleon/subscriptions",
        "organizations_url": "https://api.github.com/users/marcofleon/orgs",
        "repos_url": "https://api.github.com/users/marcofleon/repos",
        "events_url": "https://api.github.com/users/marcofleon/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/marcofleon/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:50:38Z"
    },
    {
      "event": "subscribed",
      "id": 14968671536,
      "node_id": "SE_lADOABII586JBASVzwAAAAN8M80w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968671536",
      "actor": {
        "login": "marcofleon",
        "id": 95179662,
        "node_id": "U_kgDOBaxTjg",
        "avatar_url": "https://avatars.githubusercontent.com/u/95179662?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/marcofleon",
        "html_url": "https://github.com/marcofleon",
        "followers_url": "https://api.github.com/users/marcofleon/followers",
        "following_url": "https://api.github.com/users/marcofleon/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/marcofleon/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/marcofleon/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/marcofleon/subscriptions",
        "organizations_url": "https://api.github.com/users/marcofleon/orgs",
        "repos_url": "https://api.github.com/users/marcofleon/repos",
        "events_url": "https://api.github.com/users/marcofleon/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/marcofleon/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T19:50:38Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14968804933,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAN8NdZF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968804933",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T20:02:15Z"
    },
    {
      "event": "labeled",
      "id": 14968806001,
      "node_id": "LE_lADOABII586JBASVzwAAAAN8Ndpx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14968806001",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T20:02:20Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2442509003,
      "node_id": "IC_kwDOABII586RlbrL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2442509003",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T20:02:21Z",
      "updated_at": "2024-10-28T20:02:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/32180649974</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2442509003",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14969644398,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAN8QqVu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14969644398",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T21:16:29Z"
    },
    {
      "event": "unlabeled",
      "id": 14970502830,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAN8T76u",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14970502830",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-28T22:42:30Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2401362483,
      "node_id": "PRR_kwDOABII586PIeIz",
      "url": null,
      "actor": null,
      "commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2401362483",
      "submitted_at": "2024-10-29T10:06:19Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2401412734,
      "node_id": "PRR_kwDOABII586PIqZ-",
      "url": null,
      "actor": null,
      "commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2401412734",
      "submitted_at": "2024-10-29T10:17:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2401436632,
      "node_id": "PRR_kwDOABII586PIwPY",
      "url": null,
      "actor": null,
      "commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2401436632",
      "submitted_at": "2024-10-29T10:27:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2401450441,
      "node_id": "PRR_kwDOABII586PIznJ",
      "url": null,
      "actor": null,
      "commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2401450441",
      "submitted_at": "2024-10-29T10:33:34Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "labeled",
      "id": 14990685668,
      "node_id": "LE_lADOABII586JBASVzwAAAAN9g7Xk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14990685668",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-29T20:05:35Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14991341560,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAN9jbf4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14991341560",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-29T21:06:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15009203941,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAN-nkbl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15009203941",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-30T14:59:04Z"
    },
    {
      "event": "commented",
      "id": 2447434066,
      "node_id": "IC_kwDOABII586R4OFS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2447434066",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-30T14:59:22Z",
      "updated_at": "2024-10-30T14:59:22Z",
      "author_association": "MEMBER",
      "body": "Rebasing to deal with merge conflicts",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2447434066",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "unlabeled",
      "id": 15012329940,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAN-zfnU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15012329940",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-30T16:47:06Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2407676322,
      "node_id": "PRR_kwDOABII586Pgjmi",
      "url": null,
      "actor": null,
      "commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2407676322",
      "submitted_at": "2024-10-31T11:17:52Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2409798591,
      "node_id": "PRR_kwDOABII586Popu_",
      "url": null,
      "actor": null,
      "commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2409798591",
      "submitted_at": "2024-11-01T09:49:22Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "reviewed",
      "id": 2409819446,
      "node_id": "PRR_kwDOABII586Pou02",
      "url": null,
      "actor": null,
      "commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2409819446",
      "submitted_at": "2024-11-01T10:06:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDdlNDJhNTA2MzEyMzE1ZjcwZjA3NGNlMjYxN2E1NmNhMjFmNWUyYjg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7e42a506312315f70f074ce2617a56ca21f5e2b8",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7e42a506312315f70f074ce2617a56ca21f5e2b8",
      "tree": {
        "sha": "95471a00b4ef41b62ae6c4bddbaad72db24ef003",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/95471a00b4ef41b62ae6c4bddbaad72db24ef003"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4a0251c05dd7df982cceaf38c50d923608a66807",
          "sha": "4a0251c05dd7df982cceaf38c50d923608a66807",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4a0251c05dd7df982cceaf38c50d923608a66807"
        }
      ],
      "message": "refactor: remove legacy comments\n\nThese comments became irrelevant in one of the previous code changes.\nThey simply don't make sense anymore.",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-01T19:59:28Z"
      },
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2023-12-05T08:20:48Z"
      },
      "sha": "7e42a506312315f70f074ce2617a56ca21f5e2b8"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15074678099,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOChVVT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15074678099",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-01T20:43:44Z"
    },
    {
      "event": "commented",
      "id": 2452563866,
      "node_id": "IC_kwDOABII586SLyea",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2452563866",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-01T20:44:24Z",
      "updated_at": "2024-11-01T20:44:24Z",
      "author_association": "MEMBER",
      "body": "Rebased to make CI green, plus covered (and masked as resolved) some outstanding comments:\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818553463\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818555798\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818577080\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818641775\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818703437\r\nhttps://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818706047",
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#issuecomment-2452563866",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15075296357,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOCjsRl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15075296357",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-01T22:15:25Z"
    },
    {
      "event": "labeled",
      "id": 15075296929,
      "node_id": "LE_lADOABII586JBASVzwAAAAOCjsah",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15075296929",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-01T22:15:32Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15075323008,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOCjyyA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15075323008",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-01T22:21:00Z"
    },
    {
      "event": "unlabeled",
      "id": 15075765947,
      "node_id": "UNLE_lADOABII586JBASVzwAAAAOCle67",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15075765947",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-02T00:04:06Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2412537999,
      "node_id": "PRR_kwDOABII586PzGiP",
      "url": null,
      "actor": null,
      "commit_id": "fecb8c2cb35425e0959d3680a28dfa61fa17819a",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2412537999",
      "submitted_at": "2024-11-04T10:21:57Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "mentioned",
      "id": 15103123282,
      "node_id": "MEE_lADOABII586JBASVzwAAAAOEN19S",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15103123282",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-04T12:30:14Z"
    },
    {
      "event": "subscribed",
      "id": 15103123301,
      "node_id": "SE_lADOABII586JBASVzwAAAAOEN19l",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15103123301",
      "actor": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-04T12:30:14Z"
    },
    {
      "event": "comment_deleted",
      "id": 15103139469,
      "node_id": "CDE_lADOABII586JBASVzwAAAAOEN56N",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15103139469",
      "actor": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-04T12:31:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15289964921,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOPWll5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15289964921",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "4f8ee9bd19f5bff35df344280a20a058a76f3310",
      "commit_url": "https://api.github.com/repos/sr-gi/bitcoin/commits/4f8ee9bd19f5bff35df344280a20a058a76f3310",
      "created_at": "2024-11-13T22:01:24Z"
    },
    {
      "event": "reviewed",
      "id": 2435223379,
      "node_id": "PRR_kwDOABII586RJo9T",
      "url": null,
      "actor": null,
      "commit_id": "ee46e21a5c913175415a192661b406b328209800",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2435223379",
      "submitted_at": "2024-11-14T07:16:04Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15304065846,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOQMYM2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15304065846",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "483edab5e01e7b788771d9ee4c21377a22e1d1ab",
      "commit_url": "https://api.github.com/repos/sr-gi/bitcoin/commits/483edab5e01e7b788771d9ee4c21377a22e1d1ab",
      "created_at": "2024-11-14T20:30:08Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDk2NjdjODlhN2JiOWI5ZGU1OGY0MWY3YjY5NmU1YjJiN2Y1YThlNTg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58",
      "tree": {
        "sha": "98a8f3bbf65abd2bdd921d97cce534e439d40b6c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/98a8f3bbf65abd2bdd921d97cce534e439d40b6c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7e42a506312315f70f074ce2617a56ca21f5e2b8",
          "sha": "7e42a506312315f70f074ce2617a56ca21f5e2b8",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7e42a506312315f70f074ce2617a56ca21f5e2b8"
        }
      ],
      "message": "p2p: Functions to add/remove wtxids to tx reconciliation sets\n\nThey will be used later on.",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:27Z"
      },
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2022-10-08T06:25:01Z"
      },
      "sha": "9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc4NGM0NThhY2JhNDBkZmM0MTE0M2Q2ZjgyZWI2MDIwZjAyMWEyOWI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/784c458acba40dfc41143d6f82eb6020f021a29b",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/784c458acba40dfc41143d6f82eb6020f021a29b",
      "tree": {
        "sha": "127bb57712442a4dcdd903b79e3c3f702785482f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/127bb57712442a4dcdd903b79e3c3f702785482f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58",
          "sha": "9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9667c89a7bb9b9de58f41f7b696e5b2b7f5a8e58"
        }
      ],
      "message": "p2p: Make short id collision detectable when adding wtxids to tx reconciliation sets",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-05-30T15:50:11Z"
      },
      "sha": "784c458acba40dfc41143d6f82eb6020f021a29b"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGUxYzMzZmY5Yjc5YzAzNTFlMzRjZDkyNDU5NTQ4ODQ4ZTc1NGM4ZTc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e1c33ff9b79c0351e34cd92459548848e754c8e7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e1c33ff9b79c0351e34cd92459548848e754c8e7",
      "tree": {
        "sha": "b73b304324de2d0c706b352705d112b2a043f295",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b73b304324de2d0c706b352705d112b2a043f295"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/784c458acba40dfc41143d6f82eb6020f021a29b",
          "sha": "784c458acba40dfc41143d6f82eb6020f021a29b",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/784c458acba40dfc41143d6f82eb6020f021a29b"
        }
      ],
      "message": "p2p: Add PeerManager method to count the amount of inbound/outbounds fanout peers",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-06-07T17:54:52Z"
      },
      "sha": "e1c33ff9b79c0351e34cd92459548848e754c8e7"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDFkY2U5YWVkYzU5ZWJhMmI2MjNjNzc4NWY1OTQzMGE1ODZmYmQ4MzM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1dce9aedc59eba2b623c7785f59430a586fbd833",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/1dce9aedc59eba2b623c7785f59430a586fbd833",
      "tree": {
        "sha": "26a2f2a19800c7967a70dd5ab2805f2c145d3943",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/26a2f2a19800c7967a70dd5ab2805f2c145d3943"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e1c33ff9b79c0351e34cd92459548848e754c8e7",
          "sha": "e1c33ff9b79c0351e34cd92459548848e754c8e7",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/e1c33ff9b79c0351e34cd92459548848e754c8e7"
        }
      ],
      "message": "p2p: Adds a method to sort peers by fewest parent\n\nWhen receiving a transaction that depends on an unconfirmed transactions, and needing to\ndecide what peer to fanout to, those with fewer parents already in the reconciliation set\nwill be prioritized",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-13T21:01:20Z"
      },
      "sha": "1dce9aedc59eba2b623c7785f59430a586fbd833"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDAwOTJmNzAzMTRiOGQ1OWI0MWZmNGJkMmJjMTVhNzFmOTU0NjY4ZDQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "tree": {
        "sha": "fe9ce24951b6e81fa45e8fc9cea6f550112aa507",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fe9ce24951b6e81fa45e8fc9cea6f550112aa507"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1dce9aedc59eba2b623c7785f59430a586fbd833",
          "sha": "1dce9aedc59eba2b623c7785f59430a586fbd833",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/1dce9aedc59eba2b623c7785f59430a586fbd833"
        }
      ],
      "message": "p2p: Add transactions to reconciliation sets\n\nTransactions eligible for reconciliation are added to the\nreconciliation sets. For the remaining txs, low-fanout is used.\n\nIf a transaction to be reconciled has in mempool ancestors, we need to be consistent\nwith the way in which we announce this transaction (either by fanning out or reconciling\nall the ancestor set). In order for Erlay to work best, a minimum amount of fanout is required.\nTherefore, we cannot simply reconcile with everyone in this case either. Find the subset of peers\nthat have the least ancestors to be reconciled and send all of them via fanout\n\nCo-authored-by:  Gleb Naumenko <naumenko.gs@gmail.com>",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-05-30T16:03:58Z"
      },
      "sha": "0092f70314b8d59b41ff4bd2bc15a71f954668d4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGE5MTk1YWVmMzMwMmE5ZWQ5NjRjZDc2ODU3NzY5ZDFmN2VhZDA1NGM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a9195aef3302a9ed964cd76857769d1f7ead054c",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/a9195aef3302a9ed964cd76857769d1f7ead054c",
      "tree": {
        "sha": "47e4314cfb52a50562ba1f790c0a111ada050691",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/47e4314cfb52a50562ba1f790c0a111ada050691"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0092f70314b8d59b41ff4bd2bc15a71f954668d4",
          "sha": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/0092f70314b8d59b41ff4bd2bc15a71f954668d4"
        }
      ],
      "message": "bench: add bench for ShouldFanoutTo",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2023-12-13T19:53:03Z"
      },
      "sha": "a9195aef3302a9ed964cd76857769d1f7ead054c"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGJiZTgzN2ViMzExOWNiZDliMTFiMzIzZDNhYWFmMGQ5NTE1YTIyYTg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8",
      "tree": {
        "sha": "af56b329ceb4146e50fd34b8996f3157c3580e80",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/af56b329ceb4146e50fd34b8996f3157c3580e80"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a9195aef3302a9ed964cd76857769d1f7ead054c",
          "sha": "a9195aef3302a9ed964cd76857769d1f7ead054c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/a9195aef3302a9ed964cd76857769d1f7ead054c"
        }
      ],
      "message": "p2p: Cache inbound reconciling peers count\n\nIt helps to avoid recomputing every time we consider\na transaction for fanout/reconciliation.\n\nCo-authored-by: Sergi Delgado Segura <sergi.delgado.s@gmail.com>",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2024-01-17T09:28:02Z"
      },
      "sha": "bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg4ZjY3NjU1MjM3ZDQ5NzczNTdiNWM5MzIxOTI1MmJhNWYwMmI2NWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88f67655237d4977357b5c93219252ba5f02b65e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/88f67655237d4977357b5c93219252ba5f02b65e",
      "tree": {
        "sha": "1f84ab04563526c098f6489c12d8ee8cc6927eb1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1f84ab04563526c098f6489c12d8ee8cc6927eb1"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8",
          "sha": "bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bbe837eb3119cbd9b11b323d3aaaf0d9515a22a8"
        }
      ],
      "message": "p2p: Add helper to compute reconciliation tx short ids and a cache of short ids to wtxids",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-05-30T16:03:58Z"
      },
      "sha": "88f67655237d4977357b5c93219252ba5f02b65e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDU5OTZkNDczNDM0ZDM2NGNmZjkzN2FlODlmZmQ5NWNkMDljNWQxYTc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5996d473434d364cff937ae89ffd95cd09c5d1a7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/5996d473434d364cff937ae89ffd95cd09c5d1a7",
      "tree": {
        "sha": "73d5ea3ba90974c3060451733405ca247ccf846c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/73d5ea3ba90974c3060451733405ca247ccf846c"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88f67655237d4977357b5c93219252ba5f02b65e",
          "sha": "88f67655237d4977357b5c93219252ba5f02b65e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/88f67655237d4977357b5c93219252ba5f02b65e"
        }
      ],
      "message": "p2p: Deal with shortid collisions for reconciliation sets\n\nIf a wtxid to be added to a peer's recon set has a shot id collisions (a previously\nadded wtxid maps to the same short id), both transaction should be fanout, given\nour peer may have added the opposite transaction to our recon set, and reconciliation\nwill fail. Moreover, all descendants of the previously added transaction that were in\nthe recon set should also be removed and fanout.",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T20:46:30Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-05-30T19:01:05Z"
      },
      "sha": "5996d473434d364cff937ae89ffd95cd09c5d1a7"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg0MGE0ZTE0ZjJkODMzNzE3Yzg3YTU0ZWMyNzA3YTkyZDUxMzFhZGE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/840a4e14f2d833717c87a54ec2707a92d5131ada",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/840a4e14f2d833717c87a54ec2707a92d5131ada",
      "tree": {
        "sha": "f8790cfc00ff874b18a72a4b26ea24eae86ce739",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f8790cfc00ff874b18a72a4b26ea24eae86ce739"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5996d473434d364cff937ae89ffd95cd09c5d1a7",
          "sha": "5996d473434d364cff937ae89ffd95cd09c5d1a7",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/5996d473434d364cff937ae89ffd95cd09c5d1a7"
        }
      ],
      "message": "p2p: Makes transactions available for reconciliation on trickle\n\nSplits the reconciliation set in two, a delayed set and an available set.\nTransactions are added to the delayed set and made available when on the next\ntrickle interval for the peer. This prevents adversarial nodes from proving\nour reconciliation set by spamming reconciliation requests, in an equivalent\nmanner to how fanout delays work",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T21:22:46Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-10-01T19:32:33Z"
      },
      "sha": "840a4e14f2d833717c87a54ec2707a92d5131ada"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGZjMDY3ODZmMzJiMmZjODJjOTU3MWViZGU2N2I0ZmY1NGY0YWQ4MjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "tree": {
        "sha": "79f72b15d05fea46b5ca6c4e2fd3ed97a7464b2f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/79f72b15d05fea46b5ca6c4e2fd3ed97a7464b2f"
      },
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "payload": null,
        "signature": null
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/840a4e14f2d833717c87a54ec2707a92d5131ada",
          "sha": "840a4e14f2d833717c87a54ec2707a92d5131ada",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/840a4e14f2d833717c87a54ec2707a92d5131ada"
        }
      ],
      "message": "p2p: Replaces IsFanoutTarget with GetFanoutTargets in TxReconciliationTracker\n\nInstead of checking if a target is fanout for every single node and having to store already\ncomputed values in a cache, we can simply return the lists of fanout targets for both inbounds and outbounds\nand just check for membership for each peer (depending on its type)",
      "committer": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-11-14T21:22:48Z"
      },
      "author": {
        "name": "Sergi Delgado Segura",
        "email": "sergi.delgado.s@gmail.com",
        "date": "2024-10-25T20:38:50Z"
      },
      "sha": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15304556829,
      "node_id": "HRFPE_lADOABII586JBASVzwAAAAOQOQEd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15304556829",
      "actor": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "commit_url": "https://api.github.com/repos/sr-gi/bitcoin/commits/fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "created_at": "2024-11-14T21:22:54Z"
    },
    {
      "event": "reviewed",
      "id": 2460468786,
      "node_id": "PRR_kwDOABII586Sp8Yy",
      "url": null,
      "actor": null,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#pullrequestreview-2460468786",
      "submitted_at": "2024-11-26T11:42:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602301949",
      "pull_request_review_id": 2059094027,
      "id": 1602301949,
      "node_id": "PRRC_kwDOABII585fgS_9",
      "diff_hunk": "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "path": "src/node/txreconciliation.h",
      "position": 88,
      "original_position": 12,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" 7c047d30cb0eadc8a424cb01de2fcd0978e22206: What is the step 2? This comment seems a little confuse because I couldn't find it as I see for Step 1.",
      "created_at": "2024-05-15T22:03:28Z",
      "updated_at": "2024-05-15T22:03:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602301949",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602301949"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 127,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602304001",
      "pull_request_review_id": 2059097014,
      "id": 1602304001,
      "node_id": "PRRC_kwDOABII585fgTgB",
      "diff_hunk": "@@ -115,10 +138,55 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (peer_state->m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        // The caller currently keeps track of the per-peer transaction announcements, so it\n+        // should not attempt to add same tx to the set twice. However, if that happens, we will\n+        // simply ignore it.\n+        if (peer_state->m_local_set.insert(wtxid).second) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                        \"Now the set contains %i transactions.\\n\",\n+                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+        }\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const Wtxid& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" https://github.com/bitcoin/bitcoin/commit/7c047d30cb0eadc8a424cb01de2fcd0978e22206: Perhaps adding a log when removing from set?",
      "created_at": "2024-05-15T22:06:35Z",
      "updated_at": "2024-05-15T22:06:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1602304001",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1602304001"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 180,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603304486",
      "pull_request_review_id": 2060684244,
      "id": 1603304486,
      "node_id": "PRRC_kwDOABII585fkHwm",
      "diff_hunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>",
      "path": "src/bench/txreconciliation.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "3f59bf83a41b7787f9c43c277b5e62f327a72c3e",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In \"add bench for ShouldFanoutTo\" 3f59bf83a41b7787f9c43c277b5e62f327a72c3e: `net.h` include seems unnecessary.",
      "created_at": "2024-05-16T13:02:43Z",
      "updated_at": "2024-05-16T13:02:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603304486",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603304486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 7,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603383480",
      "pull_request_review_id": 2060823307,
      "id": 1603383480,
      "node_id": "PRRC_kwDOABII585fkbC4",
      "diff_hunk": "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "path": "src/node/txreconciliation.h",
      "position": 88,
      "original_position": 12,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "in_reply_to_id": 1602301949,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think this refers to the steps listed at the beginning of the file. Not all of them are covered yet. This PR leaves this right before 2 AFAICT",
      "created_at": "2024-05-16T13:44:15Z",
      "updated_at": "2024-05-16T14:57:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603383480",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603383480"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 127,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603525767",
      "pull_request_review_id": 2060823307,
      "id": 1603525767,
      "node_id": "PRRC_kwDOABII585fk9yH",
      "diff_hunk": "@@ -115,10 +138,55 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (peer_state->m_local_set.size() >= MAX_SET_SIZE) return false;\n+\n+        // The caller currently keeps track of the per-peer transaction announcements, so it\n+        // should not attempt to add same tx to the set twice. However, if that happens, we will\n+        // simply ignore it.\n+        if (peer_state->m_local_set.insert(wtxid).second) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                        \"Now the set contains %i transactions.\\n\",\n+                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+        }\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const Wtxid& wtxid_to_remove) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "in_reply_to_id": 1602304001,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Updated to track both successful and unsuccessful deletions (in debug log, to prevent unnecessarily spamming the logs)",
      "created_at": "2024-05-16T14:51:59Z",
      "updated_at": "2024-05-16T15:04:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603525767",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603525767"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 180,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603536079",
      "pull_request_review_id": 2060823307,
      "id": 1603536079,
      "node_id": "PRRC_kwDOABII585flATP",
      "diff_hunk": "@@ -0,0 +1,40 @@\n+// Copyright (c) 2020-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <net.h>",
      "path": "src/bench/txreconciliation.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "3f59bf83a41b7787f9c43c277b5e62f327a72c3e",
      "in_reply_to_id": 1603304486,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Removed",
      "created_at": "2024-05-16T14:57:37Z",
      "updated_at": "2024-05-16T14:57:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603536079",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603536079"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 7,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603548036",
      "pull_request_review_id": 2061100687,
      "id": 1603548036,
      "node_id": "PRRC_kwDOABII585flDOE",
      "diff_hunk": "@@ -74,6 +74,20 @@ class TxReconciliationTracker\n     ReconciliationRegisterResult RegisterPeer(NodeId peer_id, bool is_peer_inbound,\n                                               uint32_t peer_recon_version, uint64_t remote_salt);\n \n+    /**\n+     * Step 1. Add a new transaction we want to announce to the peer to the local reconciliation set\n+     * of the peer, so that it will be reconciled later, unless the set limit is reached.\n+     * Returns whether the transaction appears in the set.\n+     */\n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid);\n+\n+    /**\n+     * Before Step 2, we might want to remove a wtxid from the reconciliation set, for example if",
      "path": "src/node/txreconciliation.h",
      "position": 88,
      "original_position": 12,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "7c047d30cb0eadc8a424cb01de2fcd0978e22206",
      "in_reply_to_id": 1602301949,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "My bad, missed that. Thanks.",
      "created_at": "2024-05-16T15:02:42Z",
      "updated_at": "2024-05-16T15:02:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1603548036",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1603548036"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 127,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610144238",
      "pull_request_review_id": 2071518907,
      "id": 1610144238,
      "node_id": "PRRC_kwDOABII585f-Nnu",
      "diff_hunk": "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In \"p2p: Functions to add/remove wtxids to tx reconciliation sets\" 2e29e9beeebcadfc7afc56a28791456d40551bed: I think `MAX_SET_SIZE` could be in `txreconciliation.h` then we can use it in the tests.\r\n\r\n```diff\r\n-/**\r\n- * Maximum number of wtxids stored in a peer local set, bounded to protect the memory use of\r\n- * reconciliation sets and short ids mappings, and CPU used for sketch computation.\r\n- */\r\n-constexpr size_t MAX_SET_SIZE = 3000;\r\n \r\n /**\r\n  * Maximum number of transactions for which we store assigned fanout targets.\r\ndiff --git a/src/node/txreconciliation.h b/src/node/txreconciliation.h\r\nindex c2cdf9875f..648b6369c0 100644\r\n--- a/src/node/txreconciliation.h\r\n+++ b/src/node/txreconciliation.h\r\n@@ -14,6 +14,12 @@\r\n /** Supported transaction reconciliation protocol version */\r\n static constexpr uint32_t TXRECONCILIATION_VERSION{1};\r\n \r\n+/**\r\n+ * Maximum number of wtxids stored in a peer local set, bounded to protect the memory use of\r\n+ * reconciliation sets and short ids mappings, and CPU used for sketch computation.\r\n+ */\r\n+constexpr size_t MAX_SET_SIZE = 3000;\r\n+\r\n enum class ReconciliationRegisterResult {\r\n     NOT_FOUND,\r\n     SUCCESS,\r\ndiff --git a/src/test/txreconciliation_tests.cpp b/src/test/txreconciliation_tests.cpp\r\nindex a0071e4388..8befe0d36e 100644\r\n--- a/src/test/txreconciliation_tests.cpp\r\n+++ b/src/test/txreconciliation_tests.cpp\r\n@@ -115,7 +115,7 @@ BOOST_AUTO_TEST_CASE(AddToSetTest)\r\n     BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\r\n     BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\r\n \r\n-    for (size_t i = 0; i < 3000; ++i)\r\n+    for (size_t i = 0; i < MAX_SET_SIZE; ++i)\r\n         BOOST_REQUIRE(tracker.AddToSet(peer_id1, Wtxid::FromUint256(frc.rand256())));\r\n     BOOST_REQUIRE(!tracker.AddToSet(peer_id1, Wtxid::FromUint256(frc.rand256())));\r\n```",
      "created_at": "2024-05-22T14:51:48Z",
      "updated_at": "2024-05-22T14:51:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610144238",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610144238"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610159034",
      "pull_request_review_id": 2071544864,
      "id": 1610159034,
      "node_id": "PRRC_kwDOABII585f-RO6",
      "diff_hunk": "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "in_reply_to_id": 1610144238,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've been talking to @sipa about this recently and I think the limit may not be necessary if the approach for when to compute the reconciliation sets is changed. I'm may get rid of it, but if not, I'll take this",
      "created_at": "2024-05-22T14:59:17Z",
      "updated_at": "2024-05-22T14:59:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1610159034",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1610159034"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1620894922",
      "pull_request_review_id": 2088540718,
      "id": 1620894922,
      "node_id": "PRRC_kwDOABII585gnOTK",
      "diff_hunk": "@@ -81,4 +81,60 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid));\n+\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    BOOST_REQUIRE(!tracker.AddToSet(peer_id0, wtxid2));\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    for (size_t i = 0; i < 3000; ++i)",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": null,
      "original_position": 30,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e29e9beeebcadfc7afc56a28791456d40551bed",
      "in_reply_to_id": 1610144238,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Ended up taking this, since the limit will be kept in the end.\r\n\r\nThanks!",
      "created_at": "2024-05-30T15:05:35Z",
      "updated_at": "2024-05-30T15:05:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1620894922",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1620894922"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634736227",
      "pull_request_review_id": 2110226626,
      "id": 1634736227,
      "node_id": "PRRC_kwDOABII585hcBhj",
      "diff_hunk": "@@ -390,7 +425,13 @@ TxReconciliationTracker::~TxReconciliationTracker() = default;\n \n uint64_t TxReconciliationTracker::PreRegisterPeer(NodeId peer_id)\n {\n-    return m_impl->PreRegisterPeer(peer_id);\n+    const uint64_t local_salt{GetRand(UINT64_MAX)};\n+    return m_impl->PreRegisterPeer(peer_id, local_salt);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 85,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "f71575cf4321443219ffede00ad598600f558994",
      "in_reply_to_id": null,
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "What is the intention behind moving salt calculation out of PreRegisterPeer ? Now if PreRegisterPeer is not executed due to lock being held we are doing meaningless computation .",
      "created_at": "2024-06-11T11:58:34Z",
      "updated_at": "2024-06-11T12:09:44Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1634736227",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1634736227"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": 393,
      "start_side": "LEFT",
      "line": null,
      "original_line": 496,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635224220",
      "pull_request_review_id": 2111021554,
      "id": 1635224220,
      "node_id": "PRRC_kwDOABII585hd4qc",
      "diff_hunk": "@@ -390,7 +425,13 @@ TxReconciliationTracker::~TxReconciliationTracker() = default;\n \n uint64_t TxReconciliationTracker::PreRegisterPeer(NodeId peer_id)\n {\n-    return m_impl->PreRegisterPeer(peer_id);\n+    const uint64_t local_salt{GetRand(UINT64_MAX)};\n+    return m_impl->PreRegisterPeer(peer_id, local_salt);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 85,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "f71575cf4321443219ffede00ad598600f558994",
      "in_reply_to_id": 1634736227,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The purpose is for `PreRegisterPeer` to be callable with a fixed salt (via `PreRegisterPeerWithSalt`), so collisions can be tested. This is just moving it out of the `PImpl`, the effects on the external caller should be the same",
      "created_at": "2024-06-11T17:09:10Z",
      "updated_at": "2024-06-11T17:09:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1635224220",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1635224220"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": 393,
      "start_side": "LEFT",
      "line": null,
      "original_line": 496,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638809793",
      "pull_request_review_id": 2116801594,
      "id": 1638809793,
      "node_id": "PRRC_kwDOABII585hrkDB",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": null,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This is pending. Happy get get feedback on how many to pick (either hardcoded or based on what)",
      "created_at": "2024-06-13T20:02:50Z",
      "updated_at": "2024-06-13T20:02:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1638809793",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1638809793"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1641905080",
      "pull_request_review_id": 2121497666,
      "id": 1641905080,
      "node_id": "PRRC_kwDOABII585h3Xu4",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The number of parents per peer should mostly be in the range of (0-2/3) , This should include a significant numbers of peers to reconcile with . A constant number might not be ideal considering if the array returned is smaller than that constant number , we might be reconciling with non-existent peers .",
      "created_at": "2024-06-16T15:26:10Z",
      "updated_at": "2024-06-16T15:26:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1641905080",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1641905080"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644607912",
      "pull_request_review_id": 2125758247,
      "id": 1644607912,
      "node_id": "PRRC_kwDOABII585iBrmo",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm curious to know where do you get that parent count range from  ",
      "created_at": "2024-06-18T14:53:39Z",
      "updated_at": "2024-06-18T14:53:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1644607912",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1644607912"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646641952",
      "pull_request_review_id": 2128966341,
      "id": 1646641952,
      "node_id": "PRRC_kwDOABII585iJcMg",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I got some data for about 4100+ transactions from a source (cant be sure of the credibility) for bitcoin transactions in a mempool and i ran a script to count the avg. parents which came to approx. 1.6 . Another way I thought of this is I got the avg. number of [inputs per transaction](https://transactionfee.info/charts/inputs-per-transaction/) . For 2023-2024 the average is somewhat between 2-3 . If we make a tree like dependency structure for transaction considering the transactions which had their inputs as utxo's , the probability of having higher ancestories diminishes rapidly since any  transaction missing will eliminate the ancestory above it . Considering the mempool are in general highly updated , ancestories beyond grandparent transactions are not very likely to be there . So if I consider this , there are supposed to be 6 ancestors for a transactions on an average and we can expect 2-3 range to have a significant number of transactions.    ",
      "created_at": "2024-06-19T19:57:20Z",
      "updated_at": "2024-06-19T19:57:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1646641952",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1646641952"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647708122",
      "pull_request_review_id": 2130655678,
      "id": 1647708122,
      "node_id": "PRRC_kwDOABII585iNgfa",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Notice this does not apply to all transactions though. The exception here applies to transactions that have some ancestors **in the mempool**. In that case, we need to be consistent with the way we share this set of transactions, otherwise, it could be the case that the parents are reconciled at time T and the children are fanout at T-n, potentially making the children orphan.\r\n\r\nUnder these conditions, we are checking how many peers have the ancestors in their reconciliation sets, and selecting a subset of the ones with fewer of them, so the amount of transactions to be fanout is the smallest possible.",
      "created_at": "2024-06-20T14:46:06Z",
      "updated_at": "2024-06-20T14:46:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1647708122",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647708122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1667753973",
      "pull_request_review_id": 2161914223,
      "id": 1667753973,
      "node_id": "PRRC_kwDOABII585jZ-f1",
      "diff_hunk": "@@ -81,4 +87,193 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    // If the peer is not registered, adding to the set fails\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    auto r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // As long as the peer is registered, adding a new wtxid to the set should work\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // If the peer is dropped, adding wtxids to its set should fail\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    r = tracker.AddToSet(peer_id0, wtxid2);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    // As long as the peer is registered and the transaction is not in the set, and there is no short id\n+    // collision, adding should work\n+    for (size_t i = 0; i < MAX_RECONSET_SIZE; ++i) {\n+        wtxid = Wtxid::FromUint256(frc.rand256());\n+        Wtxid collision;\n+        uint32_t short_id;\n+\n+        if (!tracker.HasCollision(peer_id1, wtxid, collision, short_id)) {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(r.m_succeeded);\n+            BOOST_REQUIRE(!r.m_conflict.has_value());\n+        } else {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(!r.m_succeeded);\n+            BOOST_REQUIRE_EQUAL(r.m_conflict.value(), collision);\n+        }\n+    }\n+\n+    // Trying to add the same item twice will just bypass\n+    r = tracker.AddToSet(peer_id1, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(AddToSetCollisionTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // Register the peer with a predefined salt so we can force the collision\n+    tracker.PreRegisterPeerWithSalt(peer_id0, 2);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    // Precompute collision\n+    Wtxid wtxid{Wtxid::FromUint256(uint256S(\"c70d778bccef36a81aed8da0b819d2bd28bd8653e56a5d40903df1a0ade0b876\"))};\n+    Wtxid collision{Wtxid::FromUint256(uint256S(\"ae52a6ecb8733fba1f7af6022a8b9dd327d7825054229fafcad7e03c38ae2a50\"))};\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    auto r = tracker.AddToSet(peer_id0, collision);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE_EQUAL(r.m_conflict.value(), wtxid);\n+}\n+\n+BOOST_AUTO_TEST_CASE(TryRemovingFromSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    BOOST_REQUIRE(tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    tracker.ForgetPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+}\n+\n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                            /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    // Initialize a new instance with a new hasher to be used later on.\n+    CSipHasher hasher2(0x0706050403020100ULL, 0x4F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker2(TXRECONCILIATION_VERSION, hasher2);\n+    int inbound_peers = 36;\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        tracker2.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+        BOOST_REQUIRE_EQUAL(tracker2.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    }\n+\n+    // Relay to a fraction of registered inbound peers.\n+    // For 35 peers we will choose 3.5 flooding targets, which means that it's either 3 or 4 with\n+    // 50% chance. Make sure the randomness actually works by checking against a different hasher.\n+    size_t total_fanouted1 = 0;\n+    size_t total_fanouted2 = 0;\n+    auto wtxid = Wtxid::FromUint256(uint256(1)); // determinism is required.\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        total_fanouted1 += tracker.ShouldFanoutTo(wtxid, i,\n+                                                  /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+        total_fanouted2 += tracker2.ShouldFanoutTo(wtxid, i,\n+                                                   /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+    }\n+    BOOST_CHECK_EQUAL(total_fanouted1, 3);\n+    BOOST_CHECK_EQUAL(total_fanouted2, 4);\n+",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": 299,
      "original_position": 216,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e0b6742b82e60ea685afd25f2d19b8b558678ce",
      "in_reply_to_id": null,
      "user": {
        "login": "Prabhat1308",
        "id": 94048855,
        "node_id": "U_kgDOBZsSVw",
        "avatar_url": "https://avatars.githubusercontent.com/u/94048855?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Prabhat1308",
        "html_url": "https://github.com/Prabhat1308",
        "followers_url": "https://api.github.com/users/Prabhat1308/followers",
        "following_url": "https://api.github.com/users/Prabhat1308/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Prabhat1308/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Prabhat1308/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Prabhat1308/subscriptions",
        "organizations_url": "https://api.github.com/users/Prabhat1308/orgs",
        "repos_url": "https://api.github.com/users/Prabhat1308/repos",
        "events_url": "https://api.github.com/users/Prabhat1308/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Prabhat1308/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\nfor (int i = 1; i < inbound_peers; ++i) {\r\n        // create 4000 random wtxids so that FANOUT_TARGETS_PER_TX_CACHE_SIZE is breached\r\n        for (int j = 0; j < 4000; ++j) {\r\n            tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), i,\r\n                                   /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\r\n        }\r\n    }\r\n```\r\n\r\nincreases coverage of the units tests to check the cache_size check in ```IsFanoutTarget``` . ",
      "created_at": "2024-07-07T19:52:13Z",
      "updated_at": "2024-07-07T19:52:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1667753973",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1667753973"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 350,
      "original_line": 350,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1759454074",
      "pull_request_review_id": 2304056408,
      "id": 1759454074,
      "node_id": "PRRC_kwDOABII585o3yN6",
      "diff_hunk": "@@ -81,4 +87,193 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    // If the peer is not registered, adding to the set fails\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    auto r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // As long as the peer is registered, adding a new wtxid to the set should work\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // If the peer is dropped, adding wtxids to its set should fail\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    r = tracker.AddToSet(peer_id0, wtxid2);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    // As long as the peer is registered and the transaction is not in the set, and there is no short id\n+    // collision, adding should work\n+    for (size_t i = 0; i < MAX_RECONSET_SIZE; ++i) {\n+        wtxid = Wtxid::FromUint256(frc.rand256());\n+        Wtxid collision;\n+        uint32_t short_id;\n+\n+        if (!tracker.HasCollision(peer_id1, wtxid, collision, short_id)) {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(r.m_succeeded);\n+            BOOST_REQUIRE(!r.m_conflict.has_value());\n+        } else {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(!r.m_succeeded);\n+            BOOST_REQUIRE_EQUAL(r.m_conflict.value(), collision);\n+        }\n+    }\n+\n+    // Trying to add the same item twice will just bypass\n+    r = tracker.AddToSet(peer_id1, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(AddToSetCollisionTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // Register the peer with a predefined salt so we can force the collision\n+    tracker.PreRegisterPeerWithSalt(peer_id0, 2);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    // Precompute collision\n+    Wtxid wtxid{Wtxid::FromUint256(uint256S(\"c70d778bccef36a81aed8da0b819d2bd28bd8653e56a5d40903df1a0ade0b876\"))};\n+    Wtxid collision{Wtxid::FromUint256(uint256S(\"ae52a6ecb8733fba1f7af6022a8b9dd327d7825054229fafcad7e03c38ae2a50\"))};\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    auto r = tracker.AddToSet(peer_id0, collision);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE_EQUAL(r.m_conflict.value(), wtxid);\n+}\n+\n+BOOST_AUTO_TEST_CASE(TryRemovingFromSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    BOOST_REQUIRE(tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    tracker.ForgetPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+}\n+\n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                            /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    // Initialize a new instance with a new hasher to be used later on.\n+    CSipHasher hasher2(0x0706050403020100ULL, 0x4F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker2(TXRECONCILIATION_VERSION, hasher2);\n+    int inbound_peers = 36;\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        tracker2.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+        BOOST_REQUIRE_EQUAL(tracker2.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    }\n+\n+    // Relay to a fraction of registered inbound peers.\n+    // For 35 peers we will choose 3.5 flooding targets, which means that it's either 3 or 4 with\n+    // 50% chance. Make sure the randomness actually works by checking against a different hasher.\n+    size_t total_fanouted1 = 0;\n+    size_t total_fanouted2 = 0;\n+    auto wtxid = Wtxid::FromUint256(uint256(1)); // determinism is required.\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        total_fanouted1 += tracker.ShouldFanoutTo(wtxid, i,\n+                                                  /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+        total_fanouted2 += tracker2.ShouldFanoutTo(wtxid, i,\n+                                                   /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+    }\n+    BOOST_CHECK_EQUAL(total_fanouted1, 3);\n+    BOOST_CHECK_EQUAL(total_fanouted2, 4);\n+",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": 299,
      "original_position": 216,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e0b6742b82e60ea685afd25f2d19b8b558678ce",
      "in_reply_to_id": 1667753973,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I haven't taken this yet, given I'm working on a last commit reworking part of how the fanout selection works. I may consider it after that. In any case, looks like this is only filling the cache but not testing anything after it",
      "created_at": "2024-09-13T20:22:15Z",
      "updated_at": "2024-09-13T20:22:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1759454074",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1759454074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 350,
      "original_line": 350,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769550928",
      "pull_request_review_id": 2319731127,
      "id": 1769550928,
      "node_id": "PRRC_kwDOABII585peTRQ",
      "diff_hunk": "@@ -2374,10 +2419,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (peer_can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n+        }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant\n+            // set. Otherwise it could be the case that the children were fanout before the parent\n+            // got reconciled.\n+            Assume(peer->m_wtxid_relay);\n+            const auto result = m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid));\n+            if (!result.m_succeeded) {\n+                // If the transactions fails to get into the set, we fanout\n+                invs_to_send.push_back(wtxid);\n+                // If the transaction fails because it collides with an existing one,\n+                // we also remove and fanout the conflict and all its descendants.\n+                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 134,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "3879f550d3c513c83ab34df7bc390e33c89e7e72",
      "in_reply_to_id": null,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```suggestion\r\n                // This is because our peer may have added the conflicting transaction\r\n```",
      "created_at": "2024-09-21T12:47:14Z",
      "updated_at": "2024-09-21T12:47:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1769550928",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769550928"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2453,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1775342441",
      "pull_request_review_id": 2328451689,
      "id": 1775342441,
      "node_id": "PRRC_kwDOABII585p0ZNp",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "brunoerg",
        "id": 19480819,
        "node_id": "MDQ6VXNlcjE5NDgwODE5",
        "avatar_url": "https://avatars.githubusercontent.com/u/19480819?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/brunoerg",
        "html_url": "https://github.com/brunoerg",
        "followers_url": "https://api.github.com/users/brunoerg/followers",
        "following_url": "https://api.github.com/users/brunoerg/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/brunoerg/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/brunoerg/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/brunoerg/subscriptions",
        "organizations_url": "https://api.github.com/users/brunoerg/orgs",
        "repos_url": "https://api.github.com/users/brunoerg/repos",
        "events_url": "https://api.github.com/users/brunoerg/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/brunoerg/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Shouldn't we decrease the number of `inbounds_fanout_tx_relay`/`outbounds_fanout_tx_relay` by the number of peers we're going to fanout with ancestors?",
      "created_at": "2024-09-25T14:28:26Z",
      "updated_at": "2024-09-25T14:29:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1775342441",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1775342441"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1776775938",
      "pull_request_review_id": 2330757791,
      "id": 1776775938,
      "node_id": "PRRC_kwDOABII585p53MC",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "We could. I left it as for simplicity, given this case should not be too frequent, so having a higher fanout under these conditions shouldn't be too bad. \r\n\r\nI'll consider adding it if it does not make the code much harder to read, or if there is a clear counterargument in favor of it.",
      "created_at": "2024-09-26T10:11:57Z",
      "updated_at": "2024-09-26T10:11:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1776775938",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1776775938"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1797721753",
      "pull_request_review_id": 2363929991,
      "id": 1797721753,
      "node_id": "PRRC_kwDOABII585rJw6Z",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": null,
      "user": {
        "login": "marcofleon",
        "id": 95179662,
        "node_id": "U_kgDOBaxTjg",
        "avatar_url": "https://avatars.githubusercontent.com/u/95179662?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/marcofleon",
        "html_url": "https://github.com/marcofleon",
        "followers_url": "https://api.github.com/users/marcofleon/followers",
        "following_url": "https://api.github.com/users/marcofleon/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/marcofleon/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/marcofleon/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/marcofleon/subscriptions",
        "organizations_url": "https://api.github.com/users/marcofleon/orgs",
        "repos_url": "https://api.github.com/users/marcofleon/repos",
        "events_url": "https://api.github.com/users/marcofleon/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/marcofleon/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can `outbounds_fanout_tx_relay` ever be greater than 1 here? I think if we have two (or more) unregistered outbound peers and at least one registered peer, then this results in an unsigned integer overflow. Which then overflows `targets_size` in `IsFanoutTarget`.",
      "created_at": "2024-10-12T15:46:04Z",
      "updated_at": "2024-10-12T16:19:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1797721753",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1797721753"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812987095",
      "pull_request_review_id": 2389107187,
      "id": 1812987095,
      "node_id": "PRRC_kwDOABII585sD_zX",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "working on a test and fix for this.",
      "created_at": "2024-10-23T15:03:12Z",
      "updated_at": "2024-10-23T15:03:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1812987095",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812987095"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813071345",
      "pull_request_review_id": 2389257068,
      "id": 1813071345,
      "node_id": "PRRC_kwDOABII585sEUXx",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Oh sorry, I forgot to reply to this. We discussed this in person last week and this is indeed an issue. Happy to take your fix @naumenkogs",
      "created_at": "2024-10-23T15:44:23Z",
      "updated_at": "2024-10-23T15:44:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1813071345",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813071345"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1814685980",
      "pull_request_review_id": 2391985630,
      "id": 1814685980,
      "node_id": "PRRC_kwDOABII585sKekc",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Okay,  see the last two commits [here](https://github.com/naumenkogs/bitcoin/commits/2024-10-30116-fix-underflow/).\r\n\r\nI also dropped the `<0.001` check, it's kinda pointless anyway...",
      "created_at": "2024-10-24T10:06:07Z",
      "updated_at": "2024-10-24T10:06:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1814685980",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1814685980"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818548647",
      "pull_request_review_id": 2398229655,
      "id": 1818548647,
      "node_id": "PRRC_kwDOABII585sZNmn",
      "diff_hunk": "@@ -197,15 +195,52 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool HasCollisionInternal(TxReconciliationState *peer_state, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        AssertLockHeld(m_txreconciliation_mutex);\n+\n+        short_id = peer_state->ComputeShortID(wtxid);\n+        const auto iter = peer_state->m_short_id_mapping.find(short_id);\n+\n+        if (iter != peer_state->m_short_id_mapping.end()) {\n+            collision = iter->second;\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    bool HasCollision(NodeId peer_id, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5\r\nNot sure it's worth exposing this external method if the only reason to have it is testing.",
      "created_at": "2024-10-28T08:16:31Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818548647",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818548647"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818553463",
      "pull_request_review_id": 2398229655,
      "id": 1818553463,
      "node_id": "PRRC_kwDOABII585sZOx3",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5\r\n\r\nworth adding a comment on what would happen if there are 3 colliding transactions (probably fine but some text would be helpful) :)",
      "created_at": "2024-10-28T08:20:30Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818553463",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818553463"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6276,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818555798",
      "pull_request_review_id": 2398229655,
      "id": 1818555798,
      "node_id": "PRRC_kwDOABII585sZPWW",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);\n+                                        vInv.emplace_back(MSG_WTX, wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5\r\nwhat would happen if a descendant was already flooded?",
      "created_at": "2024-10-28T08:22:22Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818555798",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818555798"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6286,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818568903",
      "pull_request_review_id": 2398229655,
      "id": 1818568903,
      "node_id": "PRRC_kwDOABII585sZSjH",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5\r\ncould *this* be used to game collisions (for *wtxid* you have here)?",
      "created_at": "2024-10-28T08:32:21Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818568903",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818568903"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6285,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818570491",
      "pull_request_review_id": 2398229655,
      "id": 1818570491,
      "node_id": "PRRC_kwDOABII585sZS77",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818568903,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "say a descendant was never considered for reconciliation (somehow), but now is used to removefromset some other transaction (it collides with)\r\n\r\nor maybe it was considered, but then was dropped in favor of something else (that's not how we currently handle collisions, but that would be a hard assumption)",
      "created_at": "2024-10-28T08:33:42Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818570491",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818570491"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6285,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818575030",
      "pull_request_review_id": 2398229655,
      "id": 1818575030,
      "node_id": "PRRC_kwDOABII585sZUC2",
      "diff_hunk": "@@ -523,7 +523,7 @@ class PeerManagerImpl final : public PeerManager\n     PeerManagerInfo GetInfo() const override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     void SendPings() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     std::pair<size_t, size_t> GetFanoutPeersCount() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n-    void RelayTransaction(const uint256& txid, const uint256& wtxid) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    void RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);",
      "path": "src/net_processing.cpp",
      "position": 15,
      "original_position": 5,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\nwhy do you think force relay should influence whether we reconcile or flood? The transaction is relayed in either case (the original meaning of force relay)",
      "created_at": "2024-10-28T08:37:21Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818575030",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818575030"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 509,
      "original_line": 509,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818577080",
      "pull_request_review_id": 2398229655,
      "id": 1818577080,
      "node_id": "PRRC_kwDOABII585sZUi4",
      "diff_hunk": "@@ -2370,8 +2370,8 @@ std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount()\n     if (m_txreconciliation) {\n         LOCK(m_peer_mutex);\n         for(const auto& [peer_id, peer] : m_peer_map) {\n-            if (auto tx_relay = peer->GetTxRelay()) {\n-                bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+            if (const auto tx_relay = peer->GetTxRelay()) {",
      "path": "src/net_processing.cpp",
      "position": 51,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\n these kind of refactors we better apply where the code was introduced, in the older commits of this PR",
      "created_at": "2024-10-28T08:38:59Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818577080",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818577080"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2129,
      "original_line": 2129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818583090",
      "pull_request_review_id": 2398229655,
      "id": 1818583090,
      "node_id": "PRRC_kwDOABII585sZWAy",
      "diff_hunk": "@@ -139,6 +139,12 @@ class TxReconciliationTracker\n      */\n     bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n                         size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay);\n+\n+    /**\n+     * Returns a collections of node ids sorted by how many parents the peer has in its reconciliation set",
      "path": "src/node/txreconciliation.h",
      "position": null,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\nyou can technically feed it arbitrary transactions. I think the comment should say it, and then later say \"we normally pass a list of parents to determine whether [... ... ...]\".",
      "created_at": "2024-10-28T08:43:20Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818583090",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818583090"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 158,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818584774",
      "pull_request_review_id": 2398229655,
      "id": 1818584774,
      "node_id": "PRRC_kwDOABII585sZWbG",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\nwhy not modifying the former commit that introduces this code?",
      "created_at": "2024-10-28T08:44:41Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818584774",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818584774"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818598067",
      "pull_request_review_id": 2398229655,
      "id": 1818598067,
      "node_id": "PRRC_kwDOABII585sZZqz",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\nwhat about the order of the parents here? Deserves a comment at least. With the current non-cluster mempool it might break something?\r\n\r\nUPD:\r\n\r\nSay the following happens:\r\nA -> B - > C\r\n\r\n- A arrives, we add it to some sets.\r\n- B arrives, triggers a flood from half the sets, but the other half has A+B now.\r\n- C arrives, triggers a flood from A+B. But then, can we guarantee A is flooded before B?\r\n\r\nUPD2: topo sort should work. Have a common place where the INV vector is handled?",
      "created_at": "2024-10-28T08:54:18Z",
      "updated_at": "2024-11-04T09:52:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818598067",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818598067"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818641775",
      "pull_request_review_id": 2398229655,
      "id": 1818641775,
      "node_id": "PRRC_kwDOABII585sZkVv",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "392facfce1be6d0395abecc2e049ff39635bd1a5\r\n\r\nwhere do you do this (consider in-mempool descendants and decide to fanout everything)? I only see you do it for the collision",
      "created_at": "2024-10-28T09:11:44Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818641775",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818641775"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2202,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818670032",
      "pull_request_review_id": 2398229655,
      "id": 1818670032,
      "node_id": "PRRC_kwDOABII585sZrPQ",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "20772c077832592265bd6a2876aa6b4cb7dbde7d\r\n\r\nwith this code, and especially the 5/2 trickle delay (very long), previous performance measurements become outdated.\r\n\r\nMy idea was to [delay the responses](https://github.com/bitcoin/bitcoin/pull/21515/commits/f99fa469115856aefa9799b3fc62ba09985933ad). And by this time, the hope was flooding does enough job so that scanning the sets through many connections does not work.\r\n\r\nAlso, adding to a set already happens on a trickle... so that's another level of protection",
      "created_at": "2024-10-28T09:19:43Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818670032",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818670032"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818702420",
      "pull_request_review_id": 2398229655,
      "id": 1818702420,
      "node_id": "PRRC_kwDOABII585sZzJU",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 47,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "d2f260507279b1edd6c0f55d02c7ae2e598b3585",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "d2f260507279b1edd6c0f55d02c7ae2e598b3585\r\nnit: `Assume(m_states.emplace(peer_id, std::move(new_state)).second);`",
      "created_at": "2024-10-28T09:28:52Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818702420",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818702420"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818703437",
      "pull_request_review_id": 2398229655,
      "id": 1818703437,
      "node_id": "PRRC_kwDOABII585sZzZN",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:\n+        // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+        // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+        // We don't care about a laggy peer (1) because we probably can't help them even if we fanout transactions.\n+        // However, exploiting (2) should not prevent us from relaying certain transactions.\n+        //\n+        // Transactions which don't make it to the set due to the limit are announced via fan-out.\n+        if (peer_state->m_local_set.size() >= MAX_RECONSET_SIZE) return false;\n+\n+        // The caller currently keeps track of the per-peer transaction announcements, so it\n+        // should not attempt to add same tx to the set twice. However, if that happens, we will\n+        // simply ignore it.\n+        if (peer_state->m_local_set.insert(wtxid).second) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \" /* Continued */\n+                                                                        \"Now the set contains %i transactions.\\n\",\n+                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+        }\n+        return true;\n+    }\n+\n+    bool TryRemovingFromSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        auto removed = peer_state->m_local_set.erase(wtxid) > 0;\n+        if (removed) {\n+            LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Removed %s from the reconciliation set for peer=%d. \" /* Continued */",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 92,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "d2f260507279b1edd6c0f55d02c7ae2e598b3585",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "https://github.com/bitcoin/bitcoin/commit/d2f260507279b1edd6c0f55d02c7ae2e598b3585\r\n\r\nnit: in three places in this commit `/* Continued */` should be dropped, it's no longer necessary (been a linter thing)",
      "created_at": "2024-10-28T09:29:36Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818703437",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818703437"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 325,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818706047",
      "pull_request_review_id": 2398229655,
      "id": 1818706047,
      "node_id": "PRRC_kwDOABII585sZ0B_",
      "diff_hunk": "@@ -6184,6 +6194,27 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n+\n+                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+                    const bool reconciles_txs = m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId());\n+                    if (reconciles_txs) {\n+                        for (const auto& [cur_peer_id, cur_peer] : m_peer_map) {\n+                            // Skip the source of the transaction.\n+                            if (cur_peer_id == pto->GetId()) continue;\n+                            if (auto peer_tx_relay = cur_peer->GetTxRelay()) {\n+                                LOCK(peer_tx_relay->m_bloom_filter_mutex);\n+                                // When we consider to which (and how many) Erlay peers\n+                                // we should fanout a tx, we must know to how\n+                                // many peers we would certainly announce this tx\n+                                // (non-Erlay peers).\n+                                if (peer_tx_relay->m_relay_txs && !m_txreconciliation->IsPeerRegistered(cur_peer_id)) {\n+                                    inbounds_fanout_tx_relay += cur_peer->m_is_inbound;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 65,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "873e8dd60b93f740330e9b0fbae4b3200204653a",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "873e8dd60b93f740330e9b0fbae4b3200204653a\r\n\r\nnit: cur_peer->m_is_inbound ? ++inbounds_fanout_tx_relay : ++outbounds_fanout_tx_relay",
      "created_at": "2024-10-28T09:31:16Z",
      "updated_at": "2024-10-28T09:31:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818706047",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1818706047"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6211,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1819654430",
      "pull_request_review_id": 2400051633,
      "id": 1819654430,
      "node_id": "PRRC_kwDOABII585sdbke",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The commit with the casting works, but the test one is actually not a good way of testing this; it would pass both with and without the change.\r\n\r\nTurns out that passing a huge value to `IsFanoutTarget` would result in `targets_size` being `0`, which results in the method returning `false`. I don't think there is really a good way of testing this.\r\n\r\nI'll take the code commit but skip the addition to the test.",
      "created_at": "2024-10-28T19:42:46Z",
      "updated_at": "2024-10-28T19:42:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1819654430",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1819654430"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1819663339",
      "pull_request_review_id": 2400066625,
      "id": 1819663339,
      "node_id": "PRRC_kwDOABII585sddvr",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I squashed the change in here: ad95b2c0e21f1e865f967aa9463ef99bc252550a",
      "created_at": "2024-10-28T19:48:08Z",
      "updated_at": "2024-10-28T19:48:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1819663339",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1819663339"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820474026",
      "pull_request_review_id": 2401341173,
      "id": 1820474026,
      "node_id": "PRRC_kwDOABII585sgjqq",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Interesting. So, for me, the first commit (with a new test) takes forever to execute.\r\n\r\nMore specifically, the execution hangs on `best_peers.resize(targets_size);`, with `targets_size` being a huge number.\r\n\r\nI guess your system handles this gracefully instead?\r\n\r\nA clear failure could be triggered by e.g. `Assume(targets_size <= m_states.size());`",
      "created_at": "2024-10-29T09:57:31Z",
      "updated_at": "2024-10-29T09:57:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820474026",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820474026"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820487554",
      "pull_request_review_id": 2401362483,
      "id": 1820487554,
      "node_id": "PRRC_kwDOABII585sgm-C",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};",
      "path": "src/node/txreconciliation.cpp",
      "position": 330,
      "original_position": 36,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "4234f5ebe133b949080aaa56da8cbdd18b650ff2\r\n\r\nOriginally, the code forced me to make this call for every peer, that's why i needed it to be deterministic. It's not the case anymore. Do we still need determinism then?",
      "created_at": "2024-10-29T10:06:19Z",
      "updated_at": "2024-10-29T10:06:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820487554",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820487554"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 379,
      "original_line": 379,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820490053",
      "pull_request_review_id": 2401366605,
      "id": 1820490053,
      "node_id": "PRRC_kwDOABII585sgnlF",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};",
      "path": "src/node/txreconciliation.cpp",
      "position": 330,
      "original_position": 36,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820487554,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Otherwise we can drop `m_deterministic_randomizer` altogether and use some cheap `FastRandomContext` instead.",
      "created_at": "2024-10-29T10:08:05Z",
      "updated_at": "2024-10-29T10:08:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820490053",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820490053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 379,
      "original_line": 379,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820518288",
      "pull_request_review_id": 2401412734,
      "id": 1820518288,
      "node_id": "PRRC_kwDOABII585sgueQ",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "There is no need to cast it to double anymore. \r\n\r\nWhat we should do is something like\r\n```\r\n        size_t outbounds_target_size = 0;\r\n        if (OUTBOUND_FANOUT_DESTINATIONS > outbounds_fanout_tx_relay) outbounds_target_size = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\r\n```\r\n\r\nPerhaps there is a less ugly way to do this. But casting to double seems worse.",
      "created_at": "2024-10-29T10:17:24Z",
      "updated_at": "2024-10-29T10:17:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820518288",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820518288"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 374,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820521627",
      "pull_request_review_id": 2401417792,
      "id": 1820521627,
      "node_id": "PRRC_kwDOABII585sgvSb",
      "diff_hunk": "@@ -142,15 +378,166 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    // Not const because of caching.\n+    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        // First, try checking if the result is already cached, and return it if so\n+        if (const auto &it = m_tx_fanout_targets_cache_data.find(wtxid); it != m_tx_fanout_targets_cache_data.end()) {\n+            return std::binary_search(it->second.begin(), it->second.end(), peer_id);\n+        }\n+\n+        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n+        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n+        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n+        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n+        deterministic_randomizer.Write(wtxid.ToUint256());\n+\n+        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n+        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n+        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n+        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n+        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n+        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n+        best_peers.reserve(m_states.size());\n+\n+        for (const auto& [node_id, op_peer_state]: m_states) {\n+            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n+            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n+                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n+                best_peers.emplace_back(hash_key, node_id);\n+            }\n+        }\n+\n+        // Sort by the assigned key.\n+        std::sort(best_peers.begin(), best_peers.end());\n+        best_peers.resize(targets_size);\n+\n+        std::vector<NodeId> new_fanout_candidates;\n+        new_fanout_candidates.reserve(targets_size);\n+        for_each(best_peers.begin(), best_peers.end(),\n+                [&new_fanout_candidates](auto& keyed_peer) { new_fanout_candidates.push_back(keyed_peer.second); });\n+\n+        // Sort by NodeId.\n+        std::sort(new_fanout_candidates.begin(), new_fanout_candidates.end());\n+        const bool found = std::binary_search(new_fanout_candidates.begin(), new_fanout_candidates.end(), peer_id);\n+\n+        // If the cache is full, make room for the new entry.\n+        if (m_tx_fanout_targets_cache_order.size() == FANOUT_TARGETS_PER_TX_CACHE_SIZE) {\n+            const auto expired_tx = m_tx_fanout_targets_cache_order.front();\n+            m_tx_fanout_targets_cache_data.erase(expired_tx);\n+            m_tx_fanout_targets_cache_order.pop_front();\n+        }\n+        m_tx_fanout_targets_cache_data.emplace(wtxid, std::move(new_fanout_candidates));\n+        m_tx_fanout_targets_cache_order.push_back(wtxid);\n+\n+        return found;\n+    }\n+\n+    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n+                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return true;\n+        // We decide whether a particular peer is a low-fanout flood target differently\n+        // based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations;\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        //\n+        // We first decide how many reconciling peers of a given direction we want to flood to,\n+        // and then generate a list of peers of that size for a given transaction. We then see\n+        // whether the given peer falls into this list.\n+        double n;\n+        if (peer_state->m_we_initiate) {\n+            n = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 409,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1797721753,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "feel free to resolve this and let's talk in the new commit.",
      "created_at": "2024-10-29T10:19:35Z",
      "updated_at": "2024-10-29T10:19:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820521627",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820521627"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 457,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820533885",
      "pull_request_review_id": 2401436632,
      "id": 1820533885,
      "node_id": "PRRC_kwDOABII585sgyR9",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The following test would break the code if we forget the double cast (discussion [here](https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820474026)). I suggest adding it to the tests.\r\n\r\n```\r\n        std::tie(in_fanout_targets, out_fanout_targets) = tracker.GetFanoutTargets(Wtxid::FromUint256(frc.rand256()), /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/100);\r\n        BOOST_CHECK(!tracker.ShouldFanoutTo(peer_id0, in_fanout_targets, out_fanout_targets));\r\n\r\n```",
      "created_at": "2024-10-29T10:27:47Z",
      "updated_at": "2024-10-29T10:27:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820533885",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820533885"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 374,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820538647",
      "pull_request_review_id": 2401443934,
      "id": 1820538647,
      "node_id": "PRRC_kwDOABII585sgzcX",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820518288,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "(technically the code you have is correct, it's just confusing for no reason i think)",
      "created_at": "2024-10-29T10:30:45Z",
      "updated_at": "2024-10-29T10:30:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820538647",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820538647"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 374,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820542894",
      "pull_request_review_id": 2401450441,
      "id": 1820542894,
      "node_id": "PRRC_kwDOABII585sg0eu",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();\n+                    sorted_outbounds.emplace_back(hash_key, node_id);\n+                } else {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_in).Write(node_id).Finalize();\n+                    sorted_inbounds.emplace_back(hash_key, node_id);\n+                }\n+\n             }\n         }\n \n-        std::sort(best_peers.begin(), best_peers.end());\n-\n-        auto it = best_peers.begin();\n-        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+        // Sort the peers based on their assigned random value, extract the node_ids and trim the collections to size\n+        std::vector<NodeId> in_fanout_targets;\n+        if (inbounds_target_size >= 1) {\n+            std::sort(sorted_inbounds.begin(), sorted_inbounds.end());\n+            for_each(sorted_inbounds.begin(), sorted_inbounds.end(),\n+                    [&in_fanout_targets](auto& keyed_peer) { in_fanout_targets.push_back(keyed_peer.second); });\n+            in_fanout_targets.resize(inbounds_target_size);\n         }\n-        return false;\n+        std::vector<NodeId> out_fanout_targets;\n+        if (outbounds_target_size >= 1) {\n+            std::sort(sorted_outbounds.begin(), sorted_outbounds.end());\n+            for_each(sorted_outbounds.begin(), sorted_outbounds.end(),\n+                    [&out_fanout_targets](auto& keyed_peer) { out_fanout_targets.push_back(keyed_peer.second); });\n+            out_fanout_targets.resize(outbounds_target_size);\n+        }\n+\n+        return std::make_tuple(in_fanout_targets, out_fanout_targets);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 83,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "4234f5ebe133b949080aaa56da8cbdd18b650ff2\r\n\r\nWe can just merge the two vectors, no? There is no use for this separation.",
      "created_at": "2024-10-29T10:33:33Z",
      "updated_at": "2024-10-29T10:33:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1820542894",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1820542894"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821427081",
      "pull_request_review_id": 2402910776,
      "id": 1821427081,
      "node_id": "PRRC_kwDOABII585skMWJ",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};",
      "path": "src/node/txreconciliation.cpp",
      "position": 330,
      "original_position": 36,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820487554,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Well, this really depends. `GetFanoutTargets` is called by `RelayTransaction`, which, in turn, may be called by `ProcessMessage` for a peer that has `NetPermissionFlags::ForceRelay`. So if force relay is used for both fanout and set reconciliation, as suggested in https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1818575030, then this could be called twice leading to two different sorting if we don't do so deterministically",
      "created_at": "2024-10-29T19:34:17Z",
      "updated_at": "2024-10-29T19:34:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1821427081",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821427081"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 379,
      "original_line": 379,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821431430",
      "pull_request_review_id": 2402917895,
      "id": 1821431430,
      "node_id": "PRRC_kwDOABII585skNaG",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();\n+                    sorted_outbounds.emplace_back(hash_key, node_id);\n+                } else {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_in).Write(node_id).Finalize();\n+                    sorted_inbounds.emplace_back(hash_key, node_id);\n+                }\n+\n             }\n         }\n \n-        std::sort(best_peers.begin(), best_peers.end());\n-\n-        auto it = best_peers.begin();\n-        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+        // Sort the peers based on their assigned random value, extract the node_ids and trim the collections to size\n+        std::vector<NodeId> in_fanout_targets;\n+        if (inbounds_target_size >= 1) {\n+            std::sort(sorted_inbounds.begin(), sorted_inbounds.end());\n+            for_each(sorted_inbounds.begin(), sorted_inbounds.end(),\n+                    [&in_fanout_targets](auto& keyed_peer) { in_fanout_targets.push_back(keyed_peer.second); });\n+            in_fanout_targets.resize(inbounds_target_size);\n         }\n-        return false;\n+        std::vector<NodeId> out_fanout_targets;\n+        if (outbounds_target_size >= 1) {\n+            std::sort(sorted_outbounds.begin(), sorted_outbounds.end());\n+            for_each(sorted_outbounds.begin(), sorted_outbounds.end(),\n+                    [&out_fanout_targets](auto& keyed_peer) { out_fanout_targets.push_back(keyed_peer.second); });\n+            out_fanout_targets.resize(outbounds_target_size);\n+        }\n+\n+        return std::make_tuple(in_fanout_targets, out_fanout_targets);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 83,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820542894,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yeah, you're right. Given how small the two vectors are, calling `ShouldFanoutTo` with a merged vector should not incur any major overhead, so merging will make it easier to read",
      "created_at": "2024-10-29T19:38:19Z",
      "updated_at": "2024-10-29T19:38:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1821431430",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821431430"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821533301",
      "pull_request_review_id": 2403082616,
      "id": 1821533301,
      "node_id": "PRRC_kwDOABII585skmR1",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 28,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820533885,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've added it to the initial commit and reworked it on the last one",
      "created_at": "2024-10-29T21:06:47Z",
      "updated_at": "2024-10-29T21:06:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1821533301",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1821533301"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 374,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822182678",
      "pull_request_review_id": 2404101797,
      "id": 1822182678,
      "node_id": "PRRC_kwDOABII585snE0W",
      "diff_hunk": "@@ -363,79 +363,75 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::tuple<std::vector<NodeId>, std::vector<NodeId>> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n \n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        auto outbounds_target_size = (double)OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+\n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};",
      "path": "src/node/txreconciliation.cpp",
      "position": 330,
      "original_position": 36,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "4234f5ebe133b949080aaa56da8cbdd18b650ff2",
      "in_reply_to_id": 1820487554,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This could be `ReattemptInitialBroadcast`, `BroadcastTransaction` (rpc/wallet), `ProcessValidTx`, or earlier upon handling `NetMsgType::TX`.\r\n\r\n~~I think it's odd we have two calls to `RelayTransaction` in the two latter cases. I'd rather change this code, e.g.  pass `already_relayed` (duplicating force) to `RelayTransaction`. Perhaps too much for this PR and we should do it elsewhere (especially now that the package stuff happens in-between). I understand why it was ok when `RelayTransaction` was simple.~~\r\n\r\n~~And while we're stuck with these two calls~~, let's say we drop the determinism.\r\n\r\nWhy `RelayTransaction` doesn't look at `m_tx_inventory_to_send` very early (and maybe `m_tx_inventory_known_filter` too)? That would catch the transactions we already set for flooding, and just pass on them.\r\n\r\nNow, the transactions in the sets. If we add them to the set again, nothing is done. If we try to flood them by a different choice, nothing is done still because we hit `m_tx_inventory_to_send` already having it.\r\n \r\nThus, for now, i think we should repeat the `m_tx_inventory_to_send` check above, rather than having the determinism. It kinda makes sense anyway, no?",
      "created_at": "2024-10-30T09:15:53Z",
      "updated_at": "2024-10-30T09:52:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1822182678",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822182678"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 379,
      "original_line": 379,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822431933",
      "pull_request_review_id": 2404538684,
      "id": 1822431933,
      "node_id": "PRRC_kwDOABII585soBq9",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1818670032,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Just talked to Bruno a bit more about this.\r\n\r\nI think it's fair to compare this delayed set mechanism to what i have in the code there.\r\nI like my solution more because:\r\n- its synced across peers (handles better spying across multiple conns i think?)\r\n- simpler code\r\n- more flexibility (doesn't have to be same trickling as adding to sets or fanouting)\r\n\r\nInterested in what other people think though.\r\n\r\n",
      "created_at": "2024-10-30T11:35:09Z",
      "updated_at": "2024-10-30T11:35:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1822431933",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822431933"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822834821",
      "pull_request_review_id": 2405261931,
      "id": 1822834821,
      "node_id": "PRRC_kwDOABII585spkCF",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1818670032,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think the current approach mimics what you were doing with your old one. I haven't picked up the trickle reduction commit not the delayed response, but I was planning to in the next PR.\r\n\r\nYour approach used to add transactions to the reconciliation set during INV building, which happens on trickle intervals. So data was added to `to_be_announced` (delayed) on `RelayTransaction` and then made available on trickle. The current approach adds data to the delayed set on `RelayTransaction` and makes it available on trickle too.\r\n\r\nSo I don't think the previous performance measurements become outdated, building the whole Erlay PR on this should yield similar results. ",
      "created_at": "2024-10-30T15:07:46Z",
      "updated_at": "2024-10-30T15:07:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1822834821",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1822834821"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823207236",
      "pull_request_review_id": 2405970195,
      "id": 1823207236,
      "node_id": "PRRC_kwDOABII585sq-9E",
      "diff_hunk": "@@ -2370,8 +2370,8 @@ std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount()\n     if (m_txreconciliation) {\n         LOCK(m_peer_mutex);\n         for(const auto& [peer_id, peer] : m_peer_map) {\n-            if (auto tx_relay = peer->GetTxRelay()) {\n-                bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+            if (const auto tx_relay = peer->GetTxRelay()) {",
      "path": "src/net_processing.cpp",
      "position": 51,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818577080,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "You're right, should have been added to the previous commit. Will fix",
      "created_at": "2024-10-30T18:45:43Z",
      "updated_at": "2024-10-30T18:45:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1823207236",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823207236"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2129,
      "original_line": 2129,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823223107",
      "pull_request_review_id": 2406001681,
      "id": 1823223107,
      "node_id": "PRRC_kwDOABII585srC1D",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818553463,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Being this part of `RelayTransaction`, which processed transactions one at a time, and given that if a collision happens the existing transaction is removed from the set, there cannot be a three-way collision. If a third transaction that happens to have the same short id as the two previous ones is added to the set later, it would be added normally since there won't be a transaction to collide with.\r\n\r\nI could add a comment for three, but someone may then mention what happens if there are four  ",
      "created_at": "2024-10-30T18:58:41Z",
      "updated_at": "2024-10-30T18:58:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1823223107",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823223107"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6276,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823263917",
      "pull_request_review_id": 2406089347,
      "id": 1823263917,
      "node_id": "PRRC_kwDOABII585srMyt",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818584774,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Do you mean squashing these changes instead of having a \"move\" commit?",
      "created_at": "2024-10-30T19:31:39Z",
      "updated_at": "2024-10-30T19:31:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1823263917",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1823263917"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824060041",
      "pull_request_review_id": 2407335911,
      "id": 1824060041,
      "node_id": "PRRC_kwDOABII585suPKJ",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818553463,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I was looking for something like \"As a general rule, we keep the transaction that appeared first\".\r\n\r\nCurrently, the `AddToSet` documentation seems outdatedit basically claims that the only way to fail is to reach a set limit.\r\n\r\nHow about the following replacement:\r\n\r\n```\r\n    /**\r\n     * Step 1. Add a to-be-announced transaction to the local reconciliation set of the target peer.\r\n     * Returns false if the set is at capacity, or if the set contains a colliding transaction.\r\n     * Returns true if the transaction appears in the set (whether it was already there or just was added).\r\n     */\r\n```",
      "created_at": "2024-10-31T08:22:33Z",
      "updated_at": "2024-10-31T08:22:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824060041",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824060041"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6276,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824208275",
      "pull_request_review_id": 2407562196,
      "id": 1824208275,
      "node_id": "PRRC_kwDOABII585suzWT",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1818670032,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I agree now, it's equivalent. Still wrapping my head around `RelayTransaction` refactoring :)\r\n\r\n---------------------------\r\n\r\nA difference could be in handling dependencies: during the trickle window after the first transaction arrives.\r\n\r\nSay, a parent arrives, and then a child arrives in a second. In my approach we may notice the child when handling (announcement-wise) the parent (because handling the parent is postponed via trickle).\r\nIn your approach, you handle the parent independently.\r\n\r\nIs there any use of knowing about the child while handling (announcement-wise) the parent? I don't think so. You probably could save some efforts of adding the parent to reconset, and then removing it, but that should be cheap anyway.\r\n\r\n-------------------------\r\n\r\n(the child-before-parent case is entirely different, as the child-to-arrive-early doesn't normally hit the announcement step while in orphanage)\r\n\r\n",
      "created_at": "2024-10-31T10:14:01Z",
      "updated_at": "2024-10-31T10:14:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824208275",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824208275"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824212857",
      "pull_request_review_id": 2407569080,
      "id": 1824212857,
      "node_id": "PRRC_kwDOABII585su0d5",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818598067,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "another question: say a child arrives a few minutes after a parent (parent still in the mempool, but it's been announced to peers a while ago). Why bother with this inv? Perhaps we should do it only if `TryRemovingFromSet` actually have removed it?\r\n\r\n(same applies to handling a collision below)\r\n\r\ni know `m_tx_inventory_known_filter` will probably catch it, but i think it's better to do it here.",
      "created_at": "2024-10-31T10:17:55Z",
      "updated_at": "2024-10-31T10:18:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824212857",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824212857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824219529",
      "pull_request_review_id": 2407578851,
      "id": 1824219529,
      "node_id": "PRRC_kwDOABII585su2GJ",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818553463,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Apparently I was wrong.\r\n\r\n```\r\n                // If the transaction fails because it collides with an existing one,\r\n                // we also remove and fanout the conflict and all its descendants.\r\n                // This is because our peer may have added the conflicting transaction\r\n                // to its set, in which reconciliation of these two would fail\r\n```\r\n\r\nSay A, B, C arrive.\r\n- First A added to the set.\r\n- then B doesn't make it to the set, but also drops A from it.\r\n- then C takes a place in the set.",
      "created_at": "2024-10-31T10:23:21Z",
      "updated_at": "2024-10-31T10:23:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824219529",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824219529"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6276,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824221603",
      "pull_request_review_id": 2407581905,
      "id": 1824221603,
      "node_id": "PRRC_kwDOABII585su2mj",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818584774,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "yes",
      "created_at": "2024-10-31T10:25:06Z",
      "updated_at": "2024-10-31T10:25:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824221603",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824221603"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824285323",
      "pull_request_review_id": 2407676322,
      "id": 1824285323,
      "node_id": "PRRC_kwDOABII585svGKL",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Nit\r\n\r\n```\r\n        const size_t removed = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);\r\n        // Data must be in one of the sets at most\r\n        Assume(removed <= 1);\r\n        return removed == 1;\r\n```",
      "created_at": "2024-10-31T11:17:52Z",
      "updated_at": "2024-10-31T11:17:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1824285323",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1824285323"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825645357",
      "pull_request_review_id": 2409798591,
      "id": 1825645357,
      "node_id": "PRRC_kwDOABII585s0SMt",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "fd7c35a22669d440afe182a153bed28fd326b51f\r\n\r\nOften, there will be no parents (e.g., a parent is in the mempool but has already been flooded/reconciled). In that case, it would be nice to give a random order. And then comment it please.\r\n\r\n(currently it's ordered by `m_states` i think).",
      "created_at": "2024-11-01T09:49:21Z",
      "updated_at": "2024-11-01T09:50:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825645357",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825645357"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825649181",
      "pull_request_review_id": 2409804609,
      "id": 1825649181,
      "node_id": "PRRC_kwDOABII585s0TId",
      "diff_hunk": "@@ -2332,12 +2330,53 @@ void PeerManagerImpl::SendPings()\n     for(auto& it : m_peer_map) it.second->m_ping_queued = true;\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount() {\n+\n+    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;\n+\n+    if (m_txreconciliation) {\n+        LOCK(m_peer_mutex);\n+        for(const auto& [peer_id, peer] : m_peer_map) {\n+            if (const auto tx_relay = peer->GetTxRelay()) {\n+                const bool peer_relays_txs = WITH_LOCK(tx_relay->m_bloom_filter_mutex, return tx_relay->m_relay_txs);\n+                if (peer_relays_txs && !m_txreconciliation->IsPeerRegistered(peer_id)) {\n+                    inbounds_fanout_tx_relay += peer->m_is_inbound;\n+                    outbounds_fanout_tx_relay += !peer->m_is_inbound;\n+                }\n+            }\n+        }\n+    }\n+\n+    return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+}\n+\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool peer_can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (peer_can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 202,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "9de4233d000be79b0d0ec934a634ed6b55433b3e",
      "in_reply_to_id": 1638809793,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This function could easily return two numbers: how many of these peers are inbound and outbound. And then just pass this pair along to `ShouldFanoutTo`. Should be not that complex code. A cheap cost to preserve the efficiency model.\r\n\r\nI might try if you don't get to it earlier.",
      "created_at": "2024-11-01T09:54:10Z",
      "updated_at": "2024-11-01T09:54:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825649181",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825649181"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2160,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825659145",
      "pull_request_review_id": 2409819446,
      "id": 1825659145,
      "node_id": "PRRC_kwDOABII585s0VkJ",
      "diff_hunk": "@@ -2155,10 +2176,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant\n+            // set. Otherwise it could be the case that the children were fanout before the parent\n+            // got reconciled.\n+            Assume(peer->m_wtxid_relay);\n+            const auto result = m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid));\n+            if (!result.m_succeeded) {\n+                // If the transactions fails to get into the set, we fanout\n+                invs_to_send.push_back(wtxid);\n+                // If the transaction fails because it collides with an existing one,\n+                // we also remove and fanout the conflict and all its descendants.\n+                // This is because our peer may have added the conflicting transaction\n+                // to its set, in which reconciliation of these two would fail\n+                if (const auto collision = result.m_conflict; collision.has_value()) {\n+                    CTxMemPool::setEntries descendants;\n+                    WITH_LOCK(m_mempool.cs, m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants));",
      "path": "src/net_processing.cpp",
      "position": 142,
      "original_position": 109,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Why having a collision means we should fanout the children? They may get reconciled in their own time.",
      "created_at": "2024-11-01T10:06:23Z",
      "updated_at": "2024-11-01T10:06:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825659145",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825659145"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2217,
      "original_line": 2217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825760358",
      "pull_request_review_id": 2409973125,
      "id": 1825760358,
      "node_id": "PRRC_kwDOABII585s0uRm",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1818670032,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Found another relevant thing! ([here](https://gist.github.com/naumenkogs/514ff3901960161a7b7ee08449840768)) \r\n\r\n```\r\n09:42:53<@gmaxwell> Existing relay logic checks that transactions are still in the mempool before relaying them. I think the issue there would go away if instead of keeping around some erlay datastructure you just keep growing the queue of the peers transactions to relay until its time to reconcile, enh?  then the existing logic to check if things are still in the mempool is sufficient.\r\n```\r\n\r\n\"Existing\" refers to the legacy code in my branch.",
      "created_at": "2024-11-01T12:22:31Z",
      "updated_at": "2024-11-01T12:24:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825760358",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825760358"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825876761",
      "pull_request_review_id": 2410166282,
      "id": 1825876761,
      "node_id": "PRRC_kwDOABII585s1KsZ",
      "diff_hunk": "@@ -2155,10 +2176,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant\n+            // set. Otherwise it could be the case that the children were fanout before the parent\n+            // got reconciled.\n+            Assume(peer->m_wtxid_relay);\n+            const auto result = m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid));\n+            if (!result.m_succeeded) {\n+                // If the transactions fails to get into the set, we fanout\n+                invs_to_send.push_back(wtxid);\n+                // If the transaction fails because it collides with an existing one,\n+                // we also remove and fanout the conflict and all its descendants.\n+                // This is because our peer may have added the conflicting transaction\n+                // to its set, in which reconciliation of these two would fail\n+                if (const auto collision = result.m_conflict; collision.has_value()) {\n+                    CTxMemPool::setEntries descendants;\n+                    WITH_LOCK(m_mempool.cs, m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants));",
      "path": "src/net_processing.cpp",
      "position": 142,
      "original_position": 109,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825659145,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Because if you remove the parent from the reconciliation set but not the children, it could be the case that you reconcile with that peer before fanning out the parent, and all those children will be orphan",
      "created_at": "2024-11-01T14:20:31Z",
      "updated_at": "2024-11-01T14:20:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825876761",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825876761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2217,
      "original_line": 2217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825888636",
      "pull_request_review_id": 2410185606,
      "id": 1825888636,
      "node_id": "PRRC_kwDOABII585s1Nl8",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818584774,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Because it is doing more than just moving the code around, so I thought it may be easier for reviewers already familiar with the original approach to understand the changes. I wouldn't mind squashing it once all the discussion around `RelayTranaction` is resolved",
      "created_at": "2024-11-01T14:30:47Z",
      "updated_at": "2024-11-01T14:30:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825888636",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825888636"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825893170",
      "pull_request_review_id": 2410193100,
      "id": 1825893170,
      "node_id": "PRRC_kwDOABII585s1Osy",
      "diff_hunk": "@@ -197,15 +195,52 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool HasCollisionInternal(TxReconciliationState *peer_state, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        AssertLockHeld(m_txreconciliation_mutex);\n+\n+        short_id = peer_state->ComputeShortID(wtxid);\n+        const auto iter = peer_state->m_short_id_mapping.find(short_id);\n+\n+        if (iter != peer_state->m_short_id_mapping.end()) {\n+            collision = iter->second;\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    bool HasCollision(NodeId peer_id, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818548647,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Happy to consider an alternative approach that allows us to check there are no collisions without having to expose a public method if you have something in mind",
      "created_at": "2024-11-01T14:34:45Z",
      "updated_at": "2024-11-01T14:34:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825893170",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825893170"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825913918",
      "pull_request_review_id": 2410227806,
      "id": 1825913918,
      "node_id": "PRRC_kwDOABII585s1Tw-",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 95,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818641775,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I don't think this comment is accurate since this can never be the case. A transaction considered for relay cannot have in-mempool descendants by definition, since they would have been orphans at the time of considering them.\r\n\r\nI cannot recall if this is a re-word of the previous approach, which tried to consider descendants, or I tried to refer to the collisions and it didn't make much sense. \r\n\r\nI'll remove the comment",
      "created_at": "2024-11-01T14:52:19Z",
      "updated_at": "2024-11-01T14:53:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825913918",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825913918"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2202,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825939865",
      "pull_request_review_id": 2410269874,
      "id": 1825939865,
      "node_id": "PRRC_kwDOABII585s1aGZ",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);\n+                                        vInv.emplace_back(MSG_WTX, wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818555798,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "That's a good point. It may be the case that the selected peer has a parent -> child dependency but was not picked as one of the `fanout_with_ancestors` peers, the parent and the child may have ended up in different sets.\r\n\r\nWe should check the return of `TryRemovingFromSet` before adding it to `vInv` ",
      "created_at": "2024-11-01T15:14:16Z",
      "updated_at": "2024-11-01T15:14:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825939865",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825939865"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6286,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825957496",
      "pull_request_review_id": 2410301259,
      "id": 1825957496,
      "node_id": "PRRC_kwDOABII585s1eZ4",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818568903,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Collisions of this kind *could* happen in theory, but I don't think they can be really gamed:\r\n\r\nshort ids are peer specific, they are generated using `SipHashUint256` which are salted using `m_k0` and  `m_k1`. Therefore, while a collision of this kind is theoretically possible, an adversarial peer should not be able to exploit them",
      "created_at": "2024-11-01T15:28:31Z",
      "updated_at": "2024-11-01T20:14:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1825957496",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1825957496"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6285,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826245538",
      "pull_request_review_id": 2410801267,
      "id": 1826245538,
      "node_id": "PRRC_kwDOABII585s2kui",
      "diff_hunk": "@@ -81,4 +87,193 @@ BOOST_AUTO_TEST_CASE(IsPeerRegisteredTest)\n     BOOST_CHECK(!tracker.IsPeerRegistered(peer_id0));\n }\n \n+BOOST_AUTO_TEST_CASE(AddToSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    // If the peer is not registered, adding to the set fails\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    auto r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // As long as the peer is registered, adding a new wtxid to the set should work\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    r = tracker.AddToSet(peer_id0, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    // If the peer is dropped, adding wtxids to its set should fail\n+    tracker.ForgetPeer(peer_id0);\n+    Wtxid wtxid2{Wtxid::FromUint256(frc.rand256())};\n+    r = tracker.AddToSet(peer_id0, wtxid2);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+\n+    NodeId peer_id1 = 1;\n+    tracker.PreRegisterPeer(peer_id1);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id1, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id1));\n+\n+    // As long as the peer is registered and the transaction is not in the set, and there is no short id\n+    // collision, adding should work\n+    for (size_t i = 0; i < MAX_RECONSET_SIZE; ++i) {\n+        wtxid = Wtxid::FromUint256(frc.rand256());\n+        Wtxid collision;\n+        uint32_t short_id;\n+\n+        if (!tracker.HasCollision(peer_id1, wtxid, collision, short_id)) {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(r.m_succeeded);\n+            BOOST_REQUIRE(!r.m_conflict.has_value());\n+        } else {\n+            r = tracker.AddToSet(peer_id1, wtxid);\n+            BOOST_REQUIRE(!r.m_succeeded);\n+            BOOST_REQUIRE_EQUAL(r.m_conflict.value(), collision);\n+        }\n+    }\n+\n+    // Trying to add the same item twice will just bypass\n+    r = tracker.AddToSet(peer_id1, wtxid);\n+    BOOST_REQUIRE(r.m_succeeded);\n+    BOOST_REQUIRE(!r.m_conflict.has_value());\n+}\n+\n+BOOST_AUTO_TEST_CASE(AddToSetCollisionTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // Register the peer with a predefined salt so we can force the collision\n+    tracker.PreRegisterPeerWithSalt(peer_id0, 2);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    // Precompute collision\n+    Wtxid wtxid{Wtxid::FromUint256(uint256S(\"c70d778bccef36a81aed8da0b819d2bd28bd8653e56a5d40903df1a0ade0b876\"))};\n+    Wtxid collision{Wtxid::FromUint256(uint256S(\"ae52a6ecb8733fba1f7af6022a8b9dd327d7825054229fafcad7e03c38ae2a50\"))};\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    auto r = tracker.AddToSet(peer_id0, collision);\n+    BOOST_REQUIRE(!r.m_succeeded);\n+    BOOST_REQUIRE_EQUAL(r.m_conflict.value(), wtxid);\n+}\n+\n+BOOST_AUTO_TEST_CASE(TryRemovingFromSetTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    Wtxid wtxid{Wtxid::FromUint256(frc.rand256())};\n+\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    BOOST_CHECK(tracker.IsPeerRegistered(peer_id0));\n+\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    BOOST_REQUIRE(tracker.TryRemovingFromSet(peer_id0, wtxid));\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+\n+    BOOST_REQUIRE(tracker.AddToSet(peer_id0, wtxid).m_succeeded);\n+    tracker.ForgetPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.TryRemovingFromSet(peer_id0, wtxid));\n+}\n+\n+BOOST_AUTO_TEST_CASE(ShouldFanoutToTest)\n+{\n+    CSipHasher hasher(0x0706050403020100ULL, 0x0F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker(TXRECONCILIATION_VERSION, hasher);\n+    NodeId peer_id0 = 0;\n+    FastRandomContext frc{/*fDeterministic=*/true};\n+\n+    // If peer is not registered for reconciliation, it should be always chosen for flooding.\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    tracker.PreRegisterPeer(peer_id0);\n+    BOOST_REQUIRE(!tracker.IsPeerRegistered(peer_id0));\n+    // Same after pre-registering.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Once the peer is registered, it should be selected for flooding of some transactions.\n+    // Since there is only one reconciling peer, it will be selected for all transactions.\n+    BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(peer_id0, /*is_peer_inbound=*/false, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Don't select a fanout target if it was already fanouted sufficiently.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(!tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                            /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/1));\n+    }\n+\n+    tracker.ForgetPeer(peer_id0);\n+    // A forgotten (reconciliation-wise) peer should be always selected for fanout again.\n+    for (int i = 0; i < 100; ++i) {\n+        BOOST_CHECK(tracker.ShouldFanoutTo(Wtxid::FromUint256(frc.rand256()), peer_id0,\n+                                           /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0));\n+    }\n+\n+    // Now for inbound connections.\n+    // Initialize a new instance with a new hasher to be used later on.\n+    CSipHasher hasher2(0x0706050403020100ULL, 0x4F0E0D0C0B0A0908ULL);\n+    TxReconciliationTracker tracker2(TXRECONCILIATION_VERSION, hasher2);\n+    int inbound_peers = 36;\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        tracker.PreRegisterPeer(i);\n+        tracker2.PreRegisterPeer(i);\n+        BOOST_REQUIRE_EQUAL(tracker.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+        BOOST_REQUIRE_EQUAL(tracker2.RegisterPeer(i, /*is_peer_inbound=*/true, 1, 1), ReconciliationRegisterResult::SUCCESS);\n+    }\n+\n+    // Relay to a fraction of registered inbound peers.\n+    // For 35 peers we will choose 3.5 flooding targets, which means that it's either 3 or 4 with\n+    // 50% chance. Make sure the randomness actually works by checking against a different hasher.\n+    size_t total_fanouted1 = 0;\n+    size_t total_fanouted2 = 0;\n+    auto wtxid = Wtxid::FromUint256(uint256(1)); // determinism is required.\n+    for (int i = 1; i < inbound_peers; ++i) {\n+        total_fanouted1 += tracker.ShouldFanoutTo(wtxid, i,\n+                                                  /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+        total_fanouted2 += tracker2.ShouldFanoutTo(wtxid, i,\n+                                                   /*inbounds_fanout_tx_relay=*/0, /*outbounds_fanout_tx_relay=*/0);\n+    }\n+    BOOST_CHECK_EQUAL(total_fanouted1, 3);\n+    BOOST_CHECK_EQUAL(total_fanouted2, 4);\n+",
      "path": "src/test/txreconciliation_tests.cpp",
      "position": 299,
      "original_position": 216,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "2e0b6742b82e60ea685afd25f2d19b8b558678ce",
      "in_reply_to_id": 1667753973,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Resolving since we don't have a cache anymore",
      "created_at": "2024-11-01T20:00:29Z",
      "updated_at": "2024-11-01T20:00:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1826245538",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826245538"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 350,
      "original_line": 350,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826249448",
      "pull_request_review_id": 2410807726,
      "id": 1826249448,
      "node_id": "PRRC_kwDOABII585s2lro",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818553463,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Agreed the docs for `TxReconciliationTracker::AddToSet` could be improved. I'll update it with a version of your suggestion",
      "created_at": "2024-11-01T20:05:22Z",
      "updated_at": "2024-11-01T20:05:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1826249448",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826249448"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6276,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826266792",
      "pull_request_review_id": 2410835421,
      "id": 1826266792,
      "node_id": "PRRC_kwDOABII585s2p6o",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": 1824285323,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Not too sure about the `return removed == 1`\r\n\r\nThe assume is there to make sure that if the code happens to be wrong, it is catched on testing. In the current approach, if the code moving data from `delayed_set` to `m_local_set` was broken somehow, this method will return that data was actually removed. If were to return `removed == 1` in the aforementioned case, it would return false, and the caller's logic may break.\r\n\r\nI don't think any of these cases is likely to happen given the assume will catch it before getting merged, but the proposed change makes me anxious.\r\n\r\nPS: I agree on doing the variable renaming if you feel that makes the code more readable though",
      "created_at": "2024-11-01T20:27:14Z",
      "updated_at": "2024-11-01T20:27:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1826266792",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826266792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826275867",
      "pull_request_review_id": 2410850307,
      "id": 1826275867,
      "node_id": "PRRC_kwDOABII585s2sIb",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);\n+                                        vInv.emplace_back(MSG_WTX, wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818555798,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I just realized this is also the case for the ancestors. When relaying with ancestors, we should also check that the ancestor we are trying to relay is part of the reconciliation set (i.e. that it has not been previously flooded) ",
      "created_at": "2024-11-01T20:39:05Z",
      "updated_at": "2024-11-01T20:39:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1826275867",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826275867"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6286,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826278558",
      "pull_request_review_id": 2410854337,
      "id": 1826278558,
      "node_id": "PRRC_kwDOABII585s2sye",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This is only called if there are in mempol parents though, the ordering doesn't matter much otherwise",
      "created_at": "2024-11-01T20:42:19Z",
      "updated_at": "2024-11-01T20:42:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1826278558",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1826278558"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827403107",
      "pull_request_review_id": 2412519551,
      "id": 1827403107,
      "node_id": "PRRC_kwDOABII585s6_Vj",
      "diff_hunk": "@@ -197,15 +195,52 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool HasCollisionInternal(TxReconciliationState *peer_state, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        AssertLockHeld(m_txreconciliation_mutex);\n+\n+        short_id = peer_state->ComputeShortID(wtxid);\n+        const auto iter = peer_state->m_short_id_mapping.find(short_id);\n+\n+        if (iter != peer_state->m_short_id_mapping.end()) {\n+            collision = iter->second;\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    bool HasCollision(NodeId peer_id, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818548647,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yeah just dropping `HasCollision`, keeping `HasCollisionInternal`. The former is used only in tests. And since its implementation is trivial, i think testing for collisions through `AddToSet` is sufficient.",
      "created_at": "2024-11-04T09:07:07Z",
      "updated_at": "2024-11-04T09:07:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827403107",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827403107"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827404289",
      "pull_request_review_id": 2412521640,
      "id": 1827404289,
      "node_id": "PRRC_kwDOABII585s6_oB",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 23,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818568903,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Right, please resolve this issue.",
      "created_at": "2024-11-04T09:08:10Z",
      "updated_at": "2024-11-04T09:08:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827404289",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827404289"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6285,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827406620",
      "pull_request_review_id": 2412525620,
      "id": 1827406620,
      "node_id": "PRRC_kwDOABII585s7AMc",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818584774,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "My impression was that there are very-very few `reviewers already familiar with the original approach` at the moment, so it's an extra burden for most to understand that former code you drop anyway.\r\nBut yeah it's ok. Perhaps a commit message saying it will be dropped will work.",
      "created_at": "2024-11-04T09:10:09Z",
      "updated_at": "2024-11-04T09:10:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827406620",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827406620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827414092",
      "pull_request_review_id": 2412537999,
      "id": 1827414092,
      "node_id": "PRRC_kwDOABII585s7CBM",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:",
      "path": "src/node/txreconciliation.cpp",
      "position": 211,
      "original_position": 63,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "e942f3a7493908988eea08640d87b2ae420c5eef",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "e942f3a7493908988eea08640d87b2ae420c5eef\r\n\r\nThis entire paragraph currently seems to me more confusing than useful. I suggest dropping it altogether.",
      "created_at": "2024-11-04T09:16:03Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827414092",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827414092"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 261,
      "original_line": 261,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827416829",
      "pull_request_review_id": 2412537999,
      "id": 1827416829,
      "node_id": "PRRC_kwDOABII585s7Cr9",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:",
      "path": "src/node/txreconciliation.cpp",
      "position": 207,
      "original_position": 59,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "e942f3a7493908988eea08640d87b2ae420c5eef",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "e942f3a7493908988eea08640d87b2ae420c5eef\r\n\r\nDuplicates the comment around `MAX_RECONSET_SIZE`. One of them we better dop.",
      "created_at": "2024-11-04T09:18:19Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827416829",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827416829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 257,
      "original_line": 257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827450458",
      "pull_request_review_id": 2412537999,
      "id": 1827450458,
      "node_id": "PRRC_kwDOABII585s7K5a",
      "diff_hunk": "@@ -5815,8 +5815,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "90059530379cf99cf4b82d664ad35c1ddefc3d07",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "90059530379cf99cf4b82d664ad35c1ddefc3d07\r\n\r\n\"Would fail\" is very confusing. \"Failed reconciliation\" will have a technical meaning in the latter commits. Here, i'd rather be more explicit \"two transactions mapped to the same short-id won't be announced between these two peers\".",
      "created_at": "2024-11-04T09:44:13Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827450458",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827450458"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5827,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827451812",
      "pull_request_review_id": 2412537999,
      "id": 1827451812,
      "node_id": "PRRC_kwDOABII585s7LOk",
      "diff_hunk": "@@ -5815,8 +5815,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "90059530379cf99cf4b82d664ad35c1ddefc3d07",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Let's provide a hint why fanouting the descendants (or at least send a reader to where the dependency issue is explained better we should have a one place explaining it)",
      "created_at": "2024-11-04T09:45:18Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827451812",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827451812"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5826,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827454877",
      "pull_request_review_id": 2412537999,
      "id": 1827454877,
      "node_id": "PRRC_kwDOABII585s7L-d",
      "diff_hunk": "@@ -6264,8 +6264,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction\n+                                // to its set, in which reconciliation of these two would fail\n+                                auto collision = result.m_conflict;\n+                                if (collision.has_value()) {\n+                                    Assume(peer->m_wtxid_relay);\n+                                    CTxMemPool::setEntries descendants;\n+                                    m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants);\n+                                    for (const auto &txit: descendants) {\n+                                        auto wtxid = txit->GetTx().GetWitnessHash();\n+                                        m_txreconciliation->TryRemovingFromSet(pto->GetId(), wtxid);\n+                                        vInv.emplace_back(MSG_WTX, wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 24,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818555798,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The fix should be done in ` p2p: Deal with shortid collisions for reconciliation sets `, please move it if you retouch.",
      "created_at": "2024-11-04T09:47:41Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827454877",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827454877"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6286,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827463923",
      "pull_request_review_id": 2412537999,
      "id": 1827463923,
      "node_id": "PRRC_kwDOABII585s7OLz",
      "diff_hunk": "@@ -2155,10 +2176,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant\n+            // set. Otherwise it could be the case that the children were fanout before the parent\n+            // got reconciled.\n+            Assume(peer->m_wtxid_relay);\n+            const auto result = m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid));\n+            if (!result.m_succeeded) {\n+                // If the transactions fails to get into the set, we fanout\n+                invs_to_send.push_back(wtxid);\n+                // If the transaction fails because it collides with an existing one,\n+                // we also remove and fanout the conflict and all its descendants.\n+                // This is because our peer may have added the conflicting transaction\n+                // to its set, in which reconciliation of these two would fail\n+                if (const auto collision = result.m_conflict; collision.has_value()) {\n+                    CTxMemPool::setEntries descendants;\n+                    WITH_LOCK(m_mempool.cs, m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants));",
      "path": "src/net_processing.cpp",
      "position": 142,
      "original_position": 109,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825659145,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Something worth documenting too :) Again, at least one place where we talk about handling dependencies.",
      "created_at": "2024-11-04T09:54:41Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827463923",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827463923"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2217,
      "original_line": 2217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827467881",
      "pull_request_review_id": 2412537999,
      "id": 1827467881,
      "node_id": "PRRC_kwDOABII585s7PJp",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "There could be mempool parents, but none are in reconciliation sets (say, they were already reconciled). For all these cases, it would be nice to not choose the peer sitting first in `m_states`?",
      "created_at": "2024-11-04T09:57:34Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827467881",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827467881"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827477226",
      "pull_request_review_id": 2412537999,
      "id": 1827477226,
      "node_id": "PRRC_kwDOABII585s7Rbq",
      "diff_hunk": "@@ -56,6 +56,13 @@ class TxReconciliationState\n      */\n     uint64_t m_k0, m_k1;\n \n+    /**\n+    * Set of transactions to be added to the reconciliation set on the next trickle. These are still unrequestable for\n+    * privacy reasons (to prevent transaction probing), transactions became available (moved to m_local_set) once they\n+    * would have been announced via fanout.",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 7,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943\r\n\r\nI think \"upon trickle\" or \"see `m_next_inv_send_time`\" is much less confusing.",
      "created_at": "2024-11-04T10:04:57Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827477226",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827477226"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827481810",
      "pull_request_review_id": 2412537999,
      "id": 1827481810,
      "node_id": "PRRC_kwDOABII585s7SjS",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": 1824285323,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I thought `size_t 0` will be cast to `bool false` on return, and just suggested the exact same behavior (1==true, 0==false) but without forcing the reader to think about casting and cause this exact confusion between us.\r\nAm i wrong?\r\n\r\n-------\r\n\r\nAhhh, so you saying `2==true` is also important? Then I'll be fine with explicit `return removed >= 1`, and comment that `2` should not normally happen.",
      "created_at": "2024-11-04T10:08:33Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827481810",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827481810"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827487325",
      "pull_request_review_id": 2412537999,
      "id": 1827487325,
      "node_id": "PRRC_kwDOABII585s7T5d",
      "diff_hunk": "@@ -237,33 +274,57 @@ class TxReconciliationTracker::Impl\n         // However, exploiting (2) should not prevent us from relaying certain transactions.\n         //\n         // Transactions which don't make it to the set due to the limit are announced via fan-out.\n-        if (peer_state->m_local_set.size() >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n+        auto set_size = peer_state->ReconSetSize();\n+        if (set_size >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n \n         // The caller currently keeps track of the per-peer transaction announcements, so it\n         // should not attempt to add same tx to the set twice. However, if that happens, we will\n         // simply ignore it.\n-        if (peer_state->m_local_set.insert(wtxid).second) {\n+        if (peer_state->m_delayed_local_set.insert(wtxid).second) {\n             peer_state->m_short_id_mapping.emplace(short_id, wtxid);\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \"\n                                                                         \"Now the set contains %i transactions.\\n\",\n-                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+                          wtxid.ToString(), peer_id, set_size + 1);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 79,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943\r\nThis is probably the most important log in the entire file, and I think it's better to distinguish two set sizes here (preferably other places the size is logged too).",
      "created_at": "2024-11-04T10:12:40Z",
      "updated_at": "2024-11-04T10:21:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1827487325",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1827487325"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1828421634",
      "pull_request_review_id": 2414170386,
      "id": 1828421634,
      "node_id": "PRRC_kwDOABII585s-4AC",
      "diff_hunk": "@@ -6216,27 +6284,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n                     unsigned int nRelayedTransactions = 0;\n-\n-                    size_t inbounds_fanout_tx_relay = 0, outbounds_fanout_tx_relay = 0;",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 151,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818584774,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'll squash in the next force push",
      "created_at": "2024-11-04T21:36:08Z",
      "updated_at": "2024-11-04T21:36:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1828421634",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1828421634"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6220,
      "side": "LEFT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841026397",
      "pull_request_review_id": 2434198140,
      "id": 1841026397,
      "node_id": "PRRC_kwDOABII585tu9Vd",
      "diff_hunk": "@@ -197,15 +195,52 @@ class TxReconciliationTracker::Impl\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool HasCollisionInternal(TxReconciliationState *peer_state, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    {\n+        AssertLockHeld(m_txreconciliation_mutex);\n+\n+        short_id = peer_state->ComputeShortID(wtxid);\n+        const auto iter = peer_state->m_short_id_mapping.find(short_id);\n+\n+        if (iter != peer_state->m_short_id_mapping.end()) {\n+            collision = iter->second;\n+            return true;\n+        }\n+\n+        return false;\n+    }\n+\n+    bool HasCollision(NodeId peer_id, const Wtxid& wtxid, Wtxid& collision, uint32_t &short_id) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 35,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "50c19dd21f6e437cd8e3d9047a89d793d097c5e5",
      "in_reply_to_id": 1818548647,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Sure, looks like tests can be rewritten for it not to be needed. Will address in the next push",
      "created_at": "2024-11-13T19:12:32Z",
      "updated_at": "2024-11-13T19:12:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841026397",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841026397"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841164936",
      "pull_request_review_id": 2434436843,
      "id": 1841164936,
      "node_id": "PRRC_kwDOABII585tvfKI",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": 1824285323,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "`2==true` would mean that we had the transaction in both places, which should never happen (I'd mean that a transaction is both ready and delayed at the same time).\r\n\r\nIf that were to happen in production for whatever reason, this would return false with the suggested changes, which may break something?",
      "created_at": "2024-11-13T21:10:57Z",
      "updated_at": "2024-11-13T21:10:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841164936",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841164936"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841223757",
      "pull_request_review_id": 2434534203,
      "id": 1841223757,
      "node_id": "PRRC_kwDOABII585tvthN",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "In that case, no transaction would be moved from the reconciliation set to `invs_to_send`, given no transaction would be removed. Therefore, the order wouldn't matter:\r\n\r\n```cpp\r\nauto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\r\nif (it != fanout_with_ancestors.end()) {\r\n    for (const auto wtxid: parents) {\r\n        m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\r\n        invs_to_send.push_back(wtxid);\r\n    }\r\n} else {\r\n    // If the peer is registered for set reconciliation, maybe pick it as fanout\r\n    fanout = m_txreconciliation->ShouldFanoutTo(peer_id, fanout_targets);\r\n}\r\n```\r\n\r\nThis may be a bit counterintuitive. I'll give some though and potentially re-design so it clearer",
      "created_at": "2024-11-13T21:51:49Z",
      "updated_at": "2024-11-13T21:52:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841223757",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841223757"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841243963",
      "pull_request_review_id": 2434566736,
      "id": 1841243963,
      "node_id": "PRRC_kwDOABII585tvyc7",
      "diff_hunk": "@@ -2155,10 +2176,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout) {\n+            // We fanout if force relay is set, if the peer does not reconcile transactions, or if it does but it has been picked for fanout.\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        } else {\n+            // Otherwise, we try to add the transaction to the peer's reconciliation set.\n+            // If the transaction has in mempool descendants, we will fanout all the descendant\n+            // set. Otherwise it could be the case that the children were fanout before the parent\n+            // got reconciled.\n+            Assume(peer->m_wtxid_relay);\n+            const auto result = m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid));\n+            if (!result.m_succeeded) {\n+                // If the transactions fails to get into the set, we fanout\n+                invs_to_send.push_back(wtxid);\n+                // If the transaction fails because it collides with an existing one,\n+                // we also remove and fanout the conflict and all its descendants.\n+                // This is because our peer may have added the conflicting transaction\n+                // to its set, in which reconciliation of these two would fail\n+                if (const auto collision = result.m_conflict; collision.has_value()) {\n+                    CTxMemPool::setEntries descendants;\n+                    WITH_LOCK(m_mempool.cs, m_mempool.CalculateDescendants(m_mempool.get_iter_from_wtxid(collision.value()), descendants));",
      "path": "src/net_processing.cpp",
      "position": 142,
      "original_position": 109,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825659145,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-13T22:01:31Z",
      "updated_at": "2024-11-13T22:01:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841243963",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841243963"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2217,
      "original_line": 2217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841245788",
      "pull_request_review_id": 2434570096,
      "id": 1841245788,
      "node_id": "PRRC_kwDOABII585tvy5c",
      "diff_hunk": "@@ -5815,8 +5815,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.\n+                                // This is because our peer may have added the conflicting tranaction",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 14,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "90059530379cf99cf4b82d664ad35c1ddefc3d07",
      "in_reply_to_id": 1827450458,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-13T22:02:36Z",
      "updated_at": "2024-11-13T22:02:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841245788",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841245788"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5827,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841245945",
      "pull_request_review_id": 2434570332,
      "id": 1841245945,
      "node_id": "PRRC_kwDOABII585tvy75",
      "diff_hunk": "@@ -5815,8 +5815,29 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             }\n                         }\n \n-                        if (fanout || !m_txreconciliation->AddToSet(pto->GetId(), wtxid).m_succeeded) {\n+                        if (fanout) {\n                             vInv.push_back(inv);\n+                        } else {\n+                            // If the transactions fails to get into the set, we fanout\n+                            auto result = m_txreconciliation->AddToSet(pto->GetId(), wtxid);\n+                            if (!result.m_succeeded) {\n+                                vInv.push_back(inv);\n+                                // If the transaction fails because it collides with an existing one,\n+                                // we also remove and fanout the conflict and all its descendants.",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "90059530379cf99cf4b82d664ad35c1ddefc3d07",
      "in_reply_to_id": 1827451812,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-13T22:02:46Z",
      "updated_at": "2024-11-13T22:02:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841245945",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841245945"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 5826,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841676251",
      "pull_request_review_id": 2435218222,
      "id": 1841676251,
      "node_id": "PRRC_kwDOABII585txb_b",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Say there is an in-mempool parent announced earlier, so it's not in any of the sets.\r\n`SortPeersByFewestParents` will return the same order as `m_states` (since all `parent_count` are 0),\r\nand `fanout_with_ancestors` will take first two after resize.\r\n\r\nThen for two peers (specifically, the first two from `m_states`) this code is executed:\r\n```\r\n                for (const auto wtxid: parents) {\r\n                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\r\n                    invs_to_send.push_back(wtxid);\r\n                }\r\n```\r\n\r\n`TryRemovingFromSet` will do nothing. But then `invs_to_send.push_back(wtxid);` is executed anyway. And always for the same two first peers from `m_states`. In other words, the first two are guaranteed to take the fanout in this case.",
      "created_at": "2024-11-14T07:12:27Z",
      "updated_at": "2024-11-14T07:12:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841676251",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841676251"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841679464",
      "pull_request_review_id": 2435223379,
      "id": 1841679464,
      "node_id": "PRRC_kwDOABII585txcxo",
      "diff_hunk": "@@ -2151,10 +2175,32 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 90,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ee46e21a5c913175415a192661b406b328209800",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "ee46e21a5c913175415a192661b406b328209800\r\n\r\nFirst I thought why don't `fanout=true` here and handle it below. We can't do it because txid/wtxid difference (although we could have a `txid_or_wtxid` variable above....). But then, you certainly want to at least set `fanout=false` here, otherwise it remains true and added to `invs_to_send` twice (it's not critical but a bug still).",
      "created_at": "2024-11-14T07:16:04Z",
      "updated_at": "2024-11-14T07:16:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841679464",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841679464"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841697846",
      "pull_request_review_id": 2435251953,
      "id": 1841697846,
      "node_id": "PRRC_kwDOABII585txhQ2",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": 1824285323,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Probably a taste thing. I think `auto` should be used only when it's obvious what type it is.\r\n\r\nHere there are two non-obvious occasions:\r\n- `auto x = bool + bool` resulting in x=2.\r\n- casting 2 to bool for the result.\r\n\r\nI won't insist but i think verbose types are better here. Feel free to close.",
      "created_at": "2024-11-14T07:33:55Z",
      "updated_at": "2024-11-14T07:33:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1841697846",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1841697846"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842711569",
      "pull_request_review_id": 2436899798,
      "id": 1842711569,
      "node_id": "PRRC_kwDOABII585t1YwR",
      "diff_hunk": "@@ -139,6 +139,12 @@ class TxReconciliationTracker\n      */\n     bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n                         size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay);\n+\n+    /**\n+     * Returns a collections of node ids sorted by how many parents the peer has in its reconciliation set",
      "path": "src/node/txreconciliation.h",
      "position": null,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818583090,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I've reworked the docs for this",
      "created_at": "2024-11-14T18:26:32Z",
      "updated_at": "2024-11-14T18:26:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842711569",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842711569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 158,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842776153",
      "pull_request_review_id": 2437012100,
      "id": 1842776153,
      "node_id": "PRRC_kwDOABII585t1ohZ",
      "diff_hunk": "@@ -523,7 +523,7 @@ class PeerManagerImpl final : public PeerManager\n     PeerManagerInfo GetInfo() const override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     void SendPings() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     std::pair<size_t, size_t> GetFanoutPeersCount() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n-    void RelayTransaction(const uint256& txid, const uint256& wtxid) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    void RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);",
      "path": "src/net_processing.cpp",
      "position": 15,
      "original_position": 5,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818575030,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I misunderstood the use of ForceRelay here. Will amend it so it applied to both",
      "created_at": "2024-11-14T19:23:05Z",
      "updated_at": "2024-11-14T19:23:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842776153",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842776153"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 509,
      "original_line": 509,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842808065",
      "pull_request_review_id": 2437065982,
      "id": 1842808065,
      "node_id": "PRRC_kwDOABII585t1wUB",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Sorry, you're right. I've been looking at this being conditional to `m_txreconciliation->TryRemovingFromSet(peer_id, wtxid)`, which is what happens with the descendants, but here it is unconditional.\r\n\r\nIt should be added only if `TryRemovingFromSet` succeeds, and therefore the ordering in case there are no ancestors won't matter. I'll also add some comments regarding that.\r\n\r\nNotice the point of this is not to add something to `invs_to_send` but rather to move it from `m_txreconciliation` to `invs_to_send`, otherwise things would be sent more than once (or potentially captured by the bloom filters before hand, but still not optimal)",
      "created_at": "2024-11-14T19:49:57Z",
      "updated_at": "2024-11-14T20:17:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842808065",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842808065"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842810444",
      "pull_request_review_id": 2437069698,
      "id": 1842810444,
      "node_id": "PRRC_kwDOABII585t1w5M",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818598067,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Not sure I follow how the first comment is an issue, but I do agree with the second. This needs to be conditional to `TryRemovingFromSet` succeeding.",
      "created_at": "2024-11-14T19:52:00Z",
      "updated_at": "2024-11-14T19:52:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842810444",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842810444"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842841578",
      "pull_request_review_id": 2437121955,
      "id": 1842841578,
      "node_id": "PRRC_kwDOABII585t14fq",
      "diff_hunk": "@@ -75,7 +81,37 @@ class TxReconciliationState\n      */\n     std::map<uint32_t, Wtxid> m_short_id_mapping;\n \n-    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1) {}\n+    TxReconciliationState(bool we_initiate, uint64_t k0, uint64_t k1) : m_we_initiate(we_initiate), m_k0(k0), m_k1(k1), m_delayed_local_set(), m_local_set(0, m_delayed_local_set.hash_function()) {}\n+\n+    /**\n+    * Checks whether a transaction is already in the set. If `include_delayed` is set, the delayed set is also\n+    * checked. Otherwise, transactions are only looked up in the regular set.\n+    */\n+    bool ContainsTx(const Wtxid& wtxid, bool include_delayed)\n+    {\n+        bool found = m_local_set.find(wtxid) != m_local_set.end();\n+        if (include_delayed) {\n+            found |= m_delayed_local_set.find(wtxid) != m_delayed_local_set.end();\n+        }\n+\n+        return found;\n+    }\n+\n+    /**\n+     * Computes the size of the reconciliation set (including both available and delayed transactions)\n+     */\n+    size_t ReconSetSize()\n+    {\n+        return m_local_set.size() + m_delayed_local_set.size();\n+    }\n+\n+    bool RemoveFromSet(const Wtxid& wtxid)\n+    {\n+        auto r = m_local_set.erase(wtxid) + m_delayed_local_set.erase(wtxid);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 53,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ccd695851c69dd30443d3d2f956eea94e8bf8f25",
      "in_reply_to_id": 1824285323,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "That is fair. I've updated it to make it more explicit (and readable)",
      "created_at": "2024-11-14T20:20:15Z",
      "updated_at": "2024-11-14T20:29:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842841578",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842841578"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842867828",
      "pull_request_review_id": 2437168215,
      "id": 1842867828,
      "node_id": "PRRC_kwDOABII585t1-50",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 47,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "d2f260507279b1edd6c0f55d02c7ae2e598b3585",
      "in_reply_to_id": 1818702420,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Done",
      "created_at": "2024-11-14T20:46:34Z",
      "updated_at": "2024-11-14T20:46:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842867828",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842867828"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842870647",
      "pull_request_review_id": 2437172597,
      "id": 1842870647,
      "node_id": "PRRC_kwDOABII585t1_l3",
      "diff_hunk": "@@ -376,6 +377,38 @@ class TxReconciliationTracker::Impl\n \n         return IsFanoutTarget(wtxid, peer_id, peer_state->m_we_initiate, n);\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 387,
      "original_position": 13,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fd7c35a22669d440afe182a153bed28fd326b51f",
      "in_reply_to_id": 1825645357,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Made the move dependant on `TryRemovingFromSet`",
      "created_at": "2024-11-14T20:49:16Z",
      "updated_at": "2024-11-26T15:42:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842870647",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842870647"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 436,
      "original_line": 436,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842873615",
      "pull_request_review_id": 2437177209,
      "id": 1842873615,
      "node_id": "PRRC_kwDOABII585t2AUP",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:",
      "path": "src/node/txreconciliation.cpp",
      "position": 211,
      "original_position": 63,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "e942f3a7493908988eea08640d87b2ae420c5eef",
      "in_reply_to_id": 1827414092,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "The whole thing from L151-L160?",
      "created_at": "2024-11-14T20:52:07Z",
      "updated_at": "2024-11-14T20:52:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842873615",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842873615"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 261,
      "original_line": 261,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842875471",
      "pull_request_review_id": 2437180153,
      "id": 1842875471,
      "node_id": "PRRC_kwDOABII585t2AxP",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:",
      "path": "src/node/txreconciliation.cpp",
      "position": 207,
      "original_position": 59,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "e942f3a7493908988eea08640d87b2ae420c5eef",
      "in_reply_to_id": 1827416829,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm guessing this is related to https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842873615, in which case I'll drop that",
      "created_at": "2024-11-14T20:53:58Z",
      "updated_at": "2024-11-14T20:53:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842875471",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842875471"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 257,
      "original_line": 257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842897353",
      "pull_request_review_id": 2437215427,
      "id": 1842897353,
      "node_id": "PRRC_kwDOABII585t2GHJ",
      "diff_hunk": "@@ -237,33 +274,57 @@ class TxReconciliationTracker::Impl\n         // However, exploiting (2) should not prevent us from relaying certain transactions.\n         //\n         // Transactions which don't make it to the set due to the limit are announced via fan-out.\n-        if (peer_state->m_local_set.size() >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n+        auto set_size = peer_state->ReconSetSize();\n+        if (set_size >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n \n         // The caller currently keeps track of the per-peer transaction announcements, so it\n         // should not attempt to add same tx to the set twice. However, if that happens, we will\n         // simply ignore it.\n-        if (peer_state->m_local_set.insert(wtxid).second) {\n+        if (peer_state->m_delayed_local_set.insert(wtxid).second) {\n             peer_state->m_short_id_mapping.emplace(short_id, wtxid);\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \"\n                                                                         \"Now the set contains %i transactions.\\n\",\n-                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+                          wtxid.ToString(), peer_id, set_size + 1);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 79,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943",
      "in_reply_to_id": 1827487325,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I changed `ReconSetSize` to return a tuple, and updated this to read:\r\n\r\n```\r\n \"Now the set contains %i reconcilable transactions (plus %i delayed transactions).\\n\",\r\n```",
      "created_at": "2024-11-14T21:16:00Z",
      "updated_at": "2024-11-14T21:16:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842897353",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842897353"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842903990",
      "pull_request_review_id": 2437225964,
      "id": 1842903990,
      "node_id": "PRRC_kwDOABII585t2Hu2",
      "diff_hunk": "@@ -237,33 +274,57 @@ class TxReconciliationTracker::Impl\n         // However, exploiting (2) should not prevent us from relaying certain transactions.\n         //\n         // Transactions which don't make it to the set due to the limit are announced via fan-out.\n-        if (peer_state->m_local_set.size() >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n+        auto set_size = peer_state->ReconSetSize();\n+        if (set_size >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n \n         // The caller currently keeps track of the per-peer transaction announcements, so it\n         // should not attempt to add same tx to the set twice. However, if that happens, we will\n         // simply ignore it.\n-        if (peer_state->m_local_set.insert(wtxid).second) {\n+        if (peer_state->m_delayed_local_set.insert(wtxid).second) {\n             peer_state->m_short_id_mapping.emplace(short_id, wtxid);\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \"\n                                                                         \"Now the set contains %i transactions.\\n\",\n-                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+                          wtxid.ToString(), peer_id, set_size + 1);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 79,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943",
      "in_reply_to_id": 1827487325,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I have also applied the same logic when removing",
      "created_at": "2024-11-14T21:22:21Z",
      "updated_at": "2024-11-14T21:22:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842903990",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842903990"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842913498",
      "pull_request_review_id": 2437241134,
      "id": 1842913498,
      "node_id": "PRRC_kwDOABII585t2KDa",
      "diff_hunk": "@@ -2151,10 +2175,32 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 90,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "ee46e21a5c913175415a192661b406b328209800",
      "in_reply_to_id": 1841679464,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Not sure if this comment only applied before https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842870647. But I think this is not currently the case.\r\n\r\nHere we are only adding the parents. Leaving `fanout=true` triggers adding the actual transaction `RelayTransaction` was called with in the following `if (fanout)` block.\r\n\r\nWe could also add it here, but it would involve adding another boolean to skip the `if (fanout)` block, since we need to populate `m_tx_inventory_to_send` with data from `invs_to_send` which happens right after",
      "created_at": "2024-11-14T21:32:06Z",
      "updated_at": "2024-11-14T21:32:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1842913498",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1842913498"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2186,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857859302",
      "pull_request_review_id": 2460468786,
      "id": 1857859302,
      "node_id": "PRRC_kwDOABII585uvK7m",
      "diff_hunk": "@@ -115,10 +133,66 @@ class TxReconciliationTracker::Impl\n                       peer_id, is_peer_inbound);\n \n         const uint256 full_salt{ComputeSalt(local_salt, remote_salt)};\n-        recon_state->second = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        auto new_state = TxReconciliationState(!is_peer_inbound, full_salt.GetUint64(0), full_salt.GetUint64(1));;\n+        m_states.erase(recon_state);\n+        m_states.emplace(peer_id, std::move(new_state));\n+\n         return ReconciliationRegisterResult::SUCCESS;\n     }\n \n+    bool AddToSet(NodeId peer_id, const Wtxid& wtxid) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+        auto peer_state = GetRegisteredPeerState(peer_id);\n+        if (!peer_state) return false;\n+\n+        // Check if the reconciliation set is not at capacity for two reasons:\n+        // - limit sizes of reconciliation sets and short id mappings;\n+        // - limit CPU use for sketch computations.\n+        //\n+        // Since we reconcile frequently, reaching capacity either means:",
      "path": "src/node/txreconciliation.cpp",
      "position": 211,
      "original_position": 63,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "e942f3a7493908988eea08640d87b2ae420c5eef",
      "in_reply_to_id": 1827414092,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This comment is related to L156-160.\r\nL151-155 could be dropped for a different reason (redundancy with the `MAX_RECONSET_SIZE` comment)",
      "created_at": "2024-11-26T06:13:04Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857859302",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857859302"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 261,
      "original_line": 261,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857868518",
      "pull_request_review_id": 2460468786,
      "id": 1857868518,
      "node_id": "PRRC_kwDOABII585uvNLm",
      "diff_hunk": "@@ -217,6 +217,37 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        std::vector<std::pair<uint16_t, NodeId>> parents_by_peer{};\n+        for (const auto &[peer_id, _]: m_states) {\n+            if (GetRegisteredPeerState(peer_id)) {\n+                parents_by_peer.emplace_back(0, peer_id);\n+            }\n+        }\n+\n+        for (auto &[parent_count, peer_id]: parents_by_peer) {\n+            const auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+            for (const auto& wtxid: parents) {\n+                if (auto found = state.m_local_set.find(wtxid); found != state.m_local_set.end()) {",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "1dce9aedc59eba2b623c7785f59430a586fbd833",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "1dce9aedc59eba2b623c7785f59430a586fbd833\r\n\r\nthe variable `found` could be dropped",
      "created_at": "2024-11-26T06:23:27Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857868518",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857868518"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 236,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857872449",
      "pull_request_review_id": 2460468786,
      "id": 1857872449,
      "node_id": "PRRC_kwDOABII585uvOJB",
      "diff_hunk": "@@ -523,7 +523,7 @@ class PeerManagerImpl final : public PeerManager\n     PeerManagerInfo GetInfo() const override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     void SendPings() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     std::pair<size_t, size_t> GetFanoutPeersCount() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n-    void RelayTransaction(const uint256& txid, const uint256& wtxid) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    void RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);",
      "path": "src/net_processing.cpp",
      "position": 15,
      "original_position": 5,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818575030,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "What's the plan? I still think `force_relay` is unnecessary here.",
      "created_at": "2024-11-26T06:27:12Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857872449",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857872449"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 509,
      "original_line": 509,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857883023",
      "pull_request_review_id": 2460468786,
      "id": 1857883023,
      "node_id": "PRRC_kwDOABII585uvQuP",
      "diff_hunk": "@@ -2151,10 +2175,33 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    if (m_txreconciliation->TryRemovingFromSet(peer_id, wtxid)) {\n+                        invs_to_send.push_back(wtxid);\n+                    }\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout || !m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid)).m_succeeded) {\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);",
      "path": "src/net_processing.cpp",
      "position": 124,
      "original_position": 100,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "0092f70314b8d59b41ff4bd2bc15a71f954668d4\r\n\r\nConsider `fanout=false` because the peer has too many parents (cut the tail from `fanout_with_ancestors`).\r\nNow, we fail to add a transaction to the set (whatever reason, say set too full), and we're now going to flood a child while reconciling the parents again?\r\n\r\nPerhaps `AddToSet` result could be handled more carefully instead (or have a todo/comment, this is a corner case of a corner case of course). ",
      "created_at": "2024-11-26T06:37:52Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857883023",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857883023"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2199,
      "original_line": 2196,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857884471",
      "pull_request_review_id": 2460468786,
      "id": 1857884471,
      "node_id": "PRRC_kwDOABII585uvRE3",
      "diff_hunk": "@@ -2151,10 +2175,33 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    if (m_txreconciliation->TryRemovingFromSet(peer_id, wtxid)) {\n+                        invs_to_send.push_back(wtxid);\n+                    }\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout || !m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid)).m_succeeded) {\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);\n+        }\n+\n+        for (const auto& hash : invs_to_send) {\n+            if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n+                tx_relay->m_tx_inventory_to_send.insert(hash);\n+            }\n+        }\n+        invs_to_send.clear();",
      "path": "src/net_processing.cpp",
      "position": 160,
      "original_position": 108,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "https://github.com/bitcoin/bitcoin/commit/0092f70314b8d59b41ff4bd2bc15a71f954668d4\r\n\r\nconsider defining this variable inside the loop rather than cleaning it after each iteration?",
      "created_at": "2024-11-26T06:39:18Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857884471",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857884471"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2235,
      "original_line": 2204,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857898012",
      "pull_request_review_id": 2460468786,
      "id": 1857898012,
      "node_id": "PRRC_kwDOABII585uvUYc",
      "diff_hunk": "@@ -2151,10 +2175,33 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    if (m_txreconciliation->TryRemovingFromSet(peer_id, wtxid)) {\n+                        invs_to_send.push_back(wtxid);\n+                    }\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout || !m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid)).m_succeeded) {\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);",
      "path": "src/net_processing.cpp",
      "position": 124,
      "original_position": 100,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "in_reply_to_id": 1857883023,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "This is slightly changed later in 5996d473434d364cff937ae89ffd95cd09c5d1a7. `AddToSetResult::Failed` still not handled though?",
      "created_at": "2024-11-26T06:51:38Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857898012",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857898012"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2199,
      "original_line": 2196,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857918168",
      "pull_request_review_id": 2460468786,
      "id": 1857918168,
      "node_id": "PRRC_kwDOABII585uvZTY",
      "diff_hunk": "@@ -381,9 +445,9 @@ class TxReconciliationTracker::Impl\n         }\n \n         for (auto &[parent_count, peer_id]: parents_by_peer) {\n-            const auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+            auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n             for (const auto& wtxid: parents) {\n-                if (auto found = state.m_local_set.find(wtxid); found != state.m_local_set.end()) {\n+                if (state.ContainsTx(wtxid, /*include_delayed=*/true)) {",
      "path": "src/node/txreconciliation.cpp",
      "position": 402,
      "original_position": 138,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "840a4e14f2d833717c87a54ec2707a92d5131ada",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "840a4e14f2d833717c87a54ec2707a92d5131ada\r\n\r\nbeen thinking about the use of a delayed set here.\r\n\r\nWe apply the delay only on addition, but not on fanouting parents (or counting them), neither on removing stuff from the sets (say at receiving a transaction).\r\n\r\nFor me the choice is pretty arbitrary (and probably fine to save the code complexity for this rare corner case), but perhaps we would benefit from better documentation around it.",
      "created_at": "2024-11-26T07:05:09Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857918168",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857918168"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 451,
      "original_line": 450,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857927041",
      "pull_request_review_id": 2460468786,
      "id": 1857927041,
      "node_id": "PRRC_kwDOABII585uvbeB",
      "diff_hunk": "@@ -357,79 +357,80 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::vector<NodeId> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        size_t outbounds_target_size = 0;\n+        if (OUTBOUND_FANOUT_DESTINATIONS > outbounds_fanout_tx_relay) {\n+            outbounds_target_size = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+        }\n \n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n+        sorted_inbounds.reserve(m_inbounds_count);\n+        Assume(m_states.size() >= m_inbounds_count);\n+        sorted_outbounds.reserve(m_states.size() - m_inbounds_count);\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();\n+                    sorted_outbounds.emplace_back(hash_key, node_id);\n+                } else {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_in).Write(node_id).Finalize();\n+                    sorted_inbounds.emplace_back(hash_key, node_id);\n+                }\n+\n             }\n         }\n \n-        std::sort(best_peers.begin(), best_peers.end());\n-\n-        auto it = best_peers.begin();\n-        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+        // Sort the peers based on their assigned random value, extract the node_ids and trim the collections to size\n+        std::vector<NodeId> in_fanout_targets;\n+        if (inbounds_target_size >= 1) {\n+            std::sort(sorted_inbounds.begin(), sorted_inbounds.end());\n+            for_each(sorted_inbounds.begin(), sorted_inbounds.end(),\n+                    [&in_fanout_targets](auto& keyed_peer) { in_fanout_targets.push_back(keyed_peer.second); });\n+            in_fanout_targets.resize(inbounds_target_size);\n         }\n-        return false;\n+        std::vector<NodeId> out_fanout_targets;\n+        if (outbounds_target_size >= 1) {\n+            std::sort(sorted_outbounds.begin(), sorted_outbounds.end());\n+            for_each(sorted_outbounds.begin(), sorted_outbounds.end(),\n+                    [&out_fanout_targets](auto& keyed_peer) { out_fanout_targets.push_back(keyed_peer.second); });\n+            out_fanout_targets.resize(outbounds_target_size);\n+        }\n+\n+        // Merge both vectors and return\n+        in_fanout_targets.insert(in_fanout_targets.end(), out_fanout_targets.begin(), out_fanout_targets.end());\n+\n+        return in_fanout_targets;\n     }\n \n-    /*\n-     * TODO. This is currently not marked const, because it would require adding a const version\n-     * of GetRegisteredPeerState. However, this function becomes non-const in the next commit anyway\n-     * due to caching. Thus, we can save us adding that extra function for now.\n-     */\n-    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n-                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n-        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool ShouldFanoutTo(NodeId peer_id, std::vector<NodeId> &fanout_targets) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 103,
      "original_position": 103,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825\r\n\r\nthis wrapper is not needed anymore. The Registered check already happens at the caller site. Just drop it and expose `GetFanoutTargets`?",
      "created_at": "2024-11-26T07:10:01Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1857927041",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1857927041"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 426,
      "original_line": 426,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858243236",
      "pull_request_review_id": 2460468786,
      "id": 1858243236,
      "node_id": "PRRC_kwDOABII585uwoqk",
      "diff_hunk": "@@ -357,79 +357,80 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::vector<NodeId> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        size_t outbounds_target_size = 0;\n+        if (OUTBOUND_FANOUT_DESTINATIONS > outbounds_fanout_tx_relay) {\n+            outbounds_target_size = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+        }\n \n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n+        sorted_inbounds.reserve(m_inbounds_count);\n+        Assume(m_states.size() >= m_inbounds_count);\n+        sorted_outbounds.reserve(m_states.size() - m_inbounds_count);\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();\n+                    sorted_outbounds.emplace_back(hash_key, node_id);\n+                } else {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_in).Write(node_id).Finalize();\n+                    sorted_inbounds.emplace_back(hash_key, node_id);\n+                }\n+\n             }\n         }\n \n-        std::sort(best_peers.begin(), best_peers.end());\n-\n-        auto it = best_peers.begin();\n-        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+        // Sort the peers based on their assigned random value, extract the node_ids and trim the collections to size",
      "path": "src/node/txreconciliation.cpp",
      "position": 72,
      "original_position": 72,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```\r\n        // TODO: now rename sorted_inbounds to weighted_inbounds\r\n        std::vector<NodeId> fanout_targets(inbounds_target_size + outbounds_target_size);\r\n        auto collect_fanout_targets = [&fanout_targets](std::vector<std::pair<uint64_t, NodeId>> weighted_peers, const size_t target_size) {\r\n            const size_t result_size = std::min(target_size, weighted_peers.size());\r\n            if (result_size == 0) return;\r\n            std::nth_element(weighted_peers.begin(), weighted_peers.begin() + result_size, weighted_peers.end());\r\n            for_each(weighted_peers.begin(), weighted_peers.begin() + result_size,\r\n                    [&fanout_targets](auto& keyed_peer) { fanout_targets.push_back(keyed_peer.second); });\r\n        };\r\n\r\n        collect_fanout_targets(sorted_inbounds, inbounds_target_size);\r\n        collect_fanout_targets(sorted_outbounds, outbounds_target_size);\r\n        return fanout_targets;\r\n```",
      "created_at": "2024-11-26T10:44:16Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858243236",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858243236"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 404,
      "original_line": 404,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858312000",
      "pull_request_review_id": 2460468786,
      "id": 1858312000,
      "node_id": "PRRC_kwDOABII585uw5dA",
      "diff_hunk": "@@ -357,79 +357,80 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::vector<NodeId> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        size_t outbounds_target_size = 0;\n+        if (OUTBOUND_FANOUT_DESTINATIONS > outbounds_fanout_tx_relay) {\n+            outbounds_target_size = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+        }\n \n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n+        sorted_inbounds.reserve(m_inbounds_count);\n+        Assume(m_states.size() >= m_inbounds_count);\n+        sorted_outbounds.reserve(m_states.size() - m_inbounds_count);\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();",
      "path": "src/node/txreconciliation.cpp",
      "position": 57,
      "original_position": 57,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "```\r\n        auto assign_key = [](const TxReconciliationState& peer_state, NodeId node_id, CSipHasher randomizer, std::vector<std::pair<uint64_t, NodeId>>& weighted_peers) {\r\n            uint64_t hash_key = randomizer.Write(node_id).Finalize();\r\n            weighted_peers.emplace_back(hash_key, node_id);\r\n        };\r\n\r\n        for (const auto& [node_id, op_peer_state]: m_states) {\r\n            const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\r\n            if (peer_state) {\r\n                if (peer_state->m_we_initiate) {\r\n                    assign_key(*peer_state, node_id, deterministic_randomizer_out, sorted_outbounds);\r\n                } else {\r\n                    assign_key(*peer_state, node_id, deterministic_randomizer_in, sorted_inbounds);\r\n                }\r\n            }\r\n        }\r\n```\r\n\r\nvery subjectively a little cleaner :)",
      "created_at": "2024-11-26T11:33:25Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858312000",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858312000"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 394,
      "original_line": 394,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858323811",
      "pull_request_review_id": 2460468786,
      "id": 1858323811,
      "node_id": "PRRC_kwDOABII585uw8Vj",
      "diff_hunk": "@@ -2135,12 +2138,33 @@ std::pair<size_t, size_t> PeerManagerImpl::GetFanoutPeersCount()\n     return std::pair(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n }\n \n-void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid)\n+void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay)\n {\n+    size_t inbounds_fanout_tx_relay{0}, outbounds_fanout_tx_relay{0};\n+    std::vector<Wtxid> parents;\n+    std::vector<NodeId> fanout_with_ancestors;\n+    const bool can_reconcile = !force_relay && m_txreconciliation;\n+    {\n+        if (can_reconcile) {\n+            std::tie(inbounds_fanout_tx_relay, outbounds_fanout_tx_relay) = GetFanoutPeersCount();\n+            LOCK(m_mempool.cs);\n+            if (auto txiter = m_mempool.GetIter(wtxid)) {\n+                const auto parents_refs = (*txiter)->GetMemPoolParents();\n+                if (!parents_refs.empty()) {\n+                    for (const auto &tx : parents_refs) {\n+                        parents.emplace_back(tx.get().GetTx().GetWitnessHash());\n+                    }\n+                    fanout_with_ancestors = m_txreconciliation->SortPeersByFewestParents(parents);\n+                    fanout_with_ancestors.resize(2); // FIXME: Resize to 2 for now",
      "path": "src/net_processing.cpp",
      "position": 82,
      "original_position": 59,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "in_reply_to_id": null,
      "user": {
        "login": "naumenkogs",
        "id": 7975071,
        "node_id": "MDQ6VXNlcjc5NzUwNzE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/naumenkogs",
        "html_url": "https://github.com/naumenkogs",
        "followers_url": "https://api.github.com/users/naumenkogs/followers",
        "following_url": "https://api.github.com/users/naumenkogs/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/naumenkogs/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/naumenkogs/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
        "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
        "repos_url": "https://api.github.com/users/naumenkogs/repos",
        "events_url": "https://api.github.com/users/naumenkogs/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Better check if the size is not 1 already? It's currently safe, but could cause bugs in the future.",
      "created_at": "2024-11-26T11:42:04Z",
      "updated_at": "2024-11-26T11:42:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858323811",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858323811"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2160,
      "original_line": 2158,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858826260",
      "pull_request_review_id": 2462013889,
      "id": 1858826260,
      "node_id": "PRRC_kwDOABII585uy3AU",
      "diff_hunk": "@@ -523,7 +523,7 @@ class PeerManagerImpl final : public PeerManager\n     PeerManagerInfo GetInfo() const override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     void SendPings() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n     std::pair<size_t, size_t> GetFanoutPeersCount() override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n-    void RelayTransaction(const uint256& txid, const uint256& wtxid) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n+    void RelayTransaction(const uint256& txid, const uint256& wtxid, bool force_relay) override EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);",
      "path": "src/net_processing.cpp",
      "position": 15,
      "original_position": 5,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818575030,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yep, I'm planning to drop it",
      "created_at": "2024-11-26T16:07:11Z",
      "updated_at": "2024-11-26T16:07:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858826260",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858826260"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 509,
      "original_line": 509,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858826625",
      "pull_request_review_id": 2462014484,
      "id": 1858826625,
      "node_id": "PRRC_kwDOABII585uy3GB",
      "diff_hunk": "@@ -6270,6 +6270,10 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                 // Determine transactions to relay\n                 if (fSendTrickle) {\n+                    if (m_txreconciliation && m_txreconciliation->IsPeerRegistered(pto->GetId())) {\n+                        // Make transactions added to the reconciliation set during the last interval available\n+                        m_txreconciliation->ReadyDelayedTransactions(pto->GetId());",
      "path": "src/net_processing.cpp",
      "position": 216,
      "original_position": 6,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "20772c077832592265bd6a2876aa6b4cb7dbde7d",
      "in_reply_to_id": 1818670032,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I'm planning to simulate both cases and report back",
      "created_at": "2024-11-26T16:07:26Z",
      "updated_at": "2024-11-26T16:07:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858826625",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858826625"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 5833,
      "original_line": 5833,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858828041",
      "pull_request_review_id": 2462016691,
      "id": 1858828041,
      "node_id": "PRRC_kwDOABII585uy3cJ",
      "diff_hunk": "@@ -2399,10 +2420,57 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    m_txreconciliation->TryRemovingFromSet(peer_id, wtxid);\n+                    invs_to_send.push_back(wtxid);",
      "path": "src/net_processing.cpp",
      "position": null,
      "original_position": 82,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "392facfce1be6d0395abecc2e049ff39635bd1a5",
      "in_reply_to_id": 1818598067,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "@naumenkogs can this be resolved?",
      "created_at": "2024-11-26T16:08:18Z",
      "updated_at": "2024-11-26T16:08:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858828041",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858828041"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2188,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858829100",
      "pull_request_review_id": 2462018504,
      "id": 1858829100,
      "node_id": "PRRC_kwDOABII585uy3ss",
      "diff_hunk": "@@ -237,33 +274,57 @@ class TxReconciliationTracker::Impl\n         // However, exploiting (2) should not prevent us from relaying certain transactions.\n         //\n         // Transactions which don't make it to the set due to the limit are announced via fan-out.\n-        if (peer_state->m_local_set.size() >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n+        auto set_size = peer_state->ReconSetSize();\n+        if (set_size >= MAX_RECONSET_SIZE) return AddToSetResult::Failed();\n \n         // The caller currently keeps track of the per-peer transaction announcements, so it\n         // should not attempt to add same tx to the set twice. However, if that happens, we will\n         // simply ignore it.\n-        if (peer_state->m_local_set.insert(wtxid).second) {\n+        if (peer_state->m_delayed_local_set.insert(wtxid).second) {\n             peer_state->m_short_id_mapping.emplace(short_id, wtxid);\n             LogPrintLevel(BCLog::TXRECONCILIATION, BCLog::Level::Debug, \"Added %s to the reconciliation set for peer=%d. \"\n                                                                         \"Now the set contains %i transactions.\\n\",\n-                          wtxid.ToString(), peer_id, peer_state->m_local_set.size());\n+                          wtxid.ToString(), peer_id, set_size + 1);",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 79,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "c790aa0e7ebfcf0b03b4d0ef5fcc0ddfa4199943",
      "in_reply_to_id": 1827487325,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Can this be resolved?",
      "created_at": "2024-11-26T16:08:58Z",
      "updated_at": "2024-11-26T16:08:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858829100",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858829100"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 279,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858866659",
      "pull_request_review_id": 2462080832,
      "id": 1858866659,
      "node_id": "PRRC_kwDOABII585uzA3j",
      "diff_hunk": "@@ -217,6 +217,37 @@ class TxReconciliationTracker::Impl\n         return (recon_state != m_states.end() &&\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n+\n+    std::vector<NodeId> SortPeersByFewestParents(std::vector<Wtxid> parents) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    {\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        std::vector<std::pair<uint16_t, NodeId>> parents_by_peer{};\n+        for (const auto &[peer_id, _]: m_states) {\n+            if (GetRegisteredPeerState(peer_id)) {\n+                parents_by_peer.emplace_back(0, peer_id);\n+            }\n+        }\n+\n+        for (auto &[parent_count, peer_id]: parents_by_peer) {\n+            const auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+            for (const auto& wtxid: parents) {\n+                if (auto found = state.m_local_set.find(wtxid); found != state.m_local_set.end()) {",
      "path": "src/node/txreconciliation.cpp",
      "position": null,
      "original_position": 20,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "1dce9aedc59eba2b623c7785f59430a586fbd833",
      "in_reply_to_id": 1857868518,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "That commit is from an old revision",
      "created_at": "2024-11-26T16:31:38Z",
      "updated_at": "2024-11-26T16:31:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1858866659",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1858866659"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 236,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859111798",
      "pull_request_review_id": 2462493434,
      "id": 1859111798,
      "node_id": "PRRC_kwDOABII585uz8t2",
      "diff_hunk": "@@ -2151,10 +2175,33 @@ void PeerManagerImpl::RelayTransaction(const uint256& txid, const uint256& wtxid\n         // in the announcement.\n         if (tx_relay->m_next_inv_send_time == 0s) continue;\n \n-        const uint256& hash{peer.m_wtxid_relay ? wtxid : txid};\n-        if (!tx_relay->m_tx_inventory_known_filter.contains(hash)) {\n-            tx_relay->m_tx_inventory_to_send.insert(hash);\n+        bool fanout = true;\n+        if (can_reconcile && m_txreconciliation->IsPeerRegistered(peer_id)) {\n+            // If this transaction has parents in the mempool and the peer is within the peers with less ancestors\n+            // to reconcile, fanout the transaction an all its ancestors. We just add the parents here and leave fanout as true\n+            auto it = std::find(fanout_with_ancestors.begin(), fanout_with_ancestors.end(), peer_id);\n+            if (it != fanout_with_ancestors.end()) {\n+                for (const auto wtxid: parents) {\n+                    if (m_txreconciliation->TryRemovingFromSet(peer_id, wtxid)) {\n+                        invs_to_send.push_back(wtxid);\n+                    }\n+                }\n+            } else {\n+                // If the peer is registered for set reconciliation, maybe pick it as fanout\n+                fanout = m_txreconciliation->ShouldFanoutTo(Wtxid::FromUint256(wtxid), peer_id, inbounds_fanout_tx_relay, outbounds_fanout_tx_relay);\n+            }\n         }\n+\n+        if (fanout || !m_txreconciliation->AddToSet(peer_id, Wtxid::FromUint256(wtxid)).m_succeeded) {\n+            invs_to_send.push_back(peer->m_wtxid_relay ? wtxid : txid);",
      "path": "src/net_processing.cpp",
      "position": 124,
      "original_position": 100,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "0092f70314b8d59b41ff4bd2bc15a71f954668d4",
      "in_reply_to_id": 1857883023,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Yes, that's right. In the current revision, if the set is full and the given transaction has some ancestors, the children will be flooded while the parents will be reconciled, which may cause orphans.\r\n\r\nI think we could handle this at the same level that we handled `fanout_with_ancestors`:\r\n\r\n- Fanout to peers that have ancestors and have a full set\r\n- Fanout to peers that have the least amount of ancestors\r\n\r\nHowever, this will still be an issue in some cases, given we only select a subset of peers to fanout to when these conditions hold (currently 2, but let's say `n`). If we do not fanout to all peers that fall under these conditions, there will always be some that will receive parents and children using different approaches, which may cause orphans. However, I think it is undesirable to fanout to all matches in this situation.\r\n\r\nThis raises the question, is it worth the added complexity, or should we add a comment acknowledging that this can be the case, but that we expect it to happen really infrequently? ",
      "created_at": "2024-11-26T19:19:56Z",
      "updated_at": "2024-11-26T19:19:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1859111798",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859111798"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 2199,
      "original_line": 2196,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859182705",
      "pull_request_review_id": 2462607651,
      "id": 1859182705,
      "node_id": "PRRC_kwDOABII585u0OBx",
      "diff_hunk": "@@ -381,9 +445,9 @@ class TxReconciliationTracker::Impl\n         }\n \n         for (auto &[parent_count, peer_id]: parents_by_peer) {\n-            const auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n+            auto state = std::get<TxReconciliationState>(m_states.find(peer_id)->second);\n             for (const auto& wtxid: parents) {\n-                if (auto found = state.m_local_set.find(wtxid); found != state.m_local_set.end()) {\n+                if (state.ContainsTx(wtxid, /*include_delayed=*/true)) {",
      "path": "src/node/txreconciliation.cpp",
      "position": 402,
      "original_position": 138,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "840a4e14f2d833717c87a54ec2707a92d5131ada",
      "in_reply_to_id": 1857918168,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "I think I'm not following here. We do apply the delayed set both on addition (`AddToSet`), deletion (`RemoveFromSet`), and when counting parents (this bit of code is part of the parent sorting).",
      "created_at": "2024-11-26T20:24:01Z",
      "updated_at": "2024-11-26T20:24:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1859182705",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859182705"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 451,
      "original_line": 450,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859187630",
      "pull_request_review_id": 2462615266,
      "id": 1859187630,
      "node_id": "PRRC_kwDOABII585u0POu",
      "diff_hunk": "@@ -357,79 +357,80 @@ class TxReconciliationTracker::Impl\n                 std::holds_alternative<TxReconciliationState>(recon_state->second));\n     }\n \n-    bool IsFanoutTarget(const Wtxid& wtxid, NodeId peer_id, bool we_initiate, double n) const EXCLUSIVE_LOCKS_REQUIRED(m_txreconciliation_mutex)\n+    std::vector<NodeId> GetFanoutTargets(const Wtxid& wtxid, size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay) const EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n     {\n-        // We use the pre-determined randomness to give a consistent result per transaction, thus making sure that no transaction\n-        // gets \"unlucky\" if every per-peer roll fails. This means that, given a `wtxid`, the ordering will always be the same,\n-        // independently of what peer this is queried for. So some need to be picked eventually (as long as `n` doesn't shrink).\n-        CSipHasher deterministic_randomizer{m_deterministic_randomizer};\n-        deterministic_randomizer.Write(wtxid.ToUint256());\n-\n-        // We decide a peer is a fanout target for a given transaction deterministically at random based on two things: the wtxid of\n-        // the transaction to be relayed (which we used as a seed for the randomizer) and the likelihood to fanout this transaction\n-        // (which depends on how many non-erlay tx-relay peers we have, and the direction of the connection).\n-        // In order to do this, we sort the peers in random order, and then we pick the top `n` peers of the resulting collection.\n-        // If our chosen peer happens to be within the picked selection, we fanout to it, otherwise we reconcile.\n-        const size_t targets_size = ((deterministic_randomizer.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n-\n-        std::vector<std::pair<uint64_t, NodeId>> best_peers;\n-        best_peers.reserve(m_states.size());\n+        AssertLockNotHeld(m_txreconciliation_mutex);\n+        LOCK(m_txreconciliation_mutex);\n+\n+        // We decide whether a particular peer is a low-fanout flood target differently based on its connection direction:\n+        // - for outbounds we have a fixed number of flood destinations.\n+        // - for inbounds we use a fraction of all inbound peers supporting tx relay.\n+        size_t outbounds_target_size = 0;\n+        if (OUTBOUND_FANOUT_DESTINATIONS > outbounds_fanout_tx_relay) {\n+            outbounds_target_size = OUTBOUND_FANOUT_DESTINATIONS - outbounds_fanout_tx_relay;\n+        }\n \n+        // Since we use the fraction for inbound peers, we first need to compute the total number of inbound targets.\n+        const double inbound_targets = (inbounds_fanout_tx_relay + m_inbounds_count) * INBOUND_FANOUT_DESTINATIONS_FRACTION;\n+        double n = std::max(inbound_targets - inbounds_fanout_tx_relay, 0.0);\n+\n+        // Being this a fraction, we need to round it either up or down. We do this deterministically at random based on the\n+        // transaction we are picking the peers for.\n+        CSipHasher deterministic_randomizer_in{m_deterministic_randomizer};\n+        deterministic_randomizer_in.Write(wtxid.ToUint256());\n+        CSipHasher deterministic_randomizer_out{deterministic_randomizer_in};\n+        const size_t inbounds_target_size = ((deterministic_randomizer_in.Finalize() & 0xFFFFFFFF) + uint64_t(n * 0x100000000)) >> 32;\n+\n+        // Pick all reconciliation registered peers and assign them a deterministically random value based on their peer id\n+        // Also, split peers in inbounds/outbounds\n+        std::vector<std::pair<uint64_t, NodeId>> sorted_inbounds, sorted_outbounds;\n+        sorted_inbounds.reserve(m_inbounds_count);\n+        Assume(m_states.size() >= m_inbounds_count);\n+        sorted_outbounds.reserve(m_states.size() - m_inbounds_count);\n         for (const auto& [node_id, op_peer_state]: m_states) {\n             const auto peer_state = std::get_if<TxReconciliationState>(&op_peer_state);\n-            if (peer_state && peer_state->m_we_initiate == we_initiate) {\n-                uint64_t hash_key = CSipHasher(deterministic_randomizer).Write(node_id).Finalize();\n-                best_peers.emplace_back(hash_key, node_id);\n+            if (peer_state) {\n+                if (peer_state->m_we_initiate) {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_out).Write(node_id).Finalize();\n+                    sorted_outbounds.emplace_back(hash_key, node_id);\n+                } else {\n+                    uint64_t hash_key = CSipHasher(deterministic_randomizer_in).Write(node_id).Finalize();\n+                    sorted_inbounds.emplace_back(hash_key, node_id);\n+                }\n+\n             }\n         }\n \n-        std::sort(best_peers.begin(), best_peers.end());\n-\n-        auto it = best_peers.begin();\n-        for (size_t i = 0; i < targets_size && it != best_peers.end(); ++i, ++it) {\n-            if (it->second == peer_id) return true;\n+        // Sort the peers based on their assigned random value, extract the node_ids and trim the collections to size\n+        std::vector<NodeId> in_fanout_targets;\n+        if (inbounds_target_size >= 1) {\n+            std::sort(sorted_inbounds.begin(), sorted_inbounds.end());\n+            for_each(sorted_inbounds.begin(), sorted_inbounds.end(),\n+                    [&in_fanout_targets](auto& keyed_peer) { in_fanout_targets.push_back(keyed_peer.second); });\n+            in_fanout_targets.resize(inbounds_target_size);\n         }\n-        return false;\n+        std::vector<NodeId> out_fanout_targets;\n+        if (outbounds_target_size >= 1) {\n+            std::sort(sorted_outbounds.begin(), sorted_outbounds.end());\n+            for_each(sorted_outbounds.begin(), sorted_outbounds.end(),\n+                    [&out_fanout_targets](auto& keyed_peer) { out_fanout_targets.push_back(keyed_peer.second); });\n+            out_fanout_targets.resize(outbounds_target_size);\n+        }\n+\n+        // Merge both vectors and return\n+        in_fanout_targets.insert(in_fanout_targets.end(), out_fanout_targets.begin(), out_fanout_targets.end());\n+\n+        return in_fanout_targets;\n     }\n \n-    /*\n-     * TODO. This is currently not marked const, because it would require adding a const version\n-     * of GetRegisteredPeerState. However, this function becomes non-const in the next commit anyway\n-     * due to caching. Thus, we can save us adding that extra function for now.\n-     */\n-    bool ShouldFanoutTo(const Wtxid& wtxid, NodeId peer_id,\n-                        size_t inbounds_fanout_tx_relay, size_t outbounds_fanout_tx_relay)\n-        EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)\n+    bool ShouldFanoutTo(NodeId peer_id, std::vector<NodeId> &fanout_targets) EXCLUSIVE_LOCKS_REQUIRED(!m_txreconciliation_mutex)",
      "path": "src/node/txreconciliation.cpp",
      "position": 103,
      "original_position": 103,
      "commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "original_commit_id": "fc06786f32b2fc82c9571ebde67b4ff54f4ad825",
      "in_reply_to_id": 1857927041,
      "user": {
        "login": "sr-gi",
        "id": 6665628,
        "node_id": "MDQ6VXNlcjY2NjU2Mjg=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6665628?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sr-gi",
        "html_url": "https://github.com/sr-gi",
        "followers_url": "https://api.github.com/users/sr-gi/followers",
        "following_url": "https://api.github.com/users/sr-gi/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sr-gi/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sr-gi/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sr-gi/subscriptions",
        "organizations_url": "https://api.github.com/users/sr-gi/orgs",
        "repos_url": "https://api.github.com/users/sr-gi/repos",
        "events_url": "https://api.github.com/users/sr-gi/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sr-gi/received_events",
        "type": "User",
        "site_admin": false,
        "patch_url": null
      },
      "body": "Sure. This also implies dropping the bench for it, which honestly I do not think is as useful anymore now that we do not have a cache",
      "created_at": "2024-11-26T20:29:05Z",
      "updated_at": "2024-11-26T20:29:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30116#discussion_r1859187630",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859187630"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30116"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 426,
      "original_line": 426,
      "side": "RIGHT"
    }
  ]
}