{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315",
    "id": 1930925459,
    "node_id": "PR_kwDOABII585zF5WT",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/30315",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/30315.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/30315.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30315",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30315/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/11328075fe1783163fa5d3113a37f6b20ccd4c43",
    "number": 30315,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "Stratum v2 Transport",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Based on #29346. Parent PR #29432.\r\n\r\nIntroduces `Sv2Transport::Transport` which is very similar to `V2Transport`.\r\n\r\nTODO:\r\n* shoehorn `Sv2NetMsg` into a `CSerializedNetMsg` in `SetMessageToSend` (currently broken)\r\n* shoehorn `Sv2NetMsg` into a `CNetMessage` in `GetReceivedMessage` (currently works)\r\n* use `BytesToSend` instead of `Sv2BytesToSend`? (currently works)\r\n\r\nSee discussion in #30209.\r\n\r\nThe first few commits move some network related code from Node to Common. My goal is to make the Stratum v2 Template Provider independent of the Node so it can run in a separate process - so it doesn't take the whole node down if there's a bug (after #10102).\r\n\r\nThose refactor commits are orthogonal to the main work here though, I'll make a separate PR for them once people are happy with the overall direction.",
    "labels": [
      {
        "id": 5334691551,
        "node_id": "LA_kwDOABII588AAAABPfju3w",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed",
        "name": "CI failed",
        "description": "",
        "color": "cccccc",
        "default": false
      }
    ],
    "created_at": "2024-06-20T15:59:15Z",
    "updated_at": "2024-06-20T16:15:58Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merge_commit_sha": "2b6b694e46276bc207b850204817e872756a9758",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "Sjors:2024/06/sv2_transport",
      "ref": "2024/06/sv2_transport",
      "sha": "11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "repo": {
        "id": 92390696,
        "node_id": "MDEwOlJlcG9zaXRvcnk5MjM5MDY5Ng==",
        "name": "bitcoin",
        "full_name": "Sjors/bitcoin",
        "owner": {
          "login": "Sjors",
          "id": 10217,
          "node_id": "MDQ6VXNlcjEwMjE3",
          "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/Sjors",
          "html_url": "https://github.com/Sjors",
          "followers_url": "https://api.github.com/users/Sjors/followers",
          "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
          "organizations_url": "https://api.github.com/users/Sjors/orgs",
          "repos_url": "https://api.github.com/users/Sjors/repos",
          "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/Sjors/received_events",
          "type": "User",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/Sjors/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/Sjors/bitcoin",
        "archive_url": "https://api.github.com/repos/Sjors/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/Sjors/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/Sjors/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/Sjors/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/Sjors/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/Sjors/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/Sjors/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/Sjors/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/Sjors/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/Sjors/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/Sjors/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/Sjors/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/Sjors/bitcoin/events",
        "forks_url": "https://api.github.com/repos/Sjors/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/Sjors/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/Sjors/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/Sjors/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/Sjors/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/Sjors/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/Sjors/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/Sjors/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/Sjors/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/Sjors/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/Sjors/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/Sjors/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/Sjors/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/Sjors/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/Sjors/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/Sjors/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:Sjors/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/Sjors/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/Sjors/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/Sjors/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/Sjors/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/Sjors/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/Sjors/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/Sjors/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/Sjors/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/Sjors/bitcoin/hooks",
        "svn_url": "https://github.com/Sjors/bitcoin",
        "homepage": "https://bitcoin.org/en/download",
        "language": "C++",
        "forks_count": 9,
        "stargazers_count": 5,
        "watchers_count": 5,
        "size": 240226,
        "default_branch": "sv2",
        "open_issues_count": 4,
        "is_template": false,
        "topics": [],
        "has_issues": true,
        "has_projects": false,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-06-20T16:59:21Z",
        "created_at": "2017-05-25T10:05:54Z",
        "updated_at": "2024-06-20T13:56:20Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "aa2ce2d64696c030fb39f4e63b12271bb700eb28",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 35543,
        "stargazers_count": 76956,
        "watchers_count": 76956,
        "size": 261760,
        "default_branch": "master",
        "open_issues_count": 687,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2024-06-20T16:58:48Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2024-06-20T16:30:54Z",
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
      }
    },
    "author_association": "MEMBER",
    "draft": true,
    "additions": 2650,
    "deletions": 184,
    "changed_files": 26,
    "commits": 7,
    "review_comments": 3,
    "comments": 3
  },
  "events": [
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg4ODQ3NDYzZGZiYjczNTE1YzU3ZDFiMGM1MDk4NGFhMzVkYmE2MGU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88847463dfbb73515c57d1b0c50984aa35dba60e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/88847463dfbb73515c57d1b0c50984aa35dba60e",
      "tree": {
        "sha": "0ee89eaffa0010e05b1b48562231c5f4ffaa821c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0ee89eaffa0010e05b1b48562231c5f4ffaa821c"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 0ee89eaffa0010e05b1b48562231c5f4ffaa821c\nparent 9c5cdf07f30f816cd134e2cd2dca9c27ef7067a5\nauthor Sjors Provoost <sjors@sprovoost.nl> 1701349128 +0100\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718716520 +0200\n\nAdd sv2 log category for Stratum v2\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZxiGgACgkQV/+b28ww\nEAkprw//cqPmevjbXi3ZBf6NaOMnkJrlXwV3U/aSRHjbnDZ+NjZ3bG9nLiPvcOF7\neRt687YmRmNuRL296g4LY7eC269Os9vbIKCgP1ggvCJA/AIJW+xtqkViLxlPxHrE\n05MDEkTOzd24tx6Kv6wKIlHlHQFV1/i03TwckcnJ4xrcM2zfNs/jS7YPtP85T/bX\nsxBBTBQl7PfwDCuWpPnxOBFniD4i21o1GVsvJhez41ojU14VLHJ8p2h4E9w8mPsc\nqcxqjYLM796lwaaMj6EvtkKw2jJIrZ5aCBYb9x1uIq+zksO4PRKVa+3AHHSIdIjr\nXDFH3EXPrulTooFmrTxcFZmE/hBu4EsIQOArAwjOBPO4UfV87yXVzQixUg+CWrsf\nTKyAkaeYvzd8PYkrCofkYbroS97b8anijgiZw6moznL+JQM32jio6eautImAqUwc\nqWmREmrNVeqKxMW6vmBqe6LXIi2mT9vngBBhc4WQPVsMi88Abb4Yy+vDpXnqWLHB\nStNnGDmuo0JGiZthV2a5MMrfxAgwz2cOOKlsLGmSV09n/dzPjO6J97vkPZkg6SOD\nSV1h8Es5ONFAREZHoUovxby7ipz0gjY9UMJ3bwUoMhyX3aatKa6kr3Cr5h3xsOFl\nfFzwzOYJ2R/yBbc0lH/WmGA1Ny4HklRMt7XAuwUdEWRA7+yf1nI=\n=t+2C\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9c5cdf07f30f816cd134e2cd2dca9c27ef7067a5",
          "sha": "9c5cdf07f30f816cd134e2cd2dca9c27ef7067a5",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/9c5cdf07f30f816cd134e2cd2dca9c27ef7067a5"
        }
      ],
      "message": "Add sv2 log category for Stratum v2",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-18T13:15:20Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2023-11-30T12:58:48Z"
      },
      "sha": "88847463dfbb73515c57d1b0c50984aa35dba60e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDI0MDQ2ZjExYzhlOWZkMmYxMTFlZGM1OGU5NGVjZDhkOWMyNzYzMWY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/24046f11c8e9fd2f111edc58e94ecd8d9c27631f",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/24046f11c8e9fd2f111edc58e94ecd8d9c27631f",
      "tree": {
        "sha": "85fd37cc1c6adf9ac13ca68557a75d560a02f202",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/85fd37cc1c6adf9ac13ca68557a75d560a02f202"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 85fd37cc1c6adf9ac13ca68557a75d560a02f202\nparent 88847463dfbb73515c57d1b0c50984aa35dba60e\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718730637 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718730637 +0200\n\nAdd sv2 noise protocol\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZxv44ACgkQV/+b28ww\nEAnCZg/+ORHiW2vMAa/Pch/UegH1JQctqpTSfN6NKUJCCXo1Wu9xn/k4YU7nQ7XS\nLJ0pXdSfiyKrJ8Fz0p8L42KqFSwv7EnStOy9f9Y98IpHviQg4H4eVZivaJVqlrSA\nviKIsi/ONymvIAG/LhfoY1yqC+MxA6txHYFdnBH0rfSx77IGU2aY6/WE8KmWaUVN\nzQmNfkJyQjVMXoEf2mKm42pGgn1C5xOf5+X2Q+zjZTIKcBJoYMIMgG7fiBTtmS42\nMJBOJs+Q6F/3XWP7dALNhhQK3Q/8/f8IfpYfrOSOlAaZXZX+S60Bq8VmXiXFN6E7\n+0u7HR/EsKoe5l/bgM3dV9SAUoPyl7B5FDW4jQNyrckJAtJQMabfcl6LjHUl5GCb\nwf/h0q7oYhfeeNeh2XaXY1TwHnM0Sns6ItLL1xgdZVrTq/ha0iOQJTukIplTQ664\nELMmhAgzSRUBxKWjBvhhL/9MMDsKMf4JHEEuO8gGJkX5z69E4K9PtTDFWZzevkRb\nkHaDaXy9nmf8TYEcyMn2d7XLPgcQ4zQjjau3j61fOOfQoT7Qf6OiEA4Za11JSSHh\nJOWTk4HYjessob4nu1XCouFHBzaRB6mQHgv2krkV9FTDcnzSo3FcpaH84ZrSIGAo\n8U3X7mluDo2k9y9qpVW/xhm1PzGepe+v+XdDFn5qElA2YKKXASM=\n=jPoT\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88847463dfbb73515c57d1b0c50984aa35dba60e",
          "sha": "88847463dfbb73515c57d1b0c50984aa35dba60e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/88847463dfbb73515c57d1b0c50984aa35dba60e"
        }
      ],
      "message": "Add sv2 noise protocol\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-18T17:10:37Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-18T17:10:37Z"
      },
      "sha": "24046f11c8e9fd2f111edc58e94ecd8d9c27631f"
    },
    {
      "event": "commented",
      "id": 2181044150,
      "node_id": "IC_kwDOABII586CABe2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2181044150",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T15:59:19Z",
      "updated_at": "2024-06-20T15:59:20Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage\nFor detailed information about the code coverage, see the [test coverage report](https://corecheck.dev/bitcoin/bitcoin/pulls/30315).\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#issuecomment-2181044150",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30315"
    },
    {
      "event": "commented",
      "id": 2181051477,
      "node_id": "IC_kwDOABII586CADRV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2181051477",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T16:03:13Z",
      "updated_at": "2024-06-20T16:03:40Z",
      "author_association": "MEMBER",
      "body": "Would it make sense to add a `libbitcoin_net` library? Either at the same level as `libbitcoin_common` or on top of it. I could see how other node implementations could benefit from that, but it's also a way to limit `libbitcoin_common` in size. Afaik only `libbitcoin_node` needs networking (and `zmq`?), and a future `libbitcoin_sv2`, and maybe `libbitcoin_rpc`.",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#issuecomment-2181051477",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30315"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13231508296,
      "node_id": "HRFPE_lADOABII586M88kQzwAAAAMUqMtI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13231508296",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T16:05:29Z"
    },
    {
      "event": "labeled",
      "id": 13231509069,
      "node_id": "LE_lADOABII586M88kQzwAAAAMUqM5N",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13231509069",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T16:05:33Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2181055856,
      "node_id": "IC_kwDOABII586CAEVw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2181055856",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T16:05:34Z",
      "updated_at": "2024-06-20T16:05:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\n\nðŸš§ At least one of the CI tasks failed. Make sure to run all tests locally, according to the\ndocumentation.\n\nPossibly this is due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/26477378291</sub>",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#issuecomment-2181055856",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/30315"
    },
    {
      "event": "reviewed",
      "id": 2130844873,
      "node_id": "PRR_kwDOABII585_AhzJ",
      "url": null,
      "actor": null,
      "commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#pullrequestreview-2130844873",
      "submitted_at": "2024-06-20T16:07:31Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
    },
    {
      "event": "reviewed",
      "id": 2130848013,
      "node_id": "PRR_kwDOABII585_AikN",
      "url": null,
      "actor": null,
      "commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#pullrequestreview-2130848013",
      "submitted_at": "2024-06-20T16:09:06Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
    },
    {
      "event": "reviewed",
      "id": 2130854214,
      "node_id": "PRR_kwDOABII585_AkFG",
      "url": null,
      "actor": null,
      "commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "commit_url": null,
      "created_at": null,
      "author_association": "MEMBER",
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#pullrequestreview-2130854214",
      "submitted_at": "2024-06-20T16:12:13Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGM4NjdkMzJjZTMwNzc1NDBjN2QyOTBjNjFiOWViNDZiODBkYmE4ODk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c867d32ce3077540c7d290c61b9eb46b80dba889",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/c867d32ce3077540c7d290c61b9eb46b80dba889",
      "tree": {
        "sha": "9eb6369b3190af39595bb83508b898973d31d0da",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9eb6369b3190af39595bb83508b898973d31d0da"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 9eb6369b3190af39595bb83508b898973d31d0da\nparent 24046f11c8e9fd2f111edc58e94ecd8d9c27631f\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718896505 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718900150 +0200\n\nMove CNetMessage and CSerializedNetMsg to Common\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZ0VbYACgkQV/+b28ww\nEAmDdw/+Is1ULvydtC36K61mTNVXdq3qwAIPtdclvza62MBGiKeLsF9ttnKPqmsk\nuqfFp0JjeJnBeFLZMM9pLZUsKOv7ng3Dt8xX1B7RyPCpD6bVQp1heB9NuvlrTkz9\nh3P6mU8th5tnHUR8bNI+BNp8GPTM9K81/qTaDCXMtPPmgmcvGPkm0vPZT8DTxkck\nDaLqvbBNgGUpyj173Zb2tvDjwBDK9A9quDzWxgxcEHjwvmez4tX2/pxkdQALLWFN\nYx9Tvmww1RZTqMASj05IA+LKlzltmH61ngwuE+opeMO09Dx+dwX80kp2qpCpgytz\nNLgIfjnbyjvwZxpiI76qShWSudDNWMJOszOR9lKRmXufhUWsNc+ckuBvwyPejW9S\n/WI/Cwbc/WdS0A5Q1ER72aQLrJwsRCWOvJdEfso8PLS6WSbO2koA18xllqTJhUDq\nn2vOes7BIlLX315mTUokl4krgysHOpqNF18h/WyZXY9LTJ9oDWX275ZMOWWf5vbv\n8jRHAP74ej0vjUDFtwnOQ4VMWT1xLo2fLiDR5LAgLEw8CZ2smpkceZMkLQ3FXI/q\n2O8xrEi6PIi4N1E8+jgMCFdULHQrp93plz//t5GolqcmkdGUgzOnqFQXjp7S+IIF\nvF+G2U9Avb/puN5jFIM5kVRNG0n2EY45woVSzfCMRFnguoyK1bE=\n=36D/\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/24046f11c8e9fd2f111edc58e94ecd8d9c27631f",
          "sha": "24046f11c8e9fd2f111edc58e94ecd8d9c27631f",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/24046f11c8e9fd2f111edc58e94ecd8d9c27631f"
        }
      ],
      "message": "Move CNetMessage and CSerializedNetMsg to Common",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T16:15:50Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T15:15:05Z"
      },
      "sha": "c867d32ce3077540c7d290c61b9eb46b80dba889"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDYwMTE2OTgyNDQ4MzUxMDljNTMyZDFhMzFmMjRlYTc1MGQ1ZDYzMDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6011698244835109c532d1a31f24ea750d5d6307",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6011698244835109c532d1a31f24ea750d5d6307",
      "tree": {
        "sha": "0ab5a909253d785f25d8ceaa2242bd8f43d2cba5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0ab5a909253d785f25d8ceaa2242bd8f43d2cba5"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 0ab5a909253d785f25d8ceaa2242bd8f43d2cba5\nparent c867d32ce3077540c7d290c61b9eb46b80dba889\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718898258 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718900150 +0200\n\nMove connection_types.h to Common\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZ0VbYACgkQV/+b28ww\nEAnyxQ/8DJdmq54GzhRSZ+wXqiaayyh7zu1VROJifT19XZGDwtXX0TLs6VfeUT5S\ni3Cv3+zOGeXLA5StRmzycxXbRMCeAItGiedGJ6ulxKhqn8qFBMzp8/tjdGF87N+y\nFXqxRrPjPGIB/GP0QGTM+6EvFfRFzX3jGYYMWQbDeDt+i3owof+gv3h9bdYGH4S3\nVARfnd5NYLjz3wdZgOBm+2XZ5fQw1CO85B1ogGgo01IM82HTsSkSHLdjfWU9n3Qt\n5825RUuA4gHMTp7qZesBG4Qbxeo90ihmY5+NBQ17M+30zLbH+ZRaBY9mNUDz4p5F\nhe6GSI24tRHQxkMJCC/9keapAHlkTfbv0nXVj+LPA4vo6zGU2vdon8eVd1R5Fv+u\njvqLynvAmDp40emO/6bZpx+DItP9vPOzW0Ve+sdJb3qqzmUrfsXnseT+pMmeBe5x\nhWN2fH5nZNRGZpVo6nD4163dYMFCntR/GWvnLel5187qw0stUD9UupGvgCrzy+vn\n1xFiEj3RRMmfUyr29kaaRR+3tkeqS1bSVemR8LmDtooxh/xs+JN9LaX7ydGIQI8j\nCwWWUoAwlXLvbAJy09s5ZRGkmgkRo5NTWL3Ab7qrdEo8K0B3UNnIFoYvERqJxu0o\nCp/Sv4z/SeAGVL/XZ8C8XtF0Otz9NEKrffd8mmZqX15Y7Mdh24w=\n=sq8u\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c867d32ce3077540c7d290c61b9eb46b80dba889",
          "sha": "c867d32ce3077540c7d290c61b9eb46b80dba889",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/c867d32ce3077540c7d290c61b9eb46b80dba889"
        }
      ],
      "message": "Move connection_types.h to Common",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T16:15:50Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T15:44:18Z"
      },
      "sha": "6011698244835109c532d1a31f24ea750d5d6307"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGFjODQxYjkyY2UzZWU2NTZhZmQ5Y2I1NDc3NzAzZThkZGE4ZmY4YzQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ac841b92ce3ee656afd9cb5477703e8dda8ff8c4",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/ac841b92ce3ee656afd9cb5477703e8dda8ff8c4",
      "tree": {
        "sha": "5c1dd7bc28a1117da0590fb0072d48e6f3de40a3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5c1dd7bc28a1117da0590fb0072d48e6f3de40a3"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 5c1dd7bc28a1117da0590fb0072d48e6f3de40a3\nparent 6011698244835109c532d1a31f24ea750d5d6307\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718897484 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718900151 +0200\n\nMove Transport to Common\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZ0VbcACgkQV/+b28ww\nEAnh/Q//blbUGIr5+5cJ/l2U9PiIXA20pnRRe1bAVby9kzxVs9PWsTNANMhtxzh9\nfLO0pex+ghqZDGGNnDgkxeG1bjIO2gbxDxjBGDZFltilQ7hmzJcOj1EiwhKHHHPq\nQv2e6sTNesCSxGOYBjRloY8teXQu05XLXO1Lv/XzcOfWnibi/hJFyZzdMEmYasf2\noiNB1oAPT8nBi7phu47HS1i/4pMb8dVU23buyJt84gU2FDYQnZ/3PbxhbnB+jB+n\nBPRE3kxDnshAyXSPBMbPkXh0fdx48QpfC6UT6+I7shetT+cPRVfVzuh44Y1dZPDN\norrW3vP8gaSSif0y6j9J0XGVhGmiaBHeSY9HdZF6pVUoQMCalHFm+EBq37+NVY8v\n3ll0NP5csOkAkb+ALsP3sLEGYLM1Mi7wMsmKg0m/APqQeOHa9/nveUGZH2VigYa6\nBU0bwG7qeiRqSTzTUmrGKLNNzlD6mc3wtH07TMdEwcDXCGGVxqVQCY8tGWR1hG0r\nvUG8mDb5ULJrogJtiUUyOibQdZzJO5qHckmxqu6tweJb+UN9al3ioXklKYeZA7My\n6vHPH5U0W6z0F42CdakyxbOsYpQXq94fZwNi/qGUKGSfLuCL9ffDXOfzG8UD0edh\nd2vSKx2gpw753izcXWsXxxPsZ0L5zVSKlM5/Uj7FU79MFqdeecg=\n=fPII\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6011698244835109c532d1a31f24ea750d5d6307",
          "sha": "6011698244835109c532d1a31f24ea750d5d6307",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/6011698244835109c532d1a31f24ea750d5d6307"
        }
      ],
      "message": "Move Transport to Common",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T16:15:51Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T15:31:24Z"
      },
      "sha": "ac841b92ce3ee656afd9cb5477703e8dda8ff8c4"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGJiZjA4YmRkODRkYzZjYjQ3YTczMTc5MjViOTE5NTVhNjIxZjlkYWE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bbf08bdd84dc6cb47a7317925b91955a621f9daa",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bbf08bdd84dc6cb47a7317925b91955a621f9daa",
      "tree": {
        "sha": "9d623ba78fa67a2c1a5542041a1059e6e159dd22",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9d623ba78fa67a2c1a5542041a1059e6e159dd22"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 9d623ba78fa67a2c1a5542041a1059e6e159dd22\nparent ac841b92ce3ee656afd9cb5477703e8dda8ff8c4\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718889964 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718900151 +0200\n\nAdd sv2 message CoinbaseOutputDataSize\n\nThis commit adds the simplest stratum v2 message. The remaining messages are introduced in later commits.\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZ0VbcACgkQV/+b28ww\nEAn9GA//ZQu6LzAJoK5rhz6P6Uav5fjLMGY1+uvhoKS41i41lodH94meBM2ifJDe\nYcpV9XFDac5Cynu0Fs9AwY93tKBxKbTeNJ2Cqr+8qEdDnyXgsoSAfFIMYc1pHvUu\n3JFjTwMZXA4DqgHQnRjqCfPi9LZrj4VYXUOpGRmn2P+pETj0nvDfUO8NHgnWo4Xi\nA5tzRKxzcdF7Ipu4hcwfRkJ2reF1TyPpDhRcSVPgFmLI8HkOUcqpwuWKUr/PvsXt\nHnmcFbHCSXiiAmSR9gwxgEkPfwV/5+XcD6GozRbNIxBqt6k5wwQpLFsRgbmDEanC\n7R0/Wl5WeQp/cQ8QwgxvN1MRnjrAsIRbYah0wPqyvuNbSlPIhgPkhZhvXrdfjFV1\nrbLmE+87W743xrxabBzM7vnaJysh/2ghfQiL0anS3JJyw4prLfoTOvdnUGrcjpz3\nhH+005MfqQvcoTI0UaWE9lquW6Isnm6dAe7e4/XSjw+lgEtlXTBLWCnVcitAzPPE\nn4qiEeW5/i0TW5tDf3zvum+Bqzm2NWHzilSGTBH2LHte4bl2ObA/Iddcq4mAc08n\n8gqJLmVAR9Nr3dX5k3I+03QJUE63YKddfPQkCVnpBn6VGYFaRy2HnvTOF4DT03N/\nDbPf6HtJCMFEZIS88IE1eHVhd1QLLwEQS+Z0chq3OIQhmA0bKQg=\n=Blt4\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ac841b92ce3ee656afd9cb5477703e8dda8ff8c4",
          "sha": "ac841b92ce3ee656afd9cb5477703e8dda8ff8c4",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/ac841b92ce3ee656afd9cb5477703e8dda8ff8c4"
        }
      ],
      "message": "Add sv2 message CoinbaseOutputDataSize\n\nThis commit adds the simplest stratum v2 message. The remaining messages are introduced in later commits.\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T16:15:51Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T13:26:04Z"
      },
      "sha": "bbf08bdd84dc6cb47a7317925b91955a621f9daa"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDExMzI4MDc1ZmUxNzgzMTYzZmE1ZDMxMTNhMzdmNmIyMGNjZDRjNDM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "tree": {
        "sha": "958b77a28fa1b324394fb612eac11cc7c4af1009",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/958b77a28fa1b324394fb612eac11cc7c4af1009"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 958b77a28fa1b324394fb612eac11cc7c4af1009\nparent bbf08bdd84dc6cb47a7317925b91955a621f9daa\nauthor Sjors Provoost <sjors@sprovoost.nl> 1718894770 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1718900151 +0200\n\nIntroduce Sv2Transport\n\nImplemented starting from a copy of V2Transport and the V2TransportTester, modifying it to fit Stratum v2 and Noise Protocol requirements.\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>\nCo-Authored-By: Fi3\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAmZ0VbcACgkQV/+b28ww\nEAkpjw/+MKle0NBgzLLOaJehNb8m2pLZAm/RM63L4xpmMDIVkCDBCurRGdS8OkrW\n5/luGl6poPZhwtLXcL3Xc6oSOA0V1jsKpD4/pG8nZ9KyTmmQqlg2KKe/Rd1cXGZh\nYDsg9bT6RxW+wGSizLQsAyMACspsBtQzAfrX1Crb/SD5dM6+5TLItIJFkBfEihqp\nilC4t+oecc/5WYAaIhzu2PFUDOuEOsVdNfIrEWynAp4MwW7/5d4w9dJgN3fPtW9u\nOeenRhlUsApxyKyRBJAmqy1eenuqvrnL6MNO43VBNcCvYEDNnZApguRpy3W77Uba\njYo8G1v3Z1uKYmGwwkuo/sEpfdlDRxzjEgHda8zAWeT8id7gLJCQMSIFJlbwa3Dr\nVcST4E/cclYU6vh1w/4GkqmUFAHANVqcQLoZTzZDjJtr5Wj4MCVKC1P0bUgkh0qo\nC6SXG6JWKSAV6LBknPdTKV3vStYromohmMz+sYBa/lORN3IMKrFRmd1Q5GaH4uyp\nXv/dC/AsqJsAMXsfI5Gh/kc5oUUOZ0mTo0WNidGvn/xde1mSXXRY1i8eWabMFgnk\nloi2ajzmdb250cWsX+Op+xbtJiWesWtq/jAk3ouhc+ZrZj0xnKl9Q73IcZ+DsEMP\nE2O47OcHtkAf7OW/6hDyPK2GxaO0G/Cyc3bjTyyM7ZXDI7PnQ3o=\n=FClY\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bbf08bdd84dc6cb47a7317925b91955a621f9daa",
          "sha": "bbf08bdd84dc6cb47a7317925b91955a621f9daa",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bbf08bdd84dc6cb47a7317925b91955a621f9daa"
        }
      ],
      "message": "Introduce Sv2Transport\n\nImplemented starting from a copy of V2Transport and the V2TransportTester, modifying it to fit Stratum v2 and Noise Protocol requirements.\n\nCo-Authored-By: Christopher Coverdale <chris.coverdale24@gmail.com>\nCo-Authored-By: Fi3",
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T16:15:51Z"
      },
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2024-06-20T14:46:10Z"
      },
      "sha": "11328075fe1783163fa5d3113a37f6b20ccd4c43"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 13231627367,
      "node_id": "HRFPE_lADOABII586M88kQzwAAAAMUqpxn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/13231627367",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-06-20T16:15:58Z"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647820313",
      "pull_request_review_id": 2130844873,
      "id": 1647820313,
      "node_id": "PRRC_kwDOABII585iN74Z",
      "diff_hunk": "@@ -0,0 +1,513 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <common/sv2_transport.h>\n+\n+#include <common/net_message.h>\n+#include <logging.h>\n+#include <memusage.h>\n+#include <common/sv2_messages.h>\n+#include <common/sv2_noise.h>\n+#include <random.h>\n+#include <util/check.h>\n+#include <util/strencodings.h>\n+#include <util/vector.h>\n+\n+Sv2Transport::Sv2Transport(CKey static_key, Sv2SignatureNoiseMessage certificate) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), std::move(certificate))}, m_initiating{false},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_1},\n+      m_send_state{SendState::HANDSHAKE_STEP_2},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                    RecvStateAsString(m_recv_state));\n+}\n+\n+Sv2Transport::Sv2Transport(CKey static_key, XOnlyPubKey responder_authority_key) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), responder_authority_key)}, m_initiating{true},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_2},\n+      m_send_state{SendState::HANDSHAKE_STEP_1},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    /** Start sending immediately since we're the initiator of the connection.\n+        This only happens in test code.\n+    */\n+    LOCK(m_send_mutex);\n+    StartSendingHandshake();\n+\n+}\n+\n+void Sv2Transport::SetReceiveState(RecvState recv_state) noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_recv_state) {\n+    case RecvState::HANDSHAKE_STEP_1:\n+        Assume(recv_state == RecvState::HANDSHAKE_STEP_2);\n+        break;\n+    case RecvState::HANDSHAKE_STEP_2:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    case RecvState::APP:\n+        Assume(recv_state == RecvState::APP_READY);\n+        break;\n+    case RecvState::APP_READY:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    }\n+    // Change state.\n+    m_recv_state = recv_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                  RecvStateAsString(m_recv_state));\n+\n+}\n+\n+void Sv2Transport::SetSendState(SendState send_state) noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_send_state) {\n+    case SendState::HANDSHAKE_STEP_1:\n+        Assume(send_state == SendState::HANDSHAKE_STEP_2);\n+        break;\n+    case SendState::HANDSHAKE_STEP_2:\n+        Assume(send_state == SendState::READY);\n+        break;\n+    case SendState::READY:\n+        Assume(false); // Final state\n+        break;\n+    }\n+    // Change state.\n+    m_send_state = send_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session send state -> %s\\n\",\n+                  SendStateAsString(m_send_state));\n+}\n+\n+void Sv2Transport::StartSendingHandshake() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_1);\n+    Assume(m_send_buffer.empty());\n+\n+    m_send_buffer.resize(Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgEphemeralPK(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_send_state = SendState::HANDSHAKE_STEP_2;\n+}\n+\n+void Sv2Transport::SendHandshakeReply() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_2);\n+\n+    Assume(m_send_buffer.empty());\n+    m_send_buffer.resize(Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgES(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_cipher.FinishHandshake();\n+\n+    // LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"m_hash: %s\\n\", HexStr(m_cipher.m_hash));\n+\n+    // We can send and receive stuff now, unless the other side hangs up\n+    SetSendState(SendState::READY);\n+    Assume(m_recv_state == RecvState::HANDSHAKE_STEP_2);\n+    SetReceiveState(RecvState::APP);\n+}\n+\n+Transport::BytesToSend Sv2Transport::GetBytesToSend(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    assert(false);\n+\n+    return {\n+        Span{m_send_buffer}.subspan(0,0),\n+        false,\n+        m_send_type\n+    };\n+}\n+\n+Sv2Transport::Sv2BytesToSend Sv2Transport::GetBytesToSendSv2(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    Assume(m_send_pos <= m_send_buffer.size());\n+    return {\n+        Span{m_send_buffer}.subspan(m_send_pos),\n+        // We only have more to send after the current m_send_buffer if there is a (next)\n+        // message to be sent, and we're capable of sending packets. */\n+        have_next_message && m_send_state == SendState::READY\n+    };\n+}\n+\n+void Sv2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    // if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+    //     LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    // }\n+\n+    m_send_pos += bytes_sent;\n+    Assume(m_send_pos <= m_send_buffer.size());\n+    // Wipe the buffer when everything is sent.\n+    if (m_send_pos == m_send_buffer.size()) {\n+        m_send_pos = 0;\n+        ClearShrink(m_send_buffer);\n+    }\n+}\n+\n+bool Sv2Transport::SetMessageToSend(CSerializedNetMsg& msg) noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    // We only allow adding a new message to be sent when in the READY state (so the packet cipher\n+    // is available) and the send buffer is empty. This limits the number of messages in the send\n+    // buffer to just one, and leaves the responsibility for queueing them up to the caller.\n+    if (m_send_state != SendState::READY) {\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"SendState is not READY\\n\");\n+        return false;\n+    }\n+\n+    if (!m_send_buffer.empty()) {\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Send buffer is not empty\\n\");\n+        return false;\n+    }\n+\n+    // The Sv2NetMsg is wrapped inside a dummy CSerializedNetMsg, extract it:\n+    Assume(msg.m_type == \"\");\n+    Sv2NetMsg sv2_msg;\n+    // sv2_msg << msg.data;",
      "path": "src/common/sv2_transport.cpp",
      "position": 185,
      "original_position": 185,
      "commit_id": "11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "original_commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "11328075fe1783163fa5d3113a37f6b20ccd4c43: @sipa any thoughts on how to best do this?",
      "created_at": "2024-06-20T16:07:31Z",
      "updated_at": "2024-06-20T16:16:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#discussion_r1647820313",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647820313"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 185,
      "original_line": 185,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647822168",
      "pull_request_review_id": 2130848013,
      "id": 1647822168,
      "node_id": "PRRC_kwDOABII585iN8VY",
      "diff_hunk": "@@ -0,0 +1,513 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <common/sv2_transport.h>\n+\n+#include <common/net_message.h>\n+#include <logging.h>\n+#include <memusage.h>\n+#include <common/sv2_messages.h>\n+#include <common/sv2_noise.h>\n+#include <random.h>\n+#include <util/check.h>\n+#include <util/strencodings.h>\n+#include <util/vector.h>\n+\n+Sv2Transport::Sv2Transport(CKey static_key, Sv2SignatureNoiseMessage certificate) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), std::move(certificate))}, m_initiating{false},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_1},\n+      m_send_state{SendState::HANDSHAKE_STEP_2},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                    RecvStateAsString(m_recv_state));\n+}\n+\n+Sv2Transport::Sv2Transport(CKey static_key, XOnlyPubKey responder_authority_key) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), responder_authority_key)}, m_initiating{true},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_2},\n+      m_send_state{SendState::HANDSHAKE_STEP_1},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    /** Start sending immediately since we're the initiator of the connection.\n+        This only happens in test code.\n+    */\n+    LOCK(m_send_mutex);\n+    StartSendingHandshake();\n+\n+}\n+\n+void Sv2Transport::SetReceiveState(RecvState recv_state) noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_recv_state) {\n+    case RecvState::HANDSHAKE_STEP_1:\n+        Assume(recv_state == RecvState::HANDSHAKE_STEP_2);\n+        break;\n+    case RecvState::HANDSHAKE_STEP_2:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    case RecvState::APP:\n+        Assume(recv_state == RecvState::APP_READY);\n+        break;\n+    case RecvState::APP_READY:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    }\n+    // Change state.\n+    m_recv_state = recv_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                  RecvStateAsString(m_recv_state));\n+\n+}\n+\n+void Sv2Transport::SetSendState(SendState send_state) noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_send_state) {\n+    case SendState::HANDSHAKE_STEP_1:\n+        Assume(send_state == SendState::HANDSHAKE_STEP_2);\n+        break;\n+    case SendState::HANDSHAKE_STEP_2:\n+        Assume(send_state == SendState::READY);\n+        break;\n+    case SendState::READY:\n+        Assume(false); // Final state\n+        break;\n+    }\n+    // Change state.\n+    m_send_state = send_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session send state -> %s\\n\",\n+                  SendStateAsString(m_send_state));\n+}\n+\n+void Sv2Transport::StartSendingHandshake() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_1);\n+    Assume(m_send_buffer.empty());\n+\n+    m_send_buffer.resize(Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgEphemeralPK(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_send_state = SendState::HANDSHAKE_STEP_2;\n+}\n+\n+void Sv2Transport::SendHandshakeReply() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_2);\n+\n+    Assume(m_send_buffer.empty());\n+    m_send_buffer.resize(Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgES(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_cipher.FinishHandshake();\n+\n+    // LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"m_hash: %s\\n\", HexStr(m_cipher.m_hash));\n+\n+    // We can send and receive stuff now, unless the other side hangs up\n+    SetSendState(SendState::READY);\n+    Assume(m_recv_state == RecvState::HANDSHAKE_STEP_2);\n+    SetReceiveState(RecvState::APP);\n+}\n+\n+Transport::BytesToSend Sv2Transport::GetBytesToSend(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    assert(false);\n+\n+    return {\n+        Span{m_send_buffer}.subspan(0,0),\n+        false,\n+        m_send_type\n+    };\n+}\n+\n+Sv2Transport::Sv2BytesToSend Sv2Transport::GetBytesToSendSv2(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    Assume(m_send_pos <= m_send_buffer.size());\n+    return {\n+        Span{m_send_buffer}.subspan(m_send_pos),\n+        // We only have more to send after the current m_send_buffer if there is a (next)\n+        // message to be sent, and we're capable of sending packets. */\n+        have_next_message && m_send_state == SendState::READY\n+    };\n+}\n+\n+void Sv2Transport::MarkBytesSent(size_t bytes_sent) noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    // if (m_send_state == SendState::AWAITING_KEY && m_send_pos == 0 && bytes_sent > 0) {\n+    //     LogPrint(BCLog::NET, \"start sending v2 handshake to peer=%d\\n\", m_nodeid);\n+    // }\n+\n+    m_send_pos += bytes_sent;\n+    Assume(m_send_pos <= m_send_buffer.size());\n+    // Wipe the buffer when everything is sent.\n+    if (m_send_pos == m_send_buffer.size()) {\n+        m_send_pos = 0;\n+        ClearShrink(m_send_buffer);\n+    }\n+}\n+\n+bool Sv2Transport::SetMessageToSend(CSerializedNetMsg& msg) noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    // We only allow adding a new message to be sent when in the READY state (so the packet cipher\n+    // is available) and the send buffer is empty. This limits the number of messages in the send\n+    // buffer to just one, and leaves the responsibility for queueing them up to the caller.\n+    if (m_send_state != SendState::READY) {\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"SendState is not READY\\n\");\n+        return false;\n+    }\n+\n+    if (!m_send_buffer.empty()) {\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Send buffer is not empty\\n\");\n+        return false;\n+    }\n+\n+    // The Sv2NetMsg is wrapped inside a dummy CSerializedNetMsg, extract it:\n+    Assume(msg.m_type == \"\");\n+    Sv2NetMsg sv2_msg;\n+    // sv2_msg << msg.data;\n+\n+    // Construct ciphertext in send buffer.\n+    const size_t encrypted_msg_size = Sv2Cipher::EncryptedMessageSize(sv2_msg.m_msg.size());\n+    m_send_buffer.resize(SV2_HEADER_ENCRYPTED_SIZE + encrypted_msg_size);\n+    Span<std::byte> buffer_span{MakeWritableByteSpan(m_send_buffer)};\n+\n+    // Header\n+    DataStream ss_header_plain{};\n+    ss_header_plain << sv2_msg.m_sv2_header;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Header: %s\\n\", HexStr(ss_header_plain));\n+    Span<std::byte> header_encrypted{buffer_span.subspan(0, SV2_HEADER_ENCRYPTED_SIZE)};\n+    if (!m_cipher.EncryptMessage(ss_header_plain, header_encrypted)) {\n+        return false;\n+    }\n+\n+    // Payload\n+    Span<std::byte> payload_plain = MakeWritableByteSpan(sv2_msg.m_msg);\n+    // TODO: truncate very long messages, about 100 bytes at the start and end\n+    //       is probably enough for most debugging.\n+    // LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Payload: %s\\n\", HexStr(payload_plain));\n+    Span<std::byte> payload_encrypted{buffer_span.subspan(SV2_HEADER_ENCRYPTED_SIZE, encrypted_msg_size)};\n+    if (!m_cipher.EncryptMessage(payload_plain, payload_encrypted)) {\n+        return false;\n+    }\n+\n+    // Release memory\n+    ClearShrink(msg.data);\n+\n+    return true;\n+}\n+\n+size_t Sv2Transport::GetSendMemoryUsage() const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    return sizeof(m_send_buffer) + memusage::DynamicUsage(m_send_buffer);\n+}\n+\n+bool Sv2Transport::ReceivedBytes(Span<const uint8_t>& msg_bytes) noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    /** How many bytes to allocate in the receive buffer at most above what is received so far. */\n+    static constexpr size_t MAX_RESERVE_AHEAD = 256 * 1024; // TODO: reduce to NOISE_MAX_CHUNK_SIZE?\n+\n+    LOCK(m_recv_mutex);\n+    // Process the provided bytes in msg_bytes in a loop. In each iteration a nonzero number of\n+    // bytes (decided by GetMaxBytesToProcess) are taken from the beginning om msg_bytes, and\n+    // appended to m_recv_buffer. Then, depending on the receiver state, one of the\n+    // ProcessReceived*Bytes functions is called to process the bytes in that buffer.\n+    while (!msg_bytes.empty()) {\n+        // Decide how many bytes to copy from msg_bytes to m_recv_buffer.\n+        size_t max_read = GetMaxBytesToProcess();\n+\n+        // Reserve space in the buffer if there is not enough.\n+        if (m_recv_buffer.size() + std::min(msg_bytes.size(), max_read) > m_recv_buffer.capacity()) {\n+            switch (m_recv_state) {\n+            case RecvState::HANDSHAKE_STEP_1:\n+                m_recv_buffer.reserve(Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+                break;\n+            case RecvState::HANDSHAKE_STEP_2:\n+                m_recv_buffer.reserve(Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+                break;\n+            case RecvState::APP: {\n+                // During states where a packet is being received, as much as is expected but never\n+                // more than MAX_RESERVE_AHEAD bytes in addition to what is received so far.\n+                // This means attackers that want to cause us to waste allocated memory are limited\n+                // to MAX_RESERVE_AHEAD above the largest allowed message contents size, and to\n+                // MAX_RESERVE_AHEAD more than they've actually sent us.\n+                size_t alloc_add = std::min(max_read, msg_bytes.size() + MAX_RESERVE_AHEAD);\n+                m_recv_buffer.reserve(m_recv_buffer.size() + alloc_add);\n+                break;\n+            }\n+            case RecvState::APP_READY:\n+                // The buffer is empty in this state.\n+                Assume(m_recv_buffer.empty());\n+                break;\n+            }\n+        }\n+\n+        // Can't read more than provided input.\n+        max_read = std::min(msg_bytes.size(), max_read);\n+        // Copy data to buffer.\n+        m_recv_buffer.insert(m_recv_buffer.end(), UCharCast(msg_bytes.data()), UCharCast(msg_bytes.data() + max_read));\n+        msg_bytes = msg_bytes.subspan(max_read);\n+\n+        // Process data in the buffer.\n+        switch (m_recv_state) {\n+\n+        case RecvState::HANDSHAKE_STEP_1:\n+            if (!ProcessReceivedEphemeralKeyBytes()) return false;\n+            break;\n+\n+        case RecvState::HANDSHAKE_STEP_2:\n+            if (!ProcessReceivedHandshakeReplyBytes()) return false;\n+            break;\n+\n+        case RecvState::APP:\n+            if (!ProcessReceivedPacketBytes()) return false;\n+            break;\n+\n+        case RecvState::APP_READY:\n+            return true;\n+\n+        }\n+        // Make sure we have made progress before continuing.\n+        Assume(max_read > 0);\n+    }\n+\n+    return true;\n+}\n+\n+bool Sv2Transport::ProcessReceivedEphemeralKeyBytes() noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    AssertLockNotHeld(m_send_mutex);\n+    Assume(m_recv_state == RecvState::HANDSHAKE_STEP_1);\n+    Assume(m_recv_buffer.size() <= Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+\n+    if (m_recv_buffer.size() == Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE) {\n+        // Other side's key has been fully received, and can now be Diffie-Hellman\n+        // combined with our key. This is act 1 of the Noise Protocol handshake.\n+        // TODO handle failure\n+        // TODO: MakeByteSpan instead of MakeWritableByteSpan\n+        m_cipher.GetHandshakeState().ReadMsgEphemeralPK(MakeWritableByteSpan(m_recv_buffer));\n+        m_recv_buffer.clear();\n+        SetReceiveState(RecvState::HANDSHAKE_STEP_2);\n+\n+        LOCK(m_send_mutex);\n+        Assume(m_send_buffer.size() == 0);\n+\n+        // Send our act 2 handshake\n+        SendHandshakeReply();\n+    } else {\n+        // We still have to receive more key bytes.\n+    }\n+    return true;\n+}\n+\n+bool Sv2Transport::ProcessReceivedHandshakeReplyBytes() noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    AssertLockNotHeld(m_send_mutex);\n+    Assume(m_recv_state == RecvState::HANDSHAKE_STEP_2);\n+    Assume(m_recv_buffer.size() <= Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+\n+    if (m_recv_buffer.size() == Sv2HandshakeState::HANDSHAKE_STEP2_SIZE) {\n+        // TODO handle failure\n+        // TODO: MakeByteSpan instead of MakeWritableByteSpan\n+        bool res = m_cipher.GetHandshakeState().ReadMsgES(MakeWritableByteSpan(m_recv_buffer));\n+        if (!res) return false;\n+        m_recv_buffer.clear();\n+        m_cipher.FinishHandshake();\n+        SetReceiveState(RecvState::APP);\n+\n+        LOCK(m_send_mutex);\n+        Assume(m_send_buffer.size() == 0);\n+\n+        SetSendState(SendState::READY);\n+    } else {\n+        // We still have to receive more key bytes.\n+    }\n+    return true;\n+}\n+\n+size_t Sv2Transport::GetMaxBytesToProcess() noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    switch (m_recv_state) {\n+    case RecvState::HANDSHAKE_STEP_1:\n+        // In this state, we only allow the 64-byte key into the receive buffer.\n+        Assume(m_recv_buffer.size() <= Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+        return Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE - m_recv_buffer.size();\n+    case RecvState::HANDSHAKE_STEP_2:\n+        // In this state, we only allow the handshake reply into the receive buffer.\n+        Assume(m_recv_buffer.size() <= Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+        return Sv2HandshakeState::HANDSHAKE_STEP2_SIZE - m_recv_buffer.size();\n+    case RecvState::APP:\n+        // Decode a packet. Process the header first,\n+        // so that we know where the current packet ends (and we don't process bytes from the next\n+        // packet yet). Then, process the ciphertext bytes of the current packet.\n+        if (m_recv_buffer.size() < SV2_HEADER_ENCRYPTED_SIZE) {\n+            return SV2_HEADER_ENCRYPTED_SIZE - m_recv_buffer.size();\n+        } else {\n+            // When transitioning from receiving the packet length to receiving its ciphertext,\n+            // the encrypted header is left in the receive buffer.\n+            size_t expanded_size_with_header = SV2_HEADER_ENCRYPTED_SIZE + Sv2Cipher::EncryptedMessageSize(m_header.m_msg_len);\n+            return expanded_size_with_header - m_recv_buffer.size();\n+        }\n+    case RecvState::APP_READY:\n+        // No bytes can be processed until GetMessage() is called.\n+        return 0;\n+    }\n+    Assume(false); // unreachable\n+    return 0;\n+}\n+\n+bool Sv2Transport::ProcessReceivedPacketBytes() noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    Assume(m_recv_state == RecvState::APP);\n+\n+    // The maximum permitted decrypted payload size for a packet\n+    static constexpr size_t MAX_CONTENTS_LEN = 16777215; // 24 bit unsigned;\n+\n+    Assume(m_recv_buffer.size() <= SV2_HEADER_ENCRYPTED_SIZE || m_header.m_msg_len > 0);\n+\n+    if (m_recv_buffer.size() == SV2_HEADER_ENCRYPTED_SIZE) {\n+        // Header received, decrypt it.\n+        std::array<std::byte, SV2_HEADER_PLAIN_SIZE> header_plain;\n+        if  (!m_cipher.DecryptMessage(MakeWritableByteSpan(m_recv_buffer), header_plain)) {\n+            LogPrintLevel(BCLog::SV2, BCLog::Level::Debug, \"Failed to decrypt header\\n\");\n+            return false;\n+        }\n+\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Header: %s\\n\", HexStr(header_plain));\n+\n+        // Decode header\n+        DataStream ss_header{header_plain};\n+        node::Sv2NetHeader header;\n+        ss_header >> header;\n+        m_header = std::move(header);\n+\n+        // TODO: 16 MB is pretty large, maybe set lower limits for most or all message types?\n+        if (m_header.m_msg_len > MAX_CONTENTS_LEN) {\n+            LogTrace(BCLog::SV2, \"Packet too large (%u bytes)\\n\", m_header.m_msg_len);\n+            return false;\n+        }\n+\n+        // Disconnect for empty messages (TODO: check the spec)\n+        if (m_header.m_msg_len == 0) {\n+            LogTrace(BCLog::SV2, \"Empty message\\n\");\n+            return false;\n+        }\n+        LogTrace(BCLog::SV2, \"Expecting %d bytes payload (plain)\\n\", m_header.m_msg_len);\n+    } else if (m_recv_buffer.size() > SV2_HEADER_ENCRYPTED_SIZE &&\n+               m_recv_buffer.size() == SV2_HEADER_ENCRYPTED_SIZE + Sv2Cipher::EncryptedMessageSize(m_header.m_msg_len)) {\n+        /** Ciphertext received: decrypt into decode_buffer and deserialize into m_message.\n+          *\n+          * Note that it is impossible to reach this branch without hitting the\n+          * branch above first, as GetMaxBytesToProcess only allows up to\n+          * SV2_HEADER_ENCRYPTED_SIZE into the buffer before that point. */\n+        std::vector<std::uint8_t> payload;\n+        payload.resize(m_header.m_msg_len);\n+\n+        Span<std::byte> recv_span{MakeWritableByteSpan(m_recv_buffer).subspan(SV2_HEADER_ENCRYPTED_SIZE)};\n+        if (!m_cipher.DecryptMessage(recv_span, MakeWritableByteSpan(payload))) {\n+            LogPrintLevel(BCLog::SV2, BCLog::Level::Debug, \"Failed to decrypt message payload\\n\");\n+            return false;\n+        }\n+        LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Payload: %s\\n\", HexStr(payload));\n+\n+        // Wipe the receive buffer where the next packet will be received into.\n+        ClearShrink(m_recv_buffer);\n+\n+        Sv2NetMsg message{std::move(m_header), std::move(payload)};\n+        m_message = std::move(message);\n+\n+        // At this point we have a valid message decrypted into m_message.\n+        SetReceiveState(RecvState::APP_READY);\n+    } else {\n+        // We either have less than 22 bytes, so we don't know the packet's length yet, or more\n+        // than 22 bytes but less than the packet's full ciphertext. Wait until those arrive.\n+        LogTrace(BCLog::SV2, \"Waiting for more bytes\\n\");\n+    }\n+    return true;\n+}\n+\n+bool Sv2Transport::ReceivedMessageComplete() const noexcept\n+{\n+    AssertLockNotHeld(m_recv_mutex);\n+    LOCK(m_recv_mutex);\n+\n+    return m_recv_state == RecvState::APP_READY;\n+}\n+\n+CNetMessage Sv2Transport::GetReceivedMessage(std::chrono::microseconds time, bool& reject_message) noexcept\n+{\n+    AssertLockNotHeld(m_recv_mutex);\n+    assert(false);",
      "path": "src/common/sv2_transport.cpp",
      "position": 466,
      "original_position": 466,
      "commit_id": "11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "original_commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "11328075fe1783163fa5d3113a37f6b20ccd4c43: TODO: shoehorn our `Sv2NetMsg` into a dummy `CNetMessage`.",
      "created_at": "2024-06-20T16:09:06Z",
      "updated_at": "2024-06-20T16:16:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#discussion_r1647822168",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647822168"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 466,
      "original_line": 466,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647825951",
      "pull_request_review_id": 2130854214,
      "id": 1647825951,
      "node_id": "PRRC_kwDOABII585iN9Qf",
      "diff_hunk": "@@ -0,0 +1,513 @@\n+// Copyright (c) 2023-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <common/sv2_transport.h>\n+\n+#include <common/net_message.h>\n+#include <logging.h>\n+#include <memusage.h>\n+#include <common/sv2_messages.h>\n+#include <common/sv2_noise.h>\n+#include <random.h>\n+#include <util/check.h>\n+#include <util/strencodings.h>\n+#include <util/vector.h>\n+\n+Sv2Transport::Sv2Transport(CKey static_key, Sv2SignatureNoiseMessage certificate) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), std::move(certificate))}, m_initiating{false},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_1},\n+      m_send_state{SendState::HANDSHAKE_STEP_2},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                    RecvStateAsString(m_recv_state));\n+}\n+\n+Sv2Transport::Sv2Transport(CKey static_key, XOnlyPubKey responder_authority_key) noexcept\n+    : m_cipher{Sv2Cipher(std::move(static_key), responder_authority_key)}, m_initiating{true},\n+      m_recv_state{RecvState::HANDSHAKE_STEP_2},\n+      m_send_state{SendState::HANDSHAKE_STEP_1},\n+      m_message{Sv2NetMsg(Sv2NetHeader{})}\n+{\n+    /** Start sending immediately since we're the initiator of the connection.\n+        This only happens in test code.\n+    */\n+    LOCK(m_send_mutex);\n+    StartSendingHandshake();\n+\n+}\n+\n+void Sv2Transport::SetReceiveState(RecvState recv_state) noexcept\n+{\n+    AssertLockHeld(m_recv_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_recv_state) {\n+    case RecvState::HANDSHAKE_STEP_1:\n+        Assume(recv_state == RecvState::HANDSHAKE_STEP_2);\n+        break;\n+    case RecvState::HANDSHAKE_STEP_2:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    case RecvState::APP:\n+        Assume(recv_state == RecvState::APP_READY);\n+        break;\n+    case RecvState::APP_READY:\n+        Assume(recv_state == RecvState::APP);\n+        break;\n+    }\n+    // Change state.\n+    m_recv_state = recv_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session receive state -> %s\\n\",\n+                  RecvStateAsString(m_recv_state));\n+\n+}\n+\n+void Sv2Transport::SetSendState(SendState send_state) noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    // Enforce allowed state transitions.\n+    switch (m_send_state) {\n+    case SendState::HANDSHAKE_STEP_1:\n+        Assume(send_state == SendState::HANDSHAKE_STEP_2);\n+        break;\n+    case SendState::HANDSHAKE_STEP_2:\n+        Assume(send_state == SendState::READY);\n+        break;\n+    case SendState::READY:\n+        Assume(false); // Final state\n+        break;\n+    }\n+    // Change state.\n+    m_send_state = send_state;\n+    LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"Noise session send state -> %s\\n\",\n+                  SendStateAsString(m_send_state));\n+}\n+\n+void Sv2Transport::StartSendingHandshake() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockNotHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_1);\n+    Assume(m_send_buffer.empty());\n+\n+    m_send_buffer.resize(Sv2HandshakeState::ELLSWIFT_PUB_KEY_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgEphemeralPK(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_send_state = SendState::HANDSHAKE_STEP_2;\n+}\n+\n+void Sv2Transport::SendHandshakeReply() noexcept\n+{\n+    AssertLockHeld(m_send_mutex);\n+    AssertLockHeld(m_recv_mutex);\n+    Assume(m_send_state == SendState::HANDSHAKE_STEP_2);\n+\n+    Assume(m_send_buffer.empty());\n+    m_send_buffer.resize(Sv2HandshakeState::HANDSHAKE_STEP2_SIZE);\n+    m_cipher.GetHandshakeState().WriteMsgES(MakeWritableByteSpan(m_send_buffer));\n+\n+    m_cipher.FinishHandshake();\n+\n+    // LogPrintLevel(BCLog::SV2, BCLog::Level::Trace, \"m_hash: %s\\n\", HexStr(m_cipher.m_hash));\n+\n+    // We can send and receive stuff now, unless the other side hangs up\n+    SetSendState(SendState::READY);\n+    Assume(m_recv_state == RecvState::HANDSHAKE_STEP_2);\n+    SetReceiveState(RecvState::APP);\n+}\n+\n+Transport::BytesToSend Sv2Transport::GetBytesToSend(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    assert(false);\n+\n+    return {\n+        Span{m_send_buffer}.subspan(0,0),\n+        false,\n+        m_send_type\n+    };\n+}\n+\n+Sv2Transport::Sv2BytesToSend Sv2Transport::GetBytesToSendSv2(bool have_next_message) const noexcept\n+{\n+    AssertLockNotHeld(m_send_mutex);\n+    LOCK(m_send_mutex);\n+\n+    Assume(m_send_pos <= m_send_buffer.size());\n+    return {\n+        Span{m_send_buffer}.subspan(m_send_pos),",
      "path": "src/common/sv2_transport.cpp",
      "position": 139,
      "original_position": 139,
      "commit_id": "11328075fe1783163fa5d3113a37f6b20ccd4c43",
      "original_commit_id": "d787c61afefccd73fe9c3d86f84b18b45d331bf2",
      "in_reply_to_id": null,
      "user": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false
      },
      "body": "11328075fe1783163fa5d3113a37f6b20ccd4c43: I don't remember why I decided on a custom implementation here.",
      "created_at": "2024-06-20T16:12:13Z",
      "updated_at": "2024-06-20T16:16:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/30315#discussion_r1647825951",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1647825951"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/30315"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 139,
      "original_line": 139,
      "side": "RIGHT"
    }
  ]
}