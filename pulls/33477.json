{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477",
    "id": 2858375622,
    "node_id": "PR_kwDOABII586qX1nG",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/33477",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/33477.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/33477.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/e0162ab0ab89097efd853849b054817277d8ded7",
    "number": 33477,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "Rollback for dumptxoutset without invalidating blocks",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "body": "This is an alternative approach to implement `dumptxoutset` with rollback that was discussed a few times. It does not rely on `invalidateblock` and `reconsiderblock` and instead creates a temporary copy of the coins DB, modifies this copy by rolling back as many blocks as necessary and then creating the dump from this temp copy DB. See also https://github.com/bitcoin/bitcoin/pull/29553#issuecomment-1978480989, https://github.com/bitcoin/bitcoin/issues/32817#issuecomment-3012406102 and #29565 discussions.\r\n\r\nThe nice side-effects of this are that forks can not interfere with the rollback and network activity does not have to be suspended. But there are also some downsides when comparing to the current approach: this does require some additional disk space for the copied coins DB and performance is slower (master took 3m 17s vs 9m 16s in my last test with the code here, rolling back ~1500 blocks). However, there is also not much code being added here, network can stay active throughout and performance would stay constant with this approach while it would impact master if there were forks that needed to be invalidated as well (see #33444 for the alternative approach), so this could still be considered a good trade-off.",
    "labels": [],
    "created_at": "2025-09-24T21:15:11Z",
    "updated_at": "2025-11-27T00:21:26Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "489043a41dbf3fe5d8e99993dd740ef220c6bd3e",
    "assignees": [],
    "requested_reviewers": [
      {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      }
    ],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "fjahr:202509-better-rollback",
      "ref": "202509-better-rollback",
      "sha": "e0162ab0ab89097efd853849b054817277d8ded7",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 196253948,
        "node_id": "MDEwOlJlcG9zaXRvcnkxOTYyNTM5NDg=",
        "name": "bitcoin",
        "full_name": "fjahr/bitcoin",
        "owner": {
          "login": "fjahr",
          "id": 1322187,
          "node_id": "MDQ6VXNlcjEzMjIxODc=",
          "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/fjahr",
          "html_url": "https://github.com/fjahr",
          "followers_url": "https://api.github.com/users/fjahr/followers",
          "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
          "organizations_url": "https://api.github.com/users/fjahr/orgs",
          "repos_url": "https://api.github.com/users/fjahr/repos",
          "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/fjahr/received_events",
          "type": "User",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/fjahr/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/fjahr/bitcoin",
        "archive_url": "https://api.github.com/repos/fjahr/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/fjahr/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/fjahr/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/fjahr/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/fjahr/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/fjahr/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/fjahr/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/fjahr/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/fjahr/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/fjahr/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/fjahr/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/fjahr/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/fjahr/bitcoin/events",
        "forks_url": "https://api.github.com/repos/fjahr/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/fjahr/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/fjahr/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/fjahr/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/fjahr/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/fjahr/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/fjahr/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/fjahr/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/fjahr/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/fjahr/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/fjahr/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/fjahr/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/fjahr/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/fjahr/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/fjahr/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/fjahr/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:fjahr/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/fjahr/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/fjahr/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/fjahr/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/fjahr/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/fjahr/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/fjahr/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/fjahr/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/fjahr/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/fjahr/bitcoin/hooks",
        "svn_url": "https://github.com/fjahr/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 4,
        "watchers_count": 4,
        "size": 284225,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-11-27T00:04:15Z",
        "created_at": "2019-07-10T18:11:06Z",
        "updated_at": "2024-07-23T22:14:45Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "85d058dc537e62258ef3b3eb73589a242b885b8d",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38264,
        "stargazers_count": 87007,
        "watchers_count": 87007,
        "size": 299663,
        "default_branch": "master",
        "open_issues_count": 721,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2025-11-26T14:55:42Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2025-11-26T23:43:16Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 194,
    "deletions": 114,
    "changed_files": 2,
    "commits": 2,
    "review_comments": 21,
    "comments": 9
  },
  "events": [
    {
      "event": "commented",
      "id": 3330742861,
      "node_id": "IC_kwDOABII587GhxpN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3330742861",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T21:15:20Z",
      "updated_at": "2025-11-26T22:06:02Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/33477.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [luke-jr](https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3333347528), [kevkevinpal](https://github.com/bitcoin/bitcoin/pull/33477#pullrequestreview-3274904950), [theStack](https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3386727879), [mzumsande](https://github.com/bitcoin/bitcoin/pull/33477#pullrequestreview-3385298069) |\n| Stale ACK | [enirox001](https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3452764833) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#33444](https://github.com/bitcoin/bitcoin/pull/33444) (rpc: Fix dumptxoutset rollback with competing forks by enirox001)\n* [#31560](https://github.com/bitcoin/bitcoin/pull/31560) (rpc: allow writing UTXO set to a named pipe, introduce dump_to_sqlite.sh script by theStack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->\n### LLM Linter (âœ¨ experimental)\n\n\n\nPossible places where named args may be used (e.g. `func(x, /*named_arg=*/0)` in C++, and `func(x, named_arg=0)` in Python):\n\n- temp_cache.AddCoin(key, std::move(coin), false) in src/rpc/blockchain.cpp\n\n\n\n<sup>2025-11-26</sup>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3330742861",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19903386464,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAASiVZNg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19903386464",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d51c7d71486c86b14806fdaeea1fb47aa1f5312b",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/d51c7d71486c86b14806fdaeea1fb47aa1f5312b",
      "created_at": "2025-09-24T21:22:09Z"
    },
    {
      "event": "commented",
      "id": 3330760975,
      "node_id": "IC_kwDOABII587Gh2EP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3330760975",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T21:22:50Z",
      "updated_at": "2025-09-24T21:22:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "cc @Sjors since you were asking for this approach a few times :)",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3330760975",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "mentioned",
      "id": 19903397541,
      "node_id": "MEE_lADOABII587NsmtbzwAAAASiVb6l",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19903397541",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T21:22:51Z"
    },
    {
      "event": "subscribed",
      "id": 19903397561,
      "node_id": "SE_lADOABII587NsmtbzwAAAASiVb65",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19903397561",
      "actor": {
        "login": "Sjors",
        "id": 10217,
        "node_id": "MDQ6VXNlcjEwMjE3",
        "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Sjors",
        "html_url": "https://github.com/Sjors",
        "followers_url": "https://api.github.com/users/Sjors/followers",
        "following_url": "https://api.github.com/users/Sjors/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Sjors/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Sjors/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
        "organizations_url": "https://api.github.com/users/Sjors/orgs",
        "repos_url": "https://api.github.com/users/Sjors/repos",
        "events_url": "https://api.github.com/users/Sjors/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Sjors/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-24T21:22:51Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19903537752,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAASiV-JY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19903537752",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "716e1dbf82b21e2ab9adb97328d2c54b09ae4a38",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/716e1dbf82b21e2ab9adb97328d2c54b09ae4a38",
      "created_at": "2025-09-24T21:31:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19904389221,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAASiZOBl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19904389221",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/6d409d59704a026a56d18856ab2f9e90eea62186",
      "created_at": "2025-09-24T22:33:46Z"
    },
    {
      "event": "commented",
      "id": 3333347528,
      "node_id": "IC_kwDOABII587GrtjI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3333347528",
      "actor": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-25T10:40:34Z",
      "updated_at": "2025-09-25T10:40:34Z",
      "author_association": "MEMBER",
      "body": "Concept ACK, this seems cleaner.\r\n\r\n> master took 3m 17s vs 9m 16s in my last test with the code here\r\n\r\nI suspect if you go back further, this approach will end up performing better because we no longer need to roll back forward at the end",
      "user": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3333347528",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "subscribed",
      "id": 19941062280,
      "node_id": "SE_lADOABII587NsmtbzwAAAASklHaI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19941062280",
      "actor": {
        "login": "nervana21",
        "id": 205626986,
        "node_id": "U_kgDODEGeag",
        "avatar_url": "https://avatars.githubusercontent.com/u/205626986?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nervana21",
        "html_url": "https://github.com/nervana21",
        "followers_url": "https://api.github.com/users/nervana21/followers",
        "following_url": "https://api.github.com/users/nervana21/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nervana21/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nervana21/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nervana21/subscriptions",
        "organizations_url": "https://api.github.com/users/nervana21/orgs",
        "repos_url": "https://api.github.com/users/nervana21/repos",
        "events_url": "https://api.github.com/users/nervana21/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nervana21/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-26T10:53:27Z"
    },
    {
      "event": "reviewed",
      "id": 3274904950,
      "node_id": "PRR_kwDOABII587DMxV2",
      "url": null,
      "actor": null,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-27T14:04:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK [6d409d5](https://github.com/bitcoin/bitcoin/pull/33477/commits/6d409d59704a026a56d18856ab2f9e90eea62186)\n\nThis approach makes more sense. I reviewed the code a bit and made some comments, but nothing blocking\n\nI also added comments on possible functional tests for the new `JSONRPCError` but these can be done in a followup",
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#pullrequestreview-3274904950",
      "submitted_at": "2025-09-27T14:04:47Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
    },
    {
      "event": "commented",
      "id": 3344719601,
      "node_id": "IC_kwDOABII587HXF7x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3344719601",
      "actor": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-29T03:27:34Z",
      "updated_at": "2025-09-29T03:27:34Z",
      "author_association": "CONTRIBUTOR",
      "body": "Nice!\r\n\r\n> performance is slower (master took 3m 17s vs 9m 16s in my last test with the code here,\r\n\r\nThat probably makes sense. It might be possible to do it faster and with less disk usage for relatively short rollbacks via a two step process:\r\n\r\n * create a read-only snapshot of the db\r\n * create an empty \"coins-delta\" db\r\n * iterate through the rev data to rollback, update the coins-delta db:\r\n    * when you rollback past a coin's creation:\r\n      * if the coin was in the snapshot db, add \"[coin] deleted\"\r\n      * otherwise, if it was in the coins-delta db, remove \"[coin]\"\r\n      * (otherwise, there's a bug)\r\n    * when you rollback past a coin's spend, add \"[coin]\"\r\n * when you've finished the rollback,\r\n   * iterate through the snapshot coins, skipping any where there is a \"[coin] deleted\" entry, reporting them\r\n   * iterate through the non-deleted coins-delta coins, reporting them\r\n * delete the coins-delta db, delete the snapshot\r\n\r\nRather than being direct RPC functionality, maybe it would be better to have an RPC function to export a copy of the utxo set at the current height, and have a separate bitcoin-kernel binary that performs the rollback and utxoset stats calculation itself?",
      "user": {
        "login": "ajtowns",
        "id": 127186,
        "node_id": "MDQ6VXNlcjEyNzE4Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ajtowns",
        "html_url": "https://github.com/ajtowns",
        "followers_url": "https://api.github.com/users/ajtowns/followers",
        "following_url": "https://api.github.com/users/ajtowns/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ajtowns/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ajtowns/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
        "organizations_url": "https://api.github.com/users/ajtowns/orgs",
        "repos_url": "https://api.github.com/users/ajtowns/repos",
        "events_url": "https://api.github.com/users/ajtowns/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ajtowns/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3344719601",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "commented",
      "id": 3386727879,
      "node_id": "IC_kwDOABII587J3V3H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3386727879",
      "actor": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-09T16:57:40Z",
      "updated_at": "2025-10-09T16:57:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3386727879",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "commented",
      "id": 3452764833,
      "node_id": "IC_kwDOABII587NzQKh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3452764833",
      "actor": {
        "login": "enirox001",
        "id": 66912335,
        "node_id": "MDQ6VXNlcjY2OTEyMzM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/66912335?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/enirox001",
        "html_url": "https://github.com/enirox001",
        "followers_url": "https://api.github.com/users/enirox001/followers",
        "following_url": "https://api.github.com/users/enirox001/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/enirox001/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/enirox001/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/enirox001/subscriptions",
        "organizations_url": "https://api.github.com/users/enirox001/orgs",
        "repos_url": "https://api.github.com/users/enirox001/repos",
        "events_url": "https://api.github.com/users/enirox001/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/enirox001/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T18:38:05Z",
      "updated_at": "2025-10-27T18:38:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "ACK 6d409d5\r\n\r\nThis is a good change. Using a temporary coins DB for the rollback is a much cleaner and safer solution than the `invalidateblock` method. It correctly solves fork-related bugs by isolating the process and avoids the need for network suspension, making it a superior approach to what I proposed in #33444.\r\n\r\nThe code is well-contained, and the new `TemporaryUTXODatabase` class handles the DB lifecycle cleanly. \r\n\r\nI've pulled the branch, compiled, and the full functional test suite passes, including the `rpc_dumptxoutset` test",
      "user": {
        "login": "enirox001",
        "id": 66912335,
        "node_id": "MDQ6VXNlcjY2OTEyMzM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/66912335?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/enirox001",
        "html_url": "https://github.com/enirox001",
        "followers_url": "https://api.github.com/users/enirox001/followers",
        "following_url": "https://api.github.com/users/enirox001/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/enirox001/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/enirox001/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/enirox001/subscriptions",
        "organizations_url": "https://api.github.com/users/enirox001/orgs",
        "repos_url": "https://api.github.com/users/enirox001/repos",
        "events_url": "https://api.github.com/users/enirox001/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/enirox001/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3452764833",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "review_requested",
      "id": 20533323739,
      "node_id": "RRE_lADOABII587NsmtbzwAAAATH4afb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20533323739",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T18:38:09Z",
      "requested_reviewer": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      }
    },
    {
      "event": "review_requested",
      "id": 20533324483,
      "node_id": "RRE_lADOABII587NsmtbzwAAAATH4arD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20533324483",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T18:38:10Z",
      "requested_reviewer": {
        "login": "theStack",
        "id": 91535,
        "node_id": "MDQ6VXNlcjkxNTM1",
        "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/theStack",
        "html_url": "https://github.com/theStack",
        "followers_url": "https://api.github.com/users/theStack/followers",
        "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
        "organizations_url": "https://api.github.com/users/theStack/orgs",
        "repos_url": "https://api.github.com/users/theStack/repos",
        "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/theStack/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      }
    },
    {
      "event": "review_requested",
      "id": 20533326502,
      "node_id": "RRE_lADOABII587NsmtbzwAAAATH4bKm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20533326502",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T18:38:12Z",
      "requested_reviewer": {
        "login": "luke-jr",
        "id": 1095675,
        "node_id": "MDQ6VXNlcjEwOTU2NzU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/luke-jr",
        "html_url": "https://github.com/luke-jr",
        "followers_url": "https://api.github.com/users/luke-jr/followers",
        "following_url": "https://api.github.com/users/luke-jr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/luke-jr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/luke-jr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
        "organizations_url": "https://api.github.com/users/luke-jr/orgs",
        "repos_url": "https://api.github.com/users/luke-jr/repos",
        "events_url": "https://api.github.com/users/luke-jr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/luke-jr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "review_requester": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      }
    },
    {
      "event": "reviewed",
      "id": 3385298069,
      "node_id": "PRR_kwDOABII587Jx4yV",
      "url": null,
      "actor": null,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-10-27T20:53:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\n> I suspect if you go back further, this approach will end up performing better because we no longer need to roll back forward at the end\r\n\r\nWould be interesting if someone could try out by going back 25k blocks or more, as is usually done for creating snapshots (I can't right now).",
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#pullrequestreview-3385298069",
      "submitted_at": "2025-10-27T20:53:17Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21205869986,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAATv9-Wi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21205869986",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b71ee305235e35402c3397b0c43a3fa73a2b895a",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/b71ee305235e35402c3397b0c43a3fa73a2b895a",
      "created_at": "2025-11-26T21:45:45Z"
    },
    {
      "event": "commented",
      "id": 3583308231,
      "node_id": "IC_kwDOABII587VlPHH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3583308231",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-26T21:47:11Z",
      "updated_at": "2025-11-26T23:03:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thanks for all the feedback so far and sorry for the slow response!\r\n\r\n> Rather than being direct RPC functionality, maybe it would be better to have an RPC function to export a copy of the utxo set at the current height, and have a separate bitcoin-kernel binary that performs the rollback and utxoset stats calculation itself?\r\n\r\nHm, feels like a bit overengineered for this functionality, considering the overhead for test coverage and build changes for this. Maybe I am overcomplicating it in my head, I have not done much with kernel yet. But if this is considerably more complex I would rather first go ahead with this and then I would rather keep it for consideration of a future change.\r\n\r\n> Would be interesting if someone could try out by going back 25k blocks or more, as is usually done for creating snapshots (I can't right now).\r\n\r\nI tried with `880,000`, our v29 param, so `45,000` blocks rollback. It took just under 20min in total and it returned the correct hash.\r\n\r\n```\r\n$ build/bin/bitcoin-cli -rpcclienttimeout=0 -named dumptxoutset ~/Downloads/utxo880k.dat rollback=880000\r\n{\r\n  \"coins_written\": 184821030,\r\n  \"base_hash\": \"000000000000000000010b17283c3c400507969a9c2afd1dcf2082ec5cca2880\",\r\n  \"base_height\": 880000,\r\n  \"path\": \"/Users/FJ/Downloads/utxo880k.dat\",\r\n  \"txoutset_hash\": \"dbd190983eaf433ef7c15f78a278ae42c00ef52e0fd2a54953782175fbadcea9\",\r\n  \"nchaintx\": 1145604538\r\n}\r\n```\r\n\r\n> It might be possible to do it faster and with less disk usage for relatively short rollbacks via a two step process:\r\n\r\nI actually had a similar idea early on but then stayed with the simpler approach. I will try this out with a POC and check the performance impact.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3583308231",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21205934350,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAATv-OEO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21205934350",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "53865e7f9e471b8551130ddec1ae6a443b91179a",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/53865e7f9e471b8551130ddec1ae6a443b91179a",
      "created_at": "2025-11-26T21:51:39Z"
    },
    {
      "event": "labeled",
      "id": 21205940992,
      "node_id": "LE_lADOABII587NsmtbzwAAAATv-PsA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21205940992",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-26T21:52:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3583320163,
      "node_id": "IC_kwDOABII587VlSBj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3583320163",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-26T21:52:30Z",
      "updated_at": "2025-11-26T21:52:30Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `Windows-cross to x86_64`: https://github.com/bitcoin/bitcoin/actions/runs/19718249847/job/56495362448</sub>\n<sub>LLM reason (âœ¨ experimental): Compile errors in rpc/blockchain.cpp due to RPCHelpMan constructor signature mismatch (brace-initializer/API change).</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3583320163",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDdkNjdhNjZhOWFiNWY3Y2YzMDZjYjBmMWQ4YTJmY2NiYzE0YzZjOGU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e",
      "tree": {
        "sha": "a71a082a788e56588f3a5252ebbea7373a4bab1f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a71a082a788e56588f3a5252ebbea7373a4bab1f"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree a71a082a788e56588f3a5252ebbea7373a4bab1f\nparent 238c1c8933b1f7479a9bca2b7cb207d26151c39d\nauthor Fabian Jahr <fjahr@protonmail.com> 1758661487 +0200\ncommitter Fabian Jahr <fjahr@protonmail.com> 1764194710 +0100\n\nrpc: Don't invalidate blocks in dumptxoutset\n\nInstead this new approach uses a temporary coins db to roll back the\nUTXO set.\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmkneZcVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNdJoQAKS3quqsufzDVJtKX8FLfbr/z0zx\n/YGnKHJo44x00KSiD7CC9kkYRUovyt8hW0ppw+uMzuhYyZtW/fL7rZR5j5XtYjfR\n2SU5VKaFiwwg/PieV3M8DK7OI9Cw8HPpirxTrLYICkNtnImOJE22Iw3MPswTfT9Y\n3dWcRl4jMt0WY2uBvZhtMbj7maoSGZhVHNSpV/Ji9Wz1+gBaI59YANJ4799sBWXv\nCYEBCcNNDBHfdQsv6B3EdLfOwXgKBsPD3hGQmlntjRaB3CLAQwnUZn1W191k5ps2\nWeyJo7v4NxGpBf0skMfrNwcSZns/1h822q3Wk4HupJLdpp2RRa6LYY6Eo71lsF1L\nFstiqblctyT3sQS4ExY+uGuKQIXMhor4kRYOu8cZToXCDyRutTKEM6sOW4nkNvvi\nxoHhwAclGBdJJ8QY8u4nRwo3FPd76CJloXfZWNrJOvJ/Puk64UFJ4TNkoX5lIZ/R\nBfPCjA4virNjSeGJRTmwqz2Jo2PIdnLWUTkphLxE1JgyiIJFRrpLcHgWN178heWu\nhGMZhPNXuFUletCrsqJiI5ritRF+Si6zxm9WqAjQKY37q0BuOyeHPWOkxkKHegQr\nG8CGsCGTV0NksOVt68FvLAc6huK41U69xrkqpHNnfuO42l90yXbcPxWciDQpG8zw\nvs+DdvpiSXZNVo3K\n=FbHU\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/238c1c8933b1f7479a9bca2b7cb207d26151c39d",
          "sha": "238c1c8933b1f7479a9bca2b7cb207d26151c39d",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/238c1c8933b1f7479a9bca2b7cb207d26151c39d"
        }
      ],
      "message": "rpc: Don't invalidate blocks in dumptxoutset\n\nInstead this new approach uses a temporary coins db to roll back the\nUTXO set.",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2025-11-26T22:05:10Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2025-09-23T21:04:47Z"
      },
      "sha": "7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGUwMTYyYWIwYWI4OTA5N2VmZDg1Mzg0OWIwNTQ4MTcyNzdkOGRlZDc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e0162ab0ab89097efd853849b054817277d8ded7",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/e0162ab0ab89097efd853849b054817277d8ded7",
      "tree": {
        "sha": "c63b35502e1c77785db09872f948f0813549d528",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c63b35502e1c77785db09872f948f0813549d528"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree c63b35502e1c77785db09872f948f0813549d528\nparent 7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e\nauthor Fabian Jahr <fjahr@protonmail.com> 1758671406 +0200\ncommitter Fabian Jahr <fjahr@protonmail.com> 1764194711 +0100\n\ntest: Add dumptxoutset fork test\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\nComment: GPGTools - https://gpgtools.org\n\niQJJBAABCgAzFiEEtFq20ghhrCHSdrgm8T0enYkHmM0FAmkneZcVHGZqYWhyQHBy\nb3Rvbm1haWwuY29tAAoJEPE9Hp2JB5jNa9AQAIN1ANoyumawiSfx74z645M/EE5A\nKcw0LAvAmpJT5c/Om68AsqeSzjs1T7maaoOVS89mejpEB0UVbGF9NRT8LB7RT/ez\nL/Iv8HJFpojXUA9A03SMCzhKufBLeJlZJLpqUbfdJs0jWffljUnIpNXUvC8ZFIqn\n4ntMJmi5dfhjCTm2EBQwpDvZpDi9xfCCl7zcy90TqZloiLGJL7Nu4s2kWDox2C9z\n69/4P9Ys+8REOzWy968mC7UmT8kdmfxzCvRjysm5oD5iHOORBb3WH3dHJNQsvOF9\nmI8zkUvpInDswLe3hXQej1V1aqaZljIMbZoOlS430BWnH3UXiJEq9f7rVLa7Rpv3\n+mSA6M84ZzT6RbzNomUlyUpgOu3i8V6i+sucaVCOyckwSLvXu/gzhahqvsJJ2i7a\ntuYcH373/FsbO6KlyqCzue45t1gyMy0qUI1WsfCNDzg/4T+8o0MPPaQFfQgRO/mX\nU0DjncVKElRnhzHYlDMsExDeC6VLzd5RiYbRYq//aPv8U7uxgDR6YKxWyoByV2Mx\nUEe7TNR9WPlj1XHHQlqcmix/hv1rjIWIFyds4H1Ez/GDYnMsXw+rYSKkIV0hwvq5\nZZ22UMjz4Zlr5LAQ14z+ly3fIfxTkD+qNiCZX1pEcM/y6ApZZF+UiTbW5dSv17nF\nrxcX3d3Qjz3rXgGG\n=02xp\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e",
          "sha": "7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/7d67a66a9ab5f7cf306cb0f1d8a2fccbc14c6c8e"
        }
      ],
      "message": "test: Add dumptxoutset fork test",
      "committer": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2025-11-26T22:05:11Z"
      },
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2025-09-23T23:50:06Z"
      },
      "sha": "e0162ab0ab89097efd853849b054817277d8ded7"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21206111235,
      "node_id": "HRFPE_lADOABII587NsmtbzwAAAATv-5QD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21206111235",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "commit_url": "https://api.github.com/repos/fjahr/bitcoin/commits/e0162ab0ab89097efd853849b054817277d8ded7",
      "created_at": "2025-11-26T22:05:19Z"
    },
    {
      "event": "unlabeled",
      "id": 21206752464,
      "node_id": "UNLE_lADOABII587NsmtbzwAAAATwBVzQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21206752464",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-26T22:50:54Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3583625311,
      "node_id": "IC_kwDOABII587Vmchf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3583625311",
      "actor": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T00:21:26Z",
      "updated_at": "2025-11-27T00:21:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "> > It might be possible to do it faster and with less disk usage for relatively short rollbacks via a two step process:\r\n> \r\n> I actually had a similar idea early on but then stayed with the simpler approach. I will try this out with a POC and check the performance impact.\r\n\r\nI tried to a few different takes on the delta-based idea including some vibe coding tests. [Here](https://github.com/fjahr/bitcoin/commit/a86bbfbd6f0d6e440ff8c5c303e392e51e3eb60b) is the latest one, something is definitely still broken there but the dump it generates is correct. All tests I did had in common that the processing time actually took longer than the current approach, almost 28 min with the latest code version. I am now thinking that longer rollbacks may not be quicker, only shorter ones will be because the big copy overhead in the beginning is saved. But then we also don't have that much to gain. Even if the performance can be improved, now that I have played around with it, it doesn't seem worth the additional code complexity it introduces. It would need to be significantly faster to justify that and I am currently not seeing that.",
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#issuecomment-3583625311",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/33477"
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384138037",
      "pull_request_review_id": 3274904950,
      "id": 2384138037,
      "node_id": "PRRC_kwDOABII586OGw81",
      "diff_hunk": "@@ -3020,9 +2992,8 @@ static RPCHelpMan dumptxoutset()\n     return RPCHelpMan{\n         \"dumptxoutset\",\n         \"Write the serialized UTXO set to a file. This can be used in loadtxoutset afterwards if this snapshot height is supported in the chainparams as well.\\n\\n\"\n-        \"Unless the \\\"latest\\\" type is requested, the node will roll back to the requested height and network activity will be suspended during this process. \"\n-        \"Because of this it is discouraged to interact with the node in any other way during the execution of this call to avoid inconsistent results and race conditions, particularly RPCs that interact with blockstorage.\\n\\n\"\n-        \"This call may take several minutes. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",\n+        \"This creates a temporary UTXO database when rolling back, keeping the main chain intact. Should the node experience an unclean shutdown the temporary database may need to be removed from the datadir manually.\\n\\n\"",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 65,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It may be worth noting that \"network activity will **_not_** be suspended during this process.\"",
      "created_at": "2025-09-27T12:54:25Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384138037",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384138037"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2995,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384142999",
      "pull_request_review_id": 3274904950,
      "id": 2384142999,
      "node_id": "PRRC_kwDOABII586OGyKX",
      "diff_hunk": "@@ -3020,9 +2992,8 @@ static RPCHelpMan dumptxoutset()\n     return RPCHelpMan{\n         \"dumptxoutset\",\n         \"Write the serialized UTXO set to a file. This can be used in loadtxoutset afterwards if this snapshot height is supported in the chainparams as well.\\n\\n\"\n-        \"Unless the \\\"latest\\\" type is requested, the node will roll back to the requested height and network activity will be suspended during this process. \"\n-        \"Because of this it is discouraged to interact with the node in any other way during the execution of this call to avoid inconsistent results and race conditions, particularly RPCs that interact with blockstorage.\\n\\n\"\n-        \"This call may take several minutes. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",\n+        \"This creates a temporary UTXO database when rolling back, keeping the main chain intact. Should the node experience an unclean shutdown the temporary database may need to be removed from the datadir manually.\\n\\n\"\n+        \"This call may take several minutes for deep rollbacks. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 66,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Maybe this text would make more sense\r\n\r\n\"For deep rollbacks, make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0) as it may take several minutes.\"",
      "created_at": "2025-09-27T12:56:16Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384142999",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384142999"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2996,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175011",
      "pull_request_review_id": 3274904950,
      "id": 2384175011,
      "node_id": "PRRC_kwDOABII586OG5-j",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));",
      "path": "src/rpc/blockchain.cpp",
      "position": 262,
      "original_position": 269,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Might be able to add a functional test for this rpc error",
      "created_at": "2025-09-27T13:46:58Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384175011",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175011"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3208,
      "original_line": 3208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175091",
      "pull_request_review_id": 3274904950,
      "id": 2384175091,
      "node_id": "PRRC_kwDOABII586OG5_z",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));\n+        }\n+\n+        WITH_LOCK(::cs_main, res = chainstate.DisconnectBlock(block, block_index, rollback_cache));\n+        if (res == DISCONNECT_FAILED) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to roll back block at height %d\", block_index->nHeight));",
      "path": "src/rpc/blockchain.cpp",
      "position": 268,
      "original_position": 275,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Might be able to add a functional test for this rpc error",
      "created_at": "2025-09-27T13:47:06Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384175091",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175091"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3214,
      "original_line": 3214,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175151",
      "pull_request_review_id": 3274904950,
      "id": 2384175151,
      "node_id": "PRRC_kwDOABII586OG6Av",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));\n+        }\n+\n+        WITH_LOCK(::cs_main, res = chainstate.DisconnectBlock(block, block_index, rollback_cache));\n+        if (res == DISCONNECT_FAILED) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to roll back block at height %d\", block_index->nHeight));\n+        }\n+\n+        blocks_processed++;\n+        if (blocks_processed % 500 == 0) {\n+            LogInfo(\"Rolled back %d blocks.\", blocks_processed);\n+            rollback_cache.Flush();\n+        }\n+\n+        block_index = block_index->pprev;\n+    }\n+\n+    rollback_cache.SetBestBlock(target->GetBlockHash());\n+    rollback_cache.Flush();\n+\n+    LogInfo(\"Rollback complete. Computing UTXO statistics for created txoutset dump.\");\n+    std::optional<CCoinsStats> maybe_stats = GetUTXOStats(temp_db.get(),\n+                                                          chainstate.m_blockman,\n+                                                          CoinStatsHashType::HASH_SERIALIZED,\n+                                                          node.rpc_interruption_point);\n+\n+    if (!maybe_stats) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to compute UTXO statistics\");",
      "path": "src/rpc/blockchain.cpp",
      "position": 290,
      "original_position": 297,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Might be able to add a functional test for this rpc error",
      "created_at": "2025-09-27T13:47:22Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384175151",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175151"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3236,
      "original_line": 3236,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175185",
      "pull_request_review_id": 3274904950,
      "id": 2384175185,
      "node_id": "PRRC_kwDOABII586OG6BR",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));\n+        }\n+\n+        WITH_LOCK(::cs_main, res = chainstate.DisconnectBlock(block, block_index, rollback_cache));\n+        if (res == DISCONNECT_FAILED) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to roll back block at height %d\", block_index->nHeight));\n+        }\n+\n+        blocks_processed++;\n+        if (blocks_processed % 500 == 0) {\n+            LogInfo(\"Rolled back %d blocks.\", blocks_processed);\n+            rollback_cache.Flush();\n+        }\n+\n+        block_index = block_index->pprev;\n+    }\n+\n+    rollback_cache.SetBestBlock(target->GetBlockHash());\n+    rollback_cache.Flush();\n+\n+    LogInfo(\"Rollback complete. Computing UTXO statistics for created txoutset dump.\");\n+    std::optional<CCoinsStats> maybe_stats = GetUTXOStats(temp_db.get(),\n+                                                          chainstate.m_blockman,\n+                                                          CoinStatsHashType::HASH_SERIALIZED,\n+                                                          node.rpc_interruption_point);\n+\n+    if (!maybe_stats) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to compute UTXO statistics\");\n+    }\n+\n+    std::unique_ptr<CCoinsViewCursor> pcursor{temp_db->Cursor()};\n+    if (!pcursor) {\n+        throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to create UTXO cursor\");",
      "path": "src/rpc/blockchain.cpp",
      "position": 295,
      "original_position": 302,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Might be able to add a functional test for this rpc error",
      "created_at": "2025-09-27T13:47:31Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384175185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384175185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3241,
      "original_line": 3241,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384179539",
      "pull_request_review_id": 3274904950,
      "id": 2384179539,
      "node_id": "PRRC_kwDOABII586OG7FT",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);",
      "path": "src/rpc/blockchain.cpp",
      "position": 176,
      "original_position": 183,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": null,
      "user": {
        "login": "kevkevinpal",
        "id": 15950706,
        "node_id": "MDQ6VXNlcjE1OTUwNzA2",
        "avatar_url": "https://avatars.githubusercontent.com/u/15950706?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/kevkevinpal",
        "html_url": "https://github.com/kevkevinpal",
        "followers_url": "https://api.github.com/users/kevkevinpal/followers",
        "following_url": "https://api.github.com/users/kevkevinpal/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/kevkevinpal/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/kevkevinpal/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/kevkevinpal/subscriptions",
        "organizations_url": "https://api.github.com/users/kevkevinpal/orgs",
        "repos_url": "https://api.github.com/users/kevkevinpal/repos",
        "events_url": "https://api.github.com/users/kevkevinpal/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/kevkevinpal/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It might be useful to add a log here to inform the user the temp UTXO db was cleaned up since we mentioned in logs that we are creating a temp UTXO db",
      "created_at": "2025-09-27T14:01:30Z",
      "updated_at": "2025-09-27T14:04:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2384179539",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384179539"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3122,
      "original_line": 3122,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2466957433",
      "pull_request_review_id": 3385298069,
      "id": 2466957433,
      "node_id": "PRRC_kwDOABII586TCsh5",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {",
      "path": "src/rpc/blockchain.cpp",
      "position": 222,
      "original_position": 220,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Don't we need to hold `cs_main` throughout the copying phase? What if the utxo set changes while we are copying coins?",
      "created_at": "2025-10-27T20:14:44Z",
      "updated_at": "2025-10-27T21:01:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2466957433",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2466957433"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3168,
      "original_line": 3168,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2466997313",
      "pull_request_review_id": 3385298069,
      "id": 2466997313,
      "node_id": "PRRC_kwDOABII586TC2RB",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));\n+        }\n+\n+        WITH_LOCK(::cs_main, res = chainstate.DisconnectBlock(block, block_index, rollback_cache));\n+        if (res == DISCONNECT_FAILED) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to roll back block at height %d\", block_index->nHeight));\n+        }\n+\n+        blocks_processed++;\n+        if (blocks_processed % 500 == 0) {\n+            LogInfo(\"Rolled back %d blocks.\", blocks_processed);\n+            rollback_cache.Flush();\n+        }\n+\n+        block_index = block_index->pprev;\n+    }\n+\n+    rollback_cache.SetBestBlock(target->GetBlockHash());",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 278,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": null,
      "user": {
        "login": "mzumsande",
        "id": 48763452,
        "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
        "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mzumsande",
        "html_url": "https://github.com/mzumsande",
        "followers_url": "https://api.github.com/users/mzumsande/followers",
        "following_url": "https://api.github.com/users/mzumsande/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/mzumsande/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/mzumsande/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
        "organizations_url": "https://api.github.com/users/mzumsande/orgs",
        "repos_url": "https://api.github.com/users/mzumsande/repos",
        "events_url": "https://api.github.com/users/mzumsande/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/mzumsande/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This seems unnecessary. As far as I can see the final `DisconnectBlock` call should have set the best block already, so that could we instead Assume here that `rollback_cache.GetBestBlock() == target->GetBlockHash()`.",
      "created_at": "2025-10-27T20:31:15Z",
      "updated_at": "2025-10-27T20:55:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2466997313",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2466997313"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567639",
      "pull_request_review_id": 3512836514,
      "id": 2566567639,
      "node_id": "PRRC_kwDOABII586Y-rbX",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));\n+        }\n+\n+        WITH_LOCK(::cs_main, res = chainstate.DisconnectBlock(block, block_index, rollback_cache));\n+        if (res == DISCONNECT_FAILED) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to roll back block at height %d\", block_index->nHeight));\n+        }\n+\n+        blocks_processed++;\n+        if (blocks_processed % 500 == 0) {\n+            LogInfo(\"Rolled back %d blocks.\", blocks_processed);\n+            rollback_cache.Flush();\n+        }\n+\n+        block_index = block_index->pprev;\n+    }\n+\n+    rollback_cache.SetBestBlock(target->GetBlockHash());",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 278,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": 2466997313,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Changed to an `Assume` instead.",
      "created_at": "2025-11-26T21:47:16Z",
      "updated_at": "2025-11-26T21:47:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566567639",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3217,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567768",
      "pull_request_review_id": 3512836649,
      "id": 2566567768,
      "node_id": "PRRC_kwDOABII586Y-rdY",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {",
      "path": "src/rpc/blockchain.cpp",
      "position": 222,
      "original_position": 220,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": 2466957433,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think so, my understanding is that the cursor/LevelDB iterator works on a snapshot of the DB itself which doesn't get mutated. You can see the same pattern in `WriteUTXOSnapshot` where we are working with a cursor without holding `cs_main` as well. ",
      "created_at": "2025-11-26T21:47:20Z",
      "updated_at": "2025-11-26T21:47:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566567768",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567768"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3168,
      "original_line": 3168,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567985",
      "pull_request_review_id": 3512836815,
      "id": 2566567985,
      "node_id": "PRRC_kwDOABII586Y-rgx",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);",
      "path": "src/rpc/blockchain.cpp",
      "position": 176,
      "original_position": 183,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": 2384179539,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hm, I don't think we log anything on the creation of the DB so I think I would keep it the same on the destruction. It should only be a debug level log if we would add anything like that since it seems a bit low level for the general user.",
      "created_at": "2025-11-26T21:47:26Z",
      "updated_at": "2025-11-26T21:47:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566567985",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566567985"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3122,
      "original_line": 3122,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569186",
      "pull_request_review_id": 3512838199,
      "id": 2566569186,
      "node_id": "PRRC_kwDOABII586Y-rzi",
      "diff_hunk": "@@ -3171,6 +3097,152 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+/**\n+ * RAII class that creates a temporary database directory in its constructor\n+ * and removes it in its destructor.\n+ */\n+class TemporaryUTXODatabase\n+{\n+    fs::path m_path;\n+public:\n+    TemporaryUTXODatabase(const fs::path& path) : m_path(path) {\n+        fs::create_directories(m_path);\n+    }\n+    ~TemporaryUTXODatabase() {\n+        try {\n+            fs::remove_all(m_path);\n+        } catch (...) {\n+            LogInfo(\"Failed to clean up temporary UTXO database at %s, please remove it manually.\",\n+                    fs::PathToString(m_path));\n+        }\n+    }\n+};\n+\n+UniValue CreateRolledBackUTXOSnapshot(\n+    NodeContext& node,\n+    Chainstate& chainstate,\n+    const CBlockIndex* target,\n+    AutoFile&& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath)\n+{\n+    // Create a temporary leveldb to store the UTXO set that is being rolled back\n+    std::string temp_db_name{strprintf(\"temp_utxo_%d\", target->nHeight)};\n+    fs::path temp_db_path{fsbridge::AbsPathJoin(tmppath.parent_path(), fs::u8path(temp_db_name))};\n+    TemporaryUTXODatabase temp_db_cleaner{temp_db_path};\n+\n+    // Create temporary database\n+    DBParams db_params{\n+        .path = temp_db_path,\n+        .cache_bytes = size_t(1) << 24,  // 16MB cache\n+        .memory_only = false,\n+        .wipe_data = true,\n+        .obfuscate = false,\n+        .options = DBOptions{}\n+    };\n+\n+    std::unique_ptr<CCoinsViewDB> temp_db = std::make_unique<CCoinsViewDB>(\n+        std::move(db_params),\n+        CoinsViewOptions{}\n+    );\n+\n+    LogInfo(\"Copying current UTXO set to temporary database.\");\n+    {\n+        WITH_LOCK(::cs_main, chainstate.ForceFlushStateToDisk());\n+        CCoinsViewCache temp_cache(temp_db.get());\n+        temp_cache.SetBestBlock(chainstate.m_chain.Tip()->GetBlockHash());\n+\n+        std::unique_ptr<CCoinsViewCursor> cursor;\n+        WITH_LOCK(::cs_main, cursor = chainstate.CoinsDB().Cursor());\n+\n+        size_t coins_count = 0;\n+        while (cursor->Valid()) {\n+            node.rpc_interruption_point();\n+\n+            COutPoint key;\n+            Coin coin;\n+            if (cursor->GetKey(key) && cursor->GetValue(coin)) {\n+                temp_cache.AddCoin(key, std::move(coin), false);\n+                coins_count++;\n+\n+                // Log every 10M coins (optimized for mainnet)\n+                if (coins_count % 10'000'000 == 0) {\n+                    LogInfo(\"Copying UTXO set: %uM coins copied.\", coins_count / 1'000'000);\n+                }\n+\n+                // Flush periodically\n+                if (coins_count % 100'000 == 0) {\n+                    temp_cache.Flush();\n+                }\n+            }\n+            cursor->Next();\n+        }\n+\n+        temp_cache.Flush();\n+        LogInfo(\"UTXO set copy complete: %u coins total\", coins_count);\n+    }\n+\n+    LogInfo(\"Rolling back from height %d to %d\", chainstate.m_chain.Tip()->nHeight, target->nHeight);\n+\n+    const CBlockIndex* block_index{chainstate.m_chain.Tip()};\n+    CCoinsViewCache rollback_cache(temp_db.get());\n+    rollback_cache.SetBestBlock(block_index->GetBlockHash());\n+    size_t blocks_processed = 0;\n+    DisconnectResult res;\n+\n+    while (block_index->nHeight > target->nHeight) {\n+        node.rpc_interruption_point();\n+\n+        CBlock block;\n+        if (!node.chainman->m_blockman.ReadBlock(block, *block_index)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR,\n+                strprintf(\"Failed to read block at height %d\", block_index->nHeight));",
      "path": "src/rpc/blockchain.cpp",
      "position": 262,
      "original_position": 269,
      "commit_id": "e0162ab0ab89097efd853849b054817277d8ded7",
      "original_commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "in_reply_to_id": 2384175011,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hm, this one and the other similar comments about test coverage are all cases that are pretty hard to hit because they should only be possible in a case of db corruption or a similarly unlikely event. Not saying that this wouldn't be valuable coverage, but afaik we hardly ever go through the hassle to cover such cases and this RPC is far from being a critical path in the comparison to the rest of the code base. So, unless you have a specific suggestion for how the can be hit in practical way I would suggest we keep these for a follow-up. The current changes should be a robustness improvement by themselves.\r\n\r\n(Marking the other comments as resolved for now but feel free to correct me if you think different about one of them specifically)",
      "created_at": "2025-11-26T21:48:11Z",
      "updated_at": "2025-11-26T21:48:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566569186",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569186"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 3208,
      "original_line": 3208,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569370",
      "pull_request_review_id": 3512838445,
      "id": 2566569370,
      "node_id": "PRRC_kwDOABII586Y-r2a",
      "diff_hunk": "@@ -3020,9 +2992,8 @@ static RPCHelpMan dumptxoutset()\n     return RPCHelpMan{\n         \"dumptxoutset\",\n         \"Write the serialized UTXO set to a file. This can be used in loadtxoutset afterwards if this snapshot height is supported in the chainparams as well.\\n\\n\"\n-        \"Unless the \\\"latest\\\" type is requested, the node will roll back to the requested height and network activity will be suspended during this process. \"\n-        \"Because of this it is discouraged to interact with the node in any other way during the execution of this call to avoid inconsistent results and race conditions, particularly RPCs that interact with blockstorage.\\n\\n\"\n-        \"This call may take several minutes. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",\n+        \"This creates a temporary UTXO database when rolling back, keeping the main chain intact. Should the node experience an unclean shutdown the temporary database may need to be removed from the datadir manually.\\n\\n\"\n+        \"This call may take several minutes for deep rollbacks. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 66,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": 2384142999,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Taken",
      "created_at": "2025-11-26T21:48:20Z",
      "updated_at": "2025-11-26T21:48:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566569370",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569370"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2996,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569595",
      "pull_request_review_id": 3512838637,
      "id": 2566569595,
      "node_id": "PRRC_kwDOABII586Y-r57",
      "diff_hunk": "@@ -3020,9 +2992,8 @@ static RPCHelpMan dumptxoutset()\n     return RPCHelpMan{\n         \"dumptxoutset\",\n         \"Write the serialized UTXO set to a file. This can be used in loadtxoutset afterwards if this snapshot height is supported in the chainparams as well.\\n\\n\"\n-        \"Unless the \\\"latest\\\" type is requested, the node will roll back to the requested height and network activity will be suspended during this process. \"\n-        \"Because of this it is discouraged to interact with the node in any other way during the execution of this call to avoid inconsistent results and race conditions, particularly RPCs that interact with blockstorage.\\n\\n\"\n-        \"This call may take several minutes. Make sure to use no RPC timeout (bitcoin-cli -rpcclienttimeout=0)\",\n+        \"This creates a temporary UTXO database when rolling back, keeping the main chain intact. Should the node experience an unclean shutdown the temporary database may need to be removed from the datadir manually.\\n\\n\"",
      "path": "src/rpc/blockchain.cpp",
      "position": 1,
      "original_position": 65,
      "commit_id": "6d409d59704a026a56d18856ab2f9e90eea62186",
      "original_commit_id": "f046286c0c5e1fef8b61da548cb97506f7a8b047",
      "in_reply_to_id": 2384138037,
      "user": {
        "login": "fjahr",
        "id": 1322187,
        "node_id": "MDQ6VXNlcjEzMjIxODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fjahr",
        "html_url": "https://github.com/fjahr",
        "followers_url": "https://api.github.com/users/fjahr/followers",
        "following_url": "https://api.github.com/users/fjahr/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fjahr/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fjahr/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
        "organizations_url": "https://api.github.com/users/fjahr/orgs",
        "repos_url": "https://api.github.com/users/fjahr/repos",
        "events_url": "https://api.github.com/users/fjahr/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fjahr/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think this is necessary, I don't think a user would naturally assume that there is a reason to suspend network activity for this. Previously we had to do this as basically a hack. When we don't do this anymore it would seem odd to me to mention it.",
      "created_at": "2025-11-26T21:48:26Z",
      "updated_at": "2025-11-26T21:48:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/33477#discussion_r2566569595",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2566569595"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/33477"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 2995,
      "side": "RIGHT"
    }
  ]
}