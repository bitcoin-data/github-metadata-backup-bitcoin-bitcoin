{
  "type": "pull",
  "pull": {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132",
    "id": 2138649533,
    "node_id": "PR_kwDOABII585_eTO9",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/31132",
    "diff_url": "https://github.com/bitcoin/bitcoin/pull/31132.diff",
    "patch_url": "https://github.com/bitcoin/bitcoin/pull/31132.patch",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132",
    "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132/commits",
    "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132/comments",
    "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments%7B/number%7D",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132/comments",
    "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/77c0df7b59ff5a3a77d37e77145f1a157e05db19",
    "number": 31132,
    "state": "open",
    "locked": false,
    "maintainer_can_modify": true,
    "title": "validation: fetch block inputs on parallel threads 3x faster IBD",
    "user": {
      "login": "andrewtoth",
      "id": 237213,
      "node_id": "MDQ6VXNlcjIzNzIxMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/andrewtoth",
      "html_url": "https://github.com/andrewtoth",
      "followers_url": "https://api.github.com/users/andrewtoth/followers",
      "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
      "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
      "repos_url": "https://api.github.com/users/andrewtoth/repos",
      "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
      "type": "User",
      "site_admin": false,
      "name": null,
      "patch_url": null
    },
    "body": "_Parts of this PR are isolated in independent smaller PRs to ease review:_\r\n\r\n* [x] _https://github.com/bitcoin/bitcoin/pull/34164_\r\n* [ ] _https://github.com/bitcoin/bitcoin/pull/34165_\r\n\r\n---\r\n\r\nThis PR parallelizes fetching all input prevouts of a block during block connection, achieving over 3x faster IBD performance in some scenarios[^1][^2][^3][^4][^5].\r\n\r\n### Problem\r\n\r\nCurrently, when fetching inputs in `ConnectBlock`, each input is fetched from the cache sequentially. A cache miss requires a round trip to the disk database to fetch the outpoint and insert it into the cache. Since the database is read-only during `ConnectBlock`, we can fetch all inputs of a block in parallel on multiple threads while connecting.\r\n\r\n### Solution\r\n\r\nWe introduce a new `CoinsViewCacheAsync` `CCoinsViewCache` subclass that manages worker threads to fetch block inputs in parallel. The block is passed to the `CoinsViewCacheAsync` view before entering `ConnectBlock`, which kicks off the worker threads to begin fetching the inputs. The view is then passed to `ConnectBlock` since it provides the same API as `CCoinsViewCache`. The cache returns fetched coins as they become available via the overridden `FetchCoin` method. If not available yet, the main thread also fetches coins as it waits.\r\n\r\n### Implementation Details\r\n\r\nThe `CoinsViewCacheAsync` implements a lock-free MPSC (Multiple Producer, Single Consumer) queue design:\r\n\r\n- **Work Distribution**: Collects all input prevouts into a queue and uses a barrier to start all worker threads simultaneously\r\n- **Synchronization**: Worker threads use an atomic counter to claim which inputs to fetch, and each input has an atomic flag to signal completion to the main thread\r\n- **Main Thread Processing**: The main thread waits for inputs in order and moves their `Coin` into the `cacheCoins` map as they become available.\r\n- **Work Stealing**: If the main thread catches up to the workers, it assists with fetching to maximize parallelism\r\n- **Completion**: All threads synchronize on a barrier via a `Reset` method, which ensures all threads are parked before proceeding\r\n\r\n### Safety and Correctness\r\n\r\n- The `CoinsViewCacheAsync` works on a block that has not been fully validated, but it does not interfere or modify any of the validation during `ConnectBlock`\r\n- It simply fetches inputs in parallel, which must be fetched before a transaction is validated anyways\r\n- **Invalid blocks**: If an invalid block is mined, the temporary cache is reset without being flushed. This is an improvement over the current behavior, where existing inputs are inserted into the main `CoinsTip()` cache when pulled through for an invalid block\r\n\r\n### Performance\r\n\r\nBenchmarks show over 3x faster IBD performance in a cloud environment with network connected storage[^1], 3x faster IBD for an M4 Mac and up to 46% faster with directly connected storage[^2][^3][^4][^5]. The parallelization of expensive disk lookups provides significant speedup.\r\n\r\n[Flamegraphs show how the execution is changed](https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3617315125).\r\n\r\n### Credits\r\n\r\nInspired by [this comment](https://github.com/bitcoin/bitcoin/pull/18941#issuecomment-638553680).\r\n\r\nResolves https://github.com/bitcoin/bitcoin/issues/34121.\r\n\r\n[^1]: https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3678847806\r\n[^2]: https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3515011880\r\n[^3]: https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3463894000\r\n[^4]: https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3347436866\r\n[^5]: https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3488760623",
    "labels": [
      {
        "id": 118379652,
        "node_id": "MDU6TGFiZWwxMTgzNzk2NTI=",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation",
        "name": "Validation",
        "color": "6060aa",
        "default": false
      }
    ],
    "created_at": "2024-10-22T14:40:28Z",
    "updated_at": "2026-01-31T20:12:44Z",
    "mergeable": true,
    "mergeable_state": "blocked",
    "merged": false,
    "merge_commit_sha": "e629d5d2a9b7bfb592f407704109919994bf688e",
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "rebaseable": true,
    "head": {
      "label": "andrewtoth:threaded-inputs",
      "ref": "threaded-inputs",
      "sha": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 156145027,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNTYxNDUwMjc=",
        "name": "bitcoin",
        "full_name": "andrewtoth/bitcoin",
        "owner": {
          "login": "andrewtoth",
          "id": 237213,
          "node_id": "MDQ6VXNlcjIzNzIxMw==",
          "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/andrewtoth",
          "html_url": "https://github.com/andrewtoth",
          "followers_url": "https://api.github.com/users/andrewtoth/followers",
          "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
          "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
          "repos_url": "https://api.github.com/users/andrewtoth/repos",
          "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
          "type": "User",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/andrewtoth/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": true,
        "url": "https://api.github.com/repos/andrewtoth/bitcoin",
        "archive_url": "https://api.github.com/repos/andrewtoth/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/andrewtoth/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/andrewtoth/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/andrewtoth/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/andrewtoth/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/andrewtoth/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/andrewtoth/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/andrewtoth/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/andrewtoth/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/andrewtoth/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/andrewtoth/bitcoin/events",
        "forks_url": "https://api.github.com/repos/andrewtoth/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/andrewtoth/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/andrewtoth/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/andrewtoth/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/andrewtoth/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/andrewtoth/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/andrewtoth/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/andrewtoth/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/andrewtoth/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/andrewtoth/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/andrewtoth/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:andrewtoth/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/andrewtoth/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/andrewtoth/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/andrewtoth/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/andrewtoth/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/andrewtoth/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/andrewtoth/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/andrewtoth/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/andrewtoth/bitcoin/hooks",
        "svn_url": "https://github.com/andrewtoth/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 1,
        "stargazers_count": 1,
        "watchers_count": 1,
        "size": 295708,
        "default_branch": "master",
        "open_issues_count": 0,
        "is_template": false,
        "topics": [],
        "has_issues": false,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2026-01-31T20:35:45Z",
        "created_at": "2018-11-05T01:43:59Z",
        "updated_at": "2025-11-13T15:07:23Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "base": {
      "label": "bitcoin:master",
      "ref": "master",
      "sha": "5401e673d56198f2c0bad366581e70d5d9cd765c",
      "user": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "repo": {
        "id": 1181927,
        "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
        "name": "bitcoin",
        "full_name": "bitcoin/bitcoin",
        "owner": {
          "login": "bitcoin",
          "id": 528860,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/bitcoin",
          "html_url": "https://github.com/bitcoin",
          "followers_url": "https://api.github.com/users/bitcoin/followers",
          "following_url": "https://api.github.com/users/bitcoin/following%7B/other_user%7D",
          "gists_url": "https://api.github.com/users/bitcoin/gists%7B/gist_id%7D",
          "starred_url": "https://api.github.com/users/bitcoin/starred%7B/owner%7D%7B/repo%7D",
          "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
          "organizations_url": "https://api.github.com/users/bitcoin/orgs",
          "repos_url": "https://api.github.com/users/bitcoin/repos",
          "events_url": "https://api.github.com/users/bitcoin/events%7B/privacy%7D",
          "received_events_url": "https://api.github.com/users/bitcoin/received_events",
          "type": "Organization",
          "site_admin": false,
          "name": null,
          "patch_url": null
        },
        "private": false,
        "html_url": "https://github.com/bitcoin/bitcoin",
        "description": "Bitcoin Core integration/staging tree",
        "fork": false,
        "url": "https://api.github.com/repos/bitcoin/bitcoin",
        "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/%7Barchive_format%7D%7B/ref%7D",
        "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees%7B/user%7D",
        "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs%7B/sha%7D",
        "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches%7B/branch%7D",
        "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators%7B/collaborator%7D",
        "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments%7B/number%7D",
        "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits%7B/sha%7D",
        "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/%7Bbase%7D...%7Bhead%7D",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/%7B+path%7D",
        "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
        "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
        "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
        "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
        "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
        "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits%7B/sha%7D",
        "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs%7B/sha%7D",
        "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags%7B/sha%7D",
        "git_url": "git://github.com/bitcoin/bitcoin.git",
        "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments%7B/number%7D",
        "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events%7B/number%7D",
        "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues%7B/number%7D",
        "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys%7B/key_id%7D",
        "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels%7B/name%7D",
        "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
        "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
        "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones%7B/number%7D",
        "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications%7B?since,all,participating}",
        "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls%7B/number%7D",
        "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases%7B/id%7D",
        "ssh_url": "git@github.com:bitcoin/bitcoin.git",
        "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
        "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/%7Bsha%7D",
        "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
        "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
        "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
        "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
        "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees%7B/sha%7D",
        "clone_url": "https://github.com/bitcoin/bitcoin.git",
        "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
        "svn_url": "https://github.com/bitcoin/bitcoin",
        "homepage": "https://bitcoincore.org/en/download",
        "language": "C++",
        "forks_count": 38820,
        "stargazers_count": 87843,
        "watchers_count": 87843,
        "size": 302866,
        "default_branch": "master",
        "open_issues_count": 743,
        "is_template": false,
        "topics": [
          "bitcoin",
          "c-plus-plus",
          "cryptocurrency",
          "cryptography",
          "p2p"
        ],
        "has_issues": true,
        "has_projects": true,
        "has_wiki": false,
        "has_pages": false,
        "has_downloads": false,
        "archived": false,
        "disabled": false,
        "visibility": "public",
        "pushed_at": "2026-01-31T14:05:49Z",
        "created_at": "2010-12-19T15:16:43Z",
        "updated_at": "2026-01-31T20:47:54Z",
        "allow_forking": true,
        "license": {
          "key": "mit",
          "name": "MIT License",
          "node_id": "MDc6TGljZW5zZTEz",
          "spdx_id": "MIT",
          "url": "https://api.github.com/licenses/mit",
          "html_url": null,
          "description": null,
          "implementation": null,
          "permissions": null,
          "conditions": null,
          "limitations": null,
          "body": null,
          "featured": null
        }
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
      }
    },
    "author_association": "CONTRIBUTOR",
    "draft": false,
    "additions": 763,
    "deletions": 50,
    "changed_files": 12,
    "commits": 10,
    "review_comments": 447,
    "comments": 68
  },
  "events": [
    {
      "event": "commented",
      "id": 2429478185,
      "node_id": "IC_kwDOABII586QzuUp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2429478185",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:40:31Z",
      "updated_at": "2026-01-31T20:12:44Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--006a51241073e994b41acfe9ec718e94-->\n### Code Coverage & Benchmarks\nFor details see: https://corecheck.dev/bitcoin/bitcoin/pulls/31132.\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ismaelsadeeq](https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2462618817), [Raimo33](https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3356601737), [l0rinc](https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3767758819) |\n\nIf your review is incorrectly listed, please copy-paste <code>&lt;!--meta-tag:bot-skip--&gt;</code> into the comment that the bot should ignore.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#34320](https://github.com/bitcoin/bitcoin/pull/34320) (coins: replace remaining `HaveCoin` calls with `GetCoin` by l0rinc)\n* [#34165](https://github.com/bitcoin/bitcoin/pull/34165) (coins: don't mutate main cache when connecting block by andrewtoth)\n* [#34164](https://github.com/bitcoin/bitcoin/pull/34164) (validation: add reusable coins view for ConnectBlock by andrewtoth)\n* [#34132](https://github.com/bitcoin/bitcoin/pull/34132) (refactor: inline `CCoinsViewErrorCatcher` into `CCoinsViewDB` by l0rinc)\n* [#34124](https://github.com/bitcoin/bitcoin/pull/34124) (refactor: make `CCoinsView` a purely virtual abstract base class by l0rinc)\n* [#32317](https://github.com/bitcoin/bitcoin/pull/32317) (kernel: Separate UTXO set access from validation functions by sedited)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n<!--5faf32d7da4f0f540f40219e4f7537a3-->",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2429478185",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14786916578,
      "node_id": "LE_lADOABII586bT0I_zwAAAANxXnDi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14786916578",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:40:34Z",
      "label": {
        "name": "Validation",
        "color": "6060aa"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14787017217,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxX_oB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787017217",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9fcd08ea0e440c89c1a34aec9e31aaab53f559c4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9fcd08ea0e440c89c1a34aec9e31aaab53f559c4",
      "created_at": "2024-10-22T14:45:41Z"
    },
    {
      "event": "commented",
      "id": 2429491813,
      "node_id": "IC_kwDOABII586Qzxpl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2429491813",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:45:47Z",
      "updated_at": "2024-10-22T14:45:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/31894441286</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2429491813",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14787019013,
      "node_id": "LE_lADOABII586bT0I_zwAAAANxYAEF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787019013",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:45:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "renamed",
      "id": 14787094471,
      "node_id": "RTE_lADOABII586bT0I_zwAAAANxYSfH",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787094471",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T14:49:35Z",
      "rename": {
        "from": "validation: fetch block inputs parallel threads ~17% faster IBD",
        "to": "validation: fetch block inputs on parallel threads ~17% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14787303983,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxZFov",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14787303983",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fe0fe597cd0e510ae104fbce5823bc13e04bec82",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fe0fe597cd0e510ae104fbce5823bc13e04bec82",
      "created_at": "2024-10-22T14:59:45Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14788613835,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxeFbL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14788613835",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e2feb0cc7c62338c2f06c1da638818594f68ad32",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e2feb0cc7c62338c2f06c1da638818594f68ad32",
      "created_at": "2024-10-22T16:12:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14790893735,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAANxmyCn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14790893735",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "created_at": "2024-10-22T18:46:51Z"
    },
    {
      "event": "unlabeled",
      "id": 14792905981,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAANxudT9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14792905981",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-22T21:09:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "reviewed",
      "id": 2388117544,
      "node_id": "PRR_kwDOABII586OV8go",
      "url": null,
      "actor": null,
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-10-23T13:15:17Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK\r\n\r\nI'm still missing tests and benchmarks here and I think we need to find better default values for SSD and HDD parallelism, and I'd be interested in how coroutines would perform here instead of trying to find the best batching size manually.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2388117544",
      "submitted_at": "2024-10-23T12:44:26Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 2388943653,
      "node_id": "PRR_kwDOABII586OZGMl",
      "url": null,
      "actor": null,
      "commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-10-23T14:27:10Z",
      "author_association": "MEMBER",
      "body": "Cool idea.\r\n\r\nSince the inputs fetcher call is blocking, instead of creating a new set of worker threads, what do you think about re-using the existing script validation ones (or any other unused worker threads) by implementing a general-purpose thread pool shared among the validation checks? \r\nThe script validation checks and the inputs fetching mechanism are never done concurrently because you need the inputs in order to verify the scripts. So, they could share workers.\r\n\r\nThis should be benchmarked because it might add some overhead but, #26966 introduces such structure inside 401f21bfd72f32a28147677af542887518a4dbff, which we could pull off and use for validation.",
      "user": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2388943653",
      "submitted_at": "2024-10-23T14:25:41Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 2432481201,
      "node_id": "IC_kwDOABII586Q_Lex",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2432481201",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-23T14:48:28Z",
      "updated_at": "2024-10-23T14:48:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "> implementing a general-purpose thread pool shared among the validation checks?\r\n\r\nNice, yes that would be great! That would simplify this PR a lot if it could just schedule tasks on worker threads and receive the responses, instead of implementing all the sync code itself.\r\n\r\n> https://github.com/bitcoin/bitcoin/pull/26966 introduces such structure inside https://github.com/bitcoin/bitcoin/commit/401f21bfd72f32a28147677af542887518a4dbff, which we could pull off and use for validation.\r\n\r\nConcept ACK!",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2432481201",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2436046062,
      "node_id": "IC_kwDOABII586RMxzu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436046062",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T18:12:38Z",
      "updated_at": "2024-10-26T15:04:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "Finished benching on a HDD until 860k on Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz, CPU = 8:\r\n\r\n```bash\r\nSummary\r\n'COMMIT=f278ca4ec3f0a90c285e640f1a270869ca594d20 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0' ran\r\n 1.02 times faster than 'COMMIT=e9e23b59f8eedb8dfae75aa660328299fba92b50 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=\r\n0'\r\n```\r\n\r\n> f278ca4ec3 coins: allow emplacing non-dirty coins internally (39993.343777768874 seconds = 11.1 hours)\r\n> e9e23b59f8 validation: fetch block inputs in parallel (40929.84310861388 seconds = 11.3 hours)\r\n\r\n-----\r\n\r\n~So likely on HDD we shouldn't use so many threads, apparently it slows down IBD.~\r\nMaybe we could add a new config option (`iothreads` or `iothreadmultiplier` or something).\r\nThe defaults should likely depend on whether it's an SSD or HDD.\r\n\r\n-----\r\n\r\nEdit:\r\n\r\n<details>\r\n<summary>Previous results</summary>\r\n\r\n```bash\r\n\"command\": \"COMMIT=f278ca4ec3f0a90c285e640f1a270869ca594d20 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [39993.343777768874],\r\n\r\n\"command\": \"COMMIT=e9e23b59f8eedb8dfae75aa660328299fba92b50 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [40929.84310861388],\r\n```\r\n\r\n</details>\r\n\r\nI have retried the same with half the parallelism (rebased, but no other change in the end, otherwise the results would be hard to interpret):\r\n```bash\r\n\"command\": \"COMMIT=8207d372b2fac24af0f8999b30e71e88d40b3a13 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=10000 -printtoconsole=0\",\r\n\"times\": [40579.00445769842],\r\n``` \r\n\r\nSo it's a tiny bit faster than before (surprisingly stable for an actual IBD with real peers), but still slower-than/same-as before, so not sure why it's not faster.\r\n\r\n----\r\n\r\nEdit:\r\n\r\nRunning it on a HDD with a low dbcache value reproduces the original result:\r\n\r\n<details>\r\n<summary>benchmark</summary>\r\n\r\n```bash\r\nhyperfine --runs 1 --show-output --export-json /mnt/my_storage/ibd_full-threaded-inputs-3.json --parameter-list COMMIT 92fc718592be55812b2c73a3bf57599fc81425fa,8207d372b2fac24af0f8999b30e71e88d40b3a13 --prepare 'rm -rf /mnt/my_storage/BitcoinData/* && git checkout {COMMIT} && git clean -fxd && git reset --hard && cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_UTIL=OFF -DBUILD_TX=OFF -DBUILD_TESTS=OFF -DENABLE_WALLET=OFF -DINSTALL_MAN=OFF && cmake --build build -j$(nproc)' 'COMMIT={COMMIT} ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0'\r\n```\r\n\r\n</details>\r\n\r\n```bash\r\n8207d372b2 validation: fetch block inputs in parallel\r\n92fc718592 coins: allow emplacing non-dirty coins internally\r\nSummary\r\n  'COMMIT=8207d372b2fac24af0f8999b30e71e88d40b3a13 ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0' ran\r\n    1.16 times faster than 'COMMIT=92fc718592be55812b2c73a3bf57599fc81425fa ./build/src/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=860000 -dbcache=1000 -printtoconsole=0'\r\n```",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436046062",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2436080216,
      "node_id": "IC_kwDOABII586RM6JY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436080216",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T18:31:14Z",
      "updated_at": "2024-10-24T18:31:14Z",
      "author_association": "CONTRIBUTOR",
      "body": "> So likely on HDD we shouldn't use so many threads, apparently it slows down IBD.\r\n\r\nI'm not sure we can conclude that from your benchmark. It used a very high dbcache setting, which makes the effect of this change less important. It also is syncing from untrusted network peers, so there is some variance which could also account for the 2% difference.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436080216",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14856978808,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN1i4F4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14856978808",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "942f3006fcc85be70fb174c99b73e7b9022cfcdb",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/942f3006fcc85be70fb174c99b73e7b9022cfcdb",
      "created_at": "2024-10-24T18:40:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14857622714,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN1lVS6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14857622714",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8207d372b2fac24af0f8999b30e71e88d40b3a13",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8207d372b2fac24af0f8999b30e71e88d40b3a13",
      "created_at": "2024-10-24T19:25:33Z"
    },
    {
      "event": "commented",
      "id": 2436178257,
      "node_id": "IC_kwDOABII586RNSFR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2436178257",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T19:25:38Z",
      "updated_at": "2024-10-24T19:25:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/32027275494</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2436178257",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 14857623683,
      "node_id": "LE_lADOABII586bT0I_zwAAAAN1lViD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14857623683",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-24T19:25:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 14869493997,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAN2Snjt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14869493997",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-25T09:58:21Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14910229658,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4uAya",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910229658",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a0f6902ad1b965a42d5362329910eb6c1c9adfa1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a0f6902ad1b965a42d5362329910eb6c1c9adfa1",
      "created_at": "2024-10-26T18:47:56Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14910333712,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4uaMQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910333712",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a00dbc56fa29bc2c138b97e478517260cda99f7f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a00dbc56fa29bc2c138b97e478517260cda99f7f",
      "created_at": "2024-10-26T18:51:56Z"
    },
    {
      "event": "labeled",
      "id": 14910335810,
      "node_id": "LE_lADOABII586bT0I_zwAAAAN4uatC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14910335810",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-26T18:52:00Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2439692907,
      "node_id": "IC_kwDOABII586RasJr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2439692907",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-26T18:52:01Z",
      "updated_at": "2024-10-26T18:52:01Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/32107893176</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2439692907",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14911794047,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4z-t_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14911794047",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "54b3b484af9775c8bcd3ca47f50ae23b2fc18955",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/54b3b484af9775c8bcd3ca47f50ae23b2fc18955",
      "created_at": "2024-10-26T20:01:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14914596074,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN4-qzq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14914596074",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d5b9484f623133d7f5396fb84b36450c3dcdc689",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d5b9484f623133d7f5396fb84b36450c3dcdc689",
      "created_at": "2024-10-26T22:14:00Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14914980894,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5AIwe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14914980894",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7115abe5140c7cba2c1f31f531ff8ac48ebe5d11",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7115abe5140c7cba2c1f31f531ff8ac48ebe5d11",
      "created_at": "2024-10-26T22:31:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14915740952,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5DCUY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14915740952",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "f7ab210e5437674193ac21274fa6dbee77acc6cf",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/f7ab210e5437674193ac21274fa6dbee77acc6cf",
      "created_at": "2024-10-26T23:07:17Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14917256589,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5I0WN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14917256589",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "893c0b9c8f7d37caa69b409cc43a261bf3c04988",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/893c0b9c8f7d37caa69b409cc43a261bf3c04988",
      "created_at": "2024-10-27T00:11:36Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14920099117,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5TqUt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14920099117",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3f58a51e0881c511f4ce1550581e0b7eb2bd7396",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3f58a51e0881c511f4ce1550581e0b7eb2bd7396",
      "created_at": "2024-10-27T04:45:57Z"
    },
    {
      "event": "convert_to_draft",
      "id": 14925130762,
      "node_id": "CTDE_lADOABII586bT0I_zwAAAAN5m2wK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14925130762",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-10-27T13:28:41Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14925301705,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5ngfJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14925301705",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5a79235454ada6e08ada95a07bbd01c42689ee29",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5a79235454ada6e08ada95a07bbd01c42689ee29",
      "created_at": "2024-10-27T13:40:24Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14926730470,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5s9Tm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14926730470",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ab6fbdf698e595758d6d43c512bc3dc6754e4803",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ab6fbdf698e595758d6d43c512bc3dc6754e4803",
      "created_at": "2024-10-27T15:15:00Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14926840604,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5tYMc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14926840604",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "4ae00c48add4f6e74dccf2339f41968a57ecd5c1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/4ae00c48add4f6e74dccf2339f41968a57ecd5c1",
      "created_at": "2024-10-27T15:21:57Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14927991893,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5xxRV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14927991893",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ee5b899ef80b1e78741aed54d583ba40d8402cc9",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ee5b899ef80b1e78741aed54d583ba40d8402cc9",
      "created_at": "2024-10-27T16:37:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14928181449,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN5yfjJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14928181449",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2eb2872524cc8e4156179180e8f770092b762b31",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2eb2872524cc8e4156179180e8f770092b762b31",
      "created_at": "2024-10-27T16:51:17Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14928621817,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN50LD5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14928621817",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7e7e4092551ebaface97b945cd70c46448915245",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7e7e4092551ebaface97b945cd70c46448915245",
      "created_at": "2024-10-27T17:19:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 14931091175,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAN59l7n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/14931091175",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0d1c6375579985dc214bfc00b4eff67b87782ede",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0d1c6375579985dc214bfc00b4eff67b87782ede",
      "created_at": "2024-10-27T19:55:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15163921481,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOH1xRJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15163921481",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ccbde0f075ad9ab259b2225b9b56d98593b73f60",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ccbde0f075ad9ab259b2225b9b56d98593b73f60",
      "created_at": "2024-11-07T00:54:22Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15164034996,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOH2M-0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15164034996",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "89b1a1d830bff178ac1ee35ff39ed6b55bb5aa1a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/89b1a1d830bff178ac1ee35ff39ed6b55bb5aa1a",
      "created_at": "2024-11-07T00:59:53Z"
    },
    {
      "event": "unlabeled",
      "id": 15165724918,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOH8pj2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15165724918",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T02:25:20Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15169496211,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOILCST",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15169496211",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1a4ad617529fa0d1833c0c260b0429a948e0374e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1a4ad617529fa0d1833c0c260b0429a948e0374e",
      "created_at": "2024-11-07T05:22:21Z"
    },
    {
      "event": "ready_for_review",
      "id": 15183787339,
      "node_id": "RFRE_lADOABII586bT0I_zwAAAAOJBjVL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183787339",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:01:24Z"
    },
    {
      "event": "commented",
      "id": 2462468543,
      "node_id": "IC_kwDOABII586Sxkm_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2462468543",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:31Z",
      "updated_at": "2024-11-07T15:05:31Z",
      "author_association": "CONTRIBUTOR",
      "body": "@furszy I tried to switch to using a shared threadpool, but it is much slower that way. We need a way to have shared state between threads for this, instead of just scheduling tasks. I suppose the generic threadpool is great for scheduling independent tasks like indexing an individual block, but for quickly pulling outpoints off a shared vector it is not optimized well.\r\n\r\nFrom https://github.com/bitcoin/bitcoin/issues/29386:\r\n> I just [noticed the comment in the code](https://github.com/bitcoin/bitcoin/blob/9eeee7caa3f95ee17a645e12d330261f8e3c2dbf/doc/reduce-memory.md?plain=1#L37C1-L39C15):\r\n>>    For each thread a thread stack needs to be allocated. By default on Linux,\r\n    threads take up 8MiB for the thread stack on a 64-bit system, and 4MiB in a\r\n    32-bit system.\r\n\r\n> Only 8MiB of Virtual Memory is allocated, which doesn't really mean anything. Due to CoW mechanism, only the parts of stack that are being used will be allocated as Physical Memory which is the one that actually matters.\r\n\r\nSo, I don't think it matters much to have an extra threadpool owned by the input fetcher.\r\n\r\nI think this is ready for more review. I also added tests and a benchmark.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2462468543",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 15183942257,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAOJCJJx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183942257",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:32Z"
    },
    {
      "event": "subscribed",
      "id": 15183942283,
      "node_id": "SE_lADOABII586bT0I_zwAAAAOJCJKL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15183942283",
      "actor": {
        "login": "furszy",
        "id": 5377650,
        "node_id": "MDQ6VXNlcjUzNzc2NTA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5377650?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/furszy",
        "html_url": "https://github.com/furszy",
        "followers_url": "https://api.github.com/users/furszy/followers",
        "following_url": "https://api.github.com/users/furszy/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/furszy/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/furszy/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/furszy/subscriptions",
        "organizations_url": "https://api.github.com/users/furszy/orgs",
        "repos_url": "https://api.github.com/users/furszy/repos",
        "events_url": "https://api.github.com/users/furszy/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/furszy/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-07T15:05:32Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15189550538,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOJXiXK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15189550538",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "910bf42e0065d205b50c2e1960c63e5f9b867d3a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/910bf42e0065d205b50c2e1960c63e5f9b867d3a",
      "created_at": "2024-11-07T18:38:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15239155612,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOMUw-c",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15239155612",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "66bbde0ec074c68ddc4145e2d3c33e877a8a132c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/66bbde0ec074c68ddc4145e2d3c33e877a8a132c",
      "created_at": "2024-11-09T18:21:42Z"
    },
    {
      "event": "commented",
      "id": 2473948407,
      "node_id": "IC_kwDOABII586TdXT3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2473948407",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-13T15:28:15Z",
      "updated_at": "2024-11-13T15:28:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "For later blocks where cache misses are much more common, this change has an even bigger impact.\r\nThis benchmark report shows a 40% speedup measuring from blocks 840k to 850k. Also, compare flamegraphs of master and this branch, where the latter has 15 worker threads fetching coins from disk.\r\nhttps://bitcoin-dev-tools.github.io/benchcoin/results/pr-19/11798124132/index.html",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2473948407",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 2480372333,
      "node_id": "IC_kwDOABII586T13pt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2480372333",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T03:35:49Z",
      "updated_at": "2024-11-16T03:35:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "Even with just 2 worker threads, there is significant (~30%) speed improvement for syncing recent blocks.\r\nhttps://bitcoin-dev-tools.github.io/benchcoin/results/pr-19/11865650166/index.html",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2480372333",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15320436676,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORK0_E",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15320436676",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "97e90b5ac5a5a83a9305b8c9573760996b069419",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/97e90b5ac5a5a83a9305b8c9573760996b069419",
      "created_at": "2024-11-16T03:40:41Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15320841157,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORMXvF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15320841157",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c38cf8f92fff1df5c40b3c10e699726adc68b535",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c38cf8f92fff1df5c40b3c10e699726adc68b535",
      "created_at": "2024-11-16T07:52:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322202672,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORRkIw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322202672",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "faf19f18031ead55b1d441444a1b30b8de8bbfab",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/faf19f18031ead55b1d441444a1b30b8de8bbfab",
      "created_at": "2024-11-16T19:35:04Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322230462,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORRq6-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322230462",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ea8e67ca7d8a76c87f9df3617ea287f339b3f44b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ea8e67ca7d8a76c87f9df3617ea287f339b3f44b",
      "created_at": "2024-11-16T19:45:00Z"
    },
    {
      "event": "commented",
      "id": 2480756343,
      "node_id": "IC_kwDOABII586T3VZ3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2480756343",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T19:45:10Z",
      "updated_at": "2024-11-16T19:45:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33086747731</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2480756343",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15322230898,
      "node_id": "LE_lADOABII586bT0I_zwAAAAORRrBy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322230898",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T19:45:10Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322459653,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORSi4F",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322459653",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "887ab0c0a12a12e5ebc91a98c6b3972a6bc29af4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/887ab0c0a12a12e5ebc91a98c6b3972a6bc29af4",
      "created_at": "2024-11-16T20:56:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15322466773,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORSknV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322466773",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7ff688350de239d752a42d216b44fad75ec698a6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7ff688350de239d752a42d216b44fad75ec698a6",
      "created_at": "2024-11-16T20:58:46Z"
    },
    {
      "event": "unlabeled",
      "id": 15322621035,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAORTKRr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15322621035",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-16T21:38:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15323161161,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAORVOJJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15323161161",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "created_at": "2024-11-17T00:02:59Z"
    },
    {
      "event": "reviewed",
      "id": 2442755733,
      "node_id": "PRR_kwDOABII586RmX6V",
      "url": null,
      "actor": null,
      "commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-18T14:22:14Z",
      "author_association": "MEMBER",
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2442755733",
      "submitted_at": "2024-11-18T14:22:14Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15335691084,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSFBNM",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15335691084",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1fe34824cf75628e6b180e9ed5e6eb1b9ba98709",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1fe34824cf75628e6b180e9ed5e6eb1b9ba98709",
      "created_at": "2024-11-18T14:54:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15336267654,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSHN-G",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15336267654",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8b813495d132ff2390e039ac6cb321b82b51efd6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8b813495d132ff2390e039ac6cb321b82b51efd6",
      "created_at": "2024-11-18T15:33:59Z"
    },
    {
      "event": "commented",
      "id": 2483393645,
      "node_id": "IC_kwDOABII586UBZRt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2483393645",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T15:34:04Z",
      "updated_at": "2024-11-18T15:34:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33143571653</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2483393645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15336268823,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOSHOQX",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15336268823",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T15:34:04Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15337346046,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSLVP-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15337346046",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "992c76f3bb1a2d091f7604208a09f94ceff75509",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/992c76f3bb1a2d091f7604208a09f94ceff75509",
      "created_at": "2024-11-18T16:49:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338125165,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSOTdt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338125165",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5e05539ee48d3d4786f573d05a6ba9e89a8e74f6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5e05539ee48d3d4786f573d05a6ba9e89a8e74f6",
      "created_at": "2024-11-18T17:54:07Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338487303,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSPr4H",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338487303",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0875e93322ae53b2ac7d9418501f002da73b258b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0875e93322ae53b2ac7d9418501f002da73b258b",
      "created_at": "2024-11-18T18:25:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15338614667,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSQK-L",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15338614667",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "28e739e557de92b287546b211f763bd890d00c2d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/28e739e557de92b287546b211f763bd890d00c2d",
      "created_at": "2024-11-18T18:37:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15339145882,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSSMqa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15339145882",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "04b3f4529e804cfcdc79135a1929535b578860cd",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/04b3f4529e804cfcdc79135a1929535b578860cd",
      "created_at": "2024-11-18T19:26:05Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15339688166,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSURDm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15339688166",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "created_at": "2024-11-18T20:08:53Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15340495444,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOSXWJU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15340495444",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3a9553dbd55836c1a17583b4421f4dd9c8bd65cf",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3a9553dbd55836c1a17583b4421f4dd9c8bd65cf",
      "created_at": "2024-11-18T21:24:26Z"
    },
    {
      "event": "unlabeled",
      "id": 15340858532,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOSYuyk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15340858532",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-18T22:03:21Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15349486168,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOS5pJY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15349486168",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "02ae43e470ed16943ef8783dbc59784ac7e6bbb1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/02ae43e470ed16943ef8783dbc59784ac7e6bbb1",
      "created_at": "2024-11-19T13:22:25Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15350958942,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOS_Qte",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15350958942",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d35740b5c63ceb2157518c572e76063f1d2968f2",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d35740b5c63ceb2157518c572e76063f1d2968f2",
      "created_at": "2024-11-19T15:02:27Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15371196417,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUMdgB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371196417",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "24a523084d061020a94fc13709cb0c99862e6687",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/24a523084d061020a94fc13709cb0c99862e6687",
      "created_at": "2024-11-20T18:19:29Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15371454684,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUNcjc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371454684",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "created_at": "2024-11-20T18:46:12Z"
    },
    {
      "event": "labeled",
      "id": 15371455548,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOUNcw8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15371455548",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T18:46:17Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2489311955,
      "node_id": "IC_kwDOABII586UX-LT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2489311955",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T18:46:18Z",
      "updated_at": "2024-11-20T18:46:18Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33279820062</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2489311955",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 2445676953,
      "node_id": "PRR_kwDOABII586RxhGZ",
      "url": null,
      "actor": null,
      "commit_id": "95e6b0d189b770af2d29fbdae93c5b34290848a7",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-20T18:48:56Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2445676953",
      "submitted_at": "2024-11-20T18:48:56Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15373145284,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOUT5TE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15373145284",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "530d615acaf2db1adcb5ec58e23dc4967ed5a028",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/530d615acaf2db1adcb5ec58e23dc4967ed5a028",
      "created_at": "2024-11-20T21:45:00Z"
    },
    {
      "event": "unlabeled",
      "id": 15373675774,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOUV6z-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15373675774",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-20T22:49:48Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15385044720,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOVBSbw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385044720",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "934094ef5701e5d6d576a93cf511d9db0038e982",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/934094ef5701e5d6d576a93cf511d9db0038e982",
      "created_at": "2024-11-21T16:33:51Z"
    },
    {
      "event": "commented",
      "id": 2491818543,
      "node_id": "IC_kwDOABII586UhiIv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2491818543",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:12:26Z",
      "updated_at": "2024-11-21T17:12:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33335042693</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2491818543",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15385588395,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOVDXKr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385588395",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:12:26Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15385659114,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOVDobq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15385659114",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0d79c3688597d98d28f1d5db1ecf5645e3cfbd49",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0d79c3688597d98d28f1d5db1ecf5645e3cfbd49",
      "created_at": "2024-11-21T17:18:02Z"
    },
    {
      "event": "unsubscribed",
      "id": 15386015162,
      "node_id": "UE_lADOABII586bT0I_zwAAAAOVE_W6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15386015162",
      "actor": {
        "login": "jixi1991",
        "id": 5715530,
        "node_id": "MDQ6VXNlcjU3MTU1MzA=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5715530?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jixi1991",
        "html_url": "https://github.com/jixi1991",
        "followers_url": "https://api.github.com/users/jixi1991/followers",
        "following_url": "https://api.github.com/users/jixi1991/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jixi1991/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jixi1991/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jixi1991/subscriptions",
        "organizations_url": "https://api.github.com/users/jixi1991/orgs",
        "repos_url": "https://api.github.com/users/jixi1991/repos",
        "events_url": "https://api.github.com/users/jixi1991/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jixi1991/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T17:48:23Z"
    },
    {
      "event": "unlabeled",
      "id": 15386239028,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOVF2A0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15386239028",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-11-21T18:06:24Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15405352594,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOWOwaS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15405352594",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "895e94bb76e227aa0e6c4d2f2fc00b7ef5d17066",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/895e94bb76e227aa0e6c4d2f2fc00b7ef5d17066",
      "created_at": "2024-11-22T23:46:40Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15411272108,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOWlVms",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15411272108",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "created_at": "2024-11-24T19:10:17Z"
    },
    {
      "event": "reviewed",
      "id": 2462618817,
      "node_id": "PRR_kwDOABII586SyJTB",
      "url": null,
      "actor": null,
      "commit_id": "a236c9ec3858e892276bb528a9d29cb3aa72bfb3",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2024-11-26T20:55:39Z",
      "author_association": "MEMBER",
      "body": "Concept ACK\r\nThis is nice. Although I have not yet benchmarked this branch, I also like @furszy's idea of having a general-purpose thread pool.\r\n\r\nI just have one test improvement comment, question and a nit after first pass of the PR",
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2462618817",
      "submitted_at": "2024-11-26T20:55:39Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "labeled",
      "id": 15517599072,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOc68Vg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517599072",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T00:20:07Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15517806626,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc7vAi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517806626",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c2e3f6e8f23836d1f49201f0ede64e3749838a50",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c2e3f6e8f23836d1f49201f0ede64e3749838a50",
      "created_at": "2024-12-04T00:54:40Z"
    },
    {
      "event": "commented",
      "id": 2515910524,
      "node_id": "IC_kwDOABII586V9b98",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2515910524",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:02:47Z",
      "updated_at": "2024-12-04T17:21:54Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased. Since #30039 reading inputs is much faster, so the effect of this is somewhat less significant (17% -> 10%). It's still a significant speedup though so still worth it. Especially for worst case where the cache is completely empty, like on startup or right after it gets flushed due to size.\r\n\r\nIt is also refactored significantly. The main thread now writes everything before notifying threads, and then joins in working. This lets us do significantly less work in the critical section and parallelize more checks.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2515910524",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 15517864077,
      "node_id": "RTE_lADOABII586bT0I_zwAAAAOc79CN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15517864077",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:04:10Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads ~17% faster IBD",
        "to": "validation: fetch block inputs on parallel threads 10% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15518016570,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc8iQ6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518016570",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9d33a3a28b7bc9b2957bb528cf40476d8bc8c7ce",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9d33a3a28b7bc9b2957bb528cf40476d8bc8c7ce",
      "created_at": "2024-12-04T01:29:45Z"
    },
    {
      "event": "commented",
      "id": 2515966098,
      "node_id": "IC_kwDOABII586V9piS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2515966098",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:29:50Z",
      "updated_at": "2024-12-04T01:29:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Debug: https://github.com/bitcoin/bitcoin/runs/33884531020</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2515966098",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 15518016992,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOc8iXg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518016992",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T01:29:50Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15518169523,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOc9Hmz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518169523",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a544477011c40ee98a0c0254dfb968d6233ef811",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a544477011c40ee98a0c0254dfb968d6233ef811",
      "created_at": "2024-12-04T01:56:23Z"
    },
    {
      "event": "unlabeled",
      "id": 15518350100,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOc9zsU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518350100",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T02:24:38Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 15518493046,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOc-Wl2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15518493046",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-04T02:49:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "labeled",
      "id": 15534194608,
      "node_id": "LE_lADOABII586bT0I_zwAAAAOd6P-w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534194608",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T00:37:19Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 15534228148,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAOd6YK0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534228148",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b2da76444613229e0bf5539596903ac3c1db3053",
      "created_at": "2024-12-05T00:43:37Z"
    },
    {
      "event": "unlabeled",
      "id": 15534948844,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAOd9IHs",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/15534948844",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2024-12-05T02:50:11Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "subscribed",
      "id": 16651261972,
      "node_id": "SE_lADOABII586bT0I_zwAAAAPgfhgU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/16651261972",
      "actor": {
        "login": "jsarenik",
        "id": 244565,
        "node_id": "MDQ6VXNlcjI0NDU2NQ==",
        "avatar_url": "https://avatars.githubusercontent.com/u/244565?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/jsarenik",
        "html_url": "https://github.com/jsarenik",
        "followers_url": "https://api.github.com/users/jsarenik/followers",
        "following_url": "https://api.github.com/users/jsarenik/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/jsarenik/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/jsarenik/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/jsarenik/subscriptions",
        "organizations_url": "https://api.github.com/users/jsarenik/orgs",
        "repos_url": "https://api.github.com/users/jsarenik/repos",
        "events_url": "https://api.github.com/users/jsarenik/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/jsarenik/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-03-10T09:38:36Z"
    },
    {
      "event": "labeled",
      "id": 17939209498,
      "node_id": "LE_lADOABII586bT0I_zwAAAAQtQp0a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/17939209498",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-02T17:18:16Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 2957908956,
      "node_id": "IC_kwDOABII586wThvc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/2957908956",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-10T07:02:30Z",
      "updated_at": "2025-06-10T07:02:30Z",
      "author_association": "MEMBER",
      "body": "Looks like the CI started failing, due to too many threads being launched in the functional tests with that parallelism? As the threads may open files, this could be hitting the max open files limit? Or maybe it is a different limit hit?",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-2957908956",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3009101750,
      "node_id": "IC_kwDOABII586zWz-2",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3009101750",
      "actor": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-06-26T16:42:59Z",
      "updated_at": "2025-06-26T16:42:59Z",
      "author_association": "NONE",
      "body": "Hi folks, this looks great, since if all the `prevout coins` of all transactions of a block are loaded in advance, then the optimization in #32791 makes sense.",
      "user": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3009101750",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3302056248,
      "node_id": "IC_kwDOABII587E0WE4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3302056248",
      "actor": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T09:09:12Z",
      "updated_at": "2025-09-17T09:09:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "What's the status here?",
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3302056248",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19756832559,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZmVcv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19756832559",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7317d2056714047ff0a09c6f3bb62dccd6b56802",
      "created_at": "2025-09-17T18:18:36Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19756953150,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZmy4-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19756953150",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "743d2da0f8871afc194c63a394e1ded4c8e17990",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/743d2da0f8871afc194c63a394e1ded4c8e17990",
      "created_at": "2025-09-17T18:25:40Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 19757566915,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASZpIvD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19757566915",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/688c03597afb0b76077f1ffc4608eef19481056e",
      "created_at": "2025-09-17T18:56:46Z"
    },
    {
      "event": "commented",
      "id": 3304494917,
      "node_id": "IC_kwDOABII587E9pdF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3304494917",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-17T20:38:24Z",
      "updated_at": "2025-09-17T20:38:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "> Looks like the CI started failing, due to too many threads being launched in the functional tests with that parallelism? As the threads may open files, this could be hitting the max open files limit? Or maybe it is a different limit hit?\r\n\r\nThanks, I added `-par=1` to all nodes spawned in `features_proxy.py` in 6980852416040bdddf111df3cea3ec50639f010a. That test spawns lots of nodes and block validation is not relevant to it.\r\n\r\n> What's the status here?\r\n\r\nRebased to fix silent conflicts and added the fix for `features_proxy.py`.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3304494917",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3316319902,
      "node_id": "IC_kwDOABII587Fqwae",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3316319902",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-21T22:57:47Z",
      "updated_at": "2025-10-02T02:52:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "I benchmarked the latest branch with default dbcache up to 912683. Results are a speedup of 14% - 5:07 vs 5:49.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 688c03597afb0b76077f1ffc4608eef19481056e && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683` | 18430.672 Â± 19.856 | 18416.631 | 18444.712 | 1.00 |\r\n| `echo 1444ed855f438f1270104fca259ce61b99ed5cdb && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683` | 20937.219 Â± 62.635 | 20892.929 | 20981.508 | 1.14 Â± 0.00 |\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3316319902",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 19825003493,
      "node_id": "RTE_lADOABII586bT0I_zwAAAASdqYvl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19825003493",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-21T22:58:28Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads 10% faster IBD",
        "to": "validation: fetch block inputs on parallel threads >10% faster IBD"
      }
    },
    {
      "event": "unlabeled",
      "id": 19831185263,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAASeB99v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/19831185263",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-22T08:13:18Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3324906640,
      "node_id": "IC_kwDOABII587GLgyQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3324906640",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-09-23T17:18:05Z",
      "updated_at": "2025-09-23T17:25:21Z",
      "author_association": "CONTRIBUTOR",
      "body": "Did the same benchmark with 5000 dbcache and there is a 6% speedup :rocket: - 4:27 vs 4:44. Even with far fewer cache misses this change is still a benefit, and will continue to improve block connection speed as the blockchain and utxo set get bigger.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 688c03597afb0b76077f1ffc4608eef19481056e && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683 -dbcache=5000` | 16021.047 Â± 5.892 | 16016.881 | 16025.213 | 1.00 |\r\n| `echo 1444ed855f438f1270104fca259ce61b99ed5cdb && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=912683 -dbcache=5000` | 17057.947 Â± 42.032 | 17028.226 | 17087.668 | 1.06 Â± 0.00 |",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3324906640",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3264568566,
      "node_id": "PRR_kwDOABII587ClVz2",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-24T20:16:40Z",
      "author_association": "MEMBER",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3264568566",
      "submitted_at": "2025-09-24T20:16:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 2831320761,
      "node_id": "PRR_kwDOABII586owoa5",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-12T12:29:33Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have re-reviewed the changes again lightly and did quite a few benchmarks on different platforms.\r\nThere were a lot of surprises, see my measurements:\r\n\r\n<details>\r\n<summary>rpi5-16 IBD from local node or & reindex-chainstate seem is ~27% faster</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=915961; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        29732.695 s               [User: 60441.083 s, System: 5856.247 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        37896.082 s               [User: 60968.810 s, System: 7062.414 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.27          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n---\r\n\r\nRetested it separately with:\r\n```\r\n# cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -connect=rpi5-16-3.local\r\n\r\ncat ../BitcoinData/debug.log | egrep 'height=0|height=916000'\r\n2025-09-25T17:03:06Z UpdateTip: new best=000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f height=0 version=0x00000001 log2_work=32.000022 tx=1 date='2009-01-03T18:15:05Z' progress=0.000000 cache=0.3MiB(0txo)\r\n2025-09-26T01:02:56Z UpdateTip: new best=000000000000000000003ca9748080f4c3d1230ba9fa4bed66be6ded05f9b6e6 height=916000 version=0x2000e000 log2_work=95.840381 tx=1246369867 date='2025-09-23T07:22:08Z' progress=0.998966 cache=367.7MiB(2821413txo)\r\n7h 59m 50s\r\n```\r\n\r\n</details>\r\n\r\nDoing the same on an Intel i9 with SSD shows similar results\r\n\r\n<details>\r\n<summary>i9 with SSD, IBD from real peers/reindex-chainstate seem is 24%/25% faster for default memory, done in 6h/3.5h</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=915961; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        12698.166 s               [User: 33794.242 s, System: 3015.471 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        15928.708 s               [User: 28382.232 s, System: 2308.299 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.25          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\nand\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 3 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (mean Â± Ïƒ):     21484.108 s Â± 1187.956 s    [User: 42976.944 s, System: 4356.289 s]\r\n  Range (min â€¦ max):   20112.390 s â€¦ 22175.559 s    3 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (mean Â± Ïƒ):     26589.393 s Â± 1171.370 s    [User: 36011.245 s, System: 3193.496 s]\r\n  Range (min â€¦ max):   25607.731 s â€¦ 27886.055 s    3 runs\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.24 Â±  0.09  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n</details>\r\n\r\nIncreasing the memory decreases the difference:\r\n\r\n<details>\r\n<summary>i9 reindex-chainstate seem is ~9% faster for default memory, done in 3.3h</summary>\r\n\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; STOP=915961; DBCACHE=4500; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        11801.704 s               [User: 20216.598 s, System: 1181.879 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        12916.432 s               [User: 17150.579 s, System: 747.711 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.09          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=915961 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n</details>\r\n\r\nNote that the difference between small and big dbcache is also shrunk from 23% to 7.5%!\r\n\r\nChecked the same on an i7 with hdd, it seems the speedup is best on non-rotating disks, maybe we could consider reducing the parallelism in those cases:\r\n\r\n<details>\r\n<summary>i7 with HDD, IBD/reindex-chainstate seem is ~16% faster for default memory</summary>\r\n\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        35766.853 s               [User: 39688.514 s, System: 2853.808 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        41355.517 s               [User: 35667.321 s, System: 2872.506 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blockso$ly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.16          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\nand\r\n```\r\nCOMMITS=\"688c03597afb0b76077f1ffc4608eef19481056e af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\"; \\\r\nSTOP=916000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n688c03597a validation: fetch block inputs in parallel\r\naf8a366bd6 coins: allow emplacing non-dirty coins internally\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        35766.853 s               [User: 39688.514 s, System: 2853.808 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        41355.517 s               [User: 35667.321 s, System: 2872.506 s]\r\n\r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blockso$ly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n        1.16          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n```\r\n\r\n</details>\r\n\r\nChecking the same on my M4 max laptop was the most surprising:\r\n<details>\r\n<summary>M4 max with SSD, IBD/reindex-chainstate seem is 290% faster for default memory</summary>\r\n\r\n```\r\nSTOP=916000; DBCACHE=450; \\\r\nDATA_DIR=\"/Users/lorinc/Library/Application\\ Support/Bitcoin\"; \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --parameter-list COMMIT 688c03597afb0b76077f1ffc4608eef19481056e \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nBenchmark 1: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        20658.825 s               [User: 19679.918 s, System: 4763.490 s]\r\nBenchmark 1b: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n  Time (abs â‰¡):        20186.312 s               [User: 19481.126 s, System: 4716.728 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7131.178 s               [User: 17244.133 s, System: 12850.427 s]\r\nBenchmark 2b: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7180.762 s               [User: 17430.360 s, System: 12949.731 s\r\n\r\nRelative speed comparison\r\n        2.90          ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = af8a366bd6a08d9362e69a89b0b89b5c94eb63ca)\r\n        1.00          ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n```\r\n\r\nIt was hard to believe this was true, so I re-ran it a few times, and it was consistent.\r\n\r\n</details>\r\n\r\nI have tried -par=32 on my laptop as well - exactly the same speed:\r\n<details>\r\n<summary>-par=32</summary>\r\n\r\n```\r\nSTOP=916000; DBCACHE=450; \\\r\nDATA_DIR=\"/Users/lorinc/Library/Application\\ Support/Bitcoin\"; \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --parameter-list COMMIT 688c03597afb0b76077f1ffc4608eef19481056e \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=32\"\r\n\r\nBenchmark 1: ./build/bin/bitcoind -datadir=/Users/lorinc/Library/Application\\ Support/Bitcoin -stopatheight=916000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=32 (COMMIT = 688c03597afb0b76077f1ffc4608eef19481056e)\r\n  Time (abs â‰¡):        7109.626 s               [User: 17210.848 s, System: 12938.964 s]\r\n```\r\nnote, the commit had:\r\n```\r\n      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, 10 * MAX_SCRIPTCHECK_THREADS)},\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-2831320761",
      "submitted_at": "2025-09-29T16:16:54Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3280693697,
      "node_id": "PRR_kwDOABII587Di2nB",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-29T16:17:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "<duplicate>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3280693697",
      "submitted_at": "2025-09-29T16:17:05Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3280976253,
      "node_id": "PRR_kwDOABII587Dj7l9",
      "url": null,
      "actor": null,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-09-29T17:45:27Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3280976253",
      "submitted_at": "2025-09-29T17:45:27Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 3356601737,
      "node_id": "IC_kwDOABII587IEa2J",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3356601737",
      "actor": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-01T14:23:57Z",
      "updated_at": "2025-10-01T14:23:57Z",
      "author_association": "CONTRIBUTOR",
      "body": "Concept ACK",
      "user": {
        "login": "Raimo33",
        "id": 104778891,
        "node_id": "U_kgDOBj7Miw",
        "avatar_url": "https://avatars.githubusercontent.com/u/104778891?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/Raimo33",
        "html_url": "https://github.com/Raimo33",
        "followers_url": "https://api.github.com/users/Raimo33/followers",
        "following_url": "https://api.github.com/users/Raimo33/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/Raimo33/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/Raimo33/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/Raimo33/subscriptions",
        "organizations_url": "https://api.github.com/users/Raimo33/orgs",
        "repos_url": "https://api.github.com/users/Raimo33/repos",
        "events_url": "https://api.github.com/users/Raimo33/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/Raimo33/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3356601737",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058361971,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrklBz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058361971",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/4331168bd08d63a73a6e45c84a7513d01541f19a",
      "created_at": "2025-10-02T12:16:35Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058563528,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrlWPI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058563528",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "928847cdfd1d7fc5158362e5bade86f48bbd7c9a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/928847cdfd1d7fc5158362e5bade86f48bbd7c9a",
      "created_at": "2025-10-02T12:26:08Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20058731082,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrl_JK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20058731082",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fe77ce977b40c8f24f641d33a15cc6eb73b1c3bb",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fe77ce977b40c8f24f641d33a15cc6eb73b1c3bb",
      "created_at": "2025-10-02T12:33:48Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20059744050,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrp2cy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20059744050",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9cdbb25a79a090a631d5684818767895021d1220",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9cdbb25a79a090a631d5684818767895021d1220",
      "created_at": "2025-10-02T13:20:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20060123208,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASrrTBI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20060123208",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "created_at": "2025-10-02T13:37:28Z"
    },
    {
      "event": "commented",
      "id": 3361944949,
      "node_id": "IC_kwDOABII587IYzV1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3361944949",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-02T15:47:28Z",
      "updated_at": "2025-10-02T15:47:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "Updated the input fetcher significantly:\n- uses counting_semaphores to synchronize threads instead of mutex + condvar.\n- stores tx + vin indexes in global vector instead of copying the COutPoints. The COutPoints are read from a global CBlock pointer.\n- The fetch queue counter is an atomic int instead of a mutex guarded int.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3361944949",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20084838906,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStJlH6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20084838906",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "86a9f72f89690fdd052532b3f908ea6a6e95aa2e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/86a9f72f89690fdd052532b3f908ea6a6e95aa2e",
      "created_at": "2025-10-03T15:58:49Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20084930245,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStJ7bF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20084930245",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "28b249c899ded88ee0765eac20b330e63b42cdfa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/28b249c899ded88ee0765eac20b330e63b42cdfa",
      "created_at": "2025-10-03T16:04:14Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20085086442,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStKhjq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20085086442",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c6e8499550632f87d6517472038f545e72c173b5",
      "created_at": "2025-10-03T16:14:00Z"
    },
    {
      "event": "commented",
      "id": 3366595565,
      "node_id": "IC_kwDOABII587Iqivt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3366595565",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-03T17:33:05Z",
      "updated_at": "2025-10-03T17:33:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "Removed `m_batch_size`. Each thread now increments the atomic counter by 1.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3366595565",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20092301267,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAStmC_T",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20092301267",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a8f9a806751b5755bdec5b096186f70c0bfddcfa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a8f9a806751b5755bdec5b096186f70c0bfddcfa",
      "created_at": "2025-10-03T23:44:01Z"
    },
    {
      "event": "commented",
      "id": 3367707177,
      "node_id": "IC_kwDOABII587IuyIp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3367707177",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-04T00:53:28Z",
      "updated_at": "2025-10-04T00:53:28Z",
      "author_association": "CONTRIBUTOR",
      "body": "The latest version seems very promising, I like that the algorithms is getting simpler.\r\nI noticed that for small dbcache it has a very noticeable effect, but for very high dbcache this seems to add an extra cost - since we already have everything in the cache, so it just does useless work.\r\nI wonder if we could enable this fetching only after the very first time we [Flush](https://github.com/bitcoin/bitcoin/blob/17372d788e6ca6f5a8452acf88d6b7db4221cb7e/src/coins.cpp#L251) and erase, since it cannot help in any way before that.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3367707177",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20097324062,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAASt5NQe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20097324062",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/cf209da104d483aa064aa3bec621f1adc9574749",
      "created_at": "2025-10-04T15:53:30Z"
    },
    {
      "event": "commented",
      "id": 3378291849,
      "node_id": "IC_kwDOABII587JXKSJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3378291849",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-07T18:52:32Z",
      "updated_at": "2025-10-07T18:52:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Compared it against master on a Raspberry Pi 5 synchronizing from real peers for realism, ran it twice for good measure until 917000 blocks with dbcache 450:\r\n\r\nThis isn't the [latest version](https://github.com/bitcoin/bitcoin/compare/a8f9a806751b5755bdec5b096186f70c0bfddcfa..cf209da104d483aa064aa3bec621f1adc9574749) of the PR, but should likely be representative anyway.\r\n\r\n<details>\r\n<summary>First run: 19% faster, finished IBD in 13h:11m | IBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"a8f9a806751b5755bdec5b096186f70c0bfddcfa f0dc19f16826f68ef482acfb7b24e8bb7168fc51\"; \\\r\nSTOP=917000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\na8f9a80675 validation: fetch block inputs in parallel\r\nf0dc19f168 coins: allow emplacing non-dirty coins internally\r\n\r\nIBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n  Time (abs â‰¡):        47485.682 s               [User: 79615.847 s, System: 9374.261 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n  Time (abs â‰¡):        56374.354 s               [User: 78807.079 s, System: 10196.290 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n        1.19          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Second run: 21% faster, finished IBD in 12h:45m | IBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"a8f9a806751b5755bdec5b096186f70c0bfddcfa f0dc19f16826f68ef482acfb7b24e8bb7168fc51\"; \\\r\nSTOP=917000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --cleanup \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\na8f9a80675 validation: fetch block inputs in parallel\r\nf0dc19f168 coins: allow emplacing non-dirty coins internally\r\n\r\nIBD | 917000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n  Time (abs â‰¡):        45907.874 s               [User: 81006.258 s, System: 10039.919 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n  Time (abs â‰¡):        55612.464 s               [User: 81830.349 s, System: 11913.754 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = a8f9a806751b5755bdec5b096186f70c0bfddcfa)\r\n        1.21          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=917000 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = f0dc19f16826f68ef482acfb7b24e8bb7168fc51)\r\n```\r\n\r\n</details>\r\n\r\nThe variance between the runs shows 1% for master and 3% difference for the PR indicating that we're likely nearing the network bandwidth limitations.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3378291849",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20226498884,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS1l-FE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20226498884",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "3335d8d45571247184c33136ba30a83c20be4701",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/3335d8d45571247184c33136ba30a83c20be4701",
      "created_at": "2025-10-11T18:03:37Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20226508890,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS1mAha",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20226508890",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "created_at": "2025-10-11T18:05:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20270952405,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS4Pi_V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20270952405",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "created_at": "2025-10-14T14:02:56Z"
    },
    {
      "event": "commented",
      "id": 3403508763,
      "node_id": "IC_kwDOABII587K3Wwb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3403508763",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:47Z",
      "updated_at": "2025-10-14T20:28:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "> I noticed that for small dbcache it has a very noticeable effect, but for very high dbcache this seems to add an extra cost - since we already have everything in the cache, so it just does useless work.\r\nI wonder if we could enable this fetching only after the very first time we [Flush](https://github.com/bitcoin/bitcoin/blob/17372d788e6ca6f5a8452acf88d6b7db4221cb7e/src/coins.cpp#L251) and erase, since it cannot help in any way before that.\r\n\r\n@l0rinc There is already quite a lot to review here, and your benchmarks (and mine) show very promising results. So, I would prefer to keep this idea as a follow-up. We can do isolated benchmarks with your suggested change afterwards and propose an improvement accordingly.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3403508763",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20278946868,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAS4uCw0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20278946868",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:48Z"
    },
    {
      "event": "subscribed",
      "id": 20278946906,
      "node_id": "SE_lADOABII586bT0I_zwAAAAS4uCxa",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20278946906",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T20:28:48Z"
    },
    {
      "event": "commented",
      "id": 3403611574,
      "node_id": "IC_kwDOABII587K3v22",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3403611574",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-14T21:04:25Z",
      "updated_at": "2025-10-14T21:05:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'm fine with doing that in a follow-up if you think it's too complicated (though it's likely quite simple, we can just track the very first cache miss and always prefetch after that - that heuristic would even survive node restarts. Maybe we need to skip the Bip30 values though, but it's just a heuristic anyway).\r\nBut I don't yet see this PR as close to being final yet - do you? I still want to review it thoroughly, I don't think we should ossify yet :)",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3403611574",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 20300777456,
      "node_id": "LE_lADOABII586bT0I_zwAAAAS6BUfw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20300777456",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-15T16:40:06Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20307527136,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS6bEXg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307527136",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ace7f2446f4fc8c7d0acc0021e2b3db4720cd790",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ace7f2446f4fc8c7d0acc0021e2b3db4720cd790",
      "created_at": "2025-10-16T00:31:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20307609389,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS6bYct",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307609389",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/64de91105312d36dadb5f71ec01fc6af9b14da69",
      "created_at": "2025-10-16T00:41:47Z"
    },
    {
      "event": "unlabeled",
      "id": 20307845082,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAS6cR_a",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20307845082",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-16T01:12:58Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3408901200,
      "node_id": "IC_kwDOABII587LL7RQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3408901200",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-16T02:07:26Z",
      "updated_at": "2025-10-16T02:07:26Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased due to conflicts.\r\nRemoved the first commit. We don't need to modify `EmplaceCoinInternalDANGER`, we can just insert the coins as dirty into the cache. They will be set dirty when they are spent anyways. If a block fails validation inside `ConnectBlock`, then the dirty coins will just rewrite the same value to the db on the next flush or sync.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3408901200",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20367044158,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS9-G4-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367044158",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7991379d7f5f42003f8168a56d09297ab4625280",
      "created_at": "2025-10-19T14:41:30Z"
    },
    {
      "event": "commented",
      "id": 3419748327,
      "node_id": "IC_kwDOABII587L1Tfn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3419748327",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:45Z",
      "updated_at": "2025-10-19T15:26:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "Updated to use `std::barrier` for the completion synchronization instead of acquiring a semaphore for each thread, as suggested by @l0rinc .",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3419748327",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20367214353,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAS9-wcR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367214353",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:46Z"
    },
    {
      "event": "subscribed",
      "id": 20367214366,
      "node_id": "SE_lADOABII586bT0I_zwAAAAS9-wce",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20367214366",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-19T15:26:46Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368713439,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-Eebf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368713439",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "90b3286dd8ee4661fe1cedded466cca934fe95bc",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/90b3286dd8ee4661fe1cedded466cca934fe95bc",
      "created_at": "2025-10-19T22:18:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368756565,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-Eo9V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368756565",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "f509cf9a31445af176429b24ccd65aad598d1e71",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/f509cf9a31445af176429b24ccd65aad598d1e71",
      "created_at": "2025-10-19T22:30:54Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368819693,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-E4Xt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368819693",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d63496004d54ae215808a396d800280dba5e4017",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d63496004d54ae215808a396d800280dba5e4017",
      "created_at": "2025-10-19T22:48:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20368952454,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-FYyG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20368952454",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fc0cb7579abf6a0949e513b2412c2e66a6a0446c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fc0cb7579abf6a0949e513b2412c2e66a6a0446c",
      "created_at": "2025-10-19T23:21:21Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20369070922,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAS-F1tK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20369070922",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "created_at": "2025-10-19T23:54:29Z"
    },
    {
      "event": "commented",
      "id": 3427287178,
      "node_id": "IC_kwDOABII587MSECK",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3427287178",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T15:32:32Z",
      "updated_at": "2025-10-21T15:32:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "I love the new structure, it's a lot easier to track the progress compared to previous versions. It's also measurably faster than previous versions, we seem to be nearing ~20% - sweeeet! It also pairs well with other `Siphash` related changes that are in the pipeline.\r\n\r\nI have reimplemented most of it locally to make sure I can do a meaningful review, see https://github.com/l0rinc/bitcoin/pull/47 for my attempt. It's not finished, I'm still experimenting with different alternatives to make sure we can make this as simple and useful as possible (e.g. using barriers, filtering and sorting before fetch, adding dedicated `ThreadPool`, splitting reading and writing caches etc.), but wanted to publish my observations so far.\r\n\r\nMy remaining biggest concern is that the threadpool should definitely be untangled from the `InputFetcher` logic (I hate concurrent mutability), it's an independent concern mixed with non-trivial fetcher logic. We also shouldn't parallelize based on CPU in the first place, I don't see why we'd do that. And the `ThreadPool` part still needs independent tests.\r\n\r\nI have tried fetching everything on a single thread and the same with sorted UTXOs and it does seem to be ~6% faster on an SSD (I'd expected even bigger difference on HDD, still measuring that) - but I don't have a final solution that's faster than everything else (since I could only solve it by single-threaded filtering which is slow).\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\nb6ccd542fd single-threaded NO sort\r\nc50a6bd981 single-threaded + sorted fetch\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 100 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b6ccd542fdc371d3ecd90164169e3d5d7c60e82d)\r\n  Time (abs â‰¡):        11322.014 s               [User: 20431.572 s, System: 1375.995 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = c50a6bd9815ebb2e0d86d5e6b679da5ac021b796)\r\n  Time (abs â‰¡):        10646.049 s               [User: 19231.516 s, System: 1268.395 s]\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3427287178",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3427748120,
      "node_id": "IC_kwDOABII587MT0kY",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3427748120",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:19Z",
      "updated_at": "2025-10-21T16:58:11Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you for your review @l0rinc!\r\n\r\n> I love the new structure, it's a lot easier to track the progress compared to previous versions. It's also measurably faster than previous versions, we seem to be nearing ~20% - sweeeet!\r\n\r\n:rocket:\r\n\r\n> we can make this as simple and useful as possible\r\n\r\nWhat else do you have in mind for this being useful? It has a very focused purpose in my view. I would love to make it as simple as possible.\r\n\r\n> using barriers\r\n\r\nDone :)\r\n\r\n> filtering and sorting before fetch\r\n\r\nCan you expand on why we would want this? Prefiltering on the main thread was always slower than filtering in parallel when I was testing this idea.\r\n\r\n> adding dedicated ThreadPool\r\n\r\nYes, see https://github.com/bitcoin/bitcoin/pull/26966. Hopefully we can pull that out and it can be used here. See https://github.com/andrewtoth/bitcoin/tree/test-thread-pool.\r\n\r\n> splitting reading and writing caches\r\n\r\nI'm not sure what you mean by this? There is only one cache, and we read from it concurrently, then write to it on a single thread. Can you expand on how we can split the cache into two? Also, why would we want separate caches?\r\n\r\n> My remaining biggest concern is that the threadpool should definitely be untangled from the InputFetcher logic\r\n\r\nIs this not accomplished by `ThreadLoop`, `Work` and `OnCompletion` functions? The `Work` function has no thread pool logic at all, it is completely independent and can be run by one thread or many. Do you have any concrete suggestions, or specific codepaths that are tangled that are concerning?\r\n\r\n> I hate concurrent mutability\r\n\r\nI'm not sure I understand this. There is no concurrent mutability in my implementation. That would be undefined behavior. Can you point out the data members that are being concurrently mutated and how? Perhaps we have different definitions of concurrent mutability.\r\n\r\n> We also shouldn't parallelize based on CPU in the first place, I don't see why we'd do that.\r\n\r\nThis is following the logic of the check queue. Ideally we could reuse both threads in the same threadpool in the future. Do you have any concrete recommendations on how we many threads we should run? Using the number of threads per CPU is yielding a 20% speed boost, so it seems like a sane enough choice.\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3427748120",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20410121940,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATAib7U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20410121940",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:20Z"
    },
    {
      "event": "subscribed",
      "id": 20410121981,
      "node_id": "SE_lADOABII586bT0I_zwAAAATAib79",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20410121981",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-21T16:55:20Z"
    },
    {
      "event": "commented",
      "id": 3444285774,
      "node_id": "IC_kwDOABII587NS6FO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3444285774",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-24T18:02:04Z",
      "updated_at": "2025-10-24T19:15:24Z",
      "author_association": "CONTRIBUTOR",
      "body": "Let me summarize our offline discussions:\r\n\r\n### Cache hierarchy\r\n\r\nDuring block connection we're adding an extra temporary in-memory dbcache layer on top so that whatever happens during block connection doesn't end up polluting the big dbcache or leveldb.\r\nI think we should take advantage of this and use the temporary top layer to collect the missing inputs there:\r\n* if block validation fails we can just throw it out\r\n* it's easier to test and benchmark, we can rerun the same operation without changing the underlying state\r\n* the missing values will all be fetched from the top layer now, avoiding two-hop lookups\r\n* since the threads aren't reading from the temp cache and aren't writing to the big cache, we can copy the needed inputs from the big in-memory cache contents on the main thread as well to the temporary top layer (without locking) while the other threads are fetching from the DB (since those are IO bound, this being CPU bound). That would create a dedicated dbcache per blocks which we could eventually flush independently.\r\n\r\nThis might need some workarounds, but it does enable new cache invalidation opportunities.\r\n\r\n### Sorted fetch\r\n\r\nSince LevelDB writes (via the `CDBBatch` and `MemTable`) are already sorted and result in a significant speedup compared to inserting the values one-by-one (though likely this isn't just the effect of sorting), I thought it would make sense to experiment with sorted fetches as well.\r\nI have added an extra fetch (similarly to this PR, see https://github.com/l0rinc/bitcoin/commit/b72f67d4a88495a0222cbb9ae825daa6ea38e4df) before calling `ConnectBlock` so that the cache is pre-warmed, but on a single thread. This is the baseline, in the next commit after gathering the missing values I'm sorting them and doing the fetch from the db one-by-one, but in a sorted order.\r\n\r\nThe results indicate that sorted fetching is a lot faster, especially on lower-end devices (i7 with HDD and Rpi5 with SSD).\r\n\r\n<details>\r\n<summary>6% faster reindex-chainstate | 919191 blocks | dbcache 450 | rpi5-16-2</summary>\r\n\r\n```\r\nCOMMITS=\"7d27af98c7cf858b5ab5a02e64f89a857cc53172 ccc748b05858a9ebeb375cc1f3e7426698394470 ead8da2b33117807e27a66f814cf11cdf676d194\"; \\\r\nSTOP=919191; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz\r\nccc748b058 coins: prefetch inputs on single thread\r\nead8da2b33 coins: sorted input prefetch\r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)\r\n  Time (abs â‰¡):        42271.083 s               [User: 66842.872 s, System: 8003.776 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)\r\n  Time (abs â‰¡):        40776.988 s               [User: 67394.771 s, System: 7130.144 s]\r\n \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)\r\n  Time (abs â‰¡):        38435.516 s               [User: 64537.357 s, System: 6716.634 s]\r\n \r\nRelative speed comparison\r\n        1.10          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)\r\n        1.06          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)\r\n```\r\n\r\n</details>\r\n\r\n(interestingly it seems this is even faster than master by a lot, we're not yet sure what's causing that since the fetches are still single-threaded)\r\n\r\nSimilar speedup on HDD:\r\n\r\n<details>\r\n<summary>5% faster reindex-chainstate | 919191 blocks | dbcache 450 | i7-hdd</summary>\r\n\r\n```\r\nSTOP=919191; DBCACHE=450; \\                                                                                                                   \r\nCC=gcc; CXX=g++; \\                                                                                                                                                                  \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                                           \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                                                      \r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cor\r\nes | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || e\r\ncho HDD)\"; echo \"\") &&\\                                                                                                                                                             \r\nhyperfine \\                                  \r\n  --sort command \\                           \r\n  --runs 1 \\                                 \r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\                                                                      \r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                               \r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\                                                  \r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\                                                                  \r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\                                                                        \r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\                                                                                                   \r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\                                                                                \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"                         \r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz                             \r\nccc748b058 coins: prefetch inputs on single thread                                        \r\nead8da2b33 coins: sorted input prefetch                                                   \r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD                                      \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                                        \r\n  Time (abs â‰¡):        42897.195 s               [User: 38613.661 s, System: 3154.561 s]                                                                                            \r\n                                             \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                                               \r\n  Time (abs â‰¡):        42015.404 s               [User: 40096.242 s, System: 3180.038 s]                                                                                            \r\n                                             \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)                                               \r\n  Time (abs â‰¡):        40176.361 s               [User: 38614.897 s, System: 3047.461 s]                                                                                            \r\n                                             \r\nRelative speed comparison                    \r\n        1.07          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                               \r\n        1.05          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                               \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)   \r\n```\r\n\r\n</details>\r\n\r\nOn a very powerful i9 with very performant SSD sorting isn't faster than master, but it's still a lot faster than random fetching:\r\n\r\n<details>\r\n<summary>4% faster reindex-chainstate | 919191 blocks | dbcache 450 | i9-ssd</summary>\r\n\r\n```\r\nSTOP=919191; DBCACHE=450; \\                                                                                                      \r\nCC=gcc; CXX=g++; \\                                                                                                                                                     \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                              \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                                         \r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\                                  \r\nhyperfine \\                              \r\n  --sort command \\                       \r\n  --runs 1 \\                             \r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\                                                         \r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                        \r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\                                     \r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\                                                     \r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\                                                           \r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\                                                                                      \r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\                                                                   \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"            \r\n\r\n7d27af98c7 Merge bitcoin/bitcoin#33461: ci: add Valgrind fuzz                      \r\nccc748b058 coins: prefetch inputs on single thread                                 \r\nead8da2b33 coins: sorted input prefetch                                            \r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD                        \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)                    \r\n  Time (abs â‰¡):        20383.488 s               [User: 38259.799 s, System: 2702.188 s]                                                                               \r\n                                         \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)                    \r\n  Time (abs â‰¡):        21213.645 s               [User: 39728.945 s, System: 2709.999 s]                                                                               \r\n                                         \r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)                    \r\n  Time (abs â‰¡):        20476.751 s               [User: 38448.254 s, System: 2597.600 s]                                                                               \r\n                                         \r\nRelative speed comparison                \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7d27af98c7cf858b5ab5a02e64f89a857cc53172)           \r\n        1.04          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ccc748b05858a9ebeb375cc1f3e7426698394470)           \r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ead8da2b33117807e27a66f814cf11cdf676d194)  \r\n```\r\n\r\n</details>\r\n\r\nTheoretically this can also be affected by LevelDB's internal `options.block_cache` and `options.block_size` and `iteroptions.fill_cache` (currently experimenting with different values to see if it makes any difference).\r\nThis is why I have [suggested](https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812534028) trying a read-only snapshot per thread, if they're reading sorted values the previous path could theoretically be caches which can help avoid a few lookups.\r\n\r\n### Separate ThreadPool\r\n\r\nI think we should be able to use a single barrier for starting and stopping, assuming that we either want to use all of them or none of them, something like: https://github.com/l0rinc/bitcoin/commit/67e79e041b524eb1b0039ff39d4fc5b235d89b8f#diff-7ad6c5646dfd3749d2634861dfaf98e8c6fbc041a8e8eded973ff39929acffd7 or https://github.com/bitcoin/bitcoin/pull/33689\r\nThis would also help with completely separating the multithreaded part from the `Inputfetcher` which would also allow testing that critical behavior separately.\r\nThis would also help with minimizing the mutable state which could theoretically allow concurrent calls to swap out the work from under the started threads (so likely the `m_task` in my example should be atomic, haven't given it enough thought).\r\n\r\nSince sorted-fetching currently needs a preprocessing step, we could use these available threads for filtering operations as well (since single-threaded filtering is slow, as proven above) - we could filter on all threads for missing, sort the missing on main thread and spread out to all threads for db fetching - leaving the main thread to do other things (since db fetching isn't really CPU bound, no need to involve the main thread), such as the mentioned outer-layer warming from the main in-memory dbcache.\r\nAnd alternative to the \"fetch-missing & sort & get\" on a single thread is to try \"fetch-all & sort & filter & get\" instead which is more parallelizable.\r\nSince everything in the outer-layer will be spent anyway, in the future maybe we could even flush them on a background thread to db (given that we've just copied the items to the temp cache, after successful flush we could just remove them from the main cache) - which would likely simplify the main dbcache's dirty and spent behaviors, but that's outside of the scope of this PR but could provide extra motivation for these changes).",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3444285774",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20513157923,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATGrfMj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513157923",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "13e2d22dfc4fdc63a2e7903b481f82c33b7145df",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/13e2d22dfc4fdc63a2e7903b481f82c33b7145df",
      "created_at": "2025-10-27T00:50:06Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20513600649,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATGtLSJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513600649",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8aedbc78c2e341ef2b9f0e140245388718c74e33",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8aedbc78c2e341ef2b9f0e140245388718c74e33",
      "created_at": "2025-10-27T01:44:01Z"
    },
    {
      "event": "commented",
      "id": 3449216359,
      "node_id": "IC_kwDOABII587Nlt1n",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3449216359",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:21Z",
      "updated_at": "2025-10-27T02:01:12Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you @l0rinc for your detailed review and suggestions! I have taken some of them. The input fetcher has now been redesigned.\r\n- Coins are written to the ephemeral cache that is created just to be used in `ConnectBlock`, instead of the main cache. This requires a new method in `CCoinsViewCache` - `GetPossiblySpentCoinFromCache`. Since we write to an empty cache instead of `CoinsTip()`, we could insert a `Coin` that exists in the db but is spent in `CoinsTip()`. Previously that insertion would fail since we were inserting again into `CoinsTip()` which would not overwrite the spent coin.\r\n- Because of this we can safely write to the ephemeral cache on the main thread, since the worker threads will be reading from a different cache. So the main thread does not do any fetching, but it writes fetched `Coin`s to the cache in parallel as workers fetch them. It is a lock-free MPSC queue. The workers and main thread synchronize on an atomic `Status` member of each input. The workers set it to `READY` while the main thread spins on it until it is no longer `WAITING`. This is a substantial speed improvement over the previous version, and it also lets us insert `Coin`s from the main cache into the ephemeral cache faster. So this change speeds up block connection even when there are no cache misses, and makes the workers utilize more CPU rather than just IO.\r\n- A single barrier is used to synchronize the threads. Both the main and worker threads call `arrive_and_wait` before they begin their work and after completion.\r\n\r\nI removed the last commit, and instead add the `InputFetcher` as multi threaded initially. It didn't make sense to split it since the worker threads and main threads do different things now.\r\n\r\nI haven't been able to effectively utilize a sorting strategy. Sorting the inputs before fetching doesn't seem to have a benefit in the multi threaded approach. The overhead of copying the `COutPoint`s and sorting them was always slower. I think the parallel fetching dominates any speedup achieved by sorted fetching anyways.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3449216359",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20513726785,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATGtqFB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513726785",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:23Z"
    },
    {
      "event": "subscribed",
      "id": 20513726804,
      "node_id": "SE_lADOABII586bT0I_zwAAAATGtqFU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20513726804",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-27T01:58:23Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20529972733,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATHroX9",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20529972733",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5781a445f1d19c9479561bb536ec0f884c4bb950",
      "created_at": "2025-10-27T16:10:15Z"
    },
    {
      "event": "reviewed",
      "id": 3347436866,
      "node_id": "PRR_kwDOABII587HhdVC",
      "url": null,
      "actor": null,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-10-27T21:58:50Z",
      "author_association": "CONTRIBUTOR",
      "body": "Looks like I forgot to push the comments last time - that explains your surprise. I pushed all of them, many are out of date, please just resolve them. Sorry for the confusion.\r\n\r\nSince I'm reposting these old comments (since commented from the main GitHub view), lemme' post a recently finished Rpi4 benchmark showing a 31% speedup for an older push \\\\:D/\r\n\r\n<details>\r\n<summary>31% faster reindex-chainstate | 919191 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"063946d6bd78035276d12e070a208d84492ac5cd 64de91105312d36dadb5f71ec01fc6af9b14da69\"; \\\r\nSTOP=919191; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n063946d6bd coins: add inputfetcher\r\n64de911053 coins: fetch coins on parallel threads\r\n\r\nreindex-chainstate | 919191 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 063946d6bd78035276d12e070a208d84492ac5cd)\r\n  Time (abs â‰¡):        329713.086 s               [User: 172834.637 s, System: 87207.916 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 64de91105312d36dadb5f71ec01fc6af9b14da69)\r\n  Time (abs â‰¡):        251976.600 s               [User: 177923.005 s, System: 116804.580 s]\r\n \r\nRelative speed comparison\r\n        1.31          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 063946d6bd78035276d12e070a208d84492ac5cd)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=919191 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 64de91105312d36dadb5f71ec01fc6af9b14da69)\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3347436866",
      "submitted_at": "2025-10-27T21:48:06Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20554764190,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATJKM-e",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20554764190",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2aa510348143521a14146e41b5cf87cb3e60b29e",
      "created_at": "2025-10-28T13:58:59Z"
    },
    {
      "event": "commented",
      "id": 3463894000,
      "node_id": "IC_kwDOABII587OdtPw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3463894000",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-29T20:40:40Z",
      "updated_at": "2025-10-29T20:40:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "I'd say it's time to update the PR description:\r\n<details>\r\n<summary>24% faster reindex-chainstate | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85 2aa510348143521a14146e41b5cf87cb3e60b29e\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log; \\\r\n              grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\ncb0fdfdf37 coins: add inputfetcher\r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (abs â‰¡):        40539.887 s               [User: 69358.879 s, System: 7393.185 s]\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n  Time (abs â‰¡):        32768.672 s               [User: 69495.022 s, System: 11880.553 s]\r\n \r\nRelative speed comparison\r\n        1.24          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\nWith this change we're getting a 9 hours full `reindex-chainstate` on an rpi5 with default 450MB memory. Wow!",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3463894000",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "renamed",
      "id": 20594474601,
      "node_id": "RTE_lADOABII586bT0I_zwAAAATLhr5p",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20594474601",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-10-29T23:31:25Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads >10% faster IBD",
        "to": "validation: fetch block inputs on parallel threads >20% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20624176497,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATNS_Vx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20624176497",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1ebf2f02e64ec94a493eb68c01bd874c57b19497",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1ebf2f02e64ec94a493eb68c01bd874c57b19497",
      "created_at": "2025-10-31T03:24:15Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20633380777,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATN2Gep",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20633380777",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "created_at": "2025-10-31T12:40:23Z"
    },
    {
      "event": "commented",
      "id": 3475945645,
      "node_id": "IC_kwDOABII587PLrit",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3475945645",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-01T08:20:29Z",
      "updated_at": "2025-11-04T07:15:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased the latest version of the PR now that https://github.com/bitcoin/bitcoin/pull/31645 was merged and measured a reindex on my M4 laptop: it finished all 3 runs with dbcache 450, 4500 and 45000 overnight.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\ntime ./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 \r\n\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   8805.12s user 1456.47s system 134% cpu 2:07:22.36 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate    12201.80s user 3698.94s system 197% cpu 2:13:54.50 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     20676.11s user 10582.81s system 358% cpu 2:25:26.52 total\r\n```\r\n\r\nrepeated the same later to check for stability:\r\n```\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   8873.87s user 1468.17s system 134% cpu 2:07:47.62 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate    12178.09s user 3621.39s system 197% cpu 2:13:11.48 total\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     20725.97s user 10666.85s system 359% cpu 2:25:33.12 total\r\n```\r\n\r\n</details>\r\n\r\n<img width=\"1185\" height=\"580\" alt=\"image\" src=\"https://github.com/user-attachments/assets/a530f7d2-e7e5-4fa4-9ab0-59d0359aa763\" />\r\n\r\nNote: I did get a `bitcoind(70369,0x16f5ff000) malloc: Failed to allocate segment from range group - out of space` warning above, maybe 45 GB memory was a bit too much, but I can continue the block connection after the reindexes, so the measurements are likely representative.\r\nEdit: reran the 45 GB case, it did complete successfully in a similar time without errors.\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\nreindex-chainstate seems correct, it can continue after:\r\n```\r\n./build/bin/bitcoind\r\n2025-11-01T08:16:25Z Bitcoin Core version v30.99.0-45fe0c0e5bed (release build)\r\n...\r\n2025-11-01T08:16:29Z nBestHeight = 921129\r\n...\r\n2025-11-01T08:16:29Z UpdateTip: new best=00000000000000000000a216ce3209897114b757dbac3b651c72484829637c0e height=921130 version=0x343ba000 log2_work=95.904905 tx=1262937761 date='2025-10-28T06:06:11Z' progress=0.998475 cache=0.5MiB(3812txo)\r\n2025-11-01T08:16:29Z UpdateTip: new best=00000000000000000001965d9ff2ef639dd6829da2ad19c3f5d46691475f0df1 height=921131 version=0x25472000 log2_work=95.904918 tx=1262938885 date='2025-10-28T06:13:50Z' progress=0.998477 cache=1.6MiB(9726txo)\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3475945645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20654613374,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATPHGN-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20654613374",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/62868c8846f043477d128788eadced3e71522417",
      "created_at": "2025-11-01T21:43:52Z"
    },
    {
      "event": "commented",
      "id": 3476888214,
      "node_id": "IC_kwDOABII587PPRqW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3476888214",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-01T21:47:49Z",
      "updated_at": "2025-11-01T21:47:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "Rebased to test behavior with #31645.\r\nSome other touch-ups include:\r\n- Use `const COutPoint&` in `Input` struct instead of `vin` and `vtx` indexes\r\n- Cleanup shared vectors and pointers at the end of loop\r\n- Refactor inner work loop to do fewer existence checks at the expense of some duplicated code\r\n- Use `std::atomic_usize_t` instead of `std::atomic<usize_t>`\r\n- Use `GetPossiblySpentCoinFromCache` in tests and fuzz harness for better clarity and correctness",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3476888214",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3389779624,
      "node_id": "PRR_kwDOABII587KC-6o",
      "url": null,
      "actor": null,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-02T20:32:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "I like how we're progressing here! I think we need a few more things and have to try out a few alternatives (I haven't given up on sorting yet, especially now with bigger dbcache) and want to see how this combines with the other optimizations (threadpool, SipHash13, map hash caching, etc), but I'm definitely getting closer and closer to an ACK :D\r\n\r\nI'm testing full IBD locally on my servers, but those are always slower than `reindex-chainstes` since the nodes can't send the blocks fast enough - I don't yet have a seeding node yet, but working on it.\r\n\r\n\"It simply inserts inputs into the temporary cache, which must be fetched before a transaction is validated anyways.\" beautiful, I think some of this should be added to the commit messages as well.\r\ncommit message nit: \"coins: add InputFetcher\" (commit message content and formatting is a bit sloppy)\r\n\r\nI'd merge `fuzz: add inputfetcher fuzz harness` and `tests: add inputfetcher tests` and `coins: add inputfetcher` since the clients are needed for the review of `InputFetcher`, otherwise it's just dead code added...\r\n\r\n\r\n<details>\r\n<summary>local patch I had during review - they're not necessarily suggestions, just changes I did locally</summary>\r\n\r\n```patch\r\ndiff --git a/src/bench/CMakeLists.txt b/src/bench/CMakeLists.txt\r\nindex 9d03f075a7..dcb6281699 100644\r\n--- a/src/bench/CMakeLists.txt\r\n+++ b/src/bench/CMakeLists.txt\r\n@@ -52,6 +52,7 @@ add_executable(bench_bitcoin\r\n   streams_findbyte.cpp\r\n   strencodings.cpp\r\n   txgraph.cpp\r\n+  txid_membership.cpp\r\n   txorphanage.cpp\r\n   util_time.cpp\r\n   verify_script.cpp\r\ndiff --git a/src/bench/inputfetcher.cpp b/src/bench/inputfetcher.cpp\r\nindex c10fcc5b5e..c1660c3ccf 100644\r\n--- a/src/bench/inputfetcher.cpp\r\n+++ b/src/bench/inputfetcher.cpp\r\n@@ -12,20 +12,18 @@\r\n #include <streams.h>\r\n #include <util/time.h>\r\n \r\n-static constexpr auto DELAY{2ms};\r\n-\r\n //! Simulates a DB by adding a delay when calling GetCoin\r\n struct DelayedCoinsView : CCoinsView\r\n {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override\r\n     {\r\n-        UninterruptibleSleep(DELAY);\r\n+        UninterruptibleSleep(2ms);\r\n         Coin coin{};\r\n         coin.out.nValue = 1;\r\n         return coin;\r\n     }\r\n \r\n-    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\r\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { throw std::logic_error{\"unused\"}; }\r\n };\r\n \r\n static void InputFetcherBenchmark(benchmark::Bench& bench)\r\n@@ -39,11 +37,13 @@ static void InputFetcherBenchmark(benchmark::Bench& bench)\r\n     // The main thread should be counted to prevent thread oversubscription, and\r\n     // to decrease the variance of benchmark results.\r\n     const auto worker_threads_num{GetNumCores() - 1};\r\n-    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\r\n+    InputFetcher fetcher{worker_threads_num};\r\n \r\n     bench.run([&] {\r\n         CCoinsViewCache temp_cache(&main_cache);\r\n         fetcher.FetchInputs(temp_cache, main_cache, db, block);\r\n+        ankerl::nanobench::doNotOptimizeAway(&temp_cache);\r\n+        Assert(temp_cache.GetCacheSize() == 4599);\r\n     });\r\n }\r\n \r\ndiff --git a/src/bench/txid_membership.cpp b/src/bench/txid_membership.cpp\r\nnew file mode 100644\r\nindex 0000000000..e646bb2a4a\r\n--- /dev/null\r\n+++ b/src/bench/txid_membership.cpp\r\n@@ -0,0 +1,134 @@\r\n+// Copyright (c) 2022-present The Bitcoin Core developers\r\n+// Distributed under the MIT software license, see the accompanying\r\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n+\r\n+#include <bench/bench.h>\r\n+#include <bench/nanobench.h>\r\n+#include <primitives/transaction_identifier.h>\r\n+#include <random.h>\r\n+#include <util/check.h>\r\n+#include <util/hasher.h>\r\n+\r\n+#include <algorithm>\r\n+#include <ranges>\r\n+#include <set>\r\n+#include <unordered_set>\r\n+#include <vector>\r\n+\r\n+namespace {\r\n+\r\n+constexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\n+constexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\n+constexpr size_t tx_count{5500};\r\n+\r\n+struct Dataset {\r\n+    std::set<Txid> sorted_set;\r\n+    std::unordered_set<Txid, SaltedTxidHasher> unsorted_set;\r\n+    std::vector<Txid> vec_sorted;\r\n+    std::vector<Txid> vec_unsorted;\r\n+\r\n+    std::vector<Txid> queries;\r\n+};\r\n+\r\n+std::vector<Dataset> BuildDatasets()\r\n+{\r\n+    FastRandomContext rng(/*fDeterministic=*/true);\r\n+\r\n+    std::vector<Dataset> datasets;\r\n+    datasets.reserve(iterations);\r\n+\r\n+    for (size_t d{0}; d < iterations; ++d) {\r\n+        Dataset ds;\r\n+        ds.queries.reserve(tx_count);\r\n+        ds.unsorted_set.reserve(tx_count);\r\n+        ds.vec_sorted.reserve(tx_count);\r\n+        ds.vec_unsorted.reserve(tx_count);\r\n+\r\n+        for (size_t i{0}; i < tx_count; ++i) {\r\n+            Txid t{Txid::FromUint256(rng.rand256())};\r\n+            ds.sorted_set.emplace(t);\r\n+            ds.unsorted_set.emplace(t);\r\n+            ds.vec_sorted.emplace_back(t);\r\n+            ds.vec_unsorted.emplace_back(t);\r\n+\r\n+            ds.queries.emplace_back(i < hits_count ? t : Txid::FromUint256(rng.rand256()));\r\n+        }\r\n+\r\n+        std::ranges::shuffle(ds.queries, rng);\r\n+        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n+        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n+\r\n+        datasets.emplace_back(std::move(ds));\r\n+    }\r\n+    return datasets;\r\n+}\r\n+\r\n+} // namespace\r\n+\r\n+static void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += s.unsorted_set.contains(q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_SetOrdered(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += s.sorted_set.contains(q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+static void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n+{\r\n+    static auto ds{BuildDatasets()};\r\n+    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n+        return std::ranges::find(v, x) != v.end();\r\n+    }};\r\n+    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n+        size_t sum{0};\r\n+        for (const auto& s : ds) {\r\n+            for (const auto& q : s.queries) {\r\n+                sum += contains_linear(s.vec_unsorted, q);\r\n+            }\r\n+        }\r\n+        ankerl::nanobench::doNotOptimizeAway(sum);\r\n+        Assert(sum == iterations * hits_count);\r\n+    });\r\n+}\r\n+\r\n+BENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\n+BENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex 1b3dcfc309..95c3bfe2f5 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -486,7 +486,8 @@ public:\r\n      * Reserve enough space in the cache so the underlying unordered_map will\r\n      * not have to rehash unless capacity is exceeded.\r\n      */\r\n-    void Reserve(size_t capacity) {\r\n+    void Reserve(size_t capacity)\r\n+    {\r\n         cacheCoins.reserve(capacity);\r\n     }\r\n \r\ndiff --git a/src/inputfetcher.h b/src/inputfetcher.h\r\nindex cd9eaed6ea..d15c4874cc 100644\r\n--- a/src/inputfetcher.h\r\n+++ b/src/inputfetcher.h\r\n@@ -17,6 +17,7 @@\r\n #include <atomic>\r\n #include <barrier>\r\n #include <cstdint>\r\n+#include <set>\r\n #include <stdexcept>\r\n #include <thread>\r\n #include <unordered_set>\r\n@@ -38,9 +39,8 @@\r\n  */\r\n class InputFetcher\r\n {\r\n-private:\r\n     //! The latest input being fetched. Workers atomically increment this when fetching.\r\n-    alignas(64) std::atomic_size_t m_input_head{0};\r\n+    alignas(64) std::atomic_int32_t m_input_head{0};\r\n \r\n     //! The inputs of the block which is being fetched.\r\n     struct Input {\r\n@@ -59,7 +59,7 @@ private:\r\n         Coin coin{};\r\n \r\n         Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\r\n-        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n     };\r\n     std::vector<Input> m_inputs{};\r\n \r\n@@ -68,7 +68,7 @@ private:\r\n      * Used to filter out inputs that are created and spent in the same block,\r\n      * since they will not be in the db or the cache.\r\n      */\r\n-    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\r\n+    std::set<Txid> m_txids{};\r\n \r\n     //! DB coins view to fetch from.\r\n     const CCoinsView* m_db{nullptr};\r\n@@ -77,18 +77,15 @@ private:\r\n \r\n     std::vector<std::thread> m_worker_threads{};\r\n     std::barrier<> m_barrier;\r\n-    bool m_request_stop{false};\r\n \r\n     void WorkLoop() noexcept\r\n     {\r\n         while (true) {\r\n             m_barrier.arrive_and_wait();\r\n-            if (m_request_stop) [[unlikely]] {\r\n-                return;\r\n-            }\r\n+            if (m_input_head.load(std::memory_order_relaxed) < 0) [[unlikely]] return;\r\n             while (true) {\r\n-                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\r\n-                if (i >= m_inputs.size()) [[unlikely]] {\r\n+                const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\r\n+                if (i >= int32_t(m_inputs.size())) [[unlikely]] {\r\n                     break;\r\n                 }\r\n                 auto& input{m_inputs[i]};\r\n@@ -125,11 +122,10 @@ private:\r\n     }\r\n \r\n public:\r\n-    explicit InputFetcher(size_t worker_thread_count) noexcept\r\n-        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\r\n+    explicit InputFetcher(int32_t worker_thread_count) noexcept : m_barrier{(worker_thread_count + 1)}\r\n     {\r\n-        for (size_t n{0}; n < worker_thread_count; ++n) {\r\n-            m_worker_threads.emplace_back([this, n]() {\r\n+        for (int32_t n{0}; n < worker_thread_count; ++n) {\r\n+            m_worker_threads.emplace_back([this, n] {\r\n                 util::ThreadRename(strprintf(\"inputfetch.%i\", n));\r\n                 WorkLoop();\r\n             });\r\n@@ -145,6 +141,8 @@ public:\r\n \r\n         // Loop through the inputs of the block and set them in the queue.\r\n         // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\r\n+        //m_txids.reserve(block.vtx.size());\r\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\r\n         auto outputs_count{block.vtx[0]->vout.size()};\r\n         for (size_t i{1}; i < block.vtx.size(); ++i) {\r\n             const auto& tx{block.vtx[i]};\r\n@@ -162,7 +160,7 @@ public:\r\n         m_barrier.arrive_and_wait();\r\n \r\n         // Insert fetched coins into the temp_cache as they are set to READY.\r\n-        temp_cache.Reserve(m_inputs.size() + outputs_count);\r\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n         for (auto& input : m_inputs) {\r\n             auto status{input.status.load(std::memory_order_acquire)};\r\n             while (status == Input::Status::WAITING) {\r\n@@ -175,6 +173,7 @@ public:\r\n                 break;\r\n             }\r\n         }\r\n+        Assert(temp_cache.GetCacheSize() <= temp_cache.GetCacheSize() + m_inputs.size() + outputs_count); // TODO remove\r\n \r\n         m_barrier.arrive_and_wait();\r\n         // Cleanup after all worker threads have exited the inner loop.\r\n@@ -186,11 +185,9 @@ public:\r\n \r\n     ~InputFetcher()\r\n     {\r\n-        m_request_stop = true;\r\n-        m_barrier.arrive_and_wait();\r\n-        for (auto& t : m_worker_threads) {\r\n-            t.join();\r\n-        }\r\n+        m_input_head.store(-1, std::memory_order_relaxed);\r\n+        m_barrier.arrive_and_drop();\r\n+        for (auto& t : m_worker_threads) t.join();\r\n     }\r\n };\r\n \r\ndiff --git a/src/test/inputfetcher_tests.cpp b/src/test/inputfetcher_tests.cpp\r\nindex b92a15d291..3d085bc843 100644\r\n--- a/src/test/inputfetcher_tests.cpp\r\n+++ b/src/test/inputfetcher_tests.cpp\r\n@@ -14,10 +14,8 @@\r\n \r\n #include <boost/test/unit_test.hpp>\r\n \r\n-#include <cstdint>\r\n #include <memory>\r\n #include <stdexcept>\r\n-#include <string>\r\n #include <unordered_set>\r\n \r\n BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\r\n@@ -82,7 +80,7 @@ BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\r\n         }\r\n \r\n         CCoinsViewCache main_cache(&db);\r\n-        CCoinsViewCache cache(&cache);\r\n+        CCoinsViewCache cache(&main_cache);\r\n         getFetcher().FetchInputs(cache, main_cache, db, block);\r\n \r\n         std::unordered_set<Txid, SaltedTxidHasher> txids{};\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 7564b97a07..07ab71852f 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -6299,7 +6299,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\r\n \r\n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\r\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n-      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n+      m_input_fetcher{std::clamp<int32_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\r\n       m_interrupt{interrupt},\r\n       m_options{Flatten(std::move(options))},\r\n       m_blockman{interrupt, std::move(blockman_options)},\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3389779624",
      "submitted_at": "2025-11-02T20:31:48Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20663257933,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATPoEtN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20663257933",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "created_at": "2025-11-02T23:31:49Z"
    },
    {
      "event": "commented",
      "id": 3479640421,
      "node_id": "IC_kwDOABII587PZxll",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3479640421",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:31Z",
      "updated_at": "2025-11-03T09:34:31Z",
      "author_association": "CONTRIBUTOR",
      "body": "I have the IBD numbers for the i7-hdd and i9-ssd server. They're not as glorious as our `reindex-chainstate` measurements, most likely since I don't yet have a way to test IBD from extremely fast peers. But as a sanity-check I think it's fine, we're still bandwidth bound - which is a good problem to have.\r\n\r\n<details>\r\n<summary>7% faster IBD | 921129 blocks | dbcache 4500 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; \\                        \r\nSTOP=921129; DBCACHE=4500; \\                                                                                                                                \r\nCC=gcc; CXX=g++; \\                                                                                                                                          \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                   (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                              \r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)      \r\n  Time (mean Â± Ïƒ):     36470.995 s Â± 113.187 s    [User: 38024.880 s, System: 2035.545 s]\r\n  Range (min â€¦ max):   36390.960 s â€¦ 36551.030 s    2 runs\r\n  \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)                                                                         \r\n  Time (mean Â± Ïƒ):     33962.782 s Â± 375.163 s    [User: 41686.176 s, System: 2832.686 s]\r\n  Range (min â€¦ max):   33697.502 s â€¦ 34228.062 s    2 runs\r\n  \r\nRelative speed comparison\r\n        1.07 Â±  0.01  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -blocksonly -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n```\r\n\r\n</details>\r\n\r\nand\r\n\r\n<details>\r\n<summary>12% faster IBD | 921129 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n</summary>\r\n\r\n```\r\nCOMMITS=\"aeec2e421d2ba102d905633d474f0fb88f91a9bf 62868c8846f043477d128788eadced3e71522417\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\naeec2e421d coins: add inputfetcher\r\n62868c8846 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = aeec2e421d2ba102d905633d474f0fb88f91a9bf)\r\n  Time (mean Â± Ïƒ):     30907.958 s Â± 1761.510 s    [User: 51503.334 s, System: 3833.881 s]\r\n  Range (min â€¦ max):   29662.383 s â€¦ 32153.534 s    2 runs\r\n \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 62868c8846f043477d128788eadced3e71522417)\r\n  Time (mean Â± Ïƒ):     27504.900 s Â± 2529.652 s    [User: 59336.996 s, System: 5796.247 s]\r\n  Range (min â€¦ max):   25716.165 s â€¦ 29293.634 s    2 runs\r\n \r\nRelative speed comparison\r\n        1.12 Â±  0.12  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = aeec2e421d2ba102d905633d474f0fb88f91a9bf)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 62868c8846f043477d128788eadced3e71522417)\r\n```\r\n\r\n</details>\r\n\r\nand\r\n\r\n<details>\r\n<summary>9% faster IBD | 921129 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"2aa510348143521a14146e41b5cf87cb3e60b29e cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"IBD | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log && \\\r\n             grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -printtoconsole=0\"\r\n\r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting\r\ncb0fdfdf37 coins: add inputfetcher\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n  Time (mean Â± Ïƒ):     61239.351 s Â± 4942.104 s    [User: 90457.852 s, System: 16836.057 s]\r\n  Range (min â€¦ max):   57744.756 s â€¦ 64733.946 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (mean Â± Ïƒ):     66848.997 s Â± 1122.176 s    [User: 88025.800 s, System: 11057.384 s]\r\n  Range (min â€¦ max):   66055.499 s â€¦ 67642.496 s    2 runs\r\n  \r\nRelative speed comparison\r\n        1.09 Â±  0.09  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -blocksonly -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\n\r\n-----\r\n\r\n\r\nThe reindex-chainstate cases (which we can look at as a more stable way of testing offline-IBD) show very good results even for the max-memory usecase (45 GB dbcache) - and confirm @andrewtoth's claim that we may be able to deprecate the `-dbcache` argument after this since it has barely any effect after this change!\r\n\r\n<details>\r\n<summary>3% faster reindex-chainstate | 921129 blocks | dbcache 45000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; \\\r\nSTOP=921129; DBCACHE=45000; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n  Time (abs â‰¡):        16044.026 s               [User: 23421.874 s, System: 695.027 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n  Time (abs â‰¡):        15643.115 s               [User: 26237.588 s, System: 984.588 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n```\r\n\r\n</details>\r\n\r\nthe same measurement with default memory is basically exactly the same speed as with max memory (450 MB -> 15818 seconds vs 45 GB -> 15643 seconds)\r\n\r\n<details>\r\n<summary>30% faster reindex-chainstate | 921129 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"bf07cf0adf19889727cb6bea24ebfbbfcc231a0c 45fe0c0e5beddce1c9e836ab5d97aa064069c192\"; STOP=921129; DBCACHE=450; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\nbf07cf0adf coins: add inputfetcher\r\n45fe0c0e5b validation: fetch block inputs via InputFetcher before connecting\r\n \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n  Time (abs â‰¡):        20500.654 s               [User: 40766.355 s, System: 2845.314 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n  Time (abs â‰¡):        15818.604 s               [User: 45952.420 s, System: 4127.137 s]\r\n \r\nRelative speed comparison\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 45fe0c0e5beddce1c9e836ab5d97aa064069c192)\r\n        1.30          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = bf07cf0adf19889727cb6bea24ebfbbfcc231a0c)\r\n```\r\n\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>17% faster reindex-chainstate | 921129 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```\r\nCOMMITS=\"cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85 2aa510348143521a14146e41b5cf87cb3e60b29e\"; STOP=921129; DBCACHE=450;\r\n CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origi\r\nn $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(unam\r\ne -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log; \\\r\n              grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\ncb0fdfdf37 coins: add inputfetcher                                            \r\n2aa5103481 validation: fetch block inputs via InputFetcher before connecting                                                                                \r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n  Time (abs â‰¡):        43407.876 s               [User: 40230.765 s, System: 3077.358 s]\r\n                                                                              \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)                       \r\n  Time (abs â‰¡):        37189.669 s               [User: 45706.002 s, System: 4452.708 s]\r\n  \r\nRelative speed comparison\r\n        1.17          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = cb0fdfdf3704d5ffe6ccc634de6fdba6b7b57a85)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 2aa510348143521a14146e41b5cf87cb3e60b29e)\r\n```\r\n\r\n</details>\r\n\r\n<img width=\"1503\" height=\"869\" alt=\"image\" src=\"https://github.com/user-attachments/assets/2a3fa7c0-6d5e-4afb-a346-99aa733ac9e8\" />\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3479640421",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20670066006,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATQCC1W",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20670066006",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:33Z"
    },
    {
      "event": "subscribed",
      "id": 20670066069,
      "node_id": "SE_lADOABII586bT0I_zwAAAATQCC2V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20670066069",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-03T09:34:33Z"
    },
    {
      "event": "reviewed",
      "id": 3410536334,
      "node_id": "PRR_kwDOABII587LSKeO",
      "url": null,
      "actor": null,
      "commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-03T11:19:25Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3410536334",
      "submitted_at": "2025-11-03T11:19:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20713012354,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATSl3yC",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713012354",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "48da1e349f488220cfea299018969522b1f7a283",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/48da1e349f488220cfea299018969522b1f7a283",
      "created_at": "2025-11-04T20:59:31Z"
    },
    {
      "event": "labeled",
      "id": 20713609901,
      "node_id": "LE_lADOABII586bT0I_zwAAAATSoJqt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713609901",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-04T21:42:53Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20713870398,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATSpJQ-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20713870398",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c055a95b8085bc871802e76cb6b03f5745572218",
      "created_at": "2025-11-04T22:03:19Z"
    },
    {
      "event": "unlabeled",
      "id": 20714725818,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATSsaG6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20714725818",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-04T23:11:53Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3488760623,
      "node_id": "IC_kwDOABII587P8kMv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3488760623",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:32Z",
      "updated_at": "2025-11-05T01:46:32Z",
      "author_association": "CONTRIBUTOR",
      "body": "Benchmarked the latest up to block 921129 and it's 16% faster :rocket:. Not as fast as some of @l0rinc's numbers but it's on a laptop with an internal NVMe SSD. This change will see the most benefit for disk IO with higher latency, like network connected storage.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo d606c36a13ca2a055d1a4eb4c623fb6aa45405b2 && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 18498.670 Â± 16.716 | 18486.850 | 18510.490 | 1.00 |\r\n| `echo 25c45bb0d0bd6618ec9296a1a43605657124e5de && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 21537.077 Â± 123.626 | 21449.660 | 21624.494 | 1.16 Â± 0.01 |\r\n\r\nAlso refactored to not stop early if an input is missing. This let's us simplify the logic. We can get rid of the different status flags and just synchronize each input on an atomic bool.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3488760623",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 20716636141,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATSzsft",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20716636141",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:33Z"
    },
    {
      "event": "subscribed",
      "id": 20716636156,
      "node_id": "SE_lADOABII586bT0I_zwAAAATSzsf8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20716636156",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-05T01:46:33Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20717270118,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATS2HRm",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20717270118",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9ea30540974900de38d5485d133adaeb6123e803",
      "created_at": "2025-11-05T02:27:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20761636450,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATVfW5i",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20761636450",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "created_at": "2025-11-06T14:33:23Z"
    },
    {
      "event": "labeled",
      "id": 20763087729,
      "node_id": "LE_lADOABII586bT0I_zwAAAATVk5Nx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20763087729",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T15:25:38Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3497802844,
      "node_id": "IC_kwDOABII587QfDxc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3497802844",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T15:25:48Z",
      "updated_at": "2025-11-06T15:25:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/actions/runs/19139133943/job/54698986986</sub>\n<sub>LLM reason (âœ¨ experimental): Trailing whitespace detected in src/inputfetcher.h caused the lint check to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3497802844",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "reviewed",
      "id": 3428778459,
      "node_id": "PRR_kwDOABII587MXwHb",
      "url": null,
      "actor": null,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-06T15:35:31Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3428778459",
      "submitted_at": "2025-11-06T15:35:31Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "reviewed",
      "id": 3429394484,
      "node_id": "PRR_kwDOABII587MaGg0",
      "url": null,
      "actor": null,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-06T17:00:11Z",
      "author_association": "CONTRIBUTOR",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3429394484",
      "submitted_at": "2025-11-06T17:00:11Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20766387744,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATVxe4g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20766387744",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "created_at": "2025-11-06T17:27:44Z"
    },
    {
      "event": "unlabeled",
      "id": 20767569679,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATV1_cP",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20767569679",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-06T18:13:54Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20809638431,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATYWeIf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20809638431",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b4ae702e2cb9d947f190c35be41b46dc2f710552",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b4ae702e2cb9d947f190c35be41b46dc2f710552",
      "created_at": "2025-11-08T20:18:01Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20809991787,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATYX0Zr",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20809991787",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "88910d258e5ae8dff8bfe4cc26b0e919678d6f17",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/88910d258e5ae8dff8bfe4cc26b0e919678d6f17",
      "created_at": "2025-11-08T21:07:51Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20892493596,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATdSicc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20892493596",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c2b0239001629a43d50cb8eb00e884423db89b38",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c2b0239001629a43d50cb8eb00e884423db89b38",
      "created_at": "2025-11-12T16:05:46Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 20931074963,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATfltuT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/20931074963",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "created_at": "2025-11-14T01:40:00Z"
    },
    {
      "event": "commented",
      "id": 3532063730,
      "node_id": "IC_kwDOABII587ShwPy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3532063730",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-14T10:29:48Z",
      "updated_at": "2025-11-23T14:39:47Z",
      "author_association": "CONTRIBUTOR",
      "body": "I was still wondering how number of parallel threads affects this, given that it's not a cpu-bound task.\r\n\r\nThe measurements were done on i9, m4 and rpi4. First two have 16 threads, rpi has 4.\r\nThe results still indicate to me that it doesn't make sense to set parallelism based on number of cpus directly. Beyond 4-8 threads the systems didn't really perform any better.\r\n\r\n<img width=\"1489\" height=\"861\" alt=\"image\" src=\"https://github.com/user-attachments/assets/c6065154-0625-4609-928f-867c957ba2e4\" />\r\n\r\nI will continue measuring it on other systems as well, but wanted to share preliminary results since these measurements take a lot of time.\r\n\r\n<details>\r\n<summary>i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD \r\n</summary>\r\n\r\n```\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 2 4 8 16 32 64; do   time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par; done\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    94m1.512s\r\nuser    169m2.995s\r\nsys     11m59.017s\r\n\r\nreal    86m23.533s\r\nuser    171m32.112s\r\nsys     12m42.929s\r\n\r\nreal    82m58.013s\r\nuser    179m20.981s\r\nsys     14m25.288s\r\n\r\nreal    82m38.540s\r\nuser    197m24.427s\r\nsys     20m31.753s\r\n\r\nreal    82m38.442s\r\nuser    197m16.954s\r\nsys     20m32.770s\r\n\r\nreal    82m46.060s\r\nuser    197m44.609s\r\nsys     20m37.426s\r\n```\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>Macbook Pro M4 Max</summary>\r\n\r\n```\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && \\\r\ngit checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && \\\r\nfor par in 2 4 8 16 32 64; do\r\n  time ./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10711.00s user 1495.61s system 181% cpu 1:51:52.59 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10601.27s user 1311.29s system 207% cpu 1:35:49.25 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     11362.34s user 2558.23s system 242% cpu 1:35:29.27 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12203.63s user 5783.56s system 299% cpu 1:40:07.62 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12124.30s user 5764.53s system 298% cpu 1:40:01.07 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12276.36s user 5816.05s system 300% cpu 1:40:13.27 total\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>rpi4-8-1</summary>\r\n\r\n```\r\nroot@rpi4-8-1:/mnt/my_storage/bitcoin# for par in 4 8; do \\\r\n    COMMITS=\"c2b0239001629a43d50cb8eb00e884423db89b38\"; \\\r\n    STOP=700000; DBCACHE=450; \\\r\n    CC=gcc; CXX=g++; \\\r\n    BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n    (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\n    hyperfine \\\r\n      --sort command \\\r\n      --runs 1 \\\r\n      --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n      --parameter-list COMMIT ${COMMITS// /,} \\\r\n      --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n        ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n      --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n                  cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n      \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\"; \\\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=4 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        36057.895 s               [User: 61089.585 s, System: 12571.590 s]\r\n \r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=8 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        35682.583 s               [User: 61828.582 s, System: 14162.402 s]\r\n```\r\n\r\n</details>\r\n\r\n\r\nEdit: updated times:\r\n\r\n<img width=\"1495\" height=\"866\" alt=\"image\" src=\"https://github.com/user-attachments/assets/d5c8257f-5b46-40ce-9730-6a6b39049fb1\" />\r\n\r\n\r\nEdit2: update with even more fine-grained measurements\r\n<img width=\"1493\" height=\"868\" alt=\"image\" src=\"https://github.com/user-attachments/assets/7636f9f0-3e3a-484f-a8c0-61a00a6515fa\" />\r\n\r\n<details>\r\n<summary>Raw measurements</summary>\r\n\r\n```\r\n\r\ni9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 2 4 8 16 32 64; do   time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par; done\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    94m1.512s\r\nuser    169m2.995s\r\nsys     11m59.017s\r\n\r\nreal    86m23.533s\r\nuser    171m32.112s\r\nsys     12m42.929s\r\n\r\nreal    82m58.013s\r\nuser    179m20.981s\r\nsys     14m25.288s\r\n\r\nreal    82m38.540s\r\nuser    197m24.427s\r\nsys     20m31.753s\r\n\r\nreal    82m38.442s\r\nuser    197m16.954s\r\nsys     20m32.770s\r\n\r\nreal    82m46.060s\r\nuser    197m44.609s\r\nsys     20m37.426s\r\n\r\n\r\n\r\nroot@rpi4-8-1:/mnt/my_storage/bitcoin# for par in 2 4 8 16; do \\\r\n    COMMITS=\"c2b0239001629a43d50cb8eb00e884423db89b38\"; \\\r\n    STOP=700000; DBCACHE=450; \\\r\n    CC=gcc; CXX=g++; \\\r\n    BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n    (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\n    hyperfine \\\r\n      --sort command \\\r\n      --runs 1 \\\r\n      --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n      --parameter-list COMMIT ${COMMITS// /,} \\\r\n      --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n        ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n      --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n                  cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n      \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\"; \\\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=2 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        39770.114 s               [User: 62016.921 s, System: 12176.118 s]\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=4 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        36057.895 s               [User: 61089.585 s, System: 12571.590 s]\r\n\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=8 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        35682.583 s               [User: 61828.582 s, System: 14162.402 s]\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=16 (COMMIT = c2b0239001629a43d50cb8eb00e884423db89b38)\r\n  Time (abs â‰¡):        36414.980 s               [User: 63043.265 s, System: 16780.513 s]\r\n\r\n\r\n\r\n\r\n\r\nrpi5-16-1:\r\ncommit=d6fac85ee4465cce8e81e36cdfd46636d34725fa && git log -1 --pretty='%h %s' $commit && git fetch origin $commit >/dev/null 2>&1 && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 1 2 3 4 5 6 7 8 9 10; do   time ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -par=$par -stopatheight=800000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0; done\r\nd6fac85ee4 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    393m14.069s\r\nuser    611m13.972s\r\nsys     64m44.860s\r\n\r\nreal    335m41.301s\r\nuser    615m9.967s\r\nsys     61m58.381s\r\n\r\nreal    314m37.969s\r\nuser    617m42.106s\r\nsys     60m47.302s\r\n\r\nreal    313m26.580s\r\nuser    619m26.740s\r\nsys     63m59.801s\r\n\r\nreal    314m35.267s\r\nuser    622m30.314s\r\nsys     66m53.456s\r\n\r\nreal    314m14.335s\r\nuser    621m22.819s\r\nsys     68m30.831s\r\n\r\nreal    314m49.454s\r\nuser    621m3.552s\r\nsys     70m1.733s\r\n\r\nreal    316m10.270s\r\nuser    624m1.233s\r\nsys     70m48.074s\r\n\r\nreal    315m57.060s\r\nuser    619m48.948s\r\nsys     72m10.586s\r\n\r\nreal    316m27.926s\r\nuser    622m56.166s\r\nsys     73m16.170s\r\n\r\n\r\n\r\ni9:\r\ncommit=d6fac85ee4465cce8e81e36cdfd46636d34725fa && git log -1 --pretty='%h %s' $commit && git fetch origin $commit >/dev/null 2>&1 && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do   time ./build/bin/bitcoind -par=$par -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0; done\r\n\r\nd6fac85ee4 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    395m38.371s\r\nuser    624m54.760s\r\nsys     50m2.017s\r\n\r\nreal    321m54.706s\r\nuser    638m0.914s\r\nsys     45m16.018s\r\n\r\nreal    295m13.108s\r\nuser    635m21.111s\r\nsys     44m41.847s\r\n\r\nreal    281m53.289s\r\nuser    636m26.743s\r\nsys     45m4.569s\r\n\r\nreal    274m35.436s\r\nuser    638m44.171s\r\nsys     46m25.320s\r\n\r\nreal    270m4.622s\r\nuser    641m52.896s\r\nsys     45m44.507s\r\n\r\nreal    266m44.501s\r\nuser    647m12.988s\r\nsys     47m8.929s\r\n\r\nreal    265m9.994s\r\nuser    661m8.192s\r\nsys     48m54.941s\r\n\r\nreal    263m49.009s\r\nuser    675m41.091s\r\nsys     49m52.024s\r\n\r\nreal    262m13.541s\r\nuser    687m23.237s\r\nsys     51m29.839s\r\n\r\nreal    262m29.564s\r\nuser    701m19.813s\r\nsys     52m20.824s\r\n\r\nreal    261m29.692s\r\nuser    717m48.727s\r\nsys     53m54.110s\r\n\r\nreal    260m36.882s\r\nuser    727m35.223s\r\nsys     56m30.900s\r\n\r\nreal    259m58.230s\r\nuser    740m17.961s\r\nsys     57m37.615s\r\n\r\nreal    259m46.496s\r\nuser    750m59.419s\r\nsys     59m55.428s\r\n\r\nreal    262m3.069s\r\nuser    756m49.146s\r\nsys     63m51.639s\r\n\r\nreal    262m29.892s\r\nuser    755m7.876s\r\nsys     63m29.261s\r\n\r\nreal    262m54.519s\r\nuser    759m4.919s\r\nsys     62m51.652s\r\n\r\n\r\n\r\ni7:\r\ncommit=d6fac85ee4465cce8e81e36cdfd46636d34725fa && git log -1 --pretty='%h %s' $commit && git fetch origin $commit >/dev/null 2>&1 && git checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && for par in 1 2 3 4 5 6 7 8 9 10 11 12 13; do   time ./build/bin/bitcoind -par=$par -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0; done\r\n\r\nd6fac85ee4 validation: fetch block inputs via InputFetcher before connecting\r\n\r\nreal    677m53.522s\r\nuser    540m13.974s\r\nsys     48m0.685s\r\n\r\nreal    616m58.994s\r\nuser    547m24.056s\r\nsys     46m0.808s\r\n\r\nreal    582m52.884s\r\nuser    554m55.162s\r\nsys     45m21.949s\r\n\r\nreal    577m5.937s\r\nuser    563m47.629s\r\nsys     45m28.084s\r\n\r\nreal    568m25.225s\r\nuser    576m19.153s\r\nsys     46m34.582s\r\n\r\nreal    566m31.568s\r\nuser    586m8.162s\r\nsys     46m41.220s\r\n\r\nreal    564m43.096s\r\nuser    594m42.382s\r\nsys     49m17.091s\r\n\r\nreal    558m40.218s\r\nuser    600m10.625s\r\nsys     52m24.030s\r\n\r\nreal    556m23.944s\r\nuser    606m36.724s\r\nsys     55m27.147s\r\n\r\nreal    565m47.020s\r\nuser    607m41.449s\r\nsys     56m21.510s\r\n\r\nreal    563m37.784s\r\nuser    609m40.123s\r\nsys     57m35.573s\r\n\r\nreal    567m43.207s\r\nuser    608m53.189s\r\nsys     57m43.208s\r\n\r\nreal    563m14.968s\r\nuser    611m1.819s\r\nsys     58m43.991s\r\n\r\n\r\nMacbook Pro M4 Max\r\ncommit=c2b0239001629a43d50cb8eb00e884423db89b38 && git log -1 --pretty='%h %s' $commit && \\\r\ngit checkout $commit >/dev/null 2>&1 && rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && \\\r\nfor par in 2 4 8 16 32 64; do\r\n  time ./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 -par=$par\r\ndone\r\n\r\nc2b0239001 validation: fetch block inputs via InputFetcher before connecting\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10711.00s user 1495.61s system 181% cpu 1:51:52.59 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     10601.27s user 1311.29s system 207% cpu 1:35:49.25 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     11362.34s user 2558.23s system 242% cpu 1:35:29.27 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12203.63s user 5783.56s system 299% cpu 1:40:07.62 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12124.30s user 5764.53s system 298% cpu 1:40:01.07 total\r\n./build/bin/bitcoind -stopatheight=800000 -dbcache=450 -reindex-chainstate     12276.36s user 5816.05s system 300% cpu 1:40:13.27 total\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3532063730",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21118717953,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATqxhAB",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21118717953",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1e60a8ff5ef2818d76d5b8c58c210694ee7741ec",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1e60a8ff5ef2818d76d5b8c58c210694ee7741ec",
      "created_at": "2025-11-23T01:20:52Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21119000246,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATqyl62",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119000246",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "aba28093c24ef446b78acdda0559536fd08b6f96",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/aba28093c24ef446b78acdda0559536fd08b6f96",
      "created_at": "2025-11-23T01:54:23Z"
    },
    {
      "event": "labeled",
      "id": 21119001357,
      "node_id": "LE_lADOABII586bT0I_zwAAAATqymMN",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119001357",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T01:54:52Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3567362645,
      "node_id": "IC_kwDOABII587UoaJV",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3567362645",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T01:55:04Z",
      "updated_at": "2025-11-23T01:55:04Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `fuzzer,address,undefined,integer, no depends`: https://github.com/bitcoin/bitcoin/actions/runs/19603900050/job/56139454218</sub>\n<sub>LLM reason (âœ¨ experimental): Fuzz run crashes with UndefinedBehaviorSanitizer: null-pointer-use (null CTransaction dereference in CoinsViewCacheAsync).</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3567362645",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "convert_to_draft",
      "id": 21119213205,
      "node_id": "CTDE_lADOABII586bT0I_zwAAAATqzZ6V",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119213205",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T02:49:26Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21119372860,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq0A48",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119372860",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "197f73c920c71519ef1bc40b111399f3c5cdc634",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/197f73c920c71519ef1bc40b111399f3c5cdc634",
      "created_at": "2025-11-23T03:36:45Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21119723124,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq1WZ0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119723124",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0c59bf677d9a4fe81cc09abb1f91f6af1453222b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0c59bf677d9a4fe81cc09abb1f91f6af1453222b",
      "created_at": "2025-11-23T05:27:45Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21119936155,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq2Kab",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21119936155",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c414ceb72876cca59f5ec6e56441e59fb2cc9995",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c414ceb72876cca59f5ec6e56441e59fb2cc9995",
      "created_at": "2025-11-23T06:28:29Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21120097072,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq2xsw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21120097072",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c0a0948cdb9cce6d9b680bdd7d9a745b9ac4cc7d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c0a0948cdb9cce6d9b680bdd7d9a745b9ac4cc7d",
      "created_at": "2025-11-23T07:17:19Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21120273093,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq3crF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21120273093",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6ecfafd288d565f2e89ffde375947281fc4c6c0b",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/6ecfafd288d565f2e89ffde375947281fc4c6c0b",
      "created_at": "2025-11-23T08:11:00Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21122455213,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATq_xat",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21122455213",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "097edd861fd3148cc95bee58bc4a37002c8bf3a5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/097edd861fd3148cc95bee58bc4a37002c8bf3a5",
      "created_at": "2025-11-23T14:45:43Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21122599499,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATrAUpL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21122599499",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "014f6cc70264cc816421cb95539f88216f2c6423",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/014f6cc70264cc816421cb95539f88216f2c6423",
      "created_at": "2025-11-23T15:16:03Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21122836649,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATrBOip",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21122836649",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "42e68d48b4da838361b045a977242d3262f8b351",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/42e68d48b4da838361b045a977242d3262f8b351",
      "created_at": "2025-11-23T15:54:54Z"
    },
    {
      "event": "unlabeled",
      "id": 21123083467,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATrCKzL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21123083467",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T16:48:33Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "ready_for_review",
      "id": 21123086692,
      "node_id": "RFRE_lADOABII586bT0I_zwAAAATrCLlk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21123086692",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T16:49:18Z"
    },
    {
      "event": "commented",
      "id": 3568164009,
      "node_id": "IC_kwDOABII587Urdyp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3568164009",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T17:13:08Z",
      "updated_at": "2025-11-23T17:15:15Z",
      "author_association": "CONTRIBUTOR",
      "body": "I've updated the PR to make the `InputFetcher` a subclass of `CCoinsViewCache`. Instead of waiting on the MPSC queue to be finished before connecting the block, the queue can be processed inside `CCoinsViewCache::FetchCoin` during `ConnectBlock`. This makes the fetching non-blocking, which is a significant performance improvement. It's been renamed to `CoinsViewCacheAsync`.\r\n\r\n@l0rinc thank you for your very thorough benchmarks. I've updated this to use 4 worker threads, which yields the same speed as with 15 on my benchmark machine. I've also made this non-configurable, as I don't see a reason why a user would want to change it. It should help performance on single core machines as well since the parallel work is IO bound.\r\n\r\nThis new non-blocking version using 4 threads is significantly faster. On the same machine that yielded [16% IBD speedup until block 921129](https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3488760623), this version is now 21% faster :rocket:. I'm curious to see benchmarks on other machines.\r\n\r\n| Command | Mean [s] | Min [s] | Max [s] | Relative |\r\n|:---|---:|---:|---:|---:|\r\n| `echo 42e68d48b4da838361b045a977242d3262f8b351 && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 17842.357 Â± 131.143 | 17749.624 | 17935.089 | 1.00 |\r\n| `echo 25c45bb0d0bd6618ec9296a1a43605657124e5de && /usr/bin/time ./build/bin/bitcoind -printtoconsole=0 -connect=192.168.2.171 -stopatheight=921129` | 21537.077 Â± 123.626 | 21449.660 | 21624.494 | 1.21 |",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3568164009",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 21123200598,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATrCnZW",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21123200598",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T17:13:09Z"
    },
    {
      "event": "subscribed",
      "id": 21123200604,
      "node_id": "SE_lADOABII586bT0I_zwAAAATrCnZc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21123200604",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-23T17:13:09Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21125583326,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATrLtHe",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21125583326",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e8028f337175c40fea8c7e24acaa273a1fdf7543",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e8028f337175c40fea8c7e24acaa273a1fdf7543",
      "created_at": "2025-11-24T00:51:20Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21125839899,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATrMrwb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21125839899",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "a7016db0ca321fe962b8960795405d7329729ad1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/a7016db0ca321fe962b8960795405d7329729ad1",
      "created_at": "2025-11-24T01:27:27Z"
    },
    {
      "event": "labeled",
      "id": 21125843551,
      "node_id": "LE_lADOABII586bT0I_zwAAAATrMspf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21125843551",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-24T01:28:00Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3568644017,
      "node_id": "IC_kwDOABII587UtS-x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3568644017",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-24T01:28:10Z",
      "updated_at": "2025-11-24T01:28:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `fuzzer,address,undefined,integer, no depends`: https://github.com/bitcoin/bitcoin/actions/runs/19620057148/job/56178655244</sub>\n<sub>LLM reason (âœ¨ experimental): libFuzzer crash (deadly signal) from an assertion in DbCoinsView::GetCoin during fuzzing.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3568644017",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21126961641,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATrQ9np",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21126961641",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "19394266331c27469441b2af08a496ca8ffe16d6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/19394266331c27469441b2af08a496ca8ffe16d6",
      "created_at": "2025-11-24T03:43:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21148077513,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATshg3J",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21148077513",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7b0100cd82ffbbfbe1d150a00d918dbe151e773e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7b0100cd82ffbbfbe1d150a00d918dbe151e773e",
      "created_at": "2025-11-24T20:15:14Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21148331311,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATsie0v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21148331311",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e86d48527122c803a58d7bfecffd43a0e373c756",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e86d48527122c803a58d7bfecffd43a0e373c756",
      "created_at": "2025-11-24T20:29:09Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21150285515,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATsp77L",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21150285515",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "960ebad0929546feef26cd84285eba8ff52e7e61",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/960ebad0929546feef26cd84285eba8ff52e7e61",
      "created_at": "2025-11-24T22:23:39Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21151470709,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATsudR1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21151470709",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "66d09a42eb957ba1f3e04383035edfd3c8c82b18",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/66d09a42eb957ba1f3e04383035edfd3c8c82b18",
      "created_at": "2025-11-24T23:51:26Z"
    },
    {
      "event": "unlabeled",
      "id": 21152034961,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATswnCR",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21152034961",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-25T00:39:20Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21152931000,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATs0By4",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21152931000",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "32de0ff1a97fc2880ba2f507dd00082727badf3f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/32de0ff1a97fc2880ba2f507dd00082727badf3f",
      "created_at": "2025-11-25T01:43:34Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21175375502,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATuJpaO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21175375502",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b1a791db1c75a47569b690baf7b074b78e08ca5a",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b1a791db1c75a47569b690baf7b074b78e08ca5a",
      "created_at": "2025-11-25T22:18:54Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21206860606,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATwBwM-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21206860606",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "56cff0f1dde58426907b73d39d2778857c19cbac",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/56cff0f1dde58426907b73d39d2778857c19cbac",
      "created_at": "2025-11-26T23:01:43Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21208350530,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATwHb9C",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21208350530",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "created_at": "2025-11-27T01:36:30Z"
    },
    {
      "event": "reviewed",
      "id": 3515011880,
      "node_id": "PRR_kwDOABII587RgtMo",
      "url": null,
      "actor": null,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-27T16:40:02Z",
      "author_association": "CONTRIBUTOR",
      "body": "This new design achieves the best results I've seen so far across all platforms measured, excellent job!!\r\n\r\nIt evolved from an `InputFetcher` helper (where the parallelism happened before `ConnectBlock` was called) to `CoinsViewCacheAsync`, a multithreaded `CCoinsViewCache` subclass whose worker threads run in parallel with `ConnectBlock` itself.\r\n\r\nInternal spends are still filtered using short txid prefixes stored in a sorted `std::vector` and checked via `std::binary_search`. In the rare case of a prefix collision, the async fetcher will simply skip that input, and it will be fetched later by the normal synchronous path.\r\n\r\nFor now the async view uses a fixed worker thread count of 4. The workload is primarily I/O-bound on DB latency rather than CPU-bound, so 4 workers already hide most of the latency and it simplifies the implementation. If needed we can make this configurable or tie it to `-par` later.\r\n\r\nThis way the I/O-bound work runs in parallel with the CPU-bound validation work, and the preliminary results are very encouraging: on a Raspberry Pi 5 the best `-reindex-chainstate` so far is about 7.3 hours with `-dbcache=4500` and about 7.7 hours with the default 450 MB, roughly 36% and 46% faster than the current single-threaded baseline.\r\n\r\nThe new implementation has been fuzzed for several days - it would be good to get some more eyes on it.\r\n\r\n<img width=\"1500\" height=\"861\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/c631ce84-9610-46ed-8cc2-8e171fd2d0f5\" />\r\n\r\n(some of these measurements are suspiciously good, especially the M4 versions (maybe it switches from the energy efficient cores to the performance ones), I will try to replicate the results in followups)\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\n> M4 @ dbcache=450:\r\nfor commit in dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab 32de0ff1a97fc2880ba2f507dd00082727badf3f; do\r\n  git fetch origin $commit >/dev/null 2>&1 && git checkout $commit >/dev/null 2>&1 && git log -1 --pretty='%h %s' && \\\r\n  rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && \\\r\n  time ./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 || exit 1\r\ndone\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     20994.00s user 5348.08s system 120% cpu 6:03:05.28 total\r\n\r\n32de0ff1a9 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate     16748.42s user 1830.34s system 276% cpu 1:51:50.94 total\r\n\r\n\r\n> M4 @ dbcache=4500:\r\nd5ed4ba9d8 Merge bitcoin/bitcoin#33906: depends: Add patch for Windows11Style plugin\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -blocksonly    8895.93s user 751.51s system 133% cpu 2:00:08.82 total\r\nb1a791db1c validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -blocksonly    10327.49s user 940.30s system 186% cpu 1:40:57.44 total\r\n\r\n> M4 @ dbcache=45000:\r\nfor commit in dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab b1a791db1c75a47569b690baf7b074b78e08ca5a; do\r\n  git fetch origin $commit >/dev/null 2>&1 && git checkout $commit >/dev/null 2>&1 && git log -1 --pretty='%h %s' && \\\r\n  rm -rf build && cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF >/dev/null 2>&1 && ninja -C build bitcoind -j$(nproc) >/dev/null 2>&1 && \\\r\n  time ./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 || exit 1\r\ndone\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   6338.71s user 332.32s system 131% cpu 1:24:22.56 total\r\n\r\nb1a791db1c validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate   7301.13s user 471.62s system 162% cpu 1:19:35.33 total\r\n\r\n\r\n> i9 @ dbcache=450:\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\ne86d485271 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (abs â‰¡):        20659.626 s               [User: 40733.602 s, System: 2871.904 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n  Time (abs â‰¡):        14729.736 s               [User: 39566.674 s, System: 2313.959 s]\r\n\r\nRelative speed comparison\r\n        1.40          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n\r\n\r\n> i9  @ dbcache=4500:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab 32de0ff1a97fc2880ba2f507dd00082727badf3f\"; STOP=921129; DBCACHE=4500; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\n32de0ff1a9 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 4500 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (abs â‰¡):        16615.768 s               [User: 25458.915 s, System: 859.662 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n  Time (abs â‰¡):        13689.366 s               [User: 26290.581 s, System: 991.037 s]\r\n\r\nRelative speed comparison\r\n        1.21          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n\r\n\r\n> i9  @ dbcache=45000:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab 32de0ff1a97fc2880ba2f507dd00082727badf3f\"; STOP=921129; DBCACHE=45000; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\n32de0ff1a9 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 45000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (abs â‰¡):        16118.775 s               [User: 23433.898 s, System: 725.843 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n  Time (abs â‰¡):        14429.306 s               [User: 23850.818 s, System: 792.987 s]\r\n\r\nRelative speed comparison\r\n        1.12          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n\r\n\r\n> i7 @ dbcache=450:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab 32de0ff1a97fc2880ba2f507dd00082727badf3f\"; STOP=921129; DBCACHE=450; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origi\r\nn $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(unam\r\ne -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS/\r\n/ /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5;\r\ngrep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.\r\nlog; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -d\r\nbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\n32de0ff1a9 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -conne\r\nct=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (abs â‰¡):        42473.571 s               [User: 40584.287 s, System: 3012.074 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -conne\r\nct=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n  Time (abs â‰¡):        34193.205 s               [User: 42326.030 s, System: 2778.267 s]\r\n\r\nRelative speed comparison\r\n        1.24          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blockson\r\nly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blockson\r\nly -connect=0 -printtoconsole=0 (COMMIT = 32de0ff1a97fc2880ba2f507dd00082727badf3f)\r\n\r\n\r\n> i7 @ dbcache=4500:\r\nCOMMITS=\"d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac b1a791db1c75a47569b690baf7b074b78e08ca5a\"; STOP=921129; DBCACHE=4500; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\ncmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\ncp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\nd5ed4ba9d8 Merge bitcoin/bitcoin#33906: depends: Add patch for Windows11Style plugin\r\nb1a791db1c validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 4500 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\r\n  Time (abs â‰¡):        27190.152 s               [User: 33685.961 s, System: 1842.096 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\r\n  Time (abs â‰¡):        23873.513 s               [User: 27793.779 s, System: 1036.030 s]\r\n\r\nRelative speed comparison\r\n        1.14          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\r\n\r\n\r\n> i7 @ dbcache=45000:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab e86d48527122c803a58d7bfecffd43a0e373c756\"; \\\r\nSTOP=921129; DBCACHE=45000; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\ne86d485271 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 45000 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (mean Â± Ïƒ):     22133.846 s Â± 42.629 s    [User: 24498.825 s, System: 634.139 s]\r\n  Range (min â€¦ max):   22103.703 s â€¦ 22163.990 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n  Time (mean Â± Ïƒ):     20547.518 s Â±  8.809 s    [User: 25074.730 s, System: 695.076 s]\r\n  Range (min â€¦ max):   20541.289 s â€¦ 20553.747 s    2 runs\r\n\r\nRelative speed comparison\r\n        1.08 Â±  0.00  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n\r\n\r\n> rpi5 @ dbcache=450:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab e86d48527122c803a58d7bfecffd43a0e373c756\"; \\\r\nSTOP=921129; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 2 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\ne86d485271 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 450 | rpi5-16-1 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (mean Â± Ïƒ):     41084.236 s Â± 701.352 s    [User: 68642.573 s, System: 7256.334 s]\r\n  Range (min â€¦ max):   40588.305 s â€¦ 41580.166 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n  Time (mean Â± Ïƒ):     28200.555 s Â± 297.983 s    [User: 66305.959 s, System: 5678.536 s]\r\n  Range (min â€¦ max):   27989.850 s â€¦ 28411.261 s    2 runs\r\n\r\nRelative speed comparison\r\n        1.46 Â±  0.03  COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n\r\n\r\n> rpi5 @ dbcache=4500:\r\nCOMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab e86d48527122c803a58d7bfecffd43a0e373c756\"; STOP=921129; DBCACHE=4500; CC14:18:21 [10/1679]\r\nE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exi\r\nt 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs)\r\n| $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 &&\r\n echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.jso\r\nn\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA\r\n_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\nroot@rpi5-16-1:/mnt/my_storage/bitcoin# COMMITS=\"dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab e86d48527122c803a58d7bfecffd43a0e373c756\"; STOP=921129; DBCACHE=4500; CC=gcc; CXX=g++; BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&hyperfine   --sort command   --runs 1   --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\"   --parameter-list COMMIT ${COMMITS// /,}   --prepare \"killall bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\"   --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\"   \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\ndfde31f2ec Merge bitcoin/bitcoin#33864: scripted-diff: fix leftover references to `policy/fees.h`\r\ne86d485271 validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 921129 blocks | dbcache 4500 | rpi5-16-1 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n  Time (abs â‰¡):        35867.389 s               [User: 41695.508 s, System: 3281.868 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n  Time (abs â‰¡):        26440.662 s               [User: 43495.688 s, System: 3743.419 s]\r\n\r\nRelative speed comparison\r\n        1.36          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = dfde31f2ec1f90976f3ba6b06f2b38a1307c01ab)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e86d48527122c803a58d7bfecffd43a0e373c756)\r\n```\r\n\r\n</details>",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3515011880",
      "submitted_at": "2025-11-27T15:26:24Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "renamed",
      "id": 21224594472,
      "node_id": "RTE_lADOABII586bT0I_zwAAAATxFZwo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21224594472",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-27T16:22:02Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads >20% faster IBD",
        "to": "validation: fetch block inputs on parallel threads >40% faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21254561160,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATy3t2I",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21254561160",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "077f8eb3b5dec614f76bfc3538e28d9740ebd3b3",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/077f8eb3b5dec614f76bfc3538e28d9740ebd3b3",
      "created_at": "2025-11-30T03:48:01Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21254589571,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATy30yD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21254589571",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "5810e364b0bd106425e4c2e727a08e1bf546cb59",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/5810e364b0bd106425e4c2e727a08e1bf546cb59",
      "created_at": "2025-11-30T04:00:24Z"
    },
    {
      "event": "labeled",
      "id": 21254591163,
      "node_id": "LE_lADOABII586bT0I_zwAAAATy31K7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21254591163",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T04:00:59Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3592170548,
      "node_id": "IC_kwDOABII587WHCw0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3592170548",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T04:01:19Z",
      "updated_at": "2025-11-30T04:01:19Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `ASan + LSan + UBSan + integer`: https://github.com/bitcoin/bitcoin/actions/runs/19793395783/job/56710184816</sub>\n<sub>LLM reason (âœ¨ experimental): Compiler errors: thread-safety checks fail in coinsviewcacheasync.cpp (requires holding cs_main exclusively), causing build to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3592170548",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21254775855,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATy4iQv",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21254775855",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "19bc07e8adbced7f222fab96ac935b7fdcd4c2fa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/19bc07e8adbced7f222fab96ac935b7fdcd4c2fa",
      "created_at": "2025-11-30T05:14:11Z"
    },
    {
      "event": "unlabeled",
      "id": 21254903888,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATy5BhQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21254903888",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T05:59:07Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3592671116,
      "node_id": "IC_kwDOABII587WI8-M",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3592671116",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T15:15:38Z",
      "updated_at": "2025-11-30T15:15:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you very much for your review and bencharking @l0rinc! The speedup this offers is great. I have taken most of your suggestions.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3592671116",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 21257215865,
      "node_id": "MEE_lADOABII586bT0I_zwAAAATzB195",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21257215865",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T15:15:40Z"
    },
    {
      "event": "subscribed",
      "id": 21257215872,
      "node_id": "SE_lADOABII586bT0I_zwAAAATzB1-A",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21257215872",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T15:15:40Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21257605030,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATzDU-m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21257605030",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "e841a652f87cde8c09844583a70e00133d5103f4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/e841a652f87cde8c09844583a70e00133d5103f4",
      "created_at": "2025-11-30T16:04:48Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21257698285,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATzDrvt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21257698285",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b1104aea508b8608dafce91f4d4b3d51ff40f8a8",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b1104aea508b8608dafce91f4d4b3d51ff40f8a8",
      "created_at": "2025-11-30T16:15:29Z"
    },
    {
      "event": "labeled",
      "id": 21257703676,
      "node_id": "LE_lADOABII586bT0I_zwAAAATzDtD8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21257703676",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T16:16:01Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3592769401,
      "node_id": "IC_kwDOABII587WJU95",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3592769401",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T16:16:16Z",
      "updated_at": "2025-11-30T16:16:16Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `Windows-cross to x86_64, ucrt`: https://github.com/bitcoin/bitcoin/actions/runs/19801430839/job/56729280722</sub>\n<sub>LLM reason (âœ¨ experimental): Linker failure: undefined reference to util::TraceThread causing the bitcoinkernel.dll build to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3592769401",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "unlabeled",
      "id": 21258114541,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAATzFRXt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21258114541",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-11-30T17:03:24Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21258446887,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATzGign",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21258446887",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/69310ec0035351e486cfb51cb66492639f6f8b47",
      "created_at": "2025-11-30T17:40:08Z"
    },
    {
      "event": "reviewed",
      "id": 3521928328,
      "node_id": "PRR_kwDOABII587R7FyI",
      "url": null,
      "actor": null,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-11-30T21:15:49Z",
      "author_association": "CONTRIBUTOR",
      "body": "The new version cleverly uses `m_inputs` being empty as the shared shutdown signal (handling both 'no work' and 'shutdown' cases). This finally allowed us to eliminate the `m_request_stop` flag I disliked :).\n\nIt also benchmarks real-world I/O latency via a real LevelDB acces, while the fuzz tests use in-memory LevelDB now - sweet!\nThe new design basically falls back to synchronous fetching gracefully in cases of collisions or delays (we may want to test that specifically).\n\nRegarding 'faster IBD performance', I think it would be more accurate to call it 'validation performance', as this benefits block connection generally, not just during initial download (which we can't reliably measure anyway).\n\nShould we also add some log message announcing that input fetching is running on parallel threads? We should definitely add release notes for this feature once it stabilizes - and I like this latest push a lot!\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3521928328",
      "submitted_at": "2025-11-30T21:15:49Z",
      "state": "APPROVED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21260903932,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAATzP6X8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21260903932",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "created_at": "2025-11-30T22:20:46Z"
    },
    {
      "event": "reviewed",
      "id": 3523358497,
      "node_id": "PRR_kwDOABII587SAi8h",
      "url": null,
      "actor": null,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-01T09:43:05Z",
      "author_association": "CONTRIBUTOR",
      "body": "Redid he measurements on a Mac with AppleClang for different sizes to check why there's such a massive speedup for lowe memory:\n```bash\nfor DBCACHE in 450 4500 45000; do \\\n    COMMITS=\"d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac b1a791db1c75a47569b690baf7b074b78e08ca5a\"; \\\n    STOP=921129; \\\n    DATA_DIR=\"$HOME/Library/Application Support/Bitcoin\"; LOG_DIR=\"$HOME/bitcoin-reindex-logs\"; \\\n    mkdir -p \"$LOG_DIR\"; \\\n    COMMA_COMMITS=${COMMITS// /,}; \\\n    (echo \"\"; echo \"$COMMITS\" | tr ' ' '\\n' | while read -r c; do git log -1 --pretty='%h %s' -- \"$c\" || exit 1; done;) && \\\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(sysctl -n machdep.cpu.brand_string) | $(nproc) cores | $(printf '%.1fGiB' \"$(( $(sysctl -n hw.memsize)/1024/1024/1024 ))\") RAM | SSD | $(sw_vers -productName) $(sw_vers -productVersion) $(sw_vers -buildVersion) | $(xcrun clang --version | head -1)\"; echo \"\") && \\\n    hyperfine \\\n      --sort command \\\n      --runs 1 \\\n      --export-json \"$LOG_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-appleclang.json\" \\\n      --parameter-list COMMIT \"$COMMA_COMMITS\" \\\n      --prepare \"killall bitcoind 2>/dev/null || true; rm -f \\\"$DATA_DIR\\\"/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\n        ./build/bin/bitcoind -datadir=\\\"$DATA_DIR\\\" -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\n      --conclude \"killall bitcoind 2>/dev/null || true; sleep 5; grep -q 'height=0' \\\"$DATA_DIR\\\"/debug.log && grep -q 'Disabling script verification at block #1' \\\"$DATA_DIR\\\"/debug.log && grep -q \\\"height=$STOP\\\" \\\"$DATA_DIR\\\"/debug.log || { echo 'debug.log assertions failed'; exit 1; }; \\\n                  cp \\\"$DATA_DIR\\\"/debug.log \\\"$LOG_DIR\\\"/debug-{COMMIT}-\\$(date +%s).log 2>/dev/null || true\" \\\n      \"./build/bin/bitcoind -datadir=\\\"$DATA_DIR\\\" -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\ndone\n```\n\n> dbcache 450\n```bash\nreindex-chainstate | 921129 blocks | dbcache 450 | M4-Max.local | arm64 | Apple M4 Max | 16 cores | 64.0GiB RAM | SSD | macOS 26.1 25B78 | Apple clang version 17.0.0 (clang-1700.4.4.1)\n\nBenchmark 1: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n  Time (abs â‰¡):        26759.295 s               [User: 29786.899 s, System: 7379.722 s]\n\nBenchmark 2: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n  Time (abs â‰¡):        8826.595 s               [User: 23102.926 s, System: 2391.832 s]\n\nRelative speed comparison\n        3.03          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n        1.00          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n```\n\n> dbcache 4500\n```bash\nreindex-chainstate | 921129 blocks | dbcache 4500 | M4-Max.local | arm64 | Apple M4 Max | 16 cores | 64.0GiB RAM | SSD | macOS 26.1 25B78 | Apple clang version 17.0.0 (clang-1700.4.4.1)\n\nBenchmark 1: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n  Time (abs â‰¡):        12563.690 s               [User: 15217.346 s, System: 1087.166 s]\n\nBenchmark 2: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n  Time (abs â‰¡):        7786.335 s               [User: 14306.318 s, System: 1220.685 s]\n\nRelative speed comparison\n        1.61          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n        1.00          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n```\n\n> dbcache 45000\n```bash\nreindex-chainstate | 921129 blocks | dbcache 45000 | M4-Max.local | arm64 | Apple M4 Max | 16 cores | 64.0GiB RAM | SSD | macOS 26.1 25B78 | Apple clang version 17.0.0 (clang-1700.4.4.1)\n\nBenchmark 1: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n  Time (abs â‰¡):        5256.592 s               [User: 6551.334 s, System: 337.214 s]\n\nBenchmark 2: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n  Time (abs â‰¡):        4727.896 s               [User: 7191.973 s, System: 467.989 s]\n\nRelative speed comparison\n        1.11          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = d5ed4ba9d8627f1897322ce7eb5b34e08e4f73ac)\n        1.00          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b1a791db1c75a47569b690baf7b074b78e08ca5a)\n```\n\nThe huge difference may come from the multithreaded solution using the performance cores more heavily:\n\nMaster:\n<img width=\"869\" height=\"429\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/caa6ddaf-51c8-45cd-835a-232d2dc943af\" />\n\nPR:\n<img width=\"868\" height=\"426\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/5a410b64-b460-423e-b7f1-133bd266d02f\" />\n\n@andrewtoth can you reproduce the low-memory speedup results?",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3523358497",
      "submitted_at": "2025-12-01T09:43:05Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21284283132,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAT0pGL8",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21284283132",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "9b186fee419fcdd273e4b6514779c3f44f3210d4",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/9b186fee419fcdd273e4b6514779c3f44f3210d4",
      "created_at": "2025-12-01T18:31:08Z"
    },
    {
      "event": "labeled",
      "id": 21285674553,
      "node_id": "LE_lADOABII586bT0I_zwAAAAT0uZ45",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21285674553",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-01T19:26:03Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3598487324,
      "node_id": "IC_kwDOABII587WfI8c",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3598487324",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-01T19:26:09Z",
      "updated_at": "2025-12-01T19:26:09Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `32 bit ARM`: https://github.com/bitcoin/bitcoin/actions/runs/19833312863/job/56824503489</sub>\n<sub>LLM reason (âœ¨ experimental): Narrowing conversion in CoinsViewCacheAsync constructor triggers -Werror, causing the build to fail.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3598487324",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21285865481,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAT0vIgJ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21285865481",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "created_at": "2025-12-01T19:36:02Z"
    },
    {
      "event": "unlabeled",
      "id": 21286929691,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAT0zMUb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21286929691",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-01T20:27:40Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3617315125,
      "node_id": "IC_kwDOABII587Xm9k1",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3617315125",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T15:12:20Z",
      "updated_at": "2025-12-05T16:03:08Z",
      "author_association": "CONTRIBUTOR",
      "body": "I've generated some flamegraphs from perf data recorded during IBD for ~10k blocks between 850-900k for both master and this branch.\r\n\r\nThe 4 worker threads can be seen clearly on the left of the graph. The binary search through short txids is barely noticeable, which confirms our approach to not use an unordered_set + salted hasher.\r\n\r\nLooking at `b-msghand` (main) thread, we see `ConnectBlock` dominating it on master while block serialization and tx hash computation becomes the dominant factor on this branch. The main thread calling `ProcessInputInBackground` on this branch indicates that work stealing is working correctly, and that there might be some speedup if worker thread count was increased.\r\n\r\nI see these don't work well in the browser when hosted on github. If you right-click download them, then open in a browser they are easier to inspect.\r\n\r\n![perf_master](https://github.com/user-attachments/assets/bcffa24e-7883-4710-9977-3e80e5c5b5f6)\r\n![perf_branch](https://github.com/user-attachments/assets/45b7516f-b907-45e3-a7bd-f1707a035a3e)\r\n\r\n",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3617315125",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3617721711,
      "node_id": "IC_kwDOABII587Xog1v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3617721711",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-05T16:58:12Z",
      "updated_at": "2025-12-07T20:50:27Z",
      "author_association": "CONTRIBUTOR",
      "body": "The flames look impressive, my dfferential flames for all 900k blocks should also finish in a few days.\r\n\r\n### Parallelism vs speedup on different platforms\r\n\r\n<img width=\"1268\" height=\"910\" alt=\"image\" src=\"https://github.com/user-attachments/assets/b9a7538d-0e28-46bf-b1cc-6861cc459bd8\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 700000 blocks | dbcache 450 | M4-Max.local | arm64 | Apple M4 Max | 16 cores | 64.0GiB RAM | SSD | macOS 26.1 25B78 | Apple clang version 17.0.0 (clang-1700.4.4.1)</summary>\r\n\r\n```bash\r\nCOMMITS=\"8744e5a03e84eb407a861cd36fc30c2c5367169a 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f db9ec4d4e74a6286b3de713b47398013837c7749 e4bb647a1614bd9e6718f80a83d9fe998eb48f5f 36613ec98299411950520dd6361a96786607ed08 82cd3e294f3100d8f705d63135508e018efcb80f 114fef0f348b9a4d76b826585fd737886c87a6f1 ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd\"; \\\r\nSTOP=700000; DBCACHE=450; \\\r\nDATA_DIR=\"$HOME/Library/Application Support/Bitcoin\"; LOG_DIR=\"$HOME/bitcoin-reindex-logs\"; \\\r\nmkdir -p \"$LOG_DIR\"; \\\r\nCOMMA_COMMITS=${COMMITS// /,}; \\\r\n(echo \"\"; for c in $(echo $COMMITS); do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(sysctl -n machdep.cpu.brand_string) | $(nproc) cores | $(printf '%.1fGiB' \"$(( $(sysctl -n hw.memsize)/1024/1024/1024 ))\") RAM | SSD | $(sw_vers -productName) $(sw_vers -productVersion) $(sw_vers -buildVersion) | $(xcrun clang --version | head -1)\"; echo \"\") && \\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$LOG_DIR/rdx-$(echo \"$COMMITS\" | sed -E 's/([a-f0-9]{8})[a-f0-9]+ ?/\\1-/g;s/-$//')-$STOP-$DBCACHE-appleclang.json\" \\\r\n  --parameter-list COMMIT \"$COMMA_COMMITS\" \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null || true; rm -f \\\"$DATA_DIR\\\"/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=\\\"$DATA_DIR\\\" -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind 2>/dev/null || true; sleep 5; grep -q 'height=0' \\\"$DATA_DIR\\\"/debug.log && grep -q 'Disabling script verification at block #1' \\\"$DATA_DIR\\\"/debug.log && grep -q \\\"height=$STOP\\\" \\\"$DATA_DIR\\\"/debug.log || { echo 'debug.log assertions failed'; exit 1; }; \\\r\n              cp \\\"$DATA_DIR\\\"/debug.log \\\"$LOG_DIR\\\"/debug-{COMMIT}-\\$(date +%s).log 2>/dev/null || true\" \\\r\n  \"./build/bin/bitcoind -datadir=\\\"$DATA_DIR\\\" -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"\r\n\r\n8744e5a03e WORKER_THREADS{1}\r\n042dbfdc3f WORKER_THREADS{2}\r\ndb9ec4d4e7 WORKER_THREADS{3}\r\ne4bb647a16 WORKER_THREADS{4}\r\n36613ec982 WORKER_THREADS{5}\r\n82cd3e294f WORKER_THREADS{6}\r\n114fef0f34 WORKER_THREADS{7}\r\nae1589d7f9 WORKER_THREADS{8}\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | M4-Max.local | arm64 | Apple M4 Max | 16 cores | 64.0GiB RAM | SSD | macOS 26.1 25B78 | Apple clang version 17.0.0 (clang-1700.4.4.1)\r\n\r\nBenchmark 1: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n  Time (abs â‰¡):        4188.146 s               [User: 7387.420 s, System: 932.198 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n  Time (abs â‰¡):        3683.049 s               [User: 7346.612 s, System: 833.443 s]\r\n\r\nBenchmark 3: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n  Time (abs â‰¡):        3483.915 s               [User: 7427.734 s, System: 815.722 s]\r\n\r\nBenchmark 4: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n  Time (abs â‰¡):        3349.891 s               [User: 7531.310 s, System: 839.720 s]\r\n\r\nBenchmark 5: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n  Time (abs â‰¡):        3402.258 s               [User: 7836.059 s, System: 1139.180 s]\r\n\r\nBenchmark 6: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n  Time (abs â‰¡):        3399.448 s               [User: 8072.648 s, System: 1508.136 s]\r\n\r\nBenchmark 7: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n  Time (abs â‰¡):        3404.973 s               [User: 8226.177 s, System: 1889.810 s]\r\n\r\nBenchmark 8: ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n  Time (abs â‰¡):        3398.617 s               [User: 8358.164 s, System: 2256.116 s]\r\n\r\nRelative speed comparison\r\n        1.25          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n        1.10          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n        1.04          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n        1.00          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n        1.02          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n        1.01          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n        1.02          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n        1.01          ./build/bin/bitcoind -datadir=\"/Users/lorinc/Library/Application Support/Bitcoin\" -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n```\r\n\r\n</details>\r\n\r\n\r\n<img width=\"1257\" height=\"910\" alt=\"image\" src=\"https://github.com/user-attachments/assets/ff770b73-4ad5-4477-9f51-3d9f267d50d1\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 923319 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```bash\r\nCOMMITS=\"8744e5a03e84eb407a861cd36fc30c2c5367169a 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f db9ec4d4e74a6286b3de713b47398013837c7749 e4bb647a1614bd9e6718f80a83d9fe998eb48f5f 36613ec98299411950520dd6361a96786607ed08 82cd3e294f3100d8f705d63135508e018efcb80f 114fef0f348b9a4d76b826585fd737886c87a6f1 ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd\"; \\\r\nSTOP=923319; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\n8744e5a03e WORKER_THREADS{1}\r\n042dbfdc3f WORKER_THREADS{2}\r\ndb9ec4d4e7 WORKER_THREADS{3}\r\ne4bb647a16 WORKER_THREADS{4}\r\n36613ec982 WORKER_THREADS{5}\r\n82cd3e294f WORKER_THREADS{6}\r\n114fef0f34 WORKER_THREADS{7}\r\nae1589d7f9 WORKER_THREADS{8}\r\n\r\nreindex-chainstate | 923319 blocks | dbcache 450 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n  Time (abs â‰¡):        17079.999 s               [User: 41791.411 s, System: 2436.225 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n  Time (abs â‰¡):        15860.805 s               [User: 41236.804 s, System: 2345.765 s]\r\n\r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n  Time (abs â‰¡):        15450.583 s               [User: 41354.937 s, System: 2364.782 s]\r\n\r\nBenchmark 4: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n  Time (abs â‰¡):        15319.447 s               [User: 41812.192 s, System: 2357.605 s]\r\n\r\nBenchmark 5: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n  Time (abs â‰¡):        15266.043 s               [User: 42357.261 s, System: 2514.361 s]\r\n\r\nBenchmark 6: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n  Time (abs â‰¡):        15206.688 s               [User: 42723.482 s, System: 2511.710 s]\r\n\r\nBenchmark 7: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n  Time (abs â‰¡):        15241.462 s               [User: 43303.245 s, System: 2591.484 s]\r\n\r\nBenchmark 8: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n  Time (abs â‰¡):        15234.312 s               [User: 43964.600 s, System: 2819.547 s]\r\n\r\nRelative speed comparison\r\n        1.12          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n        1.04          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n        1.02          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n        1.01          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=923319 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n```\r\n</details>\r\n\r\n<img width=\"1273\" height=\"911\" alt=\"image\" src=\"https://github.com/user-attachments/assets/2a05ed7f-fdc3-4373-9853-a04c18faf5fb\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 700000 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n```bash\r\nCOMMITS=\"8744e5a03e84eb407a861cd36fc30c2c5367169a 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f db9ec4d4e74a6286b3de713b47398013837c7749 e4bb647a1614bd9e6718f80a83d9fe998eb48f5f 36613ec98299411950520dd6361a96786607ed08 82cd3e294f3100d8f705d63135508e018efcb80f 114fef0f348b9a4d76b826585fd737886c87a6f1 ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd\"; \\\r\nSTOP=700000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\n8744e5a03e WORKER_THREADS{1}\r\n042dbfdc3f WORKER_THREADS{2}\r\ndb9ec4d4e7 WORKER_THREADS{3}\r\ne4bb647a16 WORKER_THREADS{4}\r\n36613ec982 WORKER_THREADS{5}\r\n82cd3e294f WORKER_THREADS{6}\r\n114fef0f34 WORKER_THREADS{7}\r\nae1589d7f9 WORKER_THREADS{8}\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n  Time (abs â‰¡):        18390.604 s               [User: 16855.672 s, System: 1349.628 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n  Time (abs â‰¡):        17781.743 s               [User: 17041.495 s, System: 1368.022 s]\r\n\r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n  Time (abs â‰¡):        17337.544 s               [User: 17490.866 s, System: 1413.850 s]\r\n\r\nBenchmark 4: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n  Time (abs â‰¡):        17775.681 s               [User: 17832.946 s, System: 1436.415 s]\r\n\r\nBenchmark 5: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n  Time (abs â‰¡):        17699.749 s               [User: 18151.899 s, System: 1476.080 s]\r\n\r\nBenchmark 6: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n  Time (abs â‰¡):        17115.228 s               [User: 18467.571 s, System: 1506.336 s]\r\n\r\nBenchmark 7: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n  Time (abs â‰¡):        17546.582 s               [User: 18532.849 s, System: 1551.217 s]\r\n\r\nBenchmark 8: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n  Time (abs â‰¡):        17452.997 s               [User: 18550.132 s, System: 1546.017 s]\r\n\r\nRelative speed comparison\r\n        1.07          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n        1.04          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n        1.01          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n        1.04          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n        1.02          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n```\r\n</details>\r\n\r\nEdit:\r\n\r\n<img width=\"1272\" height=\"912\" alt=\"image\" src=\"https://github.com/user-attachments/assets/29e79143-7ed0-4a32-9fca-3dae4548fd08\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 700000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD</summary>\r\n\r\n```\r\nCOMMITS=\"9a29b2d331eed5b4cbd6922f63e397b68ff12447 8744e5a03e84eb407a861cd36fc30c2c5367169a 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f db9ec4d4e74a6286b3de713b47398013837c7749 e4bb647a1614bd9e6718f80a83d9fe998eb48f5f 36613ec98299411950520dd6361a96786607ed08 82cd3e294f3100d8f705d63135508e018efcb80f 114fef0f348b9a4d76b826585fd737886c87a6f1 ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd\"; \\\r\nSTOP=700000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\n9a29b2d331 Merge bitcoin/bitcoin#33857: doc: Add `x86_64-w64-mingw32ucrt` triplet to `depends/README.md`\r\n8744e5a03e WORKER_THREADS{1}\r\n042dbfdc3f WORKER_THREADS{2}\r\ndb9ec4d4e7 WORKER_THREADS{3}\r\ne4bb647a16 WORKER_THREADS{4}\r\n36613ec982 WORKER_THREADS{5}\r\n82cd3e294f WORKER_THREADS{6}\r\n114fef0f34 WORKER_THREADS{7}\r\nae1589d7f9 WORKER_THREADS{8}\r\n\r\nreindex-chainstate | 700000 blocks | dbcache 450 | rpi5-16-2 | aarch64 | Cortex-A76 | 4 cores | 15Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 9a29b2d331eed5b4cbd6922f63e397b68ff12447)\r\n  Time (abs â‰¡):        17037.553 s               [User: 26114.648 s, System: 2505.015 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n  Time (abs â‰¡):        13967.390 s               [User: 27084.842 s, System: 2533.624 s]\r\n\r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n  Time (abs â‰¡):        13030.059 s               [User: 27638.137 s, System: 2473.673 s]\r\n\r\nBenchmark 4: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n  Time (abs â‰¡):        13077.949 s               [User: 27739.880 s, System: 2496.343 s]\r\n\r\nBenchmark 5: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n  Time (abs â‰¡):        13051.649 s               [User: 27609.668 s, System: 2538.616 s]\r\n\r\nBenchmark 6: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n  Time (abs â‰¡):        13287.758 s               [User: 27771.809 s, System: 2615.043 s]\r\n\r\nBenchmark 7: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n  Time (abs â‰¡):        13308.250 s               [User: 27744.112 s, System: 2646.436 s]\r\n\r\nBenchmark 8: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n  Time (abs â‰¡):        13436.808 s               [User: 27789.127 s, System: 2709.751 s]\r\n\r\nBenchmark 9: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n  Time (abs â‰¡):        13430.790 s               [User: 27676.672 s, System: 2727.739 s]\r\n\r\nRelative speed comparison\r\n        1.31          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 9a29b2d331eed5b4cbd6922f63e397b68ff12447)\r\n        1.07          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n        1.02          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n        1.02          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n        1.03          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=700000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n```\r\n</details>\r\n\r\n\r\nEdit2:\r\n\r\n<img width=\"1264\" height=\"915\" alt=\"image\" src=\"https://github.com/user-attachments/assets/9f0bbaea-e742-48af-9ef6-73ce79bfacdc\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 600000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD</summary>\r\n\r\n```bash\r\nCOMMITS=\"9a29b2d331eed5b4cbd6922f63e397b68ff12447 8744e5a03e84eb407a861cd36fc30c2c5367169a 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f db9ec4d4e74a6286b3de713b47398013837c7749 e4bb647a1614bd9e6718f80a83d9fe998eb48f5f 36613ec98299411950520dd6361a96786607ed08 82cd3e294f3100d8f705d63135508e018efcb80f 114fef0f348b9a4d76b826585fd737886c87a6f1 ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd\"; \\\r\nSTOP=600000; DBCACHE=450; \\\r\nCC=gcc; CXX=g++; \\\r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n(echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\nhyperfine \\\r\n  --sort command \\\r\n  --runs 1 \\\r\n  --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n  --parameter-list COMMIT ${COMMITS// /,} \\\r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n\r\n9a29b2d331 Merge bitcoin/bitcoin#33857: doc: Add `x86_64-w64-mingw32ucrt` triplet to `depends/README.md`\r\n8744e5a03e WORKER_THREADS{1}\r\n042dbfdc3f WORKER_THREADS{2}\r\ndb9ec4d4e7 WORKER_THREADS{3}\r\ne4bb647a16 WORKER_THREADS{4}\r\n36613ec982 WORKER_THREADS{5}\r\n82cd3e294f WORKER_THREADS{6}\r\n114fef0f34 WORKER_THREADS{7}\r\nae1589d7f9 WORKER_THREADS{8}\r\n\r\nreindex-chainstate | 600000 blocks | dbcache 450 | rpi4-8-1 | aarch64 | Cortex-A72 | 4 cores | 7.6Gi RAM | ext4 | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 9a29b2d331eed5b4cbd6922f63e397b68ff12447)\r\n  Time (abs â‰¡):        28988.956 s               [User: 36830.542 s, System: 6768.571 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n  Time (abs â‰¡):        23269.261 s               [User: 38584.449 s, System: 7103.664 s]\r\n\r\nBenchmark 3: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n  Time (abs â‰¡):        21678.210 s               [User: 39240.948 s, System: 7259.279 s]\r\n\r\nBenchmark 4: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n  Time (abs â‰¡):        21506.209 s               [User: 39363.857 s, System: 7569.643 s]\r\n\r\nBenchmark 5: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n  Time (abs â‰¡):        21428.512 s               [User: 39616.150 s, System: 7698.857 s]\r\n\r\nBenchmark 6: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n  Time (abs â‰¡):        21392.758 s               [User: 39653.354 s, System: 8054.084 s]\r\n\r\nBenchmark 7: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n  Time (abs â‰¡):        21395.545 s               [User: 39365.692 s, System: 8235.890 s]\r\n\r\nBenchmark 8: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n  Time (abs â‰¡):        21449.737 s               [User: 39321.387 s, System: 8314.124 s]\r\n\r\nBenchmark 9: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n  Time (abs â‰¡):        21505.684 s               [User: 39558.723 s, System: 8648.682 s]\r\n\r\nRelative speed comparison\r\n        1.36          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 9a29b2d331eed5b4cbd6922f63e397b68ff12447)\r\n        1.09          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 8744e5a03e84eb407a861cd36fc30c2c5367169a)\r\n        1.01          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 042dbfdc3f2c2ea5f04dfa91ac8785a42d493c2f)\r\n        1.01          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = db9ec4d4e74a6286b3de713b47398013837c7749)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = e4bb647a1614bd9e6718f80a83d9fe998eb48f5f)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 36613ec98299411950520dd6361a96786607ed08)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 82cd3e294f3100d8f705d63135508e018efcb80f)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 114fef0f348b9a4d76b826585fd737886c87a6f1)\r\n        1.01          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=600000 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ae1589d7f96ae2e4bdaa86bf16a0006e38b093bd)\r\n```\r\n\r\n</details>\r\n\r\nMy conclusion (given that threads aren't for free) is that 4 threads should suffice for now!\r\n\r\n\r\n### Memory usage\r\n\r\nI've also measured the peak memory usage during reindex-chainstate and unsurprisingly, the additional threads (4 threads * 8MB stack = ~32MB on glibc), reused internal caches (`m_inputs.clear()` does not free the allocated memory capacity so the peak block input size will be helf for the lifetime of the node) result in a measurable memory overhead (>100MB peak extra).\r\nOnce we're close to the finish line, we can discuss whether we should do anything about it (e.g., we could lower the default dbcache size, or try to reduce memory usage in other ways to compensate, or just document the increase).\r\n\r\nThe peak memory of v30 was **744.4 MB** (measured via assumeutxo):\r\n```\r\n    MB\r\n744.4^                            :\r\n     |# :::: :  ::: ::  :::::  ::@:::::   ::::::::@@\r\n     |# : :: :  ::: ::  : ::   ::@:: ::   ::: ::: @\r\n     |#:: :: :  ::: ::  : ::   ::@:: ::   ::: ::: @\r\n     |#:: :: :  ::: ::  : ::   ::@:: :: ::::: ::: @\r\n     |#:: :: :  ::: ::  : ::   ::@:: :: : ::: ::: @\r\n     |#:: :: :  ::: ::  : ::   ::@:: :::: ::: ::: @\r\n     |#:: :: :::::: ::  : ::   ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::: ::::: :: ::::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ ::::::::@@::@::::::::::@::\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ : : : : @ ::@:::: :::::@::\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ : : : : @ ::@:::: :::::@::\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ : : : : @ ::@:::: :::::@::\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ : : : : @ ::@:::: :::::@::\r\n     |#:: ::::: ::::::: : :: : ::@:: :::: ::: ::: @ : : : : @ ::@:::: :::::@::\r\n   0 +----------------------------------------------------------------------->h\r\n     0                                                                   1.603\r\n```\r\nthe peak memory of master is **819.6 MB** (measured via assumeutxo, see https://github.com/bitcoin/bitcoin/pull/31645#issuecomment-3234329502)\r\n```\r\n    MB\r\n819.6^      ##\r\n     | :    #       :      :  :           :\r\n     | :  ::# :::@@:::::::::  :  @:::::: :::::::\r\n     | :  : # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :: : # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :: : # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :: : # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :::: # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :::: # :: @ ::: :: ::  :  @:: ::  :::: :\r\n     | :::: # :: @ ::: :: :::::  @:: ::  :::: :\r\n     | :::: # :: @ ::: :: ::: :::@:: ::  :::: :\r\n     | :::: # :: @ ::: :: ::: :: @:: ::  :::: :\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: :\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: :\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : :::::::::::@::::@::::@:::::::@\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : : : :::::: @::::@::::@:::::::@\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : : : :::::: @::::@::::@:::::::@\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : : : :::::: @::::@::::@:::::::@\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : : : :::::: @::::@::::@:::::::@\r\n     | :::: # :: @ ::: :: ::: :: @:: :: ::::: : : : :::::: @::::@::::@:::::::@\r\n   0 +----------------------------------------------------------------------->h\r\n     0                                                                   1.484\r\n```\r\nand the peak memory after the PR is **944.1MB** (via reindex-chainstate, we can't measure it via assumeutxo):\r\n```\r\n    MB\r\n944.1^                                                         #              \r\n     |                       :@                    @           #              \r\n     |                       :@                    @           #              \r\n     |                       :@                    @      :    #              \r\n     |     :::               :@     :         @    @   :  :  @ #        :     \r\n     |     : :            :  :@     :    @    @    @ :::  :: @ #:       :     \r\n     |     : :         :: : ::@     :   :@   :@    @ :::  :: @ #:: :    :     \r\n     |  :  : :      :  : :: ::@:: : : :::@   :@   @@::::  :: @ #:: :    :     \r\n     |  :  : :::    : :: :: ::@:  :@: : :@ : :@  :@@::::  :::@ #:: ::   : :   \r\n     |  :  : ::::   : :: :::::@:  :@: : :@ : :@  :@@::::  :::@:#:: ::::@: ::  \r\n     |  :  : ::::   :::: :::::@:  :@: : :@ : :@ ::@@::::  :::@:#:: ::::@: ::  \r\n     | ::  : ::::::::::: :::::@: ::@: : :@:: :@ ::@@::::@ :::@:#:: ::::@: ::  \r\n     | ::::: :::::: :::: :::::@: ::@: : :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n     | ::: : :::::: :::: :::::@: ::@::: :@::::@:::@@::::@::::@:#:::::::@::::::\r\n   0 +----------------------------------------------------------------------->h\r\n     0                                                                   95.25\r\n```\r\n[massif-0f3778fbfb03fc9083326e9cf62b3d3293a7f623-921129-450.txt](https://github.com/user-attachments/files/23966106/massif-0f3778fbfb03fc9083326e9cf62b3d3293a7f623-921129-450.txt)\r\n\r\nAlso, now that the whole process is done in half the time, it's also possible that the higher peak memory is mostly a result of different memory-intensive processes coinciding more often.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3617721711",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21406272671,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAT76cyf",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21406272671",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0728edfc5fb0099a22a572cba4934d2d5dbd434d",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0728edfc5fb0099a22a572cba4934d2d5dbd434d",
      "created_at": "2025-12-07T00:25:26Z"
    },
    {
      "event": "labeled",
      "id": 21406718938,
      "node_id": "LE_lADOABII586bT0I_zwAAAAT78Jva",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21406718938",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-07T01:43:40Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3621473275,
      "node_id": "IC_kwDOABII587X20v7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3621473275",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-07T01:43:46Z",
      "updated_at": "2025-12-07T01:43:46Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `TSan`: https://github.com/bitcoin/bitcoin/actions/runs/19996361340/job/57344491981</sub>\n<sub>LLM reason (âœ¨ experimental): ThreadSanitizer data race detected in CCoinsViewCache::FetchCoin during coinsviewcacheasync_tests.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3621473275",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21410736146,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAT8LegS",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21410736146",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "8be628701fbb069cc108f47b16836981d0c3bc14",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/8be628701fbb069cc108f47b16836981d0c3bc14",
      "created_at": "2025-12-07T15:35:38Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21410787890,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAT8LrIy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21410787890",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/227ead11696d73db24834f612eb3e0b55a8fc62e",
      "created_at": "2025-12-07T15:47:16Z"
    },
    {
      "event": "unlabeled",
      "id": 21411230384,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAT8NXKw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21411230384",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-07T17:04:54Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "subscribed",
      "id": 21451076782,
      "node_id": "SE_lADOABII586bT0I_zwAAAAT-lXSu",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21451076782",
      "actor": {
        "login": "djpnewton",
        "id": 42459,
        "node_id": "MDQ6VXNlcjQyNDU5",
        "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/djpnewton",
        "html_url": "https://github.com/djpnewton",
        "followers_url": "https://api.github.com/users/djpnewton/followers",
        "following_url": "https://api.github.com/users/djpnewton/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/djpnewton/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/djpnewton/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
        "organizations_url": "https://api.github.com/users/djpnewton/orgs",
        "repos_url": "https://api.github.com/users/djpnewton/repos",
        "events_url": "https://api.github.com/users/djpnewton/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/djpnewton/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-09T11:32:08Z"
    },
    {
      "event": "labeled",
      "id": 21491619582,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUBABb-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21491619582",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T00:23:06Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21492604065,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUBDxyh",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21492604065",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "64336a1da186444af35ff2cd6408fb319db1dba6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/64336a1da186444af35ff2cd6408fb319db1dba6",
      "created_at": "2025-12-11T01:51:35Z"
    },
    {
      "event": "unlabeled",
      "id": 21493094963,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUBFpoz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21493094963",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T02:33:35Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3642714851,
      "node_id": "IC_kwDOABII587ZH2rj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3642714851",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T16:21:45Z",
      "updated_at": "2025-12-11T16:21:45Z",
      "author_association": "CONTRIBUTOR",
      "body": "> For now the async view uses a fixed worker thread count of 4. The workload is primarily I/O-bound on DB latency rather than CPU-bound, so 4 workers already hide most of the latency and it simplifies the implementation. If needed we can make this configurable or tie it to -par later.\r\n\r\nProbably makes sense to benchmark this kind of change in a cloud environment as well. There you'll likely see fixed, higher latency but more consistent as you push more IOPS, which I anticipate might result in substantially different results/optimal thread counts compared to physically attached flash.",
      "user": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3642714851",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3644102756,
      "node_id": "IC_kwDOABII587ZNJhk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3644102756",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T22:45:27Z",
      "updated_at": "2025-12-11T22:58:10Z",
      "author_association": "CONTRIBUTOR",
      "body": "I've rebased due to https://github.com/bitcoin/bitcoin/pull/33602, and added several touchups. Thank you @l0rinc for the suggestions!\r\n\r\nThank you also @l0rinc for your very thorough measurements. I think 4 threads is a decent choice for now, but as @TheBlueMatt suggests I will try and run benchmarks in a cloud environment with network connected storage.\r\n\r\nI would like to reproduce the memory findings, but https://github.com/bitcoin/bitcoin/issues/33351 makes it a little difficult to determine exact numbers. I think running an IBD on each branch and confirming the max RSS would be a better indicator than running an assumeutxo load.\r\n\r\n> the additional threads (4 threads * 8MB stack = ~32MB on glibc), reused internal caches (m_inputs.clear() does not free the allocated memory capacity so the peak block input size will be helf for the lifetime of the node) result in a measurable memory overhead (>100MB peak extra).\r\n\r\nI am skeptical about this claim. An `InputToFetch` is 72 bytes, plus 8 bytes per txid stored. Let's be generous and round up to 100 bytes per input. The theoretical maximum number of inputs in a block is 1MB / 41 bytes = ~24.3k, let's say 30k. Let's be generous and double that to 60k because vectors will double capacity when reaching the limit. That's 100 bytes * 60k = 6 MB. That plus the 32MB for the thread stacks is only 38MB. Where does the extra memory come from? Or am I not accounting for something big in my math here?\r\nEdit: Actually, double that since we also have the `cacheCoins` not being reallocated. So that would still only be a maximum of 12 MB (in reality much less) on top of the 32 MB.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3644102756",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 21515332966,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAUCae1m",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21515332966",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T22:45:29Z"
    },
    {
      "event": "subscribed",
      "id": 21515332986,
      "node_id": "SE_lADOABII586bT0I_zwAAAAUCae16",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21515332986",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T22:45:29Z"
    },
    {
      "event": "mentioned",
      "id": 21515333010,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAUCae2S",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21515333010",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T22:45:29Z"
    },
    {
      "event": "subscribed",
      "id": 21515333025,
      "node_id": "SE_lADOABII586bT0I_zwAAAAUCae2h",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21515333025",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-11T22:45:29Z"
    },
    {
      "event": "commented",
      "id": 3646563048,
      "node_id": "IC_kwDOABII587ZWiLo",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3646563048",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-12T13:50:39Z",
      "updated_at": "2025-12-12T13:50:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "As mentioned [on IRC](https://bitcoin-irc.chaincode.com/bitcoin-core-dev/2025-12-11#1178515;) yesterday:\r\n> We also observed that on the 16 GB system, runs with -dbcache values of 4 GB and higher were a lot slower than with -dbcache of 3 GB, and that an rpi5 with 16 GB of memory ran out of memory with -dbcache of 10 GB`.\r\n\r\nMy assumption was that it's caused by the UTXO size getting closer to the total memory, so I ran it on the i9 and i7 servers - both of which have 64 GB memory:\r\n\r\n<img width=\"1490\" height=\"873\" alt=\"image\" src=\"https://github.com/user-attachments/assets/be18a827-bbeb-4031-b0cc-79f30aa37d45\" />\r\n\r\n<details>\r\n<summary>reindex-chainstate | 900000 blocks | dbcache 100-7000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD</summary>\r\n\r\n```\r\nfor DBCACHE in 100 200 300 400 500 1000 2000 3000 4000 5000 6000 7000; do \\\r\n    COMMITS=\"f6acbef1084e34f126bf530df99e4ef6a11c38e8 eee2204d6f7117c5b39abaf47d7d329ff0951638\"; \\\r\n    STOP=900000; \\\r\n    CC=gcc; CXX=g++; \\\r\n    BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n    (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\n    hyperfine \\\r\n      --sort command \\\r\n      --runs 1 \\\r\n      --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n      --parameter-list COMMIT ${COMMITS// /,} \\\r\n      --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n        ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n      --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n                  cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n      \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\ndone\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 100 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        23016.826 s               [User: 40886.840 s, System: 2758.769 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        15579.671 s               [User: 39232.678 s, System: 2491.046 s]\r\n\r\nRelative speed comparison\r\n        1.48          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 200 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        21436.283 s               [User: 37890.294 s, System: 2736.881 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        14707.903 s               [User: 35945.513 s, System: 2246.392 s]\r\n\r\nRelative speed comparison\r\n        1.46          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 300 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        20189.990 s               [User: 35193.471 s, System: 2875.028 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        14072.230 s               [User: 33903.334 s, System: 2159.474 s]\r\n\r\nRelative speed comparison\r\n        1.43          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 400 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        19874.210 s               [User: 33637.992 s, System: 2759.377 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        14185.335 s               [User: 32711.873 s, System: 2197.601 s]\r\n\r\nRelative speed comparison\r\n        1.40          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 500 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        19176.938 s               [User: 31471.188 s, System: 2511.966 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        13856.071 s               [User: 31289.683 s, System: 2210.229 s]\r\n\r\nRelative speed comparison\r\n        1.38          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 1000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=1000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        17434.420 s               [User: 25518.649 s, System: 1736.314 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=1000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        13178.801 s               [User: 26366.210 s, System: 1707.001 s]\r\n\r\nRelative speed comparison\r\n        1.32          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=1000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=1000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 2000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=2000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        16285.543 s               [User: 20987.530 s, System: 1073.606 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=2000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        12830.954 s               [User: 22300.342 s, System: 1206.297 s]\r\n\r\nRelative speed comparison\r\n        1.27          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=2000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=2000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 3000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        15768.416 s               [User: 19226.843 s, System: 863.531 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        12788.084 s               [User: 20314.162 s, System: 965.156 s]\r\n\r\nRelative speed comparison\r\n        1.23          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 4000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=4000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        15685.029 s               [User: 18706.301 s, System: 811.667 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=4000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        12892.918 s               [User: 19746.475 s, System: 903.910 s]\r\n\r\nRelative speed comparison\r\n        1.22          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=4000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=4000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 5000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=5000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        15478.130 s               [User: 18161.854 s, System: 764.612 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=5000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        12924.056 s               [User: 19084.441 s, System: 852.527 s]\r\n\r\nRelative speed comparison\r\n        1.20          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=5000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=5000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 6000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=6000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        15563.687 s               [User: 17939.937 s, System: 754.868 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=6000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        13059.707 s               [User: 18685.622 s, System: 808.353 s]\r\n\r\nRelative speed comparison\r\n        1.19          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=6000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=6000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 7000 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=7000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        15630.441 s               [User: 17853.930 s, System: 776.871 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=7000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        13210.208 s               [User: 18681.925 s, System: 822.040 s]\r\n\r\nRelative speed comparison\r\n        1.18          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=7000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=7000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n```\r\n\r\n\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>reindex-chainstate | 900000 blocks | dbcache 100-500 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD</summary>\r\n\r\n\r\n```\r\nfor DBCACHE in 100 200 300 400 500; do \\\r\n    COMMITS=\"f6acbef1084e34f126bf530df99e4ef6a11c38e8 eee2204d6f7117c5b39abaf47d7d329ff0951638\"; \\\r\n    STOP=900000; \\\r\n    CC=gcc; CXX=g++; \\\r\n    BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n    (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n    (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\\r\n    hyperfine \\\r\n      --sort command \\\r\n      --runs 1 \\\r\n      --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n      --parameter-list COMMIT ${COMMITS// /,} \\\r\n      --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git checkout {COMMIT}; git clean -fxd; git reset --hard && \\\r\n        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=RelWithDebInfo -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n        ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20\" \\\r\n      --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n                  cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n      \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\ndone\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 100 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        44039.358 s               [User: 40502.406 s, System: 3048.444 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        34822.469 s               [User: 43549.781 s, System: 2913.842 s]\r\n\r\nRelative speed comparison\r\n        1.26          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=100 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 200 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        43276.275 s               [User: 37875.550 s, System: 3095.389 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        33394.767 s               [User: 39767.262 s, System: 2773.980 s]\r\n\r\nRelative speed comparison\r\n        1.30          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=200 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 300 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        53339.879 s               [User: 37057.843 s, System: 3635.662 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        39372.213 s               [User: 37610.647 s, System: 2897.763 s]\r\n\r\nRelative speed comparison\r\n        1.35          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=300 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 400 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        41460.250 s               [User: 33577.389 s, System: 3144.309 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        33277.494 s               [User: 35893.949 s, System: 2803.631 s]\r\n\r\nRelative speed comparison\r\n        1.25          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=400 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n\r\nf6acbef108 Merge bitcoin/bitcoin#33764: ci: Add Windows + UCRT jobs for cross-compiling and native testing\r\neee2204d6f validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\nreindex-chainstate | 900000 blocks | dbcache 500 | i7-hdd | x86_64 | Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz | 8 cores | 62Gi RAM | ext4 | HDD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n  Time (abs â‰¡):        39183.661 s               [User: 31615.517 s, System: 2853.531 s]\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n  Time (abs â‰¡):        32531.387 s               [User: 33908.272 s, System: 2720.594 s]\r\n\r\nRelative speed comparison\r\n        1.20          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = f6acbef1084e34f126bf530df99e4ef6a11c38e8)\r\n        1.00          COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=900000 -dbcache=500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = eee2204d6f7117c5b39abaf47d7d329ff0951638)\r\n```\r\n\r\n</details>\r\n\r\nMy conclusion from the above are:\r\n* It's not the size of the UTXO set vs total memory; \r\n* This change performs better the lower the memory (we knew this already);\r\n* after 3 GB of dbcache there isn't any measurable speedup for some reason - with the PR it even gets slightly slower;\r\n* `master` seems to behave similarly to the PR in this regard;\r\n* `HDD` isn't very stable, but the `SSD` is ridiculously predictable;\r\n* `PR` performs better with `100 mb` dbcache than `master` with `7 GB`;\r\n* `PR` performs exactly the same with `1 GB` and `7 GB`.\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3646563048",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3647697081,
      "node_id": "IC_kwDOABII587Za3C5",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3647697081",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-12T18:41:55Z",
      "updated_at": "2025-12-12T18:41:55Z",
      "author_association": "CONTRIBUTOR",
      "body": "> `PR` performs better with `100 mb` dbcache than `master` with `7 GB`;\r\n\r\nwat",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3647697081",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21685856538,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUMk-ka",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21685856538",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "created_at": "2025-12-20T17:48:03Z"
    },
    {
      "event": "reviewed",
      "id": 3601666630,
      "node_id": "PRR_kwDOABII587WrRJG",
      "url": null,
      "actor": null,
      "commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-21T13:56:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "I went through the changes quickly, planning on recreating everything locally to understand the constraints more fundamentally.\r\n\r\nI want to investigate a few more issues before I can do that (e.g. virtual dispatch cost on critical path, how removing `noexcept` and simpler `siphash` changes would affect the constraints, whether we can clean up the coins area a bit more before we proceed).\r\n\r\nTo reduce risk (since this is at the heart of the project), I want to continue carving our cleanup PR that would derisk and simplify this one.\r\nAppreciate your patience and quick reaction time here.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3601666630",
      "submitted_at": "2025-12-21T13:56:40Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 3678847806,
      "node_id": "IC_kwDOABII587bRsM-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3678847806",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-21T14:32:40Z",
      "updated_at": "2025-12-22T15:13:37Z",
      "author_association": "CONTRIBUTOR",
      "body": "Did some benchmarks for cloud connected storage in AWS.\r\n\r\nI used 2 `c6in.xlarge` instances (4 vCPU, 8 GB RAM) with 800 GB `gp3` volumes attached. The volumes were configured with 12500 IOPS and 391 MB/s throughput, which is the baseline for that instance type. The instance type was chosen because it had the highest baseline EBS throughput for that size class.\r\n\r\nI ran a reindex-chainstate up to block 921129 with this branch and master, and this branch was ~2.6x faster. 12h43m vs 33h20m.\r\n\r\nbranch:\r\n`39139.06user 4836.53system 12:42:43elapsed 96%CPU (0avgtext+0avgdata 6748912maxresident)k\r\n25383964712inputs+5043205272outputs (140197459major+76837294minor)pagefaults 0swaps`\r\n\r\nmaster:\r\n`34586.03user 4147.82system 33:19:56elapsed 32%CPU (0avgtext+0avgdata 6931572maxresident)k\r\n25758328464inputs+5040510928outputs (137873360major+81380971minor)pagefaults 0swaps`\r\n\r\nOn network connected storage, master is completely dominated by the serial latency of fetching inputs one by one. It can't push past around 140 MB/s read throughput, so didn't get close to maxing out disk usage. This branch easily hits the volume limits with 4 threads, by parallelizing this latency. After it completed, I ran it again but bumped the `gp3` volume throughput limit to 1000 MB/s. It managed over 500 MB/s and completed in 10h01m - a ~3.3x speedup over master. Both the second run and master completed at almost the exact same time coincidentally, which you can see in the graph below.\r\n\r\n<img width=\"2720\" height=\"593\" alt=\"Screenshot from 2025-12-20 23-17-52\" src=\"https://github.com/user-attachments/assets/06c771b9-dbef-409a-9870-0647d39986c0\" />\r\n\r\nAfter I tested running with 8 and 12 threads, with both volumes bumped to 1000 MB/s. The 12 thread variant managed to get limited by the throughput limit, but not the 8. However, after 3 hours of bursting above the baseline, they both got throttled back. These finished in 10h04m and 8h51m - 3.3x and ~3.8x speedups respectively. So they are not too much faster with this instance type. But with a bigger instance with higher EBS baseline and `gp3` settings to get more read throughput, they could be much faster.\r\n\r\nSo it might make sense if you have a lot of sustained read throughput available to bump to a lot more threads.\r\n@TheBlueMatt \r\n\r\nThe below graph shows this branch but with 12 worker threads (called master in the graph) and 8 worker threads (called branch in the graph). After 3 hours of bursting above baseline they get throttled back to ~390 MB/s.\r\n<img width=\"2720\" height=\"593\" alt=\"Screenshot from 2025-12-21 09-27-01\" src=\"https://github.com/user-attachments/assets/ce9f24d2-d416-44bd-99d7-41921a869928\" />\r\n\r\nAlso, the max RSS reported by `/usr/bin/time` from the output above shows that master actually has a higher max RSS of 6931572k vs 6748912k. That would imply that the RSS is 6.9 GB vs 6.7 GB though, which doesn't really make sense to me. Both were using default `dbcache`, so I'm not entirely sure how these values are computed. However, it seems like there is less memory pressure in this branch than master.\r\n@l0rinc ",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3678847806",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 21690525538,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAUM2ydi",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21690525538",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-21T14:32:42Z"
    },
    {
      "event": "subscribed",
      "id": 21690525548,
      "node_id": "SE_lADOABII586bT0I_zwAAAAUM2yds",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21690525548",
      "actor": {
        "login": "TheBlueMatt",
        "id": 649246,
        "node_id": "MDQ6VXNlcjY0OTI0Ng==",
        "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/TheBlueMatt",
        "html_url": "https://github.com/TheBlueMatt",
        "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
        "following_url": "https://api.github.com/users/TheBlueMatt/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/TheBlueMatt/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/TheBlueMatt/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
        "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
        "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
        "events_url": "https://api.github.com/users/TheBlueMatt/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-21T14:32:42Z"
    },
    {
      "event": "mentioned",
      "id": 21690525556,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAUM2yd0",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21690525556",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-21T14:32:42Z"
    },
    {
      "event": "subscribed",
      "id": 21690525562,
      "node_id": "SE_lADOABII586bT0I_zwAAAAUM2yd6",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21690525562",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-21T14:32:42Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21690681911,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUM3Yo3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21690681911",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "created_at": "2025-12-21T15:09:57Z"
    },
    {
      "event": "renamed",
      "id": 21696333588,
      "node_id": "RTE_lADOABII586bT0I_zwAAAAUNM8cU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21696333588",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-22T04:39:07Z",
      "rename": {
        "from": "validation: fetch block inputs on parallel threads >40% faster IBD",
        "to": "validation: fetch block inputs on parallel threads 3x faster IBD"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21716707723,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUOaqmL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21716707723",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "1c5c5b2057f593f83929ee51df14897f9de175b1",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/1c5c5b2057f593f83929ee51df14897f9de175b1",
      "created_at": "2025-12-23T02:56:31Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21716785133,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUOa9ft",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21716785133",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "074f5d4d5bace4104e17a3cdfbe8ef816e5adfa5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/074f5d4d5bace4104e17a3cdfbe8ef816e5adfa5",
      "created_at": "2025-12-23T03:05:46Z"
    },
    {
      "event": "labeled",
      "id": 21716794373,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUOa_wF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21716794373",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-23T03:06:41Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3684903405,
      "node_id": "IC_kwDOABII587boynt",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3684903405",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-23T03:06:48Z",
      "updated_at": "2025-12-23T03:06:48Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `test max 6 ancestor commits`: https://github.com/bitcoin/bitcoin/actions/runs/20450003058/job/58760941958</sub>\n<sub>LLM reason (âœ¨ experimental): Compilation error: parameter 'base' shadows inherited member in CoinsViewCacheAsync, causing CI failure.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3684903405",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21717039274,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUOb7iq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21717039274",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "349515b50dd26a93c4ea16fdfdf0f4b37f484a60",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/349515b50dd26a93c4ea16fdfdf0f4b37f484a60",
      "created_at": "2025-12-23T03:37:39Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21717861354,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUOfEPq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21717861354",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "c465be604b11a96bbe0a78711e206a6e0c262c7f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/c465be604b11a96bbe0a78711e206a6e0c262c7f",
      "created_at": "2025-12-23T05:11:36Z"
    },
    {
      "event": "unlabeled",
      "id": 21719317932,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUOkn2s",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21719317932",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-23T06:53:36Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21760473491,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURBnmT",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21760473491",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "7114bafa6dd321d63fce8467471c036487f95cc5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/7114bafa6dd321d63fce8467471c036487f95cc5",
      "created_at": "2025-12-26T16:33:10Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21760518249,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURByhp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21760518249",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ee2a41a79a15a6d1a51111a906b4883face2f333",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ee2a41a79a15a6d1a51111a906b4883face2f333",
      "created_at": "2025-12-26T16:40:54Z"
    },
    {
      "event": "labeled",
      "id": 21760523637,
      "node_id": "LE_lADOABII586bT0I_zwAAAAURBz11",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21760523637",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T16:41:42Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3693093908,
      "node_id": "IC_kwDOABII587cICQU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3693093908",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T16:41:53Z",
      "updated_at": "2025-12-26T16:41:53Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `lint`: https://github.com/bitcoin/bitcoin/actions/runs/20525757781/job/58968699149</sub>\n<sub>LLM reason (âœ¨ experimental): Lint failure due to trailing whitespace in src/test/fuzz/coinscache_sim.cpp:59.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3693093908",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21760575271,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURCAcn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21760575271",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "24045106e0abd8875891c1a99936893931122151",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/24045106e0abd8875891c1a99936893931122151",
      "created_at": "2025-12-26T16:50:44Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21760655837,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURCUHd",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21760655837",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "created_at": "2025-12-26T17:04:32Z"
    },
    {
      "event": "unlabeled",
      "id": 21761195809,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUREX8h",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21761195809",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T18:36:48Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3693324607,
      "node_id": "IC_kwDOABII587cI6k_",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3693324607",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T20:19:17Z",
      "updated_at": "2025-12-26T20:19:38Z",
      "author_association": "CONTRIBUTOR",
      "body": "Thank you again @l0rinc for your review. I've taken most of your suggestions. `Reset()` is now on the base `CCoinsViewCache` class and `GetPossiblySpentCoinFromCache` has been replaced with a protected `FetchCoinWithoutMutating`.\r\n\r\nI've removed the new fuzz harness and instead integrated the `CoinsViewCacheAsync` to our `coins_view` and `coinscache_sim` fuzz targets. So, we can fuzz them as we would a `CCoinsViewCache` and make sure the new subclass behaves the same as before. I have been fuzzing the three new targets for a while now.\r\n\r\n> virtual dispatch cost on critical path\r\n\r\nI don't see why this needs investigating. Both our benchmarks show large speedups along the critical path, so even if there is a minor increased cost here it is a net benefit.\r\n\r\n> how removing `noexcept` and simpler `siphash` changes would affect the constraints\r\n\r\nThese seem like good ideas to investigate, but I don't see how they are applicable to the change proposed here. Can you elaborate?\r\n\r\n> whether we can clean up the coins area a bit more before we proceed\r\n\r\nThat is a worthy goal. I have refactored to make the changes to coins more straightforward.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3693324607",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "mentioned",
      "id": 21761767700,
      "node_id": "MEE_lADOABII586bT0I_zwAAAAURGjkU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21761767700",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T20:19:18Z"
    },
    {
      "event": "subscribed",
      "id": 21761767705,
      "node_id": "SE_lADOABII586bT0I_zwAAAAURGjkZ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21761767705",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-26T20:19:18Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21770619562,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURoUqq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21770619562",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "360ad88e509feb6f0ee1e8180a9d813be801d3a3",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/360ad88e509feb6f0ee1e8180a9d813be801d3a3",
      "created_at": "2025-12-28T16:41:02Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21770699035,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAURooEb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21770699035",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/0827d5d363d68f38feff89124347e9914de83cfa",
      "created_at": "2025-12-28T17:03:39Z"
    },
    {
      "event": "labeled",
      "id": 21770701357,
      "node_id": "LE_lADOABII586bT0I_zwAAAAURooot",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21770701357",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-28T17:04:13Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unsubscribed",
      "id": 21770710961,
      "node_id": "UE_lADOABII586bT0I_zwAAAAURoq-x",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21770710961",
      "actor": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-28T17:06:41Z"
    },
    {
      "event": "reviewed",
      "id": 3610779003,
      "node_id": "PRR_kwDOABII587XOB17",
      "url": null,
      "actor": null,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2025-12-28T18:01:20Z",
      "author_association": "CONTRIBUTOR",
      "body": "While I was reviewing it you have pushed two new versions, so let me add my half-baked comments in the meantime.\r\nI'm also experimenting with adding the features in smaller steps in https://github.com/l0rinc/bitcoin/pull/79/commits - a separate resetable and reusable cache (applied to other temp places as well), introducing a single-threaded fetcher at first, changing it to newly created threads in the next, optimizing it via a barrier-guarded thread pool in a follow-up. It's definitely not done yet, but want to make sure we have progress, would appreciate if you could take a look and see what we can use here from the ideas. I think we should be able to extract the cache reuse commit to a dedicated PR.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3610779003",
      "submitted_at": "2025-12-28T18:01:20Z",
      "state": "COMMENTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "commented",
      "id": 3701651141,
      "node_id": "IC_kwDOABII587corbF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3701651141",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2025-12-31T07:49:36Z",
      "updated_at": "2026-01-08T15:26:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "Now that I have access to a Windows benchmarking server, managed to run a few rounds of `reindex-chainstate` with default 450 dbcache until tip.\r\n\r\nEdit: previously posted some measurements for the PR, turns out Windows disagreed and didn't actually check out the new commit (had some chmod leftovers) so I was measuring just variance.\r\n\r\nEdit2: reran the PR separately, seems we maintain the speedup we were hoping for:\r\n\r\n<img width=\"1448\" height=\"845\" alt=\"image\" src=\"https://github.com/user-attachments/assets/8f189bf8-1d67-4e9d-a163-aa5a3958e848\" />\r\n\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```\r\n for DBCACHE in 450; do \\\r\n>   COMMITS=\"7f295e1d9b44c225c823242c1f04239f46fb27a6 0827d5d363d68f38feff89124347e9914de83cfa\"; \\\r\n>   STOP=927719; \\\r\n>   BASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n>   (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n>   (echo \"\" && echo \"reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | SSD\"; echo \"\") &&\\\r\nerfine \\>   hyperfine \\\r\nort comm>     --sort command \\\r\n  --runs>     --runs 2 \\\r\n>     --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\\r\n>     --parameter-list COMMIT ${COMMITS// /,} \\\r\n>     --prepare \"killall -9 bitcoind 2>/dev/null; rm -f $DATA_DIR/debug.log; git clean -fxd; git reset --hard {COMMIT} && \\\r\ne -B bu>       cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_IPC=OFF && ninja -C build bitcoind -j2 && \\\r\n>       ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20; rm -f $DATA_DIR/debug.log\" \\\r\n>     --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log; \\\r\n        >                 cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\\r\n>     \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\";\r\n> done\r\n\r\n0827d5d363 validation: fetch inputs on parallel threads\r\n\r\nreindex-chainstate | 927719 blocks | dbcache 450 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | SSD\r\n\r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=927719 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 7f295e1d9b44c225c823242c1f04239f46fb27a6)\r\n  Time (mean Â± Ïƒ):     119997.373 s Â± 2661.660 s    [User: 85751.035 s, System: 34713.420 s]\r\n  Range (min â€¦ max):   118115.295 s â€¦ 121879.451 s    2 runs\r\n\r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/BitcoinData -stopatheight=927719 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 0827d5d363d68f38feff89124347e9914de83cfa)\r\n  Time (mean Â± Ïƒ):     48412.140 s Â± 1510.148 s    [User: 86485.276 s, System: 21483.316 s]\r\n  Range (min â€¦ max):   47344.305 s â€¦ 49479.976 s    2 runs\r\n```\r\n\r\n</details>\r\n\r\n-----\r\n\r\n\r\nedit: tried native executable with clang, I couldn't reproduce any speedup vs master that way. Couldn't yet make gcc work.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3701651141",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "unlabeled",
      "id": 21820561201,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUUm1cx",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21820561201",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-01T19:23:43Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3705146309,
      "node_id": "IC_kwDOABII587c2AvF",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3705146309",
      "actor": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-02T11:37:09Z",
      "updated_at": "2026-01-02T11:37:09Z",
      "author_association": "MEMBER",
      "body": "> Now that I have access to a Windows benchmarking server, managed to run a few rounds\r\n\r\nIt looks like this is run inside WSL (Linux) and compiled for Linux. I wonder if this is meaningful of real end-user performance, which normally run native Windows (.exe) binaries?",
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3705146309",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 21834023268,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUVaMFk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21834023268",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-03T02:53:59Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21836506034,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUVjqOy",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21836506034",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "dbeb0b4da48e0a5b881e68b16aed5c2b63884009",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/dbeb0b4da48e0a5b881e68b16aed5c2b63884009",
      "created_at": "2026-01-03T15:30:02Z"
    },
    {
      "event": "unlabeled",
      "id": 21836516857,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUVjs35",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21836516857",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-03T15:32:54Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21837537792,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUVnmIA",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21837537792",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "ea7462345babb995bad2a950e9896a2ea076e1f5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/ea7462345babb995bad2a950e9896a2ea076e1f5",
      "created_at": "2026-01-03T18:58:44Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21837553172,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUVnp4U",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21837553172",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "60cfa5d6df0f8505b0ebe144390c874c7ce0b7fd",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/60cfa5d6df0f8505b0ebe144390c874c7ce0b7fd",
      "created_at": "2026-01-03T19:02:11Z"
    },
    {
      "event": "labeled",
      "id": 21837555632,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUVnqew",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21837555632",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-03T19:02:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21837714971,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUVoRYb",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21837714971",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b5aa0175518910e26d1089d94c1e757d2d525513",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b5aa0175518910e26d1089d94c1e757d2d525513",
      "created_at": "2026-01-03T19:35:13Z"
    },
    {
      "event": "unlabeled",
      "id": 21838087316,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUVpsSU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21838087316",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-03T21:19:41Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3707366174,
      "node_id": "IC_kwDOABII587c-ese",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3707366174",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-03T21:22:38Z",
      "updated_at": "2026-01-03T22:23:43Z",
      "author_association": "CONTRIBUTOR",
      "body": "Measured the performance at tip. This branch is ~64% faster connecting newly seen blocks than master.\r\n\r\n| | Node 1 | Node 2 | Average |\r\n|-|-|-|-|\r\n| master | [273.80ms/blk](https://gist.github.com/andrewtoth/8fd74aa217fde63cbd65a79e2f52370c) | [319.19ms/blk](https://gist.github.com/andrewtoth/49390ccd2739c2f98a886f4b99cebda5) | 296.50ms/blk |\r\n| branch | [179.89ms/blk](https://gist.github.com/andrewtoth/4d3e134efb184d0d90c5535581bf73d5) | [181.45ms/blk](https://gist.github.com/andrewtoth/73b2173a493cfd19407b27a725a8b1c9) | 180.67ms/blk |\r\n\r\nI ran 5 `t3.small` AWS instances with 20 GB `gp2` EBS volumes attached. I ran all nodes pruned to 550, with the exact same `blocks`, `chainstate`, and `mempool.dat` uploaded to them. I ran 2 nodes at master, and 2 nodes at this branch. These 4 nodes only connected to the 5th node, which itself connected to a trusted node outside the VPC. Using `debug=bench`, we can see the cumulative block connection speed in the debug logs. These are linked in the table above.\r\n\r\nEdit: There was a network outage with the gateway node for 12 hours, and on connection all nodes caught up. This skews results. Restarted the nodes and will get more data.",
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3707366174",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21844448937,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUWB9ap",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21844448937",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "dc06842930c7cacc1b582f96477d124408664b2c",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/dc06842930c7cacc1b582f96477d124408664b2c",
      "created_at": "2026-01-05T01:07:24Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21844657847,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUWCwa3",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21844657847",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "created_at": "2026-01-05T01:36:31Z"
    },
    {
      "event": "labeled",
      "id": 21844662565,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUWCxkl",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21844662565",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-05T01:37:12Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 21845440240,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUWFvbw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21845440240",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-05T03:18:11Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21954213992,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUckrho",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21954213992",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "created_at": "2026-01-09T19:13:32Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 21973544816,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUdua9w",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/21973544816",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "created_at": "2026-01-11T18:13:55Z"
    },
    {
      "event": "reviewed",
      "id": 3648380425,
      "node_id": "PRR_kwDOABII587Zdd4J",
      "url": null,
      "actor": null,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "commit_url": null,
      "created_at": null,
      "updated_at": "2026-01-11T20:26:37Z",
      "author_association": "CONTRIBUTOR",
      "body": "I like the new cleanup changes and the ASCII art, I only had time and patience to quickly go over it, hope the comments are useful.",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3648380425",
      "submitted_at": "2026-01-11T20:26:37Z",
      "state": "CHANGES_REQUESTED",
      "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22051407664,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUiXccw",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22051407664",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "created_at": "2026-01-14T19:18:06Z"
    },
    {
      "event": "commented",
      "id": 3767758819,
      "node_id": "IC_kwDOABII587gk2_j",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3767758819",
      "actor": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-19T11:05:57Z",
      "updated_at": "2026-01-22T10:10:29Z",
      "author_association": "CONTRIBUTOR",
      "body": "> It looks like this is run inside WSL (Linux) and compiled for Linux\r\n\r\nTook me longer than anticipated, but we finally have our first native GCC Windows measurement - after a few failed previous attempts using `clang` or older `gcc` versions.\r\n\r\n<img width=\"2148\" height=\"1400\" alt=\"image\" src=\"https://github.com/user-attachments/assets/f699bc10-fd34-486c-80a6-582007f33288\" />\r\n\r\nResults: **29%** faster with `dbcache=450`, **14.5%** faster with `dbcache=4500` (**932239** blocks, native .exe, MinGW GCC 15.2.0)\r\n\r\n<details>\r\n<summary>2026-01-17 | reindex-chainstate | 932239 blocks | dbcache 450 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15</summary>\r\n\r\n```bash\r\nfor DBCACHE in 450 4500; do \\\r\n  COMMITS=\"ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb b3cb5bb90a41af4199dde17946e5aa9b3cd72db6\"; \\\r\n  STOP=932239; \\\r\n  HOST=x86_64-w64-mingw32; \\\r\n  XPACK=\"/home/win/xpack-mingw-w64-gcc-15.2.0-2\"; \\\r\n  BASE_DIR=\"/mnt/c/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\\r\n  WIN_DATA_DIR='C:\\\\my_storage\\\\BitcoinData'; \\\r\n  export PATH=\"$XPACK/bin:$PATH\"; \\\r\n  mkdir -p \"$LOG_DIR\"; \\\r\n  (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\\r\n  (echo \"\" && echo \"$(date -I) | reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | win64-gcc15\"; echo \"\") && \\\r\n  hyperfine \\\r\n    --sort command \\\r\n    --runs 1 \\\r\n    --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-win64.json\" \\\r\n    --parameter-list COMMIT ${COMMITS// /,} \\\r\n    --prepare \"taskkill.exe /IM bitcoind.exe /F 2>/dev/null; rm -f ./build/bin/bitcoind.exe; rm -f $DATA_DIR/debug.log; git clean -fxd -e depends/built -e depends/sources -e depends/$HOST; git reset --hard {COMMIT} && \\\r\n      make -C depends HOST=$HOST NO_QT=1 NO_ZMQ=1 CC=\\\"$XPACK/bin/x86_64-w64-mingw32-gcc\\\" CXX=\\\"$XPACK/bin/x86_64-w64-mingw32-g++\\\" -j\\$(nproc) && \\\r\n      cmake -B build -G Ninja --toolchain depends/$HOST/toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF -DWITH_ZMQ=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF && \\\r\n      ninja -C build bitcoind -j\\$(nproc) && \\\r\n      ./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20; rm -f $DATA_DIR/debug.log\" \\\r\n    --conclude \"taskkill.exe /IM bitcoind.exe /F 2>/dev/null; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log && grep 'Bitcoin Core version' $DATA_DIR/debug.log | grep -q \"$(printf %.12s {COMMIT})\"; \\\r\n      cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-\\$(date +%s).log\" \\\r\n    \"./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"; \\\r\ndone\r\n\r\nab233255d4 Merge bitcoin/bitcoin#33866: refactor: Let CCoinsViewCache::BatchWrite return void\r\nb3cb5bb90a validation: fetch inputs on parallel threads\r\n\r\n2026-01-17 | reindex-chainstate | 932239 blocks | dbcache 450 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n  Time (abs â‰¡):        37260.585 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n  Time (abs â‰¡):        28819.823 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nRelative speed comparison\r\n        1.29          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n        1.00          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n\r\nab233255d4 Merge bitcoin/bitcoin#33866: refactor: Let CCoinsViewCache::BatchWrite return void\r\nb3cb5bb90a validation: fetch inputs on parallel threads\r\n\r\n2026-01-18 | reindex-chainstate | 932239 blocks | dbcache 4500 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n  Time (abs â‰¡):        29746.920 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n  Time (abs â‰¡):        25974.137 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nRelative speed comparison\r\n        1.15          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n        1.00          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n```\r\n\r\n</details>\r\n\r\n<details>\r\n<summary>Earlier attempts</summary>\r\n\r\n```\r\nMeasure-Command { C:\\my_storage\\bitcoin-win64\\bin\\bitcoind.exe -datadir=C:\\my_storage\\BitcoinData -stopatheight=927729 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 }\r\n\r\nDays              : 0\r\nHours             : 10\r\nMinutes           : 33\r\nSeconds           : 40\r\nMilliseconds      : 162\r\nTicks             : 380201620408\r\nTotalDays         : 0.440048171768519\r\nTotalHours        : 10.5611561224444\r\nTotalMinutes      : 633.669367346667\r\nTotalSeconds      : 38020.1620408\r\nTotalMilliseconds : 38020162.0408\r\n```\r\n\r\nand\r\n\r\n```\r\n Measure-Command { C:\\my_storage\\bitcoin-win64\\bin\\bitcoind.exe -datadir=C:\\my_storage\\BitcoinData -stopatheight=927729 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 }\r\n\r\nDays              : 0\r\nHours             : 11\r\nMinutes           : 11\r\nSeconds           : 40\r\nMilliseconds      : 78\r\nTicks             : 403000786529\r\nTotalDays         : 0.466436095519676\r\nTotalHours        : 11.1944662924722\r\nTotalMinutes      : 671.667977548333\r\nTotalSeconds      : 40300.0786529\r\nTotalMilliseconds : 40300078.6529\r\n```\r\n\r\nand\r\n\r\n```\r\nwin@WIN-A2EHOAU4JET:/mnt/my_storage/bitcoin$ git log -1\r\ncommit 7f295e1d9b44c225c823242c1f04239f46fb27a6 (HEAD, l0rinc/master, master)\r\nMerge: 5e7931af35 fa4cb13b52\r\nAuthor: merge-script <fanquake@gmail.com>\r\nDate:   Fri Dec 19 16:56:02 2025 +0000\r\n\r\nMeasure-Command { C:\\my_storage\\bitcoin-win64\\bin\\bitcoind.exe -datadir=C:\\my_storage\\BitcoinData -stopatheight=927729 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 }\r\n\r\nDays              : 0\r\nHours             : 9\r\nMinutes           : 48\r\nSeconds           : 15\r\nMilliseconds      : 866\r\nTicks             : 352958669523\r\nTotalDays         : 0.408516978614583\r\nTotalHours        : 9.80440748675\r\nTotalMinutes      : 588.264449205\r\nTotalSeconds      : 35295.8669523\r\nTotalMilliseconds : 35295866.9523\r\n```\r\n\r\nand this is v30 with official release:\r\n```\r\nMeasure-Command { C:\\my_storage\\bitcoin_bins\\bitcoin-30.0\\bin\\bitcoind.exe -datadir=C:\\my_storage\\BitcoinData -stopatheight=927719 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 }\r\n\r\nDays              : 0\r\nHours             : 9\r\nMinutes           : 54\r\nSeconds           : 34\r\nMilliseconds      : 482\r\nTicks             : 356744820316\r\nTotalDays         : 0.412899097587963\r\nTotalHours        : 9.90957834211111\r\nTotalMinutes      : 594.574700526667\r\nTotalSeconds      : 35674.4820316\r\nTotalMilliseconds : 35674482.0316\r\n```\r\n\r\n</details>\r\n\r\n\r\n--------\r\n\r\nre-checked pruned IBD - this still seems to be bandwidth bound, so the difference is more modest:\r\n\r\n<details>\r\n<summary>18% faster - 2026-01-18 | pruned IBD | 932239 blocks | dbcache 450 | pruning 550 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD  </summary>\r\n\r\nCOMMITS=\"22bde74d1d8f861323eabb8dc60401bbf1226544 13d32ed39cf869eb64faf8f489c53f38806a6c29\"; \\                                        \r\nSTOP=932239; DBCACHE=450; PRUNE=550; \\                                                                                                                                                                               \r\nCC=gcc; CXX=g++; \\                                                                                                                                                                                                   \r\nBASE_DIR=\"/mnt/my_storage\"; DATA_DIR=\"$BASE_DIR/ShallowBitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\"; \\                                                                                                                     \r\n(echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) && \\                                                                                                       \r\n(echo \"\" && echo \"$(date -I) | pruned IBD | ${STOP} blocks | dbcache ${DBCACHE} | pruning ${PRUNE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(fr\r\nee -h | awk '/^Mem:/{print $2}') RAM | $(df -T $BASE_DIR | awk 'NR==2{print $2}') | $(lsblk -no ROTA $(df --output=source $BASE_DIR | tail -1) | grep -q 0 && echo SSD || echo HDD)\"; echo \"\") &&\\                   \r\nhyperfine \\                                                                                                                                                                                                          \r\n  --sort command \\                                                                                                                                                                                                   \r\n  --runs 2 \\                                                                                                                                                                                                         \r\n  --export-json \"$BASE_DIR/ibd-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-$CC.json\" \\                                                                                                       \r\n  --parameter-list COMMIT ${COMMITS// /,} \\                                                                                                                                                                          \r\n  --prepare \"killall -9 bitcoind 2>/dev/null; rm -rf $DATA_DIR/*; git clean -fxd; git reset --hard {COMMIT} && \\                                                                                                     \r\n    cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release && ninja -C build bitcoind -j2 && \\                                                                                                                           \r\n    ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=1 -prune=$PRUNE -printtoconsole=0; sleep 20\" \\                                                                                                             \r\n  --conclude \"killall bitcoind || true; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'Disabling script verification at block #1' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log && g\r\nrep 'Bitcoin Core version' $DATA_DIR/debug.log | grep -q \"$(printf %.12s {COMMIT})\"; \\                                                                                                                               \r\n              cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-$(date +%s).log\" \\                                                                                                                                      \r\n  \"COMPILER=$CC ./build/bin/bitcoind -datadir=$DATA_DIR -stopatheight=$STOP -dbcache=$DBCACHE -blocksonly -prune=$PRUNE -printtoconsole=0\"                                                                           \r\n                                                                                                                                                                                                                     \r\n22bde74d1d Merge bitcoin-core/gui#924: Show an error message if the restored wallet name is empty                                                                                                                    \r\n13d32ed39c validation: fetch inputs on parallel threads                                                                                                                                                                                                                                                                                                            \r\n                                                                                                                                                                                                                     \r\n2026-01-18 | pruned IBD | 932239 blocks | dbcache 450 | pruning 550 | i9-ssd | x86_64 | Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz | 16 cores | 62Gi RAM | xfs | SSD                                                   \r\n                                                                                                                                                                                                                     \r\nBenchmark 1: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/ShallowBitcoinData -stopatheight=932239 -dbcache=450 -blocksonly -prune=550 -printtoconsole=0 (COMMIT = 22bde74d1d8f861323eabb8dc60401bbf1226544)                                                                                                                                                                                                                                                                                    \r\n  Time (mean Â± Ïƒ):     33025.250 s Â± 368.595 s    [User: 73666.506 s, System: 4901.220 s]                                                                                                                            \r\n  Range (min â€¦ max):   32764.613 s â€¦ 33285.886 s    2 runs                                                                                                                                                           \r\n                                                                                                                                                                                                                     \r\nBenchmark 2: COMPILER=gcc ./build/bin/bitcoind -datadir=/mnt/my_storage/ShallowBitcoinData -stopatheight=932239 -dbcache=450 -blocksonly -prune=550 -printtoconsole=0 (COMMIT = 13d32ed39cf869eb64faf8f489c53f38806a6c29)                                                                                                                                                                                                                                                                                         \r\n  Time (mean Â± Ïƒ):     27953.899 s Â± 205.665 s    [User: 72179.265 s, System: 4704.044 s]                                                                                                                            \r\n  Range (min â€¦ max):   27808.472 s â€¦ 28099.327 s    2 runs \r\n\r\n</details>\r\n\r\n<details>\r\n<summary>same measurements with `reindex-chainstate` for dbcache of 3 and 12 GB</summary>\r\n\r\n```\r\n for DBCACHE in 3000 12000; do   COMMITS=\"ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb b3cb5bb90a41af4199dde17946e5aa9b3cd72db6\";   STOP=932239;\r\n   HOST=x86_64-w64-mingw32;   XPACK=\"/home/win/xpack-mingw-w64-gcc-15.2.0-2\";   BASE_DIR=\"/mnt/c/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\";   WIN_DATA_DIR='\r\nC:\\\\my_storage\\\\BitcoinData';   export PATH=\"$XPACK/bin:$PATH\";   mkdir -p \"$LOG_DIR\";   (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit\r\n1; done) &&   (echo \"\" && echo \"$(date -I) | reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 |\r\nxargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | win64-gcc15\"; echo \"\") &&   hyperfine     --sort command     --runs 1     --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\\r\nw{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-win64.json\"     --parameter-list COMMIT ${COMMITS// /,}     --prepare \"taskkill.exe /IM bitcoind.exe /F 2>/dev/null; rm -f ./build/b\r\nin/bitcoind.exe; rm -f $DATA_DIR/debug.log; git clean -fxd -e depends/built -e depends/sources -e depends/$HOST; git reset --hard {COMMIT} && \\\r\n      make -C depends HOST=$HOST NO_QT=1 NO_ZMQ=1 CC=\\\"$XPACK/bin/x86_64-w64-mingw32-gcc\\\" CXX=\\\"$XPACK/bin/x86_64-w64-mingw32-g++\\\" -j\\$(nproc) && \\\r\n      cmake -B build -G Ninja --toolchain depends/$HOST/toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF -DWITH_ZMQ=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF && \\\r\n      ninja -C build bitcoind -j\\$(nproc) && \\\r\n      ./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20; rm -f $DATA_DIR/debug.log\"     --conclude \"taskkill.exe /IM bitco\r\nind.exe /F 2>/dev/null; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log && grep 'Bitcoin Core version' $DATA_DIR/debug.log | grep -q \"$(prin\r\ntf %.12s {COMMIT})\"; \\\r\n      cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-\\$(date +%s).log\"     \"./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate\r\n-blocksonly -connect=0 -printtoconsole=0\"; done\r\n\r\nab233255d4 Merge bitcoin/bitcoin#33866: refactor: Let CCoinsViewCache::BatchWrite return void\r\nb3cb5bb90a validation: fetch inputs on parallel threads\r\n\r\n2026-01-19 | reindex-chainstate | 932239 blocks | dbcache 3000 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n  Time (abs â‰¡):        30456.010 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n  Time (abs â‰¡):        26194.317 s               [User: 0.006 s, System: 0.000 s]\r\n\r\nRelative speed comparison\r\n        1.16          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n        1.00          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n\r\nab233255d4 Merge bitcoin/bitcoin#33866: refactor: Let CCoinsViewCache::BatchWrite return void\r\nb3cb5bb90a validation: fetch inputs on parallel threads\r\n\r\n2026-01-19 | reindex-chainstate | 932239 blocks | dbcache 12000 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=12000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n  Time (abs â‰¡):        29192.227 s               [User: 0.002 s, System: 0.000 s]\r\n\r\nBenchmark 2: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=12000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n  Time (abs â‰¡):        26041.974 s               [User: 0.003 s, System: 0.000 s]\r\n\r\nRelative speed comparison\r\n        1.12          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=12000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = ab233255d444ccf6ffe4a45cb02bfc3e5fb71bdb)\r\n        1.00          ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=12000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = b3cb5bb90a41af4199dde17946e5aa9b3cd72db6)\r\n```\r\n\r\n</details>\r\n\r\n----\r\n\r\n<details>\r\n<summary>WORKER_THREADS{8} is slower</summary>\r\n\r\n```\r\n for DBCACHE in 3000 12000; do   COMMITS=\"363e525d8da3c6c495191cb92d8eaf5dbeaeddf5\";   STOP=932239;   HOST=x86_64-w64-mingw32;   XPACK=\"/home/win/xpack-mingw-w64-gcc-15.2.0-2\";   BASE_DIR=\"/mnt/c/my_storage\"; DATA_DIR=\"$BASE_DIR/BitcoinData\"; LOG_DIR=\"$BASE_DIR/logs\";   WIN_DATA_DIR='C:\\\\my_storage\\\\BitcoinData';   export PATH=\"$XPACK/bin:$PATH\";   mkdir -p \"$LOG_DIR\";   (echo \"\"; for c in $COMMITS; do git fetch -q origin $c && git log -1 --pretty='%h %s' $c || exit 1; done) &&   (echo \"\" && echo \"$(date -I) | reindex-chainstate | ${STOP} blocks | dbcache ${DBCACHE} | $(hostname) | $(uname -m) | $(lscpu | grep 'Model name' | head -1 | cut -d: -f2 | xargs) | $(nproc) cores | $(free -h | awk '/^Mem:/{print $2}') RAM | win64-gcc15\"; echo \"\") &&   hyperfine     --sort command     --runs 1     --export-json \"$BASE_DIR/rdx-$(sed -E 's/(\\w{8})\\w+ ?/\\1-/g;s/-$//'<<<\"$COMMITS\")-$STOP-$DBCACHE-win64.json\"     --parameter-list COMMIT ${COMMITS// /,}     --prepare \"taskkill.exe /IM bitcoind.exe /F 2>/dev/null; rm -f ./build/bin/bitcoind.exe; rm -f $DATA_DIR/debug.log; git clean -fxd -e depends/built -e depends/sources -e depends/$HOST; git reset --hard {COMMIT} && \\\r\n      make -C depends HOST=$HOST NO_QT=1 NO_ZMQ=1 CC=\\\"$XPACK/bin/x86_64-w64-mingw32-gcc\\\" CXX=\\\"$XPACK/bin/x86_64-w64-mingw32-g++\\\" -j\\$(nproc) && \\\r\n      cmake -B build -G Ninja --toolchain depends/$HOST/toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_GUI=OFF -DWITH_ZMQ=OFF -DBUILD_TESTS=OFF -DBUILD_BENCH=OFF && \\\r\n      ninja -C build bitcoind -j\\$(nproc) && \\\r\n      ./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=1000 -printtoconsole=0; sleep 20; rm -f $DATA_DIR/debug.log\"     --conclude \"taskkill.exe /IM bitcoind.exe /F 2>/dev/null; sleep 5; grep -q 'height=0' $DATA_DIR/debug.log && grep -q 'height=$STOP' $DATA_DIR/debug.log && grep 'Bitcoin Core version' $DATA_DIR/debug.log | grep -q \"$(printf %.12s {COMMIT})\"; \\\r\n      cp $DATA_DIR/debug.log $LOG_DIR/debug-{COMMIT}-\\$(date +%s).log\"     \"./build/bin/bitcoind.exe -datadir=\\\"$WIN_DATA_DIR\\\" -stopatheight=$STOP -dbcache=$DBCACHE -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\"; done\r\n\r\n363e525d8d WORKER_THREADS{8}\r\n\r\n2026-01-21 | reindex-chainstate | 932239 blocks | dbcache 3000 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=3000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 363e525d8da3c6c495191cb92d8eaf5dbeaeddf5)\r\n  Time (abs â‰¡):        26386.395 s               [User: 0.000 s, System: 0.001 s]\r\n\r\n363e525d8d WORKER_THREADS{8}\r\n\r\n2026-01-21 | reindex-chainstate | 932239 blocks | dbcache 12000 | WIN-A2EHOAU4JET | x86_64 | Intel(R) Xeon(R) CPU E5-2637 v2 @ 3.50GHz | 8 cores | 31Gi RAM | win64-gcc15\r\n\r\nBenchmark 1: ./build/bin/bitcoind.exe -datadir=\"C:\\\\my_storage\\\\BitcoinData\" -stopatheight=932239 -dbcache=12000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0 (COMMIT = 363e525d8da3c6c495191cb92d8eaf5dbeaeddf5)\r\n  Time (abs â‰¡):        26401.538 s               [User: 0.002 s, System: 0.000 s]\r\n```\r\n\r\n</details>\r\n",
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3767758819",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "commented",
      "id": 3785483843,
      "node_id": "IC_kwDOABII587hoeZD",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3785483843",
      "actor": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-22T16:51:56Z",
      "updated_at": "2026-01-22T16:51:56Z",
      "author_association": "MEMBER",
      "body": "Note that this needs a rebase:\r\n```bash\r\n/root/ci_scratch/src/bench/coinsviewcacheasync.cpp:51:71: error: macro â€˜BENCHMARKâ€™ passed 2 arguments, but takes just 1\r\n   51 | BENCHMARK(CoinsViewCacheAsyncBenchmark, benchmark::PriorityLevel::HIGH);\r\n      |                                                                       ^\r\nIn file included from /root/ci_scratch/src/bench/coinsviewcacheasync.cpp:5:\r\n/root/ci_scratch/src/bench/bench.h:68:9: note: macro â€˜BENCHMARKâ€™ defined here\r\n   68 | #define BENCHMARK(n) \\\r\n      |         ^~~~~~~~~\r\n```",
      "user": {
        "login": "fanquake",
        "id": 863730,
        "node_id": "MDQ6VXNlcjg2MzczMA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/fanquake",
        "html_url": "https://github.com/fanquake",
        "followers_url": "https://api.github.com/users/fanquake/followers",
        "following_url": "https://api.github.com/users/fanquake/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/fanquake/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/fanquake/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
        "organizations_url": "https://api.github.com/users/fanquake/orgs",
        "repos_url": "https://api.github.com/users/fanquake/repos",
        "events_url": "https://api.github.com/users/fanquake/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/fanquake/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3785483843",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "labeled",
      "id": 22222205387,
      "node_id": "LE_lADOABII586bT0I_zwAAAAUsi_HL",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22222205387",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-22T17:26:31Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3785681456,
      "node_id": "IC_kwDOABII587hpOow",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3785681456",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-22T17:26:39Z",
      "updated_at": "2026-01-22T17:26:39Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `32 bit ARM`: https://github.com/bitcoin/bitcoin/actions/runs/21006803006/job/61174454902</sub>\n<sub>LLM reason (âœ¨ experimental): Compilation failed due to BENCHMARK macro usage: it is invoked with two arguments, but the macro defined takes only one, causing a build error.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3785681456",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22227939434,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUs43Bq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22227939434",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "98897a49eacb3df3ad5f79b5a54b87d962b6ac20",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/98897a49eacb3df3ad5f79b5a54b87d962b6ac20",
      "created_at": "2026-01-22T22:11:12Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22227984809,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUs5CGp",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22227984809",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "84fa065eca45816f7ee00a181d2ad0e743bd748e",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/84fa065eca45816f7ee00a181d2ad0e743bd748e",
      "created_at": "2026-01-22T22:13:59Z"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22227990726,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAUs5DjG",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22227990726",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/fc72fca292d995de07d98f12dfc4164478826b1f",
      "created_at": "2026-01-22T22:14:21Z"
    },
    {
      "event": "unlabeled",
      "id": 22230224352,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAUtBk3g",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22230224352",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-23T00:32:47Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3805441437,
      "node_id": "IC_kwDOABII587i0m2d",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3805441437",
      "actor": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-27T14:10:32Z",
      "updated_at": "2026-01-27T14:10:32Z",
      "author_association": "MEMBER",
      "body": "  #### Benchcoin Full IBD Results (to block 930,000)\r\n\r\n  Benchmark run: https://github.com/bitcoin-dev-tools/benchcoin/pull/178\r\n\r\n  | dbcache | master (2778eb4) | PR (fc72fca) | Î” |\r\n  |---------|------------------|--------------|---|\r\n  | 450 MB | 323 min | 260 min | **-19.5%** |\r\n  | 32000 MB | 266 min | 246 min | **-7.5%** |\r\n\r\n  **Configuration:**\r\n  - `-prune=200GB`\r\n  - AMD Ryzen 7 7700 8-Core, 64GB RAM, NVMe SSD\r\n  - 1Gbit network to dedicated seed node\r\n\r\n  PR commits: `95ee2d60c217aa2ccf37ed1e5951ea91fdf403d9^..fc72fca292d995de07d98f12dfc4164478826b1f`\r\n  \r\n  Seems like we do indeed get a nice speedup, especially with the default dbcache :)",
      "user": {
        "login": "willcl-ark",
        "id": 6606587,
        "node_id": "MDQ6VXNlcjY2MDY1ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6606587?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/willcl-ark",
        "html_url": "https://github.com/willcl-ark",
        "followers_url": "https://api.github.com/users/willcl-ark/followers",
        "following_url": "https://api.github.com/users/willcl-ark/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/willcl-ark/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/willcl-ark/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/willcl-ark/subscriptions",
        "organizations_url": "https://api.github.com/users/willcl-ark/orgs",
        "repos_url": "https://api.github.com/users/willcl-ark/repos",
        "events_url": "https://api.github.com/users/willcl-ark/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/willcl-ark/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3805441437",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "referenced",
      "id": 22390525430,
      "node_id": "REFE_lADOABII586bT0I_zwAAAAU2lE32",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22390525430",
      "actor": {
        "login": "achow101",
        "id": 3782274,
        "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/achow101",
        "html_url": "https://github.com/achow101",
        "followers_url": "https://api.github.com/users/achow101/followers",
        "following_url": "https://api.github.com/users/achow101/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/achow101/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/achow101/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
        "organizations_url": "https://api.github.com/users/achow101/orgs",
        "repos_url": "https://api.github.com/users/achow101/repos",
        "events_url": "https://api.github.com/users/achow101/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/achow101/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "6750744eb32da428b0a44c6eaab69e5741a25167",
      "commit_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6750744eb32da428b0a44c6eaab69e5741a25167",
      "created_at": "2026-01-29T22:59:47Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGY4NWJmNjhmZmJlZDE4MTU3YmRiNTQ4NTcyMWE5ZGVjMzBmMmM0NzI",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f85bf68ffbed18157bdb5485721a9dec30f2c472",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/f85bf68ffbed18157bdb5485721a9dec30f2c472",
      "tree": {
        "sha": "cce12e65227f3c39f8b1789d88c60e4324325082",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cce12e65227f3c39f8b1789d88c60e4324325082"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree cce12e65227f3c39f8b1789d88c60e4324325082\nparent 5401e673d56198f2c0bad366581e70d5d9cd765c\nauthor Andrew Toth <andrewstoth@gmail.com> 1766559610 +0200\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769730489 -0500\n\ncoins: add PeekCoin()\n\nIntroduce a helper to look up a Coin through a stack of CCoinsViewCache layers without populating parent caches.\n\nThis is useful for ephemeral views (e.g. during ConnectBlock) that want to avoid polluting CoinsTip() when validating invalid blocks.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml78bkACgkQYAB6/Ik4\nsBjVMw/6AkY6UieApAVak3igqulAUCmmIT9GhkrmFtJQDz6GrfoWoC+0M8dBE4up\n6QN7GXI6G4ZVNN3EhOhrq/TOH3Q1ygPYqPNvnI2NxoOOZsXq4tZGegPiZytB/McV\njf3hgPl84f87sNIeRjm7GbPp1VEYM2EivT1Y10pdVfeJbmSxlGin39frDLoPF3pe\ndPP4Kq0JUveBaKc/lyafXFx1Zanctl0fWAF1oCUyMUTGuWTFAttqvg0VhVi/Swwr\n/7JFLMEDVNH+VbLK4PM7zz3mCAi/qYafQRzcBe5kdCy33BFUjvepGI4boGZ2rSEd\nwxNFTPEOws5HIbvHNXFkVdBNv/dIIhWd5DaJoQA8BmGONWY3br15jN/aD5i8heZR\nSyV3q30z7OH7O7V5mXGfi/qXHeFhGd4Cpk1omupELK1H0AkQ4dBdXd71mmugRmPg\nvJh4x3cJYXlhHJhYCD8yIAHZsb6i3moI8Jlk+/Oa5WWwdHSxuFlymH/CHYwXyLvj\nAk7ZTO1WlhIftd51Wk0FMqdd5TQh4AdYW3vAisB2iS6Qm0F2wF56iQ185jTXSYhh\nvLwKbt4eUdmVLttDCWxFEdNsRVZANPhVfMTh/txkwlmhu+llQ2EarfW0XqZRQBZU\nVhic69xiS630gxycvuYk2QlDVxOUAeZuIPiIU1DiQ6s4PyWv+oU=\n=yT5f\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5401e673d56198f2c0bad366581e70d5d9cd765c",
          "sha": "5401e673d56198f2c0bad366581e70d5d9cd765c",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/5401e673d56198f2c0bad366581e70d5d9cd765c"
        }
      ],
      "message": "coins: add PeekCoin()\n\nIntroduce a helper to look up a Coin through a stack of CCoinsViewCache layers without populating parent caches.\n\nThis is useful for ephemeral views (e.g. during ConnectBlock) that want to avoid polluting CoinsTip() when validating invalid blocks.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-29T23:48:09Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-24T07:00:10Z"
      },
      "sha": "f85bf68ffbed18157bdb5485721a9dec30f2c472"
    },
    {
      "event": "labeled",
      "id": 22391751678,
      "node_id": "LE_lADOABII586bT0I_zwAAAAU2pwP-",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22391751678",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-30T00:21:47Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDZiY2IzZTBjMmQ1MzBkY2E3MTJmNTk1OGMxMzI1NDRkNjUzMTYxY2Q",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6bcb3e0c2d530dca712f5958c132544d653161cd",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/6bcb3e0c2d530dca712f5958c132544d653161cd",
      "tree": {
        "sha": "98a0c79e26a3c83e9a760157732cceaa26ac7515",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/98a0c79e26a3c83e9a760157732cceaa26ac7515"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 98a0c79e26a3c83e9a760157732cceaa26ac7515\nparent f85bf68ffbed18157bdb5485721a9dec30f2c472\nauthor Andrew Toth <andrewstoth@gmail.com> 1768420544 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769736296 -0500\n\ncoins: don't mutate main cache when connecting block\n\nIntroduce CoinsViewCacheAsync, a CCoinsViewCache subclass that reads coins\nwithout mutating the underlying cache.\n\nOverride GetCoinFromBase() to call PeekCoin() instead of GetCoin(). This\nprevents the main cache from caching inputs pulled from disk for a block that\nhas not yet been fully validated. Once Flush() is called on the async cache,\nthese inputs will be added as spent to cacheCoins in the main cache via\nBatchWrite().\n\nRename CoinsViewCacheController to CoinsViewCacheAsyncController and change\nit to wrap CoinsViewCacheAsync internally. Update m_connect_block_controller\nto use the new async controller.\n\nThis is the foundation for async input fetching, where worker threads must not\nmutate shared state.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8CGkACgkQYAB6/Ik4\nsBiBGA//QyZaaovJN7jHfEofsbl8ALcGiJGAlKHTBDy6+ceoO7/XNe9mXFck5rN5\nFCgzuspNG189t5EWuKBozmwy2KRY3+EzB7Xt/njL+9szWh2srd9AIixBpqj6ucUf\nTFVCVNq+qlBzUnMmqpHINBW8cDUp+4t8FG8SiSmNz4GkhLMfwDmktPI08GKPKM2t\nzgq5kzPfhaf3eCigomdyOvF4553hXxutUgsVUv1sM1DDIALATN6JPnXBCE32UG/0\nJTU1WXstUFLfA2n7HUscBNJuKfex3UIq8SvcAT3uwahJHpHwrzmU3VnGKvDNtBw0\nKSy68hyEELvD/jw1tmArpAdyiGNEbgF0PPIiNClUeFwIT4X1+6ENOk6lmzJwRf3D\nZnGcDVKzBFpB7Ds0kWfhOgo7Q73HHq7r9aGK8XnHzvUbF62k4kdQrT6HgyGXEHXV\nETYGwK8QEcOTzWacLSQFcR4mBVaXH+8vKQCcWMR3CKjjLrE2naMOU1zOUaHuz8So\nlsCr38T7JclZ0nzBUQ3IO0OZMbKDB+9bmdWlfOelpE9vvMXWoYIDq8BZcECSeKBZ\nLNhgCWmmodPkRGuNCHIT+kA/UXt43kN8r/oF5d464PX+Kqa7SKiKPvuvfQeigkW+\n2gom6z9KdJ+r6JArP3dTXoxxmaJ08pBwmb0QSR5IBCqMiZT+OkQ=\n=XiZ6\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f85bf68ffbed18157bdb5485721a9dec30f2c472",
          "sha": "f85bf68ffbed18157bdb5485721a9dec30f2c472",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/f85bf68ffbed18157bdb5485721a9dec30f2c472"
        }
      ],
      "message": "coins: don't mutate main cache when connecting block\n\nIntroduce CoinsViewCacheAsync, a CCoinsViewCache subclass that reads coins\nwithout mutating the underlying cache.\n\nOverride GetCoinFromBase() to call PeekCoin() instead of GetCoin(). This\nprevents the main cache from caching inputs pulled from disk for a block that\nhas not yet been fully validated. Once Flush() is called on the async cache,\nthese inputs will be added as spent to cacheCoins in the main cache via\nBatchWrite().\n\nRename CoinsViewCacheController to CoinsViewCacheAsyncController and change\nit to wrap CoinsViewCacheAsync internally. Update m_connect_block_controller\nto use the new async controller.\n\nThis is the foundation for async input fetching, where worker threads must not\nmutate shared state.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:24:56Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-14T19:55:44Z"
      },
      "sha": "6bcb3e0c2d530dca712f5958c132544d653161cd"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDQ3ODNkMDE1NzlhZjYyNjc2ZDEwMzhhZjY0NGMyOTZmODE5NGFjMWU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4783d01579af62676d1038af644c296f8194ac1e",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/4783d01579af62676d1038af644c296f8194ac1e",
      "tree": {
        "sha": "93a75ef7d2208de014bf0432888e2be26fd08f27",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/93a75ef7d2208de014bf0432888e2be26fd08f27"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 93a75ef7d2208de014bf0432888e2be26fd08f27\nparent 6bcb3e0c2d530dca712f5958c132544d653161cd\nauthor Andrew Toth <andrewstoth@gmail.com> 1766765639 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769736297 -0500\n\nfuzz: pass coins_view_cache to TestCoinsView in coins_view\n\nRefactor TestCoinsView() to accept the cache as a parameter instead of\ncreating it internally. This prepares for adding CoinsViewCacheAsync\nfuzz targets that need to pass in a different cache type.\n\nThis is a non-functional change.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8CGkACgkQYAB6/Ik4\nsBgFshAArXRr8mOCfDQ9genWQL6CDOhMzi4FDRqat4FHTQOdOj3ed+Iht0KYBRYs\nOv/hi5YT7DOO3AqfI81oZ0ka5VUyWcwgrCw38YJXRr2O9Wvh+iz88+esnuSJXqzg\n8Tr5ewqhru3Xkvt9ifM3mHrm+g6pdp74xTmhsShC+4RbL+R3yeVNgwBDd4b9NPjR\nm9wAf2Hbi7B/2IrK+QHzLi0VmKuiRUe1LajJjw0TG4MwHn4TNUaHSAqVWHdwVp9q\nufjqY5LCnDCaS4IXlqZsDGvF8nGn8K3edNGxvvvHrZNNSliOm92bxl5dcsIueG7z\nmJ9kNwKOuiO3/WHtbhi+bsZbLd0WTAsbA+aH9MYbGuKfrW+l9GLItHgC2byffny0\nwcKjQSiql+azno0gCWxtVmPgKLzAkxsEZxkf+GPyv5+S3+hYVbsF9ibVS6Nr54hO\nqhAP77l1gwhQLU7XDCWmxGmq5qZE6XfI5ioP5Rq9S/XOPeaQKp+Jb1jWM/zKQY5o\nnQfVEujpBc8McFoIpzBMT5LRfo3ApBj9/OrLNqVHykkab8rpoqCRMCqUnTe47RHL\n/eGO35RY0uLSGpWAwKkyHIImfiuqxUqapDJnR9lwGffwT2M/nRPzIBgNJ7HJYf3+\nO372jV8aYoZj1TnBVl+H+RU2vwbOShJlQIMhBxSbD8dgCrgpdFI=\n=gpvm\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6bcb3e0c2d530dca712f5958c132544d653161cd",
          "sha": "6bcb3e0c2d530dca712f5958c132544d653161cd",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/6bcb3e0c2d530dca712f5958c132544d653161cd"
        }
      ],
      "message": "fuzz: pass coins_view_cache to TestCoinsView in coins_view\n\nRefactor TestCoinsView() to accept the cache as a parameter instead of\ncreating it internally. This prepares for adding CoinsViewCacheAsync\nfuzz targets that need to pass in a different cache type.\n\nThis is a non-functional change.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:24:57Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-26T16:13:59Z"
      },
      "sha": "4783d01579af62676d1038af644c296f8194ac1e"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDEwM2ZhMGE1MTkzMDkyYjVmNTViZjk2YzgzMjUyZDU2YjI5OGQ5Mjc",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/103fa0a5193092b5f55bf96c83252d56b298d927",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/103fa0a5193092b5f55bf96c83252d56b298d927",
      "tree": {
        "sha": "e83aa88a4781dc1b3fd8b4dc8efac709c0ada59d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e83aa88a4781dc1b3fd8b4dc8efac709c0ada59d"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree e83aa88a4781dc1b3fd8b4dc8efac709c0ada59d\nparent 4783d01579af62676d1038af644c296f8194ac1e\nauthor Andrew Toth <andrewstoth@gmail.com> 1768426282 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769737123 -0500\n\nvalidation: fetch all inputs of block before connecting block\n\nAdd StartFetching() to CoinsViewCacheAsync that populates a queue of all\ntransaction inputs in a block, then fetches them all via ProcessInput()\nbefore entering ConnectBlock. GetCoinFromBase() now checks this queue first.\nReturn a ResetGuard and override Reset to call StopFetching. The ResetGuard\nis bound to the blocks lifetime, so we will stop fetching and clear the\ninputs before the block is destroyed.\n\nIntroduce InputToFetch struct to track each input's outpoint and fetched coin.\nGetCoinFromBase() scans the queue sequentially, matching ConnectBlock's access\npattern where inputs are processed in block order.\n\nProcessInput() fetches coins one at a time using PeekCoin(),\npreparing for parallel execution in later commits.\n\nAlso add fuzz targets for CoinsViewCacheAsync and update unit tests to use\nStartFetching(block).\n\nCo-authored-by: sedited <seb.kung@gmail.com>\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8DBwACgkQYAB6/Ik4\nsBhe5hAAhWsWX3wrCut7eYCHpf9R9Q0MkYh9N/5CgUrk2kesSkAqsN1L640knofs\nmhx0Z5NEzrWB+sjDnOWE0lDuhWe28mSEZiLMH6UoUk2fwxDxVH+4/Zh9d8e0ufP+\nCSB11TMchDqC8XYkdef2olQzpus69+rYLMqT+lKXHc+ihygV4jlxI/CWrFqac514\nt+9wMNih+TpyrdID26R/XMK+qEz32Ns9o+LeBlZywWNzi4jkc7X5pBLg2n5/6MIt\nmkdyhpiZNGD1h2An+7NtH2YcedXv9BAtnziWNC++Olk4k7H+nHAXbcuCGyIweDPy\n22Q4UsBK6ghgABerDKfdEOUqmjEflMERtzBy0CeVOX51sMSg67ifH6TjNMkNutt5\nfHEmQTrYSjqrG8znNwKLZ7MgGkwT1mLkztliSKuPv0GotG5Vzkg02QrGlNsZ+FIw\nag8r9WafG9S3WV0VQcHB9PE29ChteBS/WMfxJAfNH8PDTW7cXP/yzCpPyfXp/mDL\nrAYBkClPETy8rY4UcQqO32JBYYB9u5Wy/HadqfSvTNY6x3HADCvsuhe5D6eILyQC\nMal4SkVZtu47BbuBr1M0uCJS13G/TgYjje28c+VyEBS6z2mCmtieP5VlKy4MbXj2\nMI28If7xMQFllCXSetipHBWReo44AvG7KHyKl3grGcQrHzBt/Pg=\n=htRP\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4783d01579af62676d1038af644c296f8194ac1e",
          "sha": "4783d01579af62676d1038af644c296f8194ac1e",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/4783d01579af62676d1038af644c296f8194ac1e"
        }
      ],
      "message": "validation: fetch all inputs of block before connecting block\n\nAdd StartFetching() to CoinsViewCacheAsync that populates a queue of all\ntransaction inputs in a block, then fetches them all via ProcessInput()\nbefore entering ConnectBlock. GetCoinFromBase() now checks this queue first.\nReturn a ResetGuard and override Reset to call StopFetching. The ResetGuard\nis bound to the blocks lifetime, so we will stop fetching and clear the\ninputs before the block is destroyed.\n\nIntroduce InputToFetch struct to track each input's outpoint and fetched coin.\nGetCoinFromBase() scans the queue sequentially, matching ConnectBlock's access\npattern where inputs are processed in block order.\n\nProcessInput() fetches coins one at a time using PeekCoin(),\npreparing for parallel execution in later commits.\n\nAlso add fuzz targets for CoinsViewCacheAsync and update unit tests to use\nStartFetching(block).\n\nCo-authored-by: sedited <seb.kung@gmail.com>\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:38:43Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-14T21:31:22Z"
      },
      "sha": "103fa0a5193092b5f55bf96c83252d56b298d927"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22393158759,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAU2vHxn",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22393158759",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "22869c32e84fd0f8426034cf0390538eebc6f9e5",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/22869c32e84fd0f8426034cf0390538eebc6f9e5",
      "created_at": "2026-01-30T01:48:28Z"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDg2MWQ1N2MxZGM4ZjdhZTA3ZGE4YzBiNDA1ZDQxODllYzc0ODliNTg",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/861d57c1dc8f7ae07da8c0b405d4189ec7489b58",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/861d57c1dc8f7ae07da8c0b405d4189ec7489b58",
      "tree": {
        "sha": "18cccc1aa06839249e7569939a5fc3ca11f638b3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/18cccc1aa06839249e7569939a5fc3ca11f638b3"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 18cccc1aa06839249e7569939a5fc3ca11f638b3\nparent 103fa0a5193092b5f55bf96c83252d56b298d927\nauthor Andrew Toth <andrewstoth@gmail.com> 1766451527 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769737997 -0500\n\nbench: add CoinsViewCacheAsync benchmark\n\nAdd a benchmark measuring CoinsViewCacheAsync performance when fetching\ninputs for a block. Creates a realistic scenario by adding all inputs from\nblock 413567 to a chainstate with an in memory leveldb backend.\n\nMeasures the time to access all inputs through the cache.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8Dw0ACgkQYAB6/Ik4\nsBh1XBAAm6Gh3iKdJgFdcv43WWQOAEFDViDPsXu8eA+zarZRwfeFIpGZnEsVg8VZ\nap+9IgmRVvNBuIpdc4tf96R4EYAdgxbTGEdlclOtmm7qrNfpB+1oAgyamKRLPFIJ\n0urE011ViidsPt3j6KFR0rhBXzxSCsTqx8FQKiL/ETcOy4J6vmvwUya/s40f45yF\nF3W3meX97wEwl/Kik/Xvyr5oExVwwQpb64Wtv5naqROCGPjmHNKogoyFbwMCYGAh\nB+fhIscKrXGW8U43jO8pXEeGWdoetcrISKVwOAP+V3PPS8GQGIpPijaBKZc248Qh\nQPlM6WAzxKRjJelM4CN1Wj7TkGlc5ezbGomCbMuIGY+Pr8il7p/Y0LcaIk9gfgIH\nHekT7grmxfxzpdBIAmEiR4uKiVD4KLf4wEuZsaHT2ZBr3RczQawuvzMdamhP0xLT\n4Em0y/lnUbbuLLnQVUF12cxr3f2cKAEQoSOiMlMFmwjA4hlerpZ0SkohcRLPeCQS\nmbdZB6TMu7AfxwtzwE1igZWv3YEm73vfbZ/mNIAy+hOwrgyKMqj+CkAmvoAvsCEq\n1OjTa6tj+AaiFmCAxLRPlvEym9PJeq0f/Hc2zSlwK++AqGESml8HWiWbRegAqsLI\nvcOmsOH6runC7qQ2cg6ioMRhOWbv/+Et7hPiErEt2+UkOMOpa+k=\n=ktdw\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/103fa0a5193092b5f55bf96c83252d56b298d927",
          "sha": "103fa0a5193092b5f55bf96c83252d56b298d927",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/103fa0a5193092b5f55bf96c83252d56b298d927"
        }
      ],
      "message": "bench: add CoinsViewCacheAsync benchmark\n\nAdd a benchmark measuring CoinsViewCacheAsync performance when fetching\ninputs for a block. Creates a realistic scenario by adding all inputs from\nblock 413567 to a chainstate with an in memory leveldb backend.\n\nMeasures the time to access all inputs through the cache.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:53:17Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-23T00:58:47Z"
      },
      "sha": "861d57c1dc8f7ae07da8c0b405d4189ec7489b58"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGJjOWQxZTdlZTRhMmUyZmY0NGU2YTQ4Yjg0ZTRiMTA2MTU5Zjk4ZjU",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5",
      "tree": {
        "sha": "a8dad9d6b3e34fe4a2fc67c9cb23d67aac3a3b07",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a8dad9d6b3e34fe4a2fc67c9cb23d67aac3a3b07"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree a8dad9d6b3e34fe4a2fc67c9cb23d67aac3a3b07\nparent 861d57c1dc8f7ae07da8c0b405d4189ec7489b58\nauthor Andrew Toth <andrewstoth@gmail.com> 1766451710 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769737997 -0500\n\ncoins: filter inputs created in same block before fetching\n\nSkip fetching inputs that spend outputs created earlier in the same block,\nsince these coins won't exist in the cache or database yet.\n\nStore the first 8 bytes of each transaction's txid in a sorted vector for\nO(log n) binary search lookups. Using truncated txids is a performance\noptimization; in the rare case of a collision, the input simply won't be\nprefetched and will fall back to normal fetching on the main thread.\n\nThis adds a performance regression due to the extra sorting and filtering.\nSince the benchmark uses an in-memory leveldb, there is no real disk I/O that is avoided.\n\n> bench: add CoinsViewCacheAsync benchmark\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,664,383.00 |              600.82 |    2.4% |   31,957,257.00 |    4,017,069.00 |  7.955 |   5,318,396.00 |    0.6% |      0.02 | CoinsViewCacheAsyncBenchmark\n\n> coins: filter inputs created in same block before fetching\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,970,543.00 |              507.47 |    4.0% |   32,640,039.00 |    4,760,784.00 |  6.856 |   5,506,291.00 |    1.2% |      0.02 | CoinsViewCacheAsyncBenchmark\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8Dw0ACgkQYAB6/Ik4\nsBiDBg//ezDw0wXsCfwiqvMs9pPD3LHUJ91t+kVJZ7aOE8Fp/TN2LU+PEbsga7T8\n9hS4wwQ7X6lQpKQ8NmiTE8ViGgVCGmx0x6ECvVd6+ggWxO6OA774q7eQOxahYx96\nyH5+6lkvWouVE3IStuusGxBBOWBXayVxF6Ctj24dKsp3lxD84ma4JyjBGE+wKLjG\nQB5osGv0+KvA/o+mB9PU6ziv1Z44IjInCVHiQe8vpDU2r4NqmyDl0Hd4XK9kzxFO\nnajoLGjXedtjohEEhZwGk1zT7huwiKCSOcSmrF3maqbOXiHSfxpoqnMW1/lnpxpq\nt/FW+CqPtyDzWMH+IRR7EnRAbz69qSCpvWeMxBJ07qDLu25s9iND73IHp4v5v5va\nJIZ04b3UIBBx/pQoopNzHuaxe9xcITc4JhU6X0+aioe1qsrabJ3ZzetvjiAFeQLA\nWEMDjevy5wNaG4BdC747uVtegv0kzFXoXCJy5WA1TFwpTvD0wl+xFh4JzHQyetOk\nRQUDE+NZEKGLJXaSO9vcR/2r9Jh6vIPrEPp9nE3ACxWFRyL6wpDkWmRd4kDo7KUY\nE4IpWNqVEWDl50v6EXOJhDr7srlKJC8xcnIfl/oFZnvK3Zt0eVmJrfV0XFzmA4Hc\n8YYB5XTU1ZUoCiNaZmqR0Er3nmVEKmMlQ88aoORfy5YhOPqPscg=\n=XKaj\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/861d57c1dc8f7ae07da8c0b405d4189ec7489b58",
          "sha": "861d57c1dc8f7ae07da8c0b405d4189ec7489b58",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/861d57c1dc8f7ae07da8c0b405d4189ec7489b58"
        }
      ],
      "message": "coins: filter inputs created in same block before fetching\n\nSkip fetching inputs that spend outputs created earlier in the same block,\nsince these coins won't exist in the cache or database yet.\n\nStore the first 8 bytes of each transaction's txid in a sorted vector for\nO(log n) binary search lookups. Using truncated txids is a performance\noptimization; in the rare case of a collision, the input simply won't be\nprefetched and will fall back to normal fetching on the main thread.\n\nThis adds a performance regression due to the extra sorting and filtering.\nSince the benchmark uses an in-memory leveldb, there is no real disk I/O that is avoided.\n\n> bench: add CoinsViewCacheAsync benchmark\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,664,383.00 |              600.82 |    2.4% |   31,957,257.00 |    4,017,069.00 |  7.955 |   5,318,396.00 |    0.6% |      0.02 | CoinsViewCacheAsyncBenchmark\n\n> coins: filter inputs created in same block before fetching\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,970,543.00 |              507.47 |    4.0% |   32,640,039.00 |    4,760,784.00 |  6.856 |   5,506,291.00 |    1.2% |      0.02 | CoinsViewCacheAsyncBenchmark\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:53:17Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-23T01:01:50Z"
      },
      "sha": "bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDJlMTM0ZjNlZmNlYjE5MGQ0NjEzZjE1YzFjMzBmNzQ2MjRmZGM0NmE",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2e134f3efceb190d4613f15c1c30f74624fdc46a",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/2e134f3efceb190d4613f15c1c30f74624fdc46a",
      "tree": {
        "sha": "9cf7179ef22b0d57040895e4891dfbde06a0b31b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9cf7179ef22b0d57040895e4891dfbde06a0b31b"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree 9cf7179ef22b0d57040895e4891dfbde06a0b31b\nparent bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5\nauthor Andrew Toth <andrewstoth@gmail.com> 1766451830 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769737997 -0500\n\ncoins: process pending inputs while waiting in GetCoinFromBase\n\nAllow the main thread to process unfetched inputs while waiting for a\nspecific coin. Instead of blocking, GetCoinFromBase() calls ProcessInput() to\nmake forward progress on the queue.\n\nThis prepares for parallel fetching where the main thread can help workers\ncomplete the queue rather than idling while waiting.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8Dw0ACgkQYAB6/Ik4\nsBjMChAAp0mqXTfq86W/PSF3XfHDTT2L5p4nbjieSM8GRZo3XxBnOKbUg3nLWQVs\nzcIAa1SeRh8/kaCtP4ZTHxjrToZL/MIOsABJbcop+Z1QT1ScVrFeSe86sPLPT55v\ngdF2fej9xWgiirQNrZhB7xwQN9BxZTCyTU+W2l7ZIp+WgSGKoJUuAIXxgMgvUNpw\nTunCINYkecIfmN7IbVxRZYuzzg2zsssFJNEt8qMnE8AvBn7M22ffox4rqMaJgGdx\nBmOlAj9/t39jz9VnX7X/+sYvUbUyohHDaPIkgOo+nLSxR0EKgSpeyAJibmyh9Kx/\nBOaFz0uRYr/i806Ec9//hHHqKZpt78EB+EIYbO4zLV3W5YkFGDPNlr1wtKJEDg9y\nVk2DUjzYoKSob5E4ysevZ7qDoCetQUu9K9MR+9WZBxdzHWDF+SFqHfiqNKwF6bhg\nQg6QGeTuJLKd1UYn7aFrlciZ+GNp6wKCEg8owsA2mfz7m7jI9Mbf9AlTuJn/1SJh\noHvawfWMuoTWC1LZ5tXpPMUaBJNjR5UAeL86VX4tMUTEQCqDSQri12LnJAActx4R\n54v4U/ke85eaCsDwr6HAOS0XFkvJ/VTk0zCKZRS33HFesmx1qDWubcTSy9/8aEX/\nzsdHH0oNb9cTzWV+/U8rbguCAm35CwQgF7Yc88JW0UpvayHiWwQ=\n=GJ1F\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5",
          "sha": "bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/bc9d1e7ee4a2e2ff44e6a48b84e4b106159f98f5"
        }
      ],
      "message": "coins: process pending inputs while waiting in GetCoinFromBase\n\nAllow the main thread to process unfetched inputs while waiting for a\nspecific coin. Instead of blocking, GetCoinFromBase() calls ProcessInput() to\nmake forward progress on the queue.\n\nThis prepares for parallel fetching where the main thread can help workers\ncomplete the queue rather than idling while waiting.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:53:17Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-23T01:03:50Z"
      },
      "sha": "2e134f3efceb190d4613f15c1c30f74624fdc46a"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGQxNzE4OGEyNjg3NTk4ZTcxNDk2MDMwYmJjYjVjOWNkYTg4N2I3NDQ",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d17188a2687598e71496030bbcb5c9cda887b744",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/d17188a2687598e71496030bbcb5c9cda887b744",
      "tree": {
        "sha": "b928e47e11ea1830815ed60a9003cd3990cc98cf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b928e47e11ea1830815ed60a9003cd3990cc98cf"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree b928e47e11ea1830815ed60a9003cd3990cc98cf\nparent 2e134f3efceb190d4613f15c1c30f74624fdc46a\nauthor Andrew Toth <andrewstoth@gmail.com> 1766765845 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769737997 -0500\n\nfuzz: move backend_coins_view access to end of TestCoinsView\n\nRestructure TestCoinsView() to perform all checks that don't mutate the\nbackend before accessing backend_coins_view with HaveCoin()/GetCoin().\n\nThis prepares for CoinsViewCacheAsync testing, where we want to run as many\nchecks as possible while async fetching is still active. Only at the very\nend do we call StopFetching() and perform the backend consistency checks\nthat require mutating calls (HaveCoin/GetCoin call FetchCoin which writes\nto cacheCoins).\n\nNon-mutating operations like GetBestBlock(), EstimateSize(), and Cursor()\ncan safely run on the backend while workers are still fetching.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8Dw0ACgkQYAB6/Ik4\nsBi3SA//QbYCr6Y8eu5/PK77PWwkeRt3iWwB0fXcSEy9obmKIhqc44rNewqE0dU9\nZrl3DsDiTIr8LxF+JuQF0qWWV86QBBC+xNyzssfbTOXEt0eIlehPWoF0AWz+70UF\n+AK4XhN+o5F9my8e3gONFq1YSVkgZtj4te8IRnFZrLiK38VGckOz3hkpHculGs0K\n036gA757QkonCbSi/4ZdYQUBSyB+TqQwSI3OKg6/O5m26eMKP94/QU5Eg/W1z+C5\n3qjI6zcEZvn29WMC+vMGZeORx0kkai0NXsfyJGUGZK8cyC5os+Wv786Q32n86edW\ndYTJ9y5iHdRrcLv7WQDJFvzNMixjfIq3UbSiwwZUEMOAi2mDC916Es3iRDfF4ne2\njOApGzZlmpF2HttOy7p/cE9ukxycMopnf5Y8r6ZCBn3dokENvoc170vmmrTmWZjv\nDE1gOjWvmyy8qaB9euu6w/sJt/vTl0/F7XYhJfLH3JxCptW/P8YM0I/vzwDet66H\nnVc2nfDDbswrTQ9EMqJdAmZapZFNBI4WQA1QmJs+FdjQgwpNkAEFTZrc2JO/VeaP\nVae244axrdyeFxdnvoEKcMRdIU14m85pyAFaeDmjl+S2Ttbm1ccBkxHR6TVosy95\ncE3nXllk9fY/f5os9fd2yKjs1JimOHsq23fs46qjQ+X3Q0I50g0=\n=otP7\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2e134f3efceb190d4613f15c1c30f74624fdc46a",
          "sha": "2e134f3efceb190d4613f15c1c30f74624fdc46a",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/2e134f3efceb190d4613f15c1c30f74624fdc46a"
        }
      ],
      "message": "fuzz: move backend_coins_view access to end of TestCoinsView\n\nRestructure TestCoinsView() to perform all checks that don't mutate the\nbackend before accessing backend_coins_view with HaveCoin()/GetCoin().\n\nThis prepares for CoinsViewCacheAsync testing, where we want to run as many\nchecks as possible while async fetching is still active. Only at the very\nend do we call StopFetching() and perform the backend consistency checks\nthat require mutating calls (HaveCoin/GetCoin call FetchCoin which writes\nto cacheCoins).\n\nNon-mutating operations like GetBestBlock(), EstimateSize(), and Cursor()\ncan safely run on the backend while workers are still fetching.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T01:53:17Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-26T16:17:25Z"
      },
      "sha": "d17188a2687598e71496030bbcb5c9cda887b744"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22393231182,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAU2vZdO",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22393231182",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "2011aec1085ac4a233dc152b43e10d20b95fd6d9",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/2011aec1085ac4a233dc152b43e10d20b95fd6d9",
      "created_at": "2026-01-30T01:53:26Z"
    },
    {
      "event": "labeled",
      "id": 22393240507,
      "node_id": "LE_lADOABII586bT0I_zwAAAAU2vbu7",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22393240507",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-30T01:54:03Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    },
    {
      "event": "commented",
      "id": 3821339492,
      "node_id": "IC_kwDOABII587jxQNk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/3821339492",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-30T01:54:36Z",
      "updated_at": "2026-01-30T01:54:36Z",
      "author_association": "CONTRIBUTOR",
      "body": "<!--85328a0da195eb286784d51f73fa0af9-->\nðŸš§ At least one of the CI tasks failed.\n<sub>Task `MSan`: https://github.com/bitcoin/bitcoin/actions/runs/21501458749/job/61948501131</sub>\n<sub>LLM reason (âœ¨ experimental): Compilation failed in src/bench/coinsviewcacheasync.cpp due to undeclared identifier CoinsViewCacheAsyncController, causing the build to abort.</sub>\n\n<details><summary>Hints</summary>\n\nTry to run the tests locally, according to the documentation. However, a CI failure may still\nhappen due to a number of reasons, for example:\n\n* Possibly due to a silent merge conflict (the changes in this pull request being\nincompatible with the current code in the target branch). If so, make sure to rebase on the latest\ncommit of the target branch.\n\n* A sanitizer issue, which can only be found by compiling with the sanitizer and running the\n  affected test.\n\n* An intermittent issue.\n\nLeave a comment here, if you need help tracking down a confusing failure.\n\n</details>\n\n",
      "user": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#issuecomment-3821339492",
      "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/31132"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKGRjZTI5N2FjMGFkMGYzNWYxN2ZmNTFjNmYyODYwYzJiYzUwZDYzNDk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dce297ac0ad0f35f17ff51c6f2860c2bc50d6349",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/dce297ac0ad0f35f17ff51c6f2860c2bc50d6349",
      "tree": {
        "sha": "a4afa8d0ff51efabc7f377341c4b0419bdb2c302",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a4afa8d0ff51efabc7f377341c4b0419bdb2c302"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree a4afa8d0ff51efabc7f377341c4b0419bdb2c302\nparent d17188a2687598e71496030bbcb5c9cda887b744\nauthor Andrew Toth <andrewstoth@gmail.com> 1766452194 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769739930 -0500\n\ncoins: make fetching inputs thread safe\n\nRename ProcessInput to ProcessInputInBackground.\n\nAdd thread-safe synchronization primitives to allow any thread to safely call\nProcessInputInBackground once all threads arrive_and_wait() a\nstd::barrier.\n\nMake m_input_head a std::atomic_unit32_t, so workers can claim inputs\natomically in ProcessInputInBackground.\n\nMake ready flag a std::atomic_flag per InputToFetch to act as an atomic\nmemory fence. Workers release and the main thread acquires the flag to\nensure the coin is seen correctly no matter which thread has written it.\n\nAdd StopFetching() private method that skips all remaining inputs, waits for\nall threads to arrive at the std::barrier, and resets all state in\nCoinsViewCacheAsync.\n\nOverride Flush(), Sync(), and SetBackend() to call StopFetching() before\ncalling CCoinsViewCache base class methods. This ensures no worker threads\ncan access base while it is being mutated.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8FpoACgkQYAB6/Ik4\nsBgKfQ//aq2AMmmIKeQBflcPHSt+VwGxvwcJF8+WSnh9Rl1nuov6FXm/qQaQ1qp1\niTggXqVwfoBUNBAMcTqsGl35Z2Ico9IyYa3ZbNILWkaEcUPz7M6fec6HJwpkztzc\n3KHkSvb8zvvARE7n3szcIyfDUWKcyxLka6sl5seQJMp8qB0RWE85EV3QEoBGJOvp\nkGbQfDCI02tOg24JNzSLa3eag99oMgf1KfUjnacwRbyecj9g6+aeB4RWcKfQkt4O\nr+D9CuWoEFEGIeajA5uqM3FI8mldgMHSaq4rR9KFvpFWliIj3hbSXr9HHoxsQEdO\n6o3U+y4E9CErBSHgEKYR1Dk73DFLM3UdJyaZhAvdd91KWpYXFnAxXnHfK5Pjmn8C\nQAxpt4pffXfEqkGABFlw8wXIQWZN8GNeS62Ue91gK6tgEMUuK++TnPJhM98alDwV\nT0SMyrMRwcAVTvHFbTeRHyLOrwBK27IZE/PK6qcvOZn1pKLigiiLzPP/IuzpO4KA\nbzzywa5AtdhWY11jsGIen4uRhqz7Rrre0WnM1FAtDhANTM5RAKGATlQgXe4SsQRM\n1bruc4OWqNM1wy/WUVvPZ4m+KjSV53gnl3n2ZiPOsvREDmRSEKTQuLN0m78N+h1m\nrrbLqH3JOu3jgDJ1QyiRNT+j/bQlEKmFkb0NbMSJR/AOxP23n8g=\n=kZPp\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d17188a2687598e71496030bbcb5c9cda887b744",
          "sha": "d17188a2687598e71496030bbcb5c9cda887b744",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/d17188a2687598e71496030bbcb5c9cda887b744"
        }
      ],
      "message": "coins: make fetching inputs thread safe\n\nRename ProcessInput to ProcessInputInBackground.\n\nAdd thread-safe synchronization primitives to allow any thread to safely call\nProcessInputInBackground once all threads arrive_and_wait() a\nstd::barrier.\n\nMake m_input_head a std::atomic_unit32_t, so workers can claim inputs\natomically in ProcessInputInBackground.\n\nMake ready flag a std::atomic_flag per InputToFetch to act as an atomic\nmemory fence. Workers release and the main thread acquires the flag to\nensure the coin is seen correctly no matter which thread has written it.\n\nAdd StopFetching() private method that skips all remaining inputs, waits for\nall threads to arrive at the std::barrier, and resets all state in\nCoinsViewCacheAsync.\n\nOverride Flush(), Sync(), and SetBackend() to call StopFetching() before\ncalling CCoinsViewCache base class methods. This ensures no worker threads\ncan access base while it is being mutated.\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T02:25:30Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2025-12-23T01:09:54Z"
      },
      "sha": "dce297ac0ad0f35f17ff51c6f2860c2bc50d6349"
    },
    {
      "event": "committed",
      "id": null,
      "node_id": "C_kwDOABII59oAKDc3YzBkZjdiNTlmZjVhM2E3N2QzN2U3NzE0NWYxYTE1N2UwNWRiMTk",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "actor": null,
      "commit_id": null,
      "commit_url": null,
      "created_at": null,
      "html_url": "https://github.com/bitcoin/bitcoin/commit/77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "tree": {
        "sha": "fbf42187fb9b14fbcee2d77bf457e0e67e65bcd8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fbf42187fb9b14fbcee2d77bf457e0e67e65bcd8"
      },
      "verification": {
        "verified": true,
        "reason": "valid",
        "payload": "tree fbf42187fb9b14fbcee2d77bf457e0e67e65bcd8\nparent dce297ac0ad0f35f17ff51c6f2860c2bc50d6349\nauthor Andrew Toth <andrewstoth@gmail.com> 1768414641 -0500\ncommitter Andrew Toth <andrewstoth@gmail.com> 1769739930 -0500\n\nvalidation: fetch inputs on parallel threads\n\nSpawn a fixed pool of worker threads (default 4) that fetch coins in parallel.\nWorkers wait at the barrier until StartFetching() signals work is available,\nthen race to claim and fetch inputs from the queue.\n\nOnce all inputs have been fetched, the workers wait at the barrier until the\nmain thread arrives via StopFetching().\n\nThe destructor arrives at the barrier a final time with an empty m_inputs,\nwhich signals to the threads to exit their loop.\n\n> coins: filter inputs created in same block before fetching\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,970,543.00 |              507.47 |    4.0% |   32,640,039.00 |    4,760,784.00 |  6.856 |   5,506,291.00 |    1.2% |      0.02 | CoinsViewCacheAsyncBenchmark\n> validation: fetch inputs on parallel threads\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,601,969.00 |              624.23 |    2.9% |    8,345,989.00 |    2,232,468.00 |  3.738 |   1,089,340.00 |    1.8% |      0.03 | CoinsViewCacheAsyncBenchmark\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>\n",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEISytpz6vNK/yCogaYAB6/Ik4sBgFAml8FpoACgkQYAB6/Ik4\nsBi0Pw/+JqejN1CmrzBnJETYkwUVXOpL0MDe6HPE2GPAApKE0wUTQyBnC37fWSok\nRywMqUhw0O3TJ9vOSQXG8BpFcdURMzWNxNT4b1rzNrxzFCk2KfTZy+/jkUn/ceaD\nQnHw5U+JNyU+SRbW6s5/OhXhOyV0QEXvHW6qHZ4TTHGIq4Yvruws7/0C2333yJZL\n8NInEvfoQJlEN2IjbAgKzcjLy7kPowBkAk9Ce7vntwe0UQs82Lly1xglSJ7gufiu\n4vUqzunDmQWBMfNJcOYguaQxJ/gC0KNaYtxurwe/WSWynkERqxZv+zvWijVEuy37\nEpOR7R2am6EV2iXzuKlRVMYaUbZdh+8ibXcX1MRTKv0sWNXf0TEJEO2OGSJFKFeF\nFUSUCgIXEZMvxFEMwtMglTZZv1Qt0qjJgjZjgUflFlWft7xuMeU9yIgGfqcoyIjR\nlhcOoYaIe3WCzf0eCQKj8z1mX3z+YzyTM8Pt8hfbMi0ggtVn0UgfSn7sagseaEbe\ntIikLW/37g9v8wqtzWQ7AxovWzzLAV33IXpXIYdT97Fo6YGbCQR6DD3inYKOkley\nnBFSGbNk9qLuIy6Btj3sA7urAf4DQgVgqymSNqnYzWp0CmGwNNEAwVngD2R+Po7v\n3iLE+6Z4Q/MNslXK7lWjqyz7bvRh885XaooTLkp3KgHH/FOIcwU=\n=kanl\n-----END PGP SIGNATURE-----"
      },
      "parents": [
        {
          "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dce297ac0ad0f35f17ff51c6f2860c2bc50d6349",
          "sha": "dce297ac0ad0f35f17ff51c6f2860c2bc50d6349",
          "html_url": "https://github.com/bitcoin/bitcoin/commit/dce297ac0ad0f35f17ff51c6f2860c2bc50d6349"
        }
      ],
      "message": "validation: fetch inputs on parallel threads\n\nSpawn a fixed pool of worker threads (default 4) that fetch coins in parallel.\nWorkers wait at the barrier until StartFetching() signals work is available,\nthen race to claim and fetch inputs from the queue.\n\nOnce all inputs have been fetched, the workers wait at the barrier until the\nmain thread arrives via StopFetching().\n\nThe destructor arrives at the barrier a final time with an empty m_inputs,\nwhich signals to the threads to exit their loop.\n\n> coins: filter inputs created in same block before fetching\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,970,543.00 |              507.47 |    4.0% |   32,640,039.00 |    4,760,784.00 |  6.856 |   5,506,291.00 |    1.2% |      0.02 | CoinsViewCacheAsyncBenchmark\n> validation: fetch inputs on parallel threads\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\n|        1,601,969.00 |              624.23 |    2.9% |    8,345,989.00 |    2,232,468.00 |  3.738 |   1,089,340.00 |    1.8% |      0.03 | CoinsViewCacheAsyncBenchmark\n\nCo-authored-by: l0rinc <pap.lorinc@gmail.com>",
      "committer": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-30T02:25:30Z"
      },
      "author": {
        "name": "Andrew Toth",
        "email": "andrewstoth@gmail.com",
        "date": "2026-01-14T18:17:21Z"
      },
      "sha": "77c0df7b59ff5a3a77d37e77145f1a157e05db19"
    },
    {
      "event": "head_ref_force_pushed",
      "id": 22393762282,
      "node_id": "HRFPE_lADOABII586bT0I_zwAAAAU2xbHq",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22393762282",
      "actor": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "commit_url": "https://api.github.com/repos/andrewtoth/bitcoin/commits/77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "created_at": "2026-01-30T02:25:38Z"
    },
    {
      "event": "unlabeled",
      "id": 22393996387,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAU2yURj",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22393996387",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-30T02:31:48Z",
      "label": {
        "name": "Needs rebase",
        "color": "cccccc"
      }
    },
    {
      "event": "unlabeled",
      "id": 22396398959,
      "node_id": "UNLE_lADOABII586bT0I_zwAAAAU27e1v",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events/22396398959",
      "actor": {
        "login": "DrahtBot",
        "id": 39886733,
        "node_id": "MDQ6VXNlcjM5ODg2NzMz",
        "avatar_url": "https://avatars.githubusercontent.com/u/39886733?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/DrahtBot",
        "html_url": "https://github.com/DrahtBot",
        "followers_url": "https://api.github.com/users/DrahtBot/followers",
        "following_url": "https://api.github.com/users/DrahtBot/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/DrahtBot/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/DrahtBot/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
        "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
        "repos_url": "https://api.github.com/users/DrahtBot/repos",
        "events_url": "https://api.github.com/users/DrahtBot/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2026-01-30T04:08:10Z",
      "label": {
        "name": "CI failed",
        "color": "cccccc"
      }
    }
  ],
  "comments": [
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812440117",
      "pull_request_review_id": 2388117544,
      "id": 1812440117,
      "node_id": "PRRC_kwDOABII585sB6Q1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Q: Is this a leftover a hack for non-owning LevelDB threads, or is this really the best way to name threads in a cross-platform way?",
      "created_at": "2024-10-23T10:26:47Z",
      "updated_at": "2024-10-23T13:27:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812440117",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812440117"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812531761",
      "pull_request_review_id": 2388117544,
      "id": 1812531761,
      "node_id": "PRRC_kwDOABII585sCQox",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're mostly creating the buckets randomly here, so each thread will need access to basically all of the keys.\r\nSince we have an idea of how LevelDB works here (i.e. Sorted String Table), we could likely improve cache locality (would likely be most beneficial on HDDs) and minimize lock contention by splitting the reads by sorted transactions instead.",
      "created_at": "2024-10-23T11:29:06Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812531761",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812531761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812534028",
      "pull_request_review_id": 2388117544,
      "id": 1812534028,
      "node_id": "PRRC_kwDOABII585sCRMM",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm wondering if we really need to (b)lock here or whether we could we create a [read-only snapshot](https://github.com/google/leveldb/blob/main/doc/index.md#snapshots) instead and avoid stalling?",
      "created_at": "2024-10-23T11:30:32Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812534028",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812534028"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812548418",
      "pull_request_review_id": 2388117544,
      "id": 1812548418,
      "node_id": "PRRC_kwDOABII585sCUtC",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I know it's not trivial request, but can we add a test for this class which fetches everything in parallel and sequentially and assert that the result is equivalent?\r\nAnd preferably also a benchmark, like we have it for https://github.com/bitcoin/bitcoin/blob/master/src/bench/checkqueue.cpp.\r\nI would gladly help here, if needed.",
      "created_at": "2024-10-23T11:39:06Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812548418",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812548418"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812560601",
      "pull_request_review_id": 2388117544,
      "id": 1812560601,
      "node_id": "PRRC_kwDOABII585sCXrZ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "For consistency (see: `explicit CCheckQueue(unsigned int batch_size, int worker_threads_num)`) and simplicity (`m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)}`, and to follow modern C++ directions where sizes seem to be preferred as signed values, see: https://github.com/bitcoin/bitcoin/pull/30927#discussion_r1766881296), please consider making these int(s) instead.",
      "created_at": "2024-10-23T11:46:37Z",
      "updated_at": "2024-10-23T12:47:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812560601",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812560601"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812599960",
      "pull_request_review_id": 2388117544,
      "id": 1812599960,
      "node_id": "PRRC_kwDOABII585sChSY",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Unlike the script checks, these fetches aren't CPU bound, there is no reason to provide the number of CPUs as the number of parallels threads.\r\nI don't know if we care about HDD performance here or not, but we can likely find a multiplier that makes this better for both SSD and HDD.\r\n\r\nQuoting from https://pkolaczk.github.io/disk-parallelism:\r\n> It was surprising to me that even 64 threads, which are far more than the number of CPU cores (4 physical, 8 virtual), still improved the performance. I guess that with requests of such a small size to such a fast storage, you need to submit really many of them to keep the SSD busy.\r\n\r\nIf we can provide a benchmark for this usecase we can likely find an optimal multiplier here - I won't nack but this part is very important for me.",
      "created_at": "2024-10-23T12:07:45Z",
      "updated_at": "2024-10-23T12:44:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812599960",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812599960"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812604307",
      "pull_request_review_id": 2388117544,
      "id": 1812604307,
      "node_id": "PRRC_kwDOABII585sCiWT",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Would it be possible to create the batch sizes dynamically?\r\nSince the number of missing values differs for every block (and every dbcache size), it may not make more sense to calculate the optimal split instead of using the random value of 128.\r\nCoroutines might alleviate this problem.",
      "created_at": "2024-10-23T12:10:35Z",
      "updated_at": "2024-10-23T13:37:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812604307",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812604307"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812606720",
      "pull_request_review_id": 2388117544,
      "id": 1812606720,
      "node_id": "PRRC_kwDOABII585sCi8A",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));\n+                    buffer.clear();\n+                    buffer.reserve(m_batch_size);\n+                }\n+            }\n+            txids.insert(tx->GetHash());\n+        }\n+\n+        Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 197,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Do we always have leftovers or will this process the last batch twice (or process an empty one) if the batch happens to be divisible by batch_size?",
      "created_at": "2024-10-23T12:11:58Z",
      "updated_at": "2024-10-23T13:37:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812606720",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812606720"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812659221",
      "pull_request_review_id": 2388117544,
      "id": 1812659221,
      "node_id": "PRRC_kwDOABII585sCvwV",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're basically mimicking RocksDB's `MultiGet` here - but prewarming the cache instead in separate get requests, since we can't really access LevelDB's internals.\r\n\r\nSince splitting into buckets isn't trivial and since `MultiGet` seems to rely on C++20 [coroutines](https://en.cppreference.com/w/cpp/language/coroutines) (which wasn't available in 2012 when `CCheckQueue` was written), I'm wondering how much simpler this fetching would be if we had lightweight suspendible threads instead: https://rocksdb.org/blog/2022/10/07/asynchronous-io-in-rocksdb.html#multiget",
      "created_at": "2024-10-23T12:35:29Z",
      "updated_at": "2024-10-23T13:37:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812659221",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812659221"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812779405",
      "pull_request_review_id": 2388734949,
      "id": 1812779405,
      "node_id": "PRRC_kwDOABII585sDNGN",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is blocking so we can access the queue of shared outpoints that we need to fetch from. It is not blocking for LevelDB, we access the db once we are out of the critical section.",
      "created_at": "2024-10-23T13:34:07Z",
      "updated_at": "2024-10-23T13:34:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812779405",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812779405"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812781136",
      "pull_request_review_id": 2388740849,
      "id": 1812781136,
      "node_id": "PRRC_kwDOABII585sDNhQ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I can add these but I am waiting for some more conceptual support.",
      "created_at": "2024-10-23T13:35:04Z",
      "updated_at": "2024-10-23T13:35:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812781136",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812781136"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812785573",
      "pull_request_review_id": 2388754731,
      "id": 1812785573,
      "node_id": "PRRC_kwDOABII585sDOml",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));\n+                    buffer.clear();\n+                    buffer.reserve(m_batch_size);\n+                }\n+            }\n+            txids.insert(tx->GetHash());\n+        }\n+\n+        Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 197,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812606720,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It won't process twice, but it could pass in an empty vector, which is ignored if you look at `Add` implementation.",
      "created_at": "2024-10-23T13:37:19Z",
      "updated_at": "2024-10-23T13:37:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812785573",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812785573"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812794214",
      "pull_request_review_id": 2388768186,
      "id": 1812794214,
      "node_id": "PRRC_kwDOABII585sDQtm",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think it would be similar in complexity, we would still need all the locking mechanisms to prevent multithreaded access.\r\n\r\nWhat would really be great is if we had a similar construction to Rust's `std::sync::mpsc`.",
      "created_at": "2024-10-23T13:40:49Z",
      "updated_at": "2024-10-23T13:40:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812794214",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812794214"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812797796",
      "pull_request_review_id": 2388773991,
      "id": 1812797796,
      "node_id": "PRRC_kwDOABII585sDRlk",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812604307,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure it would warrant the complexity I think this batch size is \"good enough\" for now. In a follow up we could maybe add ways to set this with configs to experiment if there really is more optimal settings.",
      "created_at": "2024-10-23T13:42:02Z",
      "updated_at": "2024-10-23T13:42:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812797796",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812797796"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812800076",
      "pull_request_review_id": 2388778745,
      "id": 1812800076,
      "node_id": "PRRC_kwDOABII585sDSJM",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Adding more threads will require more memory, which is one reason to not use many more.\r\n\r\nI did a benchmark using 64 threads on the same 16 vcore machine, and it was slightly slower :/",
      "created_at": "2024-10-23T13:43:08Z",
      "updated_at": "2024-10-23T13:43:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812800076",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812800076"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812807883",
      "pull_request_review_id": 2388792724,
      "id": 1812807883,
      "node_id": "PRRC_kwDOABII585sDUDL",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think there is any lock contention here if we are doing multithreaded reading?\r\n\r\nI also think what you're suggesting would add a lot more complexity to this PR, when this is \"good enough\".",
      "created_at": "2024-10-23T13:46:50Z",
      "updated_at": "2024-10-23T13:46:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812807883",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812807883"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812815888",
      "pull_request_review_id": 2388804635,
      "id": 1812815888,
      "node_id": "PRRC_kwDOABII585sDWAQ",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Unsure, copied from `CScriptCheck`. If the state of the art of thread naming has advanced since that was written, please let me know!",
      "created_at": "2024-10-23T13:49:23Z",
      "updated_at": "2024-10-23T13:49:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812815888",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812815888"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812826580",
      "pull_request_review_id": 2388824311,
      "id": 1812826580,
      "node_id": "PRRC_kwDOABII585sDYnU",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The C++ standard library does as far as I know have no way of renaming threads at all. `src/util/threadnames.{h,cpp}` is our wrapper around the various platform-dependent ways of doing so on supported systems.",
      "created_at": "2024-10-23T13:54:03Z",
      "updated_at": "2024-10-23T13:54:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812826580",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812826580"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812838378",
      "pull_request_review_id": 2388842458,
      "id": 1812838378,
      "node_id": "PRRC_kwDOABII585sDbfq",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can you tell me why we need to prevent multithreaded access exactly? We could collect the values to different vectors, each one accessed only by a single thread and merge them into the cache at the end on a single thread, right?\r\n \r\n How would `mpsc` solve this better? Do you think we need work stealing to make it perfectly parallel? Wouldn't coroutines already achieve the same?",
      "created_at": "2024-10-23T13:58:56Z",
      "updated_at": "2024-10-23T13:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812838378",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812838378"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812842053",
      "pull_request_review_id": 2388848761,
      "id": 1812842053,
      "node_id": "PRRC_kwDOABII585sDcZF",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "4x may be too much to begin with, but 1.5-2x sounds plausible, I'll help with benchmarking this once my current batches finish.",
      "created_at": "2024-10-23T14:00:53Z",
      "updated_at": "2024-10-23T14:00:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812842053",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812842053"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812845859",
      "pull_request_review_id": 2388855957,
      "id": 1812845859,
      "node_id": "PRRC_kwDOABII585sDdUj",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This might be as simple as sorting by tx before we create the buckets.",
      "created_at": "2024-10-23T14:02:34Z",
      "updated_at": "2024-10-23T14:02:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812845859",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812845859"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812849403",
      "pull_request_review_id": 2388859978,
      "id": 1812849403,
      "node_id": "PRRC_kwDOABII585sDeL7",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 151,
      "commit_id": "45c8f0c0deac0af6faecc85c1c26c9498e782409",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812440117,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thank you, please resolve the comment.",
      "created_at": "2024-10-23T14:03:52Z",
      "updated_at": "2024-10-23T14:03:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812849403",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812849403"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 169,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812852143",
      "pull_request_review_id": 2388864249,
      "id": 1812852143,
      "node_id": "PRRC_kwDOABII585sDe2v",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As mentioned before, why do we need shared outpoints here?",
      "created_at": "2024-10-23T14:04:56Z",
      "updated_at": "2024-10-23T14:04:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812852143",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812852143"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812858116",
      "pull_request_review_id": 2388874771,
      "id": 1812858116,
      "node_id": "PRRC_kwDOABII585sDgUE",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I haven't yet experimented with them, but as far as I understand it, coroutines are just programming paradigm, not magic; they don't do anything of their own, besides making things that were already possible easier to write. In particular, you still need a thread pool or some mechanism for scheduling how to run them,",
      "created_at": "2024-10-23T14:07:08Z",
      "updated_at": "2024-10-23T14:07:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812858116",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812858116"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812862679",
      "pull_request_review_id": 2388882032,
      "id": 1812862679,
      "node_id": "PRRC_kwDOABII585sDhbX",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> We could collect the values to different vectors, each one accessed only by a single thread and merge them into the cache at the end on a single thread\r\n\r\nIf the vectors are thread local, then how can the main thread access them at the end to write them? We also want to be writing throughout while the workers are fetching, not just at the end.\r\n\r\n> How would mpsc solve this better?\r\n\r\nInstead of each worker thread having a local queue of results, which they then append to the global results queue, they could just push each result to the channel individually. The main thread could just pull results off the channel as they arrive, instead of waiting to be awoken by a worker thread that appended all its results to the global queue.\r\n\r\n> work stealing\r\n\r\nThat is a concept for async rust, or `std::async::mpsc`. We can do all this without introducing an async runtime. But, this is getting off topic.",
      "created_at": "2024-10-23T14:09:31Z",
      "updated_at": "2024-10-23T14:09:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812862679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812862679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812869347",
      "pull_request_review_id": 2388892235,
      "id": 1812869347,
      "node_id": "PRRC_kwDOABII585sDjDj",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {\n+                    Add(std::move(buffer));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812531761,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "If a benchmark shows that it is better, then great!",
      "created_at": "2024-10-23T14:12:37Z",
      "updated_at": "2024-10-23T14:17:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812869347",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812869347"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812874933",
      "pull_request_review_id": 2388902089,
      "id": 1812874933,
      "node_id": "PRRC_kwDOABII585sDka1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The main thread adds all outpoints to a global vector, which all workers will fetch their work from.",
      "created_at": "2024-10-23T14:15:35Z",
      "updated_at": "2024-10-23T14:17:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1812874933",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1812874933"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813017536",
      "pull_request_review_id": 2389159040,
      "id": 1813017536,
      "node_id": "PRRC_kwDOABII585sEHPA",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> coroutines are just programming paradigm, not magic\r\n\r\nThat's also what I was counting on! :D\r\n\r\nIn RocksDB they have [high and low priority work](https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide#parallelism-options) (I assume that's just added to the front or the back of a background work deque) â€“ this could align well with @furszy's suggestion for mixing different kinds of background work units.\r\n\r\nI haven't used the C++ variant of coroutines either, but my thinking was that since they can theoretically yield execution when waiting for IO (and resume later), this would allow threads to focus on other tasks in the meantime. Combined with an appropriate scheduling mechanism (such as a thread pool), we could maximize both CPU and IO usage, if I'm not mistaken.\r\nInstead of each thread handling just one task, it could suspend a coroutine while waiting on IO (e.g., a database fetch) and resume it later, effectively maximizing CPU and IO work without needing to know the exact details of the work.\r\n\r\n> If the vectors are thread local\r\n\r\nThe vector would still be global, but each thread would only access a single bucket (i.e. global vector of vectors, with each thread from the pool writing only to `vector[thread_id]`, which contains a vector of fetched coins).\r\nWhen all the work is finished, we'd iterate over the global vector and merge the results into the cache on a single thread.\r\nAs mentioned, sorting the outpoints before fetching could help improve data locality and reduce lock contention, and the coroutines above would help with work stealing, ensuring that all threads finish roughly at the same time.\r\n\r\nIs there anything prohibiting us from doing something like this to minimize synchronization and lock contention during the fetch phase? I understand some synchronization would still be needed during the merge, but this could help reduce global locks and unnecessary synchronization throughout the process.\r\n",
      "created_at": "2024-10-23T15:15:39Z",
      "updated_at": "2024-10-23T15:18:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1813017536",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813017536"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813041419",
      "pull_request_review_id": 2389202333,
      "id": 1813041419,
      "node_id": "PRRC_kwDOABII585sENEL",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I haven't used the C++ variant of coroutines either, but my thinking was that since they can theoretically yield execution when waiting for IO (and resume later), this would allow threads to focus on other tasks in the meantime.\r\n\r\nThat needs async I/O, and is unrelated to coroutines, as far as I understand it. Coroutines just help with keeping track of what to do when the reads come back inside rocksdb.\r\n\r\nAs long as LevelDB (or whatever database engine we use) internally does not use async I/O, there will be one (waiting) thread per parallel outstanding read request from the database.",
      "created_at": "2024-10-23T15:28:19Z",
      "updated_at": "2024-10-23T15:28:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1813041419",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1813041419"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832842632",
      "pull_request_review_id": 2421253359,
      "id": 1832842632,
      "node_id": "PRRC_kwDOABII585tPvWI",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (size_t n = 0; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop();\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsViewDB& db, const CBlock& block) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        m_db = &db;\n+\n+        std::vector<COutPoint> buffer{};\n+        buffer.reserve(m_batch_size);\n+        std::set<Txid> txids{};\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) continue;\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint = in.prevout;\n+                // If an input references an outpoint from earlier in the\n+                // block, it won't be in the cache yet but it also won't be\n+                // in the db either.\n+                if (txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (cache.HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+\n+                buffer.emplace_back(outpoint);\n+                if (buffer.size() == m_batch_size) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 188,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812604307,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I changed the batch size to be number of workers.",
      "created_at": "2024-11-07T15:05:53Z",
      "updated_at": "2024-11-07T15:05:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832842632",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832842632"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843082",
      "pull_request_review_id": 2421254123,
      "id": 1832843082,
      "node_id": "PRRC_kwDOABII585tPvdK",
      "diff_hunk": "@@ -6243,6 +6248,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, options.worker_threads_num},\n+      m_input_fetcher{/*batch_size=*/128, static_cast<size_t>(options.worker_threads_num)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 16,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812599960,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added a benchmark to experiment with these.",
      "created_at": "2024-11-07T15:06:09Z",
      "updated_at": "2024-11-07T15:06:09Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832843082",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843082"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6257,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843202",
      "pull_request_review_id": 2421254376,
      "id": 1832843202,
      "node_id": "PRRC_kwDOABII585tPvfC",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n+                // in_flight_fetches_count will only be truthy after first run.\n+                if (in_flight_fetches_count) {\n+                    if (m_pairs.empty()) {\n+                        m_pairs = std::move(pairs);\n+                    } else {\n+                        m_pairs.reserve(m_pairs.size() + pairs.size());\n+                        m_pairs.insert(m_pairs.end(), std::make_move_iterator(pairs.begin()),\n+                                       std::make_move_iterator(pairs.end()));\n+                    }\n+                    m_in_flight_fetches_count -= in_flight_fetches_count;\n+                    m_main_cv.notify_one();\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_outpoints.empty() && !m_request_stop) {\n+                    m_worker_cv.wait(lock);\n+                }\n+                if (m_request_stop) {\n+                    return;\n+                }\n+\n+                const auto even_bucket{m_in_flight_fetches_count / m_worker_threads.size()};\n+                in_flight_fetches_count = std::max(static_cast<size_t>(1),\n+                                                   std::min(std::min(m_outpoints.size(), m_batch_size), even_bucket));\n+                auto start_it = m_outpoints.end() - in_flight_fetches_count;\n+                outpoints.assign(std::make_move_iterator(start_it), std::make_move_iterator(m_outpoints.end()));\n+                m_outpoints.erase(start_it, m_outpoints.end());\n+            }\n+\n+            pairs.clear();\n+            pairs.reserve(outpoints.size());\n+            for (COutPoint& outpoint : outpoints) {\n+                Coin coin;\n+                if (!m_db->GetCoin(outpoint, coin)) {\n+                    // Missing an input, just break. This block will fail validation, so no point in continuing.\n+                    break;\n+                }\n+                pairs.emplace_back(std::move(outpoint), std::move(coin));\n+            }\n+        } while (true);\n+    }\n+\n+    //! Add a batch of outpoints to the queue\n+    void Add(std::vector<COutPoint>&& outpoints) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (outpoints.empty()) {\n+            return;\n+        }\n+\n+        const auto size{outpoints.size()};\n+        {\n+            LOCK(m_mutex);\n+            m_in_flight_fetches_count += outpoints.size();\n+            if (m_outpoints.empty()) {\n+                m_outpoints = std::move(outpoints);\n+            } else {\n+                m_outpoints.insert(m_outpoints.end(), std::make_move_iterator(outpoints.begin()), std::make_move_iterator(outpoints.end()));\n+            }\n+        }\n+\n+        if (size == 1) {\n+            m_worker_cv.notify_one();\n+        } else {\n+            m_worker_cv.notify_all();\n+        }\n+    }\n+\n+\n+public:\n+    //! Create a new input fetcher\n+    explicit InputFetcher(size_t batch_size, size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812560601,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-11-07T15:06:14Z",
      "updated_at": "2024-11-07T15:06:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832843202",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832843202"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 145,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832844237",
      "pull_request_review_id": 2421256210,
      "id": 1832844237,
      "node_id": "PRRC_kwDOABII585tPvvN",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added tests and benchmark.\r\nThe test has random parameters, one of which would be end up having a single worker thread.",
      "created_at": "2024-11-07T15:06:54Z",
      "updated_at": "2024-11-07T15:06:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1832844237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1832844237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1845238389",
      "pull_request_review_id": 2440804044,
      "id": 1845238389,
      "node_id": "PRRC_kwDOABII585t_Bp1",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 29,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812548418,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Also added fuzz harness",
      "created_at": "2024-11-16T20:59:12Z",
      "updated_at": "2024-11-16T20:59:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1845238389",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1845238389"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846665944",
      "pull_request_review_id": 2442755733,
      "id": 1846665944,
      "node_id": "PRRC_kwDOABII585uEeLY",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This will create very long running inputs (e.g. txs = std::numeric_limits<uint32_t>::max()).\r\n\r\n```suggestion\r\n    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), N) {\r\n```\r\n\r\nor\r\n\r\n```suggestion\r\n    LIMITED_WHILE(fuzzed_data_provider.remaining_bytes(), N) {\r\n```",
      "created_at": "2024-11-18T14:16:51Z",
      "updated_at": "2024-11-18T14:22:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846665944",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846665944"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 30,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846667260",
      "pull_request_review_id": 2442755733,
      "id": 1846667260,
      "node_id": "PRRC_kwDOABII585uEef8",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {\n+        CMutableTransaction tx;\n+\n+        const auto inputs{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+        for (uint32_t j{0}; j < inputs; ++j) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 36,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": null,
      "user": {
        "login": "dergoegge",
        "id": 8077169,
        "node_id": "MDQ6VXNlcjgwNzcxNjk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/dergoegge",
        "html_url": "https://github.com/dergoegge",
        "followers_url": "https://api.github.com/users/dergoegge/followers",
        "following_url": "https://api.github.com/users/dergoegge/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/dergoegge/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/dergoegge/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
        "organizations_url": "https://api.github.com/users/dergoegge/orgs",
        "repos_url": "https://api.github.com/users/dergoegge/repos",
        "events_url": "https://api.github.com/users/dergoegge/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/dergoegge/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Same as above, this will create long running inputs and maybe even run out of memory?",
      "created_at": "2024-11-18T14:17:42Z",
      "updated_at": "2024-11-18T14:22:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846667260",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846667260"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 35,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846954861",
      "pull_request_review_id": 2443219199,
      "id": 1846954861,
      "node_id": "PRRC_kwDOABII585uFktt",
      "diff_hunk": "@@ -0,0 +1,73 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <inputfetcher.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <cstdint>\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 15)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    CCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache cache(&db);\n+\n+    CBlock block;\n+    Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+    const auto txs{fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1,\n+        std::numeric_limits<uint32_t>::max())};\n+    for (uint32_t i{0}; i < txs; ++i) {",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "2bd5f0f03b19d1b71953ac51a5809014c232a497",
      "in_reply_to_id": 1846665944,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks, done!",
      "created_at": "2024-11-18T17:04:07Z",
      "updated_at": "2024-11-18T17:04:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1846954861",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1846954861"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 30,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 36,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1848485522",
      "pull_request_review_id": 2445676953,
      "id": 1848485522,
      "node_id": "PRRC_kwDOABII585uLaaS",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": null,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Should this rather say \"optionally marking the emplaced coin as not dirty\", since the default is always dirty?",
      "created_at": "2024-11-19T14:38:21Z",
      "updated_at": "2024-11-20T18:48:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1848485522",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1848485522"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850828070",
      "pull_request_review_id": 2449452592,
      "id": 1850828070,
      "node_id": "PRRC_kwDOABII585uUWUm",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure that's the best though, since we do not mark a coin as not dirty. That is the default state.\r\n\r\nWhat about\r\n\"marking the coin as dirty unless `set_dirty` is set to false\"?",
      "created_at": "2024-11-20T18:53:20Z",
      "updated_at": "2024-11-20T18:53:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1850828070",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850828070"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850853460",
      "pull_request_review_id": 2449493581,
      "id": 1850853460,
      "node_id": "PRRC_kwDOABII585uUchU",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "That sounds good to me :+1: ",
      "created_at": "2024-11-20T19:15:26Z",
      "updated_at": "2024-11-20T19:15:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1850853460",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1850853460"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1851032146",
      "pull_request_review_id": 2449778426,
      "id": 1851032146,
      "node_id": "PRRC_kwDOABII585uVIJS",
      "diff_hunk": "@@ -416,13 +416,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     void AddCoin(const COutPoint& outpoint, Coin&& coin, bool possible_overwrite);\n \n     /**\n-     * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * Emplace a coin into cacheCoins without performing any checks, optionally\n+     * marking the emplaced coin as dirty.",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 7,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3a4af5507146b015cc754195c89c70e1ad8404cd",
      "in_reply_to_id": 1848485522,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-11-20T21:56:03Z",
      "updated_at": "2024-11-20T21:56:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1851032146",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1851032146"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 420,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859189838",
      "pull_request_review_id": 2462618817,
      "id": 1859189838,
      "node_id": "PRRC_kwDOABII585u0PxO",
      "diff_hunk": "@@ -0,0 +1,200 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    SeedRandomForTest(SeedRand::ZEROS);\n+\n+    const auto cores{GetNumCores()};\n+    const auto num_txs{m_rng.randrange(cores * 10)};\n+    const auto block{CreateBlock(num_txs)};\n+    const auto batch_size{m_rng.randrange<int32_t>(block.vtx.size() * 2)};\n+    const auto worker_threads{m_rng.randrange(cores * 2)};\n+    InputFetcher fetcher{batch_size, worker_threads};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3c201bcffc1d7e382e8afa9a88750a4c261c1cf8",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 3c201bcffc1d7e382e8afa9a88750a4c261c1cf8 \"tests: add inputfetcher tests\"\r\nYou can set this up in `InputFetcherTest` so that you don't have to repeat it in the rest of the tests.",
      "created_at": "2024-11-26T20:31:21Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859189838",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859189838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 50,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859192217",
      "pull_request_review_id": 2462618817,
      "id": 1859192217,
      "node_id": "PRRC_kwDOABII585u0QWZ",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 2349ac7d6071746a80223358bce0d5e556b277d7 \"bench: add inputfetcher bench\"\r\nHow did you select this batch size?",
      "created_at": "2024-11-26T20:33:51Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859192217",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859192217"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859204841",
      "pull_request_review_id": 2462618817,
      "id": 1859204841,
      "node_id": "PRRC_kwDOABII585u0Tbp",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 19,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": null,
      "user": {
        "login": "ismaelsadeeq",
        "id": 48946461,
        "node_id": "MDQ6VXNlcjQ4OTQ2NDYx",
        "avatar_url": "https://avatars.githubusercontent.com/u/48946461?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/ismaelsadeeq",
        "html_url": "https://github.com/ismaelsadeeq",
        "followers_url": "https://api.github.com/users/ismaelsadeeq/followers",
        "following_url": "https://api.github.com/users/ismaelsadeeq/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/ismaelsadeeq/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/ismaelsadeeq/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/ismaelsadeeq/subscriptions",
        "organizations_url": "https://api.github.com/users/ismaelsadeeq/orgs",
        "repos_url": "https://api.github.com/users/ismaelsadeeq/repos",
        "events_url": "https://api.github.com/users/ismaelsadeeq/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/ismaelsadeeq/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In 2349ac7d6071746a80223358bce0d5e556b277d7 \"bench: add inputfetcher bench\"\r\nnit: will be nice if we have `block413567` input's data that we can read so that we dont have to simulate this.",
      "created_at": "2024-11-26T20:47:18Z",
      "updated_at": "2024-11-26T20:55:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1859204841",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1859204841"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868551853",
      "pull_request_review_id": 2477040586,
      "id": 1868551853,
      "node_id": "PRRC_kwDOABII585vX9at",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        size_t in_flight_fetches_count{0};\n+        std::vector<std::pair<COutPoint, Coin>> pairs{};\n+        do {\n+            std::vector<COutPoint> outpoints{};\n+            outpoints.reserve(m_batch_size);\n+            {\n+                WAIT_LOCK(m_mutex, lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812534028,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We no longer need to block on the shared outpoints vector. We write to it once in the main thread before notifying the other threads and then only read from it afterwards.",
      "created_at": "2024-12-04T00:56:57Z",
      "updated_at": "2024-12-04T00:56:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868551853",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868551853"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552609",
      "pull_request_review_id": 2477041647,
      "id": 1868552609,
      "node_id": "PRRC_kwDOABII585vX9mh",
      "diff_hunk": "@@ -0,0 +1,200 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/transaction_identifier.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    SeedRandomForTest(SeedRand::ZEROS);\n+\n+    const auto cores{GetNumCores()};\n+    const auto num_txs{m_rng.randrange(cores * 10)};\n+    const auto block{CreateBlock(num_txs)};\n+    const auto batch_size{m_rng.randrange<int32_t>(block.vtx.size() * 2)};\n+    const auto worker_threads{m_rng.randrange(cores * 2)};\n+    InputFetcher fetcher{batch_size, worker_threads};",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "3c201bcffc1d7e382e8afa9a88750a4c261c1cf8",
      "in_reply_to_id": 1859189838,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2024-12-04T00:58:01Z",
      "updated_at": "2024-12-04T00:58:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868552609",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552609"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 50,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552959",
      "pull_request_review_id": 2477042136,
      "id": 1868552959,
      "node_id": "PRRC_kwDOABII585vX9r_",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is the hardcoded batch size used in CheckQueue. Not sure why that was selected, but I deferred to previous choices.",
      "created_at": "2024-12-04T00:58:35Z",
      "updated_at": "2024-12-04T00:58:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868552959",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868552959"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868553486",
      "pull_request_review_id": 2477042938,
      "id": 1868553486,
      "node_id": "PRRC_kwDOABII585vX90O",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 19,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859204841,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We're reading the previous outpoints of that block's inputs, which are in many other previous blocks. So, not sure this is feasible.",
      "created_at": "2024-12-04T00:59:31Z",
      "updated_at": "2024-12-04T00:59:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r1868553486",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1868553486"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2083465171",
      "pull_request_review_id": 2831320761,
      "id": 2083465171,
      "node_id": "PRRC_kwDOABII5858LyfT",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can we let the objects do the job instead of querying their internals and doing it ourselves (\"tell, don't ask\"):\r\n```suggestion\r\n        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);\r\n```",
      "created_at": "2025-05-11T09:26:33Z",
      "updated_at": "2025-09-29T17:13:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2083465171",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2083465171"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2173389714",
      "pull_request_review_id": 2968760335,
      "id": 2173389714,
      "node_id": "PRRC_kwDOABII586Bi0uS",
      "diff_hunk": "@@ -0,0 +1,237 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <iterator>\n+#include <set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread pushes batches of outpoints\n+ * onto the queue, where they are fetched by N worker threads. The resulting\n+ * coins are pushed onto another queue after they are read from disk. When\n+ * the main is done adding outpoints, it starts writing the results of the read\n+ * queue to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    //! The queue of outpoints to be fetched from disk.\n+    //! As the order of outpoints doesn't matter, it is used as a LIFO (stack)\n+    std::vector<COutPoint> m_outpoints GUARDED_BY(m_mutex){};\n+\n+    //! The queue of pairs to be written to the cache.\n+    std::vector<std::pair<COutPoint, Coin>> m_pairs GUARDED_BY(m_mutex){};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that are no longer queued, but still in the\n+     * worker's own batches.\n+     */\n+    size_t m_in_flight_fetches_count GUARDED_BY(m_mutex){0};\n+\n+    //! The maximum number of outpoints to be processed in one batch\n+    const size_t m_batch_size;\n+\n+    //! DB to fetch from.\n+    const CCoinsViewDB* m_db{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    /** Internal function that does the fetching from disk. */\n+    void Loop() noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 65,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "e9e23b59f8eedb8dfae75aa660328299fba92b50",
      "in_reply_to_id": 1812659221,
      "user": {
        "login": "HowHsu",
        "id": 38499194,
        "node_id": "MDQ6VXNlcjM4NDk5MTk0",
        "avatar_url": "https://avatars.githubusercontent.com/u/38499194?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/HowHsu",
        "html_url": "https://github.com/HowHsu",
        "followers_url": "https://api.github.com/users/HowHsu/followers",
        "following_url": "https://api.github.com/users/HowHsu/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/HowHsu/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/HowHsu/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/HowHsu/subscriptions",
        "organizations_url": "https://api.github.com/users/HowHsu/orgs",
        "repos_url": "https://api.github.com/users/HowHsu/repos",
        "events_url": "https://api.github.com/users/HowHsu/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/HowHsu/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": " > Is there anything prohibiting us from doing something like this to minimize synchronization and lock contention during the fetch phase? I understand some synchronization would still be needed during the merge, but this could help reduce global locks and unnecessary synchronization throughout the process.\r\n \r\n As far as I know, the advantage of coroutines over threads is faster context switching, since it doesnâ€™t go through the operating system kernel. This advantage only becomes apparent under extremely high concurrency, such as hundreds of thousands of concurrent tasks. Using coroutines does not eliminate the need for synchronization mechanisms where they are inherently required.\r\n\r\n\r\n",
      "created_at": "2025-06-28T16:06:38Z",
      "updated_at": "2025-06-28T16:06:39Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2173389714",
      "author_association": "NONE",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2173389714"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2376962309",
      "pull_request_review_id": 3264568566,
      "id": 2376962309,
      "node_id": "PRRC_kwDOABII586NrZEF",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "seems a bit odd to have the number of  nodes in a test influence whether or not the test has to be edited to remove or add `-par=1` everywhere. Would it not be easier to just globally set `-par=2` for all funtional tests?\r\n\r\n\r\n```diff\r\ndiff --git a/test/functional/test_framework/util.py b/test/functional/test_framework/util.py\r\nindex e5a5938f07..42bb213dd3 100644\r\n--- a/test/functional/test_framework/util.py\r\n+++ b/test/functional/test_framework/util.py\r\n@@ -459,6 +459,7 @@ def write_config(config_path, *, n, chain, extra_config=\"\", disable_autoconnect=\r\n         f.write(\"printtoconsole=0\\n\")\r\n         f.write(\"natpmp=0\\n\")\r\n         f.write(\"shrinkdebugfile=0\\n\")\r\n+        f.write(\"par=2\\n\")\r\n         # To improve SQLite wallet performance so that the tests don't timeout, use -unsafesqlitesync\r\n         f.write(\"unsafesqlitesync=1\\n\")\r\n         if disable_autoconnect:\r\n",
      "created_at": "2025-09-24T20:16:40Z",
      "updated_at": "2025-09-24T20:16:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2376962309",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2376962309"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2377071137",
      "pull_request_review_id": 3264725425,
      "id": 2377071137,
      "node_id": "PRRC_kwDOABII586Nrzoh",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I wondered if that would be more invasive to other tests though.",
      "created_at": "2025-09-24T21:01:37Z",
      "updated_at": "2025-09-24T21:01:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2377071137",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2377071137"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2378064596",
      "pull_request_review_id": 3266228181,
      "id": 2378064596,
      "node_id": "PRRC_kwDOABII586NvmLU",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It disables the auto-detection for all functional tests by default, which I can't really find a downside to. Also, it removes idle \"spam\" threads while debugging (gdb and other tools will display less script check threads), which also seems beneficial to have?",
      "created_at": "2025-09-25T07:42:08Z",
      "updated_at": "2025-09-25T07:42:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2378064596",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2378064596"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384229679",
      "pull_request_review_id": 3275004800,
      "id": 2384229679,
      "node_id": "PRRC_kwDOABII586OHHUv",
      "diff_hunk": "@@ -136,6 +136,9 @@ def setup_nodes(self):\n         if self.have_unix_sockets:\n             args[5] = ['-listen', f'-proxy=unix:{socket_path}']\n             args[6] = ['-listen', f'-onion=unix:{socket_path}']\n+        # Keep validation threads low to avoid CI thread/pid limits.\n+        # Ensure even empty arg lists get '-par=1'.\n+        args = [a + ['-par=1'] if a else ['-par=1'] for a in args]",
      "path": "test/functional/feature_proxy.py",
      "position": 1,
      "original_position": 6,
      "commit_id": "c6e8499550632f87d6517472038f545e72c173b5",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2376962309,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Makes sense. Done here https://github.com/bitcoin/bitcoin/pull/33485.",
      "created_at": "2025-09-27T16:09:48Z",
      "updated_at": "2025-09-27T16:09:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2384229679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2384229679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 141,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388213294",
      "pull_request_review_id": 2831320761,
      "id": 2388213294,
      "node_id": "PRRC_kwDOABII586OWT4u",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: is there anything in the error that we may want to log?",
      "created_at": "2025-09-29T14:31:49Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388213294",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388213294"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388218975",
      "pull_request_review_id": 2831320761,
      "id": 2388218975,
      "node_id": "PRRC_kwDOABII586OWVRf",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I haven't reviewed it in detail but was wondering why we need locking here, it should be possible to do most of this lock free (especially if we sort the keys first so that threads are more likely to access different regions). I have started reviewing and testing it in detail, but to have some progress I'm sharing my observations as I go along",
      "created_at": "2025-09-29T14:33:42Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388218975",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388218975"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388224454",
      "pull_request_review_id": 2831320761,
      "id": 2388224454,
      "node_id": "PRRC_kwDOABII586OWWnG",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 82,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "instead of the comment, can we express this in the method name?",
      "created_at": "2025-09-29T14:35:05Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388224454",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388224454"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 82,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388236852",
      "pull_request_review_id": 2831320761,
      "id": 2388236852,
      "node_id": "PRRC_kwDOABII586OWZo0",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have tried `std::jthread` in [l0rinc/bitcoin@`6afe2e8` (#40)](https://github.com/l0rinc/bitcoin/pull/40/commits/6afe2e878046703cd71b166a3cf0e53ccd12e478#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69dR1363) but it seems the CI's libc++ doesnâ€™t provide it\r\n\r\nQ: it's just the second commit and we're already doing the fetching on multiple threads. Can we add a single-threaded input fetcher first and add multithreading only as the very last step?",
      "created_at": "2025-09-29T14:38:56Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388236852",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388236852"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388250227",
      "pull_request_review_id": 2831320761,
      "id": 2388250227,
      "node_id": "PRRC_kwDOABII586OWc5z",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what if instead of locking we just iterate every `n`th element (where `n` is the thread index), implicitly dividing the input into `n` buckets without locking. Each thread would work on a distinct set of values - we can pre-filter for existing values on a single thread before forking off. This won't have work stealing, but we can likely assume uniform distribution and the solution would be trivial and lock free.",
      "created_at": "2025-09-29T14:42:49Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388250227",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388250227"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388256954",
      "pull_request_review_id": 2831320761,
      "id": 2388256954,
      "node_id": "PRRC_kwDOABII586OWei6",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 77,
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "could we pre-filter on a single tread and send the results to the fetcher instead? That way we can also decide not to do multi-threaded access for small sets (we can experiment with the values, but we can probably start with set size < nproc should be done on a single thread).",
      "created_at": "2025-09-29T14:44:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388256954",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388256954"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388258759",
      "pull_request_review_id": 2831320761,
      "id": 2388258759,
      "node_id": "PRRC_kwDOABII586OWe_H",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: the curse of long review queues\n```suggestion\n// Copyright (c) 2025-present The Bitcoin Core developers\n```",
      "created_at": "2025-09-29T14:45:09Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388258759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388258759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388269800",
      "pull_request_review_id": 2831320761,
      "id": 2388269800,
      "node_id": "PRRC_kwDOABII586OWhro",
      "diff_hunk": "@@ -423,12 +423,13 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /**\n      * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * the emplaced coin as dirty unless `set_dirty` is `false`.\n      *\n-     * NOT FOR GENERAL USE. Used only when loading coins from a UTXO snapshot.\n+     * NOT FOR GENERAL USE. Used when loading coins from a UTXO snapshot, and\n+     * in the InputFetcher.\n      * @sa ChainstateManager::PopulateAndValidateSnapshot()\n      */\n-    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin);\n+    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty = true);",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "to peel away the preparatory commits, it would simplify review to extract these into tiny, focused PRs - to have some progress, since this PR is in review for some time, but it's a very good change that I'd like to have some progress on.\r\n\r\nnit: I understand the default param is meant to make the diff smaller, but it doesn't help with understanding the effect of the change, to see where this is used and what we're changing",
      "created_at": "2025-09-29T14:48:50Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388269800",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388269800"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388273122",
      "pull_request_review_id": 2831320761,
      "id": 2388273122,
      "node_id": "PRRC_kwDOABII586OWifi",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 7,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca\r\nI had something similar in https://github.com/bitcoin/bitcoin/pull/32313/files#diff-f0ed73d62dae6ca28ebd3045e5fc0d5d02eaaacadb4c2a292985a3fbd7e1c77cR254\r\n\r\nCan you please explain in the commit message why this change is necessary?",
      "created_at": "2025-09-29T14:49:52Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388273122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388273122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 131,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388275122",
      "pull_request_review_id": 2831320761,
      "id": 2388275122,
      "node_id": "PRRC_kwDOABII586OWi-y",
      "diff_hunk": "@@ -6266,6 +6268,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have tested this with different `par` values and surprisingly it barely had any effect. Is it because of the locking?\n\n",
      "created_at": "2025-09-29T14:50:31Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388275122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388275122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388297125",
      "pull_request_review_id": 2831320761,
      "id": 2388297125,
      "node_id": "PRRC_kwDOABII586OWoWl",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        cachedCoinsUsage += mem_usage;",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 11,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this seems like a change in behavior, but it assumed that the coin was never in the cache - though `if (inserted)` didn't help with understanding this, so it likely isn't.\r\n\r\nIs that still something that we can assume - hence the \"danger\", right?\r\nAnd if it's always inserted, does the insertion guard still make sense? It's a bit even more confusing now :/",
      "created_at": "2025-09-29T14:57:23Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388297125",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388297125"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 135,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388303800",
      "pull_request_review_id": 2831320761,
      "id": 2388303800,
      "node_id": "PRRC_kwDOABII586OWp-4",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 24,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\r\n```",
      "created_at": "2025-09-29T14:59:38Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388303800",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388303800"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 23,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388307927",
      "pull_request_review_id": 2831320761,
      "id": 2388307927,
      "node_id": "PRRC_kwDOABII586OWq_X",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 27,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "do we need to write to a global vector or can we safely iterate the prevouts directly from each thread?",
      "created_at": "2025-09-29T15:00:53Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388307927",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388307927"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 26,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 27,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388318316",
      "pull_request_review_id": 2831320761,
      "id": 2388318316,
      "node_id": "PRRC_kwDOABII586OWths",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Q: do we really need the main thread to be part of this? I expect this to be disk bound and not CPU restricted, we should be able to go beyond `nproc`, so it should be safe to leave the main thread out of this as far as I can tell...",
      "created_at": "2025-09-29T15:04:17Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388318316",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388318316"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388399879",
      "pull_request_review_id": 2831320761,
      "id": 2388399879,
      "node_id": "PRRC_kwDOABII586OXBcH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "as mentioned before I think it should be safe to pre-filter on a single thread instead",
      "created_at": "2025-09-29T15:28:53Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388399879",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388399879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388409573",
      "pull_request_review_id": 2831320761,
      "id": 2388409573,
      "node_id": "PRRC_kwDOABII586OXDzl",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 127,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what if this ends up on different threads, i.e. a spend from an earlier outpoint processed on a different thread? Wouldn't we take care of those automatically? We can likely skip all values that are not found, since we will revalidate everything after this cache warming call - we just have to document that it's theoretically possible that some values won't be in the cache after this call (though the internal spends should be added, just in a different thread, right?).",
      "created_at": "2025-09-29T15:31:41Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388409573",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388409573"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388412343",
      "pull_request_review_id": 2831320761,
      "id": 2388412343,
      "node_id": "PRRC_kwDOABII586OXEe3",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "do we really care about this, it's not our job here to validate, just fetch whatever we can, the validation will happen after this pre-warming.",
      "created_at": "2025-09-29T15:32:29Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388412343",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388412343"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388419154",
      "pull_request_review_id": 2831320761,
      "id": 2388419154,
      "node_id": "PRRC_kwDOABII586OXGJS",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 162,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what's the reason for allowing negative `worker_thread_count`? In other cases I think it was used to signal how many CPUs to reserve, but that doesn't seem to be the case here, and since we're claming to min of 0, consider:\r\n```suggestion\r\n        if (worker_thread_count == 0) {\r\n```",
      "created_at": "2025-09-29T15:34:56Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388419154",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388419154"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 151,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388427056",
      "pull_request_review_id": 2831320761,
      "id": 2388427056,
      "node_id": "PRRC_kwDOABII586OXIEw",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 192,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can we maybe do something like this instead?\r\n```suggestion\r\n        if (block.vtx.size() < m_worker_threads.size()) {\r\n```",
      "created_at": "2025-09-29T15:37:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388427056",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388427056"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388430113",
      "pull_request_review_id": 2831320761,
      "id": 2388430113,
      "node_id": "PRRC_kwDOABII586OXI0h",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we avoid mutating the state in a multithreaded class for safety? It's easier to follow along knowing that the class is immutable and the state is passed along...",
      "created_at": "2025-09-29T15:38:31Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388430113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388430113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388436958",
      "pull_request_review_id": 2831320761,
      "id": 2388436958,
      "node_id": "PRRC_kwDOABII586OXKfe",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 51,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we add these tests before the multithreading change - having a single-threaded InputFetcher first, adding tests and benchmarks after and doing the actual multithreading as a very last step. That would construct the whole scenario in smaller steps, proving that every change is safe",
      "created_at": "2025-09-29T15:40:35Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388436958",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388436958"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388439344",
      "pull_request_review_id": 2831320761,
      "id": 2388439344,
      "node_id": "PRRC_kwDOABII586OXLEw",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand why benchmarks need predictability, but wouldn't we want variance for tests?",
      "created_at": "2025-09-29T15:41:15Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388439344",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388439344"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388449458",
      "pull_request_review_id": 2831320761,
      "id": 2388449458,
      "node_id": "PRRC_kwDOABII586OXNiy",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto batch_size{m_rng.randrange<int32_t>(m_block->vtx.size() * 2)};\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(batch_size, worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView db;\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+class ThrowCoinsView : public CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        throw std::runtime_error(\"database error\");",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 171,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "consider `std::terminate`",
      "created_at": "2025-09-29T15:44:14Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388449458",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388449458"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 162,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388454027",
      "pull_request_review_id": 2831320761,
      "id": 2388454027,
      "node_id": "PRRC_kwDOABII586OXOqL",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I would prefer retesting those assumptions (I don't even think we need a batch here)",
      "created_at": "2025-09-29T15:45:38Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388454027",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388454027"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388459245",
      "pull_request_review_id": 2831320761,
      "id": 2388459245,
      "node_id": "PRRC_kwDOABII586OXP7t",
      "diff_hunk": "@@ -0,0 +1,153 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(batch_size * worker_threads * 2)) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin),\n+                        /*set_dirty=*/fuzzed_data_provider.ConsumeBool());\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);\n+\n+        for (const auto& [outpoint, pair] : db_map) {\n+            // Check pre-existing coins in the cache have not been updated\n+            const auto it{cache_map.find(outpoint)};\n+            if (it != cache_map.end()) {\n+                const auto& cache_coin{it->second};\n+                const auto& coin{cache.AccessCoin(outpoint)};\n+                assert(coin.IsSpent() == cache_coin.IsSpent());\n+                assert(coin.fCoinBase == cache_coin.fCoinBase);\n+                assert(coin.nHeight == cache_coin.nHeight);\n+                assert(coin.out == cache_coin.out);\n+                continue;\n+            }\n+\n+            if (!cache.HaveCoinInCache(outpoint)) {\n+                continue;\n+            }\n+\n+            const auto& [maybe_coin, err] = pair;\n+            assert(maybe_coin && !err);\n+\n+            // Check any newly added coins in the cache are the same as the db\n+            const auto& coin{cache.AccessCoin(outpoint)};\n+            assert(!coin.IsSpent());\n+            assert(coin.fCoinBase == (*maybe_coin).fCoinBase);\n+            assert(coin.nHeight == (*maybe_coin).nHeight);\n+            assert(coin.out == (*maybe_coin).out);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 150,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "1faf0595a59ee0da61aabb195c9939575f2536eb",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n            assert(coin.fCoinBase == maybe_coin->fCoinBase);\r\n            assert(coin.nHeight == maybe_coin->nHeight);\r\n            assert(coin.out == maybe_coin->out);\r\n```",
      "created_at": "2025-09-29T15:47:05Z",
      "updated_at": "2025-09-29T16:16:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388459245",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388459245"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 148,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388733196",
      "pull_request_review_id": 3280976253,
      "id": 2388733196,
      "node_id": "PRRC_kwDOABII586OYS0M",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think we should add exact types here to make sure calculations like `end_index - local_batch_size` can't underflow",
      "created_at": "2025-09-29T17:41:02Z",
      "updated_at": "2025-09-29T17:45:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388733196",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388733196"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 85,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388743389",
      "pull_request_review_id": 3280976253,
      "id": 2388743389,
      "node_id": "PRRC_kwDOABII586OYVTd",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor& cursor, const uint256 &hashBlock) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm a bit conflicted here: this way we're all measuring something slightly different - which is especially problematic since the work here isn't even CPU bound. What if we did a min of npcu and 4?",
      "created_at": "2025-09-29T17:44:49Z",
      "updated_at": "2025-09-29T17:45:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2388743389",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2388743389"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 38,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399012085",
      "pull_request_review_id": 3294897463,
      "id": 2399012085,
      "node_id": "PRRC_kwDOABII586O_gT1",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": 2083465171,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I tried to mimic the script validation like `GetCheckQueue`. But, I guess this is different enough. Will change next time I push.",
      "created_at": "2025-10-02T14:20:12Z",
      "updated_at": "2025-10-02T14:20:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399012085",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399012085"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399016753",
      "pull_request_review_id": 3294903795,
      "id": 2399016753,
      "node_id": "PRRC_kwDOABII586O_hcx",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I've updated to use semaphores instead of mutex. That should be more efficient.\r\n\r\n> especially if we sort the keys first so that threads are more likely to access different regions\r\n\r\nI don't understand what this has to do with being lock free.",
      "created_at": "2025-10-02T14:21:49Z",
      "updated_at": "2025-10-02T14:21:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399016753",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399016753"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399019592",
      "pull_request_review_id": 3294907722,
      "id": 2399019592,
      "node_id": "PRRC_kwDOABII586O_iJI",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 82,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388224454,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I updated the thread name to ThreadLoop, which just does the loop. There is another function now, `FetchInputsOnThread`, that fetches for each block until finished.",
      "created_at": "2025-10-02T14:22:46Z",
      "updated_at": "2025-10-02T14:22:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399019592",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399019592"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 82,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399025372",
      "pull_request_review_id": 3294915812,
      "id": 2399025372,
      "node_id": "PRRC_kwDOABII586O_jjc",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388250227,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Prefiltering on the main thread is too slow, it's faster if we do the filtering in parallel. So, we still need to have a smaller batch size because then work will not be divided evenly. One thread could get all cache misses while the others all have cached inputs.",
      "created_at": "2025-10-02T14:24:55Z",
      "updated_at": "2025-10-02T14:24:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399025372",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399025372"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399027783",
      "pull_request_review_id": 3294919045,
      "id": 2399027783,
      "node_id": "PRRC_kwDOABII586O_kJH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 77,
      "commit_id": "7991379d7f5f42003f8168a56d09297ab4625280",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388256954,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Prefiltering on the main thread is too slow. It is several milliseconds to check every input in large blocks whether they exist in the cache.\r\n\r\n",
      "created_at": "2025-10-02T14:25:46Z",
      "updated_at": "2025-10-02T14:25:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399027783",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399027783"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 75,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399028082",
      "pull_request_review_id": 3294919403,
      "id": 2399028082,
      "node_id": "PRRC_kwDOABII586O_kNy",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 1,
      "commit_id": "4331168bd08d63a73a6e45c84a7513d01541f19a",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388258759,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-02T14:25:52Z",
      "updated_at": "2025-10-02T14:25:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399028082",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399028082"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399032242",
      "pull_request_review_id": 3294924932,
      "id": 2399032242,
      "node_id": "PRRC_kwDOABII586O_lOy",
      "diff_hunk": "@@ -6266,6 +6268,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388275122,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I believe this is resolved.",
      "created_at": "2025-10-02T14:27:19Z",
      "updated_at": "2025-10-02T14:27:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399032242",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399032242"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399049434",
      "pull_request_review_id": 3294948927,
      "id": 2399049434,
      "node_id": "PRRC_kwDOABII586O_pba",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};\n     auto [it, inserted] = cacheCoins.try_emplace(std::move(outpoint), std::move(coin));\n-    if (inserted) CCoinsCacheEntry::SetDirty(*it, m_sentinel);\n+    if (inserted) {\n+        cachedCoinsUsage += mem_usage;",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 11,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "af8a366bd6a08d9362e69a89b0b89b5c94eb63ca",
      "in_reply_to_id": 2388297125,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is dangerous because it doesn't check for freshness or if already inserted. It is meant to bulk load new utxos from the assume utxo set. Since assume utxo assumes the utxo set is currently empty, the coins would always be inserted.\r\nThis is repurposed here to bulk load utxos from the db directly into the cache. However, an invalid block could be mined which spends an already spent utxo that is in the cache but has not been synced to the db yet. In that case, \r\nthe insertion will fail here. There is a unit test specifically for this scenario.",
      "created_at": "2025-10-02T14:33:42Z",
      "updated_at": "2025-10-02T14:33:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399049434",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399049434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 135,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399056272",
      "pull_request_review_id": 3294959235,
      "id": 2399056272,
      "node_id": "PRRC_kwDOABII586O_rGQ",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 27,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388307927,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We iterate the prevouts directly from the block now. However, we store the tx index and vin index in a global vector now. This way we can flatten the inputs instead of having to scan the txs to see how many inputs they have.",
      "created_at": "2025-10-02T14:36:02Z",
      "updated_at": "2025-10-02T14:36:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399056272",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399056272"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 26,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 27,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399059149",
      "pull_request_review_id": 3294963215,
      "id": 2399059149,
      "node_id": "PRRC_kwDOABII586O_rzN",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388318316,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not sure, would have to benchmark this.\r\nI have updated the functions though to make the main thread's entrance clearer.",
      "created_at": "2025-10-02T14:37:07Z",
      "updated_at": "2025-10-02T14:37:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399059149",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399059149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399062889",
      "pull_request_review_id": 3294968319,
      "id": 2399062889,
      "node_id": "PRRC_kwDOABII586O_stp",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388399879,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It is definitely safe to do, since all access would be on main thread. It is also safe to do from parallel threads if we don't write until all threads are done reading, which is what this PR does.\r\nPrefiltering is slow though (several milliseconds) so is better to do in parallel.",
      "created_at": "2025-10-02T14:38:33Z",
      "updated_at": "2025-10-02T14:38:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399062889",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399062889"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399067712",
      "pull_request_review_id": 3294975172,
      "id": 2399067712,
      "node_id": "PRRC_kwDOABII586O_t5A",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 127,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388409573,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure I understand this.\r\nThe m_txids set is computed on the main thread, and is only read from multiple threads. If we didn't do this we would try to fetch non-existent outputs from the db, which would be much slower.",
      "created_at": "2025-10-02T14:40:12Z",
      "updated_at": "2025-10-02T14:40:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399067712",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399067712"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 118,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069027",
      "pull_request_review_id": 3294977180,
      "id": 2399069027,
      "node_id": "PRRC_kwDOABII586O_uNj",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 73,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388250227,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not sure why that's problematic, we don't *have* to have perfect parallelism, it seems to me we can assume uniform distribution - it's fine if there are outliers if that makes the code simpler (which I think it should, it could even eliminate most locks, since the jobs are basically completely independent)",
      "created_at": "2025-10-02T14:40:35Z",
      "updated_at": "2025-10-02T14:40:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399069027",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069027"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 73,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069282",
      "pull_request_review_id": 3294977557,
      "id": 2399069282,
      "node_id": "PRRC_kwDOABII586O_uRi",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I don't understand what this has to do with being lock free.\r\n\r\nWe may have fewer file system locks if the threads are accessing different regions\r\n\r\n> I've updated to use semaphores instead of mutex\r\n\r\nI will review that in more detail soon, probably next week.",
      "created_at": "2025-10-02T14:40:41Z",
      "updated_at": "2025-10-02T14:40:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399069282",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399069282"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399071701",
      "pull_request_review_id": 3294980461,
      "id": 2399071701,
      "node_id": "PRRC_kwDOABII586O_u3V",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388412343,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We don't really care, but it would be good to not continue doing work here if we know it's pointless. This just exits early. No validation is happening.",
      "created_at": "2025-10-02T14:41:29Z",
      "updated_at": "2025-10-02T14:41:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399071701",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399071701"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399074127",
      "pull_request_review_id": 3294983877,
      "id": 2399074127,
      "node_id": "PRRC_kwDOABII586O_vdP",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 192,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388427056,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is to not enter if there is only a coinbase tx, since it has no inputs to fetch. If there were 2 txs, and the second has 1000 inputs, we would still want to enter here.",
      "created_at": "2025-10-02T14:42:21Z",
      "updated_at": "2025-10-02T14:42:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399074127",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399074127"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399077894",
      "pull_request_review_id": 3294988855,
      "id": 2399077894,
      "node_id": "PRRC_kwDOABII586O_wYG",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388318316,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "My benchmarks so far indicate the opposite: after 3-4 threads there is no benefit to the parallelization (either on SSD or HDD). I will remeasure your new changes after you give me the ðŸ‘ ",
      "created_at": "2025-10-02T14:43:24Z",
      "updated_at": "2025-10-02T14:43:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399077894",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399077894"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399079463",
      "pull_request_review_id": 3294990649,
      "id": 2399079463,
      "node_id": "PRRC_kwDOABII586O_wwn",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388430113,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think we can do that. We need to set these here for other threads to read. These are only read from other threads, never written to. We also only read from other threads after the main thread has released the counting_semaphore, so we know the pointers are synced across the threads.",
      "created_at": "2025-10-02T14:43:51Z",
      "updated_at": "2025-10-02T14:43:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399079463",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399079463"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399082258",
      "pull_request_review_id": 3294994294,
      "id": 2399082258,
      "node_id": "PRRC_kwDOABII586O_xcS",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto batch_size{m_rng.randrange<int32_t>(m_block->vtx.size() * 2)};\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(batch_size, worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView db;\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+class ThrowCoinsView : public CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        throw std::runtime_error(\"database error\");",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 171,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388449458,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Err, we want to throw a runtime error here to test the try/catch in the inputfetcher.",
      "created_at": "2025-10-02T14:44:35Z",
      "updated_at": "2025-10-02T14:44:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399082258",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399082258"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 162,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399083511",
      "pull_request_review_id": 3294995976,
      "id": 2399083511,
      "node_id": "PRRC_kwDOABII586O_xv3",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388733196,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I rewrote this part, these are gone now.",
      "created_at": "2025-10-02T14:44:59Z",
      "updated_at": "2025-10-02T14:45:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399083511",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399083511"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 85,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399084818",
      "pull_request_review_id": 3294997807,
      "id": 2399084818,
      "node_id": "PRRC_kwDOABII586O_yES",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 130,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388399879,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "But prefiltering would allow sorting, which should untangle the threads.\r\nThe threads will access the same files (which are more likely to be different from the files the other threads are requesting), so they may profit from cache locality if the OS supports it - that's why I suggested giving it a try.",
      "created_at": "2025-10-02T14:45:28Z",
      "updated_at": "2025-10-02T14:45:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399084818",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399084818"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399092048",
      "pull_request_review_id": 3295008083,
      "id": 2399092048,
      "node_id": "PRRC_kwDOABII586O_z1Q",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> We may have fewer file system locks if the threads are accessing different regions\r\n\r\nOk, but that is not the same as this InputFetcher construction being lock free.",
      "created_at": "2025-10-02T14:47:30Z",
      "updated_at": "2025-10-02T14:47:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399092048",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399092048"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399094785",
      "pull_request_review_id": 3295011711,
      "id": 2399094785,
      "node_id": "PRRC_kwDOABII586O_0gB",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {\n+            // Don't do anything if there are no worker threads.\n+            return;\n+        }\n+        m_pairs.reserve(worker_thread_count + 1);\n+        for (auto n{0}; n < worker_thread_count + 1; ++n) {\n+            m_pairs.emplace_back();\n+        }\n+        m_worker_threads.reserve(worker_thread_count);\n+        for (auto n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                Loop(n);\n+            });\n+        }\n+    }\n+\n+    // Since this class manages its own resources, which is a thread\n+    // pool `m_worker_threads`, copy and move operations are not appropriate.\n+    InputFetcher(const InputFetcher&) = delete;\n+    InputFetcher& operator=(const InputFetcher&) = delete;\n+    InputFetcher(InputFetcher&&) = delete;\n+    InputFetcher& operator=(InputFetcher&&) = delete;\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache,\n+                     const CCoinsView& db,\n+                     const CBlock& block) noexcept\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        if (m_worker_threads.empty() || block.vtx.size() <= 1) {\n+            return;\n+        }\n+\n+        // Set the db and cache to use for this block.\n+        m_db = &db;\n+        m_cache = &cache;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 198,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388430113,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I really dislike that, will try to come up with a lock-free version later (maybe next week)",
      "created_at": "2025-10-02T14:48:22Z",
      "updated_at": "2025-10-02T14:48:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399094785",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399094785"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 197,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 135,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399100147",
      "pull_request_review_id": 3295018607,
      "id": 2399100147,
      "node_id": "PRRC_kwDOABII586O_1zz",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 136,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388412343,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think I would prefer a less opinionated version, as long as it's still correct. No need to optimize for the consensus failure speed in my opinion, I would prefer simpler code for a change as risky as this one.",
      "created_at": "2025-10-02T14:50:17Z",
      "updated_at": "2025-10-02T14:50:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399100147",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399100147"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 127,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399116295",
      "pull_request_review_id": 3295038544,
      "id": 2399116295,
      "node_id": "PRRC_kwDOABII586O_5wH",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 107,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388218975,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No, that's orthogonal, it's another area where we could possibly reduce contention.",
      "created_at": "2025-10-02T14:54:52Z",
      "updated_at": "2025-10-02T14:54:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2399116295",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2399116295"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 107,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470414",
      "pull_request_review_id": 3299718995,
      "id": 2402470414,
      "node_id": "PRRC_kwDOABII586PMsoO",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {\n+                // Database error. This will be handled later in validation.\n+                // Skip remaining outpoints and continue so main thread\n+                // can proceed.\n+                LOCK(m_mutex);\n+                m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                m_last_outpoint_index = 0;\n+            }\n+        } while (true);\n+    }\n+\n+public:\n+\n+    //! Create a new input fetcher\n+    explicit InputFetcher(int32_t batch_size, int32_t worker_thread_count) noexcept\n+        : m_batch_size(batch_size)\n+    {\n+        if (worker_thread_count < 1) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 162,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388419154,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-03T15:58:56Z",
      "updated_at": "2025-10-03T15:58:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402470414",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470414"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 151,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470769",
      "pull_request_review_id": 3299719451,
      "id": 2402470769,
      "node_id": "PRRC_kwDOABII586PMstx",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 24,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "912f26b81e0e772634fc04be2fb047bafb1723af",
      "in_reply_to_id": 2388303800,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-03T15:59:05Z",
      "updated_at": "2025-10-03T15:59:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402470769",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402470769"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 23,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402472467",
      "pull_request_review_id": 3299721826,
      "id": 2402472467,
      "node_id": "PRRC_kwDOABII586PMtIT",
      "diff_hunk": "@@ -110,10 +110,15 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n            (bool)it->second.coin.IsCoinBase());\n }\n \n-void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin) {\n-    cachedCoinsUsage += coin.DynamicMemoryUsage();\n+void CCoinsViewCache::EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty) {\n+    const auto mem_usage{coin.DynamicMemoryUsage()};",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 7,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388273122,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added some explanation in the commit message. Please let me know if it makes it more clear.",
      "created_at": "2025-10-03T15:59:58Z",
      "updated_at": "2025-10-03T15:59:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2402472467",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2402472467"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 131,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403069813",
      "pull_request_review_id": 3300510926,
      "id": 2403069813,
      "node_id": "PRRC_kwDOABII586PO-91",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 15,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859192217,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Removed the batch size ðŸŽ‰",
      "created_at": "2025-10-03T19:06:32Z",
      "updated_at": "2025-10-03T19:06:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2403069813",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403069813"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 15,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403595535",
      "pull_request_review_id": 3301344527,
      "id": 2403595535,
      "node_id": "PRRC_kwDOABII586PQ_UP",
      "diff_hunk": "@@ -3195,6 +3195,8 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.GetInputFetcher().FetchInputs(CoinsTip(), CoinsDB(), blockConnecting);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "original_commit_id": "b2da76444613229e0bf5539596903ac3c1db3053",
      "in_reply_to_id": 2083465171,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-04T00:00:08Z",
      "updated_at": "2025-10-04T00:00:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2403595535",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2403595535"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404065695",
      "pull_request_review_id": 3301981036,
      "id": 2404065695,
      "node_id": "PRRC_kwDOABII586PSyGf",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Can we add a single-threaded input fetcher first and add multithreading only as the very last step?\r\n\r\nDone.",
      "created_at": "2025-10-04T15:55:22Z",
      "updated_at": "2025-10-04T15:55:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2404065695",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404065695"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404066620",
      "pull_request_review_id": 3301981608,
      "id": 2404066620,
      "node_id": "PRRC_kwDOABII586PSyU8",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 51,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388436958,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-04T15:57:41Z",
      "updated_at": "2025-10-04T15:57:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2404066620",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2404066620"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072675",
      "pull_request_review_id": 3327511391,
      "id": 2423072675,
      "node_id": "PRRC_kwDOABII586QbSej",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    bool m_request_stop GUARDED_BY(m_mutex){false};\n+\n+    //! Internal function that does the fetching from disk.\n+    void Loop(int32_t index, bool is_main_thread = false) noexcept EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    {\n+        auto local_batch_size{0};\n+        auto end_index{0};\n+        auto& cond{is_main_thread ? m_main_cv : m_worker_cv};\n+        do {\n+            {\n+                WAIT_LOCK(m_mutex, lock);\n+                // first do the clean-up of the previous loop run (allowing us to do\n+                // it in the same critsect) local_batch_size will only be\n+                // truthy after first run.\n+                if (local_batch_size) {\n+                    m_in_flight_outpoints_count -= local_batch_size;\n+                    if (!is_main_thread && m_in_flight_outpoints_count == 0) {\n+                        m_main_cv.notify_one();\n+                    }\n+                }\n+\n+                // logically, the do loop starts here\n+                while (m_last_outpoint_index == 0) {\n+                    if ((is_main_thread && m_in_flight_outpoints_count == 0) || m_request_stop) {\n+                        return;\n+                    }\n+                    ++m_idle_worker_count;\n+                    cond.wait(lock);\n+                    --m_idle_worker_count;\n+                }\n+\n+                // Assign a batch of outpoints to this thread\n+                local_batch_size = std::max(1, std::min(m_batch_size,\n+                            static_cast<int32_t>(m_last_outpoint_index /\n+                            (m_worker_threads.size() + 1 + m_idle_worker_count))));\n+                end_index = m_last_outpoint_index;\n+                m_last_outpoint_index -= local_batch_size;\n+            }\n+\n+            auto& local_pairs{m_pairs[index]};\n+            local_pairs.reserve(local_pairs.size() + local_batch_size);\n+            try {\n+                for (auto i{end_index - local_batch_size}; i < end_index; ++i) {\n+                    const auto& outpoint{m_outpoints[i]};\n+                    // If an input spends an outpoint from earlier in the\n+                    // block, it won't be in the cache yet but it also won't be\n+                    // in the db either.\n+                    if (m_txids.contains(outpoint.hash)) {\n+                        continue;\n+                    }\n+                    if (m_cache->HaveCoinInCache(outpoint)) {\n+                        continue;\n+                    }\n+                    if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                        local_pairs.emplace_back(outpoint, std::move(*coin));\n+                    } else {\n+                        // Missing an input. This block will fail validation.\n+                        // Skip remaining outpoints and continue so main thread\n+                        // can proceed.\n+                        LOCK(m_mutex);\n+                        m_in_flight_outpoints_count -= m_last_outpoint_index;\n+                        m_last_outpoint_index = 0;\n+                        break;\n+                    }\n+                }\n+            } catch (const std::runtime_error&) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 145,
      "commit_id": "6701eef088668a9d9f87b0cc37d0d0ff885d449d",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388213294,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added a log.",
      "created_at": "2025-10-11T18:04:13Z",
      "updated_at": "2025-10-11T18:04:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072675",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072675"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072759",
      "pull_request_review_id": 3327511515,
      "id": 2423072759,
      "node_id": "PRRC_kwDOABII586QbSf3",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::ZEROS);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 55,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "c705c6f1f1b2b11c9f292d4bb60e197c6bd42603",
      "in_reply_to_id": 2388439344,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Changed to `FIXED_SEED`.",
      "created_at": "2025-10-11T18:04:32Z",
      "updated_at": "2025-10-11T18:04:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072787",
      "pull_request_review_id": 3327511553,
      "id": 2423072787,
      "node_id": "PRRC_kwDOABII586QbSgT",
      "diff_hunk": "@@ -0,0 +1,153 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto batch_size{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(0, 1024)};\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{batch_size, worker_threads};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(batch_size * worker_threads * 2)) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin),\n+                        /*set_dirty=*/fuzzed_data_provider.ConsumeBool());\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);\n+\n+        for (const auto& [outpoint, pair] : db_map) {\n+            // Check pre-existing coins in the cache have not been updated\n+            const auto it{cache_map.find(outpoint)};\n+            if (it != cache_map.end()) {\n+                const auto& cache_coin{it->second};\n+                const auto& coin{cache.AccessCoin(outpoint)};\n+                assert(coin.IsSpent() == cache_coin.IsSpent());\n+                assert(coin.fCoinBase == cache_coin.fCoinBase);\n+                assert(coin.nHeight == cache_coin.nHeight);\n+                assert(coin.out == cache_coin.out);\n+                continue;\n+            }\n+\n+            if (!cache.HaveCoinInCache(outpoint)) {\n+                continue;\n+            }\n+\n+            const auto& [maybe_coin, err] = pair;\n+            assert(maybe_coin && !err);\n+\n+            // Check any newly added coins in the cache are the same as the db\n+            const auto& coin{cache.AccessCoin(outpoint)};\n+            assert(!coin.IsSpent());\n+            assert(coin.fCoinBase == (*maybe_coin).fCoinBase);\n+            assert(coin.nHeight == (*maybe_coin).nHeight);\n+            assert(coin.out == (*maybe_coin).out);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 150,
      "commit_id": "cf209da104d483aa064aa3bec621f1adc9574749",
      "original_commit_id": "1faf0595a59ee0da61aabb195c9939575f2536eb",
      "in_reply_to_id": 2388459245,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done!",
      "created_at": "2025-10-11T18:04:40Z",
      "updated_at": "2025-10-11T18:04:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2423072787",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2423072787"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 148,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429350877",
      "pull_request_review_id": 3335914404,
      "id": 2429350877,
      "node_id": "PRRC_kwDOABII586QzPPd",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I have tried std::jthread\r\n\r\nI looked at this, but it doesn't really add anything to this implementation. We could have a `std::stop_token` for each thread, but we would have to `request_stop()` each `jthread` before releasing the semaphore in the destructor anyway. So it doesn't let us remove the destructor, and saves a line for not having to declare `m_request_stop`. I don't think it's worth it to use `jthread`s here.",
      "created_at": "2025-10-14T14:09:53Z",
      "updated_at": "2025-10-14T14:09:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2429350877",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429350877"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429481952",
      "pull_request_review_id": 3336096572,
      "id": 2429481952,
      "node_id": "PRRC_kwDOABII586QzvPg",
      "diff_hunk": "@@ -0,0 +1,246 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <primitives/transaction_identifier.h>\n+#include <sync.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <vector>\n+\n+/**\n+ * Input fetcher for fetching inputs from the CoinsDB and inserting\n+ * into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input prevouts to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself a range of outpoints from the shared vector, and\n+ * fetches the coins from disk. The outpoint and coin pairs are written to a\n+ * thread local vector of pairs. Once all outpoints are fetched, the main thread\n+ * loops through all thread local vectors and writes the pairs to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! Mutex to protect the inner state\n+    Mutex m_mutex{};\n+    //! Worker threads block on this when out of work\n+    std::condition_variable m_worker_cv{};\n+    //! Main thread blocks on this when out of work\n+    std::condition_variable m_main_cv{};\n+\n+    /**\n+     * The outpoints to be fetched from disk.\n+     * This is written to on the main thread, then read from all worker\n+     * threads only after the main thread is done writing. Hence, it doesn't\n+     * need to be guarded by a lock.\n+     */\n+    std::vector<COutPoint> m_outpoints{};\n+    /**\n+     * The index of the last outpoint that is being fetched. Workers assign\n+     * themselves a range of outpoints to fetch from m_outpoints. They will use\n+     * this index as the end of their range, and then set this index to the\n+     * beginning of the range they take for the next worker. Once it gets to\n+     * zero, all outpoints have been assigned and the next worker will wait.\n+     */\n+    size_t m_last_outpoint_index GUARDED_BY(m_mutex){0};\n+\n+    //! The set of txids of the transactions in the current block being fetched.\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+    //! The vector of thread local vectors of pairs to be written to the cache.\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_pairs{};\n+\n+    /**\n+     * Number of outpoint fetches that haven't completed yet.\n+     * This includes outpoints that have already been assigned, but are still in\n+     * the worker's own batches.\n+     */\n+    int32_t m_in_flight_outpoints_count GUARDED_BY(m_mutex){0};\n+    //! The number of worker threads that are waiting on m_worker_cv\n+    int32_t m_idle_worker_count GUARDED_BY(m_mutex){0};\n+    //! The maximum number of outpoints to be assigned in one batch\n+    const int32_t m_batch_size;\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 79,
      "commit_id": "315e3da3195673b5081ec9dd1e3dfa05bff104d4",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388236852,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I couldn't get it to work on CI anyway",
      "created_at": "2025-10-14T14:49:17Z",
      "updated_at": "2025-10-14T14:49:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2429481952",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2429481952"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2433196004",
      "pull_request_review_id": 3341247537,
      "id": 2433196004,
      "node_id": "PRRC_kwDOABII586RB5_k",
      "diff_hunk": "@@ -423,12 +423,13 @@ class CCoinsViewCache : public CCoinsViewBacked\n \n     /**\n      * Emplace a coin into cacheCoins without performing any checks, marking\n-     * the emplaced coin as dirty.\n+     * the emplaced coin as dirty unless `set_dirty` is `false`.\n      *\n-     * NOT FOR GENERAL USE. Used only when loading coins from a UTXO snapshot.\n+     * NOT FOR GENERAL USE. Used when loading coins from a UTXO snapshot, and\n+     * in the InputFetcher.\n      * @sa ChainstateManager::PopulateAndValidateSnapshot()\n      */\n-    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin);\n+    void EmplaceCoinInternalDANGER(COutPoint&& outpoint, Coin&& coin, bool set_dirty = true);",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "44f07f8957d03cf4aa8b3aea533ed6c5de9ba043",
      "original_commit_id": "688c03597afb0b76077f1ffc4608eef19481056e",
      "in_reply_to_id": 2388269800,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think I can just drop this first commit entirely. We don't actually care to not set the coins we fetch as dirty.\r\nIn the happy path, all these coins will be spent immediately after `ConnectBlock`, so they will be set to dirty anyways.\r\nIn the unhappy path where the valid proof-of-work block is found to be invalid, the dirty coins we added will just cause the coins to be overwritten by the same data in the db at the next flush.",
      "created_at": "2025-10-15T16:09:11Z",
      "updated_at": "2025-10-15T16:09:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2433196004",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2433196004"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 432,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2437808988",
      "pull_request_review_id": 3347436866,
      "id": 2437808988,
      "node_id": "PRRC_kwDOABII586RTgNc",
      "diff_hunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * It loops through the block and writes all input indexes to a\n+ * vector. It then assigns itself an input from the vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * a different vector. Once all inputs are fetched, it writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 35,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "063946d6bd78035276d12e070a208d84492ac5cd",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As far as I understood the tx index and the vin index cannot exceed the limits of a `uint32_t`, see https://github.com/bitcoin/bitcoin/blob/e744fd1249bf9577274614eaf3997bf4bbb612ff/src/primitives/transaction.h#L32\r\n\r\nPlease consider `std::vector<std::pair<uint32_t, uint32_t>>` instead, which would likely halve the memory footprint. Based on https://godbolt.org/z/Wb918bWaM it seems to me this layout allows modern compilers to coalesce the two member accesses into a single, optimal 64-bit load from memory.\r\n\r\nPacking it into a single `uint64_t` seems to be the best, but that's completely unreadable, so I'd go with the above `std::pair<uint32_t, uint32_t>`.",
      "created_at": "2025-10-16T23:56:04Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2437808988",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2437808988"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442436064",
      "pull_request_review_id": 3347436866,
      "id": 2442436064,
      "node_id": "PRRC_kwDOABII586RlJ3g",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);\n+\n         CCoinsViewCache view(&CoinsTip());",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 6,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have played with this to see if we can construct the new cache layer before the fetcher, so that it populates the new layer instead of reading & writing to the old one - seemed like a cleaner separation.\n\nBut unfortunately we would need access to both in-memory cache layers inside `FetchInputs` in that case - to read for presence from the old cache and to write the newly fetched values to the new one (which will be flushed together with the new outputs when existing this scope).\n\nBut given that we're adding these missing entries only to spend them a moment later in the other cache layer (and to avoid having all of the missing ones require two-hop-lookups) we should still try reading from the stable cache and writing to the temporary one.\n\nCollecting the missing inputs to a separate cache would also help with benchmarking and testing since the underlying cache would only be modified once block connection finishes - while the complete diff would be in the top cache layer. We also shouldn't add the entries to the cache if the block fails validation.",
      "created_at": "2025-10-18T14:02:59Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442436064",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442436064"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 3140,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442481463",
      "pull_request_review_id": 3347436866,
      "id": 2442481463,
      "node_id": "PRRC_kwDOABII586RlU83",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Does this mean the spent tx is never processed on the same thread currently?\n\nMaybe we can mix it up a bit by something like\n```C++\nif (m_rng.randbool()) {\n    prevhash = tx.GetHash(); // TODO This can theoretically simulate double spends\n}\n```",
      "created_at": "2025-10-18T16:14:51Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442481463",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442481463"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 44,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442488159",
      "pull_request_review_id": 3347436866,
      "id": 2442488159,
      "node_id": "PRRC_kwDOABII586RlWlf",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 153,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What's the point of the loop in these, is there a state we're changing in each iteration?",
      "created_at": "2025-10-18T16:34:46Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442488159",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442488159"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 150,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498069",
      "pull_request_review_id": 3347436866,
      "id": 2442498069,
      "node_id": "PRRC_kwDOABII586RlZAV",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\n\n```suggestion\n    std::optional<Coin> GetCoin(const COutPoint&) const override { std::abort(); }\n```",
      "created_at": "2025-10-18T16:52:47Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498069",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498069"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498338",
      "pull_request_review_id": 3347436866,
      "id": 2442498338,
      "node_id": "PRRC_kwDOABII586RlZEi",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 26,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: in test code I'd strive for simpler code instead of needlessly \"safe\"\n\n```suggestion\nstruct DbCoinsView : CCoinsView\n{\n    DbMap& m_map;\n```",
      "created_at": "2025-10-18T16:53:38Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498338",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498338"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 21,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498626",
      "pull_request_review_id": 3347436866,
      "id": 2442498626,
      "node_id": "PRRC_kwDOABII586RlZJC",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 29,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`GetCoin` shouldn't return spent entries",
      "created_at": "2025-10-18T16:54:18Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498626",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498626"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498819",
      "pull_request_review_id": 3347436866,
      "id": 2442498819,
      "node_id": "PRRC_kwDOABII586RlZMD",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this seems overly general to me, I think we can inline the delay for now",
      "created_at": "2025-10-18T16:54:57Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442498819",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442498819"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442499107",
      "pull_request_review_id": 3347436866,
      "id": 2442499107,
      "node_id": "PRRC_kwDOABII586RlZQj",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+public:\n+\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 153,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As mentioned before, I really dislike these lines, a fetcher shouldn't change the internal state (especially since they're const). Since we need a continuously running threads, can we package these to avoid state mutations? This would likely be solved by sending these off to a ThreadPool instance.",
      "created_at": "2025-10-18T16:55:53Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442499107",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442499107"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 151,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 153,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442502361",
      "pull_request_review_id": 3347436866,
      "id": 2442502361,
      "node_id": "PRRC_kwDOABII586RlaDZ",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We shouldn't test this with invalid (empty) blocks:\n\n```suggestion\n        if (block.vtx.empty()) continue;\n        fetcher.FetchInputs(cache, db, block);\n```",
      "created_at": "2025-10-18T17:00:10Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442502361",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442502361"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505074",
      "pull_request_review_id": 3347436866,
      "id": 2442505074,
      "node_id": "PRRC_kwDOABII586Rlaty",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 39,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\n\n```suggestion\n    CBlock block;\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n```",
      "created_at": "2025-10-18T17:08:43Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442505074",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505074"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505360",
      "pull_request_review_id": 3347436866,
      "id": 2442505360,
      "node_id": "PRRC_kwDOABII586RlayQ",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 45,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "\"should be counted\" is the reason for the \"- 1\"?",
      "created_at": "2025-10-18T17:09:25Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442505360",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442505360"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442506743",
      "pull_request_review_id": 3347436866,
      "id": 2442506743,
      "node_id": "PRRC_kwDOABII586RlbH3",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: if we keep the processor count here (which kinda' makes the benchmark measure different things on different platforms, but I don't really have a better idea, unless we assume that even the simplest machines where this matters (e.g. rpi4) already have at least 4 threads - and since this isn't even CPU bound, we shouldn't pretend that it does):\n\n```suggestion\n    const auto worker_threads_num{size_t(GetNumCores() - 1)};\n    const InputFetcher fetcher{worker_threads_num};\n```\nor\n```suggestion\n    const InputFetcher fetcher{/*max_thread_count=*/4};\n```",
      "created_at": "2025-10-18T17:12:32Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442506743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442506743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442508359",
      "pull_request_review_id": 3347436866,
      "id": 2442508359,
      "node_id": "PRRC_kwDOABII586RlbhH",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\n+\n+    bench.run([&] {\n+        const auto ok{cache.Flush()};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Doesn't this change the behavior of the benchmark after the first iteration?",
      "created_at": "2025-10-18T17:17:32Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442508359",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442508359"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442511181",
      "pull_request_review_id": 3347436866,
      "id": 2442511181,
      "node_id": "PRRC_kwDOABII586RlcNN",
      "diff_hunk": "@@ -6265,6 +6267,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't understand what `0` threads means. It likely means turn off prefetching.\r\n \r\nI would consider it to be a lot more intuitive if this started with 1 (and not be bound by the number of unrelated `MAX_SCRIPTCHECK_THREADS` since it's not script related and not even CPU bound).\r\n\r\nNote: `chainstatemanager_snapshot_init` creates it with `0` workers by default, not sure it's intended",
      "created_at": "2025-10-18T17:25:12Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442511181",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442511181"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6302,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442521884",
      "pull_request_review_id": 3347436866,
      "id": 2442521884,
      "node_id": "PRRC_kwDOABII586Rle0c",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 113,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It seems to me that since the original `m_coins` is never written by different threads, we shouldn't have a false sharing problem here - right?",
      "created_at": "2025-10-18T17:38:03Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442521884",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442521884"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442524173",
      "pull_request_review_id": 3347436866,
      "id": 2442524173,
      "node_id": "PRRC_kwDOABII586RlfYN",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This style of dynamic work-stealing seems too complicated for such a uniform problem - static slicing would likely be a lot simpler and I would expect it to perform equally well.\r\n\r\nI also realize that some of these are needed to avoid recreating the threads for every call. Currently the parallelism and the thread recreation are done in a single commit - could we first implement multithreading with thread recreation, and do the thread reuse as a separate concern (though a `ThreadPool` with dedicated test)?",
      "created_at": "2025-10-18T17:41:16Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442524173",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442524173"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 76,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442538377",
      "pull_request_review_id": 3347436866,
      "id": 2442538377,
      "node_id": "PRRC_kwDOABII586Rli2J",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n                Coin coin{};\n                assert(coin.IsSpent());\n```",
      "created_at": "2025-10-18T18:09:31Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2442538377",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2442538377"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446494738",
      "pull_request_review_id": 3347436866,
      "id": 2446494738,
      "node_id": "PRRC_kwDOABII586R0owS",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 96,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Would this suffice?\r\n```suggestion\r\n            (void)m_complete_barrier.arrive();\r\n```",
      "created_at": "2025-10-21T01:23:08Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446494738",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446494738"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 96,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446502718",
      "pull_request_review_id": 3347436866,
      "id": 2446502718,
      "node_id": "PRRC_kwDOABII586R0qs-",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;\n+        m_txids.clear();\n+        m_inputs.clear();\n+\n+        // Loop through the inputs of the block and add them to the queue.\n+        // Construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            for (size_t j{0}; j < block.vtx[i]->vin.size(); ++j) {\n+                m_inputs.emplace_back(i, j);\n+            }\n+            m_txids.emplace(block.vtx[i]->GetHash());\n+        }\n+\n+        // Set the input counter and wake threads.\n+        m_input_counter.store(0, std::memory_order_relaxed);\n+        m_start_semaphore.release(m_worker_threads.size());\n+\n+        // Have the main thread work too before we wait for other threads\n+        Work(m_worker_threads.size());\n+        m_complete_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What's the reason for not doing the completion here instead of the `OnCompletion` workaround?\n```suggestion\n        m_complete_barrier.arrive_and_wait();\n        for (auto& coins : m_coins) {\n            for (auto& [outpoint, coin] : coins) {\n                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n            }\n            coins.clear();\n        }\n```",
      "created_at": "2025-10-21T01:29:43Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446502718",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446502718"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446503935",
      "pull_request_review_id": 3347436866,
      "id": 2446503935,
      "node_id": "PRRC_kwDOABII586R0q__",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`std::ptrdiff_t` seems more appropriate here: https://en.cppreference.com/w/cpp/thread/barrier/barrier.html\n```suggestion\n    explicit InputFetcher(size_t worker_thread_count) noexcept : m_complete_barrier{std::ptrdiff_t(worker_thread_count + 1)}\n```",
      "created_at": "2025-10-21T01:30:57Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2446503935",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2446503935"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 148,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 149,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448545244",
      "pull_request_review_id": 3347436866,
      "id": 2448545244,
      "node_id": "PRRC_kwDOABII586R8dXc",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "wouldn't `m_worker_threads.size() == 0` be an error?",
      "created_at": "2025-10-21T14:21:14Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448545244",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448545244"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448558350",
      "pull_request_review_id": 3347436866,
      "id": 2448558350,
      "node_id": "PRRC_kwDOABII586R8gkO",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I personally would favor going for simpler code as opposed to going for theoretically better encapsulation, similarly to current `inputfetcher_tests.cpp`:\n```C++\nstruct DelayedCoinsView : CCoinsView\n```",
      "created_at": "2025-10-21T14:24:37Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448558350",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448558350"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448561438",
      "pull_request_review_id": 3347436866,
      "id": 2448561438,
      "node_id": "PRRC_kwDOABII586R8hUe",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We can add better assertions if we count the iterator size here:\r\n```C++\r\nbool BatchWrite(CoinsViewCacheCursor& cursor, const uint256&) override\r\n{\r\n    for (auto it{cursor.Begin()}; it != cursor.End(); it = cursor.NextAndMaybeErase(*it)) {\r\n        m_write_count++;\r\n    }\r\n    return true;\r\n}\r\n```\r\nSo the bench could be (without flush which makes the bench runs equivalent):\r\n```C++\r\nbench.run([&] {\r\n    CCoinsViewCache block_cache{&cache};\r\n    fetcher.FetchInputs(cache, block_cache, db, block);\r\n    assert(db.m_write_count == 0 && cache.GetCacheSize() == 0 && block_cache.GetCacheSize() == 4599);\r\n});\r\n```",
      "created_at": "2025-10-21T14:25:37Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448561438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448561438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448577697",
      "pull_request_review_id": 3347436866,
      "id": 2448577697,
      "node_id": "PRRC_kwDOABII586R8lSh",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Given that we already create the actual temporary top cache here, it would be great if we could separate the reading and writing (read from old/big in-memory cache and write to the temporary small one):\r\n```C++\r\nCCoinsViewCache* cache{&CoinsTip()};\r\nCCoinsViewCache new_cache{cache};\r\nm_chainman.FetchInputs(*cache, new_cache, CoinsDB(), *block_to_connect);\r\n```\r\n\r\nThis would also mean that the actually read changes are read after that from the top-layer cache instead of always requiring two hops (assuming many missing ones). It also makes sense to not add inputs from blocks that fail validation - which we'd be getting for free this way.",
      "created_at": "2025-10-21T14:30:23Z",
      "updated_at": "2025-10-27T21:48:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2448577697",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2448577697"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469585296",
      "pull_request_review_id": 3388785294,
      "id": 2469585296,
      "node_id": "PRRC_kwDOABII586TMuGQ",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);\n+\n         CCoinsViewCache view(&CoinsTip());",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 6,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442436064,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T13:30:03Z",
      "updated_at": "2025-10-28T13:30:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469585296",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469585296"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 3140,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 3142,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469589719",
      "pull_request_review_id": 3388791537,
      "id": 2469589719,
      "node_id": "PRRC_kwDOABII586TMvLX",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent\n+                cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        // Coins are still spent, even though they exist unspent in the parent db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 153,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442488159,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The InputFetcher is stateful, so this is making sure previous state does not leak into the next fetch phase.",
      "created_at": "2025-10-28T13:31:25Z",
      "updated_at": "2025-10-28T13:31:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469589719",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469589719"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 150,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469606414",
      "pull_request_review_id": 3388813847,
      "id": 2469606414,
      "node_id": "PRRC_kwDOABII586TMzQO",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+public:\n+\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_block = &block;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 153,
      "commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442499107,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Indeed, this would be gracefully solved with https://github.com/bitcoin/bitcoin/pull/33689. We could pass all state into the worker threads via lambda capture.",
      "created_at": "2025-10-28T13:36:14Z",
      "updated_at": "2025-10-28T13:36:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469606414",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469606414"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 151,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 153,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469609534",
      "pull_request_review_id": 3388818232,
      "id": 2469609534,
      "node_id": "PRRC_kwDOABII586TM0A-",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why not? The InputFetcher should not make assumptions about the structure of the block being passed in.",
      "created_at": "2025-10-28T13:37:05Z",
      "updated_at": "2025-10-28T13:37:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469609534",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469609534"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469616204",
      "pull_request_review_id": 3388827732,
      "id": 2469616204,
      "node_id": "PRRC_kwDOABII586TM1pM",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442506743,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why don't we want different benchmarks on different machines? All benchmarks are subtly different depending on the host machine.",
      "created_at": "2025-10-28T13:38:54Z",
      "updated_at": "2025-10-28T13:38:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469616204",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469616204"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469618569",
      "pull_request_review_id": 3388831117,
      "id": 2469618569,
      "node_id": "PRRC_kwDOABII586TM2OJ",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};\n+\n+    bench.run([&] {\n+        const auto ok{cache.Flush()};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442508359,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Fixed in latest iteration.",
      "created_at": "2025-10-28T13:39:40Z",
      "updated_at": "2025-10-28T13:39:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469618569",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469618569"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469625970",
      "pull_request_review_id": 3388841516,
      "id": 2469625970,
      "node_id": "PRRC_kwDOABII586TM4By",
      "diff_hunk": "@@ -6265,6 +6267,7 @@ static ChainstateManager::Options&& Flatten(ChainstateManager::Options&& opts)\n \n ChainstateManager::ChainstateManager(const util::SignalInterrupt& interrupt, Options options, node::BlockManager::Options blockman_options)\n     : m_script_check_queue{/*batch_size=*/128, std::clamp(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},\n+      m_input_fetcher{std::clamp<size_t>(options.worker_threads_num, 0, MAX_SCRIPTCHECK_THREADS)},",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442511181,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "0 threads means it is turned off, yes. If `-par=1` is configured, we want to pass 0 to input fetcher to disable prefetching. Also if `options.worker_threads_num` was negative for some reason. Do you have a suggestion of how this can be made more clear?",
      "created_at": "2025-10-28T13:41:30Z",
      "updated_at": "2025-10-28T13:42:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469625970",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469625970"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 6302,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469631434",
      "pull_request_review_id": 3388848844,
      "id": 2469631434,
      "node_id": "PRRC_kwDOABII586TM5XK",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            m_complete_semaphore.release();\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 113,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442521884,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Possibly.\r\nThis is no longer relevant in the current implementation.",
      "created_at": "2025-10-28T13:43:01Z",
      "updated_at": "2025-10-28T13:43:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469631434",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469631434"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 119,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469638986",
      "pull_request_review_id": 3388860309,
      "id": 2469638986,
      "node_id": "PRRC_kwDOABII586TM7NK",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448545244,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No, we can have no worker threads, for instance if started with `-par=1`. In that case just disable prefetching.",
      "created_at": "2025-10-28T13:44:51Z",
      "updated_at": "2025-10-28T13:44:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469638986",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469638986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469655686",
      "pull_request_review_id": 3388889093,
      "id": 2469655686,
      "node_id": "PRRC_kwDOABII586TM_SG",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "When do we do a batch write though in this example?",
      "created_at": "2025-10-28T13:49:46Z",
      "updated_at": "2025-10-28T13:49:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469655686",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469655686"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469658436",
      "pull_request_review_id": 3388892165,
      "id": 2469658436,
      "node_id": "PRRC_kwDOABII586TM_9E",
      "diff_hunk": "@@ -3137,6 +3137,8 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n+        m_chainman.FetchInputs(CoinsTip(), CoinsDB(), *block_to_connect);",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448577697,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T13:50:24Z",
      "updated_at": "2025-10-28T13:50:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469658436",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469658436"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3140,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469691257",
      "pull_request_review_id": 3388935705,
      "id": 2469691257,
      "node_id": "PRRC_kwDOABII586TNH95",
      "diff_hunk": "@@ -0,0 +1,131 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * It loops through the block and writes all input indexes to a\n+ * vector. It then assigns itself an input from the vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * a different vector. Once all inputs are fetched, it writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 35,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "063946d6bd78035276d12e070a208d84492ac5cd",
      "in_reply_to_id": 2437808988,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done, using uint32_t in the Input struct now, not sure if it will have any effect in the struct though.",
      "created_at": "2025-10-28T13:59:24Z",
      "updated_at": "2025-10-28T13:59:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469691257",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469691257"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 35,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469694470",
      "pull_request_review_id": 3388940589,
      "id": 2469694470,
      "node_id": "PRRC_kwDOABII586TNIwG",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498069,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:04Z",
      "updated_at": "2025-10-28T14:00:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469694470",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469694470"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 44,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 49,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695146",
      "pull_request_review_id": 3388941480,
      "id": 2469695146,
      "node_id": "PRRC_kwDOABII586TNI6q",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498819,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:12Z",
      "updated_at": "2025-10-28T14:00:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469695146",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695146"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695839",
      "pull_request_review_id": 3388942384,
      "id": 2469695839,
      "node_id": "PRRC_kwDOABII586TNJFf",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 29,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498626,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:19Z",
      "updated_at": "2025-10-28T14:00:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469695839",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469695839"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469696287",
      "pull_request_review_id": 3388943033,
      "id": 2469696287,
      "node_id": "PRRC_kwDOABII586TNJMf",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 26,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442498338,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:25Z",
      "updated_at": "2025-10-28T14:00:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469696287",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469696287"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 21,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 26,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469697562",
      "pull_request_review_id": 3388945347,
      "id": 2469697562,
      "node_id": "PRRC_kwDOABII586TNJga",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 39,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442505074,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:00:43Z",
      "updated_at": "2025-10-28T14:00:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469697562",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469697562"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 37,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469698872",
      "pull_request_review_id": 3388947368,
      "id": 2469698872,
      "node_id": "PRRC_kwDOABII586TNJ04",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+        getFetcher().FetchInputs(cache, db, block);\n+\n+        std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+        txids.reserve(block.vtx.size() - 1);\n+\n+        for (const auto& tx : block.vtx) {\n+            if (tx->IsCoinBase()) {\n+                BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+            } else {\n+                for (const auto& in : tx->vin) {\n+                    const auto& outpoint{in.prevout};\n+                    const auto have{cache.HaveCoinInCache(outpoint)};\n+                    const auto should_have{!txids.contains(outpoint.hash)};\n+                    BOOST_CHECK(should_have ? have : !have);\n+                }\n+                txids.emplace(tx->GetHash());\n+            }\n+        }\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db. So the input fetcher will fetch\n+// the coin from the db since HaveCoinInCache will return false for an existing\n+// but spent coin. However, the fetched coin will fail to be inserted into the\n+// cache because the emplace call in EmplaceCoinInternalDANGER will not insert\n+// the unspent coin due to the collision with the already spent coin in the map.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache cache(&db);\n+\n+        // Add all inputs as spent already in cache\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{}; // Not setting nValue implies spent",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442538377,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:01:00Z",
      "updated_at": "2025-10-28T14:01:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469698872",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469698872"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 131,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469699476",
      "pull_request_review_id": 3388948249,
      "id": 2469699476,
      "node_id": "PRRC_kwDOABII586TNJ-U",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448558350,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-10-28T14:01:08Z",
      "updated_at": "2025-10-28T14:01:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469699476",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469699476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469710016",
      "pull_request_review_id": 3388965041,
      "id": 2469710016,
      "node_id": "PRRC_kwDOABII586TNMjA",
      "diff_hunk": "@@ -0,0 +1,190 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442481463,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Does this mean the spent tx is never processed on the same thread currently?\r\n\r\nI don't think that's what it means. The same thread could fetch two inputs in a row.\r\n\r\n> Maybe we can mix it up a bit by something like\r\n\r\nSo we can use the same prevhash in difference txs? What is the benefit of this?",
      "created_at": "2025-10-28T14:04:05Z",
      "updated_at": "2025-10-28T14:04:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469710016",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469710016"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 44,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469713772",
      "pull_request_review_id": 3388970527,
      "id": 2469713772,
      "node_id": "PRRC_kwDOABII586TNNds",
      "diff_hunk": "@@ -0,0 +1,198 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the main thread\n+ * loops through all thread local vectors and writes the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to check if we already have this input.\n+    const CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    std::counting_semaphore<> m_complete_semaphore{0};\n+    std::atomic<bool> m_request_stop{false};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442524173,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It should be simpler now. I'm not sure if this comment is still valid though with the current approach. I agree if we already had a ThreadPool this would be much cleaner.",
      "created_at": "2025-10-28T14:05:10Z",
      "updated_at": "2025-10-28T14:05:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2469713772",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2469713772"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 76,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 84,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470247644",
      "pull_request_review_id": 3389722061,
      "id": 2470247644,
      "node_id": "PRRC_kwDOABII586TPPzc",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Originally we flushed, so if we still want to, we may want to extend this to assert that behavior. Or avoid flushing and simplify the bench. Or add the flushing behavior above to a test, etc.",
      "created_at": "2025-10-28T16:28:43Z",
      "updated_at": "2025-10-28T16:28:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470247644",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470247644"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470254148",
      "pull_request_review_id": 3389731253,
      "id": 2470254148,
      "node_id": "PRRC_kwDOABII586TPRZE",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Even consensus invalid ones? Or did I misunderstand the context here?",
      "created_at": "2025-10-28T16:30:48Z",
      "updated_at": "2025-10-28T16:30:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470254148",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470254148"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470260510",
      "pull_request_review_id": 3389741417,
      "id": 2470260510,
      "node_id": "PRRC_kwDOABII586TPS8e",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }\n+};\n+\n+static void InputFetcherBenchmark(benchmark::Bench& bench)\n+{\n+    DataStream stream{benchmark::data::block413567};\n+    CBlock block;\n+    stream >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db(DELAY);\n+    CCoinsViewCache cache(&db);\n+\n+    // The main thread should be counted to prevent thread oversubscription, and\n+    // to decrease the variance of benchmark results.\n+    const auto worker_threads_num{GetNumCores() - 1};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads_num)};",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 47,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442506743,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yeah, but we want to understand where the differences are coming from, otherwise we'd have the \"faster-on-my-machine\" syndrome. If you disagree, just resolve the issue.",
      "created_at": "2025-10-28T16:32:30Z",
      "updated_at": "2025-10-28T16:32:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470260510",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470260510"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470278073",
      "pull_request_review_id": 3389766524,
      "id": 2470278073,
      "node_id": "PRRC_kwDOABII586TPXO5",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We avoid flushing now.",
      "created_at": "2025-10-28T16:37:44Z",
      "updated_at": "2025-10-28T16:37:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470278073",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470278073"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470280988",
      "pull_request_review_id": 3389771134,
      "id": 2470280988,
      "node_id": "PRRC_kwDOABII586TPX8c",
      "diff_hunk": "@@ -0,0 +1,150 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+class DbCoinsView : public CCoinsView\n+{\n+private:\n+    DbMap& m_map;\n+\n+public:\n+    DbCoinsView(DbMap& map) : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+class NoAccessCoinsView : public CCoinsView\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        abort();\n+    }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{static_cast<size_t>(worker_threads)};\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        DbMap db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+\n+        DbCoinsView db(db_map);\n+\n+        NoAccessCoinsView back;\n+        CCoinsViewCache cache(&back);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\n+                const auto txid{fuzzed_data_provider.ConsumeBool()\n+                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\n+                    : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                std::optional<Coin> maybe_coin;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    maybe_coin = coin;\n+                } else {\n+                    maybe_coin = std::nullopt;\n+                }\n+                db_map.try_emplace(outpoint, std::make_pair(\n+                    maybe_coin,\n+                    fuzzed_data_provider.ConsumeBool()));\n+\n+                // Add the coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        fetcher.FetchInputs(cache, db, block);",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 120,
      "commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "original_commit_id": "64de91105312d36dadb5f71ec01fc6af9b14da69",
      "in_reply_to_id": 2442502361,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yeah, InputFetcher doesn't know if a block is consensus valid or not yet. It hasn't passed `ConnectBlock` yet before entering here.",
      "created_at": "2025-10-28T16:38:48Z",
      "updated_at": "2025-10-28T16:38:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470280988",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470280988"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470285353",
      "pull_request_review_id": 3389779624,
      "id": 2470285353,
      "node_id": "PRRC_kwDOABII586TPZAp",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: we could throw now to indicate we don't have unrepeatable side-effects",
      "created_at": "2025-10-28T16:40:19Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470285353",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470285353"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470286368",
      "pull_request_review_id": 3389779624,
      "id": 2470286368,
      "node_id": "PRRC_kwDOABII586TPZQg",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Nit: structs are now formatted consistently on the same line",
      "created_at": "2025-10-28T16:40:43Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2470286368",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2470286368"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484846327",
      "pull_request_review_id": 3389779624,
      "id": 2484846327,
      "node_id": "PRRC_kwDOABII586UG773",
      "diff_hunk": "@@ -474,6 +482,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! See: https://stackoverflow.com/questions/42114044/how-to-release-unordered-map-memory\n     void ReallocateCache();\n \n+    /**\n+     * Reserve enough space in the cache so the underlying unordered_map will\n+     * not have to rehash unless capacity is exceeded.\n+     */\n+    void Reserve(size_t capacity) {",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Nit: can you please reformat the change with latest clang-format after rebase?\r\nNit2: this seems to belong closer to `GetCacheSize`, one reserves, the other returns the actual size\r\n",
      "created_at": "2025-11-02T14:39:32Z",
      "updated_at": "2025-11-02T20:33:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484846327",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484846327"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 489,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484851139",
      "pull_request_review_id": 3389779624,
      "id": 2484851139,
      "node_id": "PRRC_kwDOABII586UG9HD",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I like that we're doing this, we've usually avoided preallocating our maps - we should do it more often!\r\n\r\n-----\r\n\r\nI know we're providing empty caches via the parameters, but for completeness either assert that they're empty or:\r\n\r\n```suggestion\r\n        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n```\r\n\r\n----\r\n\r\nI have added\r\n```C++\r\n        Assert(temp_cache.GetCacheSize() <= temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\r\n```\r\nafter the `for (auto& input : m_inputs) {` loop to validate that the allocation achieves - the tests pass! ðŸ‘ ",
      "created_at": "2025-11-02T14:50:44Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484851139",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484851139"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484854164",
      "pull_request_review_id": 3389779624,
      "id": 2484854164,
      "node_id": "PRRC_kwDOABII586UG92U",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we're also just adding stuff to the `m_inputs` without any reservation, the first few times we will have some needless copying - we could likely alleviate that by doing a rough reservation\r\n```C++\r\n        m_txids.reserve(block.vtx.size());\r\n        m_inputs.reserve(2 * block.vtx.size()); // rough guess\r\n```",
      "created_at": "2025-11-02T14:57:38Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484854164",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484854164"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484858152",
      "pull_request_review_id": 3389779624,
      "id": 2484858152,
      "node_id": "PRRC_kwDOABII586UG-0o",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand if you don't want to bother with this, but how many of these do we expect per block?\r\nI wonder if we want to incur the hashing cost here or if using a sorted set or a sorted vector with `std::binary_search` (or even (unsorted?) SIMD-enabled linear scan) would be faster or simpler here.\r\n\r\nI also thought of whether we could just add these to `temp_cache` directly, but that would likely pollute the up-coming validation (unless we can differentiate these from existing inputs).\r\n\r\n----\r\n\r\nTaking `block413567`, we can assuming for the benchmark that 5% of the txs are internal spends (we need to measure this properly before we decide) and assuming 1556 txs (4886 inputs, 3581 outputs), 287 internal spends, we can compare the alternatives, here's a bench for motivation.\r\n\r\n<details>\r\n<summary>Benchmark comparing the miss and hit count of Txid_SetOrdered, Txid_UnorderedSalted, Txid_VectorBinarySearch, Txid_VectorLinearScan</summary>\r\n\r\n```C++\r\n// Copyright (c) 2022-present The Bitcoin Core developers\r\n// Distributed under the MIT software license, see the accompanying\r\n// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n\r\n#include <bench/bench.h>\r\n#include <bench/nanobench.h>\r\n#include <primitives/transaction_identifier.h>\r\n#include <random.h>\r\n#include <util/check.h>\r\n#include <util/hasher.h>\r\n\r\n#include <algorithm>\r\n#include <ranges>\r\n#include <set>\r\n#include <unordered_set>\r\n#include <vector>\r\n\r\nnamespace {\r\n\r\nconstexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\nconstexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\nconstexpr size_t tx_count{5500};\r\n\r\nstruct Dataset {\r\n    std::set<Txid> sorted_set;\r\n    std::unordered_set<Txid, SaltedTxidHasher> unsorted_set;\r\n    std::vector<Txid> vec_sorted;\r\n    std::vector<Txid> vec_unsorted;\r\n\r\n    std::vector<Txid> queries;\r\n};\r\n\r\nstd::vector<Dataset> BuildDatasets()\r\n{\r\n    FastRandomContext rng(/*fDeterministic=*/true);\r\n\r\n    std::vector<Dataset> datasets;\r\n    datasets.reserve(iterations);\r\n\r\n    for (size_t d{0}; d < iterations; ++d) {\r\n        Dataset ds;\r\n        ds.queries.reserve(tx_count);\r\n        ds.unsorted_set.reserve(tx_count);\r\n        ds.vec_sorted.reserve(tx_count);\r\n        ds.vec_unsorted.reserve(tx_count);\r\n\r\n        for (size_t i{0}; i < tx_count; ++i) {\r\n            Txid t{Txid::FromUint256(rng.rand256())};\r\n            ds.sorted_set.emplace(t);\r\n            ds.unsorted_set.emplace(t);\r\n            ds.vec_sorted.emplace_back(t);\r\n            ds.vec_unsorted.emplace_back(t);\r\n\r\n            ds.queries.emplace_back(i < hits_count ? t : Txid::FromUint256(rng.rand256()));\r\n        }\r\n\r\n        std::ranges::shuffle(ds.queries, rng);\r\n        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n\r\n        datasets.emplace_back(std::move(ds));\r\n    }\r\n    return datasets;\r\n}\r\n\r\n} // namespace\r\n\r\nstatic void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets()};\r\n    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nBENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\n```\r\n\r\n</details>\r\n\r\n```\r\ncmake -B build -DBUILD_BENCH=ON -DENABLE_IPC=OFF -DCMAKE_BUILD_TYPE=Release && cmake --build build -j$(nproc) && build/bin/bench_bitcoin -filter='Txid_.*'\r\n```\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|          217,247.09 |            4,603.05 |    0.0% |      0.02 | `Txid_SetOrdered`\r\n|          202,607.50 |            4,935.65 |    0.0% |      0.02 | `Txid_UnorderedSalted`\r\n|          194,347.91 |            5,145.41 |    0.0% |      0.02 | `Txid_VectorBinarySearch`\r\n|       12,449,880.83 |               80.32 |    0.0% |      1.24 | `Txid_VectorLinearScan`\r\n\r\n<details>\r\n<summary>Same measurement on an Rpi5 with GCC instead</summary>\r\n\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|        1,179,326.18 |              847.94 |    0.0% |    2,361,313.36 |    2,820,742.15 |  0.837 |     475,693.50 |    1.2% |      0.12 | `Txid_SetOrdered`\r\n|          912,335.48 |            1,096.09 |    0.0% |    1,346,377.49 |    2,183,167.97 |  0.617 |      84,874.38 |    5.7% |      0.09 | `Txid_UnorderedSalted`\r\n|          732,493.03 |            1,365.20 |    0.0% |    2,411,291.90 |    1,752,928.05 |  1.376 |     531,672.95 |    8.1% |      0.07 | `Txid_VectorBinarySearch`\r\n|       25,449,442.73 |               39.29 |    0.0% |  235,989,723.07 |   60,929,976.87 |  3.873 |  58,998,462.96 |    0.0% |      2.54 | `Txid_VectorLinearScan`\r\n\r\n</details>\r\n\r\n---\r\n\r\nSo the benchmark isn't as revealing as I was hoping, please verify my assumptions and we can still test these with some macro-benchmark to see if there's any performance or memory advantage to any of these.",
      "created_at": "2025-11-02T15:06:28Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484858152",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484858152"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484898679",
      "pull_request_review_id": 3389779624,
      "id": 2484898679,
      "node_id": "PRRC_kwDOABII586UHIt3",
      "diff_hunk": "@@ -173,6 +173,11 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This seems like a code smell that we should pay attention to. I have already brought this up a year ago in https://github.com/bitcoin/bitcoin/pull/30673#discussion_r1722286606, seems it keeps biting us.\r\nInstead of adding a new method that basically does the same, can we keep `GetCoin` to simply return the coin and move the spentness checks to the call sites?\r\nI understand that it would likely require another PR, but it would make this one cleaner - I don't like that we need a workaround for a scenario that isn't out of the ordinary.",
      "created_at": "2025-11-02T16:40:44Z",
      "updated_at": "2025-11-02T20:33:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484898679",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484898679"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905167",
      "pull_request_review_id": 3389779624,
      "id": 2484905167,
      "node_id": "PRRC_kwDOABII586UHKTP",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\r\n```suggestion\r\n            m_worker_threads.emplace_back([this, n] {\r\n```",
      "created_at": "2025-11-02T16:54:42Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484905167",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905167"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905870",
      "pull_request_review_id": 3389779624,
      "id": 2484905870,
      "node_id": "PRRC_kwDOABII586UHKeO",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 128,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n    explicit InputFetcher(int32_t worker_thread_count) noexcept : m_barrier{(worker_thread_count + 1)}\r\n```\r\nthis would remove a few static casts",
      "created_at": "2025-11-02T16:56:03Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484905870",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484905870"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 128,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484907043",
      "pull_request_review_id": 3389779624,
      "id": 2484907043,
      "node_id": "PRRC_kwDOABII586UHKwj",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 62,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\r\n```suggestion\r\n        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n```",
      "created_at": "2025-11-02T16:58:43Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484907043",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484907043"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484908114",
      "pull_request_review_id": 3389779624,
      "id": 2484908114,
      "node_id": "PRRC_kwDOABII586UHLBS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "is the `alignas` a false sharing guard? Does it have a measurable effect?",
      "created_at": "2025-11-02T17:01:24Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484908114",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484908114"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484910336",
      "pull_request_review_id": 3389779624,
      "id": 2484910336,
      "node_id": "PRRC_kwDOABII586UHLkA",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't like that we need a separate field for this only, but I guess without `std::jthread` we have to do this manually.\r\n\r\nSince this field isn't checked on every iteration, only once per thread per job as far as I can tell, we could repurpose `m_input_head` and use it as\r\n```C++\r\nalignas(64) std::atomic_int32_t m_input_head{0};\r\n...\r\nif (m_input_head.load(std::memory_order_acquire) < 0) [[unlikely]] {\r\n...\r\nm_input_head.store(-1, std::memory_order_relaxed);\r\n```",
      "created_at": "2025-11-02T17:05:35Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484910336",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484910336"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484912732",
      "pull_request_review_id": 3389779624,
      "id": 2484912732,
      "node_id": "PRRC_kwDOABII586UHMJc",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;\n+        m_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "not certain, but I think this should likely be:\r\n```suggestion\r\n        m_barrier.arrive_and_drop();\r\n```",
      "created_at": "2025-11-02T17:10:36Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484912732",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484912732"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484913752",
      "pull_request_review_id": 3389779624,
      "id": 2484913752,
      "node_id": "PRRC_kwDOABII586UHMZY",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand that this poison pill broadcast is needed to stop execution when errors occur - but I'm not sure we should care here about fetching error, I think we should just try to continue if that makes the code simpler",
      "created_at": "2025-11-02T17:13:06Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484913752",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484913752"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484927472",
      "pull_request_review_id": 3389779624,
      "id": 2484927472,
      "node_id": "PRRC_kwDOABII586UHPvw",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 91,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't mind the `unlikely` parts but we're barely using them in the code, they have some weird side-effects when merged - which may not be the case here, so I'm fine wither way, if nothing else, it documents the usage",
      "created_at": "2025-11-02T17:47:41Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484927472",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484927472"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928036",
      "pull_request_review_id": 3389779624,
      "id": 2484928036,
      "node_id": "PRRC_kwDOABII586UHP4k",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm surprised synchronized insertion is faster than collecting them in a lock-free way - guess it's all the copying, but we should be able to avoid that, I don't like that we're locking again",
      "created_at": "2025-11-02T17:49:27Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484928036",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928036"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928411",
      "pull_request_review_id": 3389779624,
      "id": 2484928411,
      "node_id": "PRRC_kwDOABII586UHP-b",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "as mentioned before, is `FAILED` an important state for the fetcher? Why not just debug/warn log and continue?",
      "created_at": "2025-11-02T17:50:14Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484928411",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484928411"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931397",
      "pull_request_review_id": 3389779624,
      "id": 2484931397,
      "node_id": "PRRC_kwDOABII586UHQtF",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 104,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "hmm, code states it's likely, but the new tests are passing with:\r\n```C++\r\nif (!input.coin.IsSpent()) {\r\n    throw \"\";\r\n}\r\n```",
      "created_at": "2025-11-02T17:57:09Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484931397",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931397"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931836",
      "pull_request_review_id": 3389779624,
      "id": 2484931836,
      "node_id": "PRRC_kwDOABII586UHQz8",
      "diff_hunk": "@@ -0,0 +1,203 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <functional>\n+#include <semaphore>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and inserting into the CoinsTip.\n+ *\n+ * The main thread loops through the block and writes all input indexes to a\n+ * global vector. It then wakes all workers and starts working as well. Each\n+ * thread assigns itself an input from the shared vector, and\n+ * fetches the coin from disk. The outpoint and coin pairs are written to a\n+ * thread local vector. Once all inputs are fetched, the last thread to arrive\n+ * at the completion barrier loops through all thread local vectors and writes\n+ * the coins to the cache.\n+ */\n+class InputFetcher\n+{\n+private:\n+    /**\n+     * The flattened indexes to each input in the block. The first item in the\n+     * pair is the index of the tx, and the second is the index of the vin.\n+     */\n+    std::vector<std::pair<size_t, size_t>> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * This is used to filter out inputs that are created in the block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    /**\n+     * The latest index in m_inputs that is not yet being fetched.\n+     * Workers increment this counter when they assign themselves an input\n+     * from m_inputs to fetch.\n+     */\n+    std::atomic<size_t> m_input_counter{0};\n+\n+    /**\n+     * The vector of vectors of outpoint:coin pairs.\n+     * Each thread writes the coins it fetches to the vector at its thread\n+     * index. This way multiple threads can write concurrently to different\n+     * vectors in a thread safe way. After all threads are finished, the main\n+     * thread can loop through all vectors and write the coins to the cache.\n+     */\n+    std::vector<std::vector<std::pair<COutPoint, Coin>>> m_coins{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to write to.\n+    CCoinsViewCache* m_cache{nullptr};\n+    //! The block whose prevouts we are fetching.\n+    const CBlock* m_block{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads;\n+    std::counting_semaphore<> m_start_semaphore{0};\n+    struct OnCompletionWrapper { // Necessary to get this to compile on Windows\n+        InputFetcher* self;\n+        void operator()() noexcept { self->OnCompletion(); }\n+    };\n+    std::barrier<OnCompletionWrapper> m_complete_barrier;\n+    std::atomic<bool> m_request_stop{false};\n+\n+    void ThreadLoop(size_t thread_index) noexcept\n+    {\n+        util::ThreadRename(strprintf(\"inputfetch.%i\", thread_index));\n+\n+        while (true) {\n+            m_start_semaphore.acquire();\n+            if (m_request_stop.load(std::memory_order_relaxed)) {\n+                return;\n+            }\n+            Work(thread_index);\n+            [[maybe_unused]] const auto arrival_token{m_complete_barrier.arrive()};\n+        }\n+    }\n+\n+    void Work(size_t thread_index) noexcept\n+    {\n+        try {\n+            while (true) {\n+                const auto input_index{m_input_counter.fetch_add(1, std::memory_order_relaxed)};\n+                if (input_index >= m_inputs.size()) {\n+                    return;\n+                }\n+                const auto [tx_index, vin_index] = m_inputs[input_index];\n+                const auto& outpoint{m_block->vtx[tx_index]->vin[vin_index].prevout};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(outpoint.hash)) {\n+                    continue;\n+                }\n+                if (m_cache->HaveCoinInCache(outpoint)) {\n+                    continue;\n+                }\n+                if (auto coin{m_db->GetCoin(outpoint)}; coin) {\n+                    m_coins[thread_index].emplace_back(outpoint, std::move(*coin));\n+                } else {\n+                    // Missing an input. This block will fail validation.\n+                    // Skip remaining inputs.\n+                    m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+                    return;\n+                }\n+            }\n+        } catch (const std::runtime_error& e) {\n+            // Database error. This will be handled later in validation.\n+            // Skip remaining inputs.\n+            LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            m_input_counter.store(m_inputs.size(), std::memory_order_relaxed);\n+        }\n+    }\n+\n+    void OnCompletion() noexcept\n+    {\n+        // At this point all threads are done writing to m_coins and reading from m_cache,\n+        // so we can safely read from m_coins and write to m_cache.\n+        for (auto& coins : m_coins) {\n+            for (auto&& [outpoint, coin] : coins) {\n+                m_cache->EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+            coins.clear();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_complete_barrier{static_cast<int32_t>(worker_thread_count + 1), OnCompletionWrapper{this}}\n+    {\n+        if (worker_thread_count == 0) {\n+            return;\n+        }\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_coins.emplace_back();\n+            m_worker_threads.emplace_back(std::bind(&InputFetcher::ThreadLoop, this, n));\n+        }\n+        // One more coins vector for the main thread\n+        m_coins.emplace_back();\n+    }\n+\n+    //! Fetch all block inputs from db, and insert into cache.\n+    void FetchInputs(CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "c055a95b8085bc871802e76cb6b03f5745572218",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448545244,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not a biggy, but this also seems uncovered by the unit tests.",
      "created_at": "2025-11-02T17:58:11Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484931836",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484931836"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 110,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484932388",
      "pull_request_review_id": 3389779624,
      "id": 2484932388,
      "node_id": "PRRC_kwDOABII586UHQ8k",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 25,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think the test belongs with the implementation, I need it to be able to review the first commit (otherwise it's just dead code, with the tests it has at least a test user)",
      "created_at": "2025-11-02T17:59:35Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484932388",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484932388"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484934183",
      "pull_request_review_id": 3389779624,
      "id": 2484934183,
      "node_id": "PRRC_kwDOABII586UHRYn",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 21,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: some of these seem unused:\r\n```suggestion\r\n#include <memory>\r\n#include <stdexcept>\r\n#include <unordered_set>\r\n```",
      "created_at": "2025-11-02T18:02:22Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484934183",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484934183"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 17,
      "original_start_line": 17,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484936325",
      "pull_request_review_id": 3389779624,
      "id": 2484936325,
      "node_id": "PRRC_kwDOABII586UHR6F",
      "diff_hunk": "@@ -0,0 +1,56 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView\n+{\n+private:\n+    std::chrono::milliseconds m_delay;\n+\n+public:\n+    DelayedCoinsView(std::chrono::milliseconds delay) : m_delay(delay) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(m_delay);\n+        return Coin{};\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "a07936a62cd0acb0c9f719f4a7ba86b3a8013c1b",
      "in_reply_to_id": 2448561438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think we could still add\r\n```C++\r\n        ankerl::nanobench::doNotOptimizeAway(&temp_cache);\r\n        Assert(temp_cache.GetCacheSize() == 4599);\r\n```\r\nto document that the benchmark can loop now (i.e. every iteration should be the same)",
      "created_at": "2025-11-02T18:08:21Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484936325",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484936325"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484980972",
      "pull_request_review_id": 3389779624,
      "id": 2484980972,
      "node_id": "PRRC_kwDOABII586UHczs",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "hmm, how does this even compile?",
      "created_at": "2025-11-02T20:03:47Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484980972",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484980972"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484994822",
      "pull_request_review_id": 3389779624,
      "id": 2484994822,
      "node_id": "PRRC_kwDOABII586UHgMG",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 43,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't have a good fuzzer locally - does this cover all the new code?",
      "created_at": "2025-11-02T20:24:54Z",
      "updated_at": "2025-11-02T20:31:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484994822",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484994822"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484996439",
      "pull_request_review_id": 3389779624,
      "id": 2484996439,
      "node_id": "PRRC_kwDOABII586UHglX",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 105,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The comments indicate that you also don't think this code is very intuitive - I'm also a bit lost here, can we simplify this somehow? I don't even understand what \"release\" means here or why both branches result in `Status::READY` (can we unify them) or what happens if the first internal `if` isn't fulfilled, or the outer one or the else, etc. The branching + `continue` + try/catch doesn't help",
      "created_at": "2025-11-02T20:28:55Z",
      "updated_at": "2025-11-02T20:46:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2484996439",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2484996439"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 105,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485033847",
      "pull_request_review_id": 3409041873,
      "id": 2485033847,
      "node_id": "PRRC_kwDOABII586UHpt3",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I did try and use a sorted vector and do binary search in the workers, but it was not a measurable performance difference. In theory it should be faster since txid comparison is much faster than siphash. I can do this if you want, but I think it makes the code clearer using the `unordered_set`.",
      "created_at": "2025-11-02T21:38:15Z",
      "updated_at": "2025-11-02T21:38:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485033847",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485033847"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485039220",
      "pull_request_review_id": 3409047007,
      "id": 2485039220,
      "node_id": "PRRC_kwDOABII586UHrB0",
      "diff_hunk": "@@ -173,6 +173,11 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484898679,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is a consequence of skipping the main cache and writing directly to the temp cache.\r\n\r\nI don't think we can modify `GetCoin` to not return spent coins, it's part of the definition [Retrieve the Coin (unspent transaction output) for a given outpoint.](https://github.com/bitcoin/bitcoin/blob/master/src/coins.h#L310). This also goes backwards from your change https://github.com/bitcoin/bitcoin/pull/30849 where you added TODOs to not return spent coins where our test `GetCoin`s do. I don't think a PR to return spent coins from `GetCoin` would get enough support to be merged.\r\n\r\nIf `GetCoin` could return spent coins, we would also not be able to use it until we call `HaveCoinInCache`. This is because even though `GetCoin` is `const`, it modifies `cacheCoins` internally (which has the `mutable` modifier for this purpose). But, `HaveCoinInCache` also returns false if the coin is spent, so we would need to modify that. So, we would have 2 methods change and we would also then have to do 2 lookups. This method is very simple and very much defined for this special purpose, similar to `EmplaceCoinInCacheDANGER`.\r\n\r\nI'm open to other suggestions, but modifying `GetCoin` (and then `HaveCoinInCache`) doesn't seem like the way.",
      "created_at": "2025-11-02T21:52:21Z",
      "updated_at": "2025-11-02T21:52:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485039220",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485039220"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040051",
      "pull_request_review_id": 3409047688,
      "id": 2485040051,
      "node_id": "PRRC_kwDOABII586UHrOz",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484908114,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It was for false sharing. I don't think it has a measurable effect, but it might on some systems? I think it's harmless to keep, since there's only one InputFetcher.",
      "created_at": "2025-11-02T21:54:23Z",
      "updated_at": "2025-11-02T21:54:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485040051",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040051"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040642",
      "pull_request_review_id": 3409048208,
      "id": 2485040642,
      "node_id": "PRRC_kwDOABII586UHrYC",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 189,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484910336,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think that's actually preferable. The current way is more readable IMO.",
      "created_at": "2025-11-02T21:55:58Z",
      "updated_at": "2025-11-02T21:55:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485040642",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485040642"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 182,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485042527",
      "pull_request_review_id": 3409049863,
      "id": 2485042527,
      "node_id": "PRRC_kwDOABII586UHr1f",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There are no locks... This is a lock free implementation. It is synchronized with atomics per input, and the threads are work stealing via the `m_input_head`. Or do you mean something else?",
      "created_at": "2025-11-02T22:00:54Z",
      "updated_at": "2025-11-02T22:00:55Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485042527",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485042527"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485043525",
      "pull_request_review_id": 3409050730,
      "id": 2485043525,
      "node_id": "PRRC_kwDOABII586UHsFF",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We can't have the main thread insert a failed fetch. The coin will not be updated. I suppose the main thread could check if the coin is unspent.\r\nWe want to exit ASAP as well if we can't find an input, so we need to signal the main thread that they should exit the loop.",
      "created_at": "2025-11-02T22:03:22Z",
      "updated_at": "2025-11-02T22:03:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485043525",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485043525"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485058898",
      "pull_request_review_id": 3409078087,
      "id": 2485058898,
      "node_id": "PRRC_kwDOABII586UHv1S",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "In `ConnectBlock` if we encounter a missing input we abort validation immediately. It is wasted work to continue. Why should we do it here?",
      "created_at": "2025-11-02T22:30:38Z",
      "updated_at": "2025-11-02T22:30:38Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485058898",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485058898"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485063519",
      "pull_request_review_id": 3409082555,
      "id": 2485063519,
      "node_id": "PRRC_kwDOABII586UHw9f",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 104,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484931397,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Right, didn't cover this new happy path in tests. Unlikely case is covered though. Will add. Thanks.",
      "created_at": "2025-11-02T22:42:10Z",
      "updated_at": "2025-11-02T22:42:10Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485063519",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485063519"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 104,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073051",
      "pull_request_review_id": 3409091421,
      "id": 2485073051,
      "node_id": "PRRC_kwDOABII586UHzSb",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 21,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": 2484934183,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`<cstdint>` we need because we use `int32_t`.\r\n",
      "created_at": "2025-11-02T23:04:33Z",
      "updated_at": "2025-11-02T23:04:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485073051",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073051"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 17,
      "original_start_line": 17,
      "start_side": "RIGHT",
      "line": 20,
      "original_line": 20,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073570",
      "pull_request_review_id": 3409092042,
      "id": 2485073570,
      "node_id": "PRRC_kwDOABII586UHzai",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 43,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484994822,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, I need to fuzz it though myself. The CI is fuzzing it a little bit.",
      "created_at": "2025-11-02T23:05:58Z",
      "updated_at": "2025-11-02T23:05:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485073570",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485073570"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074194",
      "pull_request_review_id": 3409092724,
      "id": 2485074194,
      "node_id": "PRRC_kwDOABII586UHzkS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484854164,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This won't have a measurable effect if we are connecting lots of blocks though.",
      "created_at": "2025-11-02T23:07:35Z",
      "updated_at": "2025-11-02T23:07:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485074194",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074194"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074795",
      "pull_request_review_id": 3409093788,
      "id": 2485074795,
      "node_id": "PRRC_kwDOABII586UHztr",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470285353,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We could just get rid of this line now.",
      "created_at": "2025-11-02T23:08:46Z",
      "updated_at": "2025-11-02T23:08:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485074795",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485074795"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086517",
      "pull_request_review_id": 3409112313,
      "id": 2485086517,
      "node_id": "PRRC_kwDOABII586UH2k1",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+\n+    bool BatchWrite(CoinsViewCacheCursor&, const uint256&) override { return true; }",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 28,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470285353,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Got rid of it.",
      "created_at": "2025-11-02T23:31:57Z",
      "updated_at": "2025-11-02T23:31:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086517",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086517"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 28,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086567",
      "pull_request_review_id": 3409112362,
      "id": 2485086567,
      "node_id": "PRRC_kwDOABII586UH2ln",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:32:03Z",
      "updated_at": "2025-11-02T23:32:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086567",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086567"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086761",
      "pull_request_review_id": 3409112526,
      "id": 2485086761,
      "node_id": "PRRC_kwDOABII586UH2op",
      "diff_hunk": "@@ -474,6 +482,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n     //! See: https://stackoverflow.com/questions/42114044/how-to-release-unordered-map-memory\n     void ReallocateCache();\n \n+    /**\n+     * Reserve enough space in the cache so the underlying unordered_map will\n+     * not have to rehash unless capacity is exceeded.\n+     */\n+    void Reserve(size_t capacity) {",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 32,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484846327,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I couldn't get `clang-format` to work, but I made this a one-liner and moved under `GetCacheSize`.",
      "created_at": "2025-11-02T23:32:27Z",
      "updated_at": "2025-11-02T23:32:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086761",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086761"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 489,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086827",
      "pull_request_review_id": 3409112593,
      "id": 2485086827,
      "node_id": "PRRC_kwDOABII586UH2pr",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 165,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484851139,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:32:36Z",
      "updated_at": "2025-11-02T23:32:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485086827",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485086827"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 165,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087021",
      "pull_request_review_id": 3409113306,
      "id": 2485087021,
      "node_id": "PRRC_kwDOABII586UH2st",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 149,
      "commit_id": "bd6e9b18b5999b57e0cfb03e22c4ee0f9935d789",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484854164,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Did it anyways.",
      "created_at": "2025-11-02T23:33:00Z",
      "updated_at": "2025-11-02T23:33:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087021",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087021"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087120",
      "pull_request_review_id": 3409113407,
      "id": 2485087120,
      "node_id": "PRRC_kwDOABII586UH2uQ",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484905167,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:12Z",
      "updated_at": "2025-11-02T23:33:13Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087120",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087120"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087167",
      "pull_request_review_id": 3409113449,
      "id": 2485087167,
      "node_id": "PRRC_kwDOABII586UH2u_",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 128,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484905870,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:18Z",
      "updated_at": "2025-11-02T23:33:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087167",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087167"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 128,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087197",
      "pull_request_review_id": 3409113489,
      "id": 2485087197,
      "node_id": "PRRC_kwDOABII586UH2vd",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 62,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484907043,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:24Z",
      "updated_at": "2025-11-02T23:33:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087197",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087197"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 62,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087251",
      "pull_request_review_id": 3409113526,
      "id": 2485087251,
      "node_id": "PRRC_kwDOABII586UH2wT",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 43,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484908114,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Removed it.",
      "created_at": "2025-11-02T23:33:31Z",
      "updated_at": "2025-11-02T23:33:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087251",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087251"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 43,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087341",
      "pull_request_review_id": 3409113615,
      "id": 2485087341,
      "node_id": "PRRC_kwDOABII586UH2xt",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+                input.status.store(Input::Status::FAILED, std::memory_order_relaxed);\n+            }\n+            m_barrier.arrive_and_wait();\n+        }\n+    }\n+\n+public:\n+    explicit InputFetcher(size_t worker_thread_count) noexcept\n+        : m_barrier{static_cast<int32_t>(worker_thread_count + 1)}\n+    {\n+        for (size_t n{0}; n < worker_thread_count; ++n) {\n+            m_worker_threads.emplace_back([this, n]() {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                WorkLoop();\n+            });\n+        }\n+    }\n+\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) {\n+            return;\n+        }\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace(tx->GetHash());\n+            for (const auto& input : tx->vin) {\n+                m_inputs.emplace_back(input.prevout);\n+            }\n+        }\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to READY.\n+        temp_cache.Reserve(m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            auto status{input.status.load(std::memory_order_acquire)};\n+            while (status == Input::Status::WAITING) {\n+                std::this_thread::yield();\n+                status = input.status.load(std::memory_order_acquire);\n+            }\n+            if (status == Input::Status::READY) {\n+                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\n+            } else if (status == Input::Status::FAILED) [[unlikely]] {\n+                break;\n+            }\n+        }\n+\n+        m_barrier.arrive_and_wait();\n+        // Cleanup after all worker threads have exited the inner loop.\n+        m_txids.clear();\n+        m_inputs.clear();\n+        m_db = nullptr;\n+        m_cache = nullptr;\n+    }\n+\n+    ~InputFetcher()\n+    {\n+        m_request_stop = true;\n+        m_barrier.arrive_and_wait();",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 190,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484912732,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:33:45Z",
      "updated_at": "2025-11-02T23:33:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087341",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087341"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 190,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087547",
      "pull_request_review_id": 3409113833,
      "id": 2485087547,
      "node_id": "PRRC_kwDOABII586UH207",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 25,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "e3045d22375a21414c076fc5f8047f3d11848d9d",
      "in_reply_to_id": 2484932388,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done.",
      "created_at": "2025-11-02T23:34:20Z",
      "updated_at": "2025-11-02T23:34:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087547",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087547"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 24,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087694",
      "pull_request_review_id": 3409114014,
      "id": 2485087694,
      "node_id": "PRRC_kwDOABII586UH23O",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Fixed. But, it wouldn't affect the correctness of the test.",
      "created_at": "2025-11-02T23:34:42Z",
      "updated_at": "2025-11-02T23:34:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087694",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087694"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087978",
      "pull_request_review_id": 3409114255,
      "id": 2485087978,
      "node_id": "PRRC_kwDOABII586UH27q",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 105,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484996439,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Rewrote this part to make it more clear. I was trying to be clever by avoiding some extra checks, but they are probably meaningless and clarity is better here.",
      "created_at": "2025-11-02T23:35:19Z",
      "updated_at": "2025-11-02T23:35:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485087978",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485087978"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 105,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485157101",
      "pull_request_review_id": 3409208596,
      "id": 2485157101,
      "node_id": "PRRC_kwDOABII586UIHzt",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I wrote benchmarks to check how fast it was to construct, since this is the work that is done not in parallel:\r\n\r\n```C++\r\nstatic void SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::vector<Txid> v{};\r\n    v.reserve(block.vtx.size());\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n    });\r\n}\r\n\r\nstatic void UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n    u.reserve(block.vtx.size());\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n    });\r\n}\r\n\r\nstatic void SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n    std::set<Txid> s{};\r\n\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n    });\r\n}\r\n```\r\n\r\nResults:\r\n```\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|           45,794.65 |           21,836.61 |    1.6% |      777,851.91 |      110,515.70 |  7.038 |      88,000.15 |    0.5% |      0.01 | `UnorderedSetBenchmark`\r\n|           96,598.09 |           10,352.17 |    1.8% |      574,593.10 |      233,289.00 |  2.463 |     129,942.30 |    1.5% |      0.01 | `SetBenchmark`\r\n|        1,037,787.00 |              963.59 |    5.1% |   12,280,496.00 |    2,472,876.00 |  4.966 |   2,863,217.00 |    1.3% |      0.02 | :wavy_dash: `SortedVectorBenchmark` (Unstable with ~1.9 iters. Increase `minEpochIterations` to e.g. 19)\r\n```\r\n\r\nObviously we don't want to use the sorted vector. `unordered_set` is roughly twice as fast as `set`. I don't think it's worth pursuing a different filter container.",
      "created_at": "2025-11-03T01:42:49Z",
      "updated_at": "2025-11-03T01:42:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485157101",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485157101"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485569647",
      "pull_request_review_id": 3409770319,
      "id": 2485569647,
      "node_id": "PRRC_kwDOABII586UJshv",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think we should abort, it's not the fetcher's job to validate. If we didn't, we could even use short ids for the intra-block spends (64 bit likely won't even result in a single duplicate, and when they do collide we would just do a db check)",
      "created_at": "2025-11-03T07:44:08Z",
      "updated_at": "2025-11-03T07:44:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485569647",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485569647"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485572792",
      "pull_request_review_id": 3409774526,
      "id": 2485572792,
      "node_id": "PRRC_kwDOABII586UJtS4",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "atomics work via CAS, they need to retry in case of high contention. the previous solution didn't have contention, the threads all knew beforehand what to work on.",
      "created_at": "2025-11-03T07:46:00Z",
      "updated_at": "2025-11-03T07:46:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485572792",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485572792"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485575807",
      "pull_request_review_id": 3409778530,
      "id": 2485575807,
      "node_id": "PRRC_kwDOABII586UJuB_",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "that's my point, I don't think we should validate at all, it would simplify the code if we didn't ",
      "created_at": "2025-11-03T07:47:45Z",
      "updated_at": "2025-11-03T07:47:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485575807",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485575807"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485579371",
      "pull_request_review_id": 3409783658,
      "id": 2485579371,
      "node_id": "PRRC_kwDOABII586UJu5r",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "how so? Can we assert the behavior of the main cache as well so that the previous version doesn't pass?",
      "created_at": "2025-11-03T07:49:18Z",
      "updated_at": "2025-11-03T07:49:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485579371",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485579371"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485697378",
      "pull_request_review_id": 3409948029,
      "id": 2485697378,
      "node_id": "PRRC_kwDOABII586UKLti",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There are other ones that I didn't mention, reformatted the change, please take the ones that make sense:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```patch\r\ndiff --git a/src/coins.cpp b/src/coins.cpp\r\nindex 2ef2e36ccc..baac1a32b5 100644\r\n--- a/src/coins.cpp\r\n+++ b/src/coins.cpp\r\n@@ -173,7 +173,8 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\r\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\r\n }\r\n \r\n-std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const noexcept {\r\n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept\r\n+{\r\n     if (auto it{cacheCoins.find(outpoint)}; it != cacheCoins.end()) return it->second.coin;\r\n     return std::nullopt;\r\n }\r\ndiff --git a/src/coins.h b/src/coins.h\r\nindex e7d28ace97..02c3ea9e15 100644\r\n--- a/src/coins.h\r\n+++ b/src/coins.h\r\n@@ -407,7 +407,7 @@ public:\r\n      * Used in InputFetcher to make sure we do not add a coin from the backing\r\n      * view when it is spent in the cache but not yet flushed to the parent.\r\n      */\r\n-    std::optional<Coin> GetPossiblySpentCoinFromCache(const COutPoint &outpoint) const noexcept;\r\n+    std::optional<Coin> GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept;\r\n \r\n     /**\r\n      * Return a reference to Coin in the cache, or coinEmpty if not found. This is\r\ndiff --git a/src/inputfetcher.h b/src/inputfetcher.h\r\nindex a8a3f4d1ad..74c655caf1 100644\r\n--- a/src/inputfetcher.h\r\n+++ b/src/inputfetcher.h\r\n@@ -46,8 +46,8 @@ private:\r\n     struct Input {\r\n         enum class Status : uint8_t {\r\n             WAITING, // The coin has not been fetched yet\r\n-            READY, // The coin has been fetched and is ready to be inserted into the cache\r\n-            FAILED, // The coin failed to be fetched\r\n+            READY,   // The coin has been fetched and is ready to be inserted into the cache\r\n+            FAILED,  // The coin failed to be fetched\r\n             SKIPPED, // The coin is created and spent in the same block so cannot be fetched\r\n         };\r\n \r\ndiff --git a/src/test/fuzz/inputfetcher.cpp b/src/test/fuzz/inputfetcher.cpp\r\nindex cd2a0f5c68..70f5153912 100644\r\n--- a/src/test/fuzz/inputfetcher.cpp\r\n+++ b/src/test/fuzz/inputfetcher.cpp\r\n@@ -18,8 +18,7 @@\r\n \r\n using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\r\n \r\n-struct DbCoinsView : CCoinsView\r\n-{\r\n+struct DbCoinsView : CCoinsView {\r\n     DbMap& m_map;\r\n     DbCoinsView(DbMap& map) noexcept : m_map(map) {}\r\n \r\n@@ -35,8 +34,7 @@ struct DbCoinsView : CCoinsView\r\n     }\r\n };\r\n \r\n-struct NoAccessCoinsView : CCoinsView\r\n-{\r\n+struct NoAccessCoinsView : CCoinsView {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\r\n };\r\n \r\n@@ -49,7 +47,8 @@ FUZZ_TARGET(inputfetcher)\r\n         fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\r\n     InputFetcher fetcher{worker_threads};\r\n \r\n-    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\r\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\r\n+    {\r\n         CBlock block;\r\n         Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\r\n \r\n@@ -61,13 +60,13 @@ FUZZ_TARGET(inputfetcher)\r\n         NoAccessCoinsView back;\r\n         CCoinsViewCache main_cache(&back);\r\n \r\n-        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000) {\r\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\r\n+        {\r\n             CMutableTransaction tx;\r\n \r\n-            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10) {\r\n-                const auto txid{fuzzed_data_provider.ConsumeBool()\r\n-                    ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))\r\n-                    : prevhash};\r\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10)\r\n+            {\r\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\r\n                 const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\r\n                 const COutPoint outpoint(txid, index);\r\n \r\n@@ -87,8 +86,8 @@ FUZZ_TARGET(inputfetcher)\r\n                     maybe_coin = std::nullopt;\r\n                 }\r\n                 db_map.try_emplace(outpoint, std::make_pair(\r\n-                    maybe_coin,\r\n-                    fuzzed_data_provider.ConsumeBool()));\r\n+                                                 maybe_coin,\r\n+                                                 fuzzed_data_provider.ConsumeBool()));\r\n \r\n                 // Add the coin to the cache\r\n                 if (fuzzed_data_provider.ConsumeBool()) {\r\ndiff --git a/src/test/inputfetcher_tests.cpp b/src/test/inputfetcher_tests.cpp\r\nindex 33fb8c6cb0..83f3d19432 100644\r\n--- a/src/test/inputfetcher_tests.cpp\r\n+++ b/src/test/inputfetcher_tests.cpp\r\n@@ -48,7 +48,7 @@ private:\r\n \r\n public:\r\n     explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\r\n-                             TestOpts opts = {})\r\n+                              TestOpts opts = {})\r\n         : BasicTestingSetup{chainType, opts}\r\n     {\r\n         SeedRandomForTest(SeedRand::FIXED_SEED);\r\n@@ -200,8 +200,7 @@ BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, InputFetcherTest)\r\n     }\r\n }\r\n \r\n-struct ThrowCoinsView : CCoinsView\r\n-{\r\n+struct ThrowCoinsView : CCoinsView {\r\n     std::optional<Coin> GetCoin(const COutPoint&) const override\r\n     {\r\n         throw std::runtime_error(\"database error\");\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 26141305cb..2ff7c5ef6d 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -1341,7 +1341,8 @@ public:\r\n     void RecalculateBestHeader() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     CCheckQueue<CScriptCheck>& GetCheckQueue() { return m_script_check_queue; }\r\n-    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& main_cache, const CCoinsView& db, const CBlock& block) noexcept {\r\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& main_cache, const CCoinsView& db, const CBlock& block) noexcept\r\n+    {\r\n         m_input_fetcher.FetchInputs(temp_cache, main_cache, db, block);\r\n     }\r\n```\r\n\r\n</details>",
      "created_at": "2025-11-03T08:44:19Z",
      "updated_at": "2025-11-03T08:44:19Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485697378",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485697378"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485772199",
      "pull_request_review_id": 3410060281,
      "id": 2485772199,
      "node_id": "PRRC_kwDOABII586UKd-n",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm, I'm not sure this is correct.\r\n\r\n> Obviously we don't want to use the sorted vector\r\n\r\nThat's not what I'm getting. You were inserting to the same collection over and over, I'm not sure what we were measuring there.\r\nAdding the collection creation and an assertion to not optimize it away (to make sure we're measuring the same thing in every iteration) reveals something completely different.\r\n\r\n<details>\r\n<summary>updated benchmarking code</summary>\r\n\r\n```C++\r\n#include <bench/bench.h>\r\n#include <bench/data/block413567.raw.h>\r\n#include <coins.h>\r\n#include <inputfetcher.h>\r\n#include <primitives/block.h>\r\n#include <serialize.h>\r\n#include <streams.h>\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::vector<Txid> v{};\r\n        v.reserve(block.vtx.size());\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n        u.reserve(block.vtx.size());\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    bench.run([&] {\r\n        std::set<Txid> s{};\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n    });\r\n}\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark, benchmark::PriorityLevel::HIGH);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark, benchmark::PriorityLevel::HIGH);\r\nBENCHMARK(InputFetcher_SetBenchmark, benchmark::PriorityLevel::HIGH);\r\n```\r\n\r\n</details>\r\n\r\n|               ns/op |                op/s |    err% |          ins/op |          cyc/op |    IPC |         bra/op |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|          246,121.59 |            4,063.03 |    0.0% |      978,180.25 |      883,481.68 |  1.107 |     224,954.25 |    2.8% |     11.00 | `InputFetcher_SetBenchmark`\r\n|          130,850.86 |            7,642.29 |    0.2% |      608,319.13 |      469,743.71 |  1.295 |     135,588.13 |    4.4% |     11.04 | `InputFetcher_SortedVectorBenchmark`\r\n|          171,092.09 |            5,844.81 |    0.0% |    1,207,752.53 |      614,142.35 |  1.967 |     174,278.58 |    1.1% |     11.00 | `InputFetcher_UnorderedSetBenchmark`\r\n\r\n\r\n<img width=\"1500\" height=\"860\" alt=\"image\" src=\"https://github.com/user-attachments/assets/548ca5a4-bfe0-478c-9268-d76c6cd91e75\" />\r\n\r\n",
      "created_at": "2025-11-03T09:09:53Z",
      "updated_at": "2025-11-03T09:13:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2485772199",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2485772199"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486129322",
      "pull_request_review_id": 3410536334,
      "id": 2486129322,
      "node_id": "PRRC_kwDOABII586UL1Kq",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": null,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm observing a memory leak in this fuzz test similar to the one we had for the thread pool. Over there, we disabled logging and instantiate only a single pool instance: https://github.com/bitcoin/bitcoin/pull/33689/files#diff-68602d972fe2b027e3987eff0042c27f3f00fc161b7fe871bdb147571f348298R49-R58 . Maybe similar things can be done here?",
      "created_at": "2025-11-03T11:19:24Z",
      "updated_at": "2025-11-03T11:19:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486129322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486129322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486137554",
      "pull_request_review_id": 3410548325,
      "id": 2486137554,
      "node_id": "PRRC_kwDOABII586UL3LS",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Thanks for reporting, that explains why I was seeing\r\n```bash\r\nbench_bitcoin(10874,0x207c84800) malloc: Failed to allocate segment from range group - out of space\r\n```\r\nand\r\n```bash\r\nbitcoind(70369,0x16f5ff000) malloc: Failed to allocate segment from range group - out of space\r\n```\r\nrecently (cc: @maflcko)",
      "created_at": "2025-11-03T11:22:17Z",
      "updated_at": "2025-11-03T11:22:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486137554",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486137554"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486195510",
      "pull_request_review_id": 3410633771,
      "id": 2486195510,
      "node_id": "PRRC_kwDOABII586UMFU2",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "maflcko",
        "id": 6399679,
        "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
        "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/maflcko",
        "html_url": "https://github.com/maflcko",
        "followers_url": "https://api.github.com/users/maflcko/followers",
        "following_url": "https://api.github.com/users/maflcko/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/maflcko/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/maflcko/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/maflcko/subscriptions",
        "organizations_url": "https://api.github.com/users/maflcko/orgs",
        "repos_url": "https://api.github.com/users/maflcko/repos",
        "events_url": "https://api.github.com/users/maflcko/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/maflcko/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Interesting, how would a fuzz target lead to a crash in bench or bitcoind? Did you run it in parallel?\r\n\r\nThough, the suggestion to disable logging is correct, because while fuzzing, we probably don't want to spend cycles on log formatting. I guess those logs only end up in the buffer which causes the memory to grow? (There should be a `DEFAULT_MAX_LOG_BUFFER`, so if buffering is the issue, the memory should be limited)",
      "created_at": "2025-11-03T11:44:36Z",
      "updated_at": "2025-11-03T11:44:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486195510",
      "author_association": "MEMBER",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486195510"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486301326",
      "pull_request_review_id": 3410778296,
      "id": 2486301326,
      "node_id": "PRRC_kwDOABII586UMfKO",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The following patch seems to stabilize memory consumption:\r\n```diff\r\ndiff --git a/src/test/fuzz/inputfetcher.cpp b/src/test/fuzz/inputfetcher.cpp\r\nindex cd2a0f5c68..609b8e1191 100644\r\n--- a/src/test/fuzz/inputfetcher.cpp\r\n+++ b/src/test/fuzz/inputfetcher.cpp\r\n@@ -43 +43,10 @@ struct NoAccessCoinsView : CCoinsView\r\n-FUZZ_TARGET(inputfetcher)\r\n+std::optional<InputFetcher> g_fetcher{};\r\n+\r\n+static void setup_threadpool_test()\r\n+{\r\n+    LogInstance().DisableLogging();\r\n+    g_fetcher.emplace(3);\r\n+}\r\n+\r\n+FUZZ_TARGET(inputfetcher, .init = setup_threadpool_test)\r\n@@ -48,4 +56,0 @@ FUZZ_TARGET(inputfetcher)\r\n-    const auto worker_threads{\r\n-        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\r\n-    InputFetcher fetcher{worker_threads};\r\n-\r\n@@ -115 +120 @@ FUZZ_TARGET(inputfetcher)\r\n-        fetcher.FetchInputs(cache, main_cache, db, block);\r\n+        g_fetcher->FetchInputs(cache, main_cache, db, block);\r\n```",
      "created_at": "2025-11-03T12:23:08Z",
      "updated_at": "2025-11-03T12:23:08Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486301326",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486301326"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486317255",
      "pull_request_review_id": 3410800185,
      "id": 2486317255,
      "node_id": "PRRC_kwDOABII586UMjDH",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Are we sure we're not just masking a real problem with the disabled logger?",
      "created_at": "2025-11-03T12:27:41Z",
      "updated_at": "2025-11-03T12:27:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486317255",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486317255"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486334639",
      "pull_request_review_id": 3410822736,
      "id": 2486334639,
      "node_id": "PRRC_kwDOABII586UMnSv",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "sedited",
        "id": 8421793,
        "node_id": "MDQ6VXNlcjg0MjE3OTM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/8421793?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sedited",
        "html_url": "https://github.com/sedited",
        "followers_url": "https://api.github.com/users/sedited/followers",
        "following_url": "https://api.github.com/users/sedited/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sedited/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sedited/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sedited/subscriptions",
        "organizations_url": "https://api.github.com/users/sedited/orgs",
        "repos_url": "https://api.github.com/users/sedited/repos",
        "events_url": "https://api.github.com/users/sedited/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sedited/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The logger is way less problematic in terms of its effect on the memory growing, and I find it difficult to really pin its effect. Having a global input fetcher that does not get instantiated with every fuzzer iteration has an immediate and clear effect. It is not clear to me if we are are actually leaking anything through the threads, or if creating and destroying thousands of threads per second puts too much pressure on the os (same for the threadpool).",
      "created_at": "2025-11-03T12:33:00Z",
      "updated_at": "2025-11-03T12:33:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486334639",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486334639"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486501704",
      "pull_request_review_id": 3411052521,
      "id": 2486501704,
      "node_id": "PRRC_kwDOABII586UNQFI",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm right I was not clearing the containers, so the sorting was dominating. I retried with clearing and the unordered_map is still slightly faster. In your benchmark you are creating and reserving the map inside the benchmark instead of before. In this implementation the reserved memory is kept in between blocks, so reserving and creating outside makes more sense.",
      "created_at": "2025-11-03T13:30:16Z",
      "updated_at": "2025-11-03T13:30:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486501704",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486501704"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486506578",
      "pull_request_review_id": 3411058494,
      "id": 2486506578,
      "node_id": "PRRC_kwDOABII586UNRRS",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why would short ids matter here though? Isn't that for keeping the bandwidth smaller for compact blocks?",
      "created_at": "2025-11-03T13:31:59Z",
      "updated_at": "2025-11-03T13:31:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486506578",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486506578"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486519559",
      "pull_request_review_id": 3411075340,
      "id": 2486519559,
      "node_id": "PRRC_kwDOABII586UNUcH",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "no, I mean, we don't actually need 256 bits of precision here, just a probabilistic check, so taking the first 32/64 bits of the hash should suffice, since the worst case is just going to disk, so it's not a tragedy if there are false positives, as long as in the average case checks are lot faster",
      "created_at": "2025-11-03T13:36:41Z",
      "updated_at": "2025-11-03T13:36:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486519559",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486519559"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486652576",
      "pull_request_review_id": 3411260777,
      "id": 2486652576,
      "node_id": "PRRC_kwDOABII586UN06g",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Some contention on shared resources is unavoidable. The threads need to synchronize on atomics. There are no locks in this implementation that all other threads need to wait on.\r\n\r\nThe main thread *may* have to wait here if there is a slow fetch, but it would be reading uncontested memory right up until one worker thread flips this bit. None of the other threads are trying to write to this same bit, so there is no contention between the main thread and any other worker threads.",
      "created_at": "2025-11-03T14:20:11Z",
      "updated_at": "2025-11-03T14:20:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486652576",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486652576"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486669187",
      "pull_request_review_id": 3411282133,
      "id": 2486669187,
      "node_id": "PRRC_kwDOABII586UN4-D",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't see why aborting early would prevent us from using less precision. It's doubtful there would be a collision, and if there were that block will just be a little slower to connect. I don't think it would have a measurable effect though, siphashing 64 bits vs 256 here?",
      "created_at": "2025-11-03T14:25:28Z",
      "updated_at": "2025-11-03T14:26:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2486669187",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2486669187"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492188555",
      "pull_request_review_id": 3418805230,
      "id": 2492188555,
      "node_id": "PRRC_kwDOABII586Ui8eL",
      "diff_hunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 18,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "2aa510348143521a14146e41b5cf87cb3e60b29e",
      "in_reply_to_id": 2470286368,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Took the formats, thanks!",
      "created_at": "2025-11-04T22:15:12Z",
      "updated_at": "2025-11-04T22:15:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492188555",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492188555"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492189914",
      "pull_request_review_id": 3418806894,
      "id": 2492189914,
      "node_id": "PRRC_kwDOABII586Ui8za",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    void WorkLoop() noexcept\n+    {\n+        while (true) {\n+            m_barrier.arrive_and_wait();\n+            if (m_request_stop) [[unlikely]] {\n+                return;\n+            }\n+            while (true) {\n+                const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+                if (i >= m_inputs.size()) [[unlikely]] {\n+                    break;\n+                }\n+                auto& input{m_inputs[i]};\n+                // If an input spends an outpoint from earlier in the block,\n+                // it won't be in the cache yet but it also won't be in the db either.\n+                if (m_txids.contains(input.outpoint.hash)) {\n+                    input.status.store(Input::Status::SKIPPED, std::memory_order_relaxed);\n+                    continue;\n+                }\n+                try {\n+                    if (auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)}) {\n+                        input.coin = std::move(*coin);\n+                        if (!input.coin.IsSpent()) [[likely]] { // Coin from cache could be spent\n+                            // We need release here, so setting coin 2 lines above happens before the main thread loads.\n+                            input.status.store(Input::Status::READY, std::memory_order_release);\n+                            continue;\n+                        }\n+                    } else if (auto coin{m_db->GetCoin(input.outpoint)}) {\n+                        input.coin = std::move(*coin); // Coin from db cannot be spent, it does not store spent coins\n+                        // We need release here, so setting coin in the previous line happens before the main thread loads.\n+                        input.status.store(Input::Status::READY, std::memory_order_release);\n+                        continue;\n+                    }\n+                } catch (const std::runtime_error& e) {\n+                    LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+                }\n+                // Input missing or spent. This block will fail validation.\n+                // Skip remaining inputs.\n+                m_input_head.store(m_inputs.size(), std::memory_order_relaxed);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484913752,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I removed the abort early logic, so we keep going if we don't find an input. It makes the logic much simpler, but we will do some more work if we get a block mined that is double spending.",
      "created_at": "2025-11-04T22:15:58Z",
      "updated_at": "2025-11-04T22:15:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492189914",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492189914"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492191544",
      "pull_request_review_id": 3418808858,
      "id": 2492191544,
      "node_id": "PRRC_kwDOABII586Ui9M4",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 33,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928036,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I've updated this to be an atomic_bool instead of this enum. So, since there is only a false value that is set to true, we have the main thread call `input.ready.wait(false, std::memory_order_acquire);`. This way we don't spin.",
      "created_at": "2025-11-04T22:16:53Z",
      "updated_at": "2025-11-04T22:16:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492191544",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492191544"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 32,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492194122",
      "pull_request_review_id": 3418811951,
      "id": 2492194122,
      "node_id": "PRRC_kwDOABII586Ui91K",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "@TheCharlatan thanks for fuzzing, and the diff for the fuzzer! I have taken it, and added you as a co-author :heart_hands:.\r\n\r\n@l0rinc it is concerning that you are getting malloc errors. Are there any other details you can share about this?",
      "created_at": "2025-11-04T22:18:21Z",
      "updated_at": "2025-11-04T22:18:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492194122",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492194122"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492195430",
      "pull_request_review_id": 3418813465,
      "id": 2492195430,
      "node_id": "PRRC_kwDOABII586Ui-Jm",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "aeec2e421d2ba102d905633d474f0fb88f91a9bf",
      "in_reply_to_id": 2484928411,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done, this `Status` enum has been replaced. It is now just an `atomic_bool` `ready`.",
      "created_at": "2025-11-04T22:19:03Z",
      "updated_at": "2025-11-04T22:19:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2492195430",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2492195430"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2493940857",
      "pull_request_review_id": 3421210209,
      "id": 2493940857,
      "node_id": "PRRC_kwDOABII586UpoR5",
      "diff_hunk": "@@ -0,0 +1,197 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <primitives/transaction_identifier.h>\n+#include <tinyformat.h>\n+#include <txdb.h>\n+#include <util/hasher.h>\n+#include <util/threadnames.h>\n+\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the status is\n+ * atomically updated to READY. The main thread spin loops on the status field\n+ * until it is READY and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    alignas(64) std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        enum class Status : uint8_t {\n+            WAITING, // The coin has not been fetched yet\n+            READY, // The coin has been fetched and is ready to be inserted into the cache\n+            FAILED, // The coin failed to be fetched\n+            SKIPPED, // The coin is created and spent in the same block so cannot be fetched\n+        };\n+\n+        //! Workers update this after setting the coin. The main thread spins on this until it is not WAITING.\n+        std::atomic<Status> status{Status::WAITING};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::unordered_set<Txid, SaltedTxidHasher> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 71,
      "commit_id": "9ea30540974900de38d5485d133adaeb6123e803",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484858152,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> In this implementation the reserved memory is kept in between blocks\r\n\r\nK, so let's reserve outside and clear inside.\r\nNow that missing values aren't failures, we can experiment with shortids - since a missing value isn't a failure anymore (even though I wouldn't expect any collisions in 64 bits either, assuming uniform distribution. But even if the distribution isn't uniform, we can likely store it safely).\r\n64 bit ids for internal spends would mean that in case of some collision we will attempt to fetch something from disk that was actually in the current block - so the attacker can at best slow down block validation by a few milliseconds.\r\n\r\n<details>\r\n<summary>sorted/unsorted/vector benchmarks & shortids</summary>\r\n\r\n```C++\r\n// Copyright (c) 2022-present The Bitcoin Core developers\r\n// Distributed under the MIT software license, see the accompanying\r\n// file COPYING or https://www.opensource.org/licenses/mit-license.php.\r\n\r\n#include <algorithm>\r\n#include <bench/bench.h>\r\n#include <bench/data/block413567.raw.h>\r\n#include <bench/nanobench.h>\r\n#include <coins.h>\r\n#include <functional>\r\n#include <inputfetcher.h>\r\n#include <primitives/block.h>\r\n#include <primitives/transaction_identifier.h>\r\n#include <random.h>\r\n#include <ranges>\r\n#include <serialize.h>\r\n#include <set>\r\n#include <streams.h>\r\n#include <unordered_set>\r\n#include <util/check.h>\r\n#include <util/hasher.h>\r\n#include <vector>\r\n\r\nnamespace {\r\nconstexpr size_t iterations{100}; // since the inputs of the benchmarks are mutated by sorting, we can't rerun the benchmarks\r\nconstexpr size_t hits_count{275}; // assuming ~5% of blocks contain internal spends\r\nconstexpr size_t tx_count{5500};\r\n\r\nuint64_t GetShortID(const Txid& txid)\r\n{\r\n    return txid.ToUint256().GetUint64(0);\r\n}\r\n\r\ntemplate <typename T>\r\nstruct Dataset {\r\n    std::set<T> sorted_set;\r\n    std::unordered_set<T, std::conditional_t<std::is_same_v<T, Txid>, SaltedTxidHasher, std::identity>> unsorted_set;\r\n    std::vector<T> vec_sorted;\r\n    std::vector<T> vec_unsorted;\r\n    std::vector<T> queries;\r\n\r\n    static T Convert(const Txid& txid)\r\n    {\r\n        if constexpr (std::is_same_v<T, Txid>) {\r\n            return txid;\r\n        } else {\r\n            static_assert(std::is_same_v<T, uint64_t>);\r\n            return GetShortID(txid);\r\n        }\r\n    }\r\n};\r\n\r\ntemplate <typename T>\r\nstd::vector<Dataset<T>> BuildDatasets()\r\n{\r\n    FastRandomContext rng(/*fDeterministic=*/true);\r\n\r\n    std::vector<Dataset<T>> datasets;\r\n    datasets.reserve(iterations);\r\n\r\n    for (size_t d{0}; d < iterations; ++d) {\r\n        Dataset<T> ds;\r\n        ds.queries.reserve(tx_count);\r\n        ds.unsorted_set.reserve(tx_count);\r\n        ds.vec_sorted.reserve(tx_count);\r\n        ds.vec_unsorted.reserve(tx_count);\r\n\r\n        for (size_t i{0}; i < tx_count; ++i) {\r\n            T t1{Dataset<T>::Convert(Txid::FromUint256(rng.rand256()))};\r\n            ds.sorted_set.emplace(t1);\r\n            ds.unsorted_set.emplace(t1);\r\n            ds.vec_sorted.emplace_back(t1);\r\n            ds.vec_unsorted.emplace_back(t1);\r\n\r\n            T t2{Dataset<T>::Convert(Txid::FromUint256(rng.rand256()))};\r\n            ds.queries.emplace_back(i < hits_count ? t1 : t2);\r\n        }\r\n\r\n        std::ranges::shuffle(ds.queries, rng);\r\n        std::ranges::shuffle(ds.vec_unsorted, rng);\r\n        std::sort(ds.vec_sorted.begin(), ds.vec_sorted.end());\r\n\r\n        datasets.emplace_back(std::move(ds));\r\n    }\r\n    return datasets;\r\n}\r\n} // namespace\r\n\r\nstatic void Txid_UnorderedSalted(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::binary_search(s.vec_sorted.begin(), s.vec_sorted.end(), q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<Txid>()};\r\n    const auto contains_linear{[](const std::vector<Txid>& v, const Txid& x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_UnorderedSalted_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.unsorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_SetOrdered_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += s.sorted_set.contains(q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorBinarySearch_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += std::ranges::binary_search(s.vec_sorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void Txid_VectorLinearScan_shortid(benchmark::Bench& bench)\r\n{\r\n    static auto ds{BuildDatasets<uint64_t>()};\r\n    const auto contains_linear{[](const std::vector<uint64_t>& v, uint64_t x) noexcept {\r\n        return std::ranges::find(v, x) != v.end();\r\n    }};\r\n    bench.epochs(1).epochIterations(1).batch(iterations).run([&] {\r\n        size_t sum{0};\r\n        for (const auto& s : ds) {\r\n            for (const auto& q : s.queries) {\r\n                sum += contains_linear(s.vec_unsorted, q);\r\n            }\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(sum);\r\n        Assert(sum == iterations * hits_count);\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::vector<Txid> v{};\r\n    v.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(tx->GetHash());\r\n        }\r\n        std::sort(v.begin(), v.end());\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n        v.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::unordered_set<Txid, SaltedTxidHasher> u{};\r\n    u.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n        u.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::set<Txid> s{};\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(tx->GetHash());\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n        s.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SortedVectorBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::vector<uint64_t> v{};\r\n    v.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            v.emplace_back(GetShortID(tx->GetHash()));\r\n        }\r\n        std::ranges::sort(v);\r\n        ankerl::nanobench::doNotOptimizeAway(v);\r\n        v.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_UnorderedSetBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::unordered_set<uint64_t> u{};\r\n    u.reserve(block.vtx.size());\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            u.emplace(GetShortID(tx->GetHash()));\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(u);\r\n        u.clear();\r\n    });\r\n}\r\n\r\nstatic void InputFetcher_SetBenchmark_shortid(benchmark::Bench& bench)\r\n{\r\n    CBlock block;\r\n    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\r\n\r\n    std::set<uint64_t> s{};\r\n    bench.run([&] {\r\n        for (const auto& tx : block.vtx) {\r\n            s.insert(GetShortID(tx->GetHash()));\r\n        }\r\n        ankerl::nanobench::doNotOptimizeAway(s);\r\n        s.clear();\r\n    });\r\n}\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_SetBenchmark, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(InputFetcher_SortedVectorBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_UnorderedSetBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(InputFetcher_SetBenchmark_shortid, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(Txid_UnorderedSalted, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan, benchmark::PriorityLevel::LOW);\r\n\r\nBENCHMARK(Txid_UnorderedSalted_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_SetOrdered_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorBinarySearch_shortid, benchmark::PriorityLevel::LOW);\r\nBENCHMARK(Txid_VectorLinearScan_shortid, benchmark::PriorityLevel::LOW);\r\n```\r\n\r\n</details>\r\n\r\n\r\n<img width=\"1487\" height=\"864\" alt=\"image\" src=\"https://github.com/user-attachments/assets/8f971f62-87c7-496f-a060-0dec2bb9cc51\" />\r\n\r\nThe new measurements indicate that the single-threaded preparation is 4x faster with a sorted vector, while multithreaded search is more than 2x faster with small ids compared to the current approach. Worth investigating further, I'd say :)",
      "created_at": "2025-11-05T10:48:39Z",
      "updated_at": "2025-11-05T10:52:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2493940857",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2493940857"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 64,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2494844175",
      "pull_request_review_id": 3422525781,
      "id": 2494844175,
      "node_id": "PRRC_kwDOABII586UtE0P",
      "diff_hunk": "@@ -0,0 +1,191 @@\n+// Copyright (c) 2025-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <stdexcept>\n+#include <string>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(inputfetcher_tests)\n+\n+struct InputFetcherTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<InputFetcher> m_fetcher{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (auto i{1}; i < num_txs; ++i) {\n+            CMutableTransaction tx;\n+            const auto txid{m_rng.randbool() ? Txid::FromUint256(uint256(i)) : prevhash};\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit InputFetcherTest(const ChainType chainType = ChainType::MAIN,\n+                             TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto cores{GetNumCores()};\n+        const auto num_txs{m_rng.randrange(cores * 10)};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+        const auto worker_threads{m_rng.randrange(cores * 2) + 1};\n+        m_fetcher = std::make_unique<InputFetcher>(worker_threads);\n+    }\n+\n+    InputFetcher& getFetcher() { return *m_fetcher; }\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs, InputFetcherTest)\n+{\n+    const auto& block{getBlock()};\n+    for (auto i{0}; i < 3; ++i) {\n+        CCoinsView dummy;\n+        CCoinsViewCache db(&dummy);\n+\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                auto outpoint{in.prevout};\n+                Coin coin{};\n+                coin.out.nValue = 1;\n+                db.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+            }\n+        }\n+\n+        CCoinsViewCache main_cache(&db);\n+        CCoinsViewCache cache(&cache);",
      "path": "src/test/inputfetcher_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "62868c8846f043477d128788eadced3e71522417",
      "original_commit_id": "62868c8846f043477d128788eadced3e71522417",
      "in_reply_to_id": 2484980972,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Can we assert the behavior of the main cache as well so that the previous version doesn't pass?\r\n\r\nNeither the temp cache or the main cache touch their backing cache in the input fetcher. So, we can't assert a failure if the backing cache is something else. We can assert that the backing view is not touched during `FetchInputs`, which is done in the fuzz harness.",
      "created_at": "2025-11-05T14:43:45Z",
      "updated_at": "2025-11-05T14:43:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2494844175",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2494844175"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2497861709",
      "pull_request_review_id": 3426708700,
      "id": 2497861709,
      "node_id": "PRRC_kwDOABII586U4lhN",
      "diff_hunk": "@@ -0,0 +1,145 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <consensus/amount.h>\n+#include <inputfetcher.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <utility>\n+\n+using DbMap = std::map<const COutPoint, std::pair<std::optional<const Coin>, bool>>;\n+\n+struct DbCoinsView : CCoinsView\n+{\n+    DbMap& m_map;\n+    DbCoinsView(DbMap& map) noexcept : m_map(map) {}\n+\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        const auto it{m_map.find(outpoint)};\n+        assert(it != m_map.end());\n+        const auto [coin, err] = it->second;\n+        if (err) {\n+            throw std::runtime_error(\"database error\");\n+        }\n+        return coin;\n+    }\n+};\n+\n+struct NoAccessCoinsView : CCoinsView\n+{\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+FUZZ_TARGET(inputfetcher)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    const auto worker_threads{\n+        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(2, 4)};\n+    InputFetcher fetcher{worker_threads};",
      "path": "src/test/fuzz/inputfetcher.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "d606c36a13ca2a055d1a4eb4c623fb6aa45405b2",
      "original_commit_id": "21e5e10bf30baca89226e5ecb32919625dc8539a",
      "in_reply_to_id": 2486129322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Did the same on master:\r\n```\r\ngit log -1\r\ncommit 5c5704e730796c6f31e2d7891bf6334674a04219 (HEAD, upstream/master, upstream/HEAD, origin/master, origin/HEAD)\r\n```\r\nand unfortunately I'm getting the same:\r\n```\r\ntime ./build/bin/bitcoind -stopatheight=921129 -dbcache=45000 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=4500 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\\\r\n&& time ./build/bin/bitcoind -stopatheight=921129 -dbcache=450 -reindex-chainstate -blocksonly -connect=0 -printtoconsole=0\r\nbitcoind(71239,0x170f2f000) malloc: Failed to allocate segment from range group - out of space\r\n...\r\n```\r\nso it's not related to this PR\r\n\r\nAlso fuzzed for almost a day, no problems came up:\r\n```\r\n...\r\n#12935791       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1640/4082 MS: 3 EraseBytes-PersAutoDict-InsertRepeatedBytes- DE: \"\\001\\\\\"-\r\n#12941278       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1734/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\377\\031\"-\r\n#12943860       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1303/4082 MS: 2 InsertByte-EraseBytes-\r\n#12956441       REDUCE cov: 1485 ft: 9496 corp: 917/727Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2407/4082 MS: 1 EraseBytes-\r\n#12973964       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2400/4082 MS: 3 ChangeByte-ChangeBinInt-EraseBytes-\r\n#12980710       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1835/4082 MS: 1 EraseBytes-\r\n#12986931       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 471/4082 MS: 1 EraseBytes-\r\n#12987148       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 1295/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\377\\377\\377\\377\"-\r\n#13001660       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2399/4082 MS: 2 PersAutoDict-EraseBytes- DE: \"\\332\\377\\377\\377\"-\r\n#13008530       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 3079/4082 MS: 5 ChangeByte-PersAutoDict-EraseBytes-ChangeASCIIInt-InsertRepeatedBytes- DE: \"\\363\\006\\000\\000\\000\\000\\000\\000\"-\r\n#13015051       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 3063/4082 MS: 1 EraseBytes-\r\n#13026498       REDUCE cov: 1485 ft: 9496 corp: 917/726Kb lim: 4096 exec/s: 475 rss: 189Mb L: 2374/4082 MS: 2 ChangeBinInt-EraseBytes-\r\n```\r\n",
      "created_at": "2025-11-06T07:49:13Z",
      "updated_at": "2025-11-06T07:50:01Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2497861709",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2497861709"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499419184",
      "pull_request_review_id": 3428778459,
      "id": 2499419184,
      "node_id": "PRRC_kwDOABII586U-hww",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 81,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "when can this be true?",
      "created_at": "2025-11-06T15:22:17Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499419184",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499419184"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499420838",
      "pull_request_review_id": 3428778459,
      "id": 2499420838,
      "node_id": "PRRC_kwDOABII586U-iKm",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 83,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n```",
      "created_at": "2025-11-06T15:22:46Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499420838",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499420838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 83,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499427113",
      "pull_request_review_id": 3428778459,
      "id": 2499427113,
      "node_id": "PRRC_kwDOABII586U-jsp",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 93,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: trailing newline shouldn't be needed anymore\n\n```suggestion\n                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\", e.what());\n```",
      "created_at": "2025-11-06T15:24:14Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499427113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499427113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 93,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499430732",
      "pull_request_review_id": 3428778459,
      "id": 2499430732,
      "node_id": "PRRC_kwDOABII586U-klM",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 120,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\n        std::ranges::sort(m_txids);\n```",
      "created_at": "2025-11-06T15:24:55Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499430732",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499430732"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 120,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499442182",
      "pull_request_review_id": 3428778459,
      "id": 2499442182,
      "node_id": "PRRC_kwDOABII586U-nYG",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait\n+                if (!FetchCoin()) {\n+                    input.ready.wait(false, std::memory_order_acquire);",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 134,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "based on https://en.cppreference.com/w/cpp/atomic/atomic_flag/wait.html\n```suggestion\n                    input.ready.wait(/*old*/false, std::memory_order_acquire);\n```",
      "created_at": "2025-11-06T15:26:50Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499442182",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499442182"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499446404",
      "pull_request_review_id": 3428778459,
      "id": 2499446404,
      "node_id": "PRRC_kwDOABII586U-oaE",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "not yet sure I fully understand why this is needed - it's more complex, but does it result in at least a theoretic speedup?",
      "created_at": "2025-11-06T15:27:26Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499446404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499446404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499449442",
      "pull_request_review_id": 3428778459,
      "id": 2499449442,
      "node_id": "PRRC_kwDOABII586U-pJi",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait\n+                if (!FetchCoin()) {\n+                    input.ready.wait(false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin.IsSpent()) continue;\n+            temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 139,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`continue` effectively skipping the last line is a bit confusing an dangerous - it should only skip the next line:\r\n```suggestion\r\n            if (!input.coin.IsSpent()) {\r\n                temp_cache.EmplaceCoinInternalDANGER(COutPoint{input.outpoint}, std::move(input.coin));\r\n            }\r\n```",
      "created_at": "2025-11-06T15:27:53Z",
      "updated_at": "2025-11-06T15:36:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499449442",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499449442"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 138,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 139,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499464047",
      "pull_request_review_id": 3428778459,
      "id": 2499464047,
      "node_id": "PRRC_kwDOABII586U-stv",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 61,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "should we document here what happens in case of a cache miss or collision?",
      "created_at": "2025-11-06T15:29:59Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499464047",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499464047"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 70,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499486476",
      "pull_request_review_id": 3428778459,
      "id": 2499486476,
      "node_id": "PRRC_kwDOABII586U-yMM",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 76,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this will fix the linter failure as well (whitespace after `*`):\n```suggestion\n     * \n     * @return whether there are more inputs in the queue to fetch\n```",
      "created_at": "2025-11-06T15:33:54Z",
      "updated_at": "2025-11-06T15:35:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499486476",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499486476"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 74,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 76,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499916845",
      "pull_request_review_id": 3429394484,
      "id": 2499916845,
      "node_id": "PRRC_kwDOABII586VAbQt",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 78,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we call it something else to not coincide with `CCoinsViewCache::FetchCoin`",
      "created_at": "2025-11-06T17:00:11Z",
      "updated_at": "2025-11-06T17:00:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2499916845",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2499916845"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 78,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500031838",
      "pull_request_review_id": 3429535933,
      "id": 2500031838,
      "node_id": "PRRC_kwDOABII586VA3Ve",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 81,
      "commit_id": "d6fac85ee4465cce8e81e36cdfd46636d34725fa",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499419184,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is true when all inputs have been fetched from the block. We want the compiler to optimize for the case where we have work.",
      "created_at": "2025-11-06T17:28:06Z",
      "updated_at": "2025-11-06T17:33:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500031838",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500031838"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 90,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500047237",
      "pull_request_review_id": 3429554524,
      "id": 2500047237,
      "node_id": "PRRC_kwDOABII586VA7GF",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The work done on the other threads is much slower than what the main thread is doing. Fetching inputs possibly from disk vs inserting coins into the temporary cache. So, in cases where there are fewer worker threads the main thread will likely be waiting on the work to be done. In these cases we can just start fetching as well. I think this would have a large impact in cases where there are few worker threads (like rpis), or if using a low but > 1 -par value. For instance, using `-par=2` this would in theory double the efficiency of fetching inputs from disk. It is likely not a measurable effect for setups that have 16 or more vcpus.",
      "created_at": "2025-11-06T17:31:33Z",
      "updated_at": "2025-11-06T17:32:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500047237",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500047237"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500222372",
      "pull_request_review_id": 3429762642,
      "id": 2500222372,
      "node_id": "PRRC_kwDOABII586VBl2k",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure I understand why, what's the difference between *two threads working while main is waiting* vs *one thread working and main also working*?\r\nWhere does the difference come from (especially given that the work is not fully cpu-bound)?",
      "created_at": "2025-11-06T18:09:45Z",
      "updated_at": "2025-11-06T18:09:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500222372",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500222372"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500300779",
      "pull_request_review_id": 3429863156,
      "id": 2500300779,
      "node_id": "PRRC_kwDOABII586VB4_r",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> two threads working while main is waiting vs one thread working and main also working?\r\n\r\nIt would be two threads working while main is waiting vs two threads working and main also working? So the latter has 3 threads working vs the former's 2 threads working. If using `-par=3` this is the case. 50% more work is done in parallel. ",
      "created_at": "2025-11-06T18:29:10Z",
      "updated_at": "2025-11-06T18:31:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500300779",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500300779"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500406322",
      "pull_request_review_id": 3429996035,
      "id": 2500406322,
      "node_id": "PRRC_kwDOABII586VCSwy",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "So why not just do the work that `par` defined and leave main asleep, wouldn't that be simpler while basically achieving exactly the same?",
      "created_at": "2025-11-06T18:52:50Z",
      "updated_at": "2025-11-06T18:52:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500406322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500406322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500437404",
      "pull_request_review_id": 3430036138,
      "id": 2500437404,
      "node_id": "PRRC_kwDOABII586VCaWc",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No because we would have to insert all entries into temp cache at the end, instead of parallelizing that work as well. That was the previous implementation where we waited for every thread to be done and then inserted everything in series before exiting.\nNow, the main thread does both. It inserts while others are fetching, but if it inserts fast enough where it is waiting for new entries it will also fetch entries.",
      "created_at": "2025-11-06T19:02:28Z",
      "updated_at": "2025-11-06T19:02:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500437404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500437404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500462588",
      "pull_request_review_id": 3430067614,
      "id": 2500462588,
      "node_id": "PRRC_kwDOABII586VCgf8",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "On a system with 15 worker threads + main, it is likely that main will not be waiting much. The other 15 threads are busy setting newly fetched coins to ready so that the main thread can continuously read `true` for the ready flags.\r\nOn a system with only 3 worker threads + main, it is likely that the 3 worker threads will not be able to fetch and set ready coins fast enough where the main thread does not have to wait. For instance all 3 threads are fetching from disk, and the main thread reads the next input and ready is still `false`. So now it can either wait until one of the 3 worker threads fetches an input from disk, or it can start helping out the 3 workers and fetch from disk itself. This will increase parallel throughput by 33%, since 4 workers are fetching instead of just 3. Then when main returns with its fetched coin, main can insert the rest of the coins that the workers have fetched and set ready while main was busy fetching. Then it will catch up again to the latest input that is not yet ready, and fetch another coin.",
      "created_at": "2025-11-06T19:10:26Z",
      "updated_at": "2025-11-06T19:17:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500462588",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500462588"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500696484",
      "pull_request_review_id": 3430354624,
      "id": 2500696484,
      "node_id": "PRRC_kwDOABII586VDZmk",
      "diff_hunk": "@@ -0,0 +1,174 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_INPUTFETCHER_H\n+#define BITCOIN_INPUTFETCHER_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <logging.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <stdexcept>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+/**\n+ * Helper for fetching inputs from the CoinsDB and CoinsTip and inserting them\n+ * into the ephemeral cache used in ConnectBlock.\n+ *\n+ * It spawns a fixed set of worker threads that fetch Coins for each input\n+ * in a block. The Coin is moved into the Input struct and then the ready flag\n+ * is atomically updated to true. The main thread waits on the ready flag\n+ * until it is true and then inserts it into the temporary cache.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which\n+ * is used at the beginning of fetching to start the workers and at the end to\n+ * make sure all workers have exited the work loop.\n+ */\n+class InputFetcher\n+{\n+private:\n+    //! The latest input being fetched. Workers atomically increment this when fetching.\n+    std::atomic_size_t m_input_head{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct Input {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        Coin coin{};\n+\n+        Input(Input&& other) noexcept : outpoint{other.outpoint} {} // Only moved in setup for reallocation.\n+        explicit Input(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    std::vector<Input> m_inputs{};\n+\n+    /**\n+     * The set of first 8 bytes of txids of all txs in the block being fetched.\n+     * Used to filter out inputs that are created and spent in the same block,\n+     * since they will not be in the db or the cache.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView* m_db{nullptr};\n+    //! The cache to fetch from.\n+    const CCoinsViewCache* m_cache{nullptr};\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    /**\n+     * Fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     * \n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool FetchCoin() noexcept\n+    {\n+        const size_t i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        if (std::binary_search(m_txids.begin(), m_txids.end(), input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        auto coin{m_cache->GetPossiblySpentCoinFromCache(input.outpoint)};\n+        if (!coin) {\n+            try {\n+                coin = m_db->GetCoin(input.outpoint);\n+            } catch (const std::runtime_error& e) {\n+                LogPrintLevel(BCLog::VALIDATION, BCLog::Level::Warning, \"InputFetcher failed to fetch input: %s.\\n\", e.what());\n+            }\n+        }\n+        if (coin && !coin->IsSpent()) [[likely]] input.coin = std::move(*coin);\n+        // We need release here, so setting coin above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+public:\n+    //! Fetch all block inputs from cache or db, and insert into temp_cache.\n+    void FetchInputs(CCoinsViewCache& temp_cache, const CCoinsViewCache& cache, const CCoinsView& db, const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1 || m_worker_threads.size() == 0) return;\n+\n+        // Loop through the inputs of the block and set them in the queue.\n+        // Construct the set of txids to filter, and count the outputs to reserve for temp_cache.\n+        m_txids.reserve(block.vtx.size() - 1);\n+        m_inputs.reserve(2 * block.vtx.size()); // rough guess\n+        auto outputs_count{block.vtx[0]->vout.size()};\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            outputs_count += tx->vout.size();\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        std::sort(m_txids.begin(), m_txids.end());\n+\n+        // Setup shared pointers and start workers.\n+        m_db = &db;\n+        m_cache = &cache;\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_barrier.arrive_and_wait();\n+\n+        // Insert fetched coins into the temp_cache as they are set to ready.\n+        temp_cache.Reserve(temp_cache.GetCacheSize() + m_inputs.size() + outputs_count);\n+        for (auto& input : m_inputs) {\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work too while we wait",
      "path": "src/inputfetcher.h",
      "position": 1,
      "original_position": 132,
      "commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "original_commit_id": "63dde36c1dac94c3e5223aee5ba97e5b2475381c",
      "in_reply_to_id": 2499446404,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We discussed this out of band, here's the summary:\r\n* the main thread is special because it has access to the dbcache, it can insert there without locking the cache.\r\n* the threads each have their inputs now, each of which have a switch to signal when they've fetched the input and move on to the next\r\n* the threads each compete for which input to fetch, marking them one-by-one as ready\r\n* the main thread goes in order, spins until the next one is available, if it needs to wait, it does some fetching itself, rechecks later if the given value is available and if so, it inserts to the dbcache, after which it checks the next value in order.\r\n\r\nThis way the IO and CPU bound work is parallelized, so we don't need to do the heavy rehashing at the end, it's done while the other threads are doing IO work - that's why it's faster.\r\n\r\nI have to think about this, it sounds like we can simplify this further, but this is already an improvement over previous solutions.\r\n\r\n---\r\n\r\nAnd given that the worst thing that can happen for an internal spend is that if there's another input with the same prefix in the same block, we wouldn't fetch it here and it would be fetched during block connection like it was done before.\r\nThis means that we likely don't even need 64 bits for that, likely 32 are enough. Back of the napkin calculations indicate that would mean that 1/1000 blocks would contain transactions that won't be fetched by `InputFetcher` and would need to be fetched during block connection instead on a single thread. As long as 32 bit checks are faster than 64 (which should definitely be the case for the sorted-vector case), this should likely result in an overall speedup. We definitely need to add a test case for that.",
      "created_at": "2025-11-06T20:18:07Z",
      "updated_at": "2025-11-06T20:18:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2500696484",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2500696484"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 132,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568405428",
      "pull_request_review_id": 3515011880,
      "id": 2568405428,
      "node_id": "PRRC_kwDOABII586ZFsG0",
      "diff_hunk": "@@ -401,6 +401,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n      */\n     bool HaveCoinInCache(const COutPoint &outpoint) const;\n \n+    /**\n+     * Retrieves the coin from the cache even if it is spent, without calling",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 5,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: other comments use the bare verb form\r\n\r\n```suggestion\r\n     * Retrieve the coin from the cache even if it is spent, without calling\r\n```",
      "created_at": "2025-11-27T12:21:29Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568405428",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568405428"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 405,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568436113",
      "pull_request_review_id": 3515011880,
      "id": 2568436113,
      "node_id": "PRRC_kwDOABII586ZFzmR",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 85,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This highlights that our dbcache layering is a bit messy â€“ having to static_cast the base view to CCoinsViewCache here is quite ugly. It would be good to clean this up in a follow-up.",
      "created_at": "2025-11-27T12:28:30Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568436113",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568436113"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 87,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568598322",
      "pull_request_review_id": 3515011880,
      "id": 2568598322,
      "node_id": "PRRC_kwDOABII586ZGbMy",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    g_db->EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);\n+            const auto coin{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+            if (coin) {\n+                assert(!coin->IsSpent());\n+                outpoints_in_cache.emplace(outpoint);\n+            }\n+            const auto& db_it{db_map.find(outpoint)};\n+            const auto cache_it{cache_map.find(outpoint)};\n+            if (!coin) {\n+                // If we don't have a coin, then it's either spent in cache or missing\n+                const auto spent_cache_coin{cache_it != cache_map.end() && cache_it->second.IsSpent()};\n+                const auto no_coin{cache_it == cache_map.end() && db_it == db_map.end()};\n+                assert(spent_cache_coin || no_coin);\n+            } else if (cache_it != cache_map.end()) {\n+                // Make sure we have the main cache coin if it exists instead of db\n+                const auto& cache_coin{cache_it->second};\n+                assert(!cache_coin.IsSpent());\n+                assert(coin->fCoinBase == cache_coin.fCoinBase);\n+                assert(coin->nHeight == cache_coin.nHeight);\n+                assert(coin->out == cache_coin.out);\n+            } else {\n+                assert(db_it != db_map.end());\n+                // Check any coins not in the main cache are the same as the db\n+                const auto& db_coin{db_it->second};\n+                assert(coin->fCoinBase == db_coin.fCoinBase);\n+                assert(coin->nHeight == db_coin.nHeight);\n+                assert(coin->out == db_coin.out);\n+            }\n+        }\n+        assert(cache.GetCacheSize() == outpoints_in_cache.size());\n+        fuzzed_data_provider.ConsumeBool() ? (void)cache.Flush() : cache.Reset();",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 164,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Weâ€™re [moving towards Flush not returning a value](https://github.com/bitcoin/bitcoin/pull/33866/files#diff-f0ed73d62dae6ca28ebd3045e5fc0d5d02eaaacadb4c2a292985a3fbd7e1c77cR257) â€“ can we avoid adding new code that relies on its return? Not sure itâ€™s possible before that other PR lands, but worth keeping in mind.",
      "created_at": "2025-11-27T13:05:34Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568598322",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568598322"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 170,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568602665",
      "pull_request_review_id": 3515011880,
      "id": 2568602665,
      "node_id": "PRRC_kwDOABII586ZGcQp",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{1ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 21,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I wonder if we could change this benchmark to use an actual LevelDB-backed view instead of a synthetic delay â€“ and maybe reuse the setup from https://github.com/bitcoin/bitcoin/pull/32554 for a more realistic measurement?",
      "created_at": "2025-11-27T13:06:45Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568602665",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568602665"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 21,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568610778",
      "pull_request_review_id": 3515011880,
      "id": 2568610778,
      "node_id": "PRRC_kwDOABII586ZGePa",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;\n+        std::ranges::sort(m_txids);\n+        // Start workers.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (uint32_t n{0}; n < WORKER_THREADS; ++n) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "19bc07e8adbced7f222fab96ac935b7fdcd4c2fa",
      "original_commit_id": "fc4346fe0500fa1dbb4b881944296cd3bd112ad7",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: now that this is `CoinsViewCacheAsync`, maybe rename the thread prefix from \"inputfetcher.%i\" to something like \"coinsviewcacheasync.%i\" or similar, to reflect the current design.",
      "created_at": "2025-11-27T13:08:33Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568610778",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568610778"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568636267",
      "pull_request_review_id": 3515011880,
      "id": 2568636267,
      "node_id": "PRRC_kwDOABII586ZGkdr",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{1ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+};\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db{};\n+    CCoinsViewCache main_cache(&db);\n+    CoinsViewCacheAsync async_cache{main_cache, db};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        async_cache.Reset();\n+    });\n+}\n+\n+BENCHMARK(CoinsViewCacheAsyncBenchmark, benchmark::PriorityLevel::HIGH);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 43,
      "commit_id": "13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: the formatter should enforce a trailing newline at the end of C++ source files; could you add one here?",
      "created_at": "2025-11-27T13:15:56Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568636267",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568636267"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 51,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568638933",
      "pull_request_review_id": 3515011880,
      "id": 2568638933,
      "node_id": "PRRC_kwDOABII586ZGlHV",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{1ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+};\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db{};\n+    CCoinsViewCache main_cache(&db);\n+    CoinsViewCacheAsync async_cache{main_cache, db};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 38,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What if we added a second run inside the same benchmark that calls `StartFetching` again or a series of `AccessCoin` calls - to exercise the â€œeverything is already in the cacheâ€ path (similar to a large -dbcache scenario)?",
      "created_at": "2025-11-27T13:16:40Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568638933",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568638933"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568644363",
      "pull_request_review_id": 3515011880,
      "id": 2568644363,
      "node_id": "PRRC_kwDOABII586ZGmcL",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 39,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "\r\nSame idea as in the bench: would it be feasible to fuzz this against an actual LevelDB-backed view instead of a synthetic cache, or is that too expensive / complicated for now?",
      "created_at": "2025-11-27T13:18:07Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568644363",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568644363"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 39,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568645746",
      "pull_request_review_id": 3515011880,
      "id": 2568645746,
      "node_id": "PRRC_kwDOABII586ZGmxy",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 67,
      "commit_id": "5810e364b0bd106425e4c2e727a08e1bf546cb59",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Why do we need this cache to be constructed with deterministic=true here? Is the deterministic ordering actually required for the fuzz harness, or could we drop that?",
      "created_at": "2025-11-27T13:18:32Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568645746",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568645746"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 55,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568652521",
      "pull_request_review_id": 3515011880,
      "id": 2568652521,
      "node_id": "PRRC_kwDOABII586ZGobp",
      "diff_hunk": "@@ -401,6 +401,14 @@ class CCoinsViewCache : public CCoinsViewBacked\n      */\n     bool HaveCoinInCache(const COutPoint &outpoint) const;\n \n+    /**\n+     * Retrieves the coin from the cache even if it is spent, without calling\n+     * the backing CCoinsView if no coin exists.\n+     * Used in CoinsViewCacheAsync to make sure we do not add a coin from the backing\n+     * view when it is spent in the cache but not yet flushed to the parent.\n+     */\n+    std::optional<Coin> GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept;",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 10,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As mentioned before, Iâ€™m not a fan of adding a separate â€œget-possibly-spentâ€ helper â€“ it feels like spentness is a separate concern and weâ€™re encoding it into the accessor. I still think long term itâ€™d be cleaner if GetCoin always returned the raw coin and call sites handled spentness explicitly, but I understand thatâ€™s probably a separate cleanup.",
      "created_at": "2025-11-27T13:20:09Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568652521",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568652521"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 410,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568659911",
      "pull_request_review_id": 3515011880,
      "id": 2568659911,
      "node_id": "PRRC_kwDOABII586ZGqPH",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};",
      "path": "src/coinsviewcacheasync.h",
      "position": 101,
      "original_position": 47,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm, can the main thread keep track of this locally instead of storing `m_input_tail` as a member? It looks like weâ€™re effectively simulating a queue here (claiming work from the â€œheadâ€ and consuming from the â€œtailâ€). Could we use an actual `std::deque` or similar, or would that invalidate indices / references that the workers rely on?",
      "created_at": "2025-11-27T13:21:48Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568659911",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568659911"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 101,
      "original_line": 101,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568667352",
      "pull_request_review_id": 3515011880,
      "id": 2568667352,
      "node_id": "PRRC_kwDOABII586ZGsDY",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a",
      "path": "src/coinsviewcacheasync.h",
      "position": 124,
      "original_position": 70,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Do we have tests that explicitly exercise the 8-byte prefix collision case (i.e. two txids in the same block sharing the same first 64 bits)? If we used 32-bit prefixes instead, collisions would be much more frequent, but the structure would be smaller; did we benchmark 32-bit vs 64-bit prefixes, or is 64-bit a conservative choice?",
      "created_at": "2025-11-27T13:23:27Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568667352",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568667352"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 124,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568688007",
      "pull_request_review_id": 3515011880,
      "id": 2568688007,
      "node_id": "PRRC_kwDOABII586ZGxGH",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 122,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I find this iteration quite hard to follow. Could we extract the search into a helper and then act on the found index, something like:\r\n```C++\r\n    std::optional<uint32_t> FindInputIndex(const COutPoint& outpoint) const\r\n    {\r\n        for (size_t i{m_input_tail}; i < m_inputs.size(); ++i) {\r\n            if (m_inputs[i].outpoint == outpoint) {\r\n                return i;\r\n            }\r\n        }\r\n        return std::nullopt;\r\n    }\r\n\r\n\r\n    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\r\n    {\r\n        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\r\n        if (!inserted) return ret;\r\n\r\n        if (const auto idx_opt{FindInputIndex(outpoint)}) {\r\n            auto& input{m_inputs[*idx_opt]};\r\n\r\n            // Wait until this input is ready. Acquire matches the worker's release.\r\n            while (!input.ready.test(std::memory_order_acquire)) {\r\n                // Try to process other inputs instead of just waiting\r\n                if (!ProcessInputInBackground()) {\r\n                    // No more work; just wait on this one\r\n                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (input.coin) [[likely]]\r\n                ret->second.coin = std::move(*input.coin);\r\n            m_input_tail = *idx_opt + 1; // We will never need to scan earlier entries again\r\n        }\r\n\r\n        if (ret->second.coin.IsSpent()) [[unlikely]] {\r\n            // We only get here for BIP30 checks, txid collisions, or missing/spent inputs.\r\n            if (auto coin{FetchCoinFromParent(outpoint)}) {\r\n                ret->second.coin = std::move(*coin);\r\n            } else {\r\n                cacheCoins.erase(ret);\r\n                return cacheCoins.end();\r\n            }\r\n        }\r\n\r\n        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\r\n        return ret;\r\n    }\r\n```",
      "created_at": "2025-11-27T13:28:14Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2568688007",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2568688007"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 122,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569055541",
      "pull_request_review_id": 3515011880,
      "id": 2569055541,
      "node_id": "PRRC_kwDOABII586ZIK01",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;\n+        std::ranges::sort(m_txids);",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 177,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It might be worth mentioning (either in a comment here or in the PR description) that benchmarks indicated this sorted `std::vector<uint64_t> + binary_search` approach is significantly faster than a `std::unordered_set<Txid>` or `std::set<Txid>` for the expected hit/miss mix.",
      "created_at": "2025-11-27T14:46:42Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569055541",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569055541"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 218,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569067345",
      "pull_request_review_id": 3515011880,
      "id": 2569067345,
      "node_id": "PRRC_kwDOABII586ZINtR",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;\n+        std::ranges::sort(m_txids);\n+        // Start workers.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (uint32_t n{0}; n < WORKER_THREADS; ++n) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    if (m_request_stop) [[unlikely]] return;\n+                    while (ProcessInputInBackground()) {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 212,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: this is very compact, but maybe a bit hard to see, consider:\n```C++\nfor (;;) {\n    if (!ProcessInputInBackground()) break;\n}\n```",
      "created_at": "2025-11-27T14:49:08Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569067345",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569067345"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569070519",
      "pull_request_review_id": 3515011880,
      "id": 2569070519,
      "node_id": "PRRC_kwDOABII586ZIOe3",
      "diff_hunk": "@@ -3095,6 +3097,7 @@ bool Chainstate::ConnectTip(\n             if (state.IsInvalid())\n                 InvalidBlockFound(pindexNew, state);\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\n+            view.Reset();",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 22,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Is `Reset()` strictly necessary here given that a failed `ConnectBlock` will discard the ephemeral view anyway? Can we carry any async state across to the next block?",
      "created_at": "2025-11-27T14:49:43Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569070519",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569070519"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3112,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569079200",
      "pull_request_review_id": 3515011880,
      "id": 2569079200,
      "node_id": "PRRC_kwDOABII586ZIQmg",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 87,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I donâ€™t mind the `[[likely]]` hints (they can help document expectations), but I know others are opposed to using them in our codebase.",
      "created_at": "2025-11-27T14:51:25Z",
      "updated_at": "2025-11-27T15:26:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569079200",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569079200"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569094055",
      "pull_request_review_id": 3515011880,
      "id": 2569094055,
      "node_id": "PRRC_kwDOABII586ZIUOn",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 176,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What does the `if (m_inputs.size() == 0)` guard against exactly?",
      "created_at": "2025-11-27T14:54:16Z",
      "updated_at": "2025-11-27T15:56:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569094055",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569094055"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569534729",
      "pull_request_review_id": 3516392404,
      "id": 2569534729,
      "node_id": "PRRC_kwDOABII586ZJ_0J",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    g_db->EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);\n+            const auto coin{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+            if (coin) {\n+                assert(!coin->IsSpent());\n+                outpoints_in_cache.emplace(outpoint);\n+            }\n+            const auto& db_it{db_map.find(outpoint)};\n+            const auto cache_it{cache_map.find(outpoint)};\n+            if (!coin) {\n+                // If we don't have a coin, then it's either spent in cache or missing\n+                const auto spent_cache_coin{cache_it != cache_map.end() && cache_it->second.IsSpent()};\n+                const auto no_coin{cache_it == cache_map.end() && db_it == db_map.end()};\n+                assert(spent_cache_coin || no_coin);\n+            } else if (cache_it != cache_map.end()) {\n+                // Make sure we have the main cache coin if it exists instead of db\n+                const auto& cache_coin{cache_it->second};\n+                assert(!cache_coin.IsSpent());\n+                assert(coin->fCoinBase == cache_coin.fCoinBase);\n+                assert(coin->nHeight == cache_coin.nHeight);\n+                assert(coin->out == cache_coin.out);\n+            } else {\n+                assert(db_it != db_map.end());\n+                // Check any coins not in the main cache are the same as the db\n+                const auto& db_coin{db_it->second};\n+                assert(coin->fCoinBase == db_coin.fCoinBase);\n+                assert(coin->nHeight == db_coin.nHeight);\n+                assert(coin->out == db_coin.out);\n+            }\n+        }\n+        assert(cache.GetCacheSize() == outpoints_in_cache.size());\n+        fuzzed_data_provider.ConsumeBool() ? (void)cache.Flush() : cache.Reset();",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 164,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568598322,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The `(void)` here does not rely on the return value. Or do you mean something else?",
      "created_at": "2025-11-27T16:53:41Z",
      "updated_at": "2025-11-27T16:53:42Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569534729",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569534729"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 170,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569536332",
      "pull_request_review_id": 3516394652,
      "id": 2569536332,
      "node_id": "PRRC_kwDOABII586ZKANM",
      "diff_hunk": "@@ -0,0 +1,43 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto DELAY{1ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+struct DelayedCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override\n+    {\n+        UninterruptibleSleep(DELAY);\n+        Coin coin{};\n+        coin.out.nValue = 1;\n+        return coin;\n+    }\n+};\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+\n+    DelayedCoinsView db{};\n+    CCoinsViewCache main_cache(&db);\n+    CoinsViewCacheAsync async_cache{main_cache, db};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 38,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568638933,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Ah, yes the `Reset` now just short circuits it. So this is not a very good benchmark anymore. Will fix to access all coins.",
      "created_at": "2025-11-27T16:54:19Z",
      "updated_at": "2025-11-27T16:54:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569536332",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569536332"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569545118",
      "pull_request_review_id": 3516404868,
      "id": 2569545118,
      "node_id": "PRRC_kwDOABII586ZKCWe",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};",
      "path": "src/coinsviewcacheasync.h",
      "position": 101,
      "original_position": 47,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568659911,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, this is a queue! An MPSC queue to be exact. I don't think it's possible to not store this as an instance member. I don't think we can use a `std::deque` though because we can't actually mutate the container. The benefit of a deque would be to actually push and pop, but here we set up the container before kicking off the worker threads.",
      "created_at": "2025-11-27T16:57:58Z",
      "updated_at": "2025-11-27T16:57:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569545118",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569545118"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 101,
      "original_line": 101,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569548184",
      "pull_request_review_id": 3516408995,
      "id": 2569548184,
      "node_id": "PRRC_kwDOABII586ZKDGY",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a",
      "path": "src/coinsviewcacheasync.h",
      "position": 124,
      "original_position": 70,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568667352,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> did we benchmark 32-bit vs 64-bit prefixes\r\n\r\nI did do microbenchmarks with 32-bit, and it was not more performant. Also, there is no `uint256::GetUint32`, so we would either just cast the 64 bits to 32 or have to write a new method on `uint256`. I don't think it's worth exploring this more.",
      "created_at": "2025-11-27T16:59:31Z",
      "updated_at": "2025-11-27T16:59:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569548184",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569548184"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 124,
      "original_line": 124,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569551740",
      "pull_request_review_id": 3516413689,
      "id": 2569551740,
      "node_id": "PRRC_kwDOABII586ZKD98",
      "diff_hunk": "@@ -3095,6 +3097,7 @@ bool Chainstate::ConnectTip(\n             if (state.IsInvalid())\n                 InvalidBlockFound(pindexNew, state);\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\n+            view.Reset();",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 22,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569070519,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We don't actually throw away the ephemeral view anymore. We just reset the state each time. This is a big performance improvement since we don't have to reallocate anything. If we didn't do this we would need an external thread pool as well, since the threads are owned by the `CoinsViewCacheAsync`. I think it's a fair tradeoff for one extra line here.\r\nPerhaps calling it `ephemeral_view` is a misnomer though. I'm not sure what a better name would be right now.",
      "created_at": "2025-11-27T17:01:23Z",
      "updated_at": "2025-11-27T17:01:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569551740",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569551740"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3112,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569553505",
      "pull_request_review_id": 3516415695,
      "id": 2569553505,
      "node_id": "PRRC_kwDOABII586ZKEZh",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 87,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569079200,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There are some already in the codebase. They are added in C++20, why not use them? Maybe in future compiler versions the hints will become more useful for optimization?\r\nI only use them when we know a path is always happy or unhappy for a valid block (except for BIP30 checks, which we only do at the very beginning). An invalid block with valid proof of work is very rare, so we can optimize for the case where we don't get one. If we get an invalid block, we care less about speed to validate.",
      "created_at": "2025-11-27T17:02:23Z",
      "updated_at": "2025-11-27T17:04:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569553505",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569553505"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569561092",
      "pull_request_review_id": 3516423844,
      "id": 2569561092,
      "node_id": "PRRC_kwDOABII586ZKGQE",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 176,
      "commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569094055,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I use this instead of an `m_is_fetching` or equivalent boolean state. We don't want to exit the barrier if we haven't entered it. We don't enter above if the block has less than 2 txs, and we don't enter if it is an invalid block with 2 or more txs that have zero inputs. After we stop the threads and exit the barrier, we clear the inputs as well so we don't exit again.",
      "created_at": "2025-11-27T17:06:26Z",
      "updated_at": "2025-11-27T17:07:36Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569561092",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569561092"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569567709",
      "pull_request_review_id": 3516431708,
      "id": 2569567709,
      "node_id": "PRRC_kwDOABII586ZKH3d",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    g_db->EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);\n+            const auto coin{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+            if (coin) {\n+                assert(!coin->IsSpent());\n+                outpoints_in_cache.emplace(outpoint);\n+            }\n+            const auto& db_it{db_map.find(outpoint)};\n+            const auto cache_it{cache_map.find(outpoint)};\n+            if (!coin) {\n+                // If we don't have a coin, then it's either spent in cache or missing\n+                const auto spent_cache_coin{cache_it != cache_map.end() && cache_it->second.IsSpent()};\n+                const auto no_coin{cache_it == cache_map.end() && db_it == db_map.end()};\n+                assert(spent_cache_coin || no_coin);\n+            } else if (cache_it != cache_map.end()) {\n+                // Make sure we have the main cache coin if it exists instead of db\n+                const auto& cache_coin{cache_it->second};\n+                assert(!cache_coin.IsSpent());\n+                assert(coin->fCoinBase == cache_coin.fCoinBase);\n+                assert(coin->nHeight == cache_coin.nHeight);\n+                assert(coin->out == cache_coin.out);\n+            } else {\n+                assert(db_it != db_map.end());\n+                // Check any coins not in the main cache are the same as the db\n+                const auto& db_coin{db_it->second};\n+                assert(coin->fCoinBase == db_coin.fCoinBase);\n+                assert(coin->nHeight == db_coin.nHeight);\n+                assert(coin->out == db_coin.out);\n+            }\n+        }\n+        assert(cache.GetCacheSize() == outpoints_in_cache.size());\n+        fuzzed_data_provider.ConsumeBool() ? (void)cache.Flush() : cache.Reset();",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 164,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568598322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we wouldn't need it if `Flush` were a void itself, like `Reset`, right?",
      "created_at": "2025-11-27T17:09:45Z",
      "updated_at": "2025-11-27T17:09:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569567709",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569567709"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 170,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569574051",
      "pull_request_review_id": 3516438885,
      "id": 2569574051,
      "node_id": "PRRC_kwDOABII586ZKJaj",
      "diff_hunk": "@@ -3095,6 +3097,7 @@ bool Chainstate::ConnectTip(\n             if (state.IsInvalid())\n                 InvalidBlockFound(pindexNew, state);\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\n+            view.Reset();",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 22,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569070519,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> We don't actually throw away the ephemeral view anymore\r\n\r\nHah, I missed that in the latest push, thanks. ðŸ‘ \r\n\r\n> calling it ephemeral_view is a misnomer though\r\n\r\nYeah :)",
      "created_at": "2025-11-27T17:13:11Z",
      "updated_at": "2025-11-27T17:13:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569574051",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569574051"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3112,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569578980",
      "pull_request_review_id": 3516444930,
      "id": 2569578980,
      "node_id": "PRRC_kwDOABII586ZKKnk",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    g_db->EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);\n+            const auto coin{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+            if (coin) {\n+                assert(!coin->IsSpent());\n+                outpoints_in_cache.emplace(outpoint);\n+            }\n+            const auto& db_it{db_map.find(outpoint)};\n+            const auto cache_it{cache_map.find(outpoint)};\n+            if (!coin) {\n+                // If we don't have a coin, then it's either spent in cache or missing\n+                const auto spent_cache_coin{cache_it != cache_map.end() && cache_it->second.IsSpent()};\n+                const auto no_coin{cache_it == cache_map.end() && db_it == db_map.end()};\n+                assert(spent_cache_coin || no_coin);\n+            } else if (cache_it != cache_map.end()) {\n+                // Make sure we have the main cache coin if it exists instead of db\n+                const auto& cache_coin{cache_it->second};\n+                assert(!cache_coin.IsSpent());\n+                assert(coin->fCoinBase == cache_coin.fCoinBase);\n+                assert(coin->nHeight == cache_coin.nHeight);\n+                assert(coin->out == cache_coin.out);\n+            } else {\n+                assert(db_it != db_map.end());\n+                // Check any coins not in the main cache are the same as the db\n+                const auto& db_coin{db_it->second};\n+                assert(coin->fCoinBase == db_coin.fCoinBase);\n+                assert(coin->nHeight == db_coin.nHeight);\n+                assert(coin->out == db_coin.out);\n+            }\n+        }\n+        assert(cache.GetCacheSize() == outpoints_in_cache.size());\n+        fuzzed_data_provider.ConsumeBool() ? (void)cache.Flush() : cache.Reset();",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 164,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568598322,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Yes, but if the other PR is merged, then this will still compile with no errors or warnings right?",
      "created_at": "2025-11-27T17:15:30Z",
      "updated_at": "2025-11-27T17:15:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569578980",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569578980"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 170,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569597731",
      "pull_request_review_id": 3516471759,
      "id": 2569597731,
      "node_id": "PRRC_kwDOABII586ZKPMj",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 87,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569079200,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> why not use them\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/30535#discussion_r1709821764\r\nhttps://github.com/bitcoin/bitcoin/pull/31682#discussion_r1923995451\r\nhttps://github.com/bitcoin/bitcoin/pull/33657#discussion_r2559477612",
      "created_at": "2025-11-27T17:23:53Z",
      "updated_at": "2025-11-27T17:23:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569597731",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569597731"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569603708",
      "pull_request_review_id": 3516480523,
      "id": 2569603708,
      "node_id": "PRRC_kwDOABII586ZKQp8",
      "diff_hunk": "@@ -0,0 +1,167 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <stdexcept>\n+#include <unordered_set>\n+#include <utility>\n+\n+class CoinsViewDb : public CCoinsViewCache\n+{\n+public:\n+    std::optional<Coin> GetCoin(const COutPoint& outpoint) const override\n+    {\n+        if (auto it = cacheCoins.find(outpoint); it != cacheCoins.end() && !it->second.coin.IsSpent()) return it->second.coin;\n+        return std::nullopt;\n+    }\n+\n+    void Clear() noexcept\n+    {\n+        cacheCoins.clear();\n+        ReallocateCache();\n+        cachedCoinsUsage = 0;\n+    }\n+\n+    CoinsViewDb() : CCoinsViewCache(nullptr, /*deterministic=*/true) {}\n+};\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CoinsViewDb> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    g_db.emplace();\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db, /*deterministic=*/true);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db, /*deterministic=*/true);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                const auto txid{fuzzed_data_provider.ConsumeBool() ? Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider)) : prevhash};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    g_db->EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);\n+            const auto coin{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+            if (coin) {\n+                assert(!coin->IsSpent());\n+                outpoints_in_cache.emplace(outpoint);\n+            }\n+            const auto& db_it{db_map.find(outpoint)};\n+            const auto cache_it{cache_map.find(outpoint)};\n+            if (!coin) {\n+                // If we don't have a coin, then it's either spent in cache or missing\n+                const auto spent_cache_coin{cache_it != cache_map.end() && cache_it->second.IsSpent()};\n+                const auto no_coin{cache_it == cache_map.end() && db_it == db_map.end()};\n+                assert(spent_cache_coin || no_coin);\n+            } else if (cache_it != cache_map.end()) {\n+                // Make sure we have the main cache coin if it exists instead of db\n+                const auto& cache_coin{cache_it->second};\n+                assert(!cache_coin.IsSpent());\n+                assert(coin->fCoinBase == cache_coin.fCoinBase);\n+                assert(coin->nHeight == cache_coin.nHeight);\n+                assert(coin->out == cache_coin.out);\n+            } else {\n+                assert(db_it != db_map.end());\n+                // Check any coins not in the main cache are the same as the db\n+                const auto& db_coin{db_it->second};\n+                assert(coin->fCoinBase == db_coin.fCoinBase);\n+                assert(coin->nHeight == db_coin.nHeight);\n+                assert(coin->out == db_coin.out);\n+            }\n+        }\n+        assert(cache.GetCacheSize() == outpoints_in_cache.size());\n+        fuzzed_data_provider.ConsumeBool() ? (void)cache.Flush() : cache.Reset();",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 164,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2568598322,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "you will have a conflict where you're making Flush abstract and they're making it void",
      "created_at": "2025-11-27T17:25:50Z",
      "updated_at": "2025-11-27T17:25:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569603708",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569603708"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 170,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569633692",
      "pull_request_review_id": 3516512057,
      "id": 2569633692,
      "node_id": "PRRC_kwDOABII586ZKX-c",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 87,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569079200,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The first link shows a benefit to using them, and that is now in our codebase.\r\nThe second and third links reference [this blog post](https://blog.aaronballman.com/2020/08/dont-use-the-likely-or-unlikely-attributes/) which has crazy convoluted usages. I don't find that blog post convincing. The usages here are straightforward and in very hot paths. They are only used in paths where we know a valid block will always or never go into (aside from BIP30).",
      "created_at": "2025-11-27T17:40:40Z",
      "updated_at": "2025-11-27T17:40:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2569633692",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2569633692"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 89,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348088",
      "pull_request_review_id": 3520939951,
      "id": 2573348088,
      "node_id": "PRRC_kwDOABII586ZYiz4",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;\n+        std::ranges::sort(m_txids);\n+        // Start workers.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (uint32_t n{0}; n < WORKER_THREADS; ++n) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "19bc07e8adbced7f222fab96ac935b7fdcd4c2fa",
      "original_commit_id": "fc4346fe0500fa1dbb4b881944296cd3bd112ad7",
      "in_reply_to_id": 2568610778,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm the thread is just an input fetcher though. That's all it does. I like this name for it.",
      "created_at": "2025-11-30T05:03:46Z",
      "updated_at": "2025-11-30T05:03:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2573348088",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348088"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 229,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348285",
      "pull_request_review_id": 3520940113,
      "id": 2573348285,
      "node_id": "PRRC_kwDOABII586ZYi29",
      "diff_hunk": "@@ -3095,6 +3097,7 @@ bool Chainstate::ConnectTip(\n             if (state.IsInvalid())\n                 InvalidBlockFound(pindexNew, state);\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\n+            view.Reset();",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 22,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569070519,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Renamed to `m_connect_block_view`.",
      "created_at": "2025-11-30T05:04:46Z",
      "updated_at": "2025-11-30T05:04:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2573348285",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348285"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3112,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348456",
      "pull_request_review_id": 3520940203,
      "id": 2573348456,
      "node_id": "PRRC_kwDOABII586ZYi5o",
      "diff_hunk": "@@ -0,0 +1,227 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <thread>\n+#include <unordered_map>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created and spent in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claims and fetches the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (inserted) {\n+            for (auto i{m_input_tail}; i < m_inputs.size(); ++i) {\n+                auto& input{m_inputs[i]};\n+                if (input.outpoint != outpoint) continue;\n+                // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+                while (!input.ready.test(std::memory_order_acquire)) {\n+                    // Work instead of waiting if the coin is not ready\n+                    if (!ProcessInputInBackground()) {\n+                        // No more work, just wait\n+                        input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                        break;\n+                    }\n+                }\n+                if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+                m_input_tail = i + 1;\n+                break;\n+            }\n+            if (ret->second.coin.IsSpent()) [[unlikely]] {\n+                // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+                if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                    ret->second.coin = std::move(*coin);\n+                } else {\n+                    cacheCoins.erase(ret);\n+                    return cacheCoins.end();\n+                }\n+            }\n+            cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        }\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+    bool m_request_stop{false};\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() > 0) {\n+            m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+            m_barrier.arrive_and_wait();\n+            m_inputs.clear();\n+        }\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        if (block.vtx.size() <= 1) return;\n+\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (size_t i{1}; i < block.vtx.size(); ++i) {\n+            const auto& tx{block.vtx[i]};\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+        }\n+        if (m_inputs.size() == 0) return;\n+        std::ranges::sort(m_txids);\n+        // Start workers.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (uint32_t n{0}; n < WORKER_THREADS; ++n) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    if (m_request_stop) [[unlikely]] return;\n+                    while (ProcessInputInBackground()) {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 212,
      "commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "original_commit_id": "0f3778fbfb03fc9083326e9cf62b3d3293a7f623",
      "in_reply_to_id": 2569067345,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I prefer the current version.",
      "created_at": "2025-11-30T05:05:14Z",
      "updated_at": "2025-11-30T05:05:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2573348456",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2573348456"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 230,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574049689",
      "pull_request_review_id": 3521635292,
      "id": 2574049689,
      "node_id": "PRRC_kwDOABII586ZbOGZ",
      "diff_hunk": "@@ -0,0 +1,57 @@\n+// Copyright (c) 2024-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <common/system.h>\n+#include <inputfetcher.h>\n+#include <primitives/block.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <util/time.h>\n+\n+static constexpr auto QUEUE_BATCH_SIZE{128};\n+static constexpr auto DELAY{2ms};\n+\n+//! Simulates a DB by adding a delay when calling GetCoin\n+class DelayedCoinsView : public CCoinsView",
      "path": "src/bench/inputfetcher.cpp",
      "position": 1,
      "original_position": 19,
      "commit_id": "5781a445f1d19c9479561bb536ec0f884c4bb950",
      "original_commit_id": "2349ac7d6071746a80223358bce0d5e556b277d7",
      "in_reply_to_id": 1859204841,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I now use a leveldb and add mock input data before the benchmark, so it's more of a real world benchmark now :+1: . Thanks!",
      "created_at": "2025-11-30T16:09:53Z",
      "updated_at": "2025-11-30T16:09:53Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574049689",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574049689"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 18,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574385347",
      "pull_request_review_id": 3521928328,
      "id": 2574385347,
      "node_id": "PRRC_kwDOABII586ZcgDD",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        // We need to stop workers from accessing base before we mutate it.\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (const auto n : std::views::iota(0U, WORKER_THREADS)) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    while (ProcessInputInBackground()) {}\n+                    if (m_inputs.size() == 0) return;\n+                    m_barrier.arrive_and_wait();\n+                }\n+            });\n+        }\n+    }\n+\n+    ~CoinsViewCacheAsync()",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit:\n```suggestion\n    ~CoinsViewCacheAsync() override\n```",
      "created_at": "2025-11-30T18:00:09Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574385347",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574385347"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574387786",
      "pull_request_review_id": 3521928328,
      "id": 2574387786,
      "node_id": "PRRC_kwDOABII586ZcgpK",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override\n+    {\n+        // We need to stop workers from accessing base before we mutate it.\n+        StopFetching();\n+        auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n+        const auto ret{base->BatchWrite(cursor, hashBlock)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db, bool deterministic = false) noexcept\n+        : CCoinsViewCache{&cache, deterministic}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n+    {\n+        for (const auto n : std::views::iota(0U, WORKER_THREADS)) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetcher.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    while (ProcessInputInBackground()) {}\n+                    if (m_inputs.size() == 0) return;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 227,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I understand that `size() > 0` may be more descriptive than `!empty()`, but there's a dedicated method for this case (there are a few more cases):\n```suggestion\n                    if (m_inputs.empty()) return;\n```",
      "created_at": "2025-11-30T18:01:09Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574387786",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574387786"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 227,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574407137",
      "pull_request_review_id": 3521928328,
      "id": 2574407137,
      "node_id": "PRRC_kwDOABII586ZclXh",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 37,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`deterministic` sounds like something we should do in a benchmark, but it just predefines the salts for testability:\nhttps://github.com/bitcoin/bitcoin/blob/9c24cda72edb2085edfa75296d6b42fab34433d9/src/util/hasher.cpp#L22-L25 \n\nAs far as I can tell we don't need here, so we can likely remove that constructor arg completely:\n```C++\n    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db) noexcept\n        : CCoinsViewCache{&cache}, m_db{db}, m_barrier{WORKER_THREADS + 1}\n```",
      "created_at": "2025-11-30T18:08:28Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574407137",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574407137"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 37,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574435070",
      "pull_request_review_id": 3521928328,
      "id": 2574435070,
      "node_id": "PRRC_kwDOABII586ZcsL-",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 121,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Should we maybe document that this assumes that `ConnectBlock` will fetch the inputs in the same order?\r\n\r\nnit: could we use the current formatting for new code?",
      "created_at": "2025-11-30T18:18:58Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574435070",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574435070"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 121,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574437547",
      "pull_request_review_id": 3521928328,
      "id": 2574437547,
      "node_id": "PRRC_kwDOABII586Zcsyr",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 66,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "As https://corecheck.dev/bitcoin/bitcoin/pulls/31132 hints, this could also be passed as const reference.\r\n\r\nnit: formatting",
      "created_at": "2025-11-30T18:19:52Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574437547",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574437547"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 66,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574457335",
      "pull_request_review_id": 3521928328,
      "id": 2574457335,
      "node_id": "PRRC_kwDOABII586Zcxn3",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 166,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "[we should](https://sonarcloud.io/project/issues?issueStatuses=OPEN%2CCONFIRMED&branch=31132-69310ec0035351e486cfb51cb66492639f6f8b47&id=aureleoules_bitcoin&open=AZrV9y4tqc704xdUcnxD&tab=why) likely init it here instead:\n```suggestion\n    std::barrier<> m_barrier{WORKER_THREADS + 1};\n```",
      "created_at": "2025-11-30T18:26:28Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574457335",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574457335"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 189,
      "original_line": 189,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574474663",
      "pull_request_review_id": 3521928328,
      "id": 2574474663,
      "node_id": "PRRC_kwDOABII586Zc12n",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 12,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> speed up block validation\n\nShould we mention any parallelism here?",
      "created_at": "2025-11-30T18:32:21Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574474663",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574474663"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 492,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574475994",
      "pull_request_review_id": 3521928328,
      "id": 2574475994,
      "node_id": "PRRC_kwDOABII586Zc2La",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 33,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we make this `static` or at least `const`?",
      "created_at": "2025-11-30T18:33:06Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574475994",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574475994"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574500339",
      "pull_request_review_id": 3521928328,
      "id": 2574500339,
      "node_id": "PRRC_kwDOABII586Zc8Hz",
      "diff_hunk": "@@ -173,6 +173,12 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: the first commit is huge, maybe we could split out the `coins.[cpp|h]` changes to a commit before it. Not sure what else we could split out, though...\r\nWould it help if we split out the single-threaded internal spends case, so that they avoid the cache entirely? Wouldn't that already speed up IBD - in which case it's definitely a separate feature. I also don't mind if we do that in a separate PR to have some progress.",
      "created_at": "2025-11-30T18:40:53Z",
      "updated_at": "2025-11-30T21:17:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574500339",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574500339"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574503828",
      "pull_request_review_id": 3521928328,
      "id": 2574503828,
      "node_id": "PRRC_kwDOABII586Zc8-U",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we may want to explain in a comment why the parent `CCoinsViewCache::Flush` isn't called here (i.e. to stop propagation to disk)",
      "created_at": "2025-11-30T18:42:13Z",
      "updated_at": "2025-11-30T21:17:35Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574503828",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574503828"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574518539",
      "pull_request_review_id": 3521928328,
      "id": 2574518539,
      "node_id": "PRRC_kwDOABII586ZdAkL",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 117,
      "original_position": 63,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "[Sonar is complaining](https://sonarcloud.io/project/issues?issueStatuses=OPEN%2CCONFIRMED&branch=31132-69310ec0035351e486cfb51cb66492639f6f8b47&id=aureleoules_bitcoin&open=AZrV9y4tqc704xdUcnxE&tab=more_info) that we're violating the Rule of Five here, it's a bit verbose, but maybe we could:\r\n```suggestion\r\n        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\r\n        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n        InputToFetch(const InputToFetch&) = delete;\r\n        InputToFetch& operator=(const InputToFetch&) = delete;\r\n        InputToFetch& operator=(InputToFetch&&) = delete;\r\n```\r\n\r\n-----\r\n\r\nBut it begs the question: why are we even moving these and why is the \"move\" only copying partial state. Is it meant to avoid reallocations in `StartFetching`? But `m_inputs` is always empty at the beginning of assignment and we could easily `reserve` the actual size to avoid moves as far as I understood, something like:\r\n```C++\r\n    //! Start fetching all block inputs in parallel.\r\n    void StartFetching(const CBlock& block) noexcept\r\n    {\r\n        int input_count{std::accumulate(block.vtx.begin() + 1, block.vtx.end(), 0, [](size_t s, const auto& t) { return s + t->vin.size(); })};\r\n        m_inputs.reserve(input_count);\r\n\r\n        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\r\n        for (const auto& tx : block.vtx | std::views::drop(1)) {\r\n            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\r\n            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\r\n        }\r\n```\r\nwhich would allow us to delete most of the other constructors instead:\r\n```C++\r\n    explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n    InputToFetch(const InputToFetch&) = delete;\r\n    InputToFetch& operator=(const InputToFetch&) = delete;\r\n    InputToFetch(InputToFetch&&) = delete;\r\n    InputToFetch& operator=(InputToFetch&&) = delete;\r\n```",
      "created_at": "2025-11-30T18:47:28Z",
      "updated_at": "2025-12-01T13:52:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574518539",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574518539"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 116,
      "original_start_line": 62,
      "start_side": "RIGHT",
      "line": 117,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574535324",
      "pull_request_review_id": 3521928328,
      "id": 2574535324,
      "node_id": "PRRC_kwDOABII586ZdEqc",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK(spent ? coin.IsSpent() : !coin.IsSpent());",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 85,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "```suggestion\r\n            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\r\n```",
      "created_at": "2025-11-30T18:53:37Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574535324",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574535324"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 85,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574685431",
      "pull_request_review_id": 3521928328,
      "id": 2574685431,
      "node_id": "PRRC_kwDOABII586ZdpT3",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure I understand how we're actually testing this.\n`NoAccessCoinsView` is designed to abort on access, so in the shortid collision scenario how does it simulate going to disk?\nShouldn't we assert here that the number of collisions coincides with the number of simulated disk reads?",
      "created_at": "2025-11-30T19:54:24Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574685431",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574685431"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574697539",
      "pull_request_review_id": 3521928328,
      "id": 2574697539,
      "node_id": "PRRC_kwDOABII586ZdsRD",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 56,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: emplace doesn't necessarily need the class name\n\n```suggestion\n            tx.vin.emplace_back(txid, 0);\n```",
      "created_at": "2025-11-30T19:59:22Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574697539",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574697539"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 56,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574715871",
      "pull_request_review_id": 3521928328,
      "id": 2574715871,
      "node_id": "PRRC_kwDOABII586Zdwvf",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK(spent ? coin.IsSpent() : !coin.IsSpent());\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK(should_have ? !!have : !have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK(cache.GetCacheSize() == counter);\n+}\n+\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_db, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache(&dummy);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_cache, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache main_cache(&dummy);\n+    PopulateCache(block, main_cache);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache(&dummy);\n+    // Add all inputs as spent already in cache\n+    PopulateCache(block, main_cache, /*spent=*/true);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) view.AccessCoin(in.prevout);\n+        }\n+        // Coins are not added to the view, even though they exist unspent in the parent db\n+        BOOST_CHECK(view.GetCacheSize() == 0);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 166,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "any reason not to use:\n```suggestion\n        BOOST_CHECK_EQUAL(view.GetCacheSize(), 0);\n```\n? Or just a copy-paste convenience from fuzz :)?",
      "created_at": "2025-11-30T20:07:11Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574715871",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574715871"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574718480",
      "pull_request_review_id": 3521928328,
      "id": 2574718480,
      "node_id": "PRRC_kwDOABII586ZdxYQ",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 52,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "aren't we already overwriting the first 64 bits in the next step anyway?",
      "created_at": "2025-11-30T20:08:36Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574718480",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574718480"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 52,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574727843",
      "pull_request_review_id": 3521928328,
      "id": 2574727843,
      "node_id": "PRRC_kwDOABII586Zdzqj",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 46,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "isn't this too small for our purposes? Or since there's no randomness involved, we just store at most 100 values on 256 bits? That might work I guess, I would have just gone with `Txid::FromUint256(m_rng.rand256());`",
      "created_at": "2025-11-30T20:11:59Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574727843",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574727843"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 46,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574730742",
      "pull_request_review_id": 3521928328,
      "id": 2574730742,
      "node_id": "PRRC_kwDOABII586Zd0X2",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 53,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we're not switching platforms during testing, not sure we need LE/BE conversions here:\n```C++\nuint256 u{m_rng.rand256()};\nstd::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\ntxid = Txid::FromUint256(u);\n```",
      "created_at": "2025-11-30T20:13:00Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574730742",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574730742"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 53,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574740321",
      "pull_request_review_id": 3521928328,
      "id": 2574740321,
      "node_id": "PRRC_kwDOABII586Zd2th",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK(spent ? coin.IsSpent() : !coin.IsSpent());\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK(should_have ? !!have : !have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK(cache.GetCacheSize() == counter);\n+}\n+\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_db, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 122,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "nit: brace init may be slightly better here to differentiate it from function calls (many such cases):\r\n```suggestion\r\n    const CCoinsViewCache db{&dummy};\r\n```",
      "created_at": "2025-11-30T20:16:34Z",
      "updated_at": "2025-11-30T21:19:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574740321",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574740321"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 122,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574743779",
      "pull_request_review_id": 3521928328,
      "id": 2574743779,
      "node_id": "PRRC_kwDOABII586Zd3jj",
      "diff_hunk": "@@ -0,0 +1,173 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};\n+    g_async_cache.emplace(cache, *g_db);\n+}\n+\n+FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\n+{\n+    SeedRandomStateForTest(SeedRand::ZEROS);\n+    FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n+\n+    LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+    {\n+        CBlock block;\n+        Txid prevhash{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+\n+        std::map<const COutPoint, const Coin> db_map{};\n+        std::map<const COutPoint, const Coin> cache_map{};\n+        std::vector<COutPoint> input_outpoints{};\n+\n+        CCoinsViewCache main_cache(&*g_db);\n+        // Used for writing to the db and erasing between iterations\n+        CCoinsViewCache dummy_cache(&*g_db);\n+        dummy_cache.SetBestBlock(uint256::ONE);\n+\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+        {\n+            CMutableTransaction tx;\n+\n+            LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), 10000)\n+            {\n+                Txid txid;\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    txid = Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider));\n+                } else if (fuzzed_data_provider.ConsumeBool()) {\n+                    txid = prevhash;\n+                } else {\n+                    // Test shortid collisions\n+                    const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                    uint256 u(ConsumeUInt256(fuzzed_data_provider));\n+                    WriteLE64(u.data(), shorttxid);\n+                    txid = Txid::FromUint256(u);\n+                }\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                const COutPoint outpoint(txid, index);\n+\n+                tx.vin.emplace_back(outpoint);\n+\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue = ConsumeMoney(fuzzed_data_provider);\n+                    assert(!coin.IsSpent());\n+                    db_map.try_emplace(outpoint, coin);\n+                    dummy_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                // Add a different coin to the cache\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    Coin coin{};\n+                    coin.fCoinBase = fuzzed_data_provider.ConsumeBool();\n+                    coin.nHeight =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int32_t>(\n+                            0, std::numeric_limits<int32_t>::max());\n+                    coin.out.nValue =\n+                        fuzzed_data_provider.ConsumeIntegralInRange<int64_t>(\n+                            -1, MAX_MONEY);\n+                    cache_map.try_emplace(outpoint, coin);\n+                    main_cache.EmplaceCoinInternalDANGER(\n+                        COutPoint(outpoint),\n+                        std::move(coin));\n+                }\n+\n+                input_outpoints.emplace_back(outpoint);\n+            }\n+\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        (void)dummy_cache.Sync();\n+        CoinsViewCacheAsync& cache(*g_async_cache);\n+        cache.SetBackend(main_cache);\n+        cache.StartFetching(block);\n+\n+        std::unordered_set<COutPoint, SaltedOutpointHasher> outpoints_in_cache{};\n+        LIMITED_WHILE(fuzzed_data_provider.ConsumeBool(), static_cast<uint32_t>(input_outpoints.size() * 10))\n+        {\n+            COutPoint outpoint;\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                const auto index{fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, input_outpoints.size() - 1)};\n+                outpoint = input_outpoints[index];\n+            } else {\n+                const auto txid{Txid::FromUint256(ConsumeUInt256(fuzzed_data_provider))};\n+                const auto index{fuzzed_data_provider.ConsumeIntegral<uint32_t>()};\n+                outpoint = COutPoint(txid, index);\n+            }\n+            cache.AccessCoin(outpoint);",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 137,
      "commit_id": "8be628701fbb069cc108f47b16836981d0c3bc14",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we could validate the result values of `AccessCoin` throughout the tests",
      "created_at": "2025-11-30T20:17:57Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574743779",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574743779"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 136,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574755140",
      "pull_request_review_id": 3521928328,
      "id": 2574755140,
      "node_id": "PRRC_kwDOABII586Zd6VE",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.",
      "path": "src/coinsviewcacheasync.h",
      "position": 210,
      "original_position": 183,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "should we assume that the cache is empty here - or can you imagine a scenario when we wouldn't want that.?\r\nOtherwise tests like:\r\n```C++\r\nfor (auto i{0}; i < 3; ++i) {\r\n    view.StartFetching(block);\r\n    CheckCache(block, view);\r\n    view.Reset();\r\n}\r\n```\r\n\r\nwould basically pass (but hang) if we forget to `Reset`",
      "created_at": "2025-11-30T20:22:32Z",
      "updated_at": "2025-11-30T21:19:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574755140",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574755140"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 210,
      "original_line": 210,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574765851",
      "pull_request_review_id": 3521928328,
      "id": 2574765851,
      "node_id": "PRRC_kwDOABII586Zd88b",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 135,
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this early exit doesn't seem to be covered by unit tests in `coinsviewcacheasync_tests` (same for `StopFetching`)",
      "created_at": "2025-11-30T20:26:19Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574765851",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574765851"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 180,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574769313",
      "pull_request_review_id": 3521928328,
      "id": 2574769313,
      "node_id": "PRRC_kwDOABII586Zd9yh",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this also never seem to be triggered by unit tests in `coinsviewcacheasync_tests` - could we selectively block other threads to make sure we get here?",
      "created_at": "2025-11-30T20:27:25Z",
      "updated_at": "2025-11-30T21:20:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574769313",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574769313"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574771966",
      "pull_request_review_id": 3521928328,
      "id": 2574771966,
      "node_id": "PRRC_kwDOABII586Zd-b-",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this whole function never seems to be called from unit tests",
      "created_at": "2025-11-30T20:28:33Z",
      "updated_at": "2025-11-30T21:20:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574771966",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574771966"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574775352",
      "pull_request_review_id": 3521928328,
      "id": 2574775352,
      "node_id": "PRRC_kwDOABII586Zd_Q4",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK(spent ? coin.IsSpent() : !coin.IsSpent());\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK(should_have ? !!have : !have);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 109,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We could also use a less brancy equality check here\r\n\r\n```suggestion\r\n                BOOST_CHECK_EQUAL(should_have, !!have);\r\n```\r\n\r\nor\r\n```suggestion\r\n                BOOST_CHECK_NE(should_have, !have);\r\n```\r\n(but the latter might be too much for some :p)",
      "created_at": "2025-11-30T20:29:47Z",
      "updated_at": "2025-11-30T21:20:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574775352",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574775352"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 109,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574788161",
      "pull_request_review_id": 3521928328,
      "id": 2574788161,
      "node_id": "PRRC_kwDOABII586ZeCZB",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& in : tx->vin) {\n+                const auto have{async_cache.HaveCoin(in.prevout)};\n+                assert(have);\n+            }\n+        }\n+        async_cache.Reset();\n+    });\n+}\n+\n+BENCHMARK(CoinsViewCacheAsyncBenchmark, benchmark::PriorityLevel::HIGH);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 51,
      "commit_id": "13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "could you please add new lines to the end of the files? I also don't like them, but it seems to be necessary in certain cases...",
      "created_at": "2025-11-30T20:35:12Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574788161",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574788161"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 51,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574793204",
      "pull_request_review_id": 3521928328,
      "id": 2574793204,
      "node_id": "PRRC_kwDOABII586ZeDn0",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I like these functional constructs, they may take some getting used to, but they have a lot fewer moving parts which help with separating iteration (= glue code) from important parts!\r\n\r\n----\r\n\r\nNote: could you publish the benchmark results in the commit messages before/after and can you reproduce 4 threads saturating the parallelism factor with it? (I don't have any available benchmarking servers at the moment...)",
      "created_at": "2025-11-30T20:37:00Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574793204",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574793204"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574819043",
      "pull_request_review_id": 3521928328,
      "id": 2574819043,
      "node_id": "PRRC_kwDOABII586ZeJ7j",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,\n+    //! as well as not pollute the underlying cache with newly created coins in case the block is invalid.",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Do we have a specific test case that verifies cache isolation in a failure scenario?",
      "created_at": "2025-11-30T20:48:18Z",
      "updated_at": "2025-11-30T21:15:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574819043",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574819043"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 493,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574934048",
      "pull_request_review_id": 3522441708,
      "id": 2574934048,
      "node_id": "PRRC_kwDOABII586ZemAg",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,\n+    //! as well as not pollute the underlying cache with newly created coins in case the block is invalid.",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574819043,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I think some invalid block tests exercise this. If a block is invalid then the outputs of any txs are not added to the utxo set.",
      "created_at": "2025-11-30T21:44:07Z",
      "updated_at": "2025-11-30T21:44:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574934048",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574934048"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 493,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574936137",
      "pull_request_review_id": 3522443668,
      "id": 2574936137,
      "node_id": "PRRC_kwDOABII586ZemhJ",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& in : tx->vin) {\n+                const auto have{async_cache.HaveCoin(in.prevout)};\n+                assert(have);\n+            }\n+        }\n+        async_cache.Reset();\n+    });\n+}\n+\n+BENCHMARK(CoinsViewCacheAsyncBenchmark, benchmark::PriorityLevel::HIGH);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 51,
      "commit_id": "13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574788161,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "If there is a missing new line github will show a red arrow at the end of the file.",
      "created_at": "2025-11-30T21:45:07Z",
      "updated_at": "2025-11-30T21:45:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574936137",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574936137"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 51,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574956644",
      "pull_request_review_id": 3522463993,
      "id": 2574956644,
      "node_id": "PRRC_kwDOABII586Zerhk",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 46,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574727843,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> isn't this too small for our purposes?\r\n\r\nI don't see why we need any randomness or larger values for these?",
      "created_at": "2025-11-30T21:53:56Z",
      "updated_at": "2025-11-30T21:53:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574956644",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574956644"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 46,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574968743",
      "pull_request_review_id": 3522475867,
      "id": 2574968743,
      "node_id": "PRRC_kwDOABII586Zeuen",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm not sure how we'd test this with a unit test. It surely gets exercised by fuzzing though. Also the function is called by other threads.",
      "created_at": "2025-11-30T21:59:22Z",
      "updated_at": "2025-11-30T21:59:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574968743",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574968743"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574970212",
      "pull_request_review_id": 3522477282,
      "id": 2574970212,
      "node_id": "PRRC_kwDOABII586Zeu1k",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574771966,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It gets called by functional tests though.",
      "created_at": "2025-11-30T22:00:03Z",
      "updated_at": "2025-11-30T22:00:03Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574970212",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574970212"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574973805",
      "pull_request_review_id": 3522480565,
      "id": 2574973805,
      "node_id": "PRRC_kwDOABII586Zevtt",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> before/after \r\n\r\nNot sure there are any before results we can use for this.\r\n\r\n> can you reproduce 4 threads saturating the parallelism factor with it?\r\n\r\nHow would I know if I do that?",
      "created_at": "2025-11-30T22:01:28Z",
      "updated_at": "2025-11-30T22:01:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574973805",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574973805"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574979427",
      "pull_request_review_id": 3522486210,
      "id": 2574979427,
      "node_id": "PRRC_kwDOABII586ZexFj",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 12,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574474663,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "That's more an implementation detail that can be found by reading the header file, no?",
      "created_at": "2025-11-30T22:04:14Z",
      "updated_at": "2025-11-30T22:04:15Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574979427",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574979427"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 492,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574980697",
      "pull_request_review_id": 3522487562,
      "id": 2574980697,
      "node_id": "PRRC_kwDOABII586ZexZZ",
      "diff_hunk": "@@ -173,6 +173,12 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574500339,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I would prefer to split out the implementation, the tests, the fuzz harness... But you prefer those all be in the same commit?",
      "created_at": "2025-11-30T22:04:52Z",
      "updated_at": "2025-11-30T22:04:52Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574980697",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574980697"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574982084",
      "pull_request_review_id": 3522489004,
      "id": 2574982084,
      "node_id": "PRRC_kwDOABII586ZexvE",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574503828,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> (i.e. to stop propagation to disk)\r\n\r\nThe parent could be called, but this is faster since we skip calling `ReallocateCache`.",
      "created_at": "2025-11-30T22:05:24Z",
      "updated_at": "2025-11-30T22:05:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574982084",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574982084"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574988562",
      "pull_request_review_id": 3522495501,
      "id": 2574988562,
      "node_id": "PRRC_kwDOABII586ZezUS",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 117,
      "original_position": 63,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574518539,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure if we need all these deletes here? What are we gaining from this?\r\n\r\nWe need to have move assignment for it to compile. It can't automatically move the `atomic_flag`. So, it doesn't really matter if it gets called or not, we still need to define it. And, since it only happens before we start doing work, might as well make it simple and not bother moving the other fields. I don't think we need to bother reserving since we keep the capacity over many blocks. The looping is just extra overhead, and it doesn't allow us to remove the move assignment.",
      "created_at": "2025-11-30T22:08:23Z",
      "updated_at": "2025-11-30T22:08:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574988562",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574988562"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 116,
      "original_start_line": 62,
      "start_side": "RIGHT",
      "line": 117,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574995185",
      "pull_request_review_id": 3522502388,
      "id": 2574995185,
      "node_id": "PRRC_kwDOABII586Ze07x",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574685431,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It doesn't simulate going to disk. It simulates not setting the coin in `ProcessInputInBackground` even though the base has it. Then the `if (ret->second.coin.IsSpent()) [[unlikely]] {` branch is executed in `FetchCoin` and the coin is fetched from base via `GetCoinWithoutMutating`.",
      "created_at": "2025-11-30T22:11:32Z",
      "updated_at": "2025-11-30T22:11:33Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2574995185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2574995185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575017536",
      "pull_request_review_id": 3522526102,
      "id": 2575017536,
      "node_id": "PRRC_kwDOABII586Ze6ZA",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.",
      "path": "src/coinsviewcacheasync.h",
      "position": 210,
      "original_position": 183,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574755140,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> would basically pass (but hang) if we forget to Reset\r\n\r\nA hanging test is treated as failure in the CI. I don't think it's necessary to do anything else here.",
      "created_at": "2025-11-30T22:21:59Z",
      "updated_at": "2025-11-30T22:21:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575017536",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575017536"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 210,
      "original_line": 210,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575797791",
      "pull_request_review_id": 3523358497,
      "id": 2575797791,
      "node_id": "PRRC_kwDOABII586Zh44f",
      "diff_hunk": "@@ -173,6 +173,12 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574500339,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I prefer simple but fully functioning chunks that converge towards a feature (as someone illustrated: \"skateboard -> bicycle -> scooter -> motorcycle -> car\" instead of \"left wheels -> right wheels -> doors -> wipers -> radio antenna -> windows -> etc\").\r\nSo if we can carve out chunks (such as the internal spend + main fallback, or a single-threaded fetcher first), we could guide the reviewer instead of having a big-bang change that's really hard to fully comprehend as such.",
      "created_at": "2025-12-01T06:40:09Z",
      "updated_at": "2025-12-01T09:44:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575797791",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575797791"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575807594",
      "pull_request_review_id": 3523358497,
      "id": 2575807594,
      "node_id": "PRRC_kwDOABII586Zh7Rq",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> any before results\r\n\r\nI just noticed the benchmark only tests the new state - what if the benchmark originally measured the current behavior and in the commit when we're changing to multithreaded connection, we update the benchmark to reflect that (if needed, maybe the same benchmark can already switch automatically if the original `CoinsViewCacheAsync` implementation reimplements everything on a single thread at first).\r\n\r\nIn that case we could have something like (fake numbers):\r\n\r\n> bench: add CoinsViewCacheAsync benchmark\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,764,037.75 |              566.88 |    0.2% |     11.02 | `CoinsViewCacheAsyncBenchmark`\r\n\r\n> validation: fetch block inputs via CCoinsViewCacheAsync during connection\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,304,607.17 |              766.51 |    0.7% |     10.60 | `CoinsViewCacheAsyncBenchmark`\r\n\r\n\r\n-----\r\n\r\n> can you reproduce 4 threads saturating the parallelism factor with it?\r\n\r\nChanging:\r\n```C++\r\nstatic constexpr uint32_t WORKER_THREADS{1};\r\n```\r\nwhich gives me\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,294,995.86 |              772.20 |    1.4% |     10.61 | `CoinsViewCacheAsyncBenchmark`\r\n\r\nand `2`:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,237,416.55 |              808.14 |    1.9% |     10.83 | `CoinsViewCacheAsyncBenchmark`\r\n\r\nand `3`:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,321,210.42 |              756.88 |    1.3% |     10.84 | `CoinsViewCacheAsyncBenchmark`\r\n\r\nand for `4`:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,788,112.75 |              559.25 |    0.3% |     10.91 | `CoinsViewCacheAsyncBenchmark`\r\n\r\nand `5`:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        2,126,524.56 |              470.25 |    2.0% |      9.88 | `CoinsViewCacheAsyncBenchmark`\r\n\r\nand `6`:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        3,053,001.11 |              327.55 |    3.3% |     10.57 | `CoinsViewCacheAsyncBenchmark`\r\n\r\n\r\nSo it kinda' reproduces that it doesn't make sense to do more than 4",
      "created_at": "2025-12-01T06:44:37Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575807594",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575807594"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575840858",
      "pull_request_review_id": 3523358497,
      "id": 2575840858,
      "node_id": "PRRC_kwDOABII586ZiDZa",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574503828,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "wouldn't that percolate to the database layer?",
      "created_at": "2025-12-01T06:58:46Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575840858",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575840858"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575843917",
      "pull_request_review_id": 3523358497,
      "id": 2575843917,
      "node_id": "PRRC_kwDOABII586ZiEJN",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 117,
      "original_position": 63,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574518539,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I disagree, I think the current move construction is incorrect and if I understand it correctly, we should reserve instead and delete (or ignore) the other constructors.",
      "created_at": "2025-12-01T07:00:05Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575843917",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575843917"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 116,
      "original_start_line": 62,
      "start_side": "RIGHT",
      "line": 117,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575931153",
      "pull_request_review_id": 3523358497,
      "id": 2575931153,
      "node_id": "PRRC_kwDOABII586ZiZcR",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                uint256 u{};\n+                std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(txid, 0);\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType& chainType = ChainType::MAIN,\n+                              const TestOpts& opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() const noexcept { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 106,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`ConnectBlock` calls `AccessCoin` for every input, shouldn't the test do the same? Aren't we cheating by only calling it when we already know it's not an internal spend?\r\n```C++\r\n    for (const auto& tx : block.vtx) {\r\n        if (tx->IsCoinBase()) {\r\n            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\r\n        } else {\r\n            for (const auto& outpoint : tx->vin | std::views::transform(&CTxIn::prevout)) {\r\n                const auto external{!txids.contains(outpoint.hash)};\r\n                const auto& c{cache.AccessCoin(outpoint)};\r\n                BOOST_CHECK_EQUAL(c.IsSpent(), !external);\r\n\r\n                counter += external;\r\n                const bool in_cache{!!cache.GetPossiblySpentCoinFromCache(outpoint)};\r\n                BOOST_CHECK_EQUAL(external, in_cache);\r\n            }\r\n            txids.emplace(tx->GetHash());\r\n        }\r\n    }\r\n    BOOST_CHECK_EQUAL(cache.GetCacheSize(), counter);\r\n```",
      "created_at": "2025-12-01T07:29:45Z",
      "updated_at": "2025-12-01T09:43:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575931153",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575931153"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 103,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 106,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575987031",
      "pull_request_review_id": 3523358497,
      "id": 2575987031,
      "node_id": "PRRC_kwDOABII586ZinFX",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                uint256 u{};\n+                std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(txid, 0);\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType& chainType = ChainType::MAIN,\n+                              const TestOpts& opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() const noexcept { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 88,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "why are coinbases and internal spends added to the cache, that's not what happens in reality, right?\r\nIt should represent the state before the block is connected, and it should populate backed and db caches as well, so maybe something like:\r\n\r\n```suggestion\r\nvoid PopulateCache(const CBlock& block, CCoinsView& view, bool spent = false)\r\n{\r\n    CCoinsViewCache cache{&view};\r\n    cache.SetBestBlock(uint256::ONE);\r\n\r\n    std::unordered_set<Txid, SaltedTxidHasher> txids{};\r\n    txids.reserve(block.vtx.size() - 1);\r\n    for (const auto& tx : block.vtx | std::views::drop(1)) {\r\n        for (const auto& in : tx->vin) {\r\n            if (!txids.contains(in.prevout.hash)) {\r\n                Coin coin{};\r\n                if (!spent) coin.out.nValue = 1;\r\n                cache.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\r\n            }\r\n        }\r\n        txids.emplace(tx->GetHash());\r\n    }\r\n\r\n    cache.Flush();\r\n}\r\n```",
      "created_at": "2025-12-01T07:50:31Z",
      "updated_at": "2025-12-01T09:43:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2575987031",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2575987031"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 77,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 88,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576063953",
      "pull_request_review_id": 3523358497,
      "id": 2576063953,
      "node_id": "PRRC_kwDOABII586Zi53R",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 25,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "instead of `std::abort` we should just return an `std::nullopt`, it's closer to what the database would do - especially since `GetPossiblySpentCoinFromCache` is `noexcept`.\r\nOr even better, what if we also used an in-memory leveldb here instead and populated a `CCoinsView& view` in `PopulateCache`  instead (see below)?",
      "created_at": "2025-12-01T08:15:18Z",
      "updated_at": "2025-12-01T09:43:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576063953",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576063953"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576139456",
      "pull_request_review_id": 3523358497,
      "id": 2576139456,
      "node_id": "PRRC_kwDOABII586ZjMTA",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 33,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we're only using `100` here, we might as well:\n\n```suggestion\n    static constexpr auto num_txs{100};\n    CBlock CreateBlock() const noexcept\n```",
      "created_at": "2025-12-01T08:41:36Z",
      "updated_at": "2025-12-01T09:43:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576139456",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576139456"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 33,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576140637",
      "pull_request_review_id": 3523358497,
      "id": 2576140637,
      "node_id": "PRRC_kwDOABII586ZjMld",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 30,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`m_async_cache` seems unused",
      "created_at": "2025-12-01T08:42:01Z",
      "updated_at": "2025-12-01T09:45:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576140637",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576140637"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 30,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576143396",
      "pull_request_review_id": 3523358497,
      "id": 2576143396,
      "node_id": "PRRC_kwDOABII586ZjNQk",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 48,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we could add comments for these cases as well:\n```C++\n            if (i % 3 == 0) {\n                // External input\n                txid = Txid::FromUint256(uint256(i));\n            } else if (i % 3 == 1) {\n                // Internal spend (prev tx)\n                txid = prevhash;\n            } else {\n                // Test shortid collisions (looks internal, but is external)\n```",
      "created_at": "2025-12-01T08:42:56Z",
      "updated_at": "2025-12-01T09:43:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576143396",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576143396"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 46,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 48,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576158123",
      "pull_request_review_id": 3523358497,
      "id": 2576158123,
      "node_id": "PRRC_kwDOABII586ZjQ2r",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                uint256 u{};\n+                std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(txid, 0);\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType& chainType = ChainType::MAIN,\n+                              const TestOpts& opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() const noexcept { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK(cache.GetCacheSize() == counter);\n+}\n+\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_db, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db{&dummy};\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache{&dummy};\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_cache, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    const CCoinsViewCache db{&dummy};\n+    CCoinsViewCache main_cache{&dummy};\n+    PopulateCache(block, main_cache);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db{&dummy};\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache{&dummy};\n+    // Add all inputs as spent already in cache\n+    PopulateCache(block, main_cache, /*spent=*/true);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) view.AccessCoin(in.prevout);\n+        }\n+        // Coins are not added to the view, even though they exist unspent in the parent db\n+        BOOST_CHECK_EQUAL(view.GetCacheSize(), 0);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    CCoinsView db;\n+    CCoinsViewCache main_cache(&db);\n+    CoinsViewCacheAsync view{main_cache, db};",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 175,
      "commit_id": "0728edfc5fb0099a22a572cba4934d2d5dbd434d",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we could also add an in-memory leveldb here to simplify the code and make it more realistic:\r\n```suggestion\r\n    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\r\n    CCoinsViewCache main_cache{&db};\r\n    CoinsViewCacheAsync view{main_cache, db};\r\n```",
      "created_at": "2025-12-01T08:47:47Z",
      "updated_at": "2025-12-01T09:45:56Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576158123",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576158123"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 173,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576160496",
      "pull_request_review_id": 3523358497,
      "id": 2576160496,
      "node_id": "PRRC_kwDOABII586ZjRbw",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                uint256 u{};\n+                std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(txid, 0);\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType& chainType = ChainType::MAIN,\n+                              const TestOpts& opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() const noexcept { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK(cache.GetCacheSize() == counter);\n+}\n+\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_db, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db{&dummy};\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache{&dummy};\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_cache, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    const CCoinsViewCache db{&dummy};\n+    CCoinsViewCache main_cache{&dummy};\n+    PopulateCache(block, main_cache);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db{&dummy};\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache{&dummy};\n+    // Add all inputs as spent already in cache\n+    PopulateCache(block, main_cache, /*spent=*/true);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) view.AccessCoin(in.prevout);\n+        }\n+        // Coins are not added to the view, even though they exist unspent in the parent db\n+        BOOST_CHECK_EQUAL(view.GetCacheSize(), 0);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_no_inputs, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    CCoinsView db;\n+    CCoinsViewCache main_cache(&db);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) view.AccessCoin(in.prevout);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 179,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we should do *something* with the result:\n\n```suggestion\n            for (const auto& in : tx->vin) {\n                const auto& c{view.AccessCoin(in.prevout)};\n                BOOST_CHECK(c.IsSpent());\n            }\n```",
      "created_at": "2025-12-01T08:48:38Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576160496",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576160496"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 179,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576174736",
      "pull_request_review_id": 3523358497,
      "id": 2576174736,
      "node_id": "PRRC_kwDOABII586ZjU6Q",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& in : tx->vin) {\n+                const auto have{async_cache.HaveCoin(in.prevout)};\n+                assert(have);\n+            }\n+        }\n+        async_cache.Reset();\n+    });\n+}\n+\n+BENCHMARK(CoinsViewCacheAsyncBenchmark, benchmark::PriorityLevel::HIGH);",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 51,
      "commit_id": "13d32ed39cf869eb64faf8f489c53f38806a6c29",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574788161,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "You're right, my mistake",
      "created_at": "2025-12-01T08:53:05Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576174736",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576174736"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 51,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576210052",
      "pull_request_review_id": 3523358497,
      "id": 2576210052,
      "node_id": "PRRC_kwDOABII586ZjdiE",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574685431,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "isn't `GetCoinWithoutMutating` meant to simulate going one layer deeper in the cache - which is basically going to disk on the main thread, right?",
      "created_at": "2025-12-01T09:02:04Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576210052",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576210052"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576218924",
      "pull_request_review_id": 3523358497,
      "id": 2576218924,
      "node_id": "PRRC_kwDOABII586Zjfss",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,\n+    //! as well as not pollute the underlying cache with newly created coins in case the block is invalid.",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574819043,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I think some invalid block tests exercise this. If a block is invalid then the outputs of any txs are not added to the utxo set.\r\n\r\nAre those tests realistic and using the new cache or simulating it somehow? My question is: is the new functionality covered for this case, when a block has e.g. a double-spend to make sure it's not propagated to the main cache?",
      "created_at": "2025-12-01T09:04:40Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576218924",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576218924"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 493,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576230829",
      "pull_request_review_id": 3523358497,
      "id": 2576230829,
      "node_id": "PRRC_kwDOABII586Zjimt",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Hmm not sure how we'd test this with a unit test\r\n\r\nWe could block the thread pool by adding a dummy underlying cache which blocks for the gets and make sure the main thread can still do the fetch on a single thread, when you can unblock the cache and check that we still managed to make progress on a single thread.",
      "created_at": "2025-12-01T09:08:29Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576230829",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576230829"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576236185",
      "pull_request_review_id": 3523358497,
      "id": 2576236185,
      "node_id": "PRRC_kwDOABII586Zjj6Z",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 46,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574727843,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "some values are tiny now while internal spends (real or fake) have full hashes. It might be easier to work with small values, but internal spends will still result in big ugly full hashes anyway. I'm fine with it as it is.",
      "created_at": "2025-12-01T09:10:10Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576236185",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576236185"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 46,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576240407",
      "pull_request_review_id": 3523358497,
      "id": 2576240407,
      "node_id": "PRRC_kwDOABII586Zjk8X",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK(spent ? coin.IsSpent() : !coin.IsSpent());\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }\n+                const auto have{cache.GetPossiblySpentCoinFromCache(outpoint)};\n+                BOOST_CHECK(should_have ? !!have : !have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK(cache.GetCacheSize() == counter);\n+}\n+\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_db, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache(&dummy);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(fetch_inputs_from_cache, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    CCoinsViewCache main_cache(&dummy);\n+    PopulateCache(block, main_cache);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();\n+    }\n+}\n+\n+// Test for the case where a block spends coins that are spent in the cache, but\n+// the spentness has not been flushed to the db.\n+BOOST_FIXTURE_TEST_CASE(fetch_no_double_spend, CoinsViewCacheAsyncTest)\n+{\n+    const auto& block{getBlock()};\n+    NoAccessCoinsView dummy;\n+    CCoinsViewCache db(&dummy);\n+    PopulateCache(block, db);\n+    CCoinsViewCache main_cache(&dummy);\n+    // Add all inputs as spent already in cache\n+    PopulateCache(block, main_cache, /*spent=*/true);\n+    CoinsViewCacheAsync view{main_cache, db};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) view.AccessCoin(in.prevout);\n+        }\n+        // Coins are not added to the view, even though they exist unspent in the parent db\n+        BOOST_CHECK(view.GetCacheSize() == 0);",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 166,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574715871,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There's one remaining that wasn't migrated:\r\n```C++\r\nBOOST_CHECK(cache.GetCacheSize() == counter);\r\n```",
      "created_at": "2025-12-01T09:11:22Z",
      "updated_at": "2025-12-01T09:46:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576240407",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576240407"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 166,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576246728",
      "pull_request_review_id": 3523358497,
      "id": 2576246728,
      "node_id": "PRRC_kwDOABII586ZjmfI",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                const uint64_t shorttxid{prevhash.ToUint256().GetUint64(0)};\n+                uint256 u(i);\n+                WriteLE64(u.data(), shorttxid);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(COutPoint(txid, 0));\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType chainType = ChainType::MAIN,\n+                              TestOpts opts = {})",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 66,
      "commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574437547,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "formatting is still off though",
      "created_at": "2025-12-01T09:13:33Z",
      "updated_at": "2025-12-01T09:43:06Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2576246728",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2576246728"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 66,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577293052",
      "pull_request_review_id": 3525252498,
      "id": 2577293052,
      "node_id": "PRRC_kwDOABII586Znl78",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "That would be racy. We could have the worker thread count be a variable instead of hard coded, then for a test we could make it zero.",
      "created_at": "2025-12-01T14:23:26Z",
      "updated_at": "2025-12-01T14:23:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577293052",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577293052"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577297663",
      "pull_request_review_id": 3525258445,
      "id": 2577297663,
      "node_id": "PRRC_kwDOABII586ZnnD_",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, txid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.size() == 0) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {\n+            for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.size() == 0) return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock = uint256::ZERO;\n+    }\n+\n+    bool Flush() override",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 208,
      "commit_id": "227ead11696d73db24834f612eb3e0b55a8fc62e",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574503828,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Oh, we override so we make sure all threads are stopped before we do the batch write. This is in a comment two lines below.",
      "created_at": "2025-12-01T14:24:31Z",
      "updated_at": "2025-12-01T14:24:31Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577297663",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577297663"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 213,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577299367",
      "pull_request_review_id": 3525260686,
      "id": 2577299367,
      "node_id": "PRRC_kwDOABII586Znnen",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 117,
      "original_position": 63,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574518539,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Looks like this needs more work, it's not as easy as I though - we could use an `std::deque` instead of a `vector` here:\r\n```patch\r\nSubject: [PATCH] std::deque<InputToFetch> m_inputs\r\n---\r\ndiff --git a/src/coinsviewcacheasync.h b/src/coinsviewcacheasync.h\r\n--- a/src/coinsviewcacheasync.h\t(revision a3f56354d6e3f64eaca84a16e4951e6073090f60)\r\n+++ b/src/coinsviewcacheasync.h\t(revision 462408b897197de3a7067dcbdee318ad9dc1e546)\r\n@@ -17,6 +17,7 @@\r\n #include <atomic>\r\n #include <barrier>\r\n #include <cstdint>\r\n+#include <deque>\r\n #include <optional>\r\n #include <ranges>\r\n #include <thread>\r\n@@ -55,14 +56,9 @@\r\n         //! The coin that workers will fetch and main thread will insert into cache.\r\n         std::optional<Coin> coin{std::nullopt};\r\n \r\n-        /**\r\n-         * We only move when m_inputs reallocates during setup.\r\n-         * We never move after work begins, so we don't have to copy other members.\r\n-         */\r\n-        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\r\n         explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n     };\r\n-    mutable std::vector<InputToFetch> m_inputs{};\r\n+    mutable std::deque<InputToFetch> m_inputs{};\r\n \r\n     /**\r\n      * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\r\n```\r\n\r\nBut unfortunately the speed difference is measurable (5% slower):\r\n\r\n> vector:\r\n\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,644,638.02 |              608.04 |    0.1% |      1.09 | `CoinsViewCacheAsyncBenchmark`\r\n```\r\n\r\n> deque:\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,732,962.13 |              577.05 |    0.1% |      1.10 | `CoinsViewCacheAsyncBenchmark`\r\n```\r\n\r\n----\r\n\r\nMaybe we could split out the atomic and have a vector + a deque, something like:\r\n```patch\r\ndiff --git a/src/coinsviewcacheasync.h b/src/coinsviewcacheasync.h\r\n--- a/src/coinsviewcacheasync.h\t(revision 462408b897197de3a7067dcbdee318ad9dc1e546)\r\n+++ b/src/coinsviewcacheasync.h\t(date 1764598896036)\r\n@@ -48,17 +48,17 @@\r\n     mutable uint32_t m_input_tail{0};\r\n \r\n     //! The inputs of the block which is being fetched.\r\n-    struct InputToFetch {\r\n-        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\r\n-        std::atomic_flag ready{};\r\n+    struct InputData {\r\n         //! The outpoint of the input to fetch;\r\n         const COutPoint& outpoint;\r\n         //! The coin that workers will fetch and main thread will insert into cache.\r\n         std::optional<Coin> coin{std::nullopt};\r\n \r\n-        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n+        explicit InputData(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\r\n     };\r\n-    mutable std::deque<InputToFetch> m_inputs{};\r\n+    //! Workers set this after setting the coin. The main thread tests this before reading the coin.\r\n+    mutable std::deque<std::atomic_flag> m_ready_flags{};\r\n+    mutable std::vector<InputData> m_inputs{};\r\n \r\n     /**\r\n      * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\r\n@@ -97,19 +97,18 @@\r\n         const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\r\n         if (i >= m_inputs.size()) [[unlikely]] return false;\r\n \r\n-        auto& input{m_inputs[i]};\r\n         // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\r\n-        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\r\n+        if (std::ranges::binary_search(m_txids, m_inputs[i].outpoint.hash.ToUint256().GetUint64(0))) {\r\n             // We can use relaxed ordering here since we don't write the coin.\r\n-            input.ready.test_and_set(std::memory_order_relaxed);\r\n-            input.ready.notify_one();\r\n+            m_ready_flags[i].test_and_set(std::memory_order_relaxed);\r\n+            m_ready_flags[i].notify_one();\r\n             return true;\r\n         }\r\n \r\n-        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\r\n+        if (auto coin{GetCoinWithoutMutating(m_inputs[i].outpoint)}) [[likely]] m_inputs[i].coin.emplace(std::move(*coin));\r\n         // We need release here, so writing coin in the line above happens before the main thread acquires.\r\n-        input.ready.test_and_set(std::memory_order_release);\r\n-        input.ready.notify_one();\r\n+        m_ready_flags[i].test_and_set(std::memory_order_release);\r\n+        m_ready_flags[i].notify_one();\r\n         return true;\r\n     }\r\n \r\n@@ -135,17 +134,16 @@\r\n         if (!inserted) return ret;\r\n \r\n         if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\r\n-            auto& input{m_inputs[*i]};\r\n             // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\r\n-            while (!input.ready.test(std::memory_order_acquire)) {\r\n+            while (!m_ready_flags[*i].test(std::memory_order_acquire)) {\r\n                 // Work instead of waiting if the coin is not ready\r\n                 if (!ProcessInputInBackground()) {\r\n                     // No more work, just wait\r\n-                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\r\n+                    m_ready_flags[*i].wait(/*old=*/false, std::memory_order_acquire);\r\n                     break;\r\n                 }\r\n             }\r\n-            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\r\n+            if (m_inputs[*i].coin) [[likely]] ret->second.coin = std::move(*m_inputs[*i].coin);\r\n         }\r\n \r\n         if (ret->second.coin.IsSpent()) [[unlikely]] {\r\n@@ -180,6 +178,10 @@\r\n     //! Start fetching all block inputs in parallel.\r\n     void StartFetching(const CBlock& block) noexcept\r\n     {\r\n+        int input_count{std::accumulate(block.vtx.begin() + 1, block.vtx.end(), 0, [](size_t s, const auto& t) { return s + t->vin.size(); })};\r\n+        m_ready_flags.resize(input_count);\r\n+        m_inputs.reserve(input_count);\r\n+\r\n         // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\r\n         for (const auto& tx : block.vtx | std::views::drop(1)) {\r\n             for (const auto& input : tx->vin) m_inputs.emplace_back(input.prevout);\r\n```\r\n(maybe deduplicating the index accesses speeds it back up, not sure)\r\nbut this would be even slower:\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,880,070.41 |              531.89 |    0.3% |      1.10 | `CoinsViewCacheAsyncBenchmark`",
      "created_at": "2025-12-01T14:24:54Z",
      "updated_at": "2025-12-01T14:24:54Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577299367",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577299367"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 116,
      "original_start_line": 62,
      "start_side": "RIGHT",
      "line": 117,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577321551",
      "pull_request_review_id": 3525291129,
      "id": 2577321551,
      "node_id": "PRRC_kwDOABII586Zns5P",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "you sure it would be racy?",
      "created_at": "2025-12-01T14:30:57Z",
      "updated_at": "2025-12-01T14:30:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577321551",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577321551"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577345226",
      "pull_request_review_id": 3525321260,
      "id": 2577345226,
      "node_id": "PRRC_kwDOABII586ZnyrK",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}",
      "path": "src/coinsviewcacheasync.h",
      "position": 117,
      "original_position": 63,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574518539,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> I disagree, I think the current move construction is incorrect and if I understand it correctly, we should reserve instead and delete (or ignore) the other constructors.\r\n\r\nI think you are disagreeing with my statement:\r\n\r\n> since it only happens before we start doing work, might as well make it simple and not bother moving the other fields\r\n\r\nbecause the other things I said were facts. Do you think we should also construct new `atomic_flag`s when doing the move construction? As I mentioned I don't think it's worth it. We can logically see the only time we will move is during a reallocation of the vector when capacity is reached. It doesn't matter if we reserve or not, the compiler cannot deduce that so will still require the move constructor.\r\nA deque does not need to reallocate and move all elements when another is added over a capacity, which is why it is ok to use atomics without a custom move constructor. But, it is obviously much slower than a vector.",
      "created_at": "2025-12-01T14:37:01Z",
      "updated_at": "2025-12-01T14:38:02Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577345226",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577345226"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": 116,
      "original_start_line": 62,
      "start_side": "RIGHT",
      "line": 117,
      "original_line": 117,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577362125",
      "pull_request_review_id": 3525342578,
      "id": 2577362125,
      "node_id": "PRRC_kwDOABII586Zn2zN",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "There is a `ConnectBlock` benchmark already. But, it only does internal spends so it won't be that great for this. I can maybe extend it to also work on a block with inputs from leveldb. WDYT?",
      "created_at": "2025-12-01T14:41:07Z",
      "updated_at": "2025-12-01T14:41:07Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577362125",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577362125"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577369275",
      "pull_request_review_id": 3525352562,
      "id": 2577369275,
      "node_id": "PRRC_kwDOABII586Zn4i7",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "If we have a backing cache that blocks, how can we know if it's the main thread or worker threads that need to be blocked? And if we block the main thread by mistake, it will make no progress even though the worker thread can fetch all inputs",
      "created_at": "2025-12-01T14:42:40Z",
      "updated_at": "2025-12-01T14:42:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577369275",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577369275"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577376037",
      "pull_request_review_id": 3525361544,
      "id": 2577376037,
      "node_id": "PRRC_kwDOABII586Zn6Ml",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 25,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": 2576063953,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We want to specifically test that we do not access the main cache's backing view, by e.g. calling `GetCoin` on it. If we return a nullopt here then it would correctly go to the db layer (while then mutating base non-atomically and causing UB), while we want to make sure we blow up here because it is a failed test.",
      "created_at": "2025-12-01T14:44:19Z",
      "updated_at": "2025-12-01T15:54:17Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577376037",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577376037"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577394394",
      "pull_request_review_id": 3525385329,
      "id": 2577394394,
      "node_id": "PRRC_kwDOABII586Zn-ra",
      "diff_hunk": "@@ -0,0 +1,187 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs)\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256(1))};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 50,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574685431,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> NoAccessCoinsView is designed to abort on access\r\n\r\nIt is designed to abort on accessing the db via the main cache. We want to access the db only via our `m_db` ref and not go through the main cache's `base` pointer. This is unrelated to the test of short txid collisions. For those, we want to go to successfully go to disk on the main thread, while getting a nullopt from our m_input coin.",
      "created_at": "2025-12-01T14:48:26Z",
      "updated_at": "2025-12-01T14:48:26Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577394394",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577394394"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 50,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577433809",
      "pull_request_review_id": 3525442575,
      "id": 2577433809,
      "node_id": "PRRC_kwDOABII586ZoITR",
      "diff_hunk": "@@ -485,6 +486,10 @@ class CoinsViews {\n     //! can fit per the dbcache setting.\n     std::unique_ptr<CCoinsViewCache> m_cacheview GUARDED_BY(cs_main);\n \n+    //! Used as an empty view that is only passed into ConnectBlock to help speed up block validation,\n+    //! as well as not pollute the underlying cache with newly created coins in case the block is invalid.",
      "path": "src/validation.h",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574819043,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> when a block has e.g. a double-spend to make sure it's not propagated to the main cache\r\n\r\nThat would be a necessary condition of a double-spending block test. If the double spend is propagated to the main cache it is part of the utxo set and the test is a failure. The main cache is treated as the source of truth.",
      "created_at": "2025-12-01T14:57:57Z",
      "updated_at": "2025-12-01T14:57:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577433809",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577433809"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 493,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577565765",
      "pull_request_review_id": 3525618827,
      "id": 2577565765,
      "node_id": "PRRC_kwDOABII586ZoohF",
      "diff_hunk": "@@ -0,0 +1,186 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/util/random.h>\n+#include <test/util/setup_common.h>\n+#include <uint256.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <memory>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+struct NoAccessCoinsView : CCoinsView {\n+    std::optional<Coin> GetCoin(const COutPoint&) const override { abort(); }\n+};\n+\n+struct CoinsViewCacheAsyncTest : BasicTestingSetup {\n+private:\n+    std::unique_ptr<CoinsViewCacheAsync> m_async_cache{nullptr};\n+    std::unique_ptr<CBlock> m_block{nullptr};\n+\n+    CBlock CreateBlock(int32_t num_txs) const noexcept\n+    {\n+        CBlock block;\n+        CMutableTransaction coinbase;\n+        coinbase.vin.emplace_back();\n+        block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+        Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+        for (const auto i : std::views::iota(1, num_txs)) {\n+            CMutableTransaction tx;\n+            Txid txid;\n+            if (i % 3 == 0) {\n+                txid = Txid::FromUint256(uint256(i));\n+            } else if (i % 3 == 1) {\n+                txid = prevhash;\n+            } else {\n+                // Test shortid collisions\n+                uint256 u{};\n+                std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+                txid = Txid::FromUint256(u);\n+            }\n+            tx.vin.emplace_back(txid, 0);\n+            prevhash = tx.GetHash();\n+            block.vtx.push_back(MakeTransactionRef(tx));\n+        }\n+\n+        return block;\n+    }\n+\n+public:\n+    explicit CoinsViewCacheAsyncTest(const ChainType& chainType = ChainType::MAIN,\n+                              const TestOpts& opts = {})\n+        : BasicTestingSetup{chainType, opts}\n+    {\n+        SeedRandomForTest(SeedRand::FIXED_SEED);\n+\n+        const auto num_txs{100};\n+        m_block = std::make_unique<CBlock>(CreateBlock(num_txs));\n+    }\n+\n+    const CBlock& getBlock() const noexcept { return *m_block; }\n+};\n+\n+void PopulateCache(const CBlock& block, CCoinsViewCache& cache, bool spent = false)\n+{\n+    for (const auto& tx : block.vtx) {\n+        for (const auto& in : tx->vin) {\n+            auto outpoint{in.prevout};\n+            Coin coin{};\n+            if (!spent) coin.out.nValue = 1;\n+            BOOST_CHECK_EQUAL(coin.IsSpent(), spent);\n+            cache.EmplaceCoinInternalDANGER(std::move(outpoint), std::move(coin));\n+        }\n+    }\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.GetPossiblySpentCoinFromCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) {\n+                    cache.AccessCoin(outpoint);\n+                    ++counter;\n+                }",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 106,
      "commit_id": "eee2204d6f7117c5b39abaf47d7d329ff0951638",
      "original_commit_id": "236e7a4374a9ae6ba24c6001b04ba4884f9f2925",
      "in_reply_to_id": 2575931153,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "But `ConnectBlock` also inserts the newly created utxos into the cache, so that the next call to `AccessCoin` will just get it from the cache's `cacheCoins` map.",
      "created_at": "2025-12-01T15:29:12Z",
      "updated_at": "2025-12-01T15:29:12Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577565765",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577565765"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 103,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 106,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577730632",
      "pull_request_review_id": 3525836114,
      "id": 2577730632,
      "node_id": "PRRC_kwDOABII586ZpQxI",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> So it kinda' reproduces that it doesn't make sense to do more than 4\r\n\r\nLooks like it doesn't make sense to do more than 2?",
      "created_at": "2025-12-01T16:12:27Z",
      "updated_at": "2025-12-01T16:12:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577730632",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577730632"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577771108",
      "pull_request_review_id": 3525895323,
      "id": 2577771108,
      "node_id": "PRRC_kwDOABII586Zpapk",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "maybe, but leveldb is basically empty, we shouldn't take it *too* seriously ",
      "created_at": "2025-12-01T16:24:27Z",
      "updated_at": "2025-12-01T16:24:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2577771108",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2577771108"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2595703803",
      "pull_request_review_id": 3548591853,
      "id": 2595703803,
      "node_id": "PRRC_kwDOABII586at0v7",
      "diff_hunk": "@@ -0,0 +1,241 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <uint256.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr uint32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch;\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)};\n+        if (!coin) coin = m_db.GetCoin(outpoint);\n+        if (coin && !coin->IsSpent()) [[likely]] return coin;\n+        return std::nullopt;\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint &outpoint) const noexcept\n+    {\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const override\n+    {\n+        const auto [ret, inserted] = cacheCoins.try_emplace(outpoint);\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 172,
      "original_position": 142,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574769313,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is tested now by having zero worker threads.",
      "created_at": "2025-12-07T00:26:48Z",
      "updated_at": "2025-12-07T00:26:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2595703803",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2595703803"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 172,
      "original_line": 172,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637244154",
      "pull_request_review_id": 3601204703,
      "id": 2637244154,
      "node_id": "PRRC_kwDOABII586dMSb6",
      "diff_hunk": "@@ -173,6 +173,12 @@ bool CCoinsViewCache::HaveCoinInCache(const COutPoint &outpoint) const {\n     return (it != cacheCoins.end() && !it->second.coin.IsSpent());\n }\n \n+std::optional<Coin> CCoinsViewCache::GetPossiblySpentCoinFromCache(const COutPoint& outpoint) const noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "765b57d1b14df873bfbbc0a49126831acdf71702",
      "in_reply_to_id": 2574500339,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I've split the PR up into multiple commits that build on each other. Please let me know what you think.",
      "created_at": "2025-12-20T17:49:03Z",
      "updated_at": "2025-12-20T17:49:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637244154",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637244154"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 176,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637771583",
      "pull_request_review_id": 3601666630,
      "id": 2637771583,
      "node_id": "PRRC_kwDOABII586dOTM_",
      "diff_hunk": "@@ -3122,6 +3124,7 @@ bool Chainstate::ConnectTip(\n             if (state.IsInvalid())\n                 InvalidBlockFound(pindexNew, state);\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\n+            view.Reset();",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 22,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> // local CCoinsViewCache goes out of scope\r\n\r\nThis isn't true anymore as far as I can tell",
      "created_at": "2025-12-21T11:49:13Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637771583",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637771583"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3112,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637799438",
      "pull_request_review_id": 3601666630,
      "id": 2637799438,
      "node_id": "PRRC_kwDOABII586dOaAO",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "hmmm, isn't this UB, aren't we getting lifetime problems here? \r\n\r\nnit: why are the tests separated from the implementation? They're part of the \"feature\", how can we review one fully without the other?",
      "created_at": "2025-12-21T12:42:58Z",
      "updated_at": "2025-12-21T13:57:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637799438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637799438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637805247",
      "pull_request_review_id": 3601666630,
      "id": 2637805247,
      "node_id": "PRRC_kwDOABII586dOba_",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {\n+            if (!coin->IsSpent()) [[likely]] return coin;\n+            return std::nullopt;\n+        }\n+        return m_db.GetCoin(outpoint);\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.empty()) [[unlikely]] return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock.SetNull();\n+    }\n+\n+    bool Flush(bool will_reuse_cache) override\n+    {\n+        // We need to stop workers from accessing base before we mutate it.\n+        StopFetching();\n+        const auto ret{CCoinsViewCache::Flush(will_reuse_cache)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db,\n+        int32_t num_workers = WORKER_THREADS) noexcept\n+        : CCoinsViewCache{&cache}, m_db{db}, m_barrier{num_workers + 1}\n+    {\n+        for (const auto n : std::views::iota(0, num_workers)) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    while (ProcessInputInBackground()) [[likely]] {}\n+                    if (m_inputs.empty()) [[unlikely]] return;\n+                    m_barrier.arrive_and_wait();\n+                }\n+            });\n+        }\n+    }\n+\n+    ~CoinsViewCacheAsync() override\n+    {\n+        m_barrier.arrive_and_drop();",
      "path": "src/coinsviewcacheasync.h",
      "position": 271,
      "original_position": 240,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we seem to be calling `StopFetching` everywhere except here - since we rely on `m_inputs.empty()` for releasing the barrier, it might be safer to do that here, too - what do you think? Or maybe a `Flush()` - not sure...",
      "created_at": "2025-12-21T12:53:53Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637805247",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637805247"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 271,
      "original_line": 271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637813556",
      "pull_request_review_id": 3601666630,
      "id": 2637813556,
      "node_id": "PRRC_kwDOABII586dOdc0",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 25,
      "commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Based on our previous measurements I think this should remain `4` - unless you have better data.",
      "created_at": "2025-12-21T13:08:46Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637813556",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637813556"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 25,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637821587",
      "pull_request_review_id": 3601666630,
      "id": 2637821587,
      "node_id": "PRRC_kwDOABII586dOfaT",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "this is still super-fishy to me, we have to fix some abstractions here first ...",
      "created_at": "2025-12-21T13:23:01Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637821587",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637821587"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637823046",
      "pull_request_review_id": 3601666630,
      "id": 2637823046,
      "node_id": "PRRC_kwDOABII586dOfxG",
      "diff_hunk": "@@ -484,7 +492,7 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * @note this is marked const, but may actually append to `cacheCoins`, increasing\n      * memory usage.\n      */\n-    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;\n+    virtual CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 20,
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "original_commit_id": "ab1614473bee4abb558ff8b8fdf941fcaff122a6",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Doesn't this incur an additional hot-path virtual dispatch cost?\r\nI will carve this out to a separate commit and run a reindex-chainstate with minimal dbcache to force `Flush` & `FetchCoin` calls with and without virtual access to see if this is a valid concern.",
      "created_at": "2025-12-21T13:25:50Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637823046",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637823046"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 495,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637825716",
      "pull_request_review_id": 3601666630,
      "id": 2637825716,
      "node_id": "PRRC_kwDOABII586dOga0",
      "diff_hunk": "@@ -0,0 +1,31 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <coins.h>\n+\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    //! Reset state.\n+    void Reset() noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 14,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "dc4c3f6cac68dd26fab221b59b957eb84428bab7",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "`Reset` doesn't sound like an `async` property - would it make sense to make that a `CCoinsViewCache` method instead?",
      "created_at": "2025-12-21T13:30:43Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637825716",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637825716"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 201,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637834124",
      "pull_request_review_id": 3601666630,
      "id": 2637834124,
      "node_id": "PRRC_kwDOABII586dOieM",
      "diff_hunk": "@@ -67,6 +79,11 @@ class CoinsViewCacheAsync : public CCoinsViewCache\n         if (i >= m_inputs.size()) [[unlikely]] return false;\n \n         auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 31,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "b9edd77b4960f68afc761447e4e3372371be2143",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "b9edd77b4960f68afc761447e4e3372371be2143:\r\nthis feature is nicely split out of the whole - but I'm missing a test in the commit that could help me debug it locally before I move on to the next commit.",
      "created_at": "2025-12-21T13:44:21Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637834124",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637834124"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 94,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637834994",
      "pull_request_review_id": 3601666630,
      "id": 2637834994,
      "node_id": "PRRC_kwDOABII586dOiry",
      "diff_hunk": "@@ -202,4 +202,20 @@ BOOST_AUTO_TEST_CASE(access_non_input_coin)\n     }\n }\n \n+// Test that the main thread can make progress with no workers\n+BOOST_AUTO_TEST_CASE(fetch_main_thread)",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 197,
      "original_position": 5,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "85c20a57d4e97255964d2451c368d2fb0fda1f19",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "can we add this to the commit that introduces the feature that this is validating?",
      "created_at": "2025-12-21T13:46:08Z",
      "updated_at": "2025-12-21T13:58:22Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637834994",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637834994"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 197,
      "original_line": 197,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637835286",
      "pull_request_review_id": 3601666630,
      "id": 2637835286,
      "node_id": "PRRC_kwDOABII586dOiwW",
      "diff_hunk": "@@ -24,6 +24,19 @@\n \n static constexpr int32_t WORKER_THREADS{8};\n \n+/**",
      "path": "src/coinsviewcacheasync.h",
      "position": 29,
      "original_position": 4,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219:\r\ncomments aren't features - why not add them when `CoinsViewCacheAsync` is introduced and extend the description with every added feature",
      "created_at": "2025-12-21T13:46:48Z",
      "updated_at": "2025-12-21T13:56:40Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637835286",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637835286"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 29,
      "original_line": 29,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637836880",
      "pull_request_review_id": 3601666630,
      "id": 2637836880,
      "node_id": "PRRC_kwDOABII586dOjJQ",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {\n+            if (!coin->IsSpent()) [[likely]] return coin;\n+            return std::nullopt;\n+        }\n+        return m_db.GetCoin(outpoint);\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {",
      "path": "src/coinsviewcacheasync.h",
      "position": 164,
      "original_position": 127,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "does the `[[likely]]` have an effect on the `if` below? As mentioned before, I think it has some weird effect when nested...",
      "created_at": "2025-12-21T13:49:40Z",
      "updated_at": "2025-12-21T13:58:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637836880",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637836880"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637874580",
      "pull_request_review_id": 3601745409,
      "id": 2637874580,
      "node_id": "PRRC_kwDOABII586dOsWU",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {\n+            if (!coin->IsSpent()) [[likely]] return coin;\n+            return std::nullopt;\n+        }\n+        return m_db.GetCoin(outpoint);\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {",
      "path": "src/coinsviewcacheasync.h",
      "position": 164,
      "original_position": 127,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637836880,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "No, it does not affect anything other than than the loop branch. It's not nested here.",
      "created_at": "2025-12-21T14:54:43Z",
      "updated_at": "2025-12-21T14:54:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637874580",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637874580"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 164,
      "original_line": 164,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637878000",
      "pull_request_review_id": 3601747267,
      "id": 2637878000,
      "node_id": "PRRC_kwDOABII586dOtLw",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> hmmm, isn't this UB, aren't we getting lifetime problems here?\r\n\r\nNothing touches `base` while it is `nullptr`. We need to call a method to get UB, and we don't do that until we replace it with a valid pointer. Fuzzing would have revealed any UB by now.\r\n",
      "created_at": "2025-12-21T15:00:00Z",
      "updated_at": "2025-12-21T15:00:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637878000",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637878000"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637878822",
      "pull_request_review_id": 3601747808,
      "id": 2637878822,
      "node_id": "PRRC_kwDOABII586dOtYm",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> why are the tests separated from the implementation?\r\n\r\nThis seems to be a standard way to do this. Less cognitive load per commit. See e.g. #29415.",
      "created_at": "2025-12-21T15:01:19Z",
      "updated_at": "2025-12-21T15:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637878822",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637878822"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637880445",
      "pull_request_review_id": 3601749078,
      "id": 2637880445,
      "node_id": "PRRC_kwDOABII586dOtx9",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Less cognitive load per commit\r\n\r\nStrongly disagree. We simply don't have enough information to review it properly and just skip to the next commit. So in a way, yes, less cognitive load - but not the good kind...",
      "created_at": "2025-12-21T15:04:34Z",
      "updated_at": "2025-12-21T15:04:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637880445",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637880445"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637880484",
      "pull_request_review_id": 3601749097,
      "id": 2637880484,
      "node_id": "PRRC_kwDOABII586dOtyk",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637821587,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We know we will always have a cache as the base here. This doesn't always hold for the base class. e.g. `CCoinsViewCache` can have a `CCoinsViewDB` as base.",
      "created_at": "2025-12-21T15:04:37Z",
      "updated_at": "2025-12-21T15:04:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637880484",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637880484"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637881001",
      "pull_request_review_id": 3601749452,
      "id": 2637881001,
      "node_id": "PRRC_kwDOABII586dOt6p",
      "diff_hunk": "@@ -484,7 +492,7 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * @note this is marked const, but may actually append to `cacheCoins`, increasing\n      * memory usage.\n      */\n-    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;\n+    virtual CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 20,
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "original_commit_id": "ab1614473bee4abb558ff8b8fdf941fcaff122a6",
      "in_reply_to_id": 2637823046,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I'm not sure why that matters. Our benchmarks show a very large speedup with this change?",
      "created_at": "2025-12-21T15:05:24Z",
      "updated_at": "2025-12-21T15:05:24Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637881001",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637881001"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 495,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637902701",
      "pull_request_review_id": 3601768610,
      "id": 2637902701,
      "node_id": "PRRC_kwDOABII586dOzNt",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> Nothing touches base while it is nullptr\r\n\r\nIt's not `nullptr`, it's a dangling pointer.\r\n`CoinsViewCacheAsync` constructor takes `CCoinsViewCache&` from stack which gets destroyed after `setup_threadpool_test` exits, something like: https://godbolt.org/z/3e9qoPTP1\r\n\r\nThe fix could simply be:\r\n```patch\r\n std::optional<CoinsViewCacheAsync> g_async_cache{};\r\n std::optional<CCoinsViewDB> g_db{};\r\n+std::optional<CCoinsViewCache> g_cache{};\r\n \r\n static void setup_threadpool_test()\r\n {\r\n@@ -39,8 +40,8 @@\r\n         .memory_only = true,\r\n     };\r\n     g_db.emplace(std::move(db_params), CoinsViewOptions{});\r\n-    CCoinsViewCache cache{nullptr};\r\n-    g_async_cache.emplace(cache, *g_db);\r\n+    g_cache.emplace(nullptr);\r\n+    g_async_cache.emplace(*g_cache, *g_db);\r\n }\r\n```",
      "created_at": "2025-12-21T15:37:55Z",
      "updated_at": "2025-12-21T15:40:04Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2637902701",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2637902701"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2638002253",
      "pull_request_review_id": 3601864264,
      "id": 2638002253,
      "node_id": "PRRC_kwDOABII586dPLhN",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Right, now I see. Yes it is a dangling pointer, but again UB is not triggered unless the pointer is dereferenced.",
      "created_at": "2025-12-21T18:01:34Z",
      "updated_at": "2025-12-21T18:01:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2638002253",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2638002253"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2640227343",
      "pull_request_review_id": 3604494746,
      "id": 2640227343,
      "node_id": "PRRC_kwDOABII586dXqwP",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We can get rid of the dangling pointer by just doing this:\r\n\r\n```diff\r\ndiff --git a/src/test/fuzz/coinsviewcacheasync.cpp b/src/test/fuzz/coinsviewcacheasync.cpp\r\nindex 77c378288e..8796c51926 100644\r\n--- a/src/test/fuzz/coinsviewcacheasync.cpp\r\n+++ b/src/test/fuzz/coinsviewcacheasync.cpp\r\n@@ -41,6 +41,7 @@ static void setup_threadpool_test()\r\n     g_db.emplace(std::move(db_params), CoinsViewOptions{});\r\n     CCoinsViewCache cache{nullptr};\r\n     g_async_cache.emplace(cache, *g_db);\r\n+    g_async_cache->SetBackend(nullptr);\r\n }\r\n \r\n FUZZ_TARGET(coinsviewcacheasync, .init = setup_threadpool_test)\r\n```",
      "created_at": "2025-12-22T15:21:46Z",
      "updated_at": "2025-12-22T15:21:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2640227343",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2640227343"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2640238090",
      "pull_request_review_id": 3604506893,
      "id": 2640238090,
      "node_id": "PRRC_kwDOABII586dXtYK",
      "diff_hunk": "@@ -0,0 +1,31 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <coins.h>\n+\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    //! Reset state.\n+    void Reset() noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 14,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "dc4c3f6cac68dd26fab221b59b957eb84428bab7",
      "in_reply_to_id": 2637825716,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We would have to have a virtual method in the base `CCoinsViewCache` class, and then `override` it here because we have to clear our subclass members as well. But, it would never be called as a base class anywhere. It might make the commits easier to follow though, since I could introduce it on the base class and use that to reuse just a `CCoinsViewCache`. Then I could introduce `CoinsViewCacheAsync` later. I will experiment.",
      "created_at": "2025-12-22T15:24:56Z",
      "updated_at": "2025-12-22T15:24:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2640238090",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2640238090"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 201,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2641779222",
      "pull_request_review_id": 3606362440,
      "id": 2641779222,
      "node_id": "PRRC_kwDOABII586ddloW",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637821587,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Updated to use a `FetchCoinWithoutMutating` protected method.",
      "created_at": "2025-12-23T02:59:49Z",
      "updated_at": "2025-12-23T02:59:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2641779222",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2641779222"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2641780077",
      "pull_request_review_id": 3606363905,
      "id": 2641780077,
      "node_id": "PRRC_kwDOABII586ddl1t",
      "diff_hunk": "@@ -0,0 +1,181 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <consensus/amount.h>\n+#include <dbwrapper.h>\n+#include <logging.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <test/util/random.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <limits>\n+#include <map>\n+#include <optional>\n+#include <unordered_set>\n+#include <utility>\n+\n+std::optional<CoinsViewCacheAsync> g_async_cache{};\n+std::optional<CCoinsViewDB> g_db{};\n+\n+static void setup_threadpool_test()\n+{\n+    LogInstance().DisableLogging();\n+    auto db_params = DBParams{\n+        .path = \"\",\n+        .cache_bytes = 1_MiB,\n+        .memory_only = true,\n+    };\n+    g_db.emplace(std::move(db_params), CoinsViewOptions{});\n+    CCoinsViewCache cache{nullptr};",
      "path": "src/test/fuzz/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 42,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637799438,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is updated to have the same constructor interface as `CCoinsViewCache`, so fixed.",
      "created_at": "2025-12-23T03:00:28Z",
      "updated_at": "2025-12-23T03:00:29Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2641780077",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2641780077"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2645502461",
      "pull_request_review_id": 3610779003,
      "id": 2645502461,
      "node_id": "PRRC_kwDOABII586dryn9",
      "diff_hunk": "@@ -3113,7 +3114,7 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n-        CCoinsViewCache view(&CoinsTip());\n+        auto& view{*m_coins_views->m_connect_block_view};",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "14f1b7913861d95e3ffeda658d45b0b88e7019e7:\r\n\r\nI love this separation, we could extract it to a new PR since it kinda' makes sense on its own - carving out a small but self-sufficient portion of this PR.\r\nIt could also help us in future refactors (e.g. preallocating the coins cache maps to avoid resizes).\r\n\r\n-----\r\n\r\nCould we add a `Start` here as well, which could assert that this was in a clean state at the beginning (as a sanity check that all return paths are calling it)?\r\n```C++\r\nvoid CCoinsViewCache::Start()\r\n{\r\n    Assert(cacheCoins.empty());\r\n    Assert(cachedCoinsUsage == 0);\r\n    Assert(m_sentinel.second.Next() == &m_sentinel);\r\n    Assert(m_sentinel.second.Prev() == &m_sentinel);\r\n\r\n    SetBestBlock(base->GetBestBlock());\r\n}\r\n```\r\n\r\n----\r\n\r\nBesides the symmetry with `Reset`, it could help with using this same view for the other `/*will_reuse_cache=*/false`. The assertion would assure that the two cannot accidentally run at the same time (proving that we can reuse the same instance)\r\n* currently applied to `Chainstate::ConnectTip`, but could be added (here or in a separate cleanup PR) to `Chainstate::DisconnectTip` and `TestBlockValidity` cleanly\r\n* `CVerifyDB::VerifyDB` and `Chainstate::ReplayBlocks` & `Chainstate::RollforwardBlock` need to hold more than 1 block, not sure it's worth reusing the cache for those - though parallelization would be welcome in both cases...\r\n\r\nWe could also add `Reset()` and `Start()` to the constructor, but that would require fixing the mentioned UB in https://github.com/bitcoin/bitcoin/pull/34124#issuecomment-3694658009\r\n\r\n-----\r\n\r\nNote: we could access this through a dedicated method instead like we do with other similar ones:\r\n```C++\r\nCoinsViewCacheAsync& ConnectBlockView() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n{\r\n    AssertLockHeld(::cs_main);\r\n    Assert(m_coins_views);\r\n    return *Assert(m_coins_views->m_connect_block_view);\r\n}\r\n```",
      "created_at": "2025-12-24T11:39:01Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2645502461",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2645502461"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2645570612",
      "pull_request_review_id": 3610779003,
      "id": 2645570612,
      "node_id": "PRRC_kwDOABII586dsDQ0",
      "diff_hunk": "@@ -275,6 +277,13 @@ bool CCoinsViewCache::Sync()\n     return fOk;\n }\n \n+void CCoinsViewCache::Reset() noexcept\n+{\n+    cacheCoins.clear();\n+    cachedCoinsUsage = 0;\n+    hashBlock.SetNull();",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "14f1b7913861d95e3ffeda658d45b0b88e7019e7:\r\nwe're not setting `view.SetBestBlock` in `Chainstate::ConnectTip` in this commit - but I think we should, to avoid leaving the  lazy getter which is in a race with the setter. Since this is done in a multithreaded code, I think we should set it deterministically and remove the lazy init. Especially since `Flush`/`Sync` access `hashBlock` directly...",
      "created_at": "2025-12-24T12:15:44Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2645570612",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2645570612"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 296,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646742414",
      "pull_request_review_id": 3610779003,
      "id": 2646742414,
      "node_id": "PRRC_kwDOABII586dwhWO",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {\n+            if (!coin->IsSpent()) [[likely]] return coin;\n+            return std::nullopt;\n+        }\n+        return m_db.GetCoin(outpoint);\n+    }\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{GetCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            if (auto coin{GetCoinWithoutMutating(outpoint)}) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs in parallel.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));\n+        }\n+        // Don't start threads if there's nothing to fetch.\n+        if (m_inputs.empty()) [[unlikely]] return;\n+        // Sort txids so we can do binary search lookups.\n+        std::ranges::sort(m_txids);\n+        // Start workers by entering the barrier.\n+        m_barrier.arrive_and_wait();\n+    }\n+\n+    //! Stop fetching and reset state. Must be called before block is destroyed.\n+    void Reset() noexcept\n+    {\n+        StopFetching();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+        cacheCoins.clear();\n+        cachedCoinsUsage = 0;\n+        hashBlock.SetNull();\n+    }\n+\n+    bool Flush(bool will_reuse_cache) override\n+    {\n+        // We need to stop workers from accessing base before we mutate it.\n+        StopFetching();\n+        const auto ret{CCoinsViewCache::Flush(will_reuse_cache)};\n+        Reset();\n+        return ret;\n+    }\n+\n+    explicit CoinsViewCacheAsync(CCoinsViewCache& cache, const CCoinsView& db,\n+        int32_t num_workers = WORKER_THREADS) noexcept\n+        : CCoinsViewCache{&cache}, m_db{db}, m_barrier{num_workers + 1}\n+    {\n+        for (const auto n : std::views::iota(0, num_workers)) {\n+            m_worker_threads.emplace_back([this, n] {\n+                util::ThreadRename(strprintf(\"inputfetch.%i\", n));\n+                while (true) {\n+                    m_barrier.arrive_and_wait();\n+                    while (ProcessInputInBackground()) [[likely]] {}\n+                    if (m_inputs.empty()) [[unlikely]] return;\n+                    m_barrier.arrive_and_wait();\n+                }\n+            });\n+        }\n+    }\n+\n+    ~CoinsViewCacheAsync() override\n+    {\n+        m_barrier.arrive_and_drop();",
      "path": "src/coinsviewcacheasync.h",
      "position": 271,
      "original_position": 240,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637805247,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmmm, if I just call start and let the destructor do its job, I get a hanging test:\r\n```C++\r\nBOOST_AUTO_TEST_CASE(destructor_without_reset)\r\n{\r\n    CCoinsViewDB db{{.path = \"\", .memory_only = true}, {}};\r\n    CCoinsViewCache main_cache{&db};\r\n    CoinsViewCacheAsync view{&main_cache};\r\n    view.StartFetching(CreateBlock());\r\n    // Destructor called WITHOUT Reset() or Flush()\r\n}\r\n```\r\n\r\nadding an explicit stop to the destructor fixes it for me:\r\n```C++\r\n~CoinsViewCacheAsync() override\r\n{\r\n    StopFetching();\r\n    m_barrier.arrive_and_drop();\r\n    for (auto& t : m_worker_threads) t.join();\r\n}\r\n```\r\n\r\nIf you think this is a misuse of the API, we could add an assert in the destructor instead.",
      "created_at": "2025-12-25T08:43:01Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2646742414",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2646742414"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 271,
      "original_line": 271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647160362",
      "pull_request_review_id": 3610779003,
      "id": 2647160362,
      "node_id": "PRRC_kwDOABII586dyHYq",
      "diff_hunk": "@@ -0,0 +1,245 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{8};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches block inputs in parallel.\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache, overriding the FetchCoin private method and Flush.\n+ * It adds an additional StartFetching method to provide the block, and Reset to reset the state if Flush is not called.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    //! DB coins view to fetch from.\n+    const CCoinsView& m_db;\n+\n+    /**\n+     * Similar to CCoinsViewCache::GetCoin, but it does not mutate internally.\n+     * Therefore safe to call from any thread once inside the barrier.\n+     */\n+    std::optional<Coin> GetCoinWithoutMutating(const COutPoint& outpoint) const\n+    {\n+        if (auto coin{static_cast<CCoinsViewCache*>(base)->GetPossiblySpentCoinFromCache(outpoint)}) {",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "6db7f75f53bd89e4e9b019c6ecd0c31f43d0f219",
      "in_reply_to_id": 2637821587,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "My understanding is that as long as the current cache and its descendants are `CCoinsViewCache` instances, we will try to get the outpoint from them - but as mentioned, I think that violates their interface and introduced unannounced unpredictability (i.e. surprise the reviewer by assuming more locally than the interface promised).\r\n\r\nNot yet sure if that would be better, but if ew introduced an additional `CCoinsViewCache` method to peek into the structure, we wouldn't need iteration and casting, i.e. something like:\r\n```C++\r\nstd::optional<Coin> CCoinsViewBacked::PeekCoin(const COutPoint& outpoint) const { return base->PeekCoin(outpoint); }\r\n```\r\nand\r\n```C++\r\nstd::optional<Coin> CCoinsViewCache::PeekCoin(const COutPoint& outpoint) const\r\n{\r\n    if (auto it{cacheCoins.find(outpoint)}; it != cacheCoins.end()) {\r\n        return it->second.coin.IsSpent() ? std::nullopt : std::optional{it->second.coin};\r\n    }\r\n    return base->PeekCoin(outpoint);\r\n}\r\n```",
      "created_at": "2025-12-25T16:47:18Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2647160362",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647160362"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647213449",
      "pull_request_review_id": 3610779003,
      "id": 2647213449,
      "node_id": "PRRC_kwDOABII586dyUWJ",
      "diff_hunk": "@@ -484,7 +492,7 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * @note this is marked const, but may actually append to `cacheCoins`, increasing\n      * memory usage.\n      */\n-    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;\n+    virtual CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 20,
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "original_commit_id": "ab1614473bee4abb558ff8b8fdf941fcaff122a6",
      "in_reply_to_id": 2637823046,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Measured it a few times, got very different results, I guess we can assume for now that this isn't a problem.",
      "created_at": "2025-12-25T18:48:15Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2647213449",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647213449"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 495,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647213826",
      "pull_request_review_id": 3610779003,
      "id": 2647213826,
      "node_id": "PRRC_kwDOABII586dyUcC",
      "diff_hunk": "@@ -0,0 +1,31 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <coins.h>\n+\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    //! Reset state.\n+    void Reset() noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 14,
      "commit_id": "7b8fa2f815ade48ceec1ae80ce4812d0ac7d0312",
      "original_commit_id": "dc4c3f6cac68dd26fab221b59b957eb84428bab7",
      "in_reply_to_id": 2637825716,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The way you've added it is excellent, carving out a genuine sub-feature (which we could push as a separate PR)",
      "created_at": "2025-12-25T18:49:04Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2647213826",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647213826"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 201,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647996696",
      "pull_request_review_id": 3610779003,
      "id": 2647996696,
      "node_id": "PRRC_kwDOABII586d1TkY",
      "diff_hunk": "@@ -253,11 +253,13 @@ bool CCoinsViewCache::Flush(bool will_reuse_cache) {\n     auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n     bool fOk = base->BatchWrite(cursor, hashBlock);\n     if (fOk) {\n-        cacheCoins.clear();\n         if (will_reuse_cache) {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 5,
      "commit_id": "c465be604b11a96bbe0a78711e206a6e0c262c7f",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we can likely get rid of the `will_reuse_cache` now that we have a reusable cache that we can reset - will attempt in a follow-up",
      "created_at": "2025-12-26T10:28:11Z",
      "updated_at": "2025-12-28T18:02:18Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2647996696",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2647996696"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2648963149",
      "pull_request_review_id": 3610779003,
      "id": 2648963149,
      "node_id": "PRRC_kwDOABII586d4_hN",
      "diff_hunk": "@@ -85,6 +85,11 @@ void TestCoinsView(FuzzedDataProvider& fuzzed_data_provider, CCoinsView& backend\n                 if (is_db && best_block.IsNull()) best_block = uint256::ONE;\n                 coins_view_cache.SetBestBlock(best_block);\n             },\n+            [&] {\n+                coins_view_cache.Reset();\n+                // Set best block hash to non-null to satisfy the assertion in CCoinsViewDB::BatchWrite().\n+                if (is_db) coins_view_cache.SetBestBlock(uint256::ONE);",
      "path": "src/test/fuzz/coins_view.cpp",
      "position": 1,
      "original_position": 7,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we only need this for caches that actually write to db, so we might as well:\r\n```suggestion\r\n                if (!will_reuse_cache && is_db) coins_view_cache.SetBestBlock(uint256::ONE);\r\n```",
      "created_at": "2025-12-27T07:20:21Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2648963149",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2648963149"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 137,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2648968759",
      "pull_request_review_id": 3610779003,
      "id": 2648968759,
      "node_id": "PRRC_kwDOABII586d5A43",
      "diff_hunk": "@@ -1121,4 +1121,28 @@ BOOST_AUTO_TEST_CASE(ccoins_emplace_duplicate_keeps_usage_balanced)\n     BOOST_CHECK(cache.AccessCoin(outpoint) == coin1);\n }\n \n+BOOST_AUTO_TEST_CASE(ccoins_reset)",
      "path": "src/test/coins_tests.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "we could extend this with idempotency checks - especially if we add the mentioned `Start` method:\r\n```C++\r\nBOOST_AUTO_TEST_CASE(ccoins_start)\r\n{\r\n    test_only_CheckFailuresAreExceptionsNotAborts mock_checks{};\r\n\r\n    CCoinsView root;\r\n    CCoinsViewCacheTest cache{&root};\r\n\r\n    // Start fails if state wasn't reset\r\n    cache.Start();\r\n    cache.EmplaceCoinInternalDANGER({Txid::FromUint256(m_rng.rand256()), m_rng.rand32()}, {});\r\n    BOOST_CHECK_THROW(cache.Start(), NonFatalCheckError);\r\n\r\n    // Resetting allows start again\r\n    cache.Reset();\r\n    cache.Start();\r\n\r\n    // Reset and Start are idempotent\r\n    cache.Reset();\r\n    cache.Reset();\r\n    cache.Start();\r\n    cache.Start();\r\n}\r\n```",
      "created_at": "2025-12-27T07:28:00Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2648968759",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2648968759"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649001547",
      "pull_request_review_id": 3610779003,
      "id": 2649001547,
      "node_id": "PRRC_kwDOABII586d5I5L",
      "diff_hunk": "@@ -275,6 +275,13 @@ bool CCoinsViewCache::Sync()\n     return fOk;\n }\n \n+void CCoinsViewCache::Reset() noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "the constructor should likely call this reset at the beginning, so this should likely adjust `m_sentinel.second` as well, something like:\r\n```C++\r\nCCoinsViewCache::CCoinsViewCache(CCoinsView* baseIn, bool deterministic) :\r\n    CCoinsViewBacked(baseIn), m_deterministic(deterministic),\r\n    cacheCoins(0, SaltedOutpointHasher(/*deterministic=*/deterministic), CCoinsMap::key_equal{}, &m_cache_coins_memory_resource)\r\n{\r\n    CCoinsViewCache::Reset();\r\n    Start();\r\n}\r\n\r\nvoid CCoinsViewCache::Start()\r\n{\r\n    Assert(cacheCoins.empty());\r\n    Assert(cachedCoinsUsage == 0);\r\n    Assert(m_sentinel.second.Next() == &m_sentinel);\r\n    Assert(m_sentinel.second.Prev() == &m_sentinel);\r\n\r\n    SetBestBlock(base->GetBestBlock());\r\n}\r\n\r\nvoid CCoinsViewCache::Reset() noexcept\r\n{\r\n    cacheCoins.clear();\r\n    cachedCoinsUsage = 0;\r\n    hashBlock.SetNull();\r\n    m_sentinel.second.SelfRef(m_sentinel);\r\n}\r\n```",
      "created_at": "2025-12-27T07:42:39Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649001547",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649001547"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 290,
      "original_line": 290,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649003238",
      "pull_request_review_id": 3610779003,
      "id": 2649003238,
      "node_id": "PRRC_kwDOABII586d5JTm",
      "diff_hunk": "@@ -3131,8 +3133,9 @@ bool Chainstate::ConnectTip(\n                  Ticks<MillisecondsDouble>(time_3 - time_2),\n                  Ticks<SecondsDouble>(m_chainman.time_connect_total),\n                  Ticks<MillisecondsDouble>(m_chainman.time_connect_total) / m_chainman.num_blocks_total);\n-        bool flushed = view.Flush(/*will_reuse_cache=*/false); // local CCoinsViewCache goes out of scope\n+        bool flushed = view.Flush(/*will_reuse_cache=*/false); // No need to reallocate since it only has capacity for 1 block",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 30,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "ðŸ‘ for the new comment",
      "created_at": "2025-12-27T07:45:54Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649003238",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649003238"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3137,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649046808",
      "pull_request_review_id": 3610779003,
      "id": 2649046808,
      "node_id": "PRRC_kwDOABII586d5T8Y",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 177,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Is this idempotent, are we sure all state is reset after the previous block? Could we call a reset here or an assert to make sure we're not accidentally inheriting anything from a previous (failed?) fetch?",
      "created_at": "2025-12-27T09:11:31Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649046808",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649046808"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 207,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649047357",
      "pull_request_review_id": 3610779003,
      "id": 2649047357,
      "node_id": "PRRC_kwDOABII586d5UE9",
      "diff_hunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+static CBlock CreateBlock() noexcept\n+{\n+    static constexpr auto NUM_TXS{100};\n+    CBlock block;\n+    CMutableTransaction coinbase;\n+    coinbase.vin.emplace_back();\n+    block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+    Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+    for (const auto i : std::views::iota(1, NUM_TXS)) {\n+        CMutableTransaction tx;\n+        Txid txid;\n+        if (i % 3 == 0) {\n+            // External input\n+            txid = Txid::FromUint256(uint256(i));\n+        } else if (i % 3 == 1) {\n+            // Internal spend (prev tx)\n+            txid = prevhash;\n+        } else {\n+            // Test shortxid collisions (looks internal, but is external)\n+            uint256 u{};\n+            std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+            txid = Txid::FromUint256(u);\n+        }\n+        tx.vin.emplace_back(txid, 0);\n+        prevhash = tx.GetHash();\n+        block.vtx.push_back(MakeTransactionRef(tx));\n+    }\n+\n+    return block;\n+}\n+\n+void PopulateView(const CBlock& block, CCoinsView& view, bool spent = false)\n+{\n+    CCoinsViewCache cache{&view};\n+    cache.SetBestBlock(uint256::ONE);\n+\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            if (!txids.contains(in.prevout.hash)) {\n+                Coin coin{};\n+                if (!spent) coin.out.nValue = 1;\n+                cache.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+            }\n+        }\n+        txids.emplace(tx->GetHash());\n+    }\n+\n+    cache.Flush();\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto& first{cache.AccessCoin(outpoint)};\n+                const auto& second{cache.AccessCoin(outpoint)};\n+                BOOST_CHECK_EQUAL(&first, &second);\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) ++counter;\n+                const auto have{cache.HaveCoinInCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK_EQUAL(cache.GetCacheSize(), counter);\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    PopulateView(block, db);\n+    CCoinsViewCache main_cache{&db};\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        // Check that no coins have been moved up to main cache from db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!main_cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    CCoinsViewCache main_cache{&db};\n+    PopulateView(block, main_cache);\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "what if we forget to call `Reset()` between two `StartFetching` calls?",
      "created_at": "2025-12-27T09:13:03Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649047357",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649047357"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649050487",
      "pull_request_review_id": 3610779003,
      "id": 2649050487,
      "node_id": "PRRC_kwDOABII586d5U13",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        Assume(m_inputs.empty());\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 183,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "This is internal, so we don't necessarily need endian conversion here (would be skipped on most popular platforms anyway), but we could simplify a few of these regardless:\r\n```suggestion\r\n            m_txids.emplace_back(ReadLE64(tx->GetHash().begin()));\r\n```",
      "created_at": "2025-12-27T09:21:18Z",
      "updated_at": "2025-12-28T18:01:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649050487",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649050487"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649805438",
      "pull_request_review_id": 3614753401,
      "id": 2649805438,
      "node_id": "PRRC_kwDOABII586d8NJ-",
      "diff_hunk": "@@ -0,0 +1,51 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    const auto& coins_db{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsDB();)};\n+    CoinsViewCacheAsync async_cache{coins_tip, coins_db, /*deterministic=*/true};\n+\n+    bench.run([&] {\n+        async_cache.StartFetching(block);\n+        for (const auto& tx : block.vtx | std::views::drop(1)) {",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 42,
      "original_position": 41,
      "commit_id": "77c0df7b59ff5a3a77d37e77145f1a157e05db19",
      "original_commit_id": "69310ec0035351e486cfb51cb66492639f6f8b47",
      "in_reply_to_id": 2574793204,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added some benchmark results in the commits where it makes sense.",
      "created_at": "2025-12-28T16:42:50Z",
      "updated_at": "2025-12-28T16:42:50Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649805438",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649805438"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 42,
      "original_line": 42,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649880619",
      "pull_request_review_id": 3614801438,
      "id": 2649880619,
      "node_id": "PRRC_kwDOABII586d8fgr",
      "diff_hunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+static CBlock CreateBlock() noexcept\n+{\n+    static constexpr auto NUM_TXS{100};\n+    CBlock block;\n+    CMutableTransaction coinbase;\n+    coinbase.vin.emplace_back();\n+    block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+    Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+    for (const auto i : std::views::iota(1, NUM_TXS)) {\n+        CMutableTransaction tx;\n+        Txid txid;\n+        if (i % 3 == 0) {\n+            // External input\n+            txid = Txid::FromUint256(uint256(i));\n+        } else if (i % 3 == 1) {\n+            // Internal spend (prev tx)\n+            txid = prevhash;\n+        } else {\n+            // Test shortxid collisions (looks internal, but is external)\n+            uint256 u{};\n+            std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+            txid = Txid::FromUint256(u);\n+        }\n+        tx.vin.emplace_back(txid, 0);\n+        prevhash = tx.GetHash();\n+        block.vtx.push_back(MakeTransactionRef(tx));\n+    }\n+\n+    return block;\n+}\n+\n+void PopulateView(const CBlock& block, CCoinsView& view, bool spent = false)\n+{\n+    CCoinsViewCache cache{&view};\n+    cache.SetBestBlock(uint256::ONE);\n+\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            if (!txids.contains(in.prevout.hash)) {\n+                Coin coin{};\n+                if (!spent) coin.out.nValue = 1;\n+                cache.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+            }\n+        }\n+        txids.emplace(tx->GetHash());\n+    }\n+\n+    cache.Flush();\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto& first{cache.AccessCoin(outpoint)};\n+                const auto& second{cache.AccessCoin(outpoint)};\n+                BOOST_CHECK_EQUAL(&first, &second);\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) ++counter;\n+                const auto have{cache.HaveCoinInCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK_EQUAL(cache.GetCacheSize(), counter);\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    PopulateView(block, db);\n+    CCoinsViewCache main_cache{&db};\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        // Check that no coins have been moved up to main cache from db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!main_cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    CCoinsViewCache main_cache{&db};\n+    PopulateView(block, main_cache);\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649047357,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Bad things. We need to call Reset before the block is destroyed.",
      "created_at": "2025-12-28T19:19:41Z",
      "updated_at": "2025-12-28T19:19:41Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649880619",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649880619"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649881953",
      "pull_request_review_id": 3614802129,
      "id": 2649881953,
      "node_id": "PRRC_kwDOABII586d8f1h",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 177,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649046808,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It's not idempotent. We need to call `Reset`/`Flush`/`Sync`/`SetBackend` on the cache before calling this again. There is an `Assume(m_inputs.empty());`. I'm not sure if we want to call `Reset` here, since it is an error if we call this before `Reset` and we should crash.",
      "created_at": "2025-12-28T19:22:25Z",
      "updated_at": "2025-12-28T19:22:25Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649881953",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649881953"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 207,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649887568",
      "pull_request_review_id": 3614805232,
      "id": 2649887568,
      "node_id": "PRRC_kwDOABII586d8hNQ",
      "diff_hunk": "@@ -3113,7 +3114,7 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n-        CCoinsViewCache view(&CoinsTip());\n+        auto& view{*m_coins_views->m_connect_block_view};",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": 2645502461,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Hmm doing `SetBestBlock(base->GetBestBlock());` seems like a behavior change which I don't want to do here. `Reset` is basically returning the state of `CCoinsViewCache` to a fresh copy, so it is identical behavior-wise to what we had before.\r\n\r\nIf we don't call `SetBestBlock`, then I don't see a benefit to including a `Start` method.",
      "created_at": "2025-12-28T19:34:57Z",
      "updated_at": "2025-12-28T19:34:57Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649887568",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649887568"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649888876",
      "pull_request_review_id": 3614806140,
      "id": 2649888876,
      "node_id": "PRRC_kwDOABII586d8hhs",
      "diff_hunk": "@@ -3113,7 +3114,7 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n-        CCoinsViewCache view(&CoinsTip());\n+        auto& view{*m_coins_views->m_connect_block_view};",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": 2645502461,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> seems like a behavior change which I don't want to do here\r\n\r\nDon't we have a race condition otherwise because of the lazy init + setter?",
      "created_at": "2025-12-28T19:37:34Z",
      "updated_at": "2025-12-28T19:37:34Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649888876",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649888876"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649890766",
      "pull_request_review_id": 3614809380,
      "id": 2649890766,
      "node_id": "PRRC_kwDOABII586d8h_O",
      "diff_hunk": "@@ -3113,7 +3114,7 @@ bool Chainstate::ConnectTip(\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\n              Ticks<MillisecondsDouble>(time_2 - time_1));\n     {\n-        CCoinsViewCache view(&CoinsTip());\n+        auto& view{*m_coins_views->m_connect_block_view};",
      "path": "src/validation.cpp",
      "position": 1,
      "original_position": 13,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": 2645502461,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> a race condition\r\n\r\nI don't think so? Only the base's `cacheCoins` is accessed via multiple threads, not `hashBlock`. So it is safe to mutate `hashBlock` on the main thread.\r\n",
      "created_at": "2025-12-28T19:41:15Z",
      "updated_at": "2025-12-28T19:41:16Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649890766",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649890766"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 3102,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649916522",
      "pull_request_review_id": 3614827292,
      "id": 2649916522,
      "node_id": "PRRC_kwDOABII586d8oRq",
      "diff_hunk": "@@ -1121,4 +1121,28 @@ BOOST_AUTO_TEST_CASE(ccoins_emplace_duplicate_keeps_usage_balanced)\n     BOOST_CHECK(cache.AccessCoin(outpoint) == coin1);\n }\n \n+BOOST_AUTO_TEST_CASE(ccoins_reset)",
      "path": "src/test/coins_tests.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": 2648968759,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Added in #34164.",
      "created_at": "2025-12-28T20:39:22Z",
      "updated_at": "2025-12-28T20:39:23Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2649916522",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2649916522"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 1123,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651640285",
      "pull_request_review_id": 3616607098,
      "id": 2651640285,
      "node_id": "PRRC_kwDOABII586eDNHd",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        Assume(m_inputs.empty());\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 183,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649050487,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Is this simpler? `GetUint64` calls `ReadLE64` internally. This would require another import for `ReadLE64` as well. We're just skipping the conversion to uint256.",
      "created_at": "2025-12-29T19:39:05Z",
      "updated_at": "2025-12-29T19:39:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2651640285",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651640285"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651645986",
      "pull_request_review_id": 3616612750,
      "id": 2651645986,
      "node_id": "PRRC_kwDOABII586eDOgi",
      "diff_hunk": "@@ -275,6 +277,13 @@ bool CCoinsViewCache::Sync()\n     return fOk;\n }\n \n+void CCoinsViewCache::Reset() noexcept\n+{\n+    cacheCoins.clear();\n+    cachedCoinsUsage = 0;\n+    hashBlock.SetNull();",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 24,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": 2645570612,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "> the lazy getter which is in a race with the setter\r\n\r\nCan you describe this race? The current behavior creates a `CCoinsViewCache` with null `hashBlock` and passes it to `ConnectBlock`. This behavior now resets the `CoinsViewCacheAsync` `hashBlock` to null and passes it to `ConnectBlock`. We don't modify any behavior inside `ConnectBlock`. `hashBlock` is not accessed in multi threaded code.",
      "created_at": "2025-12-29T19:42:58Z",
      "updated_at": "2025-12-29T19:42:58Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2651645986",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651645986"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 296,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651756035",
      "pull_request_review_id": 3616730211,
      "id": 2651756035,
      "node_id": "PRRC_kwDOABII586eDpYD",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        Assume(m_inputs.empty());\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 183,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649050487,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "yes, it's simpler, we're skipping a call and a conversion and it's shorter - fewer moving parts. If you don't like it, resolve this comment.",
      "created_at": "2025-12-29T20:51:37Z",
      "updated_at": "2025-12-29T20:51:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2651756035",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2651756035"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2658978831",
      "pull_request_review_id": 3624371376,
      "id": 2658978831,
      "node_id": "PRRC_kwDOABII586efMwP",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept\n+    {\n+        Assume(m_inputs.empty());\n+        // Loop through the inputs of the block and set them in the queue. Also construct the set of txids to filter.\n+        for (const auto& tx : block.vtx | std::views::drop(1)) [[likely]] {\n+            for (const auto& input : tx->vin) [[likely]] m_inputs.emplace_back(input.prevout);\n+            m_txids.emplace_back(tx->GetHash().ToUint256().GetUint64(0));",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 183,
      "commit_id": "0827d5d363d68f38feff89124347e9914de83cfa",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649050487,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "You're right. Taken, thanks!",
      "created_at": "2026-01-03T15:30:45Z",
      "updated_at": "2026-01-03T15:30:45Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2658978831",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2658978831"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 183,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2659146955",
      "pull_request_review_id": 3624559501,
      "id": 2659146955,
      "node_id": "PRRC_kwDOABII586ef1zL",
      "diff_hunk": "@@ -253,11 +253,13 @@ bool CCoinsViewCache::Flush(bool will_reuse_cache) {\n     auto cursor{CoinsViewCacheCursor(m_sentinel, cacheCoins, /*will_erase=*/true)};\n     bool fOk = base->BatchWrite(cursor, hashBlock);\n     if (fOk) {\n-        cacheCoins.clear();\n         if (will_reuse_cache) {",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 5,
      "commit_id": "c465be604b11a96bbe0a78711e206a6e0c262c7f",
      "original_commit_id": "14f1b7913861d95e3ffeda658d45b0b88e7019e7",
      "in_reply_to_id": 2647996696,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Done in https://github.com/bitcoin/bitcoin/pull/34164.",
      "created_at": "2026-01-03T20:57:20Z",
      "updated_at": "2026-01-03T20:57:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2659146955",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2659146955"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 271,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2659147557",
      "pull_request_review_id": 3624559872,
      "id": 2659147557,
      "node_id": "PRRC_kwDOABII586ef18l",
      "diff_hunk": "@@ -275,6 +275,13 @@ bool CCoinsViewCache::Sync()\n     return fOk;\n }\n \n+void CCoinsViewCache::Reset() noexcept",
      "path": "src/coins.cpp",
      "position": 1,
      "original_position": 4,
      "commit_id": "fc72fca292d995de07d98f12dfc4164478826b1f",
      "original_commit_id": "738c40a56604a2daf26675760cb68ab584a27008",
      "in_reply_to_id": 2649001547,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think we need to add a `Start()` method to the cache. I'd rather not touch the `hashBlock` behavior in this PR. It can be cleaned up in a parallel PR. No multi threaded code touches it here.",
      "created_at": "2026-01-03T20:58:46Z",
      "updated_at": "2026-01-03T20:58:46Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2659147557",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2659147557"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": 290,
      "original_line": 290,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680148973",
      "pull_request_review_id": 3648380425,
      "id": 2680148973,
      "node_id": "PRRC_kwDOABII586fv9Pt",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have mixed feelings about these new RAII unused variables.\r\nWe already have structures like these where e.g. the locks are only applied in a given scope - if we think this automatic cleanup is better, can we do something like that instead?\r\n\r\n<details>\r\n<summary>WITH_BLOCK_INPUTS_FETCHING prototype</summary>\r\n\r\n```patch\r\ndiff --git a/src/bench/coinsviewcacheasync.cpp b/src/bench/coinsviewcacheasync.cpp\r\nindex aa6c9c4cd7..8b7dcc5505 100644\r\n--- a/src/bench/coinsviewcacheasync.cpp\r\n+++ b/src/bench/coinsviewcacheasync.cpp\r\n@@ -38,7 +38,7 @@ static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\r\n     CoinsViewCacheAsync async_cache{&coins_tip};\r\n \r\n     bench.run([&] {\r\n-        const auto fetch_control{async_cache.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(async_cache, block);\r\n         for (const auto& tx : block.vtx | std::views::drop(1)) {\r\n             for (const auto& in : tx->vin) {\r\n                 const auto have{async_cache.HaveCoin(in.prevout)};\r\ndiff --git a/src/coinsviewcacheasync.h b/src/coinsviewcacheasync.h\r\nindex 779bb05633..db471bff40 100644\r\n--- a/src/coinsviewcacheasync.h\r\n+++ b/src/coinsviewcacheasync.h\r\n@@ -12,6 +12,7 @@\r\n #include <primitives/transaction.h>\r\n #include <tinyformat.h>\r\n #include <util/check.h>\r\n+#include <util/macros.h>\r\n #include <util/threadnames.h>\r\n \r\n #include <algorithm>\r\n@@ -298,4 +299,8 @@ public:\r\n     }\r\n };\r\n \r\n+//! Helper macro to start background fetching of all inputs in a block for the current scope.\r\n+#define WITH_BLOCK_INPUTS_FETCHING(view, block) \\\r\n+    [[maybe_unused]] const auto UNIQUE_NAME(fetch_control_) = (view).StartFetching(block)\r\n+\r\n #endif // BITCOIN_COINSVIEWCACHEASYNC_H\r\ndiff --git a/src/test/coinsviewcacheasync_tests.cpp b/src/test/coinsviewcacheasync_tests.cpp\r\nindex 8e0020de9c..06b0dd3fc6 100644\r\n--- a/src/test/coinsviewcacheasync_tests.cpp\r\n+++ b/src/test/coinsviewcacheasync_tests.cpp\r\n@@ -109,7 +109,7 @@ BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\r\n     CCoinsViewCache main_cache{&db};\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         CheckCache(block, view);\r\n         // Check that no coins have been moved up to main cache from db\r\n         for (const auto& tx : block.vtx) {\r\n@@ -129,7 +129,7 @@ BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\r\n     PopulateView(block, main_cache);\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         CheckCache(block, view);\r\n         view.Reset();\r\n     }\r\n@@ -147,7 +147,7 @@ BOOST_AUTO_TEST_CASE(fetch_no_double_spend)\r\n     PopulateView(block, main_cache, /*spent=*/true);\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         for (const auto& tx : block.vtx) {\r\n             for (const auto& in : tx->vin) {\r\n                 const auto& c{view.AccessCoin(in.prevout)};\r\n@@ -167,7 +167,7 @@ BOOST_AUTO_TEST_CASE(fetch_no_inputs)\r\n     CCoinsViewCache main_cache{&db};\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         for (const auto& tx : block.vtx) {\r\n             for (const auto& in : tx->vin) {\r\n                 const auto& c{view.AccessCoin(in.prevout)};\r\n@@ -191,7 +191,7 @@ BOOST_AUTO_TEST_CASE(access_non_input_coin)\r\n     main_cache.EmplaceCoinInternalDANGER(COutPoint{Txid::FromUint256(uint256::ZERO), 0}, std::move(coin));\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         const auto& accessed_coin{view.AccessCoin(outpoint)};\r\n         BOOST_CHECK(!accessed_coin.IsSpent());\r\n         view.Reset();\r\n@@ -207,7 +207,7 @@ BOOST_AUTO_TEST_CASE(fetch_main_thread)\r\n     PopulateView(block, main_cache);\r\n     CoinsViewCacheAsync view{&main_cache, /*deterministic=*/false, /*num_workers=*/0};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, block);\r\n         CheckCache(block, view);\r\n         view.Reset();\r\n     }\r\ndiff --git a/src/test/fuzz/coins_view.cpp b/src/test/fuzz/coins_view.cpp\r\nindex 3f03ec90f0..aaffe98b88 100644\r\n--- a/src/test/fuzz/coins_view.cpp\r\n+++ b/src/test/fuzz/coins_view.cpp\r\n@@ -384,7 +384,7 @@ FUZZ_TARGET(coins_view_async, .init = initialize_coins_view)\r\n     CCoinsView backend_coins_view;\r\n     g_async_cache->SetBackend(backend_coins_view);\r\n     CBlock block{BuildRandomBlock(fuzzed_data_provider)};\r\n-    const auto fetch_control{g_async_cache->StartFetching(block)};\r\n+    WITH_BLOCK_INPUTS_FETCHING(*g_async_cache, block);\r\n     TestCoinsView(fuzzed_data_provider, *g_async_cache, backend_coins_view, /*is_db=*/false);\r\n     g_async_cache->Reset();\r\n }\r\n@@ -402,7 +402,7 @@ FUZZ_TARGET(coins_view_stacked, .init = initialize_coins_view)\r\n     g_async_cache->SetBackend(backend_coins_view);\r\n     TestCoinsView(fuzzed_data_provider, backend_coins_view, db_coins_view, /*is_db=*/true);\r\n     CBlock block{BuildRandomBlock(fuzzed_data_provider)};\r\n-    const auto fetch_control{g_async_cache->StartFetching(block)};\r\n+    WITH_BLOCK_INPUTS_FETCHING(*g_async_cache, block);\r\n     TestCoinsView(fuzzed_data_provider, *g_async_cache, backend_coins_view, /*is_db=*/false);\r\n     TestCoinsView(fuzzed_data_provider, backend_coins_view, db_coins_view, /*is_db=*/true);\r\n     g_async_cache->Reset();\r\ndiff --git a/src/test/fuzz/coinscache_sim.cpp b/src/test/fuzz/coinscache_sim.cpp\r\nindex c635525a24..aa304aab80 100644\r\n--- a/src/test/fuzz/coinscache_sim.cpp\r\n+++ b/src/test/fuzz/coinscache_sim.cpp\r\n@@ -408,7 +408,7 @@ FUZZ_TARGET(coinscache_sim, .init = setup_coinscache_sim)\r\n                         for (auto& async_cache : g_async_caches) {\r\n                             if (async_cache.use_count() > 1) continue;\r\n                             async_cache->SetBackend(*top_cache());\r\n-                            const auto fetch_control{async_cache->StartFetching(data.block)};\r\n+                            WITH_BLOCK_INPUTS_FETCHING(*async_cache, data.block);\r\n                             caches.emplace_back(async_cache);\r\n                             break;\r\n                         }\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f1168729d2..7b304b6f5b 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3100,7 +3100,7 @@ bool Chainstate::ConnectTip(\r\n              Ticks<MillisecondsDouble>(time_2 - time_1));\r\n     {\r\n         auto& view{*m_coins_views->m_connect_block_view};\r\n-        const auto fetch_control{view.StartFetching(*block_to_connect)};\r\n+        WITH_BLOCK_INPUTS_FETCHING(view, *block_to_connect);\r\n         bool rv = ConnectBlock(*block_to_connect, state, pindexNew, view);\r\n         if (m_chainman.m_options.signals) {\r\n             m_chainman.m_options.signals->BlockChecked(block_to_connect, state);\r\n```\r\n\r\n</details>\r\n\r\n----\r\n\r\nAlternatively (I like this one a lot more), what if we covered the existing view itself (making `FetchControl` a proxy for the view accessed through the `->` and `*` operators neatly) to make it obvious why we need it in the scope but not outside it.\r\nThis would indicate that there's a state we don't want to touch, but that there's a start/stop layer that is still needed. This would enable calling `Reset` automatically (which would already call `StopFetching`).\r\n\r\n<details>\r\n<summary>FetchControl proxy prototype</summary>\r\n\r\n```patch\r\ndiff --git a/src/bench/coinsviewcacheasync.cpp b/src/bench/coinsviewcacheasync.cpp\r\nindex aa6c9c4cd7..9b66a0e953 100644\r\n--- a/src/bench/coinsviewcacheasync.cpp\r\n+++ b/src/bench/coinsviewcacheasync.cpp\r\n@@ -38,14 +38,13 @@ static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\r\n     CoinsViewCacheAsync async_cache{&coins_tip};\r\n \r\n     bench.run([&] {\r\n-        const auto fetch_control{async_cache.StartFetching(block)};\r\n+        auto view{async_cache.StartFetching(block)};\r\n         for (const auto& tx : block.vtx | std::views::drop(1)) {\r\n             for (const auto& in : tx->vin) {\r\n-                const auto have{async_cache.HaveCoin(in.prevout)};\r\n+                const auto have{view->HaveCoin(in.prevout)};\r\n                 assert(have);\r\n             }\r\n         }\r\n-        async_cache.Reset();\r\n     });\r\n }\r\n \r\ndiff --git a/src/coinsviewcacheasync.h b/src/coinsviewcacheasync.h\r\nindex 779bb05633..dc3f51255b 100644\r\n--- a/src/coinsviewcacheasync.h\r\n+++ b/src/coinsviewcacheasync.h\r\n@@ -96,9 +96,11 @@ class CoinsViewCacheAsync : public CCoinsViewCache\r\n {\r\n public:\r\n     /**\r\n-     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\r\n+     * RAII-style controller that guarantees fetching is stopped and the view is reset when it goes out of scope.\r\n      * Returned by StartFetching() and bound to the lifetime of the block.\r\n      * Non-copyable and non-movable to prevent scope escape.\r\n+     *\r\n+     * Provides access to the view through operator-> and operator*.\r\n      */\r\n     class FetchControl\r\n     {\r\n@@ -113,10 +115,13 @@ public:\r\n         FetchControl(FetchControl&&) = delete;\r\n         FetchControl& operator=(FetchControl&&) = delete;\r\n \r\n-        ~FetchControl()\r\n-        {\r\n-            m_cache.StopFetching();\r\n-        }\r\n+        CoinsViewCacheAsync& operator*() noexcept { return m_cache; }\r\n+        const CoinsViewCacheAsync& operator*() const noexcept { return m_cache; }\r\n+\r\n+        CoinsViewCacheAsync* operator->() noexcept { return &m_cache; }\r\n+        const CoinsViewCacheAsync* operator->() const noexcept { return &m_cache; }\r\n+\r\n+        ~FetchControl() { m_cache.Reset(); }\r\n     };\r\n \r\n private:\r\n@@ -228,7 +233,7 @@ private:\r\n     }\r\n \r\n public:\r\n-    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\r\n+    //! Start fetching all block inputs and return RAII guard that resets the view on destruction.\r\n     [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\r\n     {\r\n         StopFetching();\r\ndiff --git a/src/test/coinsviewcacheasync_tests.cpp b/src/test/coinsviewcacheasync_tests.cpp\r\nindex 8e0020de9c..39232112b7 100644\r\n--- a/src/test/coinsviewcacheasync_tests.cpp\r\n+++ b/src/test/coinsviewcacheasync_tests.cpp\r\n@@ -109,15 +109,14 @@ BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\r\n     CCoinsViewCache main_cache{&db};\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n-        CheckCache(block, view);\r\n+        auto async_view{view.StartFetching(block)};\r\n+        CheckCache(block, *async_view);\r\n         // Check that no coins have been moved up to main cache from db\r\n         for (const auto& tx : block.vtx) {\r\n             for (const auto& in : tx->vin) {\r\n                 BOOST_CHECK(!main_cache.HaveCoinInCache(in.prevout));\r\n             }\r\n         }\r\n-        view.Reset();\r\n     }\r\n }\r\n \r\n@@ -129,9 +128,8 @@ BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\r\n     PopulateView(block, main_cache);\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n-        CheckCache(block, view);\r\n-        view.Reset();\r\n+        auto async_view{view.StartFetching(block)};\r\n+        CheckCache(block, *async_view);\r\n     }\r\n }\r\n \r\n@@ -147,16 +145,15 @@ BOOST_AUTO_TEST_CASE(fetch_no_double_spend)\r\n     PopulateView(block, main_cache, /*spent=*/true);\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        auto async_view{view.StartFetching(block)};\r\n         for (const auto& tx : block.vtx) {\r\n             for (const auto& in : tx->vin) {\r\n-                const auto& c{view.AccessCoin(in.prevout)};\r\n+                const auto& c{async_view->AccessCoin(in.prevout)};\r\n                 BOOST_CHECK(c.IsSpent());\r\n             }\r\n         }\r\n         // Coins are not added to the view, even though they exist unspent in the parent db\r\n-        BOOST_CHECK_EQUAL(view.GetCacheSize(), 0);\r\n-        view.Reset();\r\n+        BOOST_CHECK_EQUAL(async_view->GetCacheSize(), 0);\r\n     }\r\n }\r\n \r\n@@ -167,15 +164,14 @@ BOOST_AUTO_TEST_CASE(fetch_no_inputs)\r\n     CCoinsViewCache main_cache{&db};\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n+        auto async_view{view.StartFetching(block)};\r\n         for (const auto& tx : block.vtx) {\r\n             for (const auto& in : tx->vin) {\r\n-                const auto& c{view.AccessCoin(in.prevout)};\r\n+                const auto& c{async_view->AccessCoin(in.prevout)};\r\n                 BOOST_CHECK(c.IsSpent());\r\n             }\r\n         }\r\n-        BOOST_CHECK_EQUAL(view.GetCacheSize(), 0);\r\n-        view.Reset();\r\n+        BOOST_CHECK_EQUAL(async_view->GetCacheSize(), 0);\r\n     }\r\n }\r\n \r\n@@ -191,10 +187,9 @@ BOOST_AUTO_TEST_CASE(access_non_input_coin)\r\n     main_cache.EmplaceCoinInternalDANGER(COutPoint{Txid::FromUint256(uint256::ZERO), 0}, std::move(coin));\r\n     CoinsViewCacheAsync view{&main_cache};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n-        const auto& accessed_coin{view.AccessCoin(outpoint)};\r\n+        auto async_view{view.StartFetching(block)};\r\n+        const auto& accessed_coin{async_view->AccessCoin(outpoint)};\r\n         BOOST_CHECK(!accessed_coin.IsSpent());\r\n-        view.Reset();\r\n     }\r\n }\r\n \r\n@@ -207,9 +202,8 @@ BOOST_AUTO_TEST_CASE(fetch_main_thread)\r\n     PopulateView(block, main_cache);\r\n     CoinsViewCacheAsync view{&main_cache, /*deterministic=*/false, /*num_workers=*/0};\r\n     for (auto i{0}; i < 3; ++i) {\r\n-        const auto fetch_control{view.StartFetching(block)};\r\n-        CheckCache(block, view);\r\n-        view.Reset();\r\n+        auto async_view{view.StartFetching(block)};\r\n+        CheckCache(block, *async_view);\r\n     }\r\n }\r\n \r\ndiff --git a/src/test/fuzz/coins_view.cpp b/src/test/fuzz/coins_view.cpp\r\nindex 3f03ec90f0..f3df7b19a9 100644\r\n--- a/src/test/fuzz/coins_view.cpp\r\n+++ b/src/test/fuzz/coins_view.cpp\r\n@@ -384,9 +384,8 @@ FUZZ_TARGET(coins_view_async, .init = initialize_coins_view)\r\n     CCoinsView backend_coins_view;\r\n     g_async_cache->SetBackend(backend_coins_view);\r\n     CBlock block{BuildRandomBlock(fuzzed_data_provider)};\r\n-    const auto fetch_control{g_async_cache->StartFetching(block)};\r\n-    TestCoinsView(fuzzed_data_provider, *g_async_cache, backend_coins_view, /*is_db=*/false);\r\n-    g_async_cache->Reset();\r\n+    auto async_view{g_async_cache->StartFetching(block)};\r\n+    TestCoinsView(fuzzed_data_provider, *async_view, backend_coins_view, /*is_db=*/false);\r\n }\r\n \r\n FUZZ_TARGET(coins_view_stacked, .init = initialize_coins_view)\r\n@@ -402,8 +401,7 @@ FUZZ_TARGET(coins_view_stacked, .init = initialize_coins_view)\r\n     g_async_cache->SetBackend(backend_coins_view);\r\n     TestCoinsView(fuzzed_data_provider, backend_coins_view, db_coins_view, /*is_db=*/true);\r\n     CBlock block{BuildRandomBlock(fuzzed_data_provider)};\r\n-    const auto fetch_control{g_async_cache->StartFetching(block)};\r\n-    TestCoinsView(fuzzed_data_provider, *g_async_cache, backend_coins_view, /*is_db=*/false);\r\n+    auto async_view{g_async_cache->StartFetching(block)};\r\n+    TestCoinsView(fuzzed_data_provider, *async_view, backend_coins_view, /*is_db=*/false);\r\n     TestCoinsView(fuzzed_data_provider, backend_coins_view, db_coins_view, /*is_db=*/true);\r\n-    g_async_cache->Reset();\r\n }\r\ndiff --git a/src/test/fuzz/coinscache_sim.cpp b/src/test/fuzz/coinscache_sim.cpp\r\nindex c635525a24..4090697b8e 100644\r\n--- a/src/test/fuzz/coinscache_sim.cpp\r\n+++ b/src/test/fuzz/coinscache_sim.cpp\r\n@@ -407,8 +407,8 @@ FUZZ_TARGET(coinscache_sim, .init = setup_coinscache_sim)\r\n                         // Find an unused async cache from the pool\r\n                         for (auto& async_cache : g_async_caches) {\r\n                             if (async_cache.use_count() > 1) continue;\r\n+                            async_cache->Reset();\r\n                             async_cache->SetBackend(*top_cache());\r\n-                            const auto fetch_control{async_cache->StartFetching(data.block)};\r\n                             caches.emplace_back(async_cache);\r\n                             break;\r\n                         }\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f1168729d2..57108d05ed 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3099,9 +3099,8 @@ bool Chainstate::ConnectTip(\r\n     LogDebug(BCLog::BENCH, \"  - Load block from disk: %.2fms\\n\",\r\n              Ticks<MillisecondsDouble>(time_2 - time_1));\r\n     {\r\n-        auto& view{*m_coins_views->m_connect_block_view};\r\n-        const auto fetch_control{view.StartFetching(*block_to_connect)};\r\n-        bool rv = ConnectBlock(*block_to_connect, state, pindexNew, view);\r\n+        auto view{m_coins_views->m_connect_block_view->StartFetching(*block_to_connect)};\r\n+        bool rv = ConnectBlock(*block_to_connect, state, pindexNew, *view);\r\n         if (m_chainman.m_options.signals) {\r\n             m_chainman.m_options.signals->BlockChecked(block_to_connect, state);\r\n         }\r\n@@ -3109,7 +3108,6 @@ bool Chainstate::ConnectTip(\r\n             if (state.IsInvalid())\r\n                 InvalidBlockFound(pindexNew, state);\r\n             LogError(\"%s: ConnectBlock %s failed, %s\\n\", __func__, pindexNew->GetBlockHash().ToString(), state.ToString());\r\n-            view.Reset();\r\n             return false;\r\n         }\r\n         time_3 = SteadyClock::now();\r\n@@ -3119,8 +3117,7 @@ bool Chainstate::ConnectTip(\r\n                  Ticks<MillisecondsDouble>(time_3 - time_2),\r\n                  Ticks<SecondsDouble>(m_chainman.time_connect_total),\r\n                  Ticks<MillisecondsDouble>(m_chainman.time_connect_total) / m_chainman.num_blocks_total);\r\n-        view.Flush(/*will_reuse_cache=*/false); // No need to reallocate since it only has capacity for 1 block\r\n-        view.Reset();\r\n+        view->Flush(/*will_reuse_cache=*/false); // No need to reallocate since it only has capacity for 1 block\r\n     }\r\n     const auto time_4{SteadyClock::now()};\r\n     m_chainman.time_flush += time_4 - time_3;\r\n```\r\n\r\n</details>",
      "created_at": "2026-01-11T19:41:24Z",
      "updated_at": "2026-01-11T20:26:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680148973",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680148973"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680152913",
      "pull_request_review_id": 3648384398,
      "id": 2680152913,
      "node_id": "PRRC_kwDOABII586fv-NR",
      "diff_hunk": "@@ -484,7 +492,7 @@ class CCoinsViewCache : public CCoinsViewBacked\n      * @note this is marked const, but may actually append to `cacheCoins`, increasing\n      * memory usage.\n      */\n-    CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;\n+    virtual CCoinsMap::iterator FetchCoin(const COutPoint &outpoint) const;",
      "path": "src/coins.h",
      "position": 1,
      "original_position": 20,
      "commit_id": "b3cb5bb90a41af4199dde17946e5aa9b3cd72db6",
      "original_commit_id": "ab1614473bee4abb558ff8b8fdf941fcaff122a6",
      "in_reply_to_id": 2637823046,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Got rid of this via https://github.com/bitcoin/bitcoin/pull/34165.",
      "created_at": "2026-01-11T19:43:43Z",
      "updated_at": "2026-01-11T19:43:43Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680152913",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680152913"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 495,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680162404",
      "pull_request_review_id": 3648395518,
      "id": 2680162404,
      "node_id": "PRRC_kwDOABII586fwAhk",
      "diff_hunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+static CBlock CreateBlock() noexcept\n+{\n+    static constexpr auto NUM_TXS{100};\n+    CBlock block;\n+    CMutableTransaction coinbase;\n+    coinbase.vin.emplace_back();\n+    block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+    Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+    for (const auto i : std::views::iota(1, NUM_TXS)) {\n+        CMutableTransaction tx;\n+        Txid txid;\n+        if (i % 3 == 0) {\n+            // External input\n+            txid = Txid::FromUint256(uint256(i));\n+        } else if (i % 3 == 1) {\n+            // Internal spend (prev tx)\n+            txid = prevhash;\n+        } else {\n+            // Test shortxid collisions (looks internal, but is external)\n+            uint256 u{};\n+            std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+            txid = Txid::FromUint256(u);\n+        }\n+        tx.vin.emplace_back(txid, 0);\n+        prevhash = tx.GetHash();\n+        block.vtx.push_back(MakeTransactionRef(tx));\n+    }\n+\n+    return block;\n+}\n+\n+void PopulateView(const CBlock& block, CCoinsView& view, bool spent = false)\n+{\n+    CCoinsViewCache cache{&view};\n+    cache.SetBestBlock(uint256::ONE);\n+\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            if (!txids.contains(in.prevout.hash)) {\n+                Coin coin{};\n+                if (!spent) coin.out.nValue = 1;\n+                cache.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+            }\n+        }\n+        txids.emplace(tx->GetHash());\n+    }\n+\n+    cache.Flush();\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto& first{cache.AccessCoin(outpoint)};\n+                const auto& second{cache.AccessCoin(outpoint)};\n+                BOOST_CHECK_EQUAL(&first, &second);\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) ++counter;\n+                const auto have{cache.HaveCoinInCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK_EQUAL(cache.GetCacheSize(), counter);\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    PopulateView(block, db);\n+    CCoinsViewCache main_cache{&db};\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        // Check that no coins have been moved up to main cache from db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!main_cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    CCoinsViewCache main_cache{&db};\n+    PopulateView(block, main_cache);\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649047357,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I have updated to call `StopFetching` in `StartFetching`. This way you can fetch two blocks without resetting the cache (useful for `VerifyDB`). I've also added a RAII control object that gets returned from `StartFetching`, and will call `StopFetching` when we go out of scope. This is much safer than having to remember to call one of the methods to stop. It also separates the concerns of `Reset` to the base `CCoinsViewCache` only.\r\n\r\nThis is bound to the lifetime of the block as well, so we have static analysis that will ensure we don't keep fetching after the block is destroyed (causing UB).",
      "created_at": "2026-01-11T19:50:13Z",
      "updated_at": "2026-01-11T19:50:14Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680162404",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680162404"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680162527",
      "pull_request_review_id": 3648395654,
      "id": 2680162527,
      "node_id": "PRRC_kwDOABII586fwAjf",
      "diff_hunk": "@@ -0,0 +1,242 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate cacheCoins or base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * The cache spawns a fixed set of worker threads that fetch Coins for each input in a block.\n+ * When FetchCoin() is called, the main thread waits for the corresponding coin to be fetched and returns it.\n+ * While waiting, the main thread will also fetch coins to maximize parallelism.\n+ *\n+ * Worker threads are synchronized with the main thread using a barrier, which is used at the beginning of fetching to\n+ * start the workers and at the end to ensure all workers have finished before the next block is started.\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, input.outpoint.hash.ToUint256().GetUint64(0))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{FetchCoinWithoutMutating(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    //! Get the index in m_inputs for the given outpoint. Advances m_input_tail if found.\n+    std::optional<uint32_t> GetInputIndex(const COutPoint& outpoint) const noexcept\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input. We advance the tail since the input will be cached and not accessed through\n+        // this method again.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            if (m_inputs[i].outpoint == outpoint) {\n+                m_input_tail = i + 1;\n+                return i;\n+            }\n+        }\n+        return std::nullopt;\n+    }\n+\n+    CCoinsMap::iterator FetchCoin(const COutPoint& outpoint) const override\n+    {\n+        auto [ret, inserted]{cacheCoins.try_emplace(outpoint)};\n+        if (!inserted) return ret;\n+\n+        if (const auto i{GetInputIndex(outpoint)}) [[likely]] {\n+            auto& input{m_inputs[*i]};\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            if (input.coin) [[likely]] ret->second.coin = std::move(*input.coin);\n+        }\n+\n+        if (ret->second.coin.IsSpent()) [[unlikely]] {\n+            // We will only get in here for BIP30 checks, shorttxid collisions, or a block with missing or spent inputs.\n+            // TODO: Remove spent checks once we no longer return spent coins in coinscache_sim CoinsViewBottom.\n+            if (auto coin{FetchCoinWithoutMutating(outpoint)}; coin && !coin->IsSpent()) {\n+                ret->second.coin = std::move(*coin);\n+            } else {\n+                cacheCoins.erase(ret);\n+                return cacheCoins.end();\n+            }\n+        }\n+\n+        cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n+        return ret;\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Fetch all block inputs.\n+    void StartFetching(const CBlock& block) noexcept",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 177,
      "commit_id": "35e8b6fb0680d320d2060fdae27aae9f05a3c422",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649046808,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "See https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680162404.",
      "created_at": "2026-01-11T19:50:20Z",
      "updated_at": "2026-01-11T19:50:20Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680162527",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680162527"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 207,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680174595",
      "pull_request_review_id": 3648380425,
      "id": 2680174595,
      "node_id": "PRRC_kwDOABII586fwDgD",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Now that this is automatic, we could rather assert that it's stopped, since that would be a programming error, right?",
      "created_at": "2026-01-11T19:57:42Z",
      "updated_at": "2026-01-11T20:26:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680174595",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680174595"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680176040",
      "pull_request_review_id": 3648380425,
      "id": 2680176040,
      "node_id": "PRRC_kwDOABII586fwD2o",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 86,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Lol, cool ascii art - though it's off by one space :p\r\n```suggestion\r\n *                                       Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\r\n *                                          â”‚                   â”‚         â”‚         â”‚         â”‚\r\n *                                          â–¼                   â–¼         â–¼         â–¼         â–¼\r\n```",
      "created_at": "2026-01-11T19:58:40Z",
      "updated_at": "2026-01-11T20:26:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680176040",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680176040"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": 84,
      "start_side": "RIGHT",
      "line": null,
      "original_line": 86,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680207877",
      "pull_request_review_id": 3648380425,
      "id": 2680207877,
      "node_id": "PRRC_kwDOABII586fwLoF",
      "diff_hunk": "@@ -369,44 +397,61 @@ FUZZ_TARGET(coinscache_sim)\n             [&]() { // Uncache\n                 uint32_t outpointidx = provider.ConsumeIntegralInRange<uint32_t>(0, NUM_OUTPOINTS - 1);\n                 // Apply to real caches (there is no equivalent in our simulation).\n-                caches.back()->Uncache(data.outpoints[outpointidx]);\n+                top_cache()->Uncache(data.outpoints[outpointidx]);\n             },\n \n             [&]() { // Add a cache level (if not already at the max).\n                 if (caches.size() != MAX_CACHES) {\n                     // Apply to real caches.\n-                    caches.emplace_back(new CCoinsViewCache(&*caches.back(), /*deterministic=*/true));\n+                    if (provider.ConsumeBool()) {\n+                        // Find an unused async cache from the pool\n+                        for (auto& async_cache : g_async_caches) {\n+                            if (async_cache.use_count() > 1) continue;\n+                            async_cache->SetBackend(*top_cache());\n+                            const auto fetch_control{async_cache->StartFetching(data.block)};",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 1,
      "original_position": 185,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": null,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What is the purpose here of starting a fetch, adding it to a vector and resetting it immediately?",
      "created_at": "2026-01-11T20:19:03Z",
      "updated_at": "2026-01-11T20:26:37Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680207877",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680207877"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 411,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680221158",
      "pull_request_review_id": 3648459474,
      "id": 2680221158,
      "node_id": "PRRC_kwDOABII586fwO3m",
      "diff_hunk": "@@ -0,0 +1,216 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <primitives/transaction_identifier.h>\n+#include <txdb.h>\n+#include <uint256.h>\n+#include <util/byte_units.h>\n+#include <util/hasher.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <cstdint>\n+#include <cstring>\n+#include <ranges>\n+#include <unordered_set>\n+\n+BOOST_AUTO_TEST_SUITE(coinsviewcacheasync_tests)\n+\n+static CBlock CreateBlock() noexcept\n+{\n+    static constexpr auto NUM_TXS{100};\n+    CBlock block;\n+    CMutableTransaction coinbase;\n+    coinbase.vin.emplace_back();\n+    block.vtx.push_back(MakeTransactionRef(coinbase));\n+\n+    Txid prevhash{Txid::FromUint256(uint256{1})};\n+\n+    for (const auto i : std::views::iota(1, NUM_TXS)) {\n+        CMutableTransaction tx;\n+        Txid txid;\n+        if (i % 3 == 0) {\n+            // External input\n+            txid = Txid::FromUint256(uint256(i));\n+        } else if (i % 3 == 1) {\n+            // Internal spend (prev tx)\n+            txid = prevhash;\n+        } else {\n+            // Test shortxid collisions (looks internal, but is external)\n+            uint256 u{};\n+            std::memcpy(u.begin(), prevhash.ToUint256().begin(), 8);\n+            txid = Txid::FromUint256(u);\n+        }\n+        tx.vin.emplace_back(txid, 0);\n+        prevhash = tx.GetHash();\n+        block.vtx.push_back(MakeTransactionRef(tx));\n+    }\n+\n+    return block;\n+}\n+\n+void PopulateView(const CBlock& block, CCoinsView& view, bool spent = false)\n+{\n+    CCoinsViewCache cache{&view};\n+    cache.SetBestBlock(uint256::ONE);\n+\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            if (!txids.contains(in.prevout.hash)) {\n+                Coin coin{};\n+                if (!spent) coin.out.nValue = 1;\n+                cache.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+            }\n+        }\n+        txids.emplace(tx->GetHash());\n+    }\n+\n+    cache.Flush();\n+}\n+\n+void CheckCache(const CBlock& block, const CCoinsViewCache& cache)\n+{\n+    uint32_t counter{0};\n+    std::unordered_set<Txid, SaltedTxidHasher> txids{};\n+    txids.reserve(block.vtx.size() - 1);\n+\n+    for (const auto& tx : block.vtx) {\n+        if (tx->IsCoinBase()) {\n+            BOOST_CHECK(!cache.HaveCoinInCache(tx->vin[0].prevout));\n+        } else {\n+            for (const auto& in : tx->vin) {\n+                const auto& outpoint{in.prevout};\n+                const auto& first{cache.AccessCoin(outpoint)};\n+                const auto& second{cache.AccessCoin(outpoint)};\n+                BOOST_CHECK_EQUAL(&first, &second);\n+                const auto should_have{!txids.contains(outpoint.hash)};\n+                if (should_have) ++counter;\n+                const auto have{cache.HaveCoinInCache(outpoint)};\n+                BOOST_CHECK_EQUAL(should_have, !!have);\n+            }\n+            txids.emplace(tx->GetHash());\n+        }\n+    }\n+    BOOST_CHECK_EQUAL(cache.GetCacheSize(), counter);\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_db)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    PopulateView(block, db);\n+    CCoinsViewCache main_cache{&db};\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        // Check that no coins have been moved up to main cache from db\n+        for (const auto& tx : block.vtx) {\n+            for (const auto& in : tx->vin) {\n+                BOOST_CHECK(!main_cache.HaveCoinInCache(in.prevout));\n+            }\n+        }\n+        view.Reset();\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(fetch_inputs_from_cache)\n+{\n+    const auto block{CreateBlock()};\n+    CCoinsViewDB db{{.path = \"\", .cache_bytes = 1_MiB, .memory_only = true}, {}};\n+    CCoinsViewCache main_cache{&db};\n+    PopulateView(block, main_cache);\n+    CoinsViewCacheAsync view{&main_cache};\n+    for (auto i{0}; i < 3; ++i) {\n+        view.StartFetching(block);\n+        CheckCache(block, view);\n+        view.Reset();",
      "path": "src/test/coinsviewcacheasync_tests.cpp",
      "position": 1,
      "original_position": 134,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "b9ecb3c9babfd65562b137618eb20f6e771b6dca",
      "in_reply_to_id": 2649047357,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "That's definitely better. Added some comment in https://github.com/bitcoin/bitcoin/pull/31132#pullrequestreview-3648380425 and https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680207877 that might make this even more lightweight.",
      "created_at": "2026-01-11T20:27:59Z",
      "updated_at": "2026-01-11T20:28:00Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680221158",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680221158"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 134,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680229267",
      "pull_request_review_id": 3648468792,
      "id": 2680229267,
      "node_id": "PRRC_kwDOABII586fwQ2T",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680174595,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "It's not automatic. Consider:\r\n\r\n```C++\r\nconst auto fetch_control{view.StartFetching(block)};\r\nconst auto fetch_control2{view.StartFetching(block)};\r\n```",
      "created_at": "2026-01-11T20:33:27Z",
      "updated_at": "2026-01-11T20:33:27Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680229267",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680229267"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680233196",
      "pull_request_review_id": 3648473064,
      "id": 2680233196,
      "node_id": "PRRC_kwDOABII586fwRzs",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680174595,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "yes, shouldn't that fail with an assertion error instead of the second spitting in the soup of the first?",
      "created_at": "2026-01-11T20:35:58Z",
      "updated_at": "2026-01-11T20:35:59Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680233196",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680233196"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680234117",
      "pull_request_review_id": 3648474127,
      "id": 2680234117,
      "node_id": "PRRC_kwDOABII586fwSCF",
      "diff_hunk": "@@ -369,44 +397,61 @@ FUZZ_TARGET(coinscache_sim)\n             [&]() { // Uncache\n                 uint32_t outpointidx = provider.ConsumeIntegralInRange<uint32_t>(0, NUM_OUTPOINTS - 1);\n                 // Apply to real caches (there is no equivalent in our simulation).\n-                caches.back()->Uncache(data.outpoints[outpointidx]);\n+                top_cache()->Uncache(data.outpoints[outpointidx]);\n             },\n \n             [&]() { // Add a cache level (if not already at the max).\n                 if (caches.size() != MAX_CACHES) {\n                     // Apply to real caches.\n-                    caches.emplace_back(new CCoinsViewCache(&*caches.back(), /*deterministic=*/true));\n+                    if (provider.ConsumeBool()) {\n+                        // Find an unused async cache from the pool\n+                        for (auto& async_cache : g_async_caches) {\n+                            if (async_cache.use_count() > 1) continue;\n+                            async_cache->SetBackend(*top_cache());\n+                            const auto fetch_control{async_cache->StartFetching(data.block)};",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 1,
      "original_position": 185,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680207877,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Not much, but it exercises the `StartFetching`/`StopFetching` paths. There's not much more we can do here since the fetching is now bound to the scope. Fuzzing the methods while we are still fetching happens in coins_view.cpp fuzz harness.",
      "created_at": "2026-01-11T20:36:32Z",
      "updated_at": "2026-01-11T20:36:32Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680234117",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680234117"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 411,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680248680",
      "pull_request_review_id": 3648492528,
      "id": 2680248680,
      "node_id": "PRRC_kwDOABII586fwVlo",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680148973,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "What is the benefit of the macro? I don't see a problem with using it as suggested, but not sure what it is giving us.\r\n\r\nRe proxy - we don't want to call `Reset` everytime we go out of scope. `Reset` is only if we need to reset the cache to its initial state. Consider `VerifyDB`, where we could use it to fetch 6 blocks in a row but we don't want to clear its state each time.\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex f1168729d2..bcd933fa78 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -4697,7 +4697,7 @@ VerifyDBResult CVerifyDB::VerifyDB(\r\n     }\r\n     nCheckLevel = std::max(0, std::min(4, nCheckLevel));\r\n     LogInfo(\"Verifying last %i blocks at level %i\", nCheckDepth, nCheckLevel);\r\n-    CCoinsViewCache coins(&coinsview);\r\n+    CoinsViewCacheAsync coins(&coinsview);\r\n     CBlockIndex* pindex;\r\n     CBlockIndex* pindexFailure = nullptr;\r\n     int nGoodTransactions = 0;\r\n@@ -4799,6 +4799,7 @@ VerifyDBResult CVerifyDB::VerifyDB(\r\n                 LogError(\"Verification error: ReadBlock failed at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\r\n                 return VerifyDBResult::CORRUPTED_BLOCK_DB;\r\n             }\r\n+            const auto fetch_control{coins.StartFetching(block)};\r\n             if (!chainstate.ConnectBlock(block, state, pindex, coins)) {\r\n                 LogError(\"Verification error: found unconnectable block at %d, hash=%s (%s)\", pindex->nHeight, pindex->GetBlockHash().ToString(), state.ToString());\r\n                 return VerifyDBResult::CORRUPTED_BLOCK_DB;\r\n```\r\n\r\nWhat this gives us is a guarantee that we will stop fetching before exceeding the lifetime of the block.",
      "created_at": "2026-01-11T20:45:48Z",
      "updated_at": "2026-01-11T20:45:48Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680248680",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680248680"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680252206",
      "pull_request_review_id": 3648496685,
      "id": 2680252206,
      "node_id": "PRRC_kwDOABII586fwWcu",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680174595,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "I don't think so, it's a valid use of the API. The first fetching will be stopped and the second started. It's just inefficient, but perfectly safe.",
      "created_at": "2026-01-11T20:48:11Z",
      "updated_at": "2026-01-11T20:48:11Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680252206",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680252206"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680285145",
      "pull_request_review_id": 3648533381,
      "id": 2680285145,
      "node_id": "PRRC_kwDOABII586fwefZ",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680148973,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Wouldn't we declare and start fetching at a higher level so that the 6 blocks are all in the same scope?",
      "created_at": "2026-01-11T21:07:47Z",
      "updated_at": "2026-01-11T21:07:47Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680285145",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680285145"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680286398",
      "pull_request_review_id": 3648534795,
      "id": 2680286398,
      "node_id": "PRRC_kwDOABII586fwey-",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680174595,
      "user": {
        "login": "l0rinc",
        "id": 1841944,
        "node_id": "MDQ6VXNlcjE4NDE5NDQ=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1841944?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/l0rinc",
        "html_url": "https://github.com/l0rinc",
        "followers_url": "https://api.github.com/users/l0rinc/followers",
        "following_url": "https://api.github.com/users/l0rinc/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/l0rinc/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/l0rinc/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/l0rinc/subscriptions",
        "organizations_url": "https://api.github.com/users/l0rinc/orgs",
        "repos_url": "https://api.github.com/users/l0rinc/repos",
        "events_url": "https://api.github.com/users/l0rinc/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/l0rinc/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Can you come up with a valid usecase because it seems like an error to me...",
      "created_at": "2026-01-11T21:08:27Z",
      "updated_at": "2026-01-11T21:08:28Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680286398",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680286398"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680296093",
      "pull_request_review_id": 3648545117,
      "id": 2680296093,
      "node_id": "PRRC_kwDOABII586fwhKd",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680148973,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "We start fetching as soon as we get the block, and the block is destroyed when we exit the scope. I'm not sure what you mean.",
      "created_at": "2026-01-11T21:14:49Z",
      "updated_at": "2026-01-11T21:14:49Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2680296093",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2680296093"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2682805433",
      "pull_request_review_id": 3651405416,
      "id": 2682805433,
      "node_id": "PRRC_kwDOABII586f6Fy5",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680148973,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Looking closer at `VerifyDB`, I don't think this would be useful there. All blocks are disconnected in the same cache without flushing, so all utxos will already be in the cache and no lookups will occur. Maybe it makes sense to just `Reset`, and then we can get rid of those `Reset` calls everywhere... Will look into this, thanks!",
      "created_at": "2026-01-12T15:35:50Z",
      "updated_at": "2026-01-12T15:35:51Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2682805433",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2682805433"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691736879",
      "pull_request_review_id": 3662385720,
      "id": 2691736879,
      "node_id": "PRRC_kwDOABII586gcKUv",
      "diff_hunk": "@@ -0,0 +1,52 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <bench/data/block413567.raw.h>\n+#include <coins.h>\n+#include <coinsviewcacheasync.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <serialize.h>\n+#include <streams.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <txdb.h>\n+#include <validation.h>\n+\n+#include <cassert>\n+#include <ranges>\n+#include <utility>\n+\n+static void CoinsViewCacheAsyncBenchmark(benchmark::Bench& bench)\n+{\n+    CBlock block;\n+    DataStream{benchmark::data::block413567} >> TX_WITH_WITNESS(block);\n+    const auto testing_setup{MakeNoLogFileContext<const TestingSetup>(ChainType::MAIN, { .coins_db_in_memory = false })};\n+    Chainstate& chainstate{testing_setup->m_node.chainman->ActiveChainstate()};\n+    auto& coins_tip{WITH_LOCK(testing_setup->m_node.chainman->GetMutex(), return chainstate.CoinsTip();)};\n+\n+    for (const auto& tx : block.vtx | std::views::drop(1)) {\n+        for (const auto& in : tx->vin) {\n+            Coin coin{};\n+            coin.out.nValue = 1;\n+            coins_tip.EmplaceCoinInternalDANGER(COutPoint{in.prevout}, std::move(coin));\n+        }\n+    }\n+    chainstate.ForceFlushStateToDisk();\n+    CoinsViewCacheAsync async_cache{&coins_tip};\n+\n+    bench.run([&] {\n+        const auto fetch_control{async_cache.StartFetching(block)};",
      "path": "src/bench/coinsviewcacheasync.cpp",
      "position": 1,
      "original_position": 41,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680148973,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Updated to use a controller that returns a handle that dereferences to the cache. When the handle is destroyed it resets the cache.",
      "created_at": "2026-01-14T19:22:30Z",
      "updated_at": "2026-01-14T19:22:30Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2691736879",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691736879"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 41,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691738551",
      "pull_request_review_id": 3662387637,
      "id": 2691738551,
      "node_id": "PRRC_kwDOABII586gcKu3",
      "diff_hunk": "@@ -369,44 +397,61 @@ FUZZ_TARGET(coinscache_sim)\n             [&]() { // Uncache\n                 uint32_t outpointidx = provider.ConsumeIntegralInRange<uint32_t>(0, NUM_OUTPOINTS - 1);\n                 // Apply to real caches (there is no equivalent in our simulation).\n-                caches.back()->Uncache(data.outpoints[outpointidx]);\n+                top_cache()->Uncache(data.outpoints[outpointidx]);\n             },\n \n             [&]() { // Add a cache level (if not already at the max).\n                 if (caches.size() != MAX_CACHES) {\n                     // Apply to real caches.\n-                    caches.emplace_back(new CCoinsViewCache(&*caches.back(), /*deterministic=*/true));\n+                    if (provider.ConsumeBool()) {\n+                        // Find an unused async cache from the pool\n+                        for (auto& async_cache : g_async_caches) {\n+                            if (async_cache.use_count() > 1) continue;\n+                            async_cache->SetBackend(*top_cache());\n+                            const auto fetch_control{async_cache->StartFetching(data.block)};",
      "path": "src/test/fuzz/coinscache_sim.cpp",
      "position": 1,
      "original_position": 185,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680207877,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "The latest version does not return a fetch control object here, so we can continue fetching in the background while exercising different methods.",
      "created_at": "2026-01-14T19:23:05Z",
      "updated_at": "2026-01-14T19:23:05Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2691738551",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691738551"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 411,
      "side": "RIGHT"
    },
    {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691739366",
      "pull_request_review_id": 3662388631,
      "id": 2691739366,
      "node_id": "PRRC_kwDOABII586gcK7m",
      "diff_hunk": "@@ -0,0 +1,301 @@\n+// Copyright (c) The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSVIEWCACHEASYNC_H\n+#define BITCOIN_COINSVIEWCACHEASYNC_H\n+\n+#include <attributes.h>\n+#include <coins.h>\n+#include <crypto/common.h>\n+#include <primitives/block.h>\n+#include <primitives/transaction.h>\n+#include <tinyformat.h>\n+#include <util/check.h>\n+#include <util/threadnames.h>\n+\n+#include <algorithm>\n+#include <atomic>\n+#include <barrier>\n+#include <cstdint>\n+#include <optional>\n+#include <ranges>\n+#include <thread>\n+#include <utility>\n+#include <vector>\n+\n+static constexpr int32_t WORKER_THREADS{4};\n+\n+/**\n+ * CCoinsViewCache subclass that asynchronously fetches all block inputs in parallel during ConnectBlock without\n+ * mutating the base cache.\n+ *\n+ * Only used in ConnectBlock to pass as an ephemeral view that can be reset if the block is invalid.\n+ * It provides the same interface as CCoinsViewCache. It overrides all methods that mutate base,\n+ * stopping threads before calling superclass.\n+ * It adds an additional StartFetching method to provide the block.\n+ *\n+ * When a block is passed to StartFetching, the inputs of the block are flattened into a vector of InputToFetch\n+ * objects. A vector of sorted shorttxids of all block txs is also constructed. The main thread arrives at the\n+ * barrier, which releases all worker threads waiting on the barrier at the top of their loop. The worker threads\n+ * call ProcessInputInBackground() repeatedly until all inputs have been fetched, then wait on the barrier a second\n+ * time at the end of their loop.\n+ *\n+ * ProcessInputInBackground() atomically fetches and increments m_input_head, so each thread can only access a\n+ * single element of the m_inputs vector at a time. Workers race to claim inputs, so they may fetch elements in any\n+ * order. If the fetched index is greater than the size of m_inputs, no more inputs can be fetched and false is\n+ * returned.\n+ *\n+ * The worker claims the InputToFetch at this index. Before fetching, it checks if the input's txid prefix matches\n+ * any shorttxid in the sorted vector using binary search. If there is a match, the input is spending a coin created\n+ * earlier in the same block and won't be in the base cache, so fetching is skipped. Otherwise, the coin is fetched\n+ * from the base cache and moved to the InputToFetch object. The ready flag is then set with a release memory order.\n+ * This allows the ready flag to be used as a memory fence, guaranteeing the coin being written to the object will\n+ * have happened before another thread tests the flag with an acquire memory order.\n+ *\n+ * When a coin is requested from the cache on the main thread, if a cache miss occurs the coin is first looked up\n+ * from the m_inputs vector instead of the base cache. The vector is scanned beginning at the element at\n+ * m_input_tail. If the InputToFetch object has the same outpoint as requested, m_input_tail is advanced to the next\n+ * index so the previous inputs do not need to be scanned again. The InputToFetch object's ready flag is tested with an\n+ * acquire memory order. If the object is ready, then the worker has successfully fetched that input in the\n+ * background and the object's coin is returned. If the object is not ready, the main thread\n+ * will call ProcessInputInBackground() repeatedly until the requested coin is ready. This lets the main thread make\n+ * progress by claiming other inputs while waiting on the worker that claimed the input that was requested.\n+ *\n+ * When Flush or Reset is called after the block is validated, the main thread arrives at the barrier again to\n+ * release all workers from the barrier at the bottom of their loop. The workers return to wait on the barrier at\n+ * the top of their loop until the next block is passed to StartFetching.\n+ *\n+ *       Workers advance m_input_head to fetch inputs. Main thread advances m_input_tail to consume.\n+ *\n+ *       Before workers start:\n+ *\n+ *                 m_input_head\n+ *                 m_input_tail\n+ *                      â”‚\n+ *                      â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *\n+ *       After workers start:\n+ *\n+ *                                        Worker 2            Worker 0  Worker 3  Worker 1  m_input_head\n+ *                                           â”‚                   â”‚         â”‚         â”‚         â”‚\n+ *                                           â–¼                   â–¼         â–¼         â–¼         â–¼\n+ *                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n+ *       m_inputs: â”‚  ready  â”‚  ready  â”‚fetching â”‚  ready  â”‚fetching â”‚fetching â”‚fetching â”‚ waiting â”‚ waiting â”‚\n+ *                 â”‚consumed â”‚    âœ“    â”‚    â—    â”‚    âœ“    â”‚    â—    â”‚    â—    â”‚    â—    â”‚         â”‚         â”‚\n+ *                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n+ *                                â–²\n+ *                                â”‚\n+ *                           m_input_tail\n+ */\n+class CoinsViewCacheAsync : public CCoinsViewCache\n+{\n+public:\n+    /**\n+     * RAII-style controller that guarantees fetching is stopped when it goes out of scope.\n+     * Returned by StartFetching() and bound to the lifetime of the block.\n+     * Non-copyable and non-movable to prevent scope escape.\n+     */\n+    class FetchControl\n+    {\n+    private:\n+        friend class CoinsViewCacheAsync;\n+        CoinsViewCacheAsync& m_cache;\n+        explicit FetchControl(CoinsViewCacheAsync& cache LIFETIMEBOUND) noexcept : m_cache{cache} {}\n+\n+    public:\n+        FetchControl(const FetchControl&) = delete;\n+        FetchControl& operator=(const FetchControl&) = delete;\n+        FetchControl(FetchControl&&) = delete;\n+        FetchControl& operator=(FetchControl&&) = delete;\n+\n+        ~FetchControl()\n+        {\n+            m_cache.StopFetching();\n+        }\n+    };\n+\n+private:\n+    //! The latest input not yet being fetched. Workers atomically increment this when fetching.\n+    mutable std::atomic_uint32_t m_input_head{0};\n+    //! The latest input not yet accessed by a consumer. Only the main thread increments this.\n+    mutable uint32_t m_input_tail{0};\n+\n+    //! The inputs of the block which is being fetched.\n+    struct InputToFetch {\n+        //! Workers set this after setting the coin. The main thread tests this before reading the coin.\n+        std::atomic_flag ready{};\n+        //! The outpoint of the input to fetch.\n+        const COutPoint& outpoint;\n+        //! The coin that workers will fetch and main thread will insert into cache.\n+        std::optional<Coin> coin{std::nullopt};\n+\n+        /**\n+         * We only move when m_inputs reallocates during setup.\n+         * We never move after work begins, so we don't have to copy other members.\n+         */\n+        InputToFetch(InputToFetch&& other) noexcept : outpoint{other.outpoint} {}\n+        explicit InputToFetch(const COutPoint& o LIFETIMEBOUND) noexcept : outpoint{o} {}\n+    };\n+    mutable std::vector<InputToFetch> m_inputs{};\n+\n+    /**\n+     * The sorted first 8 bytes of txids of all txs in the block being fetched. This is used to filter out inputs that\n+     * are created earlier in the same block, since they will not be in the db or the cache.\n+     * Using only the first 8 bytes is a performance improvement, versus storing the entire 32 bytes. In case of a\n+     * collision of an input being spent having the same first 8 bytes as a txid of a tx elsewhere in the block,\n+     * the input will not be fetched in the background. The input will still be fetched later on the main thread.\n+     * Using a sorted vector and binary search lookups is a performance improvement. It is faster than\n+     * using std::unordered_set with salted hash or std::set.\n+     */\n+    std::vector<uint64_t> m_txids{};\n+\n+    /**\n+     * Claim and fetch the next input in the queue. Safe to call from any thread once inside the barrier.\n+     *\n+     * @return true if there are more inputs in the queue to fetch\n+     * @return false if there are no more inputs in the queue to fetch\n+     */\n+    bool ProcessInputInBackground() const noexcept\n+    {\n+        const auto i{m_input_head.fetch_add(1, std::memory_order_relaxed)};\n+        if (i >= m_inputs.size()) [[unlikely]] return false;\n+\n+        auto& input{m_inputs[i]};\n+        // Inputs spending a coin from a tx earlier in the block won't be in the cache or db\n+        if (std::ranges::binary_search(m_txids, ReadLE64(input.outpoint.hash.begin()))) {\n+            // We can use relaxed ordering here since we don't write the coin.\n+            input.ready.test_and_set(std::memory_order_relaxed);\n+            input.ready.notify_one();\n+            return true;\n+        }\n+\n+        if (auto coin{base->PeekCoin(input.outpoint)}) [[likely]] input.coin.emplace(std::move(*coin));\n+        // We need release here, so writing coin in the line above happens before the main thread acquires.\n+        input.ready.test_and_set(std::memory_order_release);\n+        input.ready.notify_one();\n+        return true;\n+    }\n+\n+    std::optional<Coin> GetCoinFromBase(const COutPoint& outpoint) const override\n+    {\n+        // This assumes ConnectBlock accesses all inputs in the same order as they are added to m_inputs\n+        // in StartFetching. Some outpoints are not accessed because they are created by the block, so we scan until we\n+        // come across the requested input.\n+        for (const auto i : std::views::iota(m_input_tail, m_inputs.size())) [[likely]] {\n+            auto& input{m_inputs[i]};\n+            if (input.outpoint != outpoint) continue;\n+            // We advance the tail since the input is cached and not accessed through this method again.\n+            m_input_tail = i + 1;\n+            // Check if the coin is ready to be read. We need to acquire to match the worker thread's release.\n+            while (!input.ready.test(std::memory_order_acquire)) {\n+                // Work instead of waiting if the coin is not ready\n+                if (!ProcessInputInBackground()) {\n+                    // No more work, just wait\n+                    input.ready.wait(/*old=*/false, std::memory_order_acquire);\n+                    break;\n+                }\n+            }\n+            // We can move the coin since we won't access this input again.\n+            if (input.coin) [[likely]] return std::move(*input.coin);\n+            // This block has missing or spent inputs or there is a shorttxid collision.\n+            break;\n+        }\n+\n+        // We will only get in here for BIP30 checks, shorttxid collisions or a block with missing or spent inputs.\n+        return base->PeekCoin(outpoint);\n+    }\n+\n+    std::vector<std::thread> m_worker_threads{};\n+    std::barrier<> m_barrier;\n+\n+    //! Stop all worker threads.\n+    void StopFetching() noexcept\n+    {\n+        if (m_inputs.empty()) return;\n+        // Skip fetching the rest of the inputs by moving the head to the end.\n+        m_input_head.store(m_inputs.size(), std::memory_order_relaxed);\n+        // Wait for all threads to stop.\n+        m_barrier.arrive_and_wait();\n+        m_inputs.clear();\n+        m_input_head.store(0, std::memory_order_relaxed);\n+        m_input_tail = 0;\n+        m_txids.clear();\n+    }\n+\n+public:\n+    //! Start fetching all block inputs and return RAII guard that stops fetching on destruction.\n+    [[nodiscard]] FetchControl StartFetching(const CBlock& block LIFETIMEBOUND) noexcept\n+    {\n+        StopFetching();",
      "path": "src/coinsviewcacheasync.h",
      "position": 1,
      "original_position": 234,
      "commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "original_commit_id": "396f784f8fb9bc3116f14dc79ff21f5ddd4d89dc",
      "in_reply_to_id": 2680174595,
      "user": {
        "login": "andrewtoth",
        "id": 237213,
        "node_id": "MDQ6VXNlcjIzNzIxMw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/237213?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/andrewtoth",
        "html_url": "https://github.com/andrewtoth",
        "followers_url": "https://api.github.com/users/andrewtoth/followers",
        "following_url": "https://api.github.com/users/andrewtoth/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/andrewtoth/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/andrewtoth/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/andrewtoth/subscriptions",
        "organizations_url": "https://api.github.com/users/andrewtoth/orgs",
        "repos_url": "https://api.github.com/users/andrewtoth/repos",
        "events_url": "https://api.github.com/users/andrewtoth/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/andrewtoth/received_events",
        "type": "User",
        "site_admin": false,
        "name": null,
        "patch_url": null
      },
      "body": "Changed back to an assertion.",
      "created_at": "2026-01-14T19:23:21Z",
      "updated_at": "2026-01-14T19:23:21Z",
      "html_url": "https://github.com/bitcoin/bitcoin/pull/31132#discussion_r2691739366",
      "author_association": "CONTRIBUTOR",
      "_links": {
        "self": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/2691739366"
        },
        "pull_request": {
          "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/31132"
        }
      },
      "start_line": null,
      "original_start_line": null,
      "start_side": null,
      "line": null,
      "original_line": 234,
      "side": "RIGHT"
    }
  ]
}